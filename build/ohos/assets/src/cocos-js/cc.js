System.register([],(function(t,e){"use strict";return{execute:function(){t({BitMask:Bt,CCClass:we,CacheMode:void 0,DebugMode:void 0,ECollider2DType:void 0,EJoint2DType:void 0,EPhysics2DDrawFlags:void 0,ERaycast2DType:void 0,ERigidBody2DType:void 0,Enum:Nt,Eventify:ke,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,Physics2DManifoldType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:Db,WorldNode3DToWorldNodeUI:Ib,absMax:Pi,absMaxComponent:Ei,approx:_i,assert:d,assertID:E,bezier:lm,bezierByTime:dm,ccenum:zt,clamp:ui,clamp01:mi,color:Mi,computeRatioByType:PR,createDefaultPipeline:ST,debug:f,deserialize:c_,earcut:$k,enumerableProps:Di,equals:hi,error:p,errorID:T,find:BC,fragmentText:JN,getBaselineOffset:function(){return 0},getError:D,getPathFromRoot:function(t,e){let i=t,n="";for(;null!==i&&i!==e;)n=`${i.name}/${n}`,i=i.parent;return n.slice(0,-1)},getSerializationMetadata:function(t){return t[jl]},getWorldTransformUntilRoot:function(t,e,i){for($i.identity(i);t!==e;)$i.fromRTS(qO,t.rotation,t.position,t.scale),$i.multiply(i,qO,i),t=t.parent;return i},instantiate:d_,inverseLerp:wi,isCustomTargetModifier:sB,isDisplayStats:I,isElementModifier:nB,isPropertyModifier:iB,isUnicodeCJK:XN,isUnicodeSpace:YN,isValid:Be,lerp:pi,log:u,logID:b,markAsWarning:void 0,mat4:Qi,murmurhash2_32_gc:Uo,nextPow2:Ai,pingPong:Ti,pseudoRandom:xi,pseudoRandomRange:bi,pseudoRandomRangeInt:Si,quat:Yi,randomRange:yi,randomRangeInt:vi,rect:_n,removeProperty:void 0,repeat:Ci,replaceProperty:void 0,safeMeasureText:KN,sampleAnimationCurve:ER,setDefaultLogTimes:function(t){t>0&&(si=t)},setDisplayStats:R,size:cn,toDegree:fi,toRadian:di,tween:jet,tweenUtil:Wet,v2:sn,v3:zi,v4:on,warn:m,warnID:A});const i="undefined"==typeof window?global:window,n=t("cclegacy",{_global:i});n.internal={},i.CC_BUILD=!0,i.CC_TEST=!1,i.CC_EDITOR=false,i.CC_PREVIEW=!1,i.CC_DEV=!1,i.CC_DEBUG=!1,i.CC_JSB=!0,i.CC_BYTEDANCE=!1,i.CC_WECHAT=!1,i.CC_ALIPAY=!1,i.CC_XIAOMI=!1,i.CC_BAIDU=!1,i.CC_COCOSPLAY=!1,i.CC_HUAWEI=!1,i.CC_OPPO=!1,i.CC_VIVO=!1,i.CC_MINIGAME=!1,i.CC_RUNTIME_BASED=!1,i.CC_SUPPORT_JIT=!0;const s=t("VERSION","3.3.0");i.CocosEngine=n.ENGINE_VERSION=s,i.cc=n;let r=null,o=console.log.bind(console),a=o,l=o,c=(t,e,...i)=>{t||console.log(`ASSERT: ${_(e,...i)}`)},h=o;function _(t,...e){return n.js.formatStr.apply(null,[t].concat(e))}function u(t,...e){return o(t,...e)}function m(t,...e){return a(t,...e)}function p(t,...e){return l(t,...e)}function d(t,e,...i){return c(t,e,...i)}function f(...t){return h(...t)}function g(t){if(o=a=l=c=h=()=>{},t!==P.NONE){if(t>P.ERROR){const e=t=>{if(n.game.canvas){if(!r){const t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",n.game.canvas.height);const e=t.style;e.zIndex="99999",e.position="absolute",e.top=e.left="0",r=document.createElement("textarea"),r.setAttribute("rows","20"),r.setAttribute("cols","30"),r.setAttribute("disabled","true");const i=r.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(r),n.game.canvas.parentNode.appendChild(t)}r.value=`${r.value+t}\r\n`,r.scrollTop=r.scrollHeight}};l=(t,...i)=>{e(`ERROR :  ${_(t,...i)}`)},c=(t,i,...n)=>{t||e(`ASSERT: ${_(i,...n)}`)},t!==P.ERROR_FOR_WEB_PAGE&&(a=(t,...i)=>{e(`WARN :  ${_(t,...i)}`)}),t===P.INFO_FOR_WEB_PAGE&&(o=(t,...i)=>{e(_(t,...i))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),l=console.error.bind?console.error.bind(console):console.error,c=(t,e,...i)=>{if(!t){const t=_(e,...i);throw new Error(t)}});if(t!==P.ERROR&&(a=console.warn.bind?console.warn.bind(console):console.warn),t===P.INFO&&(o="JavaScriptCore"===scriptEngineType?(t,...e)=>console.log.apply(console,[t,...e]):console.log),t<=P.VERBOSE&&"function"==typeof console.debug){const t=console.debug.bind(console);h=(...e)=>t(...e)}}}function y(t){{const e=t.stack;return void p(e?`${t}\n${e}`:t)}}function v(t){return(e,...i)=>{const n=`${t} ${e}, please go to https://github.com/cocos-creator/engine/blob/3d/EngineErrorMap.md#${e} to see details.`;return 0===i.length?n:`${n} Arguments: ${i.join(", ")}`}}const x=v("Log");function b(t,...e){u(x(t,...e))}const S=v("Warning");function A(t,...e){m(S(t,...e))}const C=v("Error");function T(t,...e){p(C(t,...e))}const w=v("Assert");function E(t,e,...i){t||d(!1,w(e,...i))}let P;function D(t,...e){return C(t,...e)}function I(){return!!n.profiler&&n.profiler.isShowingStats()}function R(t){n.profiler&&(t?n.profiler.showStats():n.profiler.hideStats(),n.game.config.showFPS=!!t)}!function(t){t[t.NONE=0]="NONE",t[t.VERBOSE=1]="VERBOSE",t[t.INFO=2]="INFO",t[t.WARN=3]="WARN",t[t.ERROR=4]="ERROR",t[t.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",t[t.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",t[t.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(P||(P=t("DebugMode",{})));var M=Object.freeze({__proto__:null,log:u,warn:m,error:p,assert:d,debug:f,_resetDebugSetting:g,_throw:y,logID:b,warnID:A,errorID:T,assertID:E,get DebugMode(){return P},getError:D,isDisplayStats:I,setDisplayStats:R});let O,B,N,L,F;!function(t){t.UNKNOWN="unknown",t.WECHAT="wechat",t.ANDROID="androidbrowser",t.IE="ie",t.EDGE="edge",t.QQ="qqbrowser",t.MOBILE_QQ="mqqbrowser",t.UC="ucbrowser",t.UCBS="ucbs",t.BROWSER_360="360browser",t.BAIDU_APP="baiduboxapp",t.BAIDU="baidubrowser",t.MAXTHON="maxthon",t.OPERA="opera",t.OUPENG="oupeng",t.MIUI="miuibrowser",t.FIREFOX="firefox",t.SAFARI="safari",t.CHROME="chrome",t.LIEBAO="liebao",t.QZONE="qzone",t.SOUGOU="sogou",t.HUAWEI="huawei"}(O||(O={})),function(t){t.UNKNOWN="unknown",t.ENGLISH="en",t.CHINESE="zh",t.FRENCH="fr",t.ITALIAN="it",t.GERMAN="de",t.SPANISH="es",t.DUTCH="du",t.RUSSIAN="ru",t.KOREAN="ko",t.JAPANESE="ja",t.HUNGARIAN="hu",t.PORTUGUESE="pt",t.ARABIC="ar",t.NORWEGIAN="no",t.POLISH="pl",t.TURKISH="tr",t.UKRAINIAN="uk",t.ROMANIAN="ro",t.BULGARIAN="bg"}(B||(B={})),function(t){t[t.NONE=0]="NONE",t[t.LAN=1]="LAN",t[t.WWAN=2]="WWAN"}(N||(N={})),function(t){t.UNKNOWN="Unknown",t.IOS="iOS",t.ANDROID="Android",t.WINDOWS="Windows",t.LINUX="Linux",t.OSX="OS X",t.OHOS="OHOS"}(L||(L={})),function(t){t.UNKNOWN="UNKNOWN",t.EDITOR_PAGE="EDITOR_PAGE",t.EDITOR_CORE="EDITOR_CORE",t.MOBILE_BROWSER="MOBILE_BROWSER",t.DESKTOP_BROWSER="DESKTOP_BROWSER",t.WIN32="WIN32",t.ANDROID="ANDROID",t.IOS="IOS",t.MACOS="MACOS",t.OHOS="OHOS",t.WECHAT_GAME="WECHAT_GAME",t.BAIDU_MINI_GAME="BAIDU_MINI_GAME",t.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",t.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",t.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",t.OPPO_MINI_GAME="OPPO_MINI_GAME",t.VIVO_MINI_GAME="VIVO_MINI_GAME",t.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",t.COCOSPLAY="COCOSPLAY",t.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",t.QTT_MINI_GAME="QTT_MINI_GAME"}(F||(F={}));class z{constructor(t,e){this._ctor=void 0,this._elementsPerBatch=void 0,this._nextAvail=void 0,this._freepool=[],this._ctor=t,this._elementsPerBatch=Math.max(e,1),this._nextAvail=this._elementsPerBatch-1;for(let e=0;e<this._elementsPerBatch;++e)this._freepool.push(t())}alloc(){if(this._nextAvail<0){const t=this._elementsPerBatch;for(let e=0;e<t;e++)this._freepool.push(this._ctor());this._nextAvail=t-1}const t=this._freepool[this._nextAvail--];return this._freepool.length--,t}free(t){this._freepool.push(t),this._nextAvail++}freeArray(t){Array.prototype.push.apply(this._freepool,t),this._nextAvail+=t.length}destroy(t){if(t)for(let e=0;e<=this._nextAvail;e++)t(this._freepool[e]);this._freepool.length=0,this._nextAvail=-1}}t("Pool",z);class V{constructor(t,e){this._fn=void 0,this._count=0,this._data=void 0,this._fn=t,this._data=new Array(e);for(let i=0;i<e;++i)this._data[i]=t()}get length(){return this._count}get data(){return this._data}reset(){this._count=0}resize(t){if(t>this._data.length)for(let e=this._data.length;e<t;++e)this._data[e]=this._fn()}add(){return this._count>=this._data.length&&this.resize(2*this._data.length),this._data[this._count++]}removeAt(t){if(t>=this._count)return;const e=this._count-1,i=this._data[t];this._data[t]=this._data[e],this._data[e]=i,this._count-=1}}t("RecyclePool",V);class U{constructor(t,e){this.array=void 0,this.length=0,this._compareFn=void 0,this.array=new Array(t),this.length=0,this._compareFn=void 0!==e?e:(t,e)=>t-e}push(t){this.array[this.length++]=t}pop(){return this.array[--this.length]}get(t){return this.array[t]}clear(){this.length=0}destroy(){this.length=0,this.array.length=0}sort(){this.array.length=this.length,this.array.sort(this._compareFn)}concat(t){for(let e=0;e<t.length;++e)this.array[this.length++]=t[e]}fastRemove(t){if(t>=this.length||t<0)return;const e=--this.length;this.array[t]=this.array[e]}indexOf(t){return this.array.indexOf(t)}}t("CachedArray",U),t("memop",Object.freeze({__proto__:null,Pool:z,RecyclePool:V,CachedArray:U}));class G{constructor(t){this.i=0,this.array=t}get length(){return this.array.length}set length(t){this.array.length=t,this.i>=t&&(this.i=t-1)}remove(t){const e=this.array.indexOf(t);e>=0&&this.removeAt(e)}removeAt(t){this.array.splice(t,1),t<=this.i&&--this.i}fastRemove(t){const e=this.array.indexOf(t);e>=0&&this.fastRemoveAt(e)}fastRemoveAt(t){const e=this.array;e[t]=e[e.length-1],--e.length,t<=this.i&&--this.i}push(t){this.array.push(t)}}function k(t,e){t.splice(e,1)}function H(t,e){const i=t.length;e<0||e>=i||(t[e]=t[i-1],t.length=i-1)}function j(t,e){const i=t.indexOf(e);return i>=0&&(k(t,i),!0)}function W(t,e){return t.indexOf(e)>=0}var q=Object.freeze({__proto__:null,removeAt:k,fastRemoveAt:H,remove:j,fastRemove:function(t,e){const i=t.indexOf(e);i>=0&&(t[i]=t[t.length-1],--t.length)},removeIf:function(t,e){const i=t.findIndex(e);if(i>=0){const e=t[i];return k(t,i),e}},verifyType:function(t,e){if(t&&t.length>0)for(const i of t)if(!(i instanceof e))return b(1300),!1;return!0},removeArray:function(t,e){for(let i=0,n=e.length;i<n;i++)j(t,e[i])},appendObjectsAt:function(t,e,i){return t.splice.apply(t,[i,0,...e]),t},contains:W,copy:function(t){const e=t.length,i=new Array(e);for(let n=0;n<e;n+=1)i[n]=t[n];return i},MutableForwardIterator:G});class X{constructor(t){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=t?t+".":""}getNewId(){return this.prefix+ ++this.id}}X.global=new X("global");const Y=new X("TmpCId."),K="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),$="__cid__";function J(t){return"number"==typeof t||t instanceof Number}function Z(t){return"string"==typeof t||t instanceof String}function Q(t){for(const e in t)return!1;return!0}const tt=(()=>{const t={value:void 0,enumerable:!1,writable:!1,configurable:!0};return(e,i,n,s,r)=>{t.value=n,t.writable=s,t.enumerable=r,Object.defineProperty(e,i,t),t.value=void 0}})(),et=(()=>{const t={get:void 0,set:void 0,enumerable:!1};return(e,i,n,s,r=!1,o=!1)=>{"boolean"==typeof s&&(r=s,s=void 0),t.get=n,t.set=s,t.enumerable=r,t.configurable=o,Object.defineProperty(e,i,t),t.get=void 0,t.set=void 0}})(),it=(()=>{const t={get:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.get=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.get=void 0}})(),nt=(()=>{const t={set:void 0,enumerable:!1,configurable:!1};return(e,i,n,s,r)=>{t.set=n,t.enumerable=s,t.configurable=r,Object.defineProperty(e,i,t),t.set=void 0}})();function st(t){const e=Object.create(null);if(t){const t=".",i="/";e[t]=1,e[i]=1,delete e[t],delete e[i]}return e}function rt(t){if("function"==typeof t){const e=t.prototype;if(e&&e.hasOwnProperty("__classname__")&&e.__classname__)return e.__classname__;let i="";if(t.name&&(i=t.name),t.toString){let e;const n=t.toString();e="["===n.charAt(0)?n.match(/\[\w+\s*(\w+)\]/):n.match(/function\s*(\w+)/),e&&2===e.length&&(i=e[1])}return"Object"!==i?i:""}return t&&t.constructor?rt(t.constructor):""}function ot(t,e,i,n){const s=/([^.]+)$/,r=s.exec(e)[0],o=s.exec(i)[0];function a(){return this[o]}n?et(t,r,a,(function(t){this[o]=t})):it(t,r,a)}function at(t,e,i,n){for(const s in i)ot(t,`${e}.${s}`,i[s],n)}const lt=/(%d)|(%s)/,ct=/%s/;function ht(t,...e){if(0===arguments.length)return"";if(0===e.length)return`${t}`;const i="string"==typeof t&&lt.test(t);if(i)for(const i of e){const e="number"==typeof i?lt:ct;if(e.test(t)){const n=`${i}`;t=t.replace(e,n)}else t+=` ${i}`}else for(const i of e)t+=` ${i}`;return t}function _t(){const t=arguments.length-1,e=new Array(t);for(let i=0;i<t;++i)e[i]=arguments[i+1];return e}function ut(t,e){for(;t;){const i=Object.getOwnPropertyDescriptor(t,e);if(i)return i;t=Object.getPrototypeOf(t)}return null}function mt(t,e,i){const n=ut(e,t);n&&Object.defineProperty(i,t,n)}function pt(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){T(5402,i);continue}for(const e in i)e in t||mt(e,i,t)}return t}function dt(t,...e){t=t||{};for(const i of e)if(i){if("object"!=typeof i){T(5403,i);continue}for(const e in i)mt(e,i,t)}return t}function ft(t,e){for(const i in e)e.hasOwnProperty(i)&&(t[i]=e[i]);return t.prototype=Object.create(e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),t}function gt(t){const e=t.prototype,i=e&&Object.getPrototypeOf(e);return i&&i.constructor}function yt(t,e){if(t&&e){if("function"!=typeof t)return!1;if("function"!=typeof e)return!1;if(t===e)return!0;for(;;){if(!(t=gt(t)))return!1;if(t===e)return!0}}return!1}function vt(t){for(const e of Object.keys(t))delete t[e]}const xt=st(!0),bt=st(!0);function St(t,e){return function(i,n){if(n.prototype.hasOwnProperty(t)&&delete e[n.prototype[t]],tt(n.prototype,t,i),i){const s=e[i];s&&s!==n?p(`A Class already exists with the same ${t} : "${i}".`):e[i]=n}}}const At=St("__cid__",xt),Ct=St("__classname__",bt);function Tt(t,e){if(Ct(t,e),!e.prototype.hasOwnProperty($)){const i=t||Y.getNewId();i&&At(i,e)}}function wt(t,e){const i=bt[e],n=xt[e];let s=!0;if(i&&i!==t&&(p(`"${e}" has already been set as name or alias of another class.`),s=!1),n&&n!==t&&(p(`"${e}" has already been set as id or alias of another class.`),s=!1),s){let i=t[K];i||(i=[],t[K]=i),i.push(e),bt[e]=t,xt[e]=t}}function Et(...t){for(const e of t){const t=e.prototype,i=t.__cid__;i&&delete xt[i];const n=t.__classname__;n&&delete bt[n];const s=t[K];if(s)for(let t=0;t<s.length;++t){const e=s[t];delete bt[e],delete xt[e]}}}function Pt(t){return xt[t]}function Dt(t){return bt[t]}function It(t,e){let i;if(e=void 0===e||e,"function"==typeof t&&t.prototype.hasOwnProperty($))return i=t.prototype.__cid__,i;if(t&&t.constructor){const e=t.constructor.prototype;if(e&&e.hasOwnProperty($))return i=t.__cid__,i}return""}class Rt{get(){return this._get()}constructor(t,e){this.count=void 0,this._pool=void 0,this._cleanup=void 0;const i=void 0===e?t:e,n=void 0===e?null:t;this.count=0,this._pool=new Array(i),this._cleanup=n}_get(){if(this.count>0){--this.count;const t=this._pool[this.count];return this._pool[this.count]=null,t}return null}put(t){const e=this._pool;if(this.count<e.length){if(this._cleanup&&!1===this._cleanup(t))return;e[this.count]=t,++this.count}}resize(t){t>=0&&(this._pool.length=t,this.count>t&&(this.count=t))}}const Mt=q,Ot={IDGenerator:X,Pool:Rt,array:q,isNumber:J,isString:Z,isEmptyObject:Q,getPropertyDescriptor:ut,addon:pt,mixin:dt,extend:ft,getSuper:gt,isChildClassOf:yt,clear:vt,value:tt,getset:et,get:it,set:nt,unregisterClass:Et,getClassName:rt,setClassName:Tt,setClassAlias:wt,getClassByName:Dt,get _registeredClassNames(){return{...bt}},set _registeredClassNames(t){vt(bt),Object.assign(bt,t)},get _registeredClassIds(){return{...xt}},set _registeredClassIds(t){vt(xt),Object.assign(xt,t)},_getClassId:It,_setClassId:At,_getClassById:Pt,obsolete:ot,obsoletes:at,formatStr:ht,shiftArguments:_t,createMap:st};function Bt(t){if("__bitmask__"in t)return t;tt(t,"__bitmask__",null,!0);let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&tt(t,o,s)}return t}function Nt(t){return"__enums__"in t?t:(tt(t,"__enums__",null,!0),Nt.update(t))}function Lt(t){t.hasOwnProperty("__enums__")}function Ft(t){Lt(t);const e=t.__enums__||[];e.length=0;for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),t.__enums__=e,e}function zt(t){"__enums__"in t||tt(t,"__enums__",null,!0)}n.js=Ot,t("js",Object.freeze({__proto__:null,array:Mt,js:Ot,IDGenerator:X,Pool:Rt,isNumber:J,isString:Z,isEmptyObject:Q,value:tt,getset:et,get:it,set:nt,createMap:st,getClassName:rt,obsolete:ot,obsoletes:at,formatStr:ht,shiftArguments:_t,getPropertyDescriptor:ut,addon:pt,mixin:dt,extend:ft,getSuper:gt,isChildClassOf:yt,clear:vt,_idToClass:xt,_nameToClass:bt,_setClassId:At,setClassName:Tt,setClassAlias:wt,unregisterClass:Et,_getClassById:Pt,getClassByName:Dt,_getClassId:It})),Bt.isBitMask=t=>t&&t.hasOwnProperty("__bitmask__"),Bt.getList=t=>{if(t.__bitmask__)return t.__bitmask__;const e=t.__bitmask__=[];for(const i in t){const n=t[i];Number.isInteger(n)&&e.push({name:i,value:n})}return e.sort(((t,e)=>t.value-e.value)),e},n.BitMask=Bt,Nt.update=t=>{let e=-1;const i=Object.keys(t);for(let n=0;n<i.length;n++){const s=i[n];let r=t[s];if(-1===r)r=++e,t[s]=r;else if("number"==typeof r)e=r;else if("string"==typeof r&&Number.isInteger(parseFloat(s)))continue;const o=`${r}`;s!==o&&tt(t,o,s)}return Array.isArray(t.__enums__)&&Ft(t),t},Nt||(Nt=t("Enum",{})),Nt.isEnum=t=>t&&t.hasOwnProperty("__enums__"),Nt.getList=t=>(Lt(t),t.__enums__?t.__enums__:Ft(t)),n.Enum=Nt;class Vt{clone(){return T(100,`${rt(this)}.clone`),this}equals(t){return!1}set(t){T(100,`${rt(this)}.set`)}toString(){return`${{}}`}}t("ValueType",Vt),Tt("cc.ValueType",Vt),n.ValueType=Vt;const Ut=t("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20});n.macro=Ut;const Gt=/^(?:cc|dragonBones|sp|ccsg)\..+/,kt=new Array(123);for(let t=0;t<123;++t)kt[t]=64;for(let t=0;t<64;++t)kt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;const Ht=kt;function jt(t,e,i){function n(t,e,i,n){const s=Object.getOwnPropertyDescriptor(t,e);if(s)s.get&&(t[i]=s.get),s.set&&n&&(t[n]=s.set);else{const s=t[i];et(t,e,s,t[n])}}let s;const r=t.prototype;for(let t=0;t<e.length;t++){s=e[t];const i=s[0].toUpperCase()+s.slice(1);n(r,s,`get${i}`,`set${i}`)}for(s in i){const t=i[s];n(r,s,t[0],t[1])}}function Wt(t,e,i,n){const s=t[e];s?Array.isArray(s)?n?(s.push(s[0]),s[0]=i):s.push(i):t[e]=n?[i,s]:[s,i]:t[e]=i}function qt(t,e){if("function"==typeof t.contains)return t.contains(e);if("function"==typeof t.compareDocumentPosition)return!!(16&t.compareDocumentPosition(e));{let i=e.parentNode;if(i)do{if(i===t)return!0;i=i.parentNode}while(null!==i);return!1}}function Xt(t){return"object"==typeof window&&"function"==typeof Node?t instanceof Node:t&&"object"==typeof t&&"number"==typeof t.nodeType&&"string"==typeof t.nodeName}function Yt(t,e,i){t&&setTimeout((()=>{t(e,i)}),0)}function Kt(t){return!(!t||t.constructor!==Object)&&Q(t)}function $t(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t<i?t:i}function Jt(t){return t*Ut.RAD}function Zt(t){return t*Ut.DEG}n.misc={BUILTIN_CLASSID_RE:Gt,BASE64_VALUES:Ht,propertyDefine:jt,pushToMap:Wt,contains:qt,isDomNode:Xt,callInNextTick:Yt,isPlainEmptyObj_DEV:Kt,clampf:$t,degreesToRadians:Jt,radiansToDegrees:Zt},t("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:Gt,BASE64_VALUES:Ht,propertyDefine:jt,pushToMap:Wt,contains:qt,isDomNode:Xt,callInNextTick:Yt,tryCatchFunctor_EDITOR:function(t){return Function("target",`try {\n  target.${t}();\n}\ncatch (e) {\n  cc._throw(e);\n}`)},isPlainEmptyObj_DEV:Kt,clampf:$t,degreesToRadians:Jt,radiansToDegrees:Zt}));const Qt="$_$";function te(t,e){const i=e?Object.create(e):{};return tt(t,"__attrs__",i),i}function ee(t){if("function"!=typeof t)return te(t,ne(t.constructor));let e;const i=n.Class.getInheritanceChain(t);for(let t=i.length-1;t>=0;t--){const n=i[t];n.hasOwnProperty("__attrs__")&&n.__attrs__||(e=i[t+1],te(n,e&&e.__attrs__))}return e=i[0],te(t,e&&e.__attrs__),t.__attrs__}function ie(t,e){const i=ne(t),n=e+Qt,s={};for(const t in i)t.startsWith(n)&&(s[t.slice(n.length)]=i[t]);return s}function ne(t){return t.hasOwnProperty("__attrs__")&&t.__attrs__||ee(t)}function se(t,e,i,n){ne(t)[e+Qt+i]=n}class re{constructor(t,e){this.name=void 0,this.default=void 0,this.name=t,this.default=e}toString(){return this.name}}const oe=t("CCInteger",new re("Integer",0));n.Integer=oe,n.CCInteger=oe;const ae=t("CCFloat",new re("Float",0));n.Float=ae,n.CCFloat=ae;const le=t("CCBoolean",new re("Boolean",!1));n.Boolean=le,n.CCBoolean=le;const ce=t("CCString",new re("String",""));function he(t,e){return function(i,n){const s=`"${rt(i)}.${n}"`,r=ie(i,n);let o=r.type;if(o===oe||o===ae?o="Number":o!==ce&&o!==le||(o=`${o}`),o!==t)return void A(3604,s);if(!r.hasOwnProperty("default"))return;const a=r.default;if(void 0===a)return;if(Array.isArray(a)||Kt(a))return;const l=typeof a,c=t.toLowerCase();if(l===c)if("object"===c){if(!a||a instanceof r.ctor)return;A(3605,s,rt(r.ctor))}else"Number"!==t&&A(3606,e,s,t);else{if("function"===l)return;t===ce.default&&null==a?A(3607,s):A(3611,e,s,l)}delete r.type}}n.String=ce,n.CCString=ce;var _e=Object.freeze({__proto__:null,DELIMETER:Qt,createAttrsSingle:te,createAttrs:ee,attr:ie,getClassAttrs:ne,setClassAttr:se,PrimitiveType:re,CCInteger:oe,CCFloat:ae,CCBoolean:le,CCString:ce,getTypeChecker_ET:he,getObjTypeChecker_ET:function(t){return function(e,i){he("Object","type")(e,i);const s=ne(e)[`${i+Qt}default`],r=n.Class.getDefault(s);if(!Array.isArray(r)&&yt(t,n.ValueType)){const n=rt(t),r=ht('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',rt(e),i,n);s?u(r):A(3612,r,n,rt(e),i,n)}}}});const ue={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function me(t,e,i,n){if(!t.get&&!t.set&&t.hasOwnProperty("default")){const s=`_N$${e}`;t.get=function(){return this[s]},t.set=function(t){const e=this[s];this[s]=t,i.call(this,e)};const r={};n[s]=r;for(const e in ue){const i=ue[e];t.hasOwnProperty(e)&&(r[e]=t[e],i.canUsedInGet||delete t[e])}}}function pe(t,e,i,s){if(Array.isArray(e)){if(!(e.length>0))return T(5508,i,s);t.type=e=e[0]}"function"==typeof e&&(e===String?t.type=n.String:e===Boolean?t.type=n.Boolean:e===Number&&(t.type=n.Float))}function de(t,e,i){const n=t?{_short:!0}:{_short:!0,default:e};return i&&(n.type=i),n}function fe(t,e){if(!t||t.constructor!==Object){if(Array.isArray(t)&&t.length>0)return de(e,[],t);if("function"==typeof t){const i=t;return de(e,yt(i,n.ValueType)?new i:null,i)}return de(e,t instanceof re?t.default:t)}return null}let ge=[];function ye(){return ge[ge.length-1]}n._RF={push:function(t,e,i,n){void 0===i&&(i=e,e=""),ge.push({uuid:e,script:i,module:t,exports:t.exports,beh:null,importMeta:n})},pop:function(){const t=ge.pop(),e=t.module;let i=e.exports;if(i===t.exports){for(const t in i)return;e.exports=i=t.cls}},peek:ye};const ve=Qt,xe={datas:null,push(t){if(this.datas)this.datas.push(t);else{this.datas=[t];const e=this;setTimeout((()=>{e.init()}),0)}},init(){const t=this.datas;if(t){for(let e=0;e<t.length;++e){const i=t[e],n=i.cls;let s=i.props;"function"==typeof s&&(s=s());const r=rt(n);s?Te(n,r,s,n.$super,i.mixins):T(3633,r)}this.datas=null}}};function be(t,e,i,n){!function(t,e){!function(t,e){t.indexOf(e)<0&&t.push(e)}(t.__props__,e)}(t,i),Pe(t,n,e,i)}function Se(t,e,i,n){const s=n.get;n.set,s&&(Pe(t,n,e,i),se(t,i,"serializable",!1))}function Ae(t){return"function"==typeof t?t():t}function Ce(t,e,i){for(const n in e)t.hasOwnProperty(n)||i&&!i(n)||Object.defineProperty(t,n,ut(e,n))}function Te(t,e,i,n,s){if(t.__props__=[],n&&n.__props__&&(t.__props__=n.__props__.slice()),s)for(let e=0;e<s.length;++e){const i=s[e];i.__props__&&(t.__props__=t.__props__.concat(i.__props__.filter((e=>t.__props__.indexOf(e)<0))))}if(i){!function(t,e){for(const i in t){let n=t[i];const s=fe(n,!1);if(s&&(n=t[i]=s),n){const s=n.notify;s&&me(n,i,s,t),"type"in n&&pe(n,n.type,e,i)}}}(i,e);for(const n in i){const s=i[n];s.get||s.set?Se(t,e,n,s):be(t,e,n,s)}}const r=ne(t);t.__values__=t.__props__.filter((t=>!1!==r[`${t+ve}serializable`]))}function we(t){let e=t.name;const i=t.extends,s=t.mixins,r=function(t,e,i,s){const r=n.Component,o=ye();if(o&&yt(e,r)){if(yt(o.cls,r))return T(3615),null;t=t||o.script}const a=function(t,e,i,n){const s=n.ctor,r=[s],o=s;tt(o,"__ctors__",r.length>0?r:null,!0);const a=o.prototype;if(e&&(o.$super=e),i){for(let t=i.length-1;t>=0;t--){const e=i[t];Ce(a,e.prototype),we._isCCClass(e)&&Ce(ne(o),ne(e))}a.constructor=o}return Tt(t,o),o}(t,e,i,s);if(o)if(yt(e,r)){const t=o.uuid;t&&At(t,a),o.cls=a}else yt(o.cls,r)||(o.cls=a);return a}(e,i,s,t);e||(e=n.js.getClassName(r)),r._sealed=!0,i&&(i._sealed=!1);const o=t.properties;"function"==typeof o||i&&null===i.__props__||s&&s.some((t=>null===t.__props__))?(xe.push({cls:r,props:o,mixins:s}),r.__props__=r.__values__=null):Te(r,e,o,i,t.mixins);const a=t.editor;return a&&yt(i,n.Component)&&n.Component._registerEditorProps(r,a),r}we._isCCClass=function(t){var e;return null==t||null===(e=t.hasOwnProperty)||void 0===e?void 0:e.call(t,"__ctors__")},we.fastDefine=function(t,e,i){Tt(t,e);const n=e.__props__=e.__values__=Object.keys(i),s=ne(e);for(let t=0;t<n.length;t++){const e=n[t];s[`${e+ve}visible`]=!1,s[`${e+ve}default`]=i[e]}},we.Attr=_e,we.attr=ie,we.getInheritanceChain=function(t){const e=[];for(;t=gt(t);)t!==Object&&e.push(t);return e};const Ee={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function Pe(t,e,i,n){let s=null,r="";function o(){return r=n+ve,s=ne(t)}"type"in e&&void 0===e.type&&A(3660,n,i);const a=e.type;a&&(Ee[a]?(s||o())[`${r}type`]=a:"Object"===a||("object"==typeof a?Nt.isEnum(a)?((s||o())[`${r}type`]="Enum",s[`${r}enumList`]=Nt.getList(a)):Bt.isBitMask(a)&&((s||o())[`${r}type`]="BitMask",s[`${r}bitmaskList`]=Bt.getList(a)):"function"==typeof a&&((s||o())[`${r}type`]="Object",s[`${r}ctor`]=a))),"default"in e&&((s||o())[`${r}default`]=e.default);const l=(t,i)=>{if(t in e){const n=e[t];typeof n===i&&((s||o())[r+t]=n)}};var c;e.editorOnly&&((s||o())[`${r}editorOnly`]=!0),e.__noImplicit?(s||o())[`${r}serializable`]=null!==(c=e.serializable)&&void 0!==c&&c:!1===e.serializable&&((s||o())[`${r}serializable`]=!1),l("formerlySerializedAs","string");const h=e.range;h&&Array.isArray(h)&&h.length>=2&&((s||o())[`${r}min`]=h[0],s[`${r}max`]=h[1],h.length>2&&(s[`${r}step`]=h[2])),l("min","number"),l("max","number"),l("step","number")}we.isArray=function(t){return t=Ae(t),Array.isArray(t)},we.getDefault=Ae,we.escapeForJS=function(t){return JSON.stringify(t).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},we.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,we.getNewValueTypeCode=function(t){const e=rt(t),i=t.constructor;let n=`new ${e}(`;for(let e=0;e<i.__props__.length;e++)n+=t[i.__props__[e]],e<i.__props__.length-1&&(n+=",");return`${n})`},n.Class=we;const De=t("editorExtrasTag","__editorExtras__"),Ie=1<<22,Re=[];class Me{static _deferredDestroy(){const t=Re.length;for(let e=0;e<t;++e){const t=Re[e];1&t._objFlags||t._destroyImmediate()}t===Re.length?Re.length=0:Re.splice(0,t)}constructor(t=""){this._objFlags=void 0,this._name=void 0,this._name=t,this._objFlags=0}get name(){return this._name}set name(t){this._name=t}set hideFlags(t){const e=t&Me.Flags.AllHideMasks;this._objFlags=this._objFlags&~Me.Flags.AllHideMasks|e}get hideFlags(){return this._objFlags&Me.Flags.AllHideMasks}set replicated(t){t?this._objFlags|=Ie:this._objFlags&=-4194305}get replicated(){return!!(this._objFlags&Ie)}get isValid(){return!(1&this._objFlags)}destroy(){return 1&this._objFlags?(A(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,Re.push(this),0))}_destruct(){const t=this.constructor;let e=t.__destruct__;e||(e=function(t,e){const i=t instanceof n._BaseNode||t instanceof n.Component,s=i?"_id":null;let r;const o={};for(r in t)if(t.hasOwnProperty(r)){if(r===s)continue;switch(typeof t[r]){case"string":o[r]="";break;case"object":case"function":o[r]=null}}if(we._isCCClass(e)){const t=n.Class.Attr.getClassAttrs(e),s=e.__props__;for(let e=0;e<s.length;e++){r=s[e];const a=`${r+n.Class.Attr.DELIMETER}default`;if(a in t){if(i&&"_id"===r)continue;switch(typeof t[a]){case"string":o[r]="";break;case"object":case"function":o[r]=null;break;case"undefined":o[r]=void 0}}}}{let t="";for(r in o){let e;e=we.IDENTIFIER_RE.test(r)?`o.${r}=`:`o[${we.escapeForJS(r)}]=`;let i=o[r];""===i&&(i='""'),t+=`${e+i};\n`}return Function("o",t)}}(this,t),tt(t,"__destruct__",e,!0)),e(this)}_destroyImmediate(){1&this._objFlags?T(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)}}t("CCObject",Me);const Oe=Me.prototype;function Be(t,e){return"object"==typeof t?!(!t||t._objFlags&(e?5:1)):void 0!==t}Oe._deserialize=null,Oe._onPreDestroy=null,we.fastDefine("cc.Object",Me,{_name:"",_objFlags:0,[De]:{}}),we.Attr.setClassAttr(Me,De,"editorOnly",!0),tt(Me,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),n.isValid=Be,n.Object=Me;const Ne=Mt.fastRemoveAt;function Le(){}class Fe{constructor(){this.callback=Le,this.target=void 0,this.once=!1}set(t,e,i){this.callback=t||Le,this.target=e,this.once=!!i}reset(){this.target=void 0,this.callback=Le,this.once=!1}check(){return!(this.target instanceof Me&&!Be(this.target,!0))}}const ze=new z((()=>new Fe),32);class Ve{constructor(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}removeByCallback(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.callback===t&&(i.reset(),ze.free(i),Ne(this.callbackInfos,e),--e)}}removeByTarget(t){for(let e=0;e<this.callbackInfos.length;++e){const i=this.callbackInfos[e];i&&i.target===t&&(i.reset(),ze.free(i),Ne(this.callbackInfos,e),--e)}}cancel(t){const e=this.callbackInfos[t];e&&(e.reset(),this.isInvoking?this.callbackInfos[t]=null:Ne(this.callbackInfos,t),ze.free(e)),this.containCanceled=!0}cancelAll(){for(let t=0;t<this.callbackInfos.length;t++){const e=this.callbackInfos[t];e&&(e.reset(),ze.free(e),this.callbackInfos[t]=null)}this.containCanceled=!0}purgeCanceled(){for(let t=this.callbackInfos.length-1;t>=0;--t)this.callbackInfos[t]||Ne(this.callbackInfos,t);this.containCanceled=!1}clear(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1}}const Ue=new z((()=>new Ve),16);class Ge{constructor(){this._callbackTable=st(!0)}on(t,e,i,n){if(!this.hasEventListener(t,e,i)){let s=this._callbackTable[t];s||(s=this._callbackTable[t]=Ue.alloc());const r=ze.alloc();r.set(e,i,n),s.callbackInfos.push(r)}return e}hasEventListener(t,e,i){const n=this._callbackTable&&this._callbackTable[t];if(!n)return!1;const s=n.callbackInfos;if(!e){if(n.isInvoking){for(let t=0;t<s.length;++t)if(s[t])return!0;return!1}return s.length>0}for(let t=0;t<s.length;++t){const n=s[t];if(n&&n.check()&&n.callback===e&&n.target===i)return!0}return!1}removeAll(t){const e=typeof t;if("string"===e||"number"===e){const e=this._callbackTable&&this._callbackTable[t];e&&(e.isInvoking?e.cancelAll():(e.clear(),Ue.free(e),delete this._callbackTable[t]))}else if(t)for(const e in this._callbackTable){const i=this._callbackTable[e];if(i.isInvoking){const e=i.callbackInfos;for(let n=0;n<e.length;++n){const s=e[n];s&&s.target===t&&i.cancel(n)}}else i.removeByTarget(t)}}off(t,e,i){const n=this._callbackTable&&this._callbackTable[t];if(n){const s=n.callbackInfos;if(e)for(let t=0;t<s.length;++t){const r=s[t];if(r&&r.callback===e&&r.target===i){n.cancel(t);break}}else this.removeAll(t)}}emit(t,e,i,n,s,r){const o=this._callbackTable&&this._callbackTable[t];if(o){const a=!o.isInvoking;o.isInvoking=!0;const l=o.callbackInfos;for(let o=0,a=l.length;o<a;++o){const a=l[o];if(a){const o=a.callback,l=a.target;a.once&&this.off(t,o,l),a.check()?l?o.call(l,e,i,n,s,r):o(e,i,n,s,r):this.off(t,o,l)}}a&&(o.isInvoking=!1,o.containCanceled&&o.purgeCanceled())}}clear(){for(const t in this._callbackTable){const e=this._callbackTable[t];e&&(e.clear(),Ue.free(e),delete this._callbackTable[t])}}}function ke(t){class e extends t{constructor(...t){super(...t),this._callbackTable=st(!0)}once(t,e,i){return this.on(t,e,i,!0)}targetOff(t){this.removeAll(t)}}const i=Ge.prototype,n=Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i));for(let t=0;t<n.length;++t){const s=n[t];if(!(s in e.prototype)){const t=Object.getOwnPropertyDescriptor(i,s);t&&Object.defineProperty(e.prototype,s,t)}}return e}const He=t("EventTarget",ke(class{}));n.EventTarget=He;const je={0:N.NONE,1:N.LAN,2:N.WWAN},We={0:F.WIN32,2:F.MACOS,3:F.ANDROID,4:F.IOS,5:F.IOS,6:F.OHOS},qe=new class extends He{get networkType(){return je[jsb.device.getNetworkType()]}constructor(){super(),this.isNative=void 0,this.isBrowser=void 0,this.isMobile=void 0,this.isLittleEndian=void 0,this.platform=void 0,this.language=void 0,this.nativeLanguage=void 0,this.os=void 0,this.osVersion=void 0,this.osMainVersion=void 0,this.browserType=void 0,this.browserVersion=void 0,this.pixelRatio=void 0,this.supportCapability=void 0,this.isNative=!0,this.isBrowser=!1,this.platform=We[__getPlatform()],this.isMobile=this.platform===F.ANDROID||this.platform===F.IOS||this.platform===F.OHOS,this.isLittleEndian=(()=>{const t=new ArrayBuffer(2);return new DataView(t).setInt16(0,256,!0),256===new Int16Array(t)[0]})();const t=__getCurrentLanguageCode();this.nativeLanguage=t?t.toLowerCase():B.UNKNOWN,this.language=__getCurrentLanguage(),this.os=__getOS(),this.osVersion=__getOSVersion(),this.osMainVersion=parseInt(this.osVersion),this.browserType=O.UNKNOWN,this.browserVersion="",this.pixelRatio=jsb.device.getDevicePixelRatio()||1,this.supportCapability={webp:!0,gl:!0,canvas:!0,imageBitmap:!1},this._registerEvent()}_registerEvent(){jsb.onPause=()=>{this.emit("hide")},jsb.onResume=()=>{this.emit("show")},jsb.onClose=()=>{this.emit("close")}}getBatteryLevel(){return jsb.device.getBatteryLevel()}triggerGC(){jsb.garbageCollect()}openURL(t){jsb.openURL(t)}now(){return Date.now?Date.now():+new Date}restartJSVM(){__restartVM()}close(){__close()}};function Xe(t){let e,i;return e=(t>65535)<<4,i=((t>>>=e)>255)<<3,e|=i,i=((t>>>=i)>15)<<2,e|=i,i=((t>>>=i)>3)<<1,e|=i,e|(t>>>=i)>>1}function Ye(t){let e=32;return(t&=-t)&&e--,65535&t&&(e-=16),16711935&t&&(e-=8),252645135&t&&(e-=4),858993459&t&&(e-=2),1431655765&t&&(e-=1),e}function Ke(t){return t+=0===t,--t,t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,1+(t|=t>>>16)}const $e=new Array(256);(t=>{for(let e=0;e<256;++e){let i=e,n=e,s=7;for(i>>>=1;i;i>>>=1)n<<=1,n|=1&i,--s;t[e]=n<<s&255}})($e);var Je=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:2147483647,INT_MIN:-2147483648,sign:function(t){return(t>0)-(t<0)},abs:function(t){const e=t>>31;return(t^e)-e},min:function(t,e){return e^(t^e)&-(t<e)},max:function(t,e){return t^(t^e)&-(t<e)},isPow2:function(t){return!(t&t-1||!t)},log2:Xe,log10:function(t){return t>=1e9?9:t>=1e8?8:t>=1e7?7:t>=1e6?6:t>=1e5?5:t>=1e4?4:t>=1e3?3:t>=100?2:t>=10?1:0},popCount:function(t){return 16843009*((t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459))+(t>>>4)&252645135)>>>24},countTrailingZeros:Ye,nextPow2:Ke,prevPow2:function(t){return t|=t>>>1,t|=t>>>2,t|=t>>>4,t|=t>>>8,(t|=t>>>16)-(t>>>1)},parity:function(t){return t^=t>>>16,t^=t>>>8,t^=t>>>4,27030>>>(t&=15)&1},reverse:function(t){return $e[255&t]<<24|$e[t>>>8&255]<<16|$e[t>>>16&255]<<8|$e[t>>>24&255]},interleave2:function(t,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))<<1},deinterleave2:function(t,e){return(t=65535&((t=16711935&((t=252645135&((t=858993459&((t=t>>>e&1431655765)|t>>>1))|t>>>2))|t>>>4))|t>>>16))<<16>>16},interleave3:function(t,e,i){return t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2),(t|=(e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2))<<1)|(i=1227133513&((i=3272356035&((i=251719695&((i=4278190335&((i&=1023)|i<<16))|i<<8))|i<<4))|i<<2))<<2},deinterleave3:function(t,e){return(t=1023&((t=4278190335&((t=251719695&((t=3272356035&((t=t>>>e&1227133513)|t>>>2))|t>>>4))|t>>>8))|t>>>16))<<22>>22},nextCombination:function(t){const e=t|t-1;return e+1|(~e&-~e)-1>>>Ye(t)+1}});t("bits",Je);let Ze,Qe,ti,ei,ii,ni,si=10,ri=0;const oi=new Map;ei=(t,e,i,n,s,r,o)=>{const a=oi.get(r);a&&a.logTimes>a.count&&(s(`'%s' is deprecated, please use '%s' instead. ${o}`,`${t}.${e}`,`${i}.${n}`),a.count++)},Ze=t("replaceProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=ri++;oi.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:si});const s=null!=i.target?i.target:t,r=null!=i.newName?i.newName:i.name,o=null!=i.targetName?i.targetName:e,a=s===t,l=i.suggest?`(${i.suggest})`:"";if(null!=i.customFunction)t[i.name]=function(){return ei(e,i.name,o,r,m,n,l),i.customFunction.call(this,...arguments)};else if(null!=i.customSetter||null!=i.customGetter){const s=null!=i.customSetter,a=null!=i.customGetter;s&&a?Object.defineProperty(t,i.name,{get(){return ei(e,i.name,o,r,m,n,l),i.customGetter.call(this)},set(t){ei(e,i.name,o,r,m,n,l),i.customSetter.call(this,t)},enumerable:!1}):s?Object.defineProperty(t,i.name,{set(t){ei(e,i.name,o,r,m,n,l),i.customSetter.call(this,t)},enumerable:!1}):a&&Object.defineProperty(t,i.name,{get(){return ei(e,i.name,o,r,m,n,l),i.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(t,i.name,{get(){return ei(e,i.name,o,r,m,n,l),a?this[r]:s[r]},set(t){ei(e,i.name,o,r,m,n,l),a?this[r]=t:s[r]=t},enumerable:!1})}))})),ni=(t,e,i,n,s)=>{const r=oi.get(n);r&&r.logTimes>r.count&&(i(`'%s' has been removed. ${s}`,`${t}.${e}`),r.count++)},Qe=t("removeProperty",((t,e,i)=>{null!=t&&i.forEach((i=>{const n=ri++;oi.set(n,{id:n,count:0,logTimes:void 0!==i.logTimes?i.logTimes:si});const s=i.suggest?`(${i.suggest})`:"";Object.defineProperty(t,i.name,{get:()=>ni(e,i.name,p,n,s),set(){ni(e,i.name,p,n,s)},enumerable:!1})}))})),ii=(t,e,i,n,s)=>{const r=oi.get(n);r&&r.logTimes>r.count&&(i(`'%s' is deprecated. ${s}`,`${t}.${e}`),r.count++)},ti=t("markAsWarning",((t,e,i)=>{if(null==t)return;const n=(e,i,n,s,r,o)=>{if(e.get){const t=e.get;e.get=function(){return ii(i,n,s,r,o),t.call(this)}}if(e.set){const t=e.set;e.set=function(e){ii(i,n,s,r,o),t.call(this,e)}}Object.defineProperty(t,n,e)};i.forEach((i=>{const s=i.name,r=Object.getOwnPropertyDescriptor(t,s);if(!r||!r.configurable)return;const o=ri++;oi.set(o,{id:o,count:0,logTimes:void 0!==i.logTimes?i.logTimes:si});const a=i.suggest?`(${i.suggest})`:"";if(void 0!==r.value)if("function"==typeof r.value){const i=r.value;t[s]=function(){return ii(e,s,m,o,a),i.call(this,...arguments)}}else{let i=r.value;Object.defineProperty(t,s,{configurable:!0,get:()=>(ii(e,s,m,o,a),i)}),r.writable&&Object.defineProperty(t,s,{set(t){ii(e,s,m,o,a),i=t}})}else n(r,e,s,m,o,a);Object.defineProperty(t,s,{enumerable:!1})}))}));const ai=Math.PI/180,li=180/Math.PI,ci=t("EPSILON",1e-6);function hi(t,e){return Math.abs(t-e)<=ci*Math.max(1,Math.abs(t),Math.abs(e))}function _i(t,e,i){return i=i||ci,Math.abs(t-e)<=i}function ui(t,e,i){if(e>i){const t=e;e=i,i=t}return t<e?e:t>i?i:t}function mi(t){return t<0?0:t>1?1:t}function pi(t,e,i){return t+(e-t)*i}function di(t){return t*ai}function fi(t){return t*li}const gi=t("random",Math.random);function yi(t,e){return Math.random()*(e-t)+t}function vi(t,e){return Math.floor(yi(t,e))}function xi(t){return(t=(9301*t+49297)%233280)/233280}function bi(t,e,i){return xi(t)*(i-e)+e}function Si(t,e,i){return Math.floor(bi(t,e,i))}function Ai(t){return--t,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Ci(t,e){return t-Math.floor(t/e)*e}function Ti(t,e){return t=Ci(t,2*e),e-Math.abs(t-e)}function wi(t,e,i){return(i-t)/(e-t)}function Ei(t){return Math.abs(t.x)>Math.abs(t.y)?Math.abs(t.x)>Math.abs(t.z)?t.x:t.z:Math.abs(t.y)>Math.abs(t.z)?t.y:t.z}function Pi(t,e){return Math.abs(t)>Math.abs(e)?t:e}function Di(t,e){e.forEach((e=>{Object.defineProperty(t,e,{enumerable:!0})}))}const Ii=1/255;class Ri extends Vt{static clone(t){const e=new Ri;return t._val?e._val=t._val:e._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,e}static copy(t,e){return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a,t}static set(t,e,i,n,s){return t.r=e,t.g=i,t.b=n,t.a=s,t}static fromHEX(t,e){return e=0===e.indexOf("#")?e.substring(1):e,t.r=parseInt(e.substr(0,2),16)||0,t.g=parseInt(e.substr(2,2),16)||0,t.b=parseInt(e.substr(4,2),16)||0,t.a=parseInt(e.substr(6,2),16)||255,t._val=(t.a<<24>>>0)+(t.b<<16)+(t.g<<8)+t.r,t}static add(t,e,i){return t.r=e.r+i.r,t.g=e.g+i.g,t.b=e.b+i.b,t.a=e.a+i.a,t}static subtract(t,e,i){return t.r=e.r-i.r,t.g=e.g-i.g,t.b=e.b-i.b,t.a=e.a-i.a,t}static multiply(t,e,i){return t.r=e.r*i.r,t.g=e.g*i.g,t.b=e.b*i.b,t.a=e.a*i.a,t}static divide(t,e,i){return t.r=e.r/i.r,t.g=e.g/i.g,t.b=e.b/i.b,t.a=e.a/i.a,t}static scale(t,e,i){return t.r=e.r*i,t.g=e.g*i,t.b=e.b*i,t.a=e.a*i,t}static lerp(t,e,i,n){let s=e.r,r=e.g,o=e.b,a=e.a;return s+=(i.r-s)*n,r+=(i.g-r)*n,o+=(i.b-o)*n,a+=(i.a-a)*n,t._val=Math.floor((a<<24>>>0)+(o<<16)+(r<<8)+s),t}static toArray(t,e,i=0){const n=e instanceof Ri||e.a>1?1/255:1;return t[i+0]=e.r*n,t[i+1]=e.g*n,t[i+2]=e.b*n,t[i+3]=e.a*n,t}static fromArray(t,e,i=0){return e.r=255*t[i+0],e.g=255*t[i+1],e.b=255*t[i+2],e.a=255*t[i+3],e}static strictEquals(t,e){return t.r===e.r&&t.g===e.g&&t.b===e.b&&t.a===e.a}static equals(t,e,i=ci){return Math.abs(t.r-e.r)<=i*Math.max(1,Math.abs(t.r),Math.abs(e.r))&&Math.abs(t.g-e.g)<=i*Math.max(1,Math.abs(t.g),Math.abs(e.g))&&Math.abs(t.b-e.b)<=i*Math.max(1,Math.abs(t.b),Math.abs(e.b))&&Math.abs(t.a-e.a)<=i*Math.max(1,Math.abs(t.a),Math.abs(e.a))}static hex(t){return(255*t.r<<24|255*t.g<<16|255*t.b<<8|255*t.a)>>>0}get r(){return 255&this._val}set r(t){t=~~ui(t,0,255),this._val=(4294967040&this._val|t)>>>0}get g(){return(65280&this._val)>>8}set g(t){t=~~ui(t,0,255),this._val=(4294902015&this._val|t<<8)>>>0}get b(){return(16711680&this._val)>>16}set b(t){t=~~ui(t,0,255),this._val=(4278255615&this._val|t<<16)>>>0}get a(){return(4278190080&this._val)>>>24}set a(t){t=~~ui(t,0,255),this._val=(16777215&this._val|t<<24)>>>0}get x(){return this.r*Ii}set x(t){this.r=255*t}get y(){return this.g*Ii}set y(t){this.g=255*t}get z(){return this.b*Ii}set z(t){this.b=255*t}get w(){return this.a*Ii}set w(t){this.a=255*t}constructor(t,e,i,n){super(),this._val=0,"string"==typeof t?this.fromHEX(t):void 0!==e?this.set(t,e,i,n):this.set(t)}clone(){const t=new Ri;return t._val=this._val,t}equals(t){return t&&this._val===t._val}lerp(t,e){let i=this.r,n=this.g,s=this.b,r=this.a;return i+=(t.r-i)*e,n+=(t.g-n)*e,s+=(t.b-s)*e,r+=(t.a-r)*e,this._val=Math.floor((r<<24>>>0)+(s<<16)+(n<<8)+i),this}toString(){return`rgba(${this.r.toFixed()}, ${this.g.toFixed()}, ${this.b.toFixed()}, ${this.a.toFixed()})`}toCSS(t="rgba"){return"rgba"===t?`rgba(${this.r},${this.g},${this.b},${(this.a*Ii).toFixed(2)})`:"rgb"===t?`rgb(${this.r},${this.g},${this.b})`:`#${this.toHEX(t)}`}fromHEX(t){t=0===t.indexOf("#")?t.substring(1):t;const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||255;return this._val=(s<<24>>>0)+(n<<16)+(i<<8)+(0|e),this}toHEX(t="#rrggbb"){const e="0",i=[(this.r<16?e:"")+this.r.toString(16),(this.g<16?e:"")+this.g.toString(16),(this.b<16?e:"")+this.b.toString(16)];return"#rgb"===t?(i[0]=i[0][0],i[1]=i[1][0],i[2]=i[2][0]):"#rrggbbaa"===t&&i.push((this.a<16?e:"")+this.a.toString(16)),i.join("")}toRGBValue(){return 16777215&this._val}fromHSV(t,e,i){let n=0,s=0,r=0;if(0===e)n=s=r=i;else if(0===i)n=s=r=0;else{1===t&&(t=0),t*=6;const o=Math.floor(t),a=t-o,l=i*(1-e),c=i*(1-e*a),h=i*(1-e*(1-a));switch(o){case 0:n=i,s=h,r=l;break;case 1:n=c,s=i,r=l;break;case 2:n=l,s=i,r=h;break;case 3:n=l,s=c,r=i;break;case 4:n=h,s=l,r=i;break;case 5:n=i,s=l,r=c}}return n*=255,s*=255,r*=255,this._val=(this.a<<24>>>0)+(r<<16)+(s<<8)+(0|n),this}toHSV(){const t=this.r*Ii,e=this.g*Ii,i=this.b*Ii,n={h:0,s:0,v:0},s=Math.max(t,e,i),r=Math.min(t,e,i);let o=0;return n.v=s,n.s=s?(s-r)/s:0,n.s?(o=s-r,n.h=t===s?(e-i)/o:e===s?2+(i-t)/o:4+(t-e)/o,n.h/=6,n.h<0&&(n.h+=1)):n.h=0,n}set(t,e,i,n){return"object"==typeof t?null!=t._val?this._val=t._val:(e=t.g||0,i=t.b||0,n="number"==typeof t.a?t.a:255,t=t.r||0,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)):(t=t||0,e=e||0,i=i||0,n="number"==typeof n?n:255,this._val=(n<<24>>>0)+(i<<16)+(e<<8)+(0|t)),this}multiply(t){const e=(255&this._val)*t.r>>8,i=(65280&this._val)*t.g>>8,n=(16711680&this._val)*t.b>>8,s=((4278190080&this._val)>>>8)*t.a;return this._val=4278190080&s|16711680&n|65280&i|255&e,this}_set_r_unsafe(t){return this._val=(4294967040&this._val|t)>>>0,this}_set_g_unsafe(t){return this._val=(4294902015&this._val|t<<8)>>>0,this}_set_b_unsafe(t){return this._val=(4278255615&this._val|t<<16)>>>0,this}_set_a_unsafe(t){return this._val=(16777215&this._val|t<<24)>>>0,this}}function Mi(t,e,i,n){return new Ri(t,e,i,n)}t("Color",Ri),Ri.WHITE=Object.freeze(new Ri(255,255,255,255)),Ri.GRAY=Object.freeze(new Ri(127,127,127,255)),Ri.BLACK=Object.freeze(new Ri(0,0,0,255)),Ri.TRANSPARENT=Object.freeze(new Ri(0,0,0,0)),Ri.RED=Object.freeze(new Ri(255,0,0,255)),Ri.GREEN=Object.freeze(new Ri(0,255,0,255)),Ri.BLUE=Object.freeze(new Ri(0,0,255,255)),Ri.CYAN=Object.freeze(new Ri(0,255,255,255)),Ri.MAGENTA=Object.freeze(new Ri(255,0,255,255)),Ri.YELLOW=Object.freeze(new Ri(255,255,0,255)),we.fastDefine("cc.Color",Ri,{r:0,g:0,b:0,a:255}),n.Color=Ri,n.color=Mi;const Oi=t("MATH_FLOAT_ARRAY",Float32Array);class Bi extends Vt{static createFloatArray(t){return new Oi(t)}get array(){return this._array}}t("MathBase",Bi);class Ni extends Bi{static zero(t){return t.x=0,t.y=0,t.z=0,t}static clone(t){return new Ni(t.x,t.y,t.z)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t}static set(t,e,i,n){return t.x=e,t.y=i,t.z=n,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return Math.sqrt(i*i+n*n+s*s)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z;return i*i+n*n+s*s}static len(t){const e=t.x,i=t.y,n=t.z;return Math.sqrt(e*e+i*i+n*n)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z;return e*e+i*i+n*n}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t}static invert(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t}static invertSafe(t,e){const i=e.x,n=e.y,s=e.z;return Math.abs(i)<ci?t.x=0:t.x=1/i,Math.abs(n)<ci?t.y=0:t.y=1/n,Math.abs(s)<ci?t.z=0:t.z=1/s,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z;let r=i*i+n*n+s*s;return r>0&&(r=1/Math.sqrt(r),t.x=i*r,t.y=n*r,t.z=s*r),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static cross(t,e,i){const{x:n,y:s,z:r}=e,{x:o,y:a,z:l}=i;return t.x=s*l-r*a,t.y=r*o-n*l,t.z=n*a-s*o,t}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t}static random(t,e){e=e||1;const i=2*gi()*Math.PI,n=2*gi()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r+i.m15;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r+i.m12)*o,t.y=(i.m01*n+i.m05*s+i.m09*r+i.m13)*o,t.z=(i.m02*n+i.m06*s+i.m10*r+i.m14)*o,t}static transformMat4Normal(t,e,i){const n=e.x,s=e.y,r=e.z;let o=i.m03*n+i.m07*s+i.m11*r;return o=o?Math.abs(1/o):1,t.x=(i.m00*n+i.m04*s+i.m08*r)*o,t.y=(i.m01*n+i.m05*s+i.m09*r)*o,t.z=(i.m02*n+i.m06*s+i.m10*r)*o,t}static transformMat3(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=n*i.m00+s*i.m03+r*i.m06,t.y=n*i.m01+s*i.m04+r*i.m07,t.z=n*i.m02+s*i.m05+r*i.m08,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13,t.x=i.m02*n+i.m06*s+i.m10*r+i.m14,t}static transformQuat(t,e,i){const n=i.w*e.x+i.y*e.z-i.z*e.y,s=i.w*e.y+i.z*e.x-i.x*e.z,r=i.w*e.z+i.x*e.y-i.y*e.x,o=-i.x*e.x-i.y*e.y-i.z*e.z;return t.x=n*i.w+o*-i.x+s*-i.z-r*-i.y,t.y=s*i.w+o*-i.y+r*-i.x-n*-i.z,t.z=r*i.w+o*-i.z+n*-i.y-s*-i.x,t}static transformRTS(t,e,i,n,s){const r=e.x*s.x,o=e.y*s.y,a=e.z*s.z,l=i.w*r+i.y*a-i.z*o,c=i.w*o+i.z*r-i.x*a,h=i.w*a+i.x*o-i.y*r,_=-i.x*r-i.y*o-i.z*a;return t.x=l*i.w+_*-i.x+c*-i.z-h*-i.y+n.x,t.y=c*i.w+_*-i.y+h*-i.x-l*-i.z+n.y,t.z=h*i.w+_*-i.z+l*-i.y-c*-i.x+n.z,t}static transformInverseRTS(t,e,i,n,s){const r=e.x-n.x,o=e.y-n.y,a=e.z-n.z,l=i.w*r-i.y*a+i.z*o,c=i.w*o-i.z*r+i.x*a,h=i.w*a-i.x*o+i.y*r,_=i.x*r+i.y*o+i.z*a;return t.x=(l*i.w+_*i.x+c*i.z-h*i.y)/s.x,t.y=(c*i.w+_*i.y+h*i.x-l*i.z)/s.y,t.z=(h*i.w+_*i.z+l*i.y-c*i.x)/s.z,t}static rotateX(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=s,h=r*a-o*l,_=r*l+o*a;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateY(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=o*l+s*a,h=r,_=o*a-s*l;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static rotateZ(t,e,i,n){const s=e.x-i.x,r=e.y-i.y,o=e.z-i.z,a=Math.cos(n),l=Math.sin(n),c=s*a-r*l,h=s*l+r*a,_=o;return t.x=c+i.x,t.y=h+i.y,t.z=_+i.z,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z}static equals(t,e,i=ci){const{x:n,y:s,z:r}=t,{x:o,y:a,z:l}=e;return Math.abs(n-o)<=i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(s-a)<=i*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(r-l)<=i*Math.max(1,Math.abs(r),Math.abs(l))}static angle(t,e){Ni.normalize(Li,t),Ni.normalize(Fi,e);const i=Ni.dot(Li,Fi);return i>1?0:i<-1?Math.PI:Math.acos(i)}static projectOnPlane(t,e,i){return Ni.subtract(t,e,Ni.project(t,e,i))}static project(t,e,i){const n=Ni.lengthSqr(i);return n<1e-6?Ni.set(t,0,0,0):Ni.multiplyScalar(t,i,Ni.dot(e,i)/n)}get x(){return this._array[0]}set x(t){this._array[0]=t}get y(){return this._array[1]}set y(t){this._array[1]=t}get z(){return this._array[2]}set z(t){this._array[2]=t}constructor(t,e,i){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.fill(0);else{const e=t.array;this._array=Bi.createFloatArray(3),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2]}else this._array=Bi.createFloatArray(3),this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0}clone(){return new Ni(this._array[0],this._array[1],this._array[2])}set(t,e,i){return t&&"object"==typeof t?(this._array[0]=t.x,this._array[1]=t.y,this._array[2]=t.z):(this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0),this}equals(t,e=ci){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))}equals3f(t,e,i,n=ci){return Math.abs(this._array[0]-t)<=n*Math.max(1,Math.abs(this._array[0]),Math.abs(t))&&Math.abs(this._array[1]-e)<=n*Math.max(1,Math.abs(this._array[1]),Math.abs(e))&&Math.abs(this._array[2]-i)<=n*Math.max(1,Math.abs(this._array[2]),Math.abs(i))}strictEquals(t){const e=t.array;return this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]}strictEquals3f(t,e,i){return this._array[0]===t&&this._array[1]===e&&this._array[2]===i}toString(){return`(${this._array[0].toFixed(2)}, ${this._array[1].toFixed(2)}, ${this._array[2].toFixed(2)})`}lerp(t,e){return this._array[0]+=e*(t.x-this._array[0]),this._array[1]+=e*(t.y-this._array[1]),this._array[2]+=e*(t.z-this._array[2]),this}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this}add3f(t,e,i){return this._array[0]+=t,this._array[1]+=e,this._array[2]+=i,this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this}subtract3f(t,e,i){return this._array[0]-=t,this._array[1]-=e,this._array[2]-=i,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec3.multiply for vector * vector operation"),this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this}multiply(t){"object"!=typeof t&&console.warn("should use Vec3.scale for vector * scalar operation");const e=t.array;return this._array[0]*=e[0],this._array[1]*=e[1],this._array[2]*=e[2],this}multiply3f(t,e,i){return this._array[0]*=t,this._array[1]*=e,this._array[2]*=i,this}divide(t){const e=t.array;return this._array[0]/=e[0],this._array[1]/=e[1],this._array[2]/=e[2],this}divide3f(t,e,i){return this._array[0]/=t,this._array[1]/=e,this._array[2]/=i,this}negative(){return this._array[0]=-this._array[0],this._array[1]=-this._array[1],this._array[2]=-this._array[2],this}clampf(t,e){const i=t.array,n=e.array;return this._array[0]=ui(this._array[0],i[0],n[0]),this._array[1]=ui(this._array[1],i[1],n[1]),this._array[2]=ui(this._array[2],i[2],n[2]),this}dot(t){const e=t.array;return this._array[0]*e[0]+this._array[1]*e[1]+this._array[2]*e[2]}cross(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=t.array[0],r=t.array[1],o=t.array[2];return this._array[0]=i*o-n*r,this._array[1]=n*s-e*o,this._array[2]=e*r-i*s,this}length(){return Math.sqrt(this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2])}lengthSqr(){return this._array[0]*this._array[0]+this._array[1]*this._array[1]+this._array[2]*this._array[2]}normalize(){const t=this._array[0],e=this._array[1],i=this._array[2];let n=t*t+e*e+i*i;return n>0&&(n=1/Math.sqrt(n),this._array[0]=t*n,this._array[1]=e*n,this._array[2]=i*n),this}transformMat4(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=t.array;let r=s[3]*e+s[7]*i+s[11]*n+s[15];return r=r?1/r:1,this._array[0]=(s[0]*e+s[4]*i+s[8]*n+s[12])*r,this._array[1]=(s[1]*e+s[5]*i+s[9]*n+s[13])*r,this._array[2]=(s[2]*e+s[6]*i+s[10]*n+s[14])*r,this}}t("Vec3",Ni),Ni.UNIT_X=Object.freeze(new Ni(1,0,0)),Ni.UNIT_Y=Object.freeze(new Ni(0,1,0)),Ni.UNIT_Z=Object.freeze(new Ni(0,0,1)),Ni.RIGHT=Object.freeze(new Ni(1,0,0)),Ni.UP=Object.freeze(new Ni(0,1,0)),Ni.FORWARD=Object.freeze(new Ni(0,0,-1)),Ni.ZERO=Object.freeze(new Ni(0,0,0)),Ni.ONE=Object.freeze(new Ni(1,1,1)),Ni.NEG_ONE=Object.freeze(new Ni(-1,-1,-1));const Li=new Ni,Fi=new Ni;function zi(t,e,i){return new Ni(t,e,i)}Di(Ni.prototype,["x","y","z"]),we.fastDefine("cc.Vec3",Ni,{x:0,y:0,z:0}),n.Vec3=Ni,n.v3=zi;class Vi extends Bi{static clone(t){return new Vi(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static set(t,e,i,n,s,r,o,a,l,c){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=l,t.m08=c,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m05;t.m01=e.m03,t.m02=e.m06,t.m03=i,t.m05=e.m07,t.m06=n,t.m07=s}else t.m00=e.m00,t.m01=e.m03,t.m02=e.m06,t.m03=e.m01,t.m04=e.m04,t.m05=e.m07,t.m06=e.m02,t.m07=e.m05,t.m08=e.m08;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=h*o-a*c,u=-h*r+a*l,m=c*r-o*l;let p=i*_+n*u+s*m;return 0===p?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t):(p=1/p,t.m00=_*p,t.m01=(-h*n+s*c)*p,t.m02=(a*n-s*o)*p,t.m03=u*p,t.m04=(h*i-s*l)*p,t.m05=(-a*i+s*r)*p,t.m06=m*p,t.m07=(-c*i+n*l)*p,t.m08=(o*i-n*r)*p,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,l=t.m07,c=t.m08;return e*(c*r-o*l)+i*(-c*s+o*a)+n*(l*s-r*a)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.m00,m=i.m01,p=i.m02,d=i.m03,f=i.m04,g=i.m05,y=i.m06,v=i.m07,x=i.m08;return t.m00=u*n+m*o+p*c,t.m01=u*s+m*a+p*h,t.m02=u*r+m*l+p*_,t.m03=d*n+f*o+g*c,t.m04=d*s+f*a+g*h,t.m05=d*r+f*l+g*_,t.m06=y*n+v*o+x*c,t.m07=y*s+v*a+x*h,t.m08=y*r+v*l+x*_,t}static multiplyMat4(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.m00,m=i.m01,p=i.m02,d=i.m04,f=i.m05,g=i.m06,y=i.m08,v=i.m09,x=i.m10;return t.m00=u*n+m*o+p*c,t.m01=u*s+m*a+p*h,t.m02=u*r+m*l+p*_,t.m03=d*n+f*o+g*c,t.m04=d*s+f*a+g*h,t.m05=d*r+f*l+g*_,t.m06=y*n+v*o+x*c,t.m07=y*s+v*a+x*h,t.m08=y*r+v*l+x*_,t}static transform(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=i.x,m=i.y;return t.m00=n,t.m01=s,t.m02=r,t.m03=o,t.m04=a,t.m05=l,t.m06=u*n+m*o+c,t.m07=u*s+m*a+h,t.m08=u*r+m*l+_,t}static scale(t,e,i){const n=i.x,s=i.y;return t.m00=n*e.m00,t.m01=n*e.m01,t.m02=n*e.m02,t.m03=s*e.m03,t.m04=s*e.m04,t.m05=s*e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t}static rotate(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=Math.sin(i),m=Math.cos(i);return t.m00=m*n+u*o,t.m01=m*s+u*a,t.m02=m*r+u*l,t.m03=m*o-u*n,t.m04=m*a-u*s,t.m05=m*l-u*r,t.m06=c,t.m07=h,t.m08=_,t}static fromMat4(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m04,t.m04=e.m05,t.m05=e.m06,t.m06=e.m08,t.m07=e.m09,t.m08=e.m10,t}static fromViewUp(t,e,i){return Ni.lengthSqr(e)<ci*ci?(Vi.identity(t),t):(Ni.normalize(Ui,Ni.cross(Ui,i||Ni.UNIT_Y,e)),Ni.lengthSqr(Ui)<ci*ci?(Vi.identity(t),t):(Ni.cross(Gi,e,Ui),Vi.set(t,Ui.x,Ui.y,Ui.z,Gi.x,Gi.y,Gi.z,e.x,e.y,e.z),t))}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=1,t.m05=0,t.m06=e.x,t.m07=e.y,t.m08=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=e.y,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=-i,t.m04=n,t.m05=0,t.m06=0,t.m07=0,t.m08=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,l=s+s,c=i*o,h=n*o,_=n*a,u=s*o,m=s*a,p=s*l,d=r*o,f=r*a,g=r*l;return t.m00=1-_-p,t.m03=h-g,t.m06=u+f,t.m01=h+g,t.m04=1-c-p,t.m07=m-d,t.m02=u-f,t.m05=m+d,t.m08=1-c-_,t}static inverseTransposeMat4(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,p=e.m12,d=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,b=n*l-s*a,S=n*c-r*a,A=s*c-r*l,C=h*d-_*p,T=h*f-u*p,w=h*g-m*p,E=_*f-u*d,P=_*g-m*d,D=u*g-m*f;let I=y*D-v*P+x*E+b*w-S*T+A*C;return I?(I=1/I,t.m00=(a*D-l*P+c*E)*I,t.m01=(l*w-o*D-c*T)*I,t.m02=(o*P-a*w+c*C)*I,t.m03=(s*P-n*D-r*E)*I,t.m04=(i*D-s*w+r*T)*I,t.m05=(n*w-i*P-r*C)*I,t.m06=(d*A-f*S+g*b)*I,t.m07=(f*x-p*A-g*v)*I,t.m08=(p*S-d*x+g*y)*I,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=i.m00*n+e.m00,t.m01=i.m01*n+e.m01,t.m02=i.m02*n+e.m02,t.m03=i.m03*n+e.m03,t.m04=i.m04*n+e.m04,t.m05=i.m05*n+e.m05,t.m06=i.m06*n+e.m06,t.m07=i.m07*n+e.m07,t.m08=i.m08*n+e.m08,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08}static equals(t,e,i=ci){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))}get m00(){return this._array[0]}set m00(t){this._array[0]=t}get m01(){return this._array[1]}set m01(t){this._array[1]=t}get m02(){return this._array[2]}set m02(t){this._array[2]=t}get m03(){return this._array[3]}set m03(t){this._array[3]=t}get m04(){return this._array[4]}set m04(t){this._array[4]=t}get m05(){return this._array[5]}set m05(t){this._array[5]=t}get m06(){return this._array[6]}set m06(t){this._array[6]=t}get m07(){return this._array[7]}set m07(t){this._array[7]=t}get m08(){return this._array[8]}set m08(t){this._array[8]=t}constructor(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,l=1){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.set([1,0,0,0,1,0,0,0,1]);else{const e=t.array;this._array=Bi.createFloatArray(9),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8]}else this._array=Bi.createFloatArray(9),this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=l}clone(){const t=this._array;return new Vi(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}set(t=1,e=0,i=0,n=0,s=1,r=0,o=0,a=0,l=1){if(t&&"object"==typeof t){const e=t.array;this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8]}else this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=l;return this}equals(t,e=ci){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=e*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=e*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=e*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=e*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=e*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))}strictEquals(t){const e=t.array;return this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]&&this._array[4]===e[4]&&this._array[5]===e[5]&&this._array[6]===e[6]&&this._array[7]===e[7]&&this._array[8]===e[8]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]},\n${this._array[3]},\n${this._array[4]}, ${this._array[5]},\n${this._array[6]}, ${this._array[7]},\n${this._array[8]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=1,this._array[5]=0,this._array[6]=0,this._array[7]=0,this._array[8]=1,this}transpose(){const t=this._array[1],e=this._array[2],i=this._array[5];return this._array[1]=this._array[3],this._array[2]=this._array[6],this._array[3]=t,this._array[5]=this._array[7],this._array[6]=e,this._array[7]=i,this}invert(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],l=this._array[8],c=l*s-r*a,h=-l*n+r*o,_=a*n-s*o;let u=t*c+e*h+i*_;return 0===u?(this.set(0,0,0,0,0,0,0,0,0),this):(u=1/u,this._array[0]=c*u,this._array[1]=(-l*e+i*a)*u,this._array[2]=(r*e-i*s)*u,this._array[3]=h*u,this._array[4]=(l*t-i*o)*u,this._array[5]=(-r*t+i*n)*u,this._array[6]=_*u,this._array[7]=(-a*t+e*o)*u,this._array[8]=(s*t-e*n)*u,this)}determinant(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],l=this._array[8];return t*(l*s-r*a)+e*(-l*n+r*o)+i*(a*n-s*o)}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this._array[3]+=e[3],this._array[4]+=e[4],this._array[5]+=e[5],this._array[6]+=e[6],this._array[7]+=e[7],this._array[8]+=e[8],this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this._array[3]-=e[3],this._array[4]-=e[4],this._array[5]-=e[5],this._array[6]-=e[6],this._array[7]-=e[7],this._array[8]-=e[8],this}multiply(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],l=this._array[7],c=this._array[8],h=t.array,_=h[0],u=h[1],m=h[2],p=h[3],d=h[4],f=h[5],g=h[6],y=h[7],v=h[8];return this._array[0]=_*e+u*s+m*a,this._array[1]=_*i+u*r+m*l,this._array[2]=_*n+u*o+m*c,this._array[3]=p*e+d*s+f*a,this._array[4]=p*i+d*r+f*l,this._array[5]=p*n+d*o+f*c,this._array[6]=g*e+y*s+v*a,this._array[7]=g*i+y*r+v*l,this._array[8]=g*n+y*o+v*c,this}multiplyScalar(t){return this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this._array[3]*=t,this._array[4]*=t,this._array[5]*=t,this._array[6]*=t,this._array[7]*=t,this._array[8]*=t,this}scale(t){const e=t.array[0],i=t.array[1];return this._array[0]*=e,this._array[1]*=e,this._array[2]*=e,this._array[3]*=i,this._array[4]*=i,this._array[5]*=i,this}rotate(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],l=this._array[7],c=this._array[8],h=Math.sin(t),_=Math.cos(t);return this._array[0]=_*e+h*s,this._array[1]=_*i+h*r,this._array[2]=_*n+h*o,this._array[3]=_*s-h*e,this._array[4]=_*r-h*i,this._array[5]=_*o-h*n,this._array[6]=a,this._array[7]=l,this._array[8]=c,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,l=e*r,c=i*r,h=i*o,_=n*r,u=n*o,m=n*a,p=s*r,d=s*o,f=s*a;return this._array[0]=1-h-m,this._array[3]=c-f,this._array[6]=_+d,this._array[1]=c+f,this._array[4]=1-l-m,this._array[7]=u-p,this._array[2]=_-d,this._array[5]=u+p,this._array[8]=1-l-h,this}}t("Mat3",Vi),Vi.IDENTITY=Object.freeze(new Vi);const Ui=new Ni,Gi=new Ni;Di(Vi.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08"]),we.fastDefine("cc.Mat3",Vi,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),n.Mat3=Vi;class ki extends Bi{static clone(t){return new ki(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static identity(t){return t.x=0,t.y=0,t.z=0,t.w=1,t}static rotationTo(t,e,i){const n=Ni.dot(e,i);return n<-.999999?(Ni.cross(Wi,Ni.UNIT_X,e),Wi.length()<1e-6&&Ni.cross(Wi,Ni.UNIT_Y,e),Ni.normalize(Wi,Wi),ki.fromAxisAngle(t,Wi,Math.PI),t):n>.999999?(t.x=0,t.y=0,t.z=0,t.w=1,t):(Ni.cross(Wi,e,i),t.x=Wi.x,t.y=Wi.y,t.z=Wi.z,t.w=1+n,ki.normalize(t,t))}static getAxisAngle(t,e){const i=2*Math.acos(e.w),n=Math.sin(i/2);return 0!==n?(t.x=e.x/n,t.y=e.y/n,t.z=e.z/n):(t.x=1,t.y=0,t.z=0),i}static multiply(t,e,i){const n=e.x*i.w+e.w*i.x+e.y*i.z-e.z*i.y,s=e.y*i.w+e.w*i.y+e.z*i.x-e.x*i.z,r=e.z*i.w+e.w*i.z+e.x*i.y-e.y*i.x,o=e.w*i.w-e.x*i.x-e.y*i.y-e.z*i.z;return t.x=n,t.y=s,t.z=r,t.w=o,t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static rotateX(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s+l*n,t.y=o*s+a*n,t.z=a*s-o*n,t.w=l*s-r*n,t}static rotateY(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s-a*n,t.y=o*s+l*n,t.z=a*s+r*n,t.w=l*s-o*n,t}static rotateZ(t,e,i){i*=.5;const n=Math.sin(i),s=Math.cos(i),{x:r,y:o,z:a,w:l}=e;return t.x=r*s+o*n,t.y=o*s-r*n,t.z=a*s+l*n,t.w=l*s-a*n,t}static rotateAround(t,e,i,n){return ki.invert(Hi,e),Ni.transformQuat(Wi,i,Hi),ki.fromAxisAngle(Hi,Wi,n),ki.multiply(t,e,Hi),t}static rotateAroundLocal(t,e,i,n){return ki.fromAxisAngle(Hi,i,n),ki.multiply(t,e,Hi),t}static calculateW(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=Math.sqrt(Math.abs(1-e.x*e.x-e.y*e.y-e.z*e.z)),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static slerp(t,e,i,n){let s=0,r=0,o=i.x,a=i.y,l=i.z,c=i.w,h=e.x*i.x+e.y*i.y+e.z*i.z+e.w*i.w;if(h<0&&(h=-h,o=-o,a=-a,l=-l,c=-c),1-h>1e-6){const t=Math.acos(h),e=Math.sin(t);s=Math.sin((1-n)*t)/e,r=Math.sin(n*t)/e}else s=1-n,r=n;return t.x=s*e.x+r*o,t.y=s*e.y+r*a,t.z=s*e.z+r*l,t.w=s*e.w+r*c,t}static sqlerp(t,e,i,n,s,r){return ki.slerp(Hi,e,s,r),ki.slerp(ji,i,n,r),ki.slerp(t,Hi,ji,2*r*(1-r)),t}static invert(t,e){const i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w,n=i?1/i:0;return t.x=-e.x*n,t.y=-e.y*n,t.z=-e.z*n,t.w=e.w*n,t}static conjugate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=e.w,t}static len(t){return Math.sqrt(t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w)}static lengthSqr(t){return t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w}static normalize(t,e){let i=e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w;return i>0&&(i=1/Math.sqrt(i),t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i),t}static fromAxes(t,e,i,n){return Vi.set(qi,e.x,e.y,e.z,i.x,i.y,i.z,n.x,n.y,n.z),ki.normalize(t,ki.fromMat3(t,qi))}static fromViewUp(t,e,i){return Vi.fromViewUp(qi,e,i),ki.normalize(t,ki.fromMat3(t,qi))}static fromAxisAngle(t,e,i){i*=.5;const n=Math.sin(i);return t.x=n*e.x,t.y=n*e.y,t.z=n*e.z,t.w=Math.cos(i),t}static fromMat3(t,e){const{m00:i,m03:n,m06:s,m01:r,m04:o,m07:a,m02:l,m05:c,m08:h}=e,_=i+o+h;if(_>0){const e=.5/Math.sqrt(_+1);t.w=.25/e,t.x=(c-a)*e,t.y=(s-l)*e,t.z=(r-n)*e}else if(i>o&&i>h){const e=2*Math.sqrt(1+i-o-h);t.w=(c-a)/e,t.x=.25*e,t.y=(n+r)/e,t.z=(s+l)/e}else if(o>h){const e=2*Math.sqrt(1+o-i-h);t.w=(s-l)/e,t.x=(n+r)/e,t.y=.25*e,t.z=(a+c)/e}else{const e=2*Math.sqrt(1+h-i-o);t.w=(r-n)/e,t.x=(s+l)/e,t.y=(a+c)/e,t.z=.25*e}return t}static fromEuler(t,e,i,n){e*=Xi,i*=Xi,n*=Xi;const s=Math.sin(e),r=Math.cos(e),o=Math.sin(i),a=Math.cos(i),l=Math.sin(n),c=Math.cos(n);return t.x=s*a*c+r*o*l,t.y=r*o*c+s*a*l,t.z=r*a*l-s*o*c,t.w=r*a*c-s*o*l,t}static fromAngleZ(t,e){return e*=Xi,t.x=t.y=0,t.z=Math.sin(e),t.w=Math.cos(e),t}static toAxisX(t,e){const i=2*e.y,n=2*e.z;return t.x=1-i*e.y-n*e.z,t.y=i*e.x+n*e.w,t.z=n*e.x+i*e.w,t}static toAxisY(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=n*e.x-s*e.w,t.y=1-i*e.x-s*e.z,t.z=s*e.y+i*e.w,t}static toAxisZ(t,e){const i=2*e.x,n=2*e.y,s=2*e.z;return t.x=s*e.x-n*e.w,t.y=s*e.y-i*e.w,t.z=1-i*e.x-n*e.y,t}static toEuler(t,e,i){const{x:n,y:s,z:r,w:o}=e;let a=0,l=0,c=0;const h=n*s+r*o;if(h>.499999)a=0,l=fi(2*Math.atan2(n,o)),c=90;else if(h<-.499999)a=0,l=-fi(2*Math.atan2(n,o)),c=-90;else{const t=n*n,e=s*s,_=r*r;a=fi(Math.atan2(2*n*o-2*s*r,1-2*t-2*_)),l=fi(Math.atan2(2*s*o-2*n*r,1-2*e-2*_)),c=fi(Math.asin(2*h)),i&&(a=-180*Math.sign(a+1e-6)+a,l=-180*Math.sign(l+1e-6)+l,c=180*Math.sign(c+1e-6)-c)}return t.x=a,t.y=l,t.z=c,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=ci){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}get x(){return this._array[0]}set x(t){this._array[0]=t}get y(){return this._array[1]}set y(t){this._array[1]=t}get z(){return this._array[2]}set z(t){this._array[2]=t}get w(){return this._array[3]}set w(t){this._array[3]=t}constructor(t,e,i,n){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.fill(0),this._array[3]=1;else{const e=t.array;this._array=Bi.createFloatArray(4),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3]}else this._array=Bi.createFloatArray(4),this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0,this._array[3]=null!=n?n:1}clone(){return new ki(this._array[0],this._array[1],this._array[2],this._array[3])}set(t,e,i,n){if(t&&"object"==typeof t){const e=t.array;this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3]}else this._array[0]=t||0,this._array[1]=e||0,this._array[2]=i||0,this._array[3]=null!=n?n:1;return this}equals(t,e=ci){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))}strictEquals(t){const e=t.array;return t&&this._array[0]===e[0]&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]}getEulerAngles(t){return ki.toEuler(t,this)}lerp(t,e){const i=t.array;return this._array[0]+=e*(i[0]-this._array[0]),this._array[1]+=e*(i[1]-this._array[1]),this._array[2]+=e*(i[2]-this._array[2]),this._array[3]+=e*(i[3]-this._array[3]),this}slerp(t,e){return ki.slerp(this,this,t,e)}length(){const t=this._array;return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3])}lengthSqr(){const t=this._array;return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]}}t("Quat",ki),ki.IDENTITY=Object.freeze(new ki),Di(ki.prototype,["x","y","z","w"]);const Hi=new ki,ji=new ki,Wi=new Ni,qi=new Vi,Xi=.5*Math.PI/180;function Yi(t=0,e=0,i=0,n=1){return new ki(t,e,i,n)}we.fastDefine("cc.Quat",ki,{x:0,y:0,z:0,w:1}),n.Quat=ki,n.quat=Yi;const Ki=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]);class $i extends Bi{static clone(t){return new $i(t.m00,t.m01,t.m02,t.m03,t.m04,t.m05,t.m06,t.m07,t.m08,t.m09,t.m10,t.m11,t.m12,t.m13,t.m14,t.m15)}static copy(t,e){return t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static set(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d,f){return t.m00=e,t.m01=i,t.m02=n,t.m03=s,t.m04=r,t.m05=o,t.m06=a,t.m07=l,t.m08=c,t.m09=h,t.m10=_,t.m11=u,t.m12=m,t.m13=p,t.m14=d,t.m15=f,t}static identity(t){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static transpose(t,e){if(t===e){const i=e.m01,n=e.m02,s=e.m03,r=e.m06,o=e.m07,a=e.m11;t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=i,t.m06=e.m09,t.m07=e.m13,t.m08=n,t.m09=r,t.m11=e.m14,t.m12=s,t.m13=o,t.m14=a}else t.m00=e.m00,t.m01=e.m04,t.m02=e.m08,t.m03=e.m12,t.m04=e.m01,t.m05=e.m05,t.m06=e.m09,t.m07=e.m13,t.m08=e.m02,t.m09=e.m06,t.m10=e.m10,t.m11=e.m14,t.m12=e.m03,t.m13=e.m07,t.m14=e.m11,t.m15=e.m15;return t}static invert(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,p=e.m12,d=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,b=n*l-s*a,S=n*c-r*a,A=s*c-r*l,C=h*d-_*p,T=h*f-u*p,w=h*g-m*p,E=_*f-u*d,P=_*g-m*d,D=u*g-m*f;let I=y*D-v*P+x*E+b*w-S*T+A*C;return 0===I?(t.m00=0,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=0,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=0,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=0,t):(I=1/I,t.m00=(a*D-l*P+c*E)*I,t.m01=(s*P-n*D-r*E)*I,t.m02=(d*A-f*S+g*b)*I,t.m03=(u*S-_*A-m*b)*I,t.m04=(l*w-o*D-c*T)*I,t.m05=(i*D-s*w+r*T)*I,t.m06=(f*x-p*A-g*v)*I,t.m07=(h*A-u*x+m*v)*I,t.m08=(o*P-a*w+c*C)*I,t.m09=(n*w-i*P-r*C)*I,t.m10=(p*S-d*x+g*y)*I,t.m11=(_*x-h*S-m*y)*I,t.m12=(a*T-o*E-l*C)*I,t.m13=(i*E-n*T+s*C)*I,t.m14=(d*v-p*b-f*y)*I,t.m15=(h*b-_*v+u*y)*I,t)}static determinant(t){const e=t.m00,i=t.m01,n=t.m02,s=t.m03,r=t.m04,o=t.m05,a=t.m06,l=t.m07,c=t.m08,h=t.m09,_=t.m10,u=t.m11,m=t.m12,p=t.m13,d=t.m14,f=t.m15;return(e*o-i*r)*(_*f-u*d)-(e*a-n*r)*(h*f-u*p)+(e*l-s*r)*(h*d-_*p)+(i*a-n*o)*(c*f-u*m)-(i*l-s*o)*(c*d-_*m)+(n*l-s*a)*(c*p-h*m)}static multiply(t,e,i){const n=e.m00,s=e.m01,r=e.m02,o=e.m03,a=e.m04,l=e.m05,c=e.m06,h=e.m07,_=e.m08,u=e.m09,m=e.m10,p=e.m11,d=e.m12,f=e.m13,g=e.m14,y=e.m15;let v=i.m00,x=i.m01,b=i.m02,S=i.m03;return t.m00=v*n+x*a+b*_+S*d,t.m01=v*s+x*l+b*u+S*f,t.m02=v*r+x*c+b*m+S*g,t.m03=v*o+x*h+b*p+S*y,v=i.m04,x=i.m05,b=i.m06,S=i.m07,t.m04=v*n+x*a+b*_+S*d,t.m05=v*s+x*l+b*u+S*f,t.m06=v*r+x*c+b*m+S*g,t.m07=v*o+x*h+b*p+S*y,v=i.m08,x=i.m09,b=i.m10,S=i.m11,t.m08=v*n+x*a+b*_+S*d,t.m09=v*s+x*l+b*u+S*f,t.m10=v*r+x*c+b*m+S*g,t.m11=v*o+x*h+b*p+S*y,v=i.m12,x=i.m13,b=i.m14,S=i.m15,t.m12=v*n+x*a+b*_+S*d,t.m13=v*s+x*l+b*u+S*f,t.m14=v*r+x*c+b*m+S*g,t.m15=v*o+x*h+b*p+S*y,t}static transform(t,e,i){const n=i.x,s=i.y,r=i.z;if(e===t)t.m12=e.m00*n+e.m04*s+e.m08*r+e.m12,t.m13=e.m01*n+e.m05*s+e.m09*r+e.m13,t.m14=e.m02*n+e.m06*s+e.m10*r+e.m14,t.m15=e.m03*n+e.m07*s+e.m11*r+e.m15;else{const i=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m04,h=e.m05,_=e.m06,u=e.m07,m=e.m08,p=e.m09,d=e.m10,f=e.m11;e.m12,e.m13,e.m14,e.m15,t.m00=i,t.m01=o,t.m02=a,t.m03=l,t.m04=c,t.m05=h,t.m06=_,t.m07=u,t.m08=m,t.m09=p,t.m10=d,t.m11=f,t.m12=i*n+c*s+m*r+e.m12,t.m13=o*n+h*s+p*r+e.m13,t.m14=a*n+_*s+d*r+e.m14,t.m15=l*n+u*s+f*r+e.m15}return t}static translate(t,e,i){return console.warn("function changed"),e===t?(t.m12+=i.x,t.m13+=i.y,t.m14+=i.z):(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12+=i.x,t.m13+=i.y,t.m14+=i.z,t.m15=e.m15),t}static scale(t,e,i){const n=i.x,s=i.y,r=i.z;return t.m00=e.m00*n,t.m01=e.m01*n,t.m02=e.m02*n,t.m03=e.m03*n,t.m04=e.m04*s,t.m05=e.m05*s,t.m06=e.m06*s,t.m07=e.m07*s,t.m08=e.m08*r,t.m09=e.m09*r,t.m10=e.m10*r,t.m11=e.m11*r,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15,t}static rotate(t,e,i,n){let s=n.x,r=n.y,o=n.z,a=Math.sqrt(s*s+r*r+o*o);if(Math.abs(a)<ci)return null;a=1/a,s*=a,r*=a,o*=a;const l=Math.sin(i),c=Math.cos(i),h=1-c,_=e.m00,u=e.m01,m=e.m02,p=e.m03,d=e.m04,f=e.m05,g=e.m06,y=e.m07,v=e.m08,x=e.m09,b=e.m10,S=e.m11,A=s*s*h+c,C=r*s*h+o*l,T=o*s*h-r*l,w=s*r*h-o*l,E=r*r*h+c,P=o*r*h+s*l,D=s*o*h+r*l,I=r*o*h-s*l,R=o*o*h+c;return t.m00=_*A+d*C+v*T,t.m01=u*A+f*C+x*T,t.m02=m*A+g*C+b*T,t.m03=p*A+y*C+S*T,t.m04=_*w+d*E+v*P,t.m05=u*w+f*E+x*P,t.m06=m*w+g*E+b*P,t.m07=p*w+y*E+S*P,t.m08=_*D+d*I+v*R,t.m09=u*D+f*I+x*R,t.m10=m*D+g*I+b*R,t.m11=p*D+y*I+S*R,e!==t&&(t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t}static rotateX(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m04,o=e.m05,a=e.m06,l=e.m07,c=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m00=e.m00,t.m01=e.m01,t.m02=e.m02,t.m03=e.m03,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m04=r*s+c*n,t.m05=o*s+h*n,t.m06=a*s+_*n,t.m07=l*s+u*n,t.m08=c*s-r*n,t.m09=h*s-o*n,t.m10=_*s-a*n,t.m11=u*s-l*n,t}static rotateY(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m08,h=e.m09,_=e.m10,u=e.m11;return e!==t&&(t.m04=e.m04,t.m05=e.m05,t.m06=e.m06,t.m07=e.m07,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s-c*n,t.m01=o*s-h*n,t.m02=a*s-_*n,t.m03=l*s-u*n,t.m08=r*n+c*s,t.m09=o*n+h*s,t.m10=a*n+_*s,t.m11=l*n+u*s,t}static rotateZ(t,e,i){const n=Math.sin(i),s=Math.cos(i),r=e.m00,o=e.m01,a=e.m02,l=e.m03,c=e.m04,h=e.m05,_=e.m06,u=e.m07;return e!==t&&(t.m08=e.m08,t.m09=e.m09,t.m10=e.m10,t.m11=e.m11,t.m12=e.m12,t.m13=e.m13,t.m14=e.m14,t.m15=e.m15),t.m00=r*s+c*n,t.m01=o*s+h*n,t.m02=a*s+_*n,t.m03=l*s+u*n,t.m04=c*s-r*n,t.m05=h*s-o*n,t.m06=_*s-a*n,t.m07=u*s-l*n,t}static fromTranslation(t,e){return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=e.x,t.m13=e.y,t.m14=e.z,t.m15=1,t}static fromScaling(t,e){return t.m00=e.x,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=e.y,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=e.z,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRotation(t,e,i){let n=i.x,s=i.y,r=i.z,o=Math.sqrt(n*n+s*s+r*r);if(Math.abs(o)<ci)return null;o=1/o,n*=o,s*=o,r*=o;const a=Math.sin(e),l=Math.cos(e),c=1-l;return t.m00=n*n*c+l,t.m01=s*n*c+r*a,t.m02=r*n*c-s*a,t.m03=0,t.m04=n*s*c-r*a,t.m05=s*s*c+l,t.m06=r*s*c+n*a,t.m07=0,t.m08=n*r*c+s*a,t.m09=s*r*c-n*a,t.m10=r*r*c+l,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromXRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=n,t.m06=i,t.m07=0,t.m08=0,t.m09=-i,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromYRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=0,t.m02=-i,t.m03=0,t.m04=0,t.m05=1,t.m06=0,t.m07=0,t.m08=i,t.m09=0,t.m10=n,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromZRotation(t,e){const i=Math.sin(e),n=Math.cos(e);return t.m00=n,t.m01=i,t.m02=0,t.m03=0,t.m04=-i,t.m05=n,t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=1,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static fromRT(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w,a=n+n,l=s+s,c=r+r,h=n*a,_=n*l,u=n*c,m=s*l,p=s*c,d=r*c,f=o*a,g=o*l,y=o*c;return t.m00=1-(m+d),t.m01=_+y,t.m02=u-g,t.m03=0,t.m04=_-y,t.m05=1-(h+d),t.m06=p+f,t.m07=0,t.m08=u+g,t.m09=p-f,t.m10=1-(h+m),t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static getTranslation(t,e){return t.x=e.m12,t.y=e.m13,t.z=e.m14,t}static getScaling(t,e){const i=Zi.m00=e.m00,n=Zi.m01=e.m01,s=Zi.m02=e.m02,r=Zi.m03=e.m04,o=Zi.m04=e.m05,a=Zi.m05=e.m06,l=Zi.m06=e.m08,c=Zi.m07=e.m09,h=Zi.m08=e.m10;return t.x=Math.sqrt(i*i+n*n+s*s),t.y=Math.sqrt(r*r+o*o+a*a),t.z=Math.sqrt(l*l+c*c+h*h),Vi.determinant(Zi)<0&&(t.x*=-1),t}static getRotation(t,e){const i=e.m00+e.m05+e.m10;let n=0;return i>0?(n=2*Math.sqrt(i+1),t.w=.25*n,t.x=(e.m06-e.m09)/n,t.y=(e.m08-e.m02)/n,t.z=(e.m01-e.m04)/n):e.m00>e.m05&&e.m00>e.m10?(n=2*Math.sqrt(1+e.m00-e.m05-e.m10),t.w=(e.m06-e.m09)/n,t.x=.25*n,t.y=(e.m01+e.m04)/n,t.z=(e.m08+e.m02)/n):e.m05>e.m10?(n=2*Math.sqrt(1+e.m05-e.m00-e.m10),t.w=(e.m08-e.m02)/n,t.x=(e.m01+e.m04)/n,t.y=.25*n,t.z=(e.m06+e.m09)/n):(n=2*Math.sqrt(1+e.m10-e.m00-e.m05),t.w=(e.m01-e.m04)/n,t.x=(e.m08+e.m02)/n,t.y=(e.m06+e.m09)/n,t.z=.25*n),t}static toRTS(t,e,i,n){n.x=Ni.set(Ji,t.m00,t.m01,t.m02).length(),Zi.m00=t.m00/n.x,Zi.m01=t.m01/n.x,Zi.m02=t.m02/n.x,n.y=Ni.set(Ji,t.m04,t.m05,t.m06).length(),Zi.m03=t.m04/n.y,Zi.m04=t.m05/n.y,Zi.m05=t.m06/n.y,n.z=Ni.set(Ji,t.m08,t.m09,t.m10).length(),Zi.m06=t.m08/n.z,Zi.m07=t.m09/n.z,Zi.m08=t.m10/n.z,Vi.determinant(Zi)<0&&(n.x*=-1,Zi.m00*=-1,Zi.m01*=-1,Zi.m02*=-1),ki.fromMat3(e,Zi),Ni.set(i,t.m12,t.m13,t.m14)}static fromRTS(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=e.w,l=s+s,c=r+r,h=o+o,_=s*l,u=s*c,m=s*h,p=r*c,d=r*h,f=o*h,g=a*l,y=a*c,v=a*h,x=n.x,b=n.y,S=n.z;return t.m00=(1-(p+f))*x,t.m01=(u+v)*x,t.m02=(m-y)*x,t.m03=0,t.m04=(u-v)*b,t.m05=(1-(_+f))*b,t.m06=(d+g)*b,t.m07=0,t.m08=(m+y)*S,t.m09=(d-g)*S,t.m10=(1-(_+p))*S,t.m11=0,t.m12=i.x,t.m13=i.y,t.m14=i.z,t.m15=1,t}static fromRTSOrigin(t,e,i,n,s){const r=e.x,o=e.y,a=e.z,l=e.w,c=r+r,h=o+o,_=a+a,u=r*c,m=r*h,p=r*_,d=o*h,f=o*_,g=a*_,y=l*c,v=l*h,x=l*_,b=n.x,S=n.y,A=n.z,C=s.x,T=s.y,w=s.z;return t.m00=(1-(d+g))*b,t.m01=(m+x)*b,t.m02=(p-v)*b,t.m03=0,t.m04=(m-x)*S,t.m05=(1-(u+g))*S,t.m06=(f+y)*S,t.m07=0,t.m08=(p+v)*A,t.m09=(f-y)*A,t.m10=(1-(u+d))*A,t.m11=0,t.m12=i.x+C-(t.m00*C+t.m04*T+t.m08*w),t.m13=i.y+T-(t.m01*C+t.m05*T+t.m09*w),t.m14=i.z+w-(t.m02*C+t.m06*T+t.m10*w),t.m15=1,t}static fromQuat(t,e){const i=e.x,n=e.y,s=e.z,r=e.w,o=i+i,a=n+n,l=s+s,c=i*o,h=n*o,_=n*a,u=s*o,m=s*a,p=s*l,d=r*o,f=r*a,g=r*l;return t.m00=1-_-p,t.m01=h+g,t.m02=u-f,t.m03=0,t.m04=h-g,t.m05=1-c-p,t.m06=m+d,t.m07=0,t.m08=u+f,t.m09=m-d,t.m10=1-c-_,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t}static frustum(t,e,i,n,s,r,o){const a=1/(i-e),l=1/(s-n),c=1/(r-o);return t.m00=2*r*a,t.m01=0,t.m02=0,t.m03=0,t.m04=0,t.m05=2*r*l,t.m06=0,t.m07=0,t.m08=(i+e)*a,t.m09=(s+n)*l,t.m10=(o+r)*c,t.m11=-1,t.m12=0,t.m13=0,t.m14=o*r*2*c,t.m15=0,t}static perspective(t,e,i,n,s,r=!0,o=-1,a=1,l=0){const c=1/Math.tan(e/2),h=1/(n-s),_=r?c/i:c,u=(r?c:c*i)*a,m=Ki[l];return t.m00=_*m[0],t.m01=_*m[1],t.m02=0,t.m03=0,t.m04=u*m[2],t.m05=u*m[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=(s-o*n)*h,t.m11=-1,t.m12=0,t.m13=0,t.m14=s*n*h*(1-o),t.m15=0,t}static ortho(t,e,i,n,s,r,o,a=-1,l=1,c=0){const h=1/(e-i),_=1/(n-s)*l,u=1/(r-o),m=-2*h,p=-2*_,d=(e+i)*h,f=(s+n)*_,g=Ki[c];return t.m00=m*g[0],t.m01=m*g[1],t.m02=0,t.m03=0,t.m04=p*g[2],t.m05=p*g[3],t.m06=0,t.m07=0,t.m08=0,t.m09=0,t.m10=u*(1-a),t.m11=0,t.m12=d*g[0]+f*g[2],t.m13=d*g[1]+f*g[3],t.m14=(r-a*o)*u,t.m15=1,t}static lookAt(t,e,i,n){const s=e.x,r=e.y,o=e.z,a=n.x,l=n.y,c=n.z;let h=s-i.x,_=r-i.y,u=o-i.z,m=1/Math.sqrt(h*h+_*_+u*u);h*=m,_*=m,u*=m;let p=l*u-c*_,d=c*h-a*u,f=a*_-l*h;m=1/Math.sqrt(p*p+d*d+f*f),p*=m,d*=m,f*=m;const g=_*f-u*d,y=u*p-h*f,v=h*d-_*p;return t.m00=p,t.m01=g,t.m02=h,t.m03=0,t.m04=d,t.m05=y,t.m06=_,t.m07=0,t.m08=f,t.m09=v,t.m10=u,t.m11=0,t.m12=-(p*s+d*r+f*o),t.m13=-(g*s+y*r+v*o),t.m14=-(h*s+_*r+u*o),t.m15=1,t}static inverseTranspose(t,e){const i=e.m00,n=e.m01,s=e.m02,r=e.m03,o=e.m04,a=e.m05,l=e.m06,c=e.m07,h=e.m08,_=e.m09,u=e.m10,m=e.m11,p=e.m12,d=e.m13,f=e.m14,g=e.m15,y=i*a-n*o,v=i*l-s*o,x=i*c-r*o,b=n*l-s*a,S=n*c-r*a,A=s*c-r*l,C=h*d-_*p,T=h*f-u*p,w=h*g-m*p,E=_*f-u*d,P=_*g-m*d,D=u*g-m*f;let I=y*D-v*P+x*E+b*w-S*T+A*C;return I?(I=1/I,t.m00=(a*D-l*P+c*E)*I,t.m01=(l*w-o*D-c*T)*I,t.m02=(o*P-a*w+c*C)*I,t.m03=0,t.m04=(s*P-n*D-r*E)*I,t.m05=(i*D-s*w+r*T)*I,t.m06=(n*w-i*P-r*C)*I,t.m07=0,t.m08=(d*A-f*S+g*b)*I,t.m09=(f*x-p*A-g*v)*I,t.m10=(p*S-d*x+g*y)*I,t.m11=0,t.m12=0,t.m13=0,t.m14=0,t.m15=1,t):null}static toArray(t,e,i=0){return t[i+0]=e.m00,t[i+1]=e.m01,t[i+2]=e.m02,t[i+3]=e.m03,t[i+4]=e.m04,t[i+5]=e.m05,t[i+6]=e.m06,t[i+7]=e.m07,t[i+8]=e.m08,t[i+9]=e.m09,t[i+10]=e.m10,t[i+11]=e.m11,t[i+12]=e.m12,t[i+13]=e.m13,t[i+14]=e.m14,t[i+15]=e.m15,t}static fromArray(t,e,i=0){return t.m00=e[i+0],t.m01=e[i+1],t.m02=e[i+2],t.m03=e[i+3],t.m04=e[i+4],t.m05=e[i+5],t.m06=e[i+6],t.m07=e[i+7],t.m08=e[i+8],t.m09=e[i+9],t.m10=e[i+10],t.m11=e[i+11],t.m12=e[i+12],t.m13=e[i+13],t.m14=e[i+14],t.m15=e[i+15],t}static add(t,e,i){return t.m00=e.m00+i.m00,t.m01=e.m01+i.m01,t.m02=e.m02+i.m02,t.m03=e.m03+i.m03,t.m04=e.m04+i.m04,t.m05=e.m05+i.m05,t.m06=e.m06+i.m06,t.m07=e.m07+i.m07,t.m08=e.m08+i.m08,t.m09=e.m09+i.m09,t.m10=e.m10+i.m10,t.m11=e.m11+i.m11,t.m12=e.m12+i.m12,t.m13=e.m13+i.m13,t.m14=e.m14+i.m14,t.m15=e.m15+i.m15,t}static subtract(t,e,i){return t.m00=e.m00-i.m00,t.m01=e.m01-i.m01,t.m02=e.m02-i.m02,t.m03=e.m03-i.m03,t.m04=e.m04-i.m04,t.m05=e.m05-i.m05,t.m06=e.m06-i.m06,t.m07=e.m07-i.m07,t.m08=e.m08-i.m08,t.m09=e.m09-i.m09,t.m10=e.m10-i.m10,t.m11=e.m11-i.m11,t.m12=e.m12-i.m12,t.m13=e.m13-i.m13,t.m14=e.m14-i.m14,t.m15=e.m15-i.m15,t}static multiplyScalar(t,e,i){return t.m00=e.m00*i,t.m01=e.m01*i,t.m02=e.m02*i,t.m03=e.m03*i,t.m04=e.m04*i,t.m05=e.m05*i,t.m06=e.m06*i,t.m07=e.m07*i,t.m08=e.m08*i,t.m09=e.m09*i,t.m10=e.m10*i,t.m11=e.m11*i,t.m12=e.m12*i,t.m13=e.m13*i,t.m14=e.m14*i,t.m15=e.m15*i,t}static multiplyScalarAndAdd(t,e,i,n){return t.m00=e.m00+i.m00*n,t.m01=e.m01+i.m01*n,t.m02=e.m02+i.m02*n,t.m03=e.m03+i.m03*n,t.m04=e.m04+i.m04*n,t.m05=e.m05+i.m05*n,t.m06=e.m06+i.m06*n,t.m07=e.m07+i.m07*n,t.m08=e.m08+i.m08*n,t.m09=e.m09+i.m09*n,t.m10=e.m10+i.m10*n,t.m11=e.m11+i.m11*n,t.m12=e.m12+i.m12*n,t.m13=e.m13+i.m13*n,t.m14=e.m14+i.m14*n,t.m15=e.m15+i.m15*n,t}static strictEquals(t,e){return t.m00===e.m00&&t.m01===e.m01&&t.m02===e.m02&&t.m03===e.m03&&t.m04===e.m04&&t.m05===e.m05&&t.m06===e.m06&&t.m07===e.m07&&t.m08===e.m08&&t.m09===e.m09&&t.m10===e.m10&&t.m11===e.m11&&t.m12===e.m12&&t.m13===e.m13&&t.m14===e.m14&&t.m15===e.m15}static equals(t,e,i=ci){return Math.abs(t.m00-e.m00)<=i*Math.max(1,Math.abs(t.m00),Math.abs(e.m00))&&Math.abs(t.m01-e.m01)<=i*Math.max(1,Math.abs(t.m01),Math.abs(e.m01))&&Math.abs(t.m02-e.m02)<=i*Math.max(1,Math.abs(t.m02),Math.abs(e.m02))&&Math.abs(t.m03-e.m03)<=i*Math.max(1,Math.abs(t.m03),Math.abs(e.m03))&&Math.abs(t.m04-e.m04)<=i*Math.max(1,Math.abs(t.m04),Math.abs(e.m04))&&Math.abs(t.m05-e.m05)<=i*Math.max(1,Math.abs(t.m05),Math.abs(e.m05))&&Math.abs(t.m06-e.m06)<=i*Math.max(1,Math.abs(t.m06),Math.abs(e.m06))&&Math.abs(t.m07-e.m07)<=i*Math.max(1,Math.abs(t.m07),Math.abs(e.m07))&&Math.abs(t.m08-e.m08)<=i*Math.max(1,Math.abs(t.m08),Math.abs(e.m08))&&Math.abs(t.m09-e.m09)<=i*Math.max(1,Math.abs(t.m09),Math.abs(e.m09))&&Math.abs(t.m10-e.m10)<=i*Math.max(1,Math.abs(t.m10),Math.abs(e.m10))&&Math.abs(t.m11-e.m11)<=i*Math.max(1,Math.abs(t.m11),Math.abs(e.m11))&&Math.abs(t.m12-e.m12)<=i*Math.max(1,Math.abs(t.m12),Math.abs(e.m12))&&Math.abs(t.m13-e.m13)<=i*Math.max(1,Math.abs(t.m13),Math.abs(e.m13))&&Math.abs(t.m14-e.m14)<=i*Math.max(1,Math.abs(t.m14),Math.abs(e.m14))&&Math.abs(t.m15-e.m15)<=i*Math.max(1,Math.abs(t.m15),Math.abs(e.m15))}get m00(){return this._array[0]}set m00(t){this._array[0]=t}get m01(){return this._array[1]}set m01(t){this._array[1]=t}get m02(){return this._array[2]}set m02(t){this._array[2]=t}get m03(){return this._array[3]}set m03(t){this._array[3]=t}get m04(){return this._array[4]}set m04(t){this._array[4]=t}get m05(){return this._array[5]}set m05(t){this._array[5]=t}get m06(){return this._array[6]}set m06(t){this._array[6]=t}get m07(){return this._array[7]}set m07(t){this._array[7]=t}get m08(){return this._array[8]}set m08(t){this._array[8]=t}get m09(){return this._array[9]}set m09(t){this._array[9]=t}get m10(){return this._array[10]}set m10(t){this._array[10]=t}get m11(){return this._array[11]}set m11(t){this._array[11]=t}get m12(){return this._array[12]}set m12(t){this._array[12]=t}get m13(){return this._array[13]}set m13(t){this._array[13]=t}get m14(){return this._array[14]}set m14(t){this._array[14]=t}get m15(){return this._array[15]}set m15(t){this._array[15]=t}constructor(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,l=0,c=0,h=1,_=0,u=0,m=0,p=0,d=1){if(super(),t&&"object"==typeof t)if(ArrayBuffer.isView(t))this._array=t,this._array.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);else{const e=t.array;this._array=Bi.createFloatArray(16),this._array[0]=e[0],this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8],this._array[9]=e[9],this._array[10]=e[10],this._array[11]=e[11],this._array[12]=e[12],this._array[13]=e[13],this._array[14]=e[14],this._array[15]=e[15]}else this._array=Bi.createFloatArray(16),this._array[0]=t,this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=l,this._array[9]=c,this._array[10]=h,this._array[11]=_,this._array[12]=u,this._array[13]=m,this._array[14]=p,this._array[15]=d}clone(){const t=this._array;return new $i(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}set(t=1,e=0,i=0,n=0,s=0,r=1,o=0,a=0,l=0,c=0,h=1,_=0,u=0,m=0,p=0,d=1){if(t&&"object"==typeof t){const e=t.array;this._array[1]=e[1],this._array[2]=e[2],this._array[3]=e[3],this._array[4]=e[4],this._array[5]=e[5],this._array[6]=e[6],this._array[7]=e[7],this._array[8]=e[8],this._array[9]=e[9],this._array[10]=e[10],this._array[11]=e[11],this._array[12]=e[12],this._array[13]=e[13],this._array[14]=e[14],this._array[15]=e[15],this._array[0]=e[0]}else this._array[1]=e,this._array[2]=i,this._array[3]=n,this._array[4]=s,this._array[5]=r,this._array[6]=o,this._array[7]=a,this._array[8]=l,this._array[9]=c,this._array[10]=h,this._array[11]=_,this._array[12]=u,this._array[13]=m,this._array[14]=p,this._array[15]=d,this._array[0]=t;return this}equals(t,e=ci){const i=t.array;return Math.abs(this._array[0]-i[0])<=e*Math.max(1,Math.abs(this._array[0]),Math.abs(i[0]))&&Math.abs(this._array[1]-i[1])<=e*Math.max(1,Math.abs(this._array[1]),Math.abs(i[1]))&&Math.abs(this._array[2]-i[2])<=e*Math.max(1,Math.abs(this._array[2]),Math.abs(i[2]))&&Math.abs(this._array[3]-i[3])<=e*Math.max(1,Math.abs(this._array[3]),Math.abs(i[3]))&&Math.abs(this._array[4]-i[4])<=e*Math.max(1,Math.abs(this._array[4]),Math.abs(i[4]))&&Math.abs(this._array[5]-i[5])<=e*Math.max(1,Math.abs(this._array[5]),Math.abs(i[5]))&&Math.abs(this._array[6]-i[6])<=e*Math.max(1,Math.abs(this._array[6]),Math.abs(i[6]))&&Math.abs(this._array[7]-i[7])<=e*Math.max(1,Math.abs(this._array[7]),Math.abs(i[7]))&&Math.abs(this._array[8]-i[8])<=e*Math.max(1,Math.abs(this._array[8]),Math.abs(i[8]))&&Math.abs(this._array[9]-i[9])<=e*Math.max(1,Math.abs(this._array[9]),Math.abs(i[9]))&&Math.abs(this._array[10]-i[10])<=e*Math.max(1,Math.abs(this._array[10]),Math.abs(i[10]))&&Math.abs(this._array[11]-i[11])<=e*Math.max(1,Math.abs(this._array[11]),Math.abs(i[11]))&&Math.abs(this._array[12]-i[12])<=e*Math.max(1,Math.abs(this._array[12]),Math.abs(i[12]))&&Math.abs(this._array[13]-i[13])<=e*Math.max(1,Math.abs(this._array[13]),Math.abs(i[13]))&&Math.abs(this._array[14]-i[14])<=e*Math.max(1,Math.abs(this._array[14]),Math.abs(i[14]))&&Math.abs(this._array[15]-i[15])<=e*Math.max(1,Math.abs(this._array[15]),Math.abs(i[15]))}strictEquals(t){const e=t.array;return this._array[0]===t.m00&&this._array[1]===e[1]&&this._array[2]===e[2]&&this._array[3]===e[3]&&this._array[4]===e[4]&&this._array[5]===e[5]&&this._array[6]===e[6]&&this._array[7]===e[7]&&this._array[8]===e[8]&&this._array[9]===e[9]&&this._array[10]===e[10]&&this._array[11]===e[11]&&this._array[12]===e[12]&&this._array[13]===e[13]&&this._array[14]===e[14]&&this._array[15]===e[15]}toString(){return`[\n${this._array[0]}, ${this._array[1]}, ${this._array[2]}, ${this._array[3]},\n${this._array[4]}, ${this._array[5]}, ${this._array[6]}, ${this._array[7]},\n${this._array[8]}, ${this._array[9]}, ${this._array[10]}, ${this._array[11]},\n${this._array[12]}, ${this._array[13]}, ${this._array[14]}, ${this._array[15]}\n]`}identity(){return this._array[0]=1,this._array[1]=0,this._array[2]=0,this._array[3]=0,this._array[4]=0,this._array[5]=1,this._array[6]=0,this._array[7]=0,this._array[8]=0,this._array[9]=0,this._array[10]=1,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}zero(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this}transpose(){const t=this._array[1],e=this._array[2],i=this._array[3],n=this._array[6],s=this._array[7],r=this._array[11];return this._array[1]=this._array[4],this._array[2]=this._array[8],this._array[3]=this._array[12],this._array[4]=t,this._array[6]=this._array[9],this._array[7]=this._array[13],this._array[8]=e,this._array[9]=n,this._array[11]=this._array[14],this._array[12]=i,this._array[13]=s,this._array[14]=r,this}invert(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],l=this._array[8],c=this._array[9],h=this._array[10],_=this._array[11],u=this._array[12],m=this._array[13],p=this._array[14],d=this._array[15],f=t*r-e*s,g=t*o-i*s,y=t*a-n*s,v=e*o-i*r,x=e*a-n*r,b=i*a-n*o,S=l*m-c*u,A=l*p-h*u,C=l*d-_*u,T=c*p-h*m,w=c*d-_*m,E=h*d-_*p;let P=f*E-g*w+y*T+v*C-x*A+b*S;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this._array[0]=(r*E-o*w+a*T)*P,this._array[1]=(i*w-e*E-n*T)*P,this._array[2]=(m*b-p*x+d*v)*P,this._array[3]=(h*x-c*b-_*v)*P,this._array[4]=(o*C-s*E-a*A)*P,this._array[5]=(t*E-i*C+n*A)*P,this._array[6]=(p*y-u*b-d*g)*P,this._array[7]=(l*b-h*y+_*g)*P,this._array[8]=(s*w-r*C+a*S)*P,this._array[9]=(e*C-t*w-n*S)*P,this._array[10]=(u*x-m*y+d*f)*P,this._array[11]=(c*y-l*x-_*f)*P,this._array[12]=(r*A-s*T-o*S)*P,this._array[13]=(t*T-e*A+i*S)*P,this._array[14]=(m*g-u*v-p*f)*P,this._array[15]=(l*v-c*g+h*f)*P,this)}determinant(){const t=this._array[0],e=this._array[1],i=this._array[2],n=this._array[3],s=this._array[4],r=this._array[5],o=this._array[6],a=this._array[7],l=this._array[8],c=this._array[9],h=this._array[10],_=this._array[11],u=this._array[12],m=this._array[13],p=this._array[14],d=this._array[15];return(t*r-e*s)*(h*d-_*p)-(t*o-i*s)*(c*d-_*m)+(t*a-n*s)*(c*p-h*m)+(e*o-i*r)*(l*d-_*u)-(e*a-n*r)*(l*p-h*u)+(i*a-n*o)*(l*m-c*u)}add(t){const e=t.array;return this._array[0]+=e[0],this._array[1]+=e[1],this._array[2]+=e[2],this._array[3]+=e[3],this._array[4]+=e[4],this._array[5]+=e[5],this._array[6]+=e[6],this._array[7]+=e[7],this._array[8]+=e[8],this._array[9]+=e[9],this._array[10]+=e[10],this._array[11]+=e[11],this._array[12]+=e[12],this._array[13]+=e[13],this._array[14]+=e[14],this._array[15]+=e[15],this}subtract(t){const e=t.array;return this._array[0]-=e[0],this._array[1]-=e[1],this._array[2]-=e[2],this._array[3]-=e[3],this._array[4]-=e[4],this._array[5]-=e[5],this._array[6]-=e[6],this._array[7]-=e[7],this._array[8]-=e[8],this._array[9]-=e[9],this._array[10]-=e[10],this._array[11]-=e[11],this._array[12]-=e[12],this._array[13]-=e[13],this._array[14]-=e[14],this._array[15]-=e[15],this}multiply(t){const e=this._array[0],i=this._array[1],n=this._array[2],s=this._array[3],r=this._array[4],o=this._array[5],a=this._array[6],l=this._array[7],c=this._array[8],h=this._array[9],_=this._array[10],u=this._array[11],m=this._array[12],p=this._array[13],d=this._array[14],f=this._array[15],g=t.array;let y=g[0],v=g[1],x=g[2],b=g[3];return this._array[0]=y*e+v*r+x*c+b*m,this._array[1]=y*i+v*o+x*h+b*p,this._array[2]=y*n+v*a+x*_+b*d,this._array[3]=y*s+v*l+x*u+b*f,y=g[4],v=g[5],x=g[6],b=g[7],this._array[4]=y*e+v*r+x*c+b*m,this._array[5]=y*i+v*o+x*h+b*p,this._array[6]=y*n+v*a+x*_+b*d,this._array[7]=y*s+v*l+x*u+b*f,y=g[8],v=g[9],x=g[10],b=g[11],this._array[8]=y*e+v*r+x*c+b*m,this._array[9]=y*i+v*o+x*h+b*p,this._array[10]=y*n+v*a+x*_+b*d,this._array[11]=y*s+v*l+x*u+b*f,y=g[12],v=g[13],x=g[14],b=g[15],this._array[12]=y*e+v*r+x*c+b*m,this._array[13]=y*i+v*o+x*h+b*p,this._array[14]=y*n+v*a+x*_+b*d,this._array[15]=y*s+v*l+x*u+b*f,this}multiplyScalar(t){return this._array[0]*=t,this._array[1]*=t,this._array[2]*=t,this._array[3]*=t,this._array[4]*=t,this._array[5]*=t,this._array[6]*=t,this._array[7]*=t,this._array[8]*=t,this._array[9]*=t,this._array[10]*=t,this._array[11]*=t,this._array[12]*=t,this._array[13]*=t,this._array[14]*=t,this._array[15]*=t,this}translate(t){console.warn("function changed");const e=t.array;return this._array[12]+=e[0],this._array[13]+=e[1],this._array[14]+=e[2],this}scale(t){const e=t.array,i=e[0],n=e[1],s=e[2];return this._array[0]*=i,this._array[1]*=i,this._array[2]*=i,this._array[3]*=i,this._array[4]*=n,this._array[5]*=n,this._array[6]*=n,this._array[7]*=n,this._array[8]*=s,this._array[9]*=s,this._array[10]*=s,this._array[11]*=s,this}rotate(t,e){let i=e.x,n=e.y,s=e.z,r=Math.sqrt(i*i+n*n+s*s);if(Math.abs(r)<ci)return null;r=1/r,i*=r,n*=r,s*=r;const o=Math.sin(t),a=Math.cos(t),l=1-a,c=this._array[0],h=this._array[1],_=this._array[2],u=this._array[3],m=this._array[4],p=this._array[5],d=this._array[6],f=this._array[7],g=this._array[8],y=this._array[9],v=this._array[10],x=this._array[11],b=i*i*l+a,S=n*i*l+s*o,A=s*i*l-n*o,C=i*n*l-s*o,T=n*n*l+a,w=s*n*l+i*o,E=i*s*l+n*o,P=n*s*l-i*o,D=s*s*l+a;return this._array[0]=c*b+m*S+g*A,this._array[1]=h*b+p*S+y*A,this._array[2]=_*b+d*S+v*A,this._array[3]=u*b+f*S+x*A,this._array[4]=c*C+m*T+g*w,this._array[5]=h*C+p*T+y*w,this._array[6]=_*C+d*T+v*w,this._array[7]=u*C+f*T+x*w,this._array[8]=c*E+m*P+g*D,this._array[9]=h*E+p*P+y*D,this._array[10]=_*E+d*P+v*D,this._array[11]=u*E+f*P+x*D,this}getTranslation(t){return t.x=this._array[12],t.y=this._array[13],t.z=this._array[14],t}getScale(t){const e=t.array,i=Zi.array,n=i[0]=this._array[0],s=i[1]=this._array[1],r=i[2]=this._array[2],o=i[3]=this._array[4],a=i[4]=this._array[5],l=i[5]=this._array[6],c=i[6]=this._array[8],h=i[7]=this._array[9],_=i[8]=this._array[10];return e[0]=Math.sqrt(n*n+s*s+r*r),e[1]=Math.sqrt(o*o+a*a+l*l),e[2]=Math.sqrt(c*c+h*h+_*_),Vi.determinant(Zi)<0&&(t.x*=-1),t}getRotation(t){const e=this._array[0]+this._array[5]+this._array[10];let i=0;return e>0?(i=2*Math.sqrt(e+1),t.w=.25*i,t.x=(this._array[6]-this._array[9])/i,t.y=(this._array[8]-this._array[2])/i,t.z=(this._array[1]-this._array[4])/i):this._array[0]>this._array[5]&&this._array[0]>this._array[10]?(i=2*Math.sqrt(1+this._array[0]-this._array[5]-this._array[10]),t.w=(this._array[6]-this._array[9])/i,t.x=.25*i,t.y=(this._array[1]+this._array[4])/i,t.z=(this._array[8]+this._array[2])/i):this._array[5]>this._array[10]?(i=2*Math.sqrt(1+this._array[5]-this._array[0]-this._array[10]),t.w=(this._array[8]-this._array[2])/i,t.x=(this._array[1]+this._array[4])/i,t.y=.25*i,t.z=(this._array[6]+this._array[9])/i):(i=2*Math.sqrt(1+this._array[10]-this._array[0]-this._array[5]),t.w=(this._array[1]-this._array[4])/i,t.x=(this._array[8]+this._array[2])/i,t.y=(this._array[6]+this._array[9])/i,t.z=.25*i),t}fromRTS(t,e,i){const n=t.x,s=t.y,r=t.z,o=t.w,a=n+n,l=s+s,c=r+r,h=n*a,_=n*l,u=n*c,m=s*l,p=s*c,d=r*c,f=o*a,g=o*l,y=o*c,v=i.x,x=i.y,b=i.z;return this._array[0]=(1-(m+d))*v,this._array[1]=(_+y)*v,this._array[2]=(u-g)*v,this._array[3]=0,this._array[4]=(_-y)*x,this._array[5]=(1-(h+d))*x,this._array[6]=(p+f)*x,this._array[7]=0,this._array[8]=(u+g)*b,this._array[9]=(p-f)*b,this._array[10]=(1-(h+m))*b,this._array[11]=0,this._array[12]=e.x,this._array[13]=e.y,this._array[14]=e.z,this._array[15]=1,this}fromQuat(t){const e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,l=e*r,c=i*r,h=i*o,_=n*r,u=n*o,m=n*a,p=s*r,d=s*o,f=s*a;return this._array[0]=1-h-m,this._array[1]=c+f,this._array[2]=_-d,this._array[3]=0,this._array[4]=c-f,this._array[5]=1-l-m,this._array[6]=u+p,this._array[7]=0,this._array[8]=_+d,this._array[9]=u-p,this._array[10]=1-l-h,this._array[11]=0,this._array[12]=0,this._array[13]=0,this._array[14]=0,this._array[15]=1,this}}t("Mat4",$i),$i.IDENTITY=Object.freeze(new $i);const Ji=new Ni,Zi=new Vi;function Qi(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d){return new $i(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d)}Di($i.prototype,["m00","m01","m02","m03","m04","m05","m06","m07","m08","m09","m10","m11","m12","m13","m14","m15"]),we.fastDefine("cc.Mat4",$i,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),n.Mat4=$i,n.mat4=Qi;class tn extends Vt{static clone(t){return new tn(t.x,t.y)}static copy(t,e){return t.x=e.x,t.y=e.y,t}static set(t,e,i){return t.x=e,t.y=i,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}static len(t){const e=t.x,i=t.y;return Math.sqrt(e*e+i*i)}static lengthSqr(t){const e=t.x,i=t.y;return e*e+i*i}static negate(t,e){return t.x=-e.x,t.y=-e.y,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t}static inverseSafe(t,e){const i=e.x,n=e.y;return Math.abs(i)<ci?t.x=0:t.x=1/i,Math.abs(n)<ci?t.y=0:t.y=1/n,t}static normalize(t,e){const i=e.x,n=e.y;let s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t.x=i*s,t.y=n*s),t}static dot(t,e){return t.x*e.x+t.y*e.y}static cross(t,e,i){return t.x=t.y=0,t.z=e.x*i.y-e.y*i.x,t}static lerp(t,e,i,n){const s=e.x,r=e.y;return t.x=s+n*(i.x-s),t.y=r+n*(i.y-r),t}static random(t,e){e=e||1;const i=2*gi()*Math.PI;return t.x=Math.cos(i)*e,t.y=Math.sin(i)*e,t}static transformMat3(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m03*s+i.m06,t.y=i.m01*n+i.m04*s+i.m07,t}static transformMat4(t,e,i){const n=e.x,s=e.y;return t.x=i.m00*n+i.m04*s+i.m12,t.y=i.m01*n+i.m05*s+i.m13,t}static str(t){return`Vec2(${t.x}, ${t.y})`}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y}static equals(t,e,i=ci){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))}static angle(t,e){tn.normalize(en,t),tn.normalize(nn,e);const i=tn.dot(en,nn);return i>1?0:i<-1?Math.PI:Math.acos(i)}constructor(t,e){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0)}clone(){return new tn(this.x,this.y)}set(t,e){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y):(this.x=t||0,this.y=e||0),this}equals(t,e=ci){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))}equals2f(t,e,i=ci){return Math.abs(this.x-t)<=i*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=i*Math.max(1,Math.abs(this.y),Math.abs(e))}strictEquals(t){return t&&this.x===t.x&&this.y===t.y}strictEquals2f(t,e){return this.x===t&&this.y===e}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)})`}lerp(t,e){const i=this.x,n=this.y;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this}clampf(t,e){return this.x=ui(this.x,t.x,e.x),this.y=ui(this.y,t.y,e.y),this}add(t){return this.x+=t.x,this.y+=t.y,this}add2f(t,e){return this.x+=t,this.y+=e,this}subtract(t){return this.x-=t.x,this.y-=t.y,this}subtract2f(t,e){return this.x-=t,this.y-=e,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=t,this.y*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this}multiply2f(t,e){return this.x*=t,this.y*=e,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divide2f(t,e){return this.x/=t,this.y/=e,this}negative(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSqr(){return this.x*this.x+this.y*this.y}normalize(){const t=this.x,e=this.y;let i=t*t+e*e;return i>0&&(i=1/Math.sqrt(i),this.x*=i,this.y*=i),this}angle(t){const e=this.lengthSqr(),i=t.lengthSqr();if(0===e||0===i)return console.warn("Can't get angle between zero vector"),0;let n=this.dot(t)/Math.sqrt(e*i);return n=ui(n,-1,1),Math.acos(n)}signAngle(t){const e=this.angle(t);return this.cross(t)<0?-e:e}rotate(t){const e=this.x,i=this.y,n=Math.sin(t),s=Math.cos(t);return this.x=s*e-n*i,this.y=n*e+s*i,this}project(t){const e=this.dot(t)/t.dot(t);return this.x=t.x*e,this.y=t.y*e,this}transformMat4(t){const e=this.x,i=this.y;return this.x=t.m00*e+t.m04*i+t.m12,this.y=t.m01*e+t.m05*i+t.m13,this}}t("Vec2",tn),tn.ZERO=Object.freeze(new tn(0,0)),tn.ONE=Object.freeze(new tn(1,1)),tn.NEG_ONE=Object.freeze(new tn(-1,-1)),tn.UNIT_X=Object.freeze(new tn(1,0)),tn.UNIT_Y=Object.freeze(new tn(0,1));const en=new tn,nn=new tn;function sn(t,e){return new tn(t,e)}we.fastDefine("cc.Vec2",tn,{x:0,y:0}),n.Vec2=tn,n.v2=sn;class rn extends Vt{static clone(t){return new rn(t.x,t.y,t.z,t.w)}static copy(t,e){return t.x=e.x,t.y=e.y,t.z=e.z,t.w=e.w,t}static set(t,e,i,n,s){return t.x=e,t.y=i,t.z=n,t.w=s,t}static add(t,e,i){return t.x=e.x+i.x,t.y=e.y+i.y,t.z=e.z+i.z,t.w=e.w+i.w,t}static subtract(t,e,i){return t.x=e.x-i.x,t.y=e.y-i.y,t.z=e.z-i.z,t.w=e.w-i.w,t}static multiply(t,e,i){return t.x=e.x*i.x,t.y=e.y*i.y,t.z=e.z*i.z,t.w=e.w*i.w,t}static divide(t,e,i){return t.x=e.x/i.x,t.y=e.y/i.y,t.z=e.z/i.z,t.w=e.w/i.w,t}static ceil(t,e){return t.x=Math.ceil(e.x),t.y=Math.ceil(e.y),t.z=Math.ceil(e.z),t.w=Math.ceil(e.w),t}static floor(t,e){return t.x=Math.floor(e.x),t.y=Math.floor(e.y),t.z=Math.floor(e.z),t.w=Math.floor(e.w),t}static min(t,e,i){return t.x=Math.min(e.x,i.x),t.y=Math.min(e.y,i.y),t.z=Math.min(e.z,i.z),t.w=Math.min(e.w,i.w),t}static max(t,e,i){return t.x=Math.max(e.x,i.x),t.y=Math.max(e.y,i.y),t.z=Math.max(e.z,i.z),t.w=Math.max(e.w,i.w),t}static round(t,e){return t.x=Math.round(e.x),t.y=Math.round(e.y),t.z=Math.round(e.z),t.w=Math.round(e.w),t}static multiplyScalar(t,e,i){return t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i,t}static scaleAndAdd(t,e,i,n){return t.x=e.x+i.x*n,t.y=e.y+i.y*n,t.z=e.z+i.z*n,t.w=e.w+i.w*n,t}static distance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return Math.sqrt(i*i+n*n+s*s+r*r)}static squaredDistance(t,e){const i=e.x-t.x,n=e.y-t.y,s=e.z-t.z,r=e.w-t.w;return i*i+n*n+s*s+r*r}static len(t){const e=t.x,i=t.y,n=t.z,s=t.w;return Math.sqrt(e*e+i*i+n*n+s*s)}static lengthSqr(t){const e=t.x,i=t.y,n=t.z,s=t.w;return e*e+i*i+n*n+s*s}static negate(t,e){return t.x=-e.x,t.y=-e.y,t.z=-e.z,t.w=-e.w,t}static inverse(t,e){return t.x=1/e.x,t.y=1/e.y,t.z=1/e.z,t.w=1/e.w,t}static inverseSafe(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;return Math.abs(i)<ci?t.x=0:t.x=1/i,Math.abs(n)<ci?t.y=0:t.y=1/n,Math.abs(s)<ci?t.z=0:t.z=1/s,Math.abs(r)<ci?t.w=0:t.w=1/r,t}static normalize(t,e){const i=e.x,n=e.y,s=e.z,r=e.w;let o=i*i+n*n+s*s+r*r;return o>0&&(o=1/Math.sqrt(o),t.x=i*o,t.y=n*o,t.z=s*o,t.w=r*o),t}static dot(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static lerp(t,e,i,n){return t.x=e.x+n*(i.x-e.x),t.y=e.y+n*(i.y-e.y),t.z=e.z+n*(i.z-e.z),t.w=e.w+n*(i.w-e.w),t}static random(t,e){e=e||1;const i=2*gi()*Math.PI,n=2*gi()-1,s=Math.sqrt(1-n*n);return t.x=s*Math.cos(i)*e,t.y=s*Math.sin(i)*e,t.z=n*e,t.w=0,t}static transformMat4(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m04*s+i.m08*r+i.m12*o,t.y=i.m01*n+i.m05*s+i.m09*r+i.m13*o,t.z=i.m02*n+i.m06*s+i.m10*r+i.m14*o,t.w=i.m03*n+i.m07*s+i.m11*r+i.m15*o,t}static transformAffine(t,e,i){const n=e.x,s=e.y,r=e.z,o=e.w;return t.x=i.m00*n+i.m01*s+i.m02*r+i.m03*o,t.y=i.m04*n+i.m05*s+i.m06*r+i.m07*o,t.x=i.m08*n+i.m09*s+i.m10*r+i.m11*o,t.w=e.w,t}static transformQuat(t,e,i){const{x:n,y:s,z:r}=e,o=i.x,a=i.y,l=i.z,c=i.w,h=c*n+a*r-l*s,_=c*s+l*n-o*r,u=c*r+o*s-a*n,m=-o*n-a*s-l*r;return t.x=h*c+m*-o+_*-l-u*-a,t.y=_*c+m*-a+u*-o-h*-l,t.z=u*c+m*-l+h*-a-_*-o,t.w=e.w,t}static toArray(t,e,i=0){return t[i+0]=e.x,t[i+1]=e.y,t[i+2]=e.z,t[i+3]=e.w,t}static fromArray(t,e,i=0){return t.x=e[i+0],t.y=e[i+1],t.z=e[i+2],t.w=e[i+3],t}static strictEquals(t,e){return t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w}static equals(t,e,i=ci){return Math.abs(t.x-e.x)<=i*Math.max(1,Math.abs(t.x),Math.abs(e.x))&&Math.abs(t.y-e.y)<=i*Math.max(1,Math.abs(t.y),Math.abs(e.y))&&Math.abs(t.z-e.z)<=i*Math.max(1,Math.abs(t.z),Math.abs(e.z))&&Math.abs(t.w-e.w)<=i*Math.max(1,Math.abs(t.w),Math.abs(e.w))}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0)}clone(){return new rn(this.x,this.y,this.z,this.w)}set(t,e,i,n){return t&&"object"==typeof t?(this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=n||0),this}equals(t,e=ci){return Math.abs(this.x-t.x)<=e*Math.max(1,Math.abs(this.x),Math.abs(t.x))&&Math.abs(this.y-t.y)<=e*Math.max(1,Math.abs(this.y),Math.abs(t.y))&&Math.abs(this.z-t.z)<=e*Math.max(1,Math.abs(this.z),Math.abs(t.z))&&Math.abs(this.w-t.w)<=e*Math.max(1,Math.abs(this.w),Math.abs(t.w))}equals4f(t,e,i,n,s=ci){return Math.abs(this.x-t)<=s*Math.max(1,Math.abs(this.x),Math.abs(t))&&Math.abs(this.y-e)<=s*Math.max(1,Math.abs(this.y),Math.abs(e))&&Math.abs(this.z-i)<=s*Math.max(1,Math.abs(this.z),Math.abs(i))&&Math.abs(this.w-n)<=s*Math.max(1,Math.abs(this.w),Math.abs(n))}strictEquals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w}strictEquals4f(t,e,i,n){return this.x===t&&this.y===e&&this.z===i&&this.w===n}lerp(t,e){const i=this.x,n=this.y,s=this.z,r=this.w;return this.x=i+e*(t.x-i),this.y=n+e*(t.y-n),this.z=s+e*(t.z-s),this.w=r+e*(t.w-r),this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.z.toFixed(2)}, ${this.w.toFixed(2)})`}clampf(t,e){return this.x=ui(this.x,t.x,e.x),this.y=ui(this.y,t.y,e.y),this.z=ui(this.z,t.z,e.z),this.w=ui(this.w,t.w,e.w),this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}add4f(t,e,i,n){return this.x+=t,this.y+=e,this.z+=i,this.w+=n,this}subtract(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subtract4f(t,e,i,n){return this.x-=t,this.y-=e,this.z-=i,this.w-=n,this}multiplyScalar(t){return"object"==typeof t&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}multiply(t){return"object"!=typeof t&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiply4f(t,e,i,n){return this.x*=t,this.y*=e,this.z*=i,this.w*=n,this}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}divide4f(t,e,i,n){return this.x/=t,this.y/=e,this.z/=i,this.w/=n,this}negative(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}cross(t){const{x:e,y:i,z:n}=this,{x:s,y:r,z:o}=t;return this.x=i*o-n*r,this.y=n*s-e*o,this.z=e*r-i*s,this}length(){const t=this.x,e=this.y,i=this.z,n=this.w;return Math.sqrt(t*t+e*e+i*i+n*n)}lengthSqr(){const t=this.x,e=this.y,i=this.z,n=this.w;return t*t+e*e+i*i+n*n}normalize(){const t=this.x,e=this.y,i=this.z,n=this.w;let s=t*t+e*e+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),this.x=t*s,this.y=e*s,this.z=i*s,this.w=n*s),this}transformMat4(t){const e=this.x,i=this.y,n=this.z,s=this.w;return this.x=t.m00*e+t.m04*i+t.m08*n+t.m12*s,this.y=t.m01*e+t.m05*i+t.m09*n+t.m13*s,this.z=t.m02*e+t.m06*i+t.m10*n+t.m14*s,this.w=t.m03*e+t.m07*i+t.m11*n+t.m15*s,this}}function on(t,e,i,n){return new rn(t,e,i,n)}t("Vec4",rn),rn.ZERO=Object.freeze(new rn(0,0,0,0)),rn.ONE=Object.freeze(new rn(1,1,1,1)),rn.NEG_ONE=Object.freeze(new rn(-1,-1,-1,-1)),we.fastDefine("cc.Vec4",rn,{x:0,y:0,z:0,w:0}),n.Vec4=rn,n.v4=on,Ze(tn,"Vec2",[{name:"sub",newName:"subtract",target:tn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:tn,targetName:"Vec2"},{name:"div",newName:"divide",target:tn,targetName:"Vec2"},{name:"dist",newName:"distance",target:tn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:tn,targetName:"Vec2"},{name:"mag",newName:"len",target:tn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:tn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:tn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:tn,targetName:"Vec2"}]),Ze(tn.prototype,"Vec2",[{name:"mag",newName:"length",target:tn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:tn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:tn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:tn.prototype,targetName:"Vec2"}]),Ze(Ni,"Vec3",[{name:"sub",newName:"subtract",target:Ni,targetName:"Vec3"},{name:"mul",newName:"multiply",target:Ni,targetName:"Vec3"},{name:"div",newName:"divide",target:Ni,targetName:"Vec3"},{name:"dist",newName:"distance",target:Ni,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:Ni,targetName:"Vec3"},{name:"mag",newName:"len",target:Ni,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:Ni,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ni,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ni,targetName:"Vec3"}]),Ze(Ni.prototype,"Vec3",[{name:"mag",newName:"length",target:Ni.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:Ni.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:Ni.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:Ni.prototype,targetName:"Vec3"}]),Ze(rn,"Vec4",[{name:"sub",newName:"subtract",target:rn,targetName:"Vec4"},{name:"mul",newName:"multiply",target:rn,targetName:"Vec4"},{name:"div",newName:"divide",target:rn,targetName:"Vec4"},{name:"dist",newName:"distance",target:rn,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:rn,targetName:"Vec4"},{name:"mag",newName:"len",target:rn,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:rn,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:rn,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:rn,targetName:"Vec4"}]),Ze(rn.prototype,"Vec4",[{name:"mag",newName:"length",target:rn.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:rn.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:rn.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:rn.prototype,targetName:"Vec4"}]),Ze(ki,"Quat",[{name:"mag",newName:"len",target:ki,targetName:"Quat"},{name:"mul",newName:"multiply",target:ki,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:ki,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:ki,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ki,targetName:"Quat"}]),Ze(ki.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:ki.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:ki.prototype,targetName:"Quat"}]),Ze(Ri,"Color",[{name:"sub",newName:"subtract",target:Ri,targetName:"Color"},{name:"mul",newName:"multiply",target:Ri,targetName:"Color"},{name:"div",newName:"divide",target:Ri,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Ri,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction(...t){const e=t[1].toString(16);return n.Color.fromHEX(t[0],e)}}]),Ze(Vi,"Mat3",[{name:"sub",newName:"subtract",target:Vi,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Vi,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Vi,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Vi,targetName:"Mat3"}]),Ze(Vi.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Vi.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Vi.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Vi.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Vi.prototype,targetName:"Mat3"}]),Ze($i,"Mat4",[{name:"sub",newName:"subtract",target:$i,targetName:"Mat4"},{name:"mul",newName:"multiply",target:$i,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:$i,targetName:"Mat4"}]),Ze($i.prototype,"Mat4",[{name:"sub",newName:"subtract",target:$i.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:$i.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:$i.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:$i.prototype,targetName:"Mat4"}]);class an{static identity(){return new an}static clone(t){return new an(t.a,t.b,t.c,t.d,t.tx,t.ty)}static concat(t,e,i){const n=e.a,s=e.b,r=e.c,o=e.d,a=e.tx,l=e.ty;t.a=n*i.a+s*i.c,t.b=n*i.b+s*i.d,t.c=r*i.a+o*i.c,t.d=r*i.b+o*i.d,t.tx=a*i.a+l*i.c+i.tx,t.ty=a*i.b+l*i.d+i.ty}static invert(t,e){const i=1/(e.a*e.d-e.b*e.c);t.a=i*e.d,t.b=-i*e.b,t.c=-i*e.c,t.d=i*e.a,t.tx=i*(e.c*e.ty-e.d*e.tx),t.ty=i*(e.b*e.tx-e.a*e.ty)}static fromMat4(t,e){t.a=e.m00,t.b=e.m01,t.c=e.m04,t.d=e.m05,t.tx=e.m12,t.ty=e.m13}static transformVec2(t,e,i,n){let s,r;void 0===n?(n=i,s=e.x,r=e.y):(s=e,r=i),t.x=n.a*s+n.c*r+n.tx,t.y=n.b*s+n.d*r+n.ty}static transformSize(t,e,i){t.width=i.a*e.width+i.c*e.height,t.height=i.b*e.width+i.d*e.height}static transformRect(t,e,i){const n=e.x+e.width,s=e.y+e.height,r=i.a*e.x+i.c*e.y+i.tx,o=i.b*e.x+i.d*e.y+i.ty,a=i.a*n+i.c*e.y+i.tx,l=i.b*n+i.d*e.y+i.ty,c=i.a*e.x+i.c*s+i.tx,h=i.b*e.x+i.d*s+i.ty,_=i.a*n+i.c*s+i.tx,u=i.b*n+i.d*s+i.ty,m=Math.min(r,a,c,_),p=Math.max(r,a,c,_),d=Math.min(o,l,h,u),f=Math.max(o,l,h,u);t.x=m,t.y=d,t.width=p-m,t.height=f-d}static transformObb(t,e,i,n,s,r){const o=r.a*s.x+r.c*s.y+r.tx,a=r.b*s.x+r.d*s.y+r.ty,l=r.a*s.width,c=r.b*s.width,h=r.c*s.height,_=r.d*s.height;e.x=o,e.y=a,i.x=l+o,i.y=c+a,t.x=h+o,t.y=_+a,n.x=l+h+o,n.y=c+_+a}constructor(t=1,e=0,i=0,n=1,s=0,r=0){this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}}t("AffineTransform",an),n.AffineTransform=an;class ln extends Vt{static lerp(t,e,i,n){return t.width=e.width+(i.width-e.width)*n,t.height=e.height+(i.height-e.height)*n,t}set x(t){this.width=t}get x(){return this.width}set y(t){this.height=t}get y(){return this.height}constructor(t,e){super(),t&&"object"==typeof t?(this.width=t.width,this.height=t.height):(this.width=t||0,this.height=e||0)}clone(){return new ln(this.width,this.height)}set(t,e){return t&&"object"==typeof t?(this.height=t.height,this.width=t.width):(this.width=t||0,this.height=e||0),this}equals(t){return this.width===t.width&&this.height===t.height}lerp(t,e){return this.width+=(t.width-this.width)*e,this.height+=(t.height-this.height)*e,this}toString(){return`(${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}}function cn(t=0,e=0){return new ln(t,e)}t("Size",ln),ln.ZERO=Object.freeze(new ln(0,0)),ln.ONE=Object.freeze(new ln(1,1)),we.fastDefine("cc.Size",ln,{width:0,height:0}),n.size=cn,n.Size=ln;class hn extends Vt{static fromMinMax(t,e,i){const n=Math.min(e.x,i.x),s=Math.min(e.y,i.y),r=Math.max(e.x,i.x),o=Math.max(e.y,i.y);return t.x=n,t.y=s,t.width=r-n,t.height=o-s,t}static lerp(t,e,i,n){const s=e.x,r=e.y,o=e.width,a=e.height;return t.x=s+(i.x-s)*n,t.y=r+(i.y-r)*n,t.width=o+(i.width-o)*n,t.height=a+(i.height-a)*n,t}static intersection(t,e,i){const n=e.x,s=e.y,r=e.x+e.width,o=e.y+e.height,a=i.x,l=i.y,c=i.x+i.width,h=i.y+i.height;return t.x=Math.max(n,a),t.y=Math.max(s,l),t.width=Math.min(r,c)-t.x,t.height=Math.min(o,h)-t.y,t}static union(t,e,i){const n=e.x,s=e.y,r=e.width,o=e.height,a=i.x,l=i.y,c=i.width,h=i.height;return t.x=Math.min(n,a),t.y=Math.min(s,l),t.width=Math.max(n+r,a+c)-t.x,t.height=Math.max(s+o,l+h)-t.y,t}get xMin(){return this.x}set xMin(t){this.width+=this.x-t,this.x=t}get yMin(){return this.y}set yMin(t){this.height+=this.y-t,this.y=t}get xMax(){return this.x+this.width}set xMax(t){this.width=t-this.x}get yMax(){return this.y+this.height}set yMax(t){this.height=t-this.y}get center(){return new tn(this.x+.5*this.width,this.y+.5*this.height)}set center(t){this.x=t.x-.5*this.width,this.y=t.y-.5*this.height}get origin(){return new tn(this.x,this.y)}set origin(t){this.x=t.x,this.y=t.y}get size(){return new ln(this.width,this.height)}set size(t){this.width=t.width,this.height=t.height}set z(t){this.width=t}get z(){return this.width}set w(t){this.height=t}get w(){return this.height}constructor(t,e,i,n){super(),t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0)}clone(){return new hn(this.x,this.y,this.width,this.height)}set(t,e,i,n){return t&&"object"==typeof t?(this.y=t.y,this.width=t.width,this.height=t.height,this.x=t.x):(this.x=t||0,this.y=e||0,this.width=i||0,this.height=n||0),this}equals(t){return this.x===t.x&&this.y===t.y&&this.width===t.width&&this.height===t.height}lerp(t,e){const i=this.x,n=this.y,s=this.width,r=this.height;return this.x=i+(t.x-i)*e,this.y=n+(t.y-n)*e,this.width=s+(t.width-s)*e,this.height=r+(t.height-r)*e,this}toString(){return`(${this.x.toFixed(2)}, ${this.y.toFixed(2)}, ${this.width.toFixed(2)}, ${this.height.toFixed(2)})`}intersects(t){const e=this.x+this.width,i=this.y+this.height,n=t.x+t.width,s=t.y+t.height;return!(e<t.x||n<this.x||i<t.y||s<this.y)}contains(t){return this.x<=t.x&&this.x+this.width>=t.x&&this.y<=t.y&&this.y+this.height>=t.y}containsRect(t){return this.x<=t.x&&this.x+this.width>=t.x+t.width&&this.y<=t.y&&this.y+this.height>=t.y+t.height}transformMat4(t){const e=this.x,i=this.y,n=e+this.width,s=i+this.height,r=t.m00*e+t.m04*i+t.m12,o=t.m01*e+t.m05*i+t.m13,a=t.m00*n+t.m04*i+t.m12,l=t.m01*n+t.m05*i+t.m13,c=t.m00*e+t.m04*s+t.m12,h=t.m01*e+t.m05*s+t.m13,_=t.m00*n+t.m04*s+t.m12,u=t.m01*n+t.m05*s+t.m13,m=Math.min(r,a,c,_),p=Math.max(r,a,c,_),d=Math.min(o,l,h,u),f=Math.max(o,l,h,u);return this.x=m,this.y=d,this.width=p-m,this.height=f-d,this}transformMat4ToPoints(t,e,i,n,s){const r=this.x,o=this.y,a=r+this.width,l=o+this.height;e.x=t.m00*r+t.m04*o+t.m12,e.y=t.m01*r+t.m05*o+t.m13,s.x=t.m00*a+t.m04*o+t.m12,s.y=t.m01*a+t.m05*o+t.m13,i.x=t.m00*r+t.m04*l+t.m12,i.y=t.m01*r+t.m05*l+t.m13,n.x=t.m00*a+t.m04*l+t.m12,n.y=t.m01*a+t.m05*l+t.m13}}function _n(t=0,e=0,i=0,n=0){return new hn(t,e,i,n)}t("Rect",hn),we.fastDefine("cc.Rect",hn,{x:0,y:0,width:0,height:0}),n.Rect=hn,n.rect=_n;var un=Object.freeze({__proto__:null,bits:Je,Vec2:tn,v2:sn,Vec3:Ni,v3:zi,Vec4:rn,v4:on,Quat:ki,quat:Yi,Mat3:Vi,Mat4:$i,mat4:Qi,AffineTransform:an,Size:ln,size:cn,Rect:hn,rect:_n,Color:Ri,color:Mi,EPSILON:ci,equals:hi,approx:_i,clamp:ui,clamp01:mi,lerp:pi,toRadian:di,toDegree:fi,random:gi,randomRange:yi,randomRangeInt:vi,pseudoRandom:xi,pseudoRandomRange:bi,pseudoRandomRangeInt:Si,nextPow2:Ai,repeat:Ci,pingPong:Ti,inverseLerp:wi,absMaxComponent:Ei,absMax:Pi,enumerableProps:Di,MATH_FLOAT_ARRAY:Oi,MathBase:Bi});let mn;t("math",un),function(t){t[t.PORTRAIT=1]="PORTRAIT",t[t.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",t[t.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",t[t.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",t[t.LANDSCAPE=12]="LANDSCAPE"}(mn||(mn={}));const pn={0:mn.PORTRAIT,"-90":mn.LANDSCAPE_LEFT,90:mn.LANDSCAPE_RIGHT,180:mn.PORTRAIT_UPSIDE_DOWN},dn=new class extends He{constructor(){super(),this._registerEvent()}_registerEvent(){jsb.onResize=t=>{0!==t.width&&0!==t.height&&(t.width/=qe.pixelRatio,t.height/=qe.pixelRatio,window.resize(t.width,t.height),this.emit("window-resize"))},jsb.onOrientationChanged=()=>{this.emit("orientation-change")}}get supportFullScreen(){return!1}get isFullScreen(){return!1}get windowSize(){return new ln(window.innerWidth,window.innerHeight)}set windowSize(t){console.warn("Setting window size is not supported yet.")}get orientation(){return pn[jsb.device.getDeviceOrientation()]}get safeAreaEdge(){const t=jsb.device.getSafeAreaEdge();let e=t.x,i=t.z,n=t.y,s=t.w;return this.orientation===mn.PORTRAIT?e<i?e=i:i=e:n<s?n=s:s=n,{top:e,bottom:i,left:n,right:s}}requestFullScreen(){return Promise.reject(new Error("request fullscreen has not been supported yet on this platform."))}exitFullScreen(){return Promise.reject(new Error("exit fullscreen has not been supported yet on this platform."))}},fn=dn.windowSize,gn=qe.pixelRatio,yn=t("sys",{NetworkType:N,Language:B,OS:L,Platform:F,BrowserType:O,isNative:qe.isNative,isBrowser:qe.isBrowser,isMobile:qe.isMobile,isLittleEndian:qe.isLittleEndian,platform:qe.platform,language:qe.language,languageCode:qe.nativeLanguage,os:qe.os,osVersion:qe.osVersion,osMainVersion:qe.osMainVersion,browserType:qe.browserType,browserVersion:qe.browserVersion,windowPixelResolution:{width:fn.width*gn,height:fn.height*gn},capabilities:{canvas:qe.supportCapability.canvas,opengl:qe.supportCapability.gl,webp:qe.supportCapability.webp,imageBitmap:qe.supportCapability.imageBitmap,touches:!1,mouse:!1,keyboard:!1,accelerometer:!1},localStorage:{},getNetworkType:()=>qe.networkType,getBatteryLevel:()=>qe.getBatteryLevel(),garbageCollect(){qe.triggerGC()},isObjectValid:t=>null!=t,dump(){let t="";t+=`isMobile : ${this.isMobile}\r\n`,t+=`language : ${this.language}\r\n`,t+=`browserType : ${this.browserType}\r\n`,t+=`browserVersion : ${this.browserVersion}\r\n`,t+=`capabilities : ${JSON.stringify(this.capabilities)}\r\n`,t+=`os : ${this.os}\r\n`,t+=`osVersion : ${this.osVersion}\r\n`,t+=`platform : ${this.platform}\r\n`,t+=`Using ${n.game.renderType===n.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS"} renderer.\r\n`,u(t)},openURL(t){qe.openURL(t)},now:()=>qe.now(),restartVM(){qe.restartJSVM()},getSafeAreaRect(){const t=n.view,e=dn.safeAreaEdge,i=dn.windowSize,s=new tn(e.left,i.height-e.bottom),r=new tn(i.width-e.right,e.top),o={left:0,top:0,width:i.width,height:i.height};t.convertToLocationInView(s.x,s.y,o,s),t.convertToLocationInView(r.x,r.y,o,r),t._convertPointWithScale(s),t._convertPointWithScale(r);const a=s.x,l=s.y,c=r.x-s.x,h=r.y-s.y;return new hn(a,l,c,h)}});!function(){try{let t=yn.localStorage=window.localStorage;t.setItem("storage",""),t.removeItem("storage"),t=null}catch(t){const e=function(){A(5200)};yn.localStorage={getItem:e,setItem:e,clear:e,removeItem:e}}const t=window,e=t.navigator,i=document,n=i.documentElement,s=yn.capabilities;(void 0!==n.ontouchstart||void 0!==i.ontouchstart||e.msPointerEnabled)&&(s.touches=!0),void 0!==n.onmouseup&&(s.mouse=!0),void 0!==n.onkeyup&&(s.keyboard=!0),(t.DeviceMotionEvent||t.DeviceOrientationEvent)&&(s.accelerometer=!0),yn.__isWebIOS14OrIPadOS14Env=(yn.os===L.IOS||yn.os===L.OSX)&&qe.isBrowser&&/(OS 1[4-9])|(Version\/1[4-9])/.test(window.navigator.userAgent),dn.on("window-resize",(()=>{const t=dn.windowSize;yn.windowPixelResolution={width:Math.round(t.width*gn),height:Math.round(t.height*gn)}}))}(),n.sys=yn;const vn=/(\.[^\.\/\?\\]*)(\?.*)?$/,xn=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,bn=/[^\.\/]+\/\.\.\//;function Sn(...t){let e="";for(const i of t)e=(e+(""===e?"":"/")+i).replace(/(\/|\\\\)$/,"");return e}function An(t){const e=vn.exec(t);return e?e[1]:""}function Cn(t){if(t){const e=t.lastIndexOf(".");if(-1!==e)return t.substring(0,e)}return t}function Tn(t,e){const i=t.indexOf("?");i>0&&(t=t.substring(0,i));const n=/(\/|\\)([^\/\\]+)$/g.exec(t.replace(/(\/|\\)$/,""));if(!n)return t;const s=n[2];return e&&t.substring(t.length-e.length).toLowerCase()===e.toLowerCase()?s.substring(0,s.length-e.length):s}function wn(t){const e=xn.exec(t);return e?e[2]:""}function En(t,e){e=e||"";let i=t.indexOf("?"),n="";return i>0&&(n=t.substring(i),t=t.substring(0,i)),i=t.lastIndexOf("."),i<0?t+e+n:t.substring(0,i)+e+n}function Pn(t,e,i){if(0===e.indexOf("."))return En(t,e);let n=t.indexOf("?"),s="";const r=i?An(t):"";return n>0&&(s=t.substring(n),t=t.substring(0,n)),n=t.lastIndexOf("/"),n=n<=0?0:n+1,t.substring(0,n)+e+r+s}function Dn(t){let e=t=String(t);do{e=t,t=t.replace(bn,"")}while(e.length!==t.length);return t}function In(t){return t.replace(/[\/\\]$/,"")}function Rn(){return yn.os===L.WINDOWS?"\\":"/"}t("path",Object.freeze({__proto__:null,join:Sn,extname:An,mainFileName:Cn,basename:Tn,dirname:wn,changeExtname:En,changeBasename:Pn,_normalize:Dn,stripSep:In,getSeperator:Rn})),n.log=u,n.warn=m,n.error=p,n.assert=d,n._throw=y,n.logID=b,n.warnID=A,n.errorID=T,n.assertID=E,n.debug=M,n.path={join:Sn,extname:An,mainFileName:Cn,basename:Tn,dirname:wn,changeExtname:En,changeBasename:Pn,_normalize:Dn,stripSep:In,get sep(){return Rn()}};let Mn=0;const On={};var Bn={addStage(t){if(void 0!==On[t])return;const e=1<<Mn;On[t]=e,Mn+=1},stageID(t){const e=On[t];return void 0===e?-1:e},stageIDs(t){let e=0;for(const i of t){const t=On[i];void 0!==t&&(e|=t)}return e}};const Nn=ns.Node,Ln=ns.Scene,Fn=ns.Model,zn=ns.SkinningModel,Vn=ns.BakedSkinningModel,Un=ns.light,Gn=ns.DirectionalLight,kn=ns.SpotLight,Hn=ns.SphereLight,jn=ns.Skybox,Wn=ns.Fog,qn=ns.Ambient,Xn=ns.Shadow,Yn=ns.Camera,Kn=ns.RenderWindow,$n=ns.RenderScene,Jn=ns.DrawBatch2D,Zn=ns.Pass,Qn=ns.SubModel,ts=ns.Root,es=ns.PipelineSharedSceneData,is=ns.AABB;class ss{get colorArray(){return this._colorArray}get albedoArray(){return this._albedoArray}set enabled(t){this._enabled=t,this._nativeObj.enabled=t}get enabled(){return this._enabled}get skyColor(){return this._skyColor}set skyColor(t){this._skyColor.set(t),Ri.toArray(this._colorArray,this._skyColor),this._nativeObj.skyColor=this._skyColor}get skyIllum(){return this._skyIllum}set skyIllum(t){this._skyIllum=t,this._nativeObj.skyIllum=t}get groundAlbedo(){return this._groundAlbedo}set groundAlbedo(t){this._groundAlbedo.set(t),Ni.toArray(this._albedoArray,this._groundAlbedo),this._nativeObj.groundAlbedo=this._groundAlbedo}get native(){return this._nativeObj}constructor(){this._skyColor=new Ri(51,128,204,1),this._groundAlbedo=new Ri(51,51,51,255),this._albedoArray=Float32Array.from([.2,.2,.2,1]),this._colorArray=Float32Array.from([.2,.5,.8,1]),this._enabled=!1,this._skyIllum=0,this._nativeObj=new qn}initialize(t){this.skyColor=t.skyColor,this.groundAlbedo=t.groundAlbedo,this.skyIllum=t.skyIllum}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}ss.SUN_ILLUM=65e3,ss.SKY_ILLUM=2e4,n.Ambient=ss;const rs=new Ni,os=new Ni,as=new Ni,ls=new Ni,cs=new Ni,hs=new Ni,_s=new Array(3),us=new Array(3);function ms(t,e){return Ni.dot(e.n,t)-e.d}function ps(t,e,i){return Ni.copy(t,e),Ni.subtract(cs,i.center,i.halfExtents),Ni.add(hs,i.center,i.halfExtents),t.x=t.x<cs.x?cs.x:t.x,t.y=t.y<cs.y?cs.y:t.y,t.z=t.z<cs.z?cs.z:t.z,t.x=t.x>hs.x?hs.x:t.x,t.y=t.y>hs.y?hs.y:t.y,t.z=t.z>hs.z?hs.z:t.z,t}function ds(t,e,i){Ni.set(rs,i.orientation.m00,i.orientation.m01,i.orientation.m02),Ni.set(os,i.orientation.m03,i.orientation.m04,i.orientation.m05),Ni.set(as,i.orientation.m06,i.orientation.m07,i.orientation.m08),_s[0]=rs,_s[1]=os,_s[2]=as,us[0]=i.halfExtents.x,us[1]=i.halfExtents.y,us[2]=i.halfExtents.z,Ni.subtract(ls,e,i.center),Ni.set(t,i.center.x,i.center.y,i.center.z);for(let e=0;e<3;e++){let i=Ni.dot(ls,_s[e]);i>us[e]&&(i=us[e]),i<-us[e]&&(i=-us[e]),t.x+=i*_s[e].x,t.y+=i*_s[e].y,t.z+=i*_s[e].z}return t}var fs=Object.freeze({__proto__:null,point_plane:ms,pt_point_plane:function(t,e,i){const n=ms(e,i);return Ni.subtract(t,e,Ni.multiplyScalar(t,i.n,n))},pt_point_aabb:ps,pt_point_obb:ds,pt_point_line:function(t,e,i,n){Ni.subtract(rs,i,n);const s=rs,r=Ni.lengthSqr(s);if(0==r)Ni.copy(t,i);else{Ni.subtract(rs,e,i);const o=Ni.dot(rs,s)/r;o<0?Ni.copy(t,i):o>1?Ni.copy(t,n):Ni.scaleAndAdd(t,i,s,o)}}}),gs={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512};class ys{static create(t,e,i,n,s,r){return new ys(t,e,i,n,s,r)}static clone(t){return new ys(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)}static copy(t,e){return Ni.copy(t.s,e.s),Ni.copy(t.e,e.e),t}static fromPoints(t,e,i){return Ni.copy(t.s,e),Ni.copy(t.e,i),t}static set(t,e,i,n,s,r,o){return t.s.x=e,t.s.y=i,t.s.z=n,t.e.x=s,t.e.y=r,t.e.z=o,t}static len(t){return Ni.distance(t.s,t.e)}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.s=void 0,this.e=void 0,this._type=void 0,this._type=gs.SHAPE_LINE,this.s=new Ni(t,e,i),this.e=new Ni(n,s,r)}length(){return Ni.distance(this.s,this.e)}}class vs{static create(t=0,e=0,i=0,n=0,s=0,r=1){return new vs(t,e,i,n,s,r)}static clone(t){return new vs(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)}static copy(t,e){return Ni.copy(t.o,e.o),Ni.copy(t.d,e.d),t}static fromPoints(t,e,i){return Ni.copy(t.o,e),Ni.normalize(t.d,Ni.subtract(t.d,i,e)),t}static set(t,e,i,n,s,r,o){return t.o.x=e,t.o.y=i,t.o.z=n,t.d.x=s,t.d.y=r,t.d.z=o,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=0,s=0,r=-1){this.o=void 0,this.d=void 0,this._type=void 0,this._type=gs.SHAPE_RAY,this.o=new Ni(t,e,i),this.d=new Ni(n,s,r)}computeHit(t,e){Ni.normalize(t,this.d),Ni.scaleAndAdd(t,this.o,t,e)}}const xs=new Ni,bs=new Ni,Ss=new Ni,As=new Ni;function Cs(t){return Math.max(Math.max(t.x,t.y),t.z)}class Ts{static create(t,e,i,n){return new Ts(t,e,i,n)}static clone(t){return new Ts(t.center.x,t.center.y,t.center.z,t.radius)}static copy(t,e){return Ni.copy(t.center,e.center),t.radius=e.radius,t}static fromPoints(t,e,i){return Ni.multiplyScalar(t.center,Ni.add(xs,e,i),.5),t.radius=.5*Ni.subtract(xs,i,e).length(),t}static set(t,e,i,n,s){return t.center.x=e,t.center.y=i,t.center.z=n,t.radius=s,t}static mergePoint(t,e,i){if(e.radius<0)return t.center.set(i),t.radius=0,t;Ni.subtract(bs,i,e.center);const n=bs.length();if(n>e.radius){const i=.5*(n-e.radius);t.radius+=i,Ni.multiplyScalar(bs,bs,i/n),Ni.add(t.center,t.center,bs)}return t}static mergeAABB(t,e,i){return i.getBoundary(Ss,As),Ts.mergePoint(t,e,Ss),Ts.mergePoint(t,e,As),t}get center(){return this._center}set center(t){this._center=t}get radius(){return this._radius}set radius(t){this._radius=t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1){this._center=new Ni(0,0,0),this._radius=0,this._type=void 0,this._type=gs.SHAPE_SPHERE,this._center=new Ni(t,e,i),this._radius=n}destroy(){}clone(){return Ts.clone(this)}copy(t){return Ts.copy(this,t)}getBoundary(t,e){Ni.set(t,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),Ni.set(e,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)}transform(t,e,i,n,s){Ni.transformMat4(s.center,this.center,t),s.radius=this.radius*Cs(n)}translateAndRotate(t,e,i){Ni.transformMat4(i.center,this.center,t)}setScale(t,e){e.radius=this.radius*Cs(t)}}class ws{static create(t=1,e=0,i=0,n=0,s=0,r=0,o=0,a=0,l=1){return new ws(t,e,i,n,s,r,o,a,l)}static clone(t){return new ws(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)}static copy(t,e){return Ni.copy(t.a,e.a),Ni.copy(t.b,e.b),Ni.copy(t.c,e.c),t}static fromPoints(t,e,i,n){return Ni.copy(t.a,e),Ni.copy(t.b,i),Ni.copy(t.c,n),t}static set(t,e,i,n,s,r,o,a,l,c){return t.a.x=e,t.a.y=i,t.a.z=n,t.b.x=s,t.b.y=r,t.b.z=o,t.c.x=a,t.c.y=l,t.c.z=c,t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=0,r=0,o=0,a=1,l=0){this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=gs.SHAPE_TRIANGLE,this.a=new Ni(t,e,i),this.b=new Ni(n,s,r),this.c=new Ni(o,a,l)}}const Es=(t,e,i)=>{for(let n=0;n<e.length;++n)t.length<=n&&t.push(new i),t[n].copy(e[n]);t.length=e.length};let Ps,Ds,Is,Rs,Ms,Os,Bs,Ns,Ls,Fs,zs,Vs,Us,Gs,ks,Hs,js,Ws,qs,Xs,Ys,Ks,$s,Js,Zs,Qs,tr,er,ir,sr,rr,or,ar,lr,cr,hr,_r,ur,mr,pr;!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BUFFER=1]="BUFFER",t[t.TEXTURE=2]="TEXTURE",t[t.RENDER_PASS=3]="RENDER_PASS",t[t.FRAMEBUFFER=4]="FRAMEBUFFER",t[t.SAMPLER=5]="SAMPLER",t[t.SHADER=6]="SHADER",t[t.DESCRIPTOR_SET_LAYOUT=7]="DESCRIPTOR_SET_LAYOUT",t[t.PIPELINE_LAYOUT=8]="PIPELINE_LAYOUT",t[t.PIPELINE_STATE=9]="PIPELINE_STATE",t[t.DESCRIPTOR_SET=10]="DESCRIPTOR_SET",t[t.INPUT_ASSEMBLER=11]="INPUT_ASSEMBLER",t[t.COMMAND_BUFFER=12]="COMMAND_BUFFER",t[t.QUEUE=13]="QUEUE",t[t.GLOBAL_BARRIER=14]="GLOBAL_BARRIER",t[t.TEXTURE_BARRIER=15]="TEXTURE_BARRIER",t[t.BUFFER_BARRIER=16]="BUFFER_BARRIER"}(Ps||(Ps={})),function(t){t[t.UNREADY=0]="UNREADY",t[t.FAILED=1]="FAILED",t[t.SUCCESS=2]="SUCCESS"}(Ds||(Ds={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.GLES2=1]="GLES2",t[t.GLES3=2]="GLES3",t[t.METAL=3]="METAL",t[t.VULKAN=4]="VULKAN",t[t.WEBGL=5]="WEBGL",t[t.WEBGL2=6]="WEBGL2",t[t.WEBGPU=7]="WEBGPU"}(Is||(Is={})),function(t){t[t.IDENTITY=0]="IDENTITY",t[t.ROTATE_90=1]="ROTATE_90",t[t.ROTATE_180=2]="ROTATE_180",t[t.ROTATE_270=3]="ROTATE_270"}(Rs||(Rs={})),function(t){t[t.COLOR_FLOAT=0]="COLOR_FLOAT",t[t.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",t[t.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",t[t.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",t[t.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",t[t.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",t[t.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",t[t.FORMAT_SRGB=7]="FORMAT_SRGB",t[t.FORMAT_ETC1=8]="FORMAT_ETC1",t[t.FORMAT_ETC2=9]="FORMAT_ETC2",t[t.FORMAT_DXT=10]="FORMAT_DXT",t[t.FORMAT_PVRTC=11]="FORMAT_PVRTC",t[t.FORMAT_ASTC=12]="FORMAT_ASTC",t[t.FORMAT_RGB8=13]="FORMAT_RGB8",t[t.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",t[t.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",t[t.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",t[t.BLEND_MINMAX=17]="BLEND_MINMAX",t[t.COMPUTE_SHADER=18]="COMPUTE_SHADER",t[t.COUNT=19]="COUNT"}(Ms||(Ms={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.A8=1]="A8",t[t.L8=2]="L8",t[t.LA8=3]="LA8",t[t.R8=4]="R8",t[t.R8SN=5]="R8SN",t[t.R8UI=6]="R8UI",t[t.R8I=7]="R8I",t[t.R16F=8]="R16F",t[t.R16UI=9]="R16UI",t[t.R16I=10]="R16I",t[t.R32F=11]="R32F",t[t.R32UI=12]="R32UI",t[t.R32I=13]="R32I",t[t.RG8=14]="RG8",t[t.RG8SN=15]="RG8SN",t[t.RG8UI=16]="RG8UI",t[t.RG8I=17]="RG8I",t[t.RG16F=18]="RG16F",t[t.RG16UI=19]="RG16UI",t[t.RG16I=20]="RG16I",t[t.RG32F=21]="RG32F",t[t.RG32UI=22]="RG32UI",t[t.RG32I=23]="RG32I",t[t.RGB8=24]="RGB8",t[t.SRGB8=25]="SRGB8",t[t.RGB8SN=26]="RGB8SN",t[t.RGB8UI=27]="RGB8UI",t[t.RGB8I=28]="RGB8I",t[t.RGB16F=29]="RGB16F",t[t.RGB16UI=30]="RGB16UI",t[t.RGB16I=31]="RGB16I",t[t.RGB32F=32]="RGB32F",t[t.RGB32UI=33]="RGB32UI",t[t.RGB32I=34]="RGB32I",t[t.RGBA8=35]="RGBA8",t[t.BGRA8=36]="BGRA8",t[t.SRGB8_A8=37]="SRGB8_A8",t[t.RGBA8SN=38]="RGBA8SN",t[t.RGBA8UI=39]="RGBA8UI",t[t.RGBA8I=40]="RGBA8I",t[t.RGBA16F=41]="RGBA16F",t[t.RGBA16UI=42]="RGBA16UI",t[t.RGBA16I=43]="RGBA16I",t[t.RGBA32F=44]="RGBA32F",t[t.RGBA32UI=45]="RGBA32UI",t[t.RGBA32I=46]="RGBA32I",t[t.R5G6B5=47]="R5G6B5",t[t.R11G11B10F=48]="R11G11B10F",t[t.RGB5A1=49]="RGB5A1",t[t.RGBA4=50]="RGBA4",t[t.RGB10A2=51]="RGB10A2",t[t.RGB10A2UI=52]="RGB10A2UI",t[t.RGB9E5=53]="RGB9E5",t[t.D16=54]="D16",t[t.D16S8=55]="D16S8",t[t.D24=56]="D24",t[t.D24S8=57]="D24S8",t[t.D32F=58]="D32F",t[t.D32F_S8=59]="D32F_S8",t[t.BC1=60]="BC1",t[t.BC1_ALPHA=61]="BC1_ALPHA",t[t.BC1_SRGB=62]="BC1_SRGB",t[t.BC1_SRGB_ALPHA=63]="BC1_SRGB_ALPHA",t[t.BC2=64]="BC2",t[t.BC2_SRGB=65]="BC2_SRGB",t[t.BC3=66]="BC3",t[t.BC3_SRGB=67]="BC3_SRGB",t[t.BC4=68]="BC4",t[t.BC4_SNORM=69]="BC4_SNORM",t[t.BC5=70]="BC5",t[t.BC5_SNORM=71]="BC5_SNORM",t[t.BC6H_UF16=72]="BC6H_UF16",t[t.BC6H_SF16=73]="BC6H_SF16",t[t.BC7=74]="BC7",t[t.BC7_SRGB=75]="BC7_SRGB",t[t.ETC_RGB8=76]="ETC_RGB8",t[t.ETC2_RGB8=77]="ETC2_RGB8",t[t.ETC2_SRGB8=78]="ETC2_SRGB8",t[t.ETC2_RGB8_A1=79]="ETC2_RGB8_A1",t[t.ETC2_SRGB8_A1=80]="ETC2_SRGB8_A1",t[t.ETC2_RGBA8=81]="ETC2_RGBA8",t[t.ETC2_SRGB8_A8=82]="ETC2_SRGB8_A8",t[t.EAC_R11=83]="EAC_R11",t[t.EAC_R11SN=84]="EAC_R11SN",t[t.EAC_RG11=85]="EAC_RG11",t[t.EAC_RG11SN=86]="EAC_RG11SN",t[t.PVRTC_RGB2=87]="PVRTC_RGB2",t[t.PVRTC_RGBA2=88]="PVRTC_RGBA2",t[t.PVRTC_RGB4=89]="PVRTC_RGB4",t[t.PVRTC_RGBA4=90]="PVRTC_RGBA4",t[t.PVRTC2_2BPP=91]="PVRTC2_2BPP",t[t.PVRTC2_4BPP=92]="PVRTC2_4BPP",t[t.ASTC_RGBA_4X4=93]="ASTC_RGBA_4X4",t[t.ASTC_RGBA_5X4=94]="ASTC_RGBA_5X4",t[t.ASTC_RGBA_5X5=95]="ASTC_RGBA_5X5",t[t.ASTC_RGBA_6X5=96]="ASTC_RGBA_6X5",t[t.ASTC_RGBA_6X6=97]="ASTC_RGBA_6X6",t[t.ASTC_RGBA_8X5=98]="ASTC_RGBA_8X5",t[t.ASTC_RGBA_8X6=99]="ASTC_RGBA_8X6",t[t.ASTC_RGBA_8X8=100]="ASTC_RGBA_8X8",t[t.ASTC_RGBA_10X5=101]="ASTC_RGBA_10X5",t[t.ASTC_RGBA_10X6=102]="ASTC_RGBA_10X6",t[t.ASTC_RGBA_10X8=103]="ASTC_RGBA_10X8",t[t.ASTC_RGBA_10X10=104]="ASTC_RGBA_10X10",t[t.ASTC_RGBA_12X10=105]="ASTC_RGBA_12X10",t[t.ASTC_RGBA_12X12=106]="ASTC_RGBA_12X12",t[t.ASTC_SRGBA_4X4=107]="ASTC_SRGBA_4X4",t[t.ASTC_SRGBA_5X4=108]="ASTC_SRGBA_5X4",t[t.ASTC_SRGBA_5X5=109]="ASTC_SRGBA_5X5",t[t.ASTC_SRGBA_6X5=110]="ASTC_SRGBA_6X5",t[t.ASTC_SRGBA_6X6=111]="ASTC_SRGBA_6X6",t[t.ASTC_SRGBA_8X5=112]="ASTC_SRGBA_8X5",t[t.ASTC_SRGBA_8X6=113]="ASTC_SRGBA_8X6",t[t.ASTC_SRGBA_8X8=114]="ASTC_SRGBA_8X8",t[t.ASTC_SRGBA_10X5=115]="ASTC_SRGBA_10X5",t[t.ASTC_SRGBA_10X6=116]="ASTC_SRGBA_10X6",t[t.ASTC_SRGBA_10X8=117]="ASTC_SRGBA_10X8",t[t.ASTC_SRGBA_10X10=118]="ASTC_SRGBA_10X10",t[t.ASTC_SRGBA_12X10=119]="ASTC_SRGBA_12X10",t[t.ASTC_SRGBA_12X12=120]="ASTC_SRGBA_12X12",t[t.COUNT=121]="COUNT"}(Os||(Os={})),function(t){t[t.NONE=0]="NONE",t[t.UNORM=1]="UNORM",t[t.SNORM=2]="SNORM",t[t.UINT=3]="UINT",t[t.INT=4]="INT",t[t.UFLOAT=5]="UFLOAT",t[t.FLOAT=6]="FLOAT"}(Bs||(Bs={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.BOOL=1]="BOOL",t[t.BOOL2=2]="BOOL2",t[t.BOOL3=3]="BOOL3",t[t.BOOL4=4]="BOOL4",t[t.INT=5]="INT",t[t.INT2=6]="INT2",t[t.INT3=7]="INT3",t[t.INT4=8]="INT4",t[t.UINT=9]="UINT",t[t.UINT2=10]="UINT2",t[t.UINT3=11]="UINT3",t[t.UINT4=12]="UINT4",t[t.FLOAT=13]="FLOAT",t[t.FLOAT2=14]="FLOAT2",t[t.FLOAT3=15]="FLOAT3",t[t.FLOAT4=16]="FLOAT4",t[t.MAT2=17]="MAT2",t[t.MAT2X3=18]="MAT2X3",t[t.MAT2X4=19]="MAT2X4",t[t.MAT3X2=20]="MAT3X2",t[t.MAT3=21]="MAT3",t[t.MAT3X4=22]="MAT3X4",t[t.MAT4X2=23]="MAT4X2",t[t.MAT4X3=24]="MAT4X3",t[t.MAT4=25]="MAT4",t[t.SAMPLER1D=26]="SAMPLER1D",t[t.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",t[t.SAMPLER2D=28]="SAMPLER2D",t[t.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",t[t.SAMPLER3D=30]="SAMPLER3D",t[t.SAMPLER_CUBE=31]="SAMPLER_CUBE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE1D=33]="TEXTURE1D",t[t.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",t[t.TEXTURE2D=35]="TEXTURE2D",t[t.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",t[t.TEXTURE3D=37]="TEXTURE3D",t[t.TEXTURE_CUBE=38]="TEXTURE_CUBE",t[t.IMAGE1D=39]="IMAGE1D",t[t.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",t[t.IMAGE2D=41]="IMAGE2D",t[t.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",t[t.IMAGE3D=43]="IMAGE3D",t[t.IMAGE_CUBE=44]="IMAGE_CUBE",t[t.SUBPASS_INPUT=45]="SUBPASS_INPUT",t[t.COUNT=46]="COUNT"}(Ns||(Ns={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.INDEX=4]="INDEX",t[t.VERTEX=8]="VERTEX",t[t.UNIFORM=16]="UNIFORM",t[t.STORAGE=32]="STORAGE",t[t.INDIRECT=64]="INDIRECT"}(Ls||(Ls={})),function(t){t[t.NONE=0]="NONE"}(Fs||(Fs={})),function(t){t[t.NONE=0]="NONE",t[t.READ_ONLY=1]="READ_ONLY",t[t.WRITE_ONLY=2]="WRITE_ONLY",t[t.READ_WRITE=3]="READ_WRITE"}(zs||(zs={})),function(t){t[t.NONE=0]="NONE",t[t.DEVICE=1]="DEVICE",t[t.HOST=2]="HOST"}(Vs||(Vs={})),function(t){t[t.TEX1D=0]="TEX1D",t[t.TEX2D=1]="TEX2D",t[t.TEX3D=2]="TEX3D",t[t.CUBE=3]="CUBE",t[t.TEX1D_ARRAY=4]="TEX1D_ARRAY",t[t.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Us||(Us={})),function(t){t[t.NONE=0]="NONE",t[t.TRANSFER_SRC=1]="TRANSFER_SRC",t[t.TRANSFER_DST=2]="TRANSFER_DST",t[t.SAMPLED=4]="SAMPLED",t[t.STORAGE=8]="STORAGE",t[t.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",t[t.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",t[t.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Gs||(Gs={})),function(t){t[t.NONE=0]="NONE",t[t.GEN_MIPMAP=1]="GEN_MIPMAP",t[t.IMMUTABLE=2]="IMMUTABLE",t[t.GENERAL_LAYOUT=4]="GENERAL_LAYOUT"}(ks||(ks={})),function(t){t[t.X1=1]="X1",t[t.X2=2]="X2",t[t.X4=4]="X4",t[t.X8=8]="X8",t[t.X16=16]="X16",t[t.X32=32]="X32",t[t.X64=64]="X64"}(Hs||(Hs={})),function(t){t[t.NONE=0]="NONE",t[t.POINT=1]="POINT",t[t.LINEAR=2]="LINEAR",t[t.ANISOTROPIC=3]="ANISOTROPIC"}(js||(js={})),function(t){t[t.WRAP=0]="WRAP",t[t.MIRROR=1]="MIRROR",t[t.CLAMP=2]="CLAMP",t[t.BORDER=3]="BORDER"}(Ws||(Ws={})),function(t){t[t.NEVER=0]="NEVER",t[t.LESS=1]="LESS",t[t.EQUAL=2]="EQUAL",t[t.LESS_EQUAL=3]="LESS_EQUAL",t[t.GREATER=4]="GREATER",t[t.NOT_EQUAL=5]="NOT_EQUAL",t[t.GREATER_EQUAL=6]="GREATER_EQUAL",t[t.ALWAYS=7]="ALWAYS"}(qs||(qs={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=1]="KEEP",t[t.REPLACE=2]="REPLACE",t[t.INCR=3]="INCR",t[t.DECR=4]="DECR",t[t.INVERT=5]="INVERT",t[t.INCR_WRAP=6]="INCR_WRAP",t[t.DECR_WRAP=7]="DECR_WRAP"}(Xs||(Xs={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_ALPHA=2]="SRC_ALPHA",t[t.DST_ALPHA=3]="DST_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",t[t.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",t[t.SRC_COLOR=6]="SRC_COLOR",t[t.DST_COLOR=7]="DST_COLOR",t[t.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",t[t.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=11]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ys||(Ys={})),function(t){t[t.ADD=0]="ADD",t[t.SUB=1]="SUB",t[t.REV_SUB=2]="REV_SUB",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(Ks||(Ks={})),function(t){t[t.NONE=0]="NONE",t[t.R=1]="R",t[t.G=2]="G",t[t.B=4]="B",t[t.A=8]="A",t[t.ALL=15]="ALL"}($s||($s={})),function(t){t[t.NONE=0]="NONE",t[t.VERTEX=1]="VERTEX",t[t.CONTROL=2]="CONTROL",t[t.EVALUATION=4]="EVALUATION",t[t.GEOMETRY=8]="GEOMETRY",t[t.FRAGMENT=16]="FRAGMENT",t[t.COMPUTE=32]="COMPUTE",t[t.ALL=63]="ALL"}(Js||(Js={})),function(t){t[t.LOAD=0]="LOAD",t[t.CLEAR=1]="CLEAR",t[t.DISCARD=2]="DISCARD"}(Zs||(Zs={})),function(t){t[t.STORE=0]="STORE",t[t.DISCARD=1]="DISCARD"}(Qs||(Qs={})),function(t){t[t.NONE=0]="NONE",t[t.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",t[t.INDEX_BUFFER=2]="INDEX_BUFFER",t[t.VERTEX_BUFFER=3]="VERTEX_BUFFER",t[t.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",t[t.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",t[t.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",t[t.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",t[t.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",t[t.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",t[t.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",t[t.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",t[t.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",t[t.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",t[t.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",t[t.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",t[t.TRANSFER_READ=17]="TRANSFER_READ",t[t.HOST_READ=18]="HOST_READ",t[t.PRESENT=19]="PRESENT",t[t.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",t[t.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",t[t.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",t[t.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",t[t.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",t[t.TRANSFER_WRITE=25]="TRANSFER_WRITE",t[t.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",t[t.HOST_WRITE=27]="HOST_WRITE"}(tr||(tr={})),function(t){t[t.NONE=0]="NONE",t[t.SAMPLE_ZERO=1]="SAMPLE_ZERO",t[t.AVERAGE=2]="AVERAGE",t[t.MIN=3]="MIN",t[t.MAX=4]="MAX"}(er||(er={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.RAY_TRACING=2]="RAY_TRACING"}(ir||(ir={})),function(t){t[t.POINT_LIST=0]="POINT_LIST",t[t.LINE_LIST=1]="LINE_LIST",t[t.LINE_STRIP=2]="LINE_STRIP",t[t.LINE_LOOP=3]="LINE_LOOP",t[t.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",t[t.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",t[t.ISO_LINE_LIST=6]="ISO_LINE_LIST",t[t.TRIANGLE_LIST=7]="TRIANGLE_LIST",t[t.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=9]="TRIANGLE_FAN",t[t.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",t[t.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",t[t.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",t[t.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(sr||(sr={})),function(t){t[t.FILL=0]="FILL",t[t.POINT=1]="POINT",t[t.LINE=2]="LINE"}(rr||(rr={})),function(t){t[t.GOURAND=0]="GOURAND",t[t.FLAT=1]="FLAT"}(or||(or={})),function(t){t[t.NONE=0]="NONE",t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK"}(ar||(ar={})),function(t){t[t.NONE=0]="NONE",t[t.VIEWPORT=1]="VIEWPORT",t[t.SCISSOR=2]="SCISSOR",t[t.LINE_WIDTH=4]="LINE_WIDTH",t[t.DEPTH_BIAS=8]="DEPTH_BIAS",t[t.BLEND_CONSTANTS=16]="BLEND_CONSTANTS",t[t.DEPTH_BOUNDS=32]="DEPTH_BOUNDS",t[t.STENCIL_WRITE_MASK=64]="STENCIL_WRITE_MASK",t[t.STENCIL_COMPARE_MASK=128]="STENCIL_COMPARE_MASK"}(lr||(lr={})),function(t){t[t.FRONT=1]="FRONT",t[t.BACK=2]="BACK",t[t.ALL=3]="ALL"}(cr||(cr={})),function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",t[t.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",t[t.STORAGE_BUFFER=4]="STORAGE_BUFFER",t[t.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",t[t.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",t[t.SAMPLER=32]="SAMPLER",t[t.TEXTURE=64]="TEXTURE",t[t.STORAGE_IMAGE=128]="STORAGE_IMAGE",t[t.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(hr||(hr={})),function(t){t[t.GRAPHICS=0]="GRAPHICS",t[t.COMPUTE=1]="COMPUTE",t[t.TRANSFER=2]="TRANSFER"}(_r||(_r={})),function(t){t[t.PRIMARY=0]="PRIMARY",t[t.SECONDARY=1]="SECONDARY"}(ur||(ur={})),function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.DEPTH=2]="DEPTH",t[t.STENCIL=4]="STENCIL",t[t.DEPTH_STENCIL=6]="DEPTH_STENCIL",t[t.ALL=7]="ALL"}(mr||(mr={}));class dr{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class fr{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0,a=0,l=0,c=0,h=0,_=0,u=0,m=0,p=0,d=1,f=0,g=0,y=new dr,v=new dr,x=-1,b=1,S=1){this.maxVertexAttributes=t,this.maxVertexUniformVectors=e,this.maxFragmentUniformVectors=i,this.maxTextureUnits=n,this.maxImageUnits=s,this.maxVertexTextureUnits=r,this.maxColorRenderTargets=o,this.maxShaderStorageBufferBindings=a,this.maxShaderStorageBlockSize=l,this.maxUniformBufferBindings=c,this.maxUniformBlockSize=h,this.maxTextureSize=_,this.maxCubeMapTextureSize=u,this.depthBits=m,this.stencilBits=p,this.uboOffsetAlignment=d,this.maxComputeSharedMemorySize=f,this.maxComputeWorkGroupInvocations=g,this.maxComputeWorkGroupSize=y,this.maxComputeWorkGroupCount=v,this.clipSpaceMinZ=x,this.screenSpaceSignY=b,this.clipSpaceSignY=S}copy(t){return this.maxVertexAttributes=t.maxVertexAttributes,this.maxVertexUniformVectors=t.maxVertexUniformVectors,this.maxFragmentUniformVectors=t.maxFragmentUniformVectors,this.maxTextureUnits=t.maxTextureUnits,this.maxImageUnits=t.maxImageUnits,this.maxVertexTextureUnits=t.maxVertexTextureUnits,this.maxColorRenderTargets=t.maxColorRenderTargets,this.maxShaderStorageBufferBindings=t.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=t.maxShaderStorageBlockSize,this.maxUniformBufferBindings=t.maxUniformBufferBindings,this.maxUniformBlockSize=t.maxUniformBlockSize,this.maxTextureSize=t.maxTextureSize,this.maxCubeMapTextureSize=t.maxCubeMapTextureSize,this.depthBits=t.depthBits,this.stencilBits=t.stencilBits,this.uboOffsetAlignment=t.uboOffsetAlignment,this.maxComputeSharedMemorySize=t.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=t.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(t.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(t.maxComputeWorkGroupCount),this.clipSpaceMinZ=t.clipSpaceMinZ,this.screenSpaceSignY=t.screenSpaceSignY,this.clipSpaceSignY=t.clipSpaceSignY,this}}class gr{constructor(t=0,e=0,i=0){this.x=t,this.y=e,this.z=i}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}}class yr{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.width=i,this.height=n}copy(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}}class vr{constructor(t=0,e=0,i=1){this.width=t,this.height=e,this.depth=i}copy(t){return this.width=t.width,this.height=t.height,this.depth=t.depth,this}}class xr{constructor(t=0,e=0,i=1){this.mipLevel=t,this.baseArrayLayer=e,this.layerCount=i}copy(t){return this.mipLevel=t.mipLevel,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class br{constructor(t=0,e=1,i=0,n=1){this.baseMipLevel=t,this.levelCount=e,this.baseArrayLayer=i,this.layerCount=n}copy(t){return this.baseMipLevel=t.baseMipLevel,this.levelCount=t.levelCount,this.baseArrayLayer=t.baseArrayLayer,this.layerCount=t.layerCount,this}}class Sr{constructor(t=new xr,e=new gr,i=new xr,n=new gr,s=new vr){this.srcSubres=t,this.srcOffset=e,this.dstSubres=i,this.dstOffset=n,this.extent=s}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.extent.copy(t.extent),this}}class Ar{constructor(t=new xr,e=new gr,i=new vr,n=new xr,s=new gr,r=new vr){this.srcSubres=t,this.srcOffset=e,this.srcExtent=i,this.dstSubres=n,this.dstOffset=s,this.dstExtent=r}copy(t){return this.srcSubres.copy(t.srcSubres),this.srcOffset.copy(t.srcOffset),this.srcExtent.copy(t.srcExtent),this.dstSubres.copy(t.dstSubres),this.dstOffset.copy(t.dstOffset),this.dstExtent.copy(t.dstExtent),this}}class Cr{constructor(t=0,e=0,i=new gr,n=new vr,s=new xr){this.buffStride=t,this.buffTexHeight=e,this.texOffset=i,this.texExtent=n,this.texSubres=s}copy(t){return this.buffStride=t.buffStride,this.buffTexHeight=t.buffTexHeight,this.texOffset.copy(t.texOffset),this.texExtent.copy(t.texExtent),this.texSubres.copy(t.texSubres),this}}class Tr{constructor(t=0,e=0,i=0,n=0,s=0,r=1){this.left=t,this.top=e,this.width=i,this.height=n,this.minDepth=s,this.maxDepth=r}copy(t){return this.left=t.left,this.top=t.top,this.width=t.width,this.height=t.height,this.minDepth=t.minDepth,this.maxDepth=t.maxDepth,this}}class wr{constructor(t=0,e=0,i=0,n=0){this.x=t,this.y=e,this.z=i,this.w=n}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this}}class Er{constructor(t=[],e=[],i=0){this.bufferOffsets=t,this.samplerOffsets=e,this.flexibleSet=i}copy(t){return this.bufferOffsets=t.bufferOffsets.slice(),this.samplerOffsets=t.samplerOffsets.slice(),this.flexibleSet=t.flexibleSet,this}}class Pr{constructor(t=Ls.NONE,e=Vs.NONE,i=0,n=0,s=Fs.NONE){this.usage=t,this.memUsage=e,this.size=i,this.stride=n,this.flags=s}copy(t){return this.usage=t.usage,this.memUsage=t.memUsage,this.size=t.size,this.stride=t.stride,this.flags=t.flags,this}}class Dr{constructor(t=null,e=0,i=0){this.buffer=t,this.offset=e,this.range=i}copy(t){return this.buffer=t.buffer,this.offset=t.offset,this.range=t.range,this}}class Ir{constructor(t=0,e=0,i=0,n=0,s=0,r=0,o=0){this.vertexCount=t,this.firstVertex=e,this.indexCount=i,this.firstIndex=n,this.vertexOffset=s,this.instanceCount=r,this.firstInstance=o}copy(t){return this.vertexCount=t.vertexCount,this.firstVertex=t.firstVertex,this.indexCount=t.indexCount,this.firstIndex=t.firstIndex,this.vertexOffset=t.vertexOffset,this.instanceCount=t.instanceCount,this.firstInstance=t.firstInstance,this}}class Rr{constructor(t=0,e=0,i=0,n=null,s=0){this.groupCountX=t,this.groupCountY=e,this.groupCountZ=i,this.indirectBuffer=n,this.indirectOffset=s}copy(t){return this.groupCountX=t.groupCountX,this.groupCountY=t.groupCountY,this.groupCountZ=t.groupCountZ,this.indirectBuffer=t.indirectBuffer,this.indirectOffset=t.indirectOffset,this}}class Mr{constructor(t=[]){this.drawInfos=t}copy(t){return Es(this.drawInfos,t.drawInfos,Ir),this}}class Or{constructor(t=Us.TEX2D,e=Gs.NONE,i=Os.UNKNOWN,n=0,s=0,r=ks.NONE,o=1,a=1,l=Hs.X1,c=1){this.type=t,this.usage=e,this.format=i,this.width=n,this.height=s,this.flags=r,this.layerCount=o,this.levelCount=a,this.samples=l,this.depth=c}copy(t){return this.type=t.type,this.usage=t.usage,this.format=t.format,this.width=t.width,this.height=t.height,this.flags=t.flags,this.layerCount=t.layerCount,this.levelCount=t.levelCount,this.samples=t.samples,this.depth=t.depth,this}}class Br{constructor(t=null,e=Us.TEX2D,i=Os.UNKNOWN,n=0,s=1,r=0,o=1){this.texture=t,this.type=e,this.format=i,this.baseLevel=n,this.levelCount=s,this.baseLayer=r,this.layerCount=o}copy(t){return this.texture=t.texture,this.type=t.type,this.format=t.format,this.baseLevel=t.baseLevel,this.levelCount=t.levelCount,this.baseLayer=t.baseLayer,this.layerCount=t.layerCount,this}}class Nr{constructor(t=js.LINEAR,e=js.LINEAR,i=js.NONE,n=Ws.WRAP,s=Ws.WRAP,r=Ws.WRAP,o=0,a=qs.ALWAYS,l=new wr,c=0){this.minFilter=t,this.magFilter=e,this.mipFilter=i,this.addressU=n,this.addressV=s,this.addressW=r,this.maxAnisotropy=o,this.cmpFunc=a,this.borderColor=l,this.mipLODBias=c}copy(t){return this.minFilter=t.minFilter,this.magFilter=t.magFilter,this.mipFilter=t.mipFilter,this.addressU=t.addressU,this.addressV=t.addressV,this.addressW=t.addressW,this.maxAnisotropy=t.maxAnisotropy,this.cmpFunc=t.cmpFunc,this.borderColor.copy(t.borderColor),this.mipLODBias=t.mipLODBias,this}}class Lr{constructor(t="",e=Ns.UNKNOWN,i=0){this.name=t,this.type=e,this.count=i}copy(t){return this.name=t.name,this.type=t.type,this.count=t.count,this}}class Fr{constructor(t=0,e=0,i="",n=[],s=0){this.set=t,this.binding=e,this.name=i,this.members=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,Es(this.members,t.members,Lr),this.count=t.count,this}}class zr{constructor(t=0,e=0,i="",n=Ns.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class Vr{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class Ur{constructor(t=0,e=0,i="",n=Ns.UNKNOWN,s=0){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this}}class Gr{constructor(t=0,e=0,i="",n=Ns.UNKNOWN,s=0,r=zs.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.type=n,this.count=s,this.memoryAccess=r}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.type=t.type,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class kr{constructor(t=0,e=0,i="",n=0,s=zs.READ_WRITE){this.set=t,this.binding=e,this.name=i,this.count=n,this.memoryAccess=s}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this.memoryAccess=t.memoryAccess,this}}class Hr{constructor(t=0,e=0,i="",n=0){this.set=t,this.binding=e,this.name=i,this.count=n}copy(t){return this.set=t.set,this.binding=t.binding,this.name=t.name,this.count=t.count,this}}class jr{constructor(t=Js.NONE,e=""){this.stage=t,this.source=e}copy(t){return this.stage=t.stage,this.source=t.source,this}}class Wr{constructor(t="",e=Os.UNKNOWN,i=!1,n=0,s=!1,r=0){this.name=t,this.format=e,this.isNormalized=i,this.stream=n,this.isInstanced=s,this.location=r}copy(t){return this.name=t.name,this.format=t.format,this.isNormalized=t.isNormalized,this.stream=t.stream,this.isInstanced=t.isInstanced,this.location=t.location,this}}class qr{constructor(t="",e=[],i=[],n=[],s=[],r=[],o=[],a=[],l=[],c=[]){this.name=t,this.stages=e,this.attributes=i,this.blocks=n,this.buffers=s,this.samplerTextures=r,this.samplers=o,this.textures=a,this.images=l,this.subpassInputs=c}copy(t){return this.name=t.name,Es(this.stages,t.stages,jr),Es(this.attributes,t.attributes,Wr),Es(this.blocks,t.blocks,Fr),Es(this.buffers,t.buffers,kr),Es(this.samplerTextures,t.samplerTextures,zr),Es(this.samplers,t.samplers,Vr),Es(this.textures,t.textures,Ur),Es(this.images,t.images,Gr),Es(this.subpassInputs,t.subpassInputs,Hr),this}}class Xr{constructor(t=[],e=[],i=null,n=null){this.attributes=t,this.vertexBuffers=e,this.indexBuffer=i,this.indirectBuffer=n}copy(t){return Es(this.attributes,t.attributes,Wr),this.vertexBuffers=t.vertexBuffers.slice(),this.indexBuffer=t.indexBuffer,this.indirectBuffer=t.indirectBuffer,this}}class Yr{constructor(t=Os.UNKNOWN,e=Hs.X1,i=Zs.CLEAR,n=Qs.STORE,s=[],r=[tr.PRESENT],o=!1){this.format=t,this.sampleCount=e,this.loadOp=i,this.storeOp=n,this.beginAccesses=s,this.endAccesses=r,this.isGeneralLayout=o}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.loadOp=t.loadOp,this.storeOp=t.storeOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this}}class Kr{constructor(t=Os.UNKNOWN,e=Hs.X1,i=Zs.CLEAR,n=Qs.STORE,s=Zs.CLEAR,r=Qs.STORE,o=[],a=[tr.DEPTH_STENCIL_ATTACHMENT_WRITE],l=!1){this.format=t,this.sampleCount=e,this.depthLoadOp=i,this.depthStoreOp=n,this.stencilLoadOp=s,this.stencilStoreOp=r,this.beginAccesses=o,this.endAccesses=a,this.isGeneralLayout=l}copy(t){return this.format=t.format,this.sampleCount=t.sampleCount,this.depthLoadOp=t.depthLoadOp,this.depthStoreOp=t.depthStoreOp,this.stencilLoadOp=t.stencilLoadOp,this.stencilStoreOp=t.stencilStoreOp,this.beginAccesses=t.beginAccesses.slice(),this.endAccesses=t.endAccesses.slice(),this.isGeneralLayout=t.isGeneralLayout,this}}class $r{constructor(t=[],e=[],i=[],n=[],s=-1,r=-1,o=er.NONE,a=er.NONE){this.inputs=t,this.colors=e,this.resolves=i,this.preserves=n,this.depthStencil=s,this.depthStencilResolve=r,this.depthResolveMode=o,this.stencilResolveMode=a}copy(t){return this.inputs=t.inputs.slice(),this.colors=t.colors.slice(),this.resolves=t.resolves.slice(),this.preserves=t.preserves.slice(),this.depthStencil=t.depthStencil,this.depthStencilResolve=t.depthStencilResolve,this.depthResolveMode=t.depthResolveMode,this.stencilResolveMode=t.stencilResolveMode,this}}class Jr{constructor(t=0,e=0,i=[],n=[]){this.srcSubpass=t,this.dstSubpass=e,this.srcAccesses=i,this.dstAccesses=n}copy(t){return this.srcSubpass=t.srcSubpass,this.dstSubpass=t.dstSubpass,this.srcAccesses=t.srcAccesses.slice(),this.dstAccesses=t.dstAccesses.slice(),this}}class Zr{constructor(t=[],e=new Kr,i=[],n=[]){this.colorAttachments=t,this.depthStencilAttachment=e,this.subpasses=i,this.dependencies=n}copy(t){return Es(this.colorAttachments,t.colorAttachments,Yr),this.depthStencilAttachment.copy(t.depthStencilAttachment),Es(this.subpasses,t.subpasses,$r),Es(this.dependencies,t.dependencies,Jr),this}}class Qr{constructor(t=[],e=[]){this.prevAccesses=t,this.nextAccesses=e}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this}}class to{constructor(t=[],e=[],i=!1,n=null,s=null){this.prevAccesses=t,this.nextAccesses=e,this.discardContents=i,this.srcQueue=n,this.dstQueue=s}copy(t){return this.prevAccesses=t.prevAccesses.slice(),this.nextAccesses=t.nextAccesses.slice(),this.discardContents=t.discardContents,this.srcQueue=t.srcQueue,this.dstQueue=t.dstQueue,this}}class eo{constructor(t=null,e=[],i=null){this.renderPass=t,this.colorTextures=e,this.depthStencilTexture=i}copy(t){return this.renderPass=t.renderPass,this.colorTextures=t.colorTextures.slice(),this.depthStencilTexture=t.depthStencilTexture,this}}class io{constructor(t=-1,e=hr.UNKNOWN,i=0,n=Js.NONE,s=[]){this.binding=t,this.descriptorType=e,this.count=i,this.stageFlags=n,this.immutableSamplers=s}copy(t){return this.binding=t.binding,this.descriptorType=t.descriptorType,this.count=t.count,this.stageFlags=t.stageFlags,this.immutableSamplers=t.immutableSamplers.slice(),this}}class no{constructor(t=[]){this.bindings=t}copy(t){return Es(this.bindings,t.bindings,io),this}}class so{constructor(t=null){this.layout=t}copy(t){return this.layout=t.layout,this}}class ro{constructor(t=[]){this.setLayouts=t}copy(t){return this.setLayouts=t.setLayouts.slice(),this}}class oo{constructor(t=[]){this.attributes=t}copy(t){return Es(this.attributes,t.attributes,Wr),this}}class ao{constructor(t=null,e=ur.PRIMARY){this.queue=t,this.type=e}copy(t){return this.queue=t.queue,this.type=t.type,this}}class lo{constructor(t=_r.GRAPHICS){this.type=t}copy(t){return this.type=t.type,this}}class co{constructor(t="",e=0,i=0,n=Bs.NONE,s=!1,r=!1,o=!1,a=!1){this.name=t,this.size=e,this.count=i,this.type=n,this.hasAlpha=s,this.hasDepth=r,this.hasStencil=o,this.isCompressed=a}}class ho{constructor(t=0,e=0){this.bufferSize=t,this.textureSize=e}copy(t){return this.bufferSize=t.bufferSize,this.textureSize=t.textureSize,this}}class _o{constructor(t=0,e=0,i=0){this.writeMask=t,this.compareMask=e,this.reference=i}copy(t){return this.writeMask=t.writeMask,this.compareMask=t.compareMask,this.reference=t.reference,this}}class uo{constructor(t=new Tr,e=new yr,i=new wr,n=1,s=0,r=0,o=0,a=0,l=0,c=new _o,h=new _o){this.viewport=t,this.scissor=e,this.blendConstant=i,this.lineWidth=n,this.depthBiasConstant=s,this.depthBiasClamp=r,this.depthBiasSlope=o,this.depthMinBounds=a,this.depthMaxBounds=l,this.stencilStatesFront=c,this.stencilStatesBack=h}copy(t){return this.viewport.copy(t.viewport),this.scissor.copy(t.scissor),this.blendConstant.copy(t.blendConstant),this.lineWidth=t.lineWidth,this.depthBiasConstant=t.depthBiasConstant,this.depthBiasClamp=t.depthBiasClamp,this.depthBiasSlope=t.depthBiasSlope,this.depthMinBounds=t.depthMinBounds,this.depthMaxBounds=t.depthMaxBounds,this.stencilStatesFront.copy(t.stencilStatesFront),this.stencilStatesBack.copy(t.stencilStatesBack),this}}class mo{get gfxType(){return this._gfxType}constructor(t){this._gfxType=Ps.UNKNOWN,this._gfxType=t}}class po{constructor(t,e=!0,i=!0,n=1,s=1,r=1,o=new Er){this.canvasElm=t,this.isAntialias=e,this.isPremultipliedAlpha=i,this.devicePixelRatio=n,this.width=s,this.height=r,this.bindingMappingInfo=o}}!function(t){t.ATTR_POSITION="a_position",t.ATTR_NORMAL="a_normal",t.ATTR_TANGENT="a_tangent",t.ATTR_BITANGENT="a_bitangent",t.ATTR_WEIGHTS="a_weights",t.ATTR_JOINTS="a_joints",t.ATTR_COLOR="a_color",t.ATTR_COLOR1="a_color1",t.ATTR_COLOR2="a_color2",t.ATTR_TEX_COORD="a_texCoord",t.ATTR_TEX_COORD1="a_texCoord1",t.ATTR_TEX_COORD2="a_texCoord2",t.ATTR_TEX_COORD3="a_texCoord3",t.ATTR_TEX_COORD4="a_texCoord4",t.ATTR_TEX_COORD5="a_texCoord5",t.ATTR_TEX_COORD6="a_texCoord6",t.ATTR_TEX_COORD7="a_texCoord7",t.ATTR_TEX_COORD8="a_texCoord8",t.ATTR_BATCH_ID="a_batch_id",t.ATTR_BATCH_UV="a_batch_uv"}(pr||(pr={}));const fo=Object.freeze([new co("UNKNOWN",0,0,Bs.NONE,!1,!1,!1,!1),new co("A8",1,1,Bs.UNORM,!0,!1,!1,!1),new co("L8",1,1,Bs.UNORM,!1,!1,!1,!1),new co("LA8",1,2,Bs.UNORM,!0,!1,!1,!1),new co("R8",1,1,Bs.UNORM,!1,!1,!1,!1),new co("R8SN",1,1,Bs.SNORM,!1,!1,!1,!1),new co("R8UI",1,1,Bs.UINT,!1,!1,!1,!1),new co("R8I",1,1,Bs.INT,!1,!1,!1,!1),new co("R16F",2,1,Bs.FLOAT,!1,!1,!1,!1),new co("R16UI",2,1,Bs.UINT,!1,!1,!1,!1),new co("R16I",2,1,Bs.INT,!1,!1,!1,!1),new co("R32F",4,1,Bs.FLOAT,!1,!1,!1,!1),new co("R32UI",4,1,Bs.UINT,!1,!1,!1,!1),new co("R32I",4,1,Bs.INT,!1,!1,!1,!1),new co("RG8",2,2,Bs.UNORM,!1,!1,!1,!1),new co("RG8SN",2,2,Bs.SNORM,!1,!1,!1,!1),new co("RG8UI",2,2,Bs.UINT,!1,!1,!1,!1),new co("RG8I",2,2,Bs.INT,!1,!1,!1,!1),new co("RG16F",4,2,Bs.FLOAT,!1,!1,!1,!1),new co("RG16UI",4,2,Bs.UINT,!1,!1,!1,!1),new co("RG16I",4,2,Bs.INT,!1,!1,!1,!1),new co("RG32F",8,2,Bs.FLOAT,!1,!1,!1,!1),new co("RG32UI",8,2,Bs.UINT,!1,!1,!1,!1),new co("RG32I",8,2,Bs.INT,!1,!1,!1,!1),new co("RGB8",3,3,Bs.UNORM,!1,!1,!1,!1),new co("SRGB8",3,3,Bs.UNORM,!1,!1,!1,!1),new co("RGB8SN",3,3,Bs.SNORM,!1,!1,!1,!1),new co("RGB8UI",3,3,Bs.UINT,!1,!1,!1,!1),new co("RGB8I",3,3,Bs.INT,!1,!1,!1,!1),new co("RGB16F",6,3,Bs.FLOAT,!1,!1,!1,!1),new co("RGB16UI",6,3,Bs.UINT,!1,!1,!1,!1),new co("RGB16I",6,3,Bs.INT,!1,!1,!1,!1),new co("RGB32F",12,3,Bs.FLOAT,!1,!1,!1,!1),new co("RGB32UI",12,3,Bs.UINT,!1,!1,!1,!1),new co("RGB32I",12,3,Bs.INT,!1,!1,!1,!1),new co("RGBA8",4,4,Bs.UNORM,!0,!1,!1,!1),new co("BGRA8",4,4,Bs.UNORM,!0,!1,!1,!1),new co("SRGB8_A8",4,4,Bs.UNORM,!0,!1,!1,!1),new co("RGBA8SN",4,4,Bs.SNORM,!0,!1,!1,!1),new co("RGBA8UI",4,4,Bs.UINT,!0,!1,!1,!1),new co("RGBA8I",4,4,Bs.INT,!0,!1,!1,!1),new co("RGBA16F",8,4,Bs.FLOAT,!0,!1,!1,!1),new co("RGBA16UI",8,4,Bs.UINT,!0,!1,!1,!1),new co("RGBA16I",8,4,Bs.INT,!0,!1,!1,!1),new co("RGBA32F",16,4,Bs.FLOAT,!0,!1,!1,!1),new co("RGBA32UI",16,4,Bs.UINT,!0,!1,!1,!1),new co("RGBA32I",16,4,Bs.INT,!0,!1,!1,!1),new co("R5G6B5",2,3,Bs.UNORM,!1,!1,!1,!1),new co("R11G11B10F",4,3,Bs.FLOAT,!1,!1,!1,!1),new co("RGB5A1",2,4,Bs.UNORM,!0,!1,!1,!1),new co("RGBA4",2,4,Bs.UNORM,!0,!1,!1,!1),new co("RGB10A2",2,4,Bs.UNORM,!0,!1,!1,!1),new co("RGB10A2UI",2,4,Bs.UINT,!0,!1,!1,!1),new co("RGB9E5",2,4,Bs.FLOAT,!0,!1,!1,!1),new co("D16",2,1,Bs.UINT,!1,!0,!1,!1),new co("D16S8",3,2,Bs.UINT,!1,!0,!0,!1),new co("D24",3,1,Bs.UINT,!1,!0,!1,!1),new co("D24S8",4,2,Bs.UINT,!1,!0,!0,!1),new co("D32F",4,1,Bs.FLOAT,!1,!0,!1,!1),new co("D32FS8",5,2,Bs.FLOAT,!1,!0,!0,!1),new co("BC1",1,3,Bs.UNORM,!1,!1,!1,!0),new co("BC1_ALPHA",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC1_SRGB",1,3,Bs.UNORM,!1,!1,!1,!0),new co("BC1_SRGB_ALPHA",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC2",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC2_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC3",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC3_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC4",1,1,Bs.UNORM,!1,!1,!1,!0),new co("BC4_SNORM",1,1,Bs.SNORM,!1,!1,!1,!0),new co("BC5",1,2,Bs.UNORM,!1,!1,!1,!0),new co("BC5_SNORM",1,2,Bs.SNORM,!1,!1,!1,!0),new co("BC6H_UF16",1,3,Bs.UFLOAT,!1,!1,!1,!0),new co("BC6H_SF16",1,3,Bs.FLOAT,!1,!1,!1,!0),new co("BC7",1,4,Bs.UNORM,!0,!1,!1,!0),new co("BC7_SRGB",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ETC_RGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new co("ETC2_RGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new co("ETC2_SRGB8",1,3,Bs.UNORM,!1,!1,!1,!0),new co("ETC2_RGB8_A1",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ETC2_SRGB8_A1",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ETC2_RGBA8",2,4,Bs.UNORM,!0,!1,!1,!0),new co("ETC2_SRGB8_A8",2,4,Bs.UNORM,!0,!1,!1,!0),new co("EAC_R11",1,1,Bs.UNORM,!1,!1,!1,!0),new co("EAC_R11SN",1,1,Bs.SNORM,!1,!1,!1,!0),new co("EAC_RG11",2,2,Bs.UNORM,!1,!1,!1,!0),new co("EAC_RG11SN",2,2,Bs.SNORM,!1,!1,!1,!0),new co("PVRTC_RGB2",2,3,Bs.UNORM,!1,!1,!1,!0),new co("PVRTC_RGBA2",2,4,Bs.UNORM,!0,!1,!1,!0),new co("PVRTC_RGB4",2,3,Bs.UNORM,!1,!1,!1,!0),new co("PVRTC_RGBA4",2,4,Bs.UNORM,!0,!1,!1,!0),new co("PVRTC2_2BPP",2,4,Bs.UNORM,!0,!1,!1,!0),new co("PVRTC2_4BPP",2,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_4x4",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_5x4",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_5x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_6x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_6x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_8x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_8x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_8x8",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_10x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_10x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_10x8",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_10x10",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_12x10",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_RGBA_12x12",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_4x4",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_5x4",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_5x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_6x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_6x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_8x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_8x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_8x8",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_10x5",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_10x6",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_10x8",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_10x10",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_12x10",1,4,Bs.UNORM,!0,!1,!1,!0),new co("ASTC_SRGBA_12x12",1,4,Bs.UNORM,!0,!1,!1,!0)]),go=hr.UNIFORM_BUFFER|hr.DYNAMIC_UNIFORM_BUFFER|hr.STORAGE_BUFFER|hr.DYNAMIC_STORAGE_BUFFER,yo=hr.SAMPLER_TEXTURE|hr.SAMPLER|hr.TEXTURE|hr.STORAGE_IMAGE|hr.INPUT_ATTACHMENT,vo=hr.DYNAMIC_STORAGE_BUFFER|hr.DYNAMIC_UNIFORM_BUFFER;function xo(t){return t>0&&0==(t&t-1)}function bo(t,e,i,n){if(!fo[t].isCompressed)return e*i*n*fo[t].size;switch(t){case Os.BC1:case Os.BC1_ALPHA:case Os.BC1_SRGB:case Os.BC1_SRGB_ALPHA:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case Os.BC2:case Os.BC2_SRGB:case Os.BC3:case Os.BC3_SRGB:case Os.BC4:case Os.BC4_SNORM:case Os.BC6H_SF16:case Os.BC6H_UF16:case Os.BC7:case Os.BC7_SRGB:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Os.BC5:case Os.BC5_SNORM:return Math.ceil(e/4)*Math.ceil(i/4)*32*n;case Os.ETC_RGB8:case Os.ETC2_RGB8:case Os.ETC2_SRGB8:case Os.ETC2_RGB8_A1:case Os.EAC_R11:case Os.EAC_R11SN:return Math.ceil(e/4)*Math.ceil(i/4)*8*n;case Os.ETC2_RGBA8:case Os.ETC2_SRGB8_A1:case Os.EAC_RG11:case Os.EAC_RG11SN:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Os.PVRTC_RGB2:case Os.PVRTC_RGBA2:case Os.PVRTC2_2BPP:return Math.ceil(Math.max(e,16)*Math.max(i,8)/4)*n;case Os.PVRTC_RGB4:case Os.PVRTC_RGBA4:case Os.PVRTC2_4BPP:return Math.ceil(Math.max(e,8)*Math.max(i,8)/2)*n;case Os.ASTC_RGBA_4X4:case Os.ASTC_SRGBA_4X4:return Math.ceil(e/4)*Math.ceil(i/4)*16*n;case Os.ASTC_RGBA_5X4:case Os.ASTC_SRGBA_5X4:return Math.ceil(e/5)*Math.ceil(i/4)*16*n;case Os.ASTC_RGBA_5X5:case Os.ASTC_SRGBA_5X5:return Math.ceil(e/5)*Math.ceil(i/5)*16*n;case Os.ASTC_RGBA_6X5:case Os.ASTC_SRGBA_6X5:return Math.ceil(e/6)*Math.ceil(i/5)*16*n;case Os.ASTC_RGBA_6X6:case Os.ASTC_SRGBA_6X6:return Math.ceil(e/6)*Math.ceil(i/6)*16*n;case Os.ASTC_RGBA_8X5:case Os.ASTC_SRGBA_8X5:return Math.ceil(e/8)*Math.ceil(i/5)*16*n;case Os.ASTC_RGBA_8X6:case Os.ASTC_SRGBA_8X6:return Math.ceil(e/8)*Math.ceil(i/6)*16*n;case Os.ASTC_RGBA_8X8:case Os.ASTC_SRGBA_8X8:return Math.ceil(e/8)*Math.ceil(i/8)*16*n;case Os.ASTC_RGBA_10X5:case Os.ASTC_SRGBA_10X5:return Math.ceil(e/10)*Math.ceil(i/5)*16*n;case Os.ASTC_RGBA_10X6:case Os.ASTC_SRGBA_10X6:return Math.ceil(e/10)*Math.ceil(i/6)*16*n;case Os.ASTC_RGBA_10X8:case Os.ASTC_SRGBA_10X8:return Math.ceil(e/10)*Math.ceil(i/8)*16*n;case Os.ASTC_RGBA_10X10:case Os.ASTC_SRGBA_10X10:return Math.ceil(e/10)*Math.ceil(i/10)*16*n;case Os.ASTC_RGBA_12X10:case Os.ASTC_SRGBA_12X10:return Math.ceil(e/12)*Math.ceil(i/10)*16*n;case Os.ASTC_RGBA_12X12:case Os.ASTC_SRGBA_12X12:return Math.ceil(e/12)*Math.ceil(i/12)*16*n;default:return 0}}function So(t,e,i,n,s){let r=0;for(let o=0;o<s;++o)r+=bo(t,e,i,n),e=Math.max(e>>1,1),i=Math.max(i>>1,1);return r}const Ao=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function Co(t){return Ao[t]||0}function To(t){const e=t.size/t.count;switch(t.type){case Bs.UNORM:case Bs.UINT:switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case Bs.SNORM:case Bs.INT:switch(e){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case Bs.FLOAT:return Float32Array}return Float32Array}var wo=Object.freeze({__proto__:null,get ObjectType(){return Ps},get Status(){return Ds},get API(){return Is},get SurfaceTransform(){return Rs},get Feature(){return Ms},get Format(){return Os},get FormatType(){return Bs},get Type(){return Ns},get BufferUsageBit(){return Ls},get BufferFlagBit(){return Fs},get MemoryAccessBit(){return zs},get MemoryUsageBit(){return Vs},get TextureType(){return Us},get TextureUsageBit(){return Gs},get TextureFlagBit(){return ks},get SampleCount(){return Hs},get Filter(){return js},get Address(){return Ws},get ComparisonFunc(){return qs},get StencilOp(){return Xs},get BlendFactor(){return Ys},get BlendOp(){return Ks},get ColorMask(){return $s},get ShaderStageFlagBit(){return Js},get LoadOp(){return Zs},get StoreOp(){return Qs},get AccessType(){return tr},get ResolveMode(){return er},get PipelineBindPoint(){return ir},get PrimitiveMode(){return sr},get PolygonMode(){return rr},get ShadeModel(){return or},get CullMode(){return ar},get DynamicStateFlagBit(){return lr},get StencilFace(){return cr},get DescriptorType(){return hr},get QueueType(){return _r},get CommandBufferType(){return ur},get ClearFlagBit(){return mr},Size:dr,DeviceCaps:fr,Offset:gr,Rect:yr,Extent:vr,TextureSubresLayers:xr,TextureSubresRange:br,TextureCopy:Sr,TextureBlit:Ar,BufferTextureCopy:Cr,Viewport:Tr,Color:wr,BindingMappingInfo:Er,BufferInfo:Pr,BufferViewInfo:Dr,DrawInfo:Ir,DispatchInfo:Rr,IndirectBuffer:Mr,TextureInfo:Or,TextureViewInfo:Br,SamplerInfo:Nr,Uniform:Lr,UniformBlock:Fr,UniformSamplerTexture:zr,UniformSampler:Vr,UniformTexture:Ur,UniformStorageImage:Gr,UniformStorageBuffer:kr,UniformInputAttachment:Hr,ShaderStage:jr,Attribute:Wr,ShaderInfo:qr,InputAssemblerInfo:Xr,ColorAttachment:Yr,DepthStencilAttachment:Kr,SubpassInfo:$r,SubpassDependency:Jr,RenderPassInfo:Zr,GlobalBarrierInfo:Qr,TextureBarrierInfo:to,FramebufferInfo:eo,DescriptorSetLayoutBinding:io,DescriptorSetLayoutInfo:no,DescriptorSetInfo:so,PipelineLayoutInfo:ro,InputState:oo,CommandBufferInfo:ao,QueueInfo:lo,FormatInfo:co,MemoryStatus:ho,DynamicStencilStates:_o,DynamicStates:uo,Obj:mo,DeviceInfo:po,get AttributeName(){return pr},FormatInfos:fo,DESCRIPTOR_BUFFER_TYPE:go,DESCRIPTOR_SAMPLER_TYPE:yo,DESCRIPTOR_DYNAMIC_TYPE:vo,DRAW_INFO_SIZE:28,IsPowerOf2:xo,FormatSize:bo,FormatSurfaceSize:So,GetTypeSize:Co,getTypedArrayConstructor:To});class Eo{constructor(t=!1,e=rr.FILL,i=or.GOURAND,n=ar.BACK,s=!0,r=!1,o=0,a=0,l=0,c=!0,h=!1,_=1){this._nativeObj=void 0,this._isDiscard=!1,this._polygonMode=rr.FILL,this._shadeModel=or.GOURAND,this._cullMode=ar.BACK,this._isFrontFaceCCW=!0,this._depthBiasEnabled=!1,this._depthBias=0,this._depthBiasClamp=0,this._depthBiasSlop=0,this._isDepthClip=!0,this._isMultisample=!1,this._lineWidth=1,this._nativeObj=new gfx.RasterizerState,this.assignProperties(t,e,i,n,s,r,o,a,l,c,h,_)}get native(){return this._nativeObj}get isDiscard(){return this._isDiscard}set isDiscard(t){this._isDiscard=t,this._nativeObj.isDiscard=t}get polygonMode(){return this._polygonMode}set polygonMode(t){this._polygonMode=t,this._nativeObj.polygonMode=t}get shadeModel(){return this._shadeModel}set shadeModel(t){this._shadeModel=t,this._nativeObj.shadeModel=t}get cullMode(){return this._cullMode}set cullMode(t){this._cullMode=t,this._nativeObj.cullMode=t}get isFrontFaceCCW(){return this._isFrontFaceCCW}set isFrontFaceCCW(t){this._isFrontFaceCCW=t,this._nativeObj.isFrontFaceCCW=t}get depthBiasEnabled(){return this._depthBiasEnabled}set depthBiasEnabled(t){this._depthBiasEnabled=t,this._nativeObj.depthBiasEnabled=t}get depthBias(){return this._depthBias}set depthBias(t){this._depthBias=t,this._nativeObj.depthBias=t}get depthBiasClamp(){return this._depthBiasClamp}set depthBiasClamp(t){this._depthBiasClamp=t,this._nativeObj.depthBiasClamp=t}get depthBiasSlop(){return this._depthBiasSlop}set depthBiasSlop(t){this._depthBiasSlop=t,this._nativeObj.depthBiasSlop=t}get isDepthClip(){return this._isDepthClip}set isDepthClip(t){this._isDepthClip=t,this._nativeObj.isDepthClip=t}get isMultisample(){return this._isMultisample}set isMultisample(t){this._isMultisample=t,this._nativeObj.isMultisample=t}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this._nativeObj.lineWidth=t}reset(){this.assignProperties(!1,rr.FILL,or.GOURAND,ar.BACK,!0,!1,0,0,0,!0,!1,1)}assign(t){t&&this.assignProperties(t.isDiscard,t.polygonMode,t.shadeModel,t.cullMode,t.isFrontFaceCCW,t.depthBiasEnabled,t.depthBias,t.depthBiasClamp,t.depthBiasSlop,t.isDepthClip,t.isMultisample,t.lineWidth)}destroy(){this._nativeObj=null}assignProperties(t,e,i,n,s,r,o,a,l,c,h,_){void 0!==t&&(this.isDiscard=t),void 0!==e&&(this.polygonMode=e),void 0!==i&&(this.shadeModel=i),void 0!==n&&(this.cullMode=n),void 0!==s&&(this.isFrontFaceCCW=s),void 0!==r&&(this.depthBiasEnabled=r),void 0!==o&&(this.depthBias=o),void 0!==a&&(this.depthBiasClamp=a),void 0!==l&&(this.depthBiasSlop=l),void 0!==c&&(this.isDepthClip=c),void 0!==h&&(this.isMultisample=h),void 0!==_&&(this.lineWidth=_)}}class Po{constructor(t=!0,e=!0,i=qs.LESS,n=!1,s=qs.ALWAYS,r=65535,o=65535,a=Xs.KEEP,l=Xs.KEEP,c=Xs.KEEP,h=1,_=!1,u=qs.ALWAYS,m=65535,p=65535,d=Xs.KEEP,f=Xs.KEEP,g=Xs.KEEP,y=1){this._nativeObj=void 0,this._depthTest=!0,this._depthWrite=!0,this._depthFunc=qs.LESS,this._stencilTestFront=!1,this._stencilFuncFront=qs.ALWAYS,this._stencilReadMaskFront=65535,this._stencilWriteMaskFront=65535,this._stencilFailOpFront=Xs.KEEP,this._stencilZFailOpFront=Xs.KEEP,this._stencilPassOpFront=Xs.KEEP,this._stencilRefFront=1,this._stencilTestBack=!1,this._stencilFuncBack=qs.ALWAYS,this._stencilReadMaskBack=65535,this._stencilWriteMaskBack=65535,this._stencilFailOpBack=Xs.KEEP,this._stencilZFailOpBack=Xs.KEEP,this._stencilPassOpBack=Xs.KEEP,this._stencilRefBack=1,this._nativeObj=new gfx.DepthStencilState,this.assignProperties(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d,f,g,y)}get native(){return this._nativeObj}get depthTest(){return this._depthTest}set depthTest(t){this._depthTest=t,this._nativeObj.depthTest=t}get depthWrite(){return this._depthWrite}set depthWrite(t){this._depthWrite=t,this._nativeObj.depthWrite=t}get depthFunc(){return this._depthFunc}set depthFunc(t){this._depthFunc=t,this._nativeObj.depthFunc=t}get stencilTestFront(){return this._stencilTestFront}set stencilTestFront(t){this._stencilTestFront=t,this._nativeObj.stencilTestFront=t}get stencilFuncFront(){return this._stencilFuncFront}set stencilFuncFront(t){this._stencilFuncFront=t,this._nativeObj.stencilFuncFront=t}get stencilReadMaskFront(){return this._stencilReadMaskFront}set stencilReadMaskFront(t){this._stencilReadMaskFront=t,this._nativeObj.stencilReadMaskFront=t}get stencilWriteMaskFront(){return this._stencilWriteMaskFront}set stencilWriteMaskFront(t){this._stencilWriteMaskFront=t,this._nativeObj.stencilWriteMaskFront=t}get stencilFailOpFront(){return this._stencilFailOpFront}set stencilFailOpFront(t){this._stencilFailOpFront=t,this._nativeObj.stencilFailOpFront=t}get stencilZFailOpFront(){return this._stencilZFailOpFront}set stencilZFailOpFront(t){this._stencilZFailOpFront=t,this._nativeObj.stencilZFailOpFront=t}get stencilPassOpFront(){return this._stencilPassOpFront}set stencilPassOpFront(t){this._stencilPassOpFront=t,this._nativeObj.stencilPassOpFront=t}get stencilRefFront(){return this._stencilRefFront}set stencilRefFront(t){this._stencilRefFront=t,this._nativeObj.stencilRefFront=t}get stencilTestBack(){return this._stencilTestBack}set stencilTestBack(t){this._stencilTestBack=t,this._nativeObj.stencilTestBack=t}get stencilFuncBack(){return this._stencilFuncBack}set stencilFuncBack(t){this._stencilFuncBack=t,this._nativeObj.stencilFuncBack=t}get stencilReadMaskBack(){return this._stencilReadMaskBack}set stencilReadMaskBack(t){this._stencilReadMaskBack=t,this._nativeObj.stencilReadMaskBack=t}get stencilWriteMaskBack(){return this._stencilWriteMaskBack}set stencilWriteMaskBack(t){this._stencilWriteMaskBack=t,this._nativeObj.stencilWriteMaskBack=t}get stencilFailOpBack(){return this._stencilFailOpBack}set stencilFailOpBack(t){this._stencilFailOpBack=t,this._nativeObj.stencilFailOpBack=t}get stencilZFailOpBack(){return this._stencilZFailOpBack}set stencilZFailOpBack(t){this._stencilZFailOpBack=t,this._nativeObj.stencilZFailOpBack=t}get stencilPassOpBack(){return this._stencilPassOpBack}set stencilPassOpBack(t){this._stencilPassOpBack=t,this._nativeObj.stencilPassOpBack=t}get stencilRefBack(){return this._stencilRefBack}set stencilRefBack(t){this._stencilRefBack=t,this._nativeObj.stencilRefBack=t}reset(){this.assignProperties(!0,!0,qs.LESS,!1,qs.ALWAYS,65535,65535,Xs.KEEP,Xs.KEEP,Xs.KEEP,1,!1,qs.ALWAYS,65535,65535,Xs.KEEP,Xs.KEEP,Xs.KEEP,1)}assign(t){t&&this.assignProperties(t.depthTest,t.depthWrite,t.depthFunc,t.stencilTestFront,t.stencilFuncFront,t.stencilReadMaskFront,t.stencilWriteMaskFront,t.stencilFailOpFront,t.stencilZFailOpFront,t.stencilPassOpFront,t.stencilRefFront,t.stencilTestBack,t.stencilFuncBack,t.stencilReadMaskBack,t.stencilWriteMaskBack,t.stencilFailOpBack,t.stencilZFailOpBack,t.stencilPassOpBack,t.stencilRefBack)}destroy(){this._nativeObj=null}assignProperties(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d,f,g,y){void 0!==t&&(this.depthTest=t),void 0!==e&&(this.depthWrite=e),void 0!==i&&(this.depthFunc=i),void 0!==n&&(this.stencilTestFront=n),void 0!==s&&(this.stencilFuncFront=s),void 0!==r&&(this.stencilReadMaskFront=r),void 0!==o&&(this.stencilWriteMaskFront=o),void 0!==a&&(this.stencilFailOpFront=a),void 0!==l&&(this.stencilZFailOpFront=l),void 0!==c&&(this.stencilPassOpFront=c),void 0!==h&&(this.stencilRefFront=h),void 0!==_&&(this.stencilTestBack=_),void 0!==u&&(this.stencilFuncBack=u),void 0!==m&&(this.stencilReadMaskBack=m),void 0!==p&&(this.stencilWriteMaskBack=p),void 0!==d&&(this.stencilFailOpBack=d),void 0!==f&&(this.stencilZFailOpBack=f),void 0!==g&&(this.stencilPassOpBack=g),void 0!==y&&(this.stencilRefBack=y)}}class Do{get native(){return this._nativeObj}constructor(t=!1,e=Ys.ONE,i=Ys.ZERO,n=Ks.ADD,s=Ys.ONE,r=Ys.ZERO,o=Ks.ADD,a=$s.ALL){this._nativeObj=void 0,this._blend=!1,this._blendSrc=Ys.ONE,this._blendDst=Ys.ZERO,this._blendEq=Ks.ADD,this._blendSrcAlpha=Ys.ONE,this._blendDstAlpha=Ys.ZERO,this._blendAlphaEq=Ks.ADD,this._blendColorMask=$s.ALL,this._nativeObj=new gfx.BlendTarget,this.assignProperties(t,e,i,n,s,r,o,a)}get blend(){return this._blend}set blend(t){this._blend=t,this._nativeObj.blend=t}get blendSrc(){return this._blendSrc}set blendSrc(t){this._blendSrc=t,this._nativeObj.blendSrc=t}get blendDst(){return this._blendDst}set blendDst(t){this._blendDst=t,this._nativeObj.blendDst=t}get blendEq(){return this._blendEq}set blendEq(t){this._blendEq=t,this._nativeObj.blendEq=t}get blendSrcAlpha(){return this._blendSrcAlpha}set blendSrcAlpha(t){this._blendSrcAlpha=t,this._nativeObj.blendSrcAlpha=t}get blendDstAlpha(){return this._blendDstAlpha}set blendDstAlpha(t){this._blendDstAlpha=t,this._nativeObj.blendDstAlpha=t}get blendAlphaEq(){return this._blendAlphaEq}set blendAlphaEq(t){this._blendAlphaEq=t,this._nativeObj.blendAlphaEq=t}get blendColorMask(){return this._blendColorMask}set blendColorMask(t){this._blendColorMask=t,this._nativeObj.blendColorMask=t}reset(){this.assignProperties(!1,Ys.ONE,Ys.ZERO,Ks.ADD,Ys.ONE,Ys.ZERO,Ks.ADD,$s.ALL)}destroy(){this._nativeObj=null}assign(t){t&&this.assignProperties(t.blend,t.blendSrc,t.blendDst,t.blendEq,t.blendSrcAlpha,t.blendDstAlpha,t.blendAlphaEq,t.blendColorMask)}assignProperties(t,e,i,n,s,r,o,a){void 0!==t&&(this.blend=t),void 0!==e&&(this.blendSrc=e),void 0!==i&&(this.blendDst=i),void 0!==n&&(this.blendEq=n),void 0!==s&&(this.blendSrcAlpha=s),void 0!==r&&(this.blendDstAlpha=r),void 0!==o&&(this.blendAlphaEq=o),void 0!==a&&(this.blendColorMask=a)}}class Io{_setTargets(t){this.targets=t;const e="$__nativeObj";this._syncTargetsToNativeObj(e),function(t,e,i,n,s){for(let r=0,o=e.length;r<o;r++){let o=e[r],a=o[i].$__nativeObj||o[i];o[i]=new Proxy(a,{get:(t,e)=>e===n?t:Reflect.get(t,e),set:(e,i,n)=>(Reflect.set(e,i,n),s(t),!0)})}}(this,this.targets,"_nativeObj",e,(t=>{t._syncTargetsToNativeObj(e)}))}_syncTargetsToNativeObj(t){const e=this.targets.map((e=>e.native[t]||e.native));this._nativeObj.targets=e}get native(){return this._nativeObj}constructor(t=!1,e=!1,i=new wr,n=[new Do]){this.targets=void 0,this._blendColor=void 0,this._nativeObj=void 0,this._isA2C=!1,this._isIndepend=!1,this._nativeObj=new gfx.BlendState,this._setTargets(n),this.blendColor=i,this.isA2c=t,this.isIndepend=e}get isA2c(){return this._isA2C}set isA2c(t){this._isA2C=t,this._nativeObj.isA2C=t}get isIndepend(){return this._isIndepend}set isIndepend(t){this._isIndepend=t,this._nativeObj.isIndepend=t}get blendColor(){return this._blendColor}set blendColor(t){this._blendColor=t,this._nativeObj.blendColor=t}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new Do),i.assign(e),this._setTargets(this.targets)}reset(){this.isA2c=!1,this.isIndepend=!1,this.blendColor=new wr(0,0,0,0);const t=this.targets;for(let e=1,i=t.length;e<i;++e)t[e].destroy();t.length=1,t[0].reset(),this._setTargets(t)}destroy(){for(let t=0,e=this.targets.length;t<e;++t)this.targets[t].destroy();this.targets=null,this._nativeObj=null}}const Ro=gfx.PipelineState,Mo=gfx.PipelineStateInfo;class Oo extends mo{get layout(){return this._layout}constructor(t){super(Ps.DESCRIPTOR_SET),this._device=void 0,this._layout=null,this._buffers=[],this._textures=[],this._samplers=[],this._isDirty=!1,this._device=t}bindBuffer(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&go){const n=this._layout.descriptorIndices[t];this._buffers[n+i]!==e&&(this._buffers[n+i]=e,this._isDirty=!0)}}bindSampler(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&yo){const n=this._layout.descriptorIndices[t];this._samplers[n+i]!==e&&(this._samplers[n+i]=e,this._isDirty=!0)}}bindTexture(t,e,i=0){const n=this._layout.bindingIndices[t],s=this._layout.bindings[n];if(s&&s.descriptorType&yo){const n=this._layout.descriptorIndices[t];this._textures[n+i]!==e&&(this._textures[n+i]=e,this._isDirty=!0)}}getBuffer(t,e=0){const i=this._layout.descriptorIndices[t];return this._buffers[i+e]}getSampler(t,e=0){const i=this._layout.descriptorIndices[t];return this._samplers[i+e]}getTexture(t,e=0){const i=this._layout.descriptorIndices[t];return this._textures[i+e]}}class Bo extends mo{get usage(){return this._usage}get memUsage(){return this._memUsage}get size(){return this._size}get stride(){return this._stride}get count(){return this._count}get flags(){return this._flags}constructor(t){super(Ps.BUFFER),this._device=void 0,this._usage=Ls.NONE,this._memUsage=Vs.NONE,this._size=0,this._stride=1,this._count=0,this._flags=Fs.NONE,this._indirectBuffer=null,this._isBufferView=!1,this._device=t}}class No extends mo{get type(){return this._type}get queue(){return this._queue}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}constructor(t){super(Ps.COMMAND_BUFFER),this._device=void 0,this._queue=null,this._type=ur.PRIMARY,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._device=t}}zt(Os);class Lo{constructor(){this._canvas=null,this._canvas2D=null,this._gfxAPI=Is.UNKNOWN,this._transform=Rs.IDENTITY,this._deviceName="",this._renderer="",this._vendor="",this._version="",this._features=new Array(Ms.COUNT),this._queue=null,this._cmdBuff=null,this._devicePixelRatio=1,this._width=0,this._height=0,this._colorFmt=Os.UNKNOWN,this._depthStencilFmt=Os.UNKNOWN,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new ho,this._caps=new fr}get canvas(){return this._canvas}get canvas2D(){return this._canvas2D}get gfxAPI(){return this._gfxAPI}get queue(){return this._queue}get commandBuffer(){return this._cmdBuff}get devicePixelRatio(){return this._devicePixelRatio}get width(){return this._width}get height(){return this._height}get renderer(){return this._renderer}get vendor(){return this._vendor}get colorFormat(){return this._colorFmt}get depthStencilFormat(){return this._depthStencilFmt}get numDrawCalls(){return this._numDrawCalls}get numInstances(){return this._numInstances}get numTris(){return this._numTris}get memoryStatus(){return this._memoryStatus}get capabilities(){return this._caps}get surfaceTransform(){return this._transform}hasFeature(t){return this._features[t]}}class Fo extends mo{get renderPass(){return this._renderPass}get colorTextures(){return this._colorTextures}get depthStencilTexture(){return this._depthStencilTexture}constructor(t){super(Ps.FRAMEBUFFER),this._device=void 0,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._device=t}}const zo=String.prototype.charCodeAt;function Vo(t){return this[t]}function Uo(t,e){let i=t.length,n=e^i,s=0;const r="string"==typeof t?zo:Vo;for(;i>=4;){let e=255&r.call(t,s)|(255&r.call(t,++s))<<8|(255&r.call(t,++s))<<16|(255&r.call(t,++s))<<24;e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),e^=e>>>24,e=1540483477*(65535&e)+((1540483477*(e>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^e,i-=4,++s}switch(i){case 3:n^=(255&r.call(t,s+2))<<16;case 2:n^=(255&r.call(t,s+1))<<8;case 1:n^=255&r.call(t,s),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)}return n^=n>>>13,n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16),n^=n>>>15,n>>>0}class Go extends mo{get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get attributes(){return this._attributes}get attributesHash(){return this._attributesHash}get vertexCount(){return this._vertexCount}set vertexCount(t){this._vertexCount=t}get firstVertex(){return this._firstVertex}set firstVertex(t){this._firstVertex=t}get indexCount(){return this._indexCount}set indexCount(t){this._indexCount=t}get firstIndex(){return this._firstIndex}set firstIndex(t){this._firstIndex=t}get vertexOffset(){return this._vertexOffset}set vertexOffset(t){this._vertexOffset=t}get instanceCount(){return this._instanceCount}set instanceCount(t){this._instanceCount=t}get firstInstance(){return this._firstInstance}set firstInstance(t){this._firstInstance=t}get indirectBuffer(){return this._indirectBuffer}constructor(t){super(Ps.INPUT_ASSEMBLER),this._device=void 0,this._attributes=[],this._vertexBuffers=[],this._indexBuffer=null,this._vertexCount=0,this._firstVertex=0,this._indexCount=0,this._firstIndex=0,this._vertexOffset=0,this._instanceCount=0,this._firstInstance=0,this._attributesHash=0,this._indirectBuffer=null,this._device=t}getVertexBuffer(t=0){return t<this._vertexBuffers.length?this._vertexBuffers[t]:null}computeAttributesHash(){let t="attrs";for(let e=0;e<this.attributes.length;++e){const i=this.attributes[e];t+=`,${i.name},${i.format},${i.isNormalized},${i.stream},${i.isInstanced}`}return Uo(t,666)}}class ko extends mo{get bindings(){return this._bindings}get bindingIndices(){return this._bindingIndices}get descriptorIndices(){return this._descriptorIndices}constructor(t){super(Ps.DESCRIPTOR_SET_LAYOUT),this._device=void 0,this._bindings=[],this._bindingIndices=[],this._descriptorIndices=[],this._device=t}}class Ho extends mo{get setLayouts(){return this._setLayouts}constructor(t){super(Ps.PIPELINE_LAYOUT),this._device=void 0,this._setLayouts=[],this._device=t}}class jo extends mo{get type(){return this._type}constructor(t){super(Ps.QUEUE),this._device=void 0,this._type=_r.GRAPHICS,this._isAsync=!1,this._device=t}isAsync(){return this._isAsync}}class Wo extends mo{get colorAttachments(){return this._colorInfos}get depthStencilAttachment(){return this._depthStencilInfo}get subPasses(){return this._subpasses}get hash(){return this._hash}constructor(t){super(Ps.RENDER_PASS),this._device=void 0,this._colorInfos=[],this._depthStencilInfo=null,this._subpasses=[],this._hash=0,this._device=t}computeHash(){let t="";if(this._subpasses.length)for(let e=0;e<this._subpasses.length;++e){const i=this._subpasses[e];if(i.inputs.length){t+="ia";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.colors.length){t+="ca";for(let e=0;e<i.inputs.length;++e){const n=this._colorInfos[i.inputs[e]];t+=`,${n.format},${n.sampleCount}`}}if(i.depthStencil>=0){const e=this._colorInfos[i.depthStencil];t+=`ds,${e.format},${e.sampleCount}`}}else{t+="ca";for(let e=0;e<this._colorInfos.length;++e){const i=this._colorInfos[e];t+=`,${i.format},${i.sampleCount}`}const e=this._depthStencilInfo;e&&(t+=`ds,${e.format},${e.sampleCount}`)}return Uo(t,666)}}class qo extends mo{get minFilter(){return this._minFilter}get magFilter(){return this._magFilter}get mipFilter(){return this._mipFilter}get addressU(){return this._addressU}get addressV(){return this._addressV}get addressW(){return this._addressW}get maxAnisotropy(){return this._maxAnisotropy}get cmpFunc(){return this._cmpFunc}get borderColor(){return this._borderColor}get mipLODBias(){return this._mipLODBias}constructor(t){super(Ps.SAMPLER),this._device=void 0,this._minFilter=js.LINEAR,this._magFilter=js.LINEAR,this._mipFilter=js.NONE,this._addressU=Ws.WRAP,this._addressV=Ws.WRAP,this._addressW=Ws.WRAP,this._maxAnisotropy=16,this._cmpFunc=qs.NEVER,this._borderColor=new wr,this._mipLODBias=0,this._device=t}}class Xo extends mo{get id(){return this._id}get name(){return this._name}get attributes(){return this._attributes}get blocks(){return this._blocks}get samplers(){return this._samplers}constructor(t){super(Ps.SHADER),this._device=void 0,this._id=void 0,this._name="",this._stages=[],this._attributes=[],this._blocks=[],this._samplers=[],this._device=t,this._id=Xo._shaderIdGen++}}Xo._shaderIdGen=0;class Yo extends mo{get type(){return this._type}get usage(){return this._usage}get format(){return this._format}get width(){return this._width}get height(){return this._height}get depth(){return this._depth}get layerCount(){return this._layerCount}get levelCount(){return this._levelCount}get samples(){return this._samples}get flags(){return this._flags}get size(){return this._size}constructor(t){super(Ps.TEXTURE),this._device=void 0,this._type=Us.TEX2D,this._usage=Gs.NONE,this._format=Os.UNKNOWN,this._width=0,this._height=0,this._depth=1,this._layerCount=1,this._levelCount=1,this._samples=Hs.X1,this._flags=ks.NONE,this._isPowerOf2=!1,this._size=0,this._device=t}}class Ko extends mo{constructor(t){super(Ps.GLOBAL_BARRIER),this._device=void 0,this._info=new Qr,this._device=t}initialize(t){return this._info.copy(t),!0}}class $o extends mo{constructor(t){super(Ps.TEXTURE_BARRIER),this._device=void 0,this._info=new to,this._device=t}initialize(t){return this._info.copy(t),!0}}const Jo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(const t in n.gfx){if("__esModule"===t)continue;let e=Jo[t];""===e?e=t:void 0===e&&(e=`GFX${t}`),Ze(n,"cc",[{name:e,newName:t,target:n.gfx,targetName:"cc.gfx"}])}const Zo=Object.assign({},wo);Zo.Device=gfx.Device,Zo.Buffer=gfx.Buffer,Zo.Texture=gfx.Texture,Zo.Sampler=gfx.Sampler,Zo.Shader=gfx.Shader,Zo.InputAssembler=gfx.InputAssembler,Zo.RenderPass=gfx.RenderPass,Zo.Framebuffer=gfx.Framebuffer,Zo.DescriptorSet=gfx.DescriptorSet,Zo.DescriptorSetLayout=gfx.DescriptorSetLayout,Zo.PipelineLayout=gfx.PipelineLayout,Zo.PipelineState=gfx.PipelineState,Zo.CommandBuffer=gfx.CommandBuffer,Zo.Queue=gfx.Queue,n.gfx=Zo;const Qo=Do,ta=Io,ea=Eo,ia=Po,na=Ro,sa=Mo;let ra;Zo.BlendTarget=Do,Zo.BlendState=Io,Zo.RasterizerState=Eo,Zo.DepthStencilState=Po,Zo.PipelineStateInfo=Mo,t("gfx",Object.freeze({__proto__:null,DescriptorSet:Oo,Buffer:Bo,CommandBuffer:No,get ObjectType(){return Ps},get Status(){return Ds},get API(){return Is},get SurfaceTransform(){return Rs},get Feature(){return Ms},get Format(){return Os},get FormatType(){return Bs},get Type(){return Ns},get BufferUsageBit(){return Ls},get BufferFlagBit(){return Fs},get MemoryAccessBit(){return zs},get MemoryUsageBit(){return Vs},get TextureType(){return Us},get TextureUsageBit(){return Gs},get TextureFlagBit(){return ks},get SampleCount(){return Hs},get Filter(){return js},get Address(){return Ws},get ComparisonFunc(){return qs},get StencilOp(){return Xs},get BlendFactor(){return Ys},get BlendOp(){return Ks},get ColorMask(){return $s},get ShaderStageFlagBit(){return Js},get LoadOp(){return Zs},get StoreOp(){return Qs},get AccessType(){return tr},get ResolveMode(){return er},get PipelineBindPoint(){return ir},get PrimitiveMode(){return sr},get PolygonMode(){return rr},get ShadeModel(){return or},get CullMode(){return ar},get DynamicStateFlagBit(){return lr},get StencilFace(){return cr},get DescriptorType(){return hr},get QueueType(){return _r},get CommandBufferType(){return ur},get ClearFlagBit(){return mr},Size:dr,DeviceCaps:fr,Offset:gr,Rect:yr,Extent:vr,TextureSubresLayers:xr,TextureSubresRange:br,TextureCopy:Sr,TextureBlit:Ar,BufferTextureCopy:Cr,Viewport:Tr,Color:wr,BindingMappingInfo:Er,BufferInfo:Pr,BufferViewInfo:Dr,DrawInfo:Ir,DispatchInfo:Rr,IndirectBuffer:Mr,TextureInfo:Or,TextureViewInfo:Br,SamplerInfo:Nr,Uniform:Lr,UniformBlock:Fr,UniformSamplerTexture:zr,UniformSampler:Vr,UniformTexture:Ur,UniformStorageImage:Gr,UniformStorageBuffer:kr,UniformInputAttachment:Hr,ShaderStage:jr,Attribute:Wr,ShaderInfo:qr,InputAssemblerInfo:Xr,ColorAttachment:Yr,DepthStencilAttachment:Kr,SubpassInfo:$r,SubpassDependency:Jr,RenderPassInfo:Zr,GlobalBarrierInfo:Qr,TextureBarrierInfo:to,FramebufferInfo:eo,DescriptorSetLayoutBinding:io,DescriptorSetLayoutInfo:no,DescriptorSetInfo:so,PipelineLayoutInfo:ro,InputState:oo,CommandBufferInfo:ao,QueueInfo:lo,FormatInfo:co,MemoryStatus:ho,DynamicStencilStates:_o,DynamicStates:uo,Obj:mo,DeviceInfo:po,get AttributeName(){return pr},FormatInfos:fo,DESCRIPTOR_BUFFER_TYPE:go,DESCRIPTOR_SAMPLER_TYPE:yo,DESCRIPTOR_DYNAMIC_TYPE:vo,DRAW_INFO_SIZE:28,IsPowerOf2:xo,FormatSize:bo,FormatSurfaceSize:So,GetTypeSize:Co,getTypedArrayConstructor:To,Device:Lo,Framebuffer:Fo,InputAssembler:Go,DescriptorSetLayout:ko,PipelineLayout:Ho,Queue:jo,RenderPass:Wo,Sampler:qo,Shader:Xo,Texture:Yo,GlobalBarrier:Ko,TextureBarrier:$o,BlendTarget:Qo,BlendState:ta,RasterizerState:ea,DepthStencilState:ia,PipelineState:na,PipelineStateInfo:sa})),function(t){t[t.ALL=0]="ALL",t[t.CLOSEST=1]="CLOSEST",t[t.ANY=2]="ANY"}(ra||(ra={}));const oa=function(){const t=new Ni(0,0,0);return function(e,i){const n=Ni.dot(e.d,i.n);if(Math.abs(n)<Number.EPSILON)return 0;Ni.multiplyScalar(t,i.n,i.d);const s=Ni.dot(Ni.subtract(t,t,e.o),i.n)/n;return s<0?0:s}}(),aa=function(){const t=new Ni(0,0,0),e=new Ni(0,0,0),i=new Ni(0,0,0),n=new Ni(0,0,0),s=new Ni(0,0,0);return function(r,o,a){Ni.subtract(t,o.b,o.a),Ni.subtract(e,o.c,o.a),Ni.cross(i,r.d,e);const l=Ni.dot(t,i);if(l<Number.EPSILON&&(!a||l>-Number.EPSILON))return 0;const c=1/l;Ni.subtract(n,r.o,o.a);const h=Ni.dot(n,i)*c;if(h<0||h>1)return 0;Ni.cross(s,n,t);const _=Ni.dot(r.d,s)*c;if(_<0||h+_>1)return 0;const u=Ni.dot(e,s)*c;return u<0?0:u}}(),la=function(){const t=new Ni(0,0,0);return function(e,i){const n=i.radius,s=i.center,r=e.o,o=e.d,a=n*n;Ni.subtract(t,s,r);const l=t.lengthSqr(),c=Ni.dot(t,o),h=a-(l-c*c);if(h<0)return 0;const _=Math.sqrt(h),u=l<a?c+_:c-_;return u<0?0:u}}(),ca=function(){const t=new Ni,e=new Ni;return function(i,n){return Ni.subtract(t,n.center,n.halfExtents),Ni.add(e,n.center,n.halfExtents),ha(i,t,e)}}();function ha(t,e,i){const n=t.o,s=t.d,r=1/s.x,o=1/s.y,a=1/s.z,l=(e.x-n.x)*r,c=(i.x-n.x)*r,h=(e.y-n.y)*o,_=(i.y-n.y)*o,u=(e.z-n.z)*a,m=(i.z-n.z)*a,p=Math.max(Math.max(Math.min(l,c),Math.min(h,_)),Math.min(u,m)),d=Math.min(Math.min(Math.max(l,c),Math.max(h,_)),Math.max(u,m));return d<0||p>d?0:p>0?p:d}const _a=function(){let t=new Ni,e=new Ni,i=new Ni;const n=new Ni,s=new Ni,r=new Ni,o=new Ni,a=new Array(3),l=new Array(3),c=new Array(3),h=new Array(6);return function(_,u){a[0]=u.halfExtents.x,a[1]=u.halfExtents.y,a[2]=u.halfExtents.z,t=u.center,e=_.o,i=_.d,Ni.set(n,u.orientation.m00,u.orientation.m01,u.orientation.m02),Ni.set(s,u.orientation.m03,u.orientation.m04,u.orientation.m05),Ni.set(r,u.orientation.m06,u.orientation.m07,u.orientation.m08),Ni.subtract(o,t,e),l[0]=Ni.dot(n,i),l[1]=Ni.dot(s,i),l[2]=Ni.dot(r,i),c[0]=Ni.dot(n,o),c[1]=Ni.dot(s,o),c[2]=Ni.dot(r,o);for(let t=0;t<3;++t){if(0===l[t]){if(-c[t]-a[t]>0||-c[t]+a[t]<0)return 0;l[t]=1e-7}h[2*t+0]=(c[t]+a[t])/l[t],h[2*t+1]=(c[t]-a[t])/l[t]}const m=Math.max(Math.max(Math.min(h[0],h[1]),Math.min(h[2],h[3])),Math.min(h[4],h[5])),p=Math.min(Math.min(Math.max(h[0],h[1]),Math.max(h[2],h[3])),Math.max(h[4],h[5]));return p<0||m>p?0:m>0?m:p}}(),ua=function(){const t=new Ni,e=new Ni,i=new Ni,n=new Ni,s=new Ni,r=new Ni,o=new Ni,a=new Ts;return function(l,c){const h=c.radius*c.radius,_=Ni.normalize(t,l.d),u=c.ellipseCenter0,m=c.ellipseCenter1,p=Ni.subtract(e,m,u);if(p.equals(Ni.ZERO))return a.radius=c.radius,a.center.set(c.ellipseCenter0),Ha.raySphere(l,a);const d=l.o,f=Ni.subtract(i,d,u),g=Ni.cross(n,_,p),y=g.lengthSqr();if(0===y){a.radius=c.radius;const t=Ni.subtract(s,m,d);return f.lengthSqr()<t.lengthSqr()?a.center.set(c.ellipseCenter0):a.center.set(c.ellipseCenter1),Ha.raySphere(l,a)}const v=Ni.cross(s,f,p),x=p.lengthSqr(),b=2*Ni.dot(g,v),S=b*b-4*y*(v.lengthSqr()-h*x);if(S<0)return 0;const A=(-b-Math.sqrt(S))/(2*y);if(A<0){a.radius=c.radius;const t=Ni.subtract(r,m,d);return f.lengthSqr()<t.lengthSqr()?a.center.set(c.ellipseCenter0):a.center.set(c.ellipseCenter1),Ha.raySphere(l,a)}{const t=Ni.scaleAndAdd(r,l.o,_,A),e=Ni.subtract(o,t,u),i=Ni.dot(e,p)/x;return i>=0&&i<=1?A:i<0?(a.radius=c.radius,a.center.set(c.ellipseCenter0),Ha.raySphere(l,a)):i>1?(a.radius=c.radius,a.center.set(c.ellipseCenter1),Ha.raySphere(l,a)):0}}}(),ma=function(){const t=ws.create(),e={distance:1/0,doubleSided:!1,mode:ra.ANY};let i=0;const n=(t,e,n,s,r,o)=>{t===ra.CLOSEST?(i>e||0===i)&&(i=e,o&&(0===o.length?o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}):(o[0].distance=e,o[0].vertexIndex0=n/3,o[0].vertexIndex1=s/3,o[0].vertexIndex2=r/3))):(i=e,o&&o.push({distance:e,vertexIndex0:n/3,vertexIndex1:s/3,vertexIndex2:r/3}))};return function(s,r,o){if(i=0,0===r.geometricInfo.positions.length)return i;const a=void 0===o?e:o;if(ha(s,r.geometricInfo.boundingBox.min,r.geometricInfo.boundingBox.max)){const e=r.primitiveMode,{positions:i,indices:o}=r.geometricInfo;((e,i,s,r,o)=>{if(s===sr.TRIANGLE_LIST){const s=i.length;for(let a=0;a<s;a+=3){const s=3*i[a],l=3*i[a+1],c=3*i[a+2];Ni.set(t.a,e[s],e[s+1],e[s+2]),Ni.set(t.b,e[l],e[l+1],e[l+2]),Ni.set(t.c,e[c],e[c+1],e[c+2]);const h=Ha.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,s,l,c,o.result),o.mode===ra.ANY))return h}}else if(s===sr.TRIANGLE_STRIP){const s=i.length-2;let a=0;for(let l=0;l<s;l+=1){const s=3*i[l-a],c=3*i[l+a+1],h=3*i[l+2];Ni.set(t.a,e[s],e[s+1],e[s+2]),Ni.set(t.b,e[c],e[c+1],e[c+2]),Ni.set(t.c,e[h],e[h+1],e[h+2]),a=~a;const _=Ha.rayTriangle(r,t,o.doubleSided);if(!(0===_||_>o.distance)&&(n(o.mode,_,s,c,h,o.result),o.mode===ra.ANY))return _}}else if(s===sr.TRIANGLE_FAN){const s=i.length-1,a=3*i[0];Ni.set(t.a,e[a],e[a+1],e[a+2]);for(let l=1;l<s;l+=1){const s=3*i[l],c=3*i[l+1];Ni.set(t.b,e[s],e[s+1],e[s+2]),Ni.set(t.c,e[c],e[c+1],e[c+2]);const h=Ha.rayTriangle(r,t,o.doubleSided);if(!(0===h||h>o.distance)&&(n(o.mode,h,a,s,c,o.result),o.mode===ra.ANY))return h}}})(i,o,e,s,a)}return i}}(),pa=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ra.ANY};return function(i,n,s){t=0;const r=void 0===s?e:s,o=n.renderingSubMeshes.length,a=n.struct.minPosition,l=n.struct.maxPosition;if(a&&l&&!ha(i,a,l))return t;for(let e=0;e<o;e++){const s=n.renderingSubMeshes[e],o=ma(i,s,r);if(o)if(r.mode===ra.CLOSEST)(0===t||t>o)&&(t=o,r.subIndices&&(r.subIndices[0]=e));else if(t=o,r.subIndices&&r.subIndices.push(e),r.mode===ra.ANY)return o}return t&&r.mode===ra.CLOSEST&&(r.result&&(r.result[0].distance=t,r.result.length=1),r.subIndices&&(r.subIndices.length=1)),t}}(),da=function(){let t=0;const e={distance:1/0,doubleSided:!1,mode:ra.ANY},i=new vs,n=new $i;return function(s,r,o){t=0;const a=void 0===o?e:o,l=r.worldBounds;if(l&&!ca(s,l))return t;vs.copy(i,s),r.node&&($i.invert(n,r.node.getWorldMatrix(n)),Ni.transformMat4(i.o,s.o,n),Ni.transformMat4Normal(i.d,s.d,n));const c=r.subModels;for(let e=0;e<c.length;e++){const n=c[e].subMesh,s=ma(i,n,a);if(s)if(a.mode===ra.CLOSEST)(0===t||t>s)&&(t=s,a.subIndices&&(a.subIndices[0]=e));else if(t=s,a.subIndices&&a.subIndices.push(e),a.mode===ra.ANY)return s}return t&&a.mode===ra.CLOSEST&&(a.result&&(a.result[0].distance=t,a.result.length=1),a.subIndices&&(a.subIndices.length=1)),t}}(),fa=function(){const t=new Ni(0,0,0);return function(e,i){Ni.subtract(t,e.e,e.s);const n=(i.d-Ni.dot(e.s,i.n))/Ni.dot(t,i.n);return n<0||n>1?0:n}}(),ga=function(){const t=new Ni(0,0,0),e=new Ni(0,0,0),i=new Ni(0,0,0),n=new Ni(0,0,0),s=new Ni(0,0,0),r=new Ni(0,0,0);return function(o,a,l){Ni.subtract(t,a.b,a.a),Ni.subtract(e,a.c,a.a),Ni.subtract(i,o.s,o.e),Ni.cross(s,t,e);const c=Ni.dot(i,s);if(c<=0)return 0;Ni.subtract(n,o.s,a.a);const h=Ni.dot(n,s);if(h<0||h>c)return 0;Ni.cross(r,i,n);let _=Ni.dot(e,r);if(_<0||_>c)return 0;let u=-Ni.dot(t,r);if(u<0||_+u>c)return 0;if(l){const t=1/c;_*=t,u*=t;const e=1-_-u;Ni.set(l,a.a.x*e+a.b.x*_+a.c.x*u,a.a.y*e+a.b.y*_+a.c.y*u,a.a.z*e+a.b.z*_+a.c.z*u)}return 1}}(),ya=new vs;function va(t,e){ya.o.set(t.s),Ni.subtract(ya.d,t.e,t.s),ya.d.normalize();const i=ca(ya,e);return i<=t.length()?i:0}function xa(t,e){ya.o.set(t.s),Ni.subtract(ya.d,t.e,t.s),ya.d.normalize();const i=_a(ya,e);return i<=t.length()?i:0}function ba(t,e){ya.o.set(t.s),Ni.subtract(ya.d,t.e,t.s),ya.d.normalize();const i=la(ya,e);return i<=t.length()?i:0}const Sa=function(){const t=new Ni,e=new Ni,i=new Ni,n=new Ni;return function(s,r){return Ni.subtract(t,s.center,s.halfExtents),Ni.add(e,s.center,s.halfExtents),Ni.subtract(i,r.center,r.halfExtents),Ni.add(n,r.center,r.halfExtents),t.x<=n.x&&e.x>=i.x&&t.y<=n.y&&e.y>=i.y&&t.z<=n.z&&e.z>=i.z}}();function Aa(t,e,i,n,s,r){Ni.set(r[0],t.x+i.x*e.x+n.x*e.y+s.x*e.z,t.y+i.y*e.x+n.y*e.y+s.y*e.z,t.z+i.z*e.x+n.z*e.y+s.z*e.z),Ni.set(r[1],t.x-i.x*e.x+n.x*e.y+s.x*e.z,t.y-i.y*e.x+n.y*e.y+s.y*e.z,t.z-i.z*e.x+n.z*e.y+s.z*e.z),Ni.set(r[2],t.x+i.x*e.x-n.x*e.y+s.x*e.z,t.y+i.y*e.x-n.y*e.y+s.y*e.z,t.z+i.z*e.x-n.z*e.y+s.z*e.z),Ni.set(r[3],t.x+i.x*e.x+n.x*e.y-s.x*e.z,t.y+i.y*e.x+n.y*e.y-s.y*e.z,t.z+i.z*e.x+n.z*e.y-s.z*e.z),Ni.set(r[4],t.x-i.x*e.x-n.x*e.y-s.x*e.z,t.y-i.y*e.x-n.y*e.y-s.y*e.z,t.z-i.z*e.x-n.z*e.y-s.z*e.z),Ni.set(r[5],t.x+i.x*e.x-n.x*e.y-s.x*e.z,t.y+i.y*e.x-n.y*e.y-s.y*e.z,t.z+i.z*e.x-n.z*e.y-s.z*e.z),Ni.set(r[6],t.x-i.x*e.x+n.x*e.y-s.x*e.z,t.y-i.y*e.x+n.y*e.y-s.y*e.z,t.z-i.z*e.x+n.z*e.y-s.z*e.z),Ni.set(r[7],t.x-i.x*e.x-n.x*e.y+s.x*e.z,t.y-i.y*e.x-n.y*e.y+s.y*e.z,t.z-i.z*e.x-n.z*e.y+s.z*e.z)}function Ca(t,e){let i=Ni.dot(e,t[0]),n=i;for(let s=1;s<8;++s){const r=Ni.dot(e,t[s]);i=r<i?r:i,n=r>n?r:n}return[i,n]}const Ta=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new Ni(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new Ni(0,0,0),i[t]=new Ni(0,0,0);const n=new Ni,s=new Ni;return function(r,o){Ni.set(t[0],1,0,0),Ni.set(t[1],0,1,0),Ni.set(t[2],0,0,1),Ni.set(t[3],o.orientation.m00,o.orientation.m01,o.orientation.m02),Ni.set(t[4],o.orientation.m03,o.orientation.m04,o.orientation.m05),Ni.set(t[5],o.orientation.m06,o.orientation.m07,o.orientation.m08);for(let e=0;e<3;++e)Ni.cross(t[6+3*e],t[e],t[0]),Ni.cross(t[7+3*e],t[e],t[1]),Ni.cross(t[7+3*e],t[e],t[2]);Ni.subtract(n,r.center,r.halfExtents),Ni.add(s,r.center,r.halfExtents),function(t,e,i){Ni.set(i[0],t.x,e.y,e.z),Ni.set(i[1],t.x,e.y,t.z),Ni.set(i[2],t.x,t.y,e.z),Ni.set(i[3],t.x,t.y,t.z),Ni.set(i[4],e.x,e.y,e.z),Ni.set(i[5],e.x,e.y,t.z),Ni.set(i[6],e.x,t.y,e.z),Ni.set(i[7],e.x,t.y,t.z)}(n,s,e),Aa(o.center,o.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=Ca(e,t[n]),r=Ca(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),wa=function(t,e){const i=t.halfExtents.x*Math.abs(e.n.x)+t.halfExtents.y*Math.abs(e.n.y)+t.halfExtents.z*Math.abs(e.n.z),n=Ni.dot(e.n,t.center);return n+i<e.d?-1:n-i>e.d?0:1},Ea=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===wa(t,e.planes[i]))return 0;return 1},Pa=function(){const t=new Array(8);let e=0,i=0;for(let e=0;e<t.length;e++)t[e]=new Ni(0,0,0);return function(n,s){let r=0,o=!1;for(let t=0;t<s.planes.length;t++){if(r=wa(n,s.planes[t]),-1===r)return 0;1===r&&(o=!0)}if(!o)return 1;for(let e=0;e<s.vertices.length;e++)Ni.subtract(t[e],s.vertices[e],n.center);e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].x>n.halfExtents.x?e++:t[r].x<-n.halfExtents.x&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].y>n.halfExtents.y?e++:t[r].y<-n.halfExtents.y&&i++;if(e===s.vertices.length||i===s.vertices.length)return 0;e=0,i=0;for(let r=0;r<s.vertices.length;r++)t[r].z>n.halfExtents.z?e++:t[r].z<-n.halfExtents.z&&i++;return e===s.vertices.length||i===s.vertices.length?0:1}}(),Da=function(){const t=new Ni(0,0,0),e=new Vi;return function(i,n){return Ni.subtract(t,n,i.center),Ni.transformMat3(t,t,Vi.transpose(e,i.orientation)),s=t,r=i.halfExtents,Math.abs(s.x)<r.x&&Math.abs(s.y)<r.y&&Math.abs(s.z)<r.z;var s,r}}(),Ia=function(){const t=function(t,e,i,n){return Math.abs(t.x*e+t.y*i+t.z*n)};return function(e,i){const n=e.halfExtents.x*t(i.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*t(i.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*t(i.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),s=Ni.dot(i.n,e.center);return s+n<i.d?-1:s-n>i.d?0:1}}(),Ra=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Ia(t,e.planes[i]))return 0;return 1},Ma=function(){const t=new Array(8);let e=0,i=0,n=0;for(let e=0;e<t.length;e++)t[e]=new Ni(0,0,0);const s=function(t,e,i,n){return t.x*e+t.y*i+t.z*n};return function(r,o){let a=0,l=!1;for(let t=0;t<o.planes.length;t++){if(a=Ia(r,o.planes[t]),-1===a)return 0;1===a&&(l=!0)}if(!l)return 1;for(let e=0;e<o.vertices.length;e++)Ni.subtract(t[e],o.vertices[e],r.center);i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m00,r.orientation.m01,r.orientation.m02),e>r.halfExtents.x?i++:e<-r.halfExtents.x&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m03,r.orientation.m04,r.orientation.m05),e>r.halfExtents.y?i++:e<-r.halfExtents.y&&n++;if(i===o.vertices.length||n===o.vertices.length)return 0;i=0,n=0;for(let a=0;a<o.vertices.length;a++)e=s(t[a],r.orientation.m06,r.orientation.m07,r.orientation.m08),e>r.halfExtents.z?i++:e<-r.halfExtents.z&&n++;return i===o.vertices.length||n===o.vertices.length?0:1}}(),Oa=function(){const t=new Array(15);for(let e=0;e<15;e++)t[e]=new Ni(0,0,0);const e=new Array(8),i=new Array(8);for(let t=0;t<8;t++)e[t]=new Ni(0,0,0),i[t]=new Ni(0,0,0);return function(n,s){Ni.set(t[0],n.orientation.m00,n.orientation.m01,n.orientation.m02),Ni.set(t[1],n.orientation.m03,n.orientation.m04,n.orientation.m05),Ni.set(t[2],n.orientation.m06,n.orientation.m07,n.orientation.m08),Ni.set(t[3],s.orientation.m00,s.orientation.m01,s.orientation.m02),Ni.set(t[4],s.orientation.m03,s.orientation.m04,s.orientation.m05),Ni.set(t[5],s.orientation.m06,s.orientation.m07,s.orientation.m08);for(let e=0;e<3;++e)Ni.cross(t[6+3*e],t[e],t[3]),Ni.cross(t[7+3*e],t[e],t[4]),Ni.cross(t[8+3*e],t[e],t[5]);Aa(n.center,n.halfExtents,t[0],t[1],t[2],e),Aa(s.center,s.halfExtents,t[3],t[4],t[5],i);for(let n=0;n<15;++n){const s=Ca(e,t[n]),r=Ca(i,t[n]);if(r[0]>s[1]||s[0]>r[1])return 0}return 1}}(),Ba=function(){const t=new Ts,e=new Ni,i=new Ni,n=new Ni,s=new Array(8);for(let t=0;t<8;t++)s[t]=new Ni;const r=new Array(8);for(let t=0;t<8;t++)r[t]=new Ni;return function(o,a){if(0===Ni.squaredDistance(a.ellipseCenter0,a.ellipseCenter1))return t.radius=a.radius,t.center.set(a.ellipseCenter0),Ha.sphereOBB(t,o);{e.x=o.orientation.m00,e.y=o.orientation.m01,e.z=o.orientation.m02,i.x=o.orientation.m03,i.y=o.orientation.m04,i.z=o.orientation.m05,n.x=o.orientation.m06,n.y=o.orientation.m07,n.z=o.orientation.m08,Aa(o.center,o.halfExtents,e,i,n,s);const t=r,l=Ni.copy(t[0],e),c=Ni.copy(t[1],i),h=Ni.copy(t[2],n);Ni.subtract(t[3],a.center,o.center).normalize();const _=Ni.subtract(t[4],a.ellipseCenter0,a.ellipseCenter1);_.normalize(),Ni.cross(t[5],l,_),Ni.cross(t[6],c,_),Ni.cross(t[7],h,_);for(let e=0;e<8;++e){const i=Ca(s,t[e]),n=Ni.dot(t[e],a.ellipseCenter0),r=Ni.dot(t[e],a.ellipseCenter1),o=Math.max(n,r),l=Math.min(n,r)-a.radius,c=o+a.radius;if(l>i[1]||i[0]>c)return 0}return 1}}}(),Na=function(t,e){const i=Ni.dot(e.n,t.center),n=t.radius*e.n.length();return i+n<e.d?-1:i-n>e.d?0:1},La=function(t,e){for(let i=0;i<e.planes.length;i++)if(-1===Na(t,e.planes[i]))return 0;return 1},Fa=function(){const t=new Ni(0,0,0),e=[1,-1,1,-1,1,-1];return function(i,n){for(let s=0;s<6;s++){const r=n.planes[s],o=i.radius,a=i.center,l=r.n,c=r.d,h=Ni.dot(l,a);if(h+o<c)return 0;if(!(h-o>c)){Ni.add(t,a,Ni.multiplyScalar(t,l,o));for(let i=0;i<6;i++){if(i===s||i===s+e[s])continue;const r=n.planes[i];if(Ni.dot(r.n,t)<r.d)return 0}}}return 1}}(),za=function(t,e){const i=t.radius+e.radius;return Ni.squaredDistance(t.center,e.center)<i*i},Va=function(){const t=new Ni;return function(e,i){return ps(t,e.center,i),Ni.squaredDistance(e.center,t)<e.radius*e.radius}}(),Ua=function(){const t=new Ni;return function(e,i){return ds(t,e.center,i),Ni.squaredDistance(e.center,t)<e.radius*e.radius}}(),Ga=function(){const t=new Ni,e=new Ni;return function(i,n){const s=i.radius+n.radius,r=s*s,o=Ni.squaredDistance(n.ellipseCenter0,n.ellipseCenter1);if(0===o)return Ni.squaredDistance(i.center,n.center)<r;{Ni.subtract(t,i.center,n.ellipseCenter0),Ni.subtract(e,n.ellipseCenter1,n.ellipseCenter0);const s=Ni.dot(t,e)/o;return s<0?Ni.squaredDistance(i.center,n.ellipseCenter0)<r:s>1?Ni.squaredDistance(i.center,n.ellipseCenter1)<r:(Ni.scaleAndAdd(t,n.ellipseCenter0,e,s),Ni.squaredDistance(i.center,t)<r)}}}(),ka=function(){const t=new Ni,e=new Ni,i=new Ni,n=new Ni,s=new Ni,r=new Ni;return function(o,a){const l=Ni.subtract(t,o.ellipseCenter1,o.ellipseCenter0),c=Ni.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=Ni.subtract(i,o.ellipseCenter0,a.ellipseCenter0),_=Ni.dot(l,l),u=Ni.dot(l,c),m=Ni.dot(c,c),p=Ni.dot(l,h),d=Ni.dot(c,h),f=_*m-u*u;let g,y,v=f,x=f;f<ci?(g=0,v=1,y=d,x=m):(g=u*d-m*p,y=_*d-u*p,g<0?(g=0,y=d,x=m):g>v&&(g=v,y=d+u,x=m)),y<0?(y=0,-p<0?g=0:-p>_?g=v:(g=-p,v=_)):y>x&&(y=x,-p+u<0?g=0:-p+u>_?g=v:(g=-p+u,v=_));const b=Math.abs(g)<ci?0:g/v,S=Math.abs(y)<ci?0:y/x,A=n;A.set(h),A.add(Ni.multiplyScalar(s,l,b)),A.subtract(Ni.multiplyScalar(r,c,S));const C=o.radius+a.radius;return A.lengthSqr()<C*C}}(),Ha={raySphere:la,rayAABB:ca,rayOBB:_a,rayPlane:oa,rayTriangle:aa,rayCapsule:ua,raySubMesh:ma,rayMesh:pa,rayModel:da,lineSphere:ba,lineAABB:va,lineOBB:xa,linePlane:fa,lineTriangle:ga,sphereWithSphere:za,sphereAABB:Va,sphereOBB:Ua,spherePlane:Na,sphereFrustum:La,sphereFrustumAccurate:Fa,sphereCapsule:Ga,aabbWithAABB:Sa,aabbWithOBB:Ta,aabbPlane:wa,aabbFrustum:Ea,aabbFrustumAccurate:Pa,obbWithOBB:Oa,obbPlane:Ia,obbFrustum:Ra,obbFrustumAccurate:Ma,obbPoint:Da,obbCapsule:Ba,capsuleWithCapsule:ka,resolve(t,e,i=null){const n=t._type,s=e._type,r=this[n|s];return n<s?r(t,e,i):r(e,t,i)}};Ha[gs.SHAPE_RAY|gs.SHAPE_SPHERE]=la,Ha[gs.SHAPE_RAY|gs.SHAPE_AABB]=ca,Ha[gs.SHAPE_RAY|gs.SHAPE_OBB]=_a,Ha[gs.SHAPE_RAY|gs.SHAPE_PLANE]=oa,Ha[gs.SHAPE_RAY|gs.SHAPE_TRIANGLE]=aa,Ha[gs.SHAPE_RAY|gs.SHAPE_CAPSULE]=ua,Ha[gs.SHAPE_LINE|gs.SHAPE_SPHERE]=ba,Ha[gs.SHAPE_LINE|gs.SHAPE_AABB]=va,Ha[gs.SHAPE_LINE|gs.SHAPE_OBB]=xa,Ha[gs.SHAPE_LINE|gs.SHAPE_PLANE]=fa,Ha[gs.SHAPE_LINE|gs.SHAPE_TRIANGLE]=ga,Ha[gs.SHAPE_SPHERE]=za,Ha[gs.SHAPE_SPHERE|gs.SHAPE_AABB]=Va,Ha[gs.SHAPE_SPHERE|gs.SHAPE_OBB]=Ua,Ha[gs.SHAPE_SPHERE|gs.SHAPE_PLANE]=Na,Ha[gs.SHAPE_SPHERE|gs.SHAPE_FRUSTUM]=La,Ha[gs.SHAPE_SPHERE|gs.SHAPE_FRUSTUM_ACCURATE]=Fa,Ha[gs.SHAPE_SPHERE|gs.SHAPE_CAPSULE]=Ga,Ha[gs.SHAPE_AABB]=Sa,Ha[gs.SHAPE_AABB|gs.SHAPE_OBB]=Ta,Ha[gs.SHAPE_AABB|gs.SHAPE_PLANE]=wa,Ha[gs.SHAPE_AABB|gs.SHAPE_FRUSTUM]=Ea,Ha[gs.SHAPE_AABB|gs.SHAPE_FRUSTUM_ACCURATE]=Pa,Ha[gs.SHAPE_OBB]=Oa,Ha[gs.SHAPE_OBB|gs.SHAPE_PLANE]=Ia,Ha[gs.SHAPE_OBB|gs.SHAPE_FRUSTUM]=Ra,Ha[gs.SHAPE_OBB|gs.SHAPE_FRUSTUM_ACCURATE]=Ma,Ha[gs.SHAPE_OBB|gs.SHAPE_CAPSULE]=Ba,Ha[gs.SHAPE_CAPSULE]=ka,Ze(ys.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),Qe(Ha,"intersect",[{name:"line_quad"}]);const ja=new Ni(0,0,0),Wa=new Ni(0,0,0),qa=n.mat4(),Xa=n.v4();class Ya{static create(t,e,i,n){return new Ya(t,e,i,n)}static clone(t){return new Ya(t.n.x,t.n.y,t.n.z,t.d)}static copy(t,e){return Ni.copy(t.n,e.n),t.d=e.d,t}static fromPoints(t,e,i,n){return Ni.subtract(ja,i,e),Ni.subtract(Wa,n,e),Ni.normalize(t.n,Ni.cross(t.n,ja,Wa)),t.d=Ni.dot(t.n,e),t}static set(t,e,i,n,s){return t.n.x=e,t.n.y=i,t.n.z=n,t.d=s,t}static fromNormalAndPoint(t,e,i){return Ni.copy(t.n,e),t.d=Ni.dot(e,i),t}static normalize(t,e){const i=e.n.length();return Ni.normalize(t.n,e.n),i>0&&(t.d=e.d/i),t}get type(){return this._type}set x(t){this.n.x=t}get x(){return this.n.x}set y(t){this.n.y=t}get y(){return this.n.y}set z(t){this.n.z=t}get z(){return this.n.z}set w(t){this.d=t}get w(){return this.d}constructor(t=0,e=1,i=0,n=0){this.n=void 0,this.d=void 0,this._type=void 0,this._type=gs.SHAPE_PLANE,this.n=new Ni(t,e,i),this.d=n}transform(t){$i.invert(qa,t),$i.transpose(qa,qa),rn.set(Xa,this.n.x,this.n.y,this.n.z,this.d),rn.transformMat4(Xa,Xa,qa),Ni.set(this.n,Xa.x,Xa.y,Xa.z),this.d=Xa.w}}const Ka=jsb.NativeBufferPool;var $a;jsb.NativeObjectPool,jsb.NativeBufferAllocator,function(t){t[t.UINT32=0]="UINT32",t[t.FLOAT32=1]="FLOAT32",t[t.NEVER=2]="NEVER"}($a||($a={}));class Ja{constructor(t,e,i,n,s=8){this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=n.COUNT,this._entryBits=s,this._dataType=e,this._dataMembers=i,this._stride=4*this._elementCount,this._entriesPerChunk=1<<s,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new Ka(t,s,this._stride);let r=$a.NEVER,o=!1,a=!1;for(const t in e){if(o=this._hasFloat32,a=this._hasUint32,a&&o)break;r=e[t],o||r!==$a.FLOAT32?a||r!==$a.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}alloc(){let t=0;for(;t<this._freeLists.length;t++){const e=this._freeLists[t];if(e.length){const i=e[e.length-1];return e.length--,(t<<this._entryBits)+i+this._poolFlag}}const e=this._nativePool.allocateNewChunk(),i=[],n=[],s=[],r=this._hasFloat32,o=this._hasUint32;for(let t=0;t<this._entriesPerChunk;t++)r&&i.push(new Float32Array(e,this._stride*t,this._elementCount)),o&&n.push(new Uint32Array(e,this._stride*t,this._elementCount)),t&&s.push(t);return o&&this._uint32BufferViews.push(n),r&&this._float32BufferViews.push(i),this._freeLists.push(s),this._arrayBuffers.push(e),(t<<this._entryBits)+this._poolFlag}getBuffer(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[e][i]}getTypedArray(t,e){const i=(this._chunkMask&t)>>this._entryBits,n=this._entryMask&t,s=e,r=(this._dataType[e]===$a.UINT32?this._uint32BufferViews:this._float32BufferViews)[i][n],o=this._dataMembers[e];return r.subarray(s,s+o)}free(t){const e=(this._chunkMask&t)>>this._entryBits,i=this._entryMask&t;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[e][i].fill(0),this._freeLists[e].push(i)}}let Za,Qa;!function(t){t[t.NODE=0]="NODE",t[t.PASS=1]="PASS",t[t.AABB=2]="AABB"}(Za||(Za={})),function(t){t[t.DIRTY_FLAG=0]="DIRTY_FLAG",t[t.LAYER=1]="LAYER",t[t.WORLD_SCALE=2]="WORLD_SCALE",t[t.WORLD_POSITION=5]="WORLD_POSITION",t[t.WORLD_ROTATION=8]="WORLD_ROTATION",t[t.WORLD_MATRIX=12]="WORLD_MATRIX",t[t.LOCAL_SCALE=28]="LOCAL_SCALE",t[t.LOCAL_POSITION=31]="LOCAL_POSITION",t[t.LOCAL_ROTATION=34]="LOCAL_ROTATION",t[t.COUNT=38]="COUNT"}(Qa||(Qa={}));const tl={[Qa.DIRTY_FLAG]:$a.UINT32,[Qa.LAYER]:$a.UINT32,[Qa.WORLD_SCALE]:$a.FLOAT32,[Qa.WORLD_POSITION]:$a.FLOAT32,[Qa.WORLD_ROTATION]:$a.FLOAT32,[Qa.WORLD_MATRIX]:$a.FLOAT32,[Qa.LOCAL_SCALE]:$a.FLOAT32,[Qa.LOCAL_POSITION]:$a.FLOAT32,[Qa.LOCAL_ROTATION]:$a.FLOAT32,[Qa.COUNT]:$a.NEVER},el={[Qa.DIRTY_FLAG]:Qa.LAYER-Qa.DIRTY_FLAG,[Qa.LAYER]:Qa.WORLD_SCALE-Qa.LAYER,[Qa.WORLD_SCALE]:Qa.WORLD_POSITION-Qa.WORLD_SCALE,[Qa.WORLD_POSITION]:Qa.WORLD_ROTATION-Qa.WORLD_POSITION,[Qa.WORLD_ROTATION]:Qa.WORLD_MATRIX-Qa.WORLD_ROTATION,[Qa.WORLD_MATRIX]:Qa.LOCAL_SCALE-Qa.WORLD_MATRIX,[Qa.LOCAL_SCALE]:Qa.LOCAL_POSITION-Qa.LOCAL_SCALE,[Qa.LOCAL_POSITION]:Qa.LOCAL_ROTATION-Qa.LOCAL_POSITION,[Qa.LOCAL_ROTATION]:Qa.COUNT-Qa.LOCAL_ROTATION,[Qa.COUNT]:1},il=new Ja(Za.NODE,tl,el,Qa);let nl;!function(t){t[t.PRIORITY=0]="PRIORITY",t[t.STAGE=1]="STAGE",t[t.PHASE=2]="PHASE",t[t.PRIMITIVE=3]="PRIMITIVE",t[t.BATCHING_SCHEME=4]="BATCHING_SCHEME",t[t.DYNAMIC_STATE=5]="DYNAMIC_STATE",t[t.HASH=6]="HASH",t[t.COUNT=7]="COUNT"}(nl||(nl={}));const sl={[nl.PRIORITY]:$a.UINT32,[nl.STAGE]:$a.UINT32,[nl.PHASE]:$a.UINT32,[nl.PRIMITIVE]:$a.UINT32,[nl.BATCHING_SCHEME]:$a.UINT32,[nl.DYNAMIC_STATE]:$a.UINT32,[nl.HASH]:$a.UINT32,[nl.COUNT]:$a.NEVER},rl={[nl.PRIORITY]:nl.STAGE-nl.PRIORITY,[nl.STAGE]:nl.PHASE-nl.STAGE,[nl.PHASE]:nl.PRIMITIVE-nl.PHASE,[nl.PRIMITIVE]:nl.BATCHING_SCHEME-nl.PRIMITIVE,[nl.BATCHING_SCHEME]:nl.DYNAMIC_STATE-nl.BATCHING_SCHEME,[nl.DYNAMIC_STATE]:nl.HASH-nl.DYNAMIC_STATE,[nl.HASH]:nl.COUNT-nl.HASH,[nl.COUNT]:1},ol=new Ja(Za.PASS,sl,rl,nl);let al;!function(t){t[t.CENTER=0]="CENTER",t[t.HALFEXTENTS=3]="HALFEXTENTS",t[t.COUNT=6]="COUNT"}(al||(al={}));const ll={[al.CENTER]:$a.FLOAT32,[al.HALFEXTENTS]:$a.FLOAT32,[al.COUNT]:$a.NEVER},cl={[al.CENTER]:al.HALFEXTENTS-al.CENTER,[al.HALFEXTENTS]:al.COUNT-al.HALFEXTENTS,[al.COUNT]:1},hl=new Ja(Za.AABB,ll,cl,al),_l=new Ni,ul=new Ni,ml=new Ni,pl=new Ni,dl=new Vi,fl=(t,e,i)=>{dl.m00=Math.abs(i.m00),dl.m01=Math.abs(i.m01),dl.m02=Math.abs(i.m02),dl.m03=Math.abs(i.m04),dl.m04=Math.abs(i.m05),dl.m05=Math.abs(i.m06),dl.m06=Math.abs(i.m08),dl.m07=Math.abs(i.m09),dl.m08=Math.abs(i.m10),Ni.transformMat3(t,e,dl)};class gl{static create(t,e,i,n,s,r){return new gl(t,e,i,n,s,r)}static clone(t){return new gl(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)}static copy(t,e){return Ni.copy(t.center,e.center),Ni.copy(t.halfExtents,e.halfExtents),t}static fromPoints(t,e,i){return Ni.add(_l,i,e),Ni.subtract(ul,i,e),Ni.multiplyScalar(t.center,_l,.5),Ni.multiplyScalar(t.halfExtents,ul,.5),t}static set(t,e,i,n,s,r,o){return t.center.set(e,i,n),t.halfExtents.set(s,r,o),t}static merge(t,e,i){return Ni.subtract(_l,e.center,e.halfExtents),Ni.subtract(ul,i.center,i.halfExtents),Ni.add(ml,e.center,e.halfExtents),Ni.add(pl,i.center,i.halfExtents),Ni.max(pl,ml,pl),Ni.min(ml,_l,ul),gl.fromPoints(t,ml,pl)}static toBoundingSphere(t,e){e.getBoundary(_l,ul),t.center.set(_l),t.radius=0,Ni.subtract(ml,ul,t.center);const i=ml.length(),n=.5*i;return t.radius+=n,Ni.multiplyScalar(ml,ml,n/i),Ni.add(t.center,t.center,ml),t}static transform(t,e,i){return Ni.transformMat4(t.center,e.center,i),fl(t.halfExtents,e.halfExtents,i),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1){return this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=gs.SHAPE_AABB,this._aabbHandle=hl.alloc(),this.center=new Ni(hl.getTypedArray(this._aabbHandle,al.CENTER)),this.halfExtents=new Ni(hl.getTypedArray(this._aabbHandle,al.HALFEXTENTS)),this.center.set(t,e,i),this.halfExtents.set(n,s,r),this._nativeObj=new is,void this._nativeObj.initWithData(hl.getBuffer(this._aabbHandle))}get native(){return this._nativeObj}getBoundary(t,e){Ni.subtract(t,this.center,this.halfExtents),Ni.add(e,this.center,this.halfExtents)}transform(t,e,i,n,s){Ni.transformMat4(s.center,this.center,t),fl(s.halfExtents,this.halfExtents,t)}clone(){return gl.clone(this)}copy(t){return gl.copy(this,t)}}const yl=new Ni,vl=new Ni,xl=new Vi;class bl{static create(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p){return new bl(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p)}static clone(t){return new bl(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)}static copy(t,e){return Ni.copy(t.center,e.center),Ni.copy(t.halfExtents,e.halfExtents),Vi.copy(t.orientation,e.orientation),t}static fromPoints(t,e,i){return Ni.multiplyScalar(t.center,Ni.add(yl,e,i),.5),Ni.multiplyScalar(t.halfExtents,Ni.subtract(vl,i,e),.5),Vi.identity(t.orientation),t}static set(t,e,i,n,s,r,o,a,l,c,h,_,u,m,p,d){return Ni.set(t.center,e,i,n),Ni.set(t.halfExtents,s,r,o),Vi.set(t.orientation,a,l,c,h,_,u,m,p,d),t}get type(){return this._type}constructor(t=0,e=0,i=0,n=1,s=1,r=1,o=1,a=0,l=0,c=0,h=1,_=0,u=0,m=0,p=1){this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=gs.SHAPE_OBB,this.center=new Ni(t,e,i),this.halfExtents=new Ni(n,s,r),this.orientation=new Vi(o,a,l,c,h,_,u,m,p)}getBoundary(t,e){var i,n,s;i=yl,n=this.halfExtents,s=this.orientation,xl.m00=Math.abs(s.m00),xl.m01=Math.abs(s.m01),xl.m02=Math.abs(s.m02),xl.m03=Math.abs(s.m03),xl.m04=Math.abs(s.m04),xl.m05=Math.abs(s.m05),xl.m06=Math.abs(s.m06),xl.m07=Math.abs(s.m07),xl.m08=Math.abs(s.m08),Ni.transformMat3(i,n,xl),Ni.subtract(t,this.center,yl),Ni.add(e,this.center,yl)}transform(t,e,i,n,s){Ni.transformMat4(s.center,this.center,t),Vi.fromQuat(s.orientation,i),Ni.multiply(s.halfExtents,this.halfExtents,n)}translateAndRotate(t,e,i){Ni.transformMat4(i.center,this.center,t),Vi.fromQuat(i.orientation,e)}setScale(t,e){Ni.multiply(e.halfExtents,this.halfExtents,t)}}class Sl{get type(){return this._type}constructor(t=.5,e=.5,i=1){this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=gs.SHAPE_CAPSULE,this.radius=t,this.halfHeight=e,this.axis=i,this.center=new Ni,this.rotation=new ki,this.ellipseCenter0=new Ni(0,e,0),this.ellipseCenter1=new Ni(0,-e,0),this.updateCache()}transform(t,e,i,n,s){const r=n,o=Ei(r);s.radius=this.radius*Math.abs(o);let a=(this.halfHeight+this.radius)*Math.abs(r.y)-s.radius;a<0&&(a=0),s.halfHeight=a,Ni.transformMat4(s.center,this.center,t),ki.multiply(s.rotation,this.rotation,i),s.updateCache()}updateCache(){this.updateLocalCenter(),Ni.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),Ni.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)}updateLocalCenter(){const t=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(t,0,0),this.ellipseCenter1.set(-t,0,0);break;case 1:this.ellipseCenter0.set(0,t,0),this.ellipseCenter1.set(0,-t,0);break;case 2:this.ellipseCenter0.set(0,0,t),this.ellipseCenter1.set(0,0,-t)}}}const Al=new Array(8);Al[0]=new Ni(1,1,1),Al[1]=new Ni(-1,1,1),Al[2]=new Ni(-1,-1,1),Al[3]=new Ni(1,-1,1),Al[4]=new Ni(1,1,-1),Al[5]=new Ni(-1,1,-1),Al[6]=new Ni(-1,-1,-1),Al[7]=new Ni(1,-1,-1);class Cl{set accurate(t){this._type=t?gs.SHAPE_FRUSTUM_ACCURATE:gs.SHAPE_FRUSTUM}static create(){return new Cl}static clone(t){return Cl.copy(new Cl,t)}static copy(t,e){t._type=e._type;for(let i=0;i<6;++i)Ya.copy(t.planes[i],e.planes[i]);for(let i=0;i<8;++i)Ni.copy(t.vertices[i],e.vertices[i]);return t}get type(){return this._type}constructor(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=gs.SHAPE_FRUSTUM,this.planes=new Array(6);for(let t=0;t<6;++t)this.planes[t]=Ya.create(0,0,0,0);this.vertices=new Array(8);for(let t=0;t<8;++t)this.vertices[t]=new Ni}update(t,e){if(Ni.set(this.planes[0].n,t.m03+t.m00,t.m07+t.m04,t.m11+t.m08),this.planes[0].d=-(t.m15+t.m12),Ni.set(this.planes[1].n,t.m03-t.m00,t.m07-t.m04,t.m11-t.m08),this.planes[1].d=-(t.m15-t.m12),Ni.set(this.planes[2].n,t.m03+t.m01,t.m07+t.m05,t.m11+t.m09),this.planes[2].d=-(t.m15+t.m13),Ni.set(this.planes[3].n,t.m03-t.m01,t.m07-t.m05,t.m11-t.m09),this.planes[3].d=-(t.m15-t.m13),Ni.set(this.planes[4].n,t.m03+t.m02,t.m07+t.m06,t.m11+t.m10),this.planes[4].d=-(t.m15+t.m14),Ni.set(this.planes[5].n,t.m03-t.m02,t.m07-t.m06,t.m11-t.m10),this.planes[5].d=-(t.m15-t.m14),this._type===gs.SHAPE_FRUSTUM_ACCURATE){for(let t=0;t<6;t++){const e=this.planes[t],i=1/e.n.length();Ni.multiplyScalar(e.n,e.n,i),e.d*=i}for(let t=0;t<8;t++)Ni.transformMat4(this.vertices[t],Al[t],e)}}transform(t){if(this._type===gs.SHAPE_FRUSTUM_ACCURATE){for(let e=0;e<8;e++)Ni.transformMat4(this.vertices[e],this.vertices[e],t);Ya.fromPoints(this.planes[0],this.vertices[1],this.vertices[5],this.vertices[6]),Ya.fromPoints(this.planes[1],this.vertices[3],this.vertices[7],this.vertices[4]),Ya.fromPoints(this.planes[2],this.vertices[6],this.vertices[7],this.vertices[3]),Ya.fromPoints(this.planes[3],this.vertices[0],this.vertices[4],this.vertices[5]),Ya.fromPoints(this.planes[4],this.vertices[2],this.vertices[3],this.vertices[0]),Ya.fromPoints(this.planes[0],this.vertices[7],this.vertices[6],this.vertices[5])}}}function Tl(t,e,i,n){i&&Object.defineProperty(t,e,{enumerable:i.enumerable,configurable:i.configurable,writable:i.writable,value:i.initializer?i.initializer.call(n):void 0})}function wl(t,e,i,n,s){var r={};return Object.keys(n).forEach((function(t){r[t]=n[t]})),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=i.slice().reverse().reduce((function(i,n){return n(t,e,i)||i}),r),s&&void 0!==r.initializer&&(r.value=r.initializer?r.initializer.call(s):void 0,r.initializer=void 0),void 0===r.initializer&&(Object.defineProperty(t,e,r),r=null),r}let El,Pl;Cl.createOrtho=(()=>{const t=new Ni;return(e,i,n,s,r,o)=>{const a=i/2,l=n/2;Ni.set(t,a,l,s),Ni.transformMat4(e.vertices[0],t,o),Ni.set(t,-a,l,s),Ni.transformMat4(e.vertices[1],t,o),Ni.set(t,-a,-l,s),Ni.transformMat4(e.vertices[2],t,o),Ni.set(t,a,-l,s),Ni.transformMat4(e.vertices[3],t,o),Ni.set(t,a,l,r),Ni.transformMat4(e.vertices[4],t,o),Ni.set(t,-a,l,r),Ni.transformMat4(e.vertices[5],t,o),Ni.set(t,-a,-l,r),Ni.transformMat4(e.vertices[6],t,o),Ni.set(t,a,-l,r),Ni.transformMat4(e.vertices[7],t,o),Ya.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Ya.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Ya.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Ya.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Ya.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Ya.fromPoints(e.planes[0],e.vertices[7],e.vertices[5],e.vertices[6])}})(),function(t){t[t.Default=0]="Default",t[t.Normal=1]="Normal",t[t.Loop=2]="Loop",t[t.ShouldWrap=4]="ShouldWrap",t[t.Clamp=8]="Clamp",t[t.PingPong=22]="PingPong",t[t.Reverse=36]="Reverse"}(El||(El={})),function(t){t[t.Default=El.Default]="Default",t[t.Normal=El.Normal]="Normal",t[t.Reverse=El.Reverse]="Reverse",t[t.Loop=El.Loop]="Loop",t[t.LoopReverse=El.Loop|El.Reverse]="LoopReverse",t[t.PingPong=El.PingPong]="PingPong",t[t.PingPongReverse=El.PingPong|El.Reverse]="PingPongReverse"}(Pl||(Pl={})),zt(Pl);class Dl{constructor(t){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,t&&this.set(t)}set(t){this.ratio=t.ratio,this.time=t.time,this.direction=t.direction,this.stopped=t.stopped,this.iterations=t.iterations,this.frameIndex=t.frameIndex}}function Il(t,e,i=1e-6){let n=0,s=t.length-1,r=s>>>1;for(;n<=s;r=n+s>>>1){const o=t[r];if(o>e+i)s=r-1;else{if(!(o<e-i))return r;n=r+1}}return~n}const Rl=()=>{},Ml=()=>Rl,Ol=Bl((()=>{}));function Bl(t){return function(e){return"function"==typeof e?t(e):function(i){return t(i,e)}}}function Nl(t){return e=>i=>{!function(t,e,i){const n=Fl(t);if(n){const t=zl(n,"proto");zl(t,"editor")[e]=i}}(i,t,e)}}const Ll="__ccclassCache__";function Fl(t){return zl(t,Ll)}function zl(t,e){return t[e]||(t[e]={})}const Vl=Bl(((t,e)=>{let i=Ot.getSuper(t);i===Object&&(i=null);const n={name:e,extends:i,ctor:t},s=t[Ll];if(s){const e=s.proto;e&&Ot.mixin(n,e),t[Ll]=void 0}return we(n)})),Ul=Nl("requireComponent"),Gl=Nl("executionOrder"),kl=Ol;function Hl(t,e,i){let n=null;function s(t,e,i){const s=Fl(t.constructor);if(s){const r=zl(s,"proto"),o=zl(r,"properties");!function(t,e,i,n,s,r){let o;const a=s&&(s.get||s.set);n&&(o=fe(n,a));const l=e[i],c=Ot.mixin(l||{},o||n||{});if(a)s.get&&(c.get=s.get),s.set&&(c.set=s.set);else if(s)s.initializer&&(c.default=function(t){let e;try{e=t()}catch(e){return t}return"object"!=typeof e||null===e?e:t}(s.initializer));else{const e=r.default||(r.default=function(t){let e;try{e=new t}catch(t){return{}}return e}(t));e.hasOwnProperty(i)&&(c.default=e[i])}e[i]=c}(t.constructor,o,e,n,i,s)}}return void 0===t?Hl({type:void 0}):void 0===e?(n=t,s):void s(t,e,i)}const jl=Symbol("cc:SerializationMetadata"),Wl=(t,e,i)=>Hl(Yl({}))(t,e,i);function ql(t){return Hl(Yl({formerlySerializedAs:t}))}const Xl=(t,e,i)=>Hl({editorOnly:!0})(t,e,i);function Yl(t){return t.__noImplicit=!0,"serializable"in t||(t.serializable=!0),t}const Kl=Rl,$l=Ol,Jl=Ml,Zl=Ol,Ql=Ml,tc=Ml,ec=Ml,ic=Rl,nc=Ml,sc=Ml,rc=Ml,oc=Ml,ac=Ml,lc=Ml,cc=Ml,hc=Rl,_c=Ml,uc=Rl,mc=Rl,pc=yc(oe),dc=yc(ae),fc=yc(le),gc=yc(ce);function yc(t){return Hl({type:t})}const vc=(t,e,i)=>Hl({__noImplicit:!0,override:!0})(t,e,i);let xc;var bc,Sc,Ac,Cc;let Tc,wc,Ec,Pc=Vl("cc.KeyframeCurve")((xc=Symbol.iterator,Ac=wl((Sc=class{constructor(){Tl(this,"_times",Ac,this),Tl(this,"_values",Cc,this)}get keyFramesCount(){return this._times.length}get rangeMin(){return this._times[0]}get rangeMax(){return this._times[this._values.length-1]}[xc](){let t=0;return{next:()=>{if(t>=this._times.length)return{done:!0,value:void 0};{const e=[this._times[t],this._values[t]];return++t,{done:!1,value:e}}}}}keyframes(){return this}times(){return this._times}values(){return this._values}getKeyframeTime(t){return this._times[t]}getKeyframeValue(t){return this._values[t]}addKeyFrame(t,e){return this._insertNewKeyframe(t,e)}removeKeyframe(t){this._times.splice(t,1),this._values.splice(t,1)}indexOfKeyframe(t){return Il(this._times,t)}updateTime(t,e){const i=this._values[t];this.removeKeyframe(t),this._insertNewKeyframe(e,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.slice());else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>t)))}}clear(){this._times.length=0,this._values.length=0}searchKeyframe(t){return Il(this._times,t)}setKeyframes(t,e){t.length,e.length,function(t){t.every(((t,e,i)=>0===e||t>i[e-1]||_i(t,i[e-1],1e-6)))}(t),this._times=t,this._values=e}_insertNewKeyframe(t,e){const i=this._times,n=this._values,s=i.length,r=Il(i,t);if(r>=0)return r;const o=~r;return 0===o?(i.unshift(t),n.unshift(e)):o===s?(i.push(t),n.push(e)):(i.splice(o-1,0,t),n.splice(o-1,0,e)),o}}).prototype,"_times",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cc=wl(Sc.prototype,"_values",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bc=Sc))||bc;function Dc(t){return t>-1e-9&&t<1e-9}!function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.CUBIC=2]="CUBIC"}(Tc||(Tc=t("RealInterpolationMode",{}))),function(t){t[t.LINEAR=0]="LINEAR",t[t.CLAMP=1]="CLAMP",t[t.LOOP=2]="LOOP",t[t.PING_PONG=3]="PING_PONG"}(wc||(wc=t("ExtrapolationMode",{}))),function(t){t[t.NONE=0]="NONE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTH=3]="BOTH"}(Ec||(Ec=t("TangentWeightMode",{})));const Ic=Object;var Rc=Object.freeze({__proto__:null,uniquelyReferenced:Kl,ccclass:Vl,property:Hl,requireComponent:Ul,executionOrder:Gl,disallowMultiple:kl,executeInEditMode:$l,menu:Jl,playOnFocus:Zl,inspector:Ql,icon:tc,help:ec,type:yc,integer:pc,float:dc,boolean:fc,string:gc});t("_decorator",Rc);class Mc{constructor(t){this._map=null,this._count=0,t?(this._map=t,this._count=Object.keys(t).length):(this._map=Ot.createMap(!0),this._count=0)}add(t,e){return t in this._map||this._count++,this._map[t]=e}get(t){return this._map[t]}has(t){return t in this._map}remove(t){const e=this._map[t];return t in this._map&&(delete this._map[t],this._count--),e}clear(){0!==this._count&&(this._map=Ot.createMap(!0),this._count=0)}forEach(t){for(const e in this._map)t(this._map[e],e)}find(t){for(const e in this._map)if(t(this._map[e],e))return this._map[e];return null}get count(){return this._count}destroy(){this._map=null}}class Oc{constructor(t,e){this.id=Oc._pipelineId++,this.name="",this.pipes=[],this.name=t;for(let t=0,i=e.length;t<i;t++)this.pipes.push(e[t])}insert(t,e){return e>this.pipes.length?(A(4921),this):(this.pipes.splice(e,0,t),this)}append(t){return this.pipes.push(t),this}remove(t){return this.pipes.splice(t,1),this}sync(t){const e=this.pipes;if(0===e.length)return null;t.isFinish=!1;for(let i=0,n=e.length;i<n;){const s=(0,e[i])(t);if(s)return t.isFinish=!0,s;i++,i!==n&&(t.input=t.output,t.output=null)}return t.isFinish=!0,t.output}async(t){0!==this.pipes.length&&(t.isFinish=!1,this._flow(0,t))}_flow(t,e){(0,this.pipes[t])(e,(i=>{i?(e.isFinish=!0,e.dispatch("complete",i)):++t<this.pipes.length?(e.input=e.output,e.output=null,this._flow(t,e)):(e.isFinish=!0,e.dispatch("complete",i,e.output))}))}}Oc._pipelineId=0;const Bc=new Mc,Nc=new Mc,Lc=new Mc,Fc=new Mc,zc=new Oc("normal load",[]),Vc=new Oc("fetch",[]),Uc=new Oc("transform url",[]);let Gc;!function(t){t.UUID="uuid",t.PATH="path",t.DIR="dir",t.URL="url",t.SCENE="scene"}(Gc||(Gc={}));const kc={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};let Hc;!function(t){t.RESOURCES="resources",t.MAIN="main",t.START_SCENE="start-scene"}(Hc||(Hc={}));class jc{static create(t){let e;return 0!==jc._deadPool.length?(e=jc._deadPool.pop(),e.set(t)):e=new jc(t),e}constructor(t){this.id=jc._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}set(t=Object.create(null)){this.onComplete=t.onComplete||null,this.onProgress=t.onProgress||null,this.onError=t.onError||null,this.source=this.input=t.input,this.output=null,this.progress=t.progress,this.options=t.options||Object.create(null)}dispatch(t,e,i,n,s){switch(t){case"complete":this.onComplete&&this.onComplete(e,i);break;case"progress":this.onProgress&&this.onProgress(e,i,n,s);break;case"error":this.onError&&this.onError(e,i,n,s);break;default:{const r=`on${t[0].toUpperCase()}${t.substr(1)}`;"function"==typeof this[r]&&this[r](e,i,n,s);break}}}recycle(){jc._deadPool.length!==jc.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,jc._deadPool.push(this))}}jc.MAX_DEAD_NUM=500,jc._taskId=0,jc._deadPool=[];const Wc="0123456789abcdef".split(""),qc=["","","",""],Xc=qc.concat(qc,"-",qc,"-",qc,"-",qc,"-",qc,qc,qc),Yc=Xc.map(((t,e)=>"-"===t?NaN:e)).filter(isFinite);function Kc(t){const e=t.split("@")[0];if(22!==e.length)return t;Xc[0]=t[0],Xc[1]=t[1];for(let e=2,i=2;e<22;e+=2){const n=Ht[t.charCodeAt(e)],s=Ht[t.charCodeAt(e+1)];Xc[Yc[i++]]=Wc[n>>2],Xc[Yc[i++]]=Wc[(3&n)<<2|s>>4],Xc[Yc[i++]]=Wc[15&s]}return t.replace(e,Xc.join(""))}const $c=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function Jc(t){const e=$c.exec(t);return e?e[1]:""}function Zc(t,e){(e=e||Object.create(null)).__isNative__=e.isNative,e.ext=e.nativeExt;const i=Fc.find((e=>!!e.getAssetInfo(t)));return i&&(e.bundle=i.name),eh(t,e)}function Qc(t){return!!t&&(t instanceof n.SceneAsset||t instanceof n.Scene)}function th(t){return t&&(46===t.charCodeAt(0)&&47===t.charCodeAt(1)?t=t.slice(2):47===t.charCodeAt(0)&&(t=t.slice(1))),t}function eh(t,e){const i=jc.create({input:t,options:e}),n=[];try{const t=Uc.sync(i);for(const e of t){const t=e.url;e.recycle(),n.push(t)}}catch(t){for(const t of i.output)t.recycle();p(t.message,t.stack)}return i.recycle(),n.length>1?n:n[0]}var ih=Object.freeze({__proto__:null,getUuidFromURL:Jc,getUrlWithUuid:Zc,isScene:Qc,normalize:th,transform:eh,decodeUuid:Kc});class nh{constructor(t,e){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=t,this.bubbles=!!e}unuse(){this.type=nh.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=nh.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1}reuse(t,e){this.type=t,this.bubbles=e||!1}isStopped(){return this.propagationStopped||this.propagationImmediateStopped}getCurrentTarget(){return this.currentTarget}getType(){return this.type}}t("Event",nh),nh.NO_TYPE="no_type",nh.TOUCH="touch",nh.MOUSE="mouse",nh.KEYBOARD="keyboard",nh.ACCELERATION="acceleration",nh.NONE=0,nh.CAPTURING_PHASE=1,nh.AT_TARGET=2,nh.BUBBLING_PHASE=3,n.Event=nh;const sh=new class{constructor(){this._finalizationRegistry=null}registerGCObject(t){return t}unregisterGCObject(t){}init(){}finalizationRegistryCallback(t){t.destroy()}destroy(){}};var rh;let oh=Vl("cc.GCObject")(rh=class extends Me{constructor(...t){return super(...t),sh.registerGCObject(this)}equals(t){return!!t&&t===this}destroy(){return sh.unregisterGCObject(this),super.destroy()}})||rh;var ah,lh,ch,hh;let _h=t("Asset",Vl("cc.Asset")((hh=class extends(ke(oh)){static deserialize(t){return n.deserialize(t)}get nativeUrl(){if(!this._nativeUrl){if(!this._native)return"";const t=this._native;if(47===t.charCodeAt(0))return t.slice(1);46===t.charCodeAt(0)?this._nativeUrl=Zc(this._uuid,{nativeExt:t,isNative:!0}):this._nativeUrl=Zc(this._uuid,{__nativeName__:t,nativeExt:An(t),isNative:!0})}return this._nativeUrl}get _nativeAsset(){return this._file}set _nativeAsset(t){this._file=t}constructor(...t){super(...t),this.loaded=!0,Tl(this,"_native",ch,this),this._nativeUrl="",this._file=null,this._ref=0,Object.defineProperty(this,"_uuid",{value:"",writable:!0})}toString(){return this.nativeUrl}serialize(){}_setRawAsset(t,e=!0){this._native=!1!==e?t||"":`/${t}`}get _nativeDep(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}get refCount(){return this._ref}addRef(){return this._ref++,this}decRef(t=!0){return this._ref>0&&this._ref--,t&&n.assetManager._releaseManager.tryRelease(this),this}onLoaded(){}initDefault(t){t&&(this._uuid=t),this.isDefault=!0}validate(){return!0}destroy(){return f(D(12101,this._uuid)),super.destroy()}},ch=wl((lh=hh).prototype,"_native",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),wl(lh.prototype,"_nativeAsset",[Hl],Object.getOwnPropertyDescriptor(lh.prototype,"_nativeAsset"),lh.prototype),ah=lh))||ah);var uh,mh,ph;_h.prototype.createNode=null,n.Asset=_h;let dh=t("Script",Vl("cc.Script")(uh=class extends _h{})||uh);n._Script=dh;let fh=t("JavaScript",Vl("cc.JavaScript")(mh=class extends dh{})||mh);n._JavaScript=fh;let gh=t("TypeScript",Vl("cc.TypeScript")(ph=class extends dh{})||ph);var yh,vh,xh,bh,Sh,Ah,Ch,Th,wh,Eh,Ph;n._TypeScript=gh;const Dh=new X("Comp"),Ih=Me.Flags.IsOnLoadCalled;let Rh=t("Component",(yh=Vl("cc.Component"),vh=sc(),xh=yc(dh),bh=rc(),yh((Ph=Eh=class extends Me{constructor(...t){super(...t),Tl(this,"node",Ch,this),Tl(this,"_enabled",Th,this),Tl(this,"__prefab",wh,this),this._sceneGetter=null,this._id=Dh.getNewId()}get name(){if(this._name)return this._name;let t=rt(this);const e=t.lastIndexOf(".");return e>=0&&(t=t.slice(e+1)),`${this.node.name}<${t}>`}set name(t){this._name=t}get uuid(){return this._id}get __scriptAsset(){return null}get enabled(){return this._enabled}set enabled(t){if(this._enabled!==t&&(this._enabled=t,this.node.activeInHierarchy)){const e=n.director._compScheduler;t?e.enableComp(this):e.disableComp(this)}}get enabledInHierarchy(){return this._enabled&&this.node&&this.node.activeInHierarchy}get _isOnLoadCalled(){return this._objFlags&Ih}_getRenderScene(){return this._sceneGetter?this._sceneGetter():this.node.scene._renderScene}addComponent(t){return this.node.addComponent(t)}getComponent(t){return this.node.getComponent(t)}getComponents(t){return this.node.getComponents(t)}getComponentInChildren(t){return this.node.getComponentInChildren(t)}getComponentsInChildren(t){return this.node.getComponentsInChildren(t)}destroy(){return!!super.destroy()&&(this._enabled&&this.node.activeInHierarchy&&n.director._compScheduler.disableComp(this),!0)}_onPreDestroy(){this.unscheduleAllCallbacks(),n.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)}_instantiate(t){return t||(t=n.instantiate._clone(this,this)),t&&(t.node=null),t}schedule(t,e=0,i=n.macro.REPEAT_FOREVER,s=0){E(t,1619),E((e=e||0)>=0,1620),i=Number.isNaN(i)?n.macro.REPEAT_FOREVER:i,s=s||0;const r=n.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(t,this,e,i,s,o)}scheduleOnce(t,e=0){this.schedule(t,0,0,e)}unschedule(t){t&&n.director.getScheduler().unschedule(t,this)}unscheduleAllCallbacks(){n.director.getScheduler().unscheduleAllForTarget(this)}},Eh.system=null,wl((Ah=Ph).prototype,"__scriptAsset",[vh,xh,bh,mc],Object.getOwnPropertyDescriptor(Ah.prototype,"__scriptAsset"),Ah.prototype),Ch=wl(Ah.prototype,"node",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Th=wl(Ah.prototype,"_enabled",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wh=wl(Ah.prototype,"__prefab",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Sh=Ah))||Sh));const Mh=Rh.prototype;var Oh,Bh,Nh;Mh.update=null,Mh.lateUpdate=null,Mh.__preload=null,Mh.onLoad=null,Mh.start=null,Mh.onEnable=null,Mh.onDisable=null,Mh.onDestroy=null,Mh.onFocusInEditor=null,Mh.onLostFocusInEditor=null,Mh.resetInEditor=null,Mh._getLocalBounds=null,Mh.onRestore=null,Rh._requireComponent=null,Rh._executionOrder=0,tt(Rh,"_registerEditorProps",((t,e)=>{const i=e.requireComponent;i&&(t._requireComponent=i);const n=e.executionOrder;n&&"number"==typeof n&&(t._executionOrder=n)})),n.Component=Rh;let Lh=t("MissingScript",Vl("cc.MissingScript")(Oh=Ql()((Nh=wl((Bh=class extends Rh{static safeFindClass(t){const e=Pt(t);if(e)return e;n.deserialize.reportMissingClass(t)}constructor(){super(),Tl(this,"_$erialized",Nh,this)}onLoad(){A(4600,this.node.name)}}).prototype,"_$erialized",[Wl,Xl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Oh=Bh))||Oh)||Oh);n._MissingScript=Lh;const Fh=t("serializeTag",Symbol("[[Serialize]]")),zh=t("deserializeTag",Symbol("[[Deserialize]]"));class Vh{constructor(t,e){this._document=void 0,this._chunks=void 0,this._document=t,this._chunks=e}get document(){return this._document}get chunks(){return this._chunks}}function Uh(t){const e=t;return{chunks:e.chunks,document:e.document}}function Gh(t){if(t.length<16)throw new kh(D(13102));const e=new DataView(t.buffer,t.byteOffset,t.byteLength);if(1313817411!==e.getUint32(0,!0))throw new kh(D(13100));const i=e.getUint32(4,!0);if(1!==i)throw new kh(D(13101,i));if(e.getUint32(8,!0)!==e.byteLength)throw new kh(D(13102));let n=12;const s=e.getUint32(n,!0);n+=4;const r=new Uint8Array(e.buffer,n+e.byteOffset,s);n+=s;const o=function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);if("Buffer"in globalThis){const{Buffer:e}=globalThis;return e.from(t.buffer,t.byteOffset,t.byteLength).toString()}throw new Error(D(13104))}(r);let a;try{a=JSON.parse(o)}catch(t){throw new kh(t)}const l=[];for(;n<e.byteLength;){n%8!=0&&(n+=8-n%8);const t=e.getUint32(n,!0);n+=4,l.push(new Uint8Array(e.buffer,n+e.byteOffset,t)),n+=t}if(n!==e.byteLength)throw new kh(D(13102));return new Vh(a,l)}class kh extends Error{}function Hh(t,e,i,s,r){if(e instanceof n.ValueType){r||t.push("if(prop){");const n=rt(e);t.push(`s._deserializeFastDefinedObject(o${i},prop,${n});`),r||t.push(`}else o${i}=null;`)}else t.push(`\nif (prop) {\n    s._deserializeAndAssignField(o, prop, ${s});\n} else {\n    o${i}=null;\n}\n`)}n.internal.parseCCONJson=Uh,n.internal.decodeCCONBinary=Gh,n.internal.CCON=Vh;const jh="$_$type",Wh="$_$default",qh="$_$formerlySerializedAs";class Xh{constructor(t,e,i,n,s){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=t,this.customEnv=n,this.deserializedList=[],this.deserializedData=null,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}reset(t,e,i,n,s){this.result=t,this.customEnv=n,this._classFinder=e,this._reportMissingClass=i,this._onDereferenced=null==e?void 0:e.onDereferenced}clear(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null}deserialize(t){let e,i=!1;t instanceof Vh?(i=!0,e=t.document,t.chunks.length>0&&(t.chunks.length,this._mainBinChunk=t.chunks[0])):e=t,this._serializedData=e,this._context={fromCCON:i};const n=Array.isArray(e)?e[0]:e;return this.deserializedData=this._deserializeObject(n,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData}_deserializeObject(t,e,i,n){switch(t.__type__){case"TypedArray":return this._deserializeTypedArrayView(t);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(t);default:return t.__type__?this._deserializeTypeTaggedObject(t,e,i,n):Array.isArray(t)?this._deserializeArray(t):this._deserializePlainObject(t)}}_deserializeTypedArrayView(t){return globalThis[t.ctor].from(t.array)}_deserializeTypedArrayViewRef(t){const{offset:e,length:i,ctor:n}=t;return new globalThis[n](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+e,i)}_deserializeArray(t){const e=new Array(t.length);let i;for(let n=0;n<t.length;n++)i=t[n],"object"==typeof i&&i?this._deserializeAndAssignField(e,i,`${n}`)&&(e[n]=null):e[n]=i;return e}_deserializePlainObject(t){const e={};return this._fillPlainObject(e,t),e}_deserializeTypeTaggedObject(t,e,i,n){const s=t.__type__,r=this._classFinder(s,t,i,n);if(!r)return this._classFinder===Pt&&this._reportMissingClass(s),null;{const i=(t=>{const i=new t;return e>=0&&(this.deserializedList[e]=i),i})(r);return this._deserializeInto(t,i,r),i}}_deserializeInto(t,e,i,s=!1){s||!e[zh]?e._deserialize?e._deserialize(t.content,this):n.Class._isCCClass(i)?this._deserializeFireClass(e,t,i):this._deserializeFastDefinedObject(e,t,i):this._runCustomizedDeserialize(t,e,i)}_runCustomizedDeserialize(t,e,i){const n={readProperty:e=>{const i=t[e];return"object"==typeof i&&i?this._deserializeObjectField(i):i},readThis:()=>{this._deserializeInto(t,e,i,!0)},readSuper:()=>{const n=gt(i);n&&this._deserializeInto(t,e,n)}};e[zh](n,this._context)}_deserializeFireClass(t,e,i){let s;i.hasOwnProperty("__deserialize__")?s=i.__deserialize__:(s=function(t,e){const i=ne(e),s=e.__values__,r=["var prop;"],o=Gt.test(It(e));for(let t=0;t<s.length;t++){const e=s[t];let n,a;we.IDENTIFIER_RE.test(e)?(a=`"${e}"`,n=`.${e}`):(a=we.escapeForJS(e),n=`[${a}]`);let l=n;if(i[e+qh]){const t=i[e+qh];l=we.IDENTIFIER_RE.test(t)?`.${t}`:`[${we.escapeForJS(t)}]`}r.push(`prop=d${l};`),r.push('if(typeof (prop)!=="undefined"){');const c=we.getDefault(i[e+Wh]);if(o){let t;const s=i[e+jh];if(void 0===c&&s)t=s instanceof re;else{const e=typeof c;t="string"===e||"number"===e||"boolean"===e}t?r.push(`o${n}=prop;`):Hh(r,c,n,a,!0)}else r.push(`if(typeof (prop)!=="object"){o${n}=prop;}else{`),Hh(r,c,n,a,!1),r.push("}");r.push("}")}return(n.js.isChildClassOf(e,n._BaseNode)||n.js.isChildClassOf(e,n.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===s[s.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,i),tt(i,"__deserialize__",s,!0)),s(this,t,e,i)}_deserializeAndAssignField(t,e,i){const n=e.__id__;if("number"==typeof n){const e=this.deserializedList[n];if(e)t[i]=e;else{var s;const e=this._serializedData[n];t[i]=this._deserializeObject(e,n,void 0,i),null===(s=this._onDereferenced)||void 0===s||s.call(this,this.deserializedList,n,t,i)}}else{const n=e.__uuid__;if(n){const s=e.__expectedType__;this.result.push(t,i,n,s)}else t[i]=this._deserializeObject(e,-1)}return!1}_deserializeObjectField(t){const e=t.__id__;if("number"==typeof e){const t=this.deserializedList[e];if(t)return t;{const t=this._serializedData[e];return this._deserializeObject(t,e,void 0,void 0)}}if(t.__uuid__)throw t.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(t,-1)}_fillPlainObject(t,e){for(const i in e){if(!e.hasOwnProperty(i))continue;const n=e[i];"object"!=typeof n?"__type__"!==i&&(t[i]=n):n?this._deserializeAndAssignField(t,n,i)&&(t[i]=null):t[i]=null}}_deserializeFastDefinedObject(t,e,i){if(i===n.Vec2)return t.x=e.x||0,void(t.y=e.y||0);if(i===n.Vec3)return t.x=e.x||0,t.y=e.y||0,void(t.z=e.z||0);if(i===n.Color){t.r=e.r||0,t.g=e.g||0,t.b=e.b||0;const i=e.a;return void(t.a=void 0===i?255:i)}if(i===n.Size)return t.width=e.width||0,void(t.height=e.height||0);const s=ne(i),r=i.__values__;for(let i=0;i<r.length;i++){const n=r[i];let o=e[n];void 0!==o||e.hasOwnProperty(n)||(o=we.getDefault(s[n+Wh])),"object"!=typeof o?t[n]=o:o?this._deserializeAndAssignField(t,o,n):t[n]=null}}}Xh.pool=new class extends Rt{constructor(){super((t=>{t.clear()}),1)}get(t,e,i,n,s){const r=this._get();return r?(r.reset(t,e,i,n,s),r):new Xh(t,e,i,n,s)}};const Yh=[tn,Ni,rn,ki,Ri,ln,hn,$i];function Kh(t,e){t.x=e[1],t.y=e[2],t.z=e[3],t.w=e[4]}const $h=[(t,e)=>{t.x=e[1],t.y=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.z=e[3]},Kh,Kh,(t,e)=>{t._val=e[1]},(t,e)=>{t.width=e[1],t.height=e[2]},(t,e)=>{t.x=e[1],t.y=e[2],t.width=e[3],t.height=e[4]},(t,e)=>{$i.fromArray(t,e,1)}];class Jh{constructor(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}init(t){t?(this.uuidObjList=t[8],this.uuidPropList=t[9],this.uuidList=t[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])}reset(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)}push(t,e,i,n){this.uuidObjList.push(t),this.uuidPropList.push(e),this.uuidList.push(i),this.uuidTypeList.push(n||"")}}function Zh(t,e){const i=t[4][e[0]],n=i[0],s=new(0,n[0]),r=n[1],o=n[2],a=i[i.length-1];let l=1;for(;l<a;++l)s[r[i[l]]]=e[l];for(;l<e.length;++l){const a=r[i[l]],c=n[i[l]+o];(0,s_[c])(t,s,a,e[l])}return s}function Qh(t,e,i){const n=new e;return n._deserialize?n._deserialize(i,t[0]):T(5303,rt(e)),n}function t_(t,e,i,n){n>=0?e[i]=t[5][n]:t[7][3*~n]=e}function e_(t){return(e,i,n,s)=>{i[n]=s;for(let i=0;i<s.length;++i)t(e,s,i,s[i])}}function i_(t,e,i,n){e[i]=null,t[8][n]=e}function n_(t,e,i,n){e[i]=Zh(t,n)}t("Details",Jh),Jh.pool=new Rt((t=>{t.reset()}),5),Jh.pool.get=function(){return this._get()||new Jh};const s_=new Array(13);function r_(t,e,i){return t||i(e),Object}function o_(t,e,i,n,s,r,o){let a=t(e);if(!a){if(s)return void(i[n]=(l=i,c=n,h=e,function(){const e=t(h)||r_(r,h,o);return l[c]=e,new e}));a=r_(r,e,o)}var l,c,h;i[n]=a}function a_(t,e,i,n){const s=i||Pt,r=t[3];for(let t=0;t<r.length;++t){const o=r[t];"string"!=typeof o?o_(s,o[0],o,0,e,i,n):o_(s,o,r,t,e,i,n)}}function l_(t){const e=t[4];if(e){const i=t[3];for(let t=0;t<e.length;++t){const n=e[t];n[0]=i[n[0]]}}}function c_(t,e,i){"string"==typeof t&&(t=JSON.parse(t));const s=!e;let r;if(e=e||Jh.pool.get(),function(t){if(Array.isArray(t)){const e=t[0];return"number"==typeof e||e instanceof h_}return!1}(t)){e.init(t),i=i||{};let s=t[0],a=!1;if("object"==typeof s&&(a=s.preprocessed,s=s.version),s<1)throw new Error(D(5304,s));var o;i._version=s,i.result=e,t[0]=i,a||(a_(t,!1,i.classFinder,null!==(o=i.reportMissingClass)&&void 0!==o?o:c_.reportMissingClass),l_(t)),n.game._isCloning=!0;const l=t[5],c=function(t){const e=t[5],i=t[6],n=0===i?0:i.length;let s=e[e.length-1],r=e.length-n;"number"!=typeof s?s=0:(s<0&&(s=~s),--r);let o=0;for(;o<r;++o)e[o]=Zh(t,e[o]);const a=t[3];for(let s=0;s<n;++s,++o){let n=i[s];const r=e[o];if(n>=0){const i=a[n];e[o]=Qh(t,i,r)}else n=~n,(0,s_[n])(t,e,o,r)}return s}(t);n.game._isCloning=!1,t[7]&&function(t,e,i){const n=t.length-1;let s=0;const r=3*t[n];for(;s<r;s+=3){const n=t[s],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}for(;s<n;s+=3){const n=e[t[s]],r=e[t[s+2]],o=t[s+1];o>=0?n[i[o]]=r:n[~o]=r}}(t[7],l,t[2]),function(t){const e=t[5],i=t[2],n=t[1],s=t[8],r=t[9],o=t[10];for(let t=0;t<s.length;++t){const a=s[t];"number"==typeof a&&(s[t]=e[a]);let l=r[t];"number"==typeof l&&(l=l>=0?i[l]:~l,r[t]=l);const c=o[t];"number"==typeof c&&(o[t]=n[c])}}(t),r=l[c]}else r=function(t,e,i){var s;const r=(i=i||{}).classFinder||Pt,o=i.createAssetRefs||yn.platform===F.EDITOR_CORE,a=i.customEnv,l=i.ignoreEditorOnly,c=null!==(s=i.reportMissingClass)&&void 0!==s?s:n.deserialize.reportMissingClass;e.init();const h=Xh.pool.get(e,r,c,a,l);n.game._isCloning=!0;const _=h.deserialize(t);return n.game._isCloning=!1,Xh.pool.put(h),o&&e.assignAssetsBy(EditorExtends.serialize.asAsset),_}(t,e,i);return s&&Jh.pool.put(e),r}s_[0]=function(t,e,i,n){e[i]=n},s_[1]=t_,s_[2]=e_(t_),s_[3]=e_(i_),s_[4]=n_,s_[5]=function(t,e,i,n){$h[n[0]](e[i],n)},s_[6]=i_,s_[7]=function(t,e,i,n){e[i].set(n)},s_[8]=function(t,e,i,n){const s=new Yh[n[0]];$h[n[0]](s,n),e[i]=s},s_[9]=e_(n_),s_[10]=function(t,e,i,n){const s=t[3][n[0]];e[i]=Qh(t,s,n[1])},s_[11]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=1;e<n.length;e+=3){const i=n[e],r=n[e+1],o=n[e+2];(0,s_[r])(t,s,i,o)}},s_[12]=function(t,e,i,n){const s=n[0];e[i]=s;for(let e=0;e<s.length;++e){const i=s[e],r=n[e+1];0!==r&&(0,s_[r])(t,s,e,i)}},c_.Details=Jh,c_.reportMissingClass=function(t){A(5302,t)};class h_{constructor(t){this.preprocessed=!0,this.version=t}}function __(t,e,i){return[1,0,0,[t],0,i?[e,-1]:[e],[0],0,[],[],[]]}n.deserialize=c_;const u_=Me.Flags.Destroyed,m_=Me.Flags.PersistentMask,p_=[];function d_(t){let e;if(t instanceof Me){if(t._instantiate)return n.game._isCloning=!0,e=t._instantiate(null,!0),n.game._isCloning=!1,e;if(t instanceof n.Asset)throw new TypeError(D(6903))}return n.game._isCloning=!0,e=f_(t),n.game._isCloning=!1,e}function f_(t,e){let i;i=t._iN$t?t._iN$t:t.constructor?new(0,t.constructor):Object.create(null),g_(t,i,e);for(let t=0,e=p_.length;t<e;++t)p_[t]._iN$t=null;return p_.length=0,i}function g_(t,e,i){Ot.value(t,"_iN$t",e,!0),p_.push(t);const s=t.constructor;if(n.Class._isCCClass(s))!function(t,e,i,n){const s=t.__values__;for(let t=0;t<s.length;t++){const r=s[t],o=e[r];if("object"==typeof o&&o){const t=i[r];t instanceof Vt&&t.constructor===o.constructor?t.set(o):i[r]=o._iN$t||y_(o,n)}else i[r]=o}}(s,t,e,i);else for(const n in t){if(!t.hasOwnProperty(n)||95===n.charCodeAt(0)&&95===n.charCodeAt(1)&&"__type__"!==n)continue;const s=t[n];if("object"==typeof s&&s){if(s===e)continue;e[n]=s._iN$t||y_(s,i)}else e[n]=s}t instanceof Me&&(e._objFlags&=m_)}function y_(t,e){if(t instanceof Vt)return t.clone();if(t instanceof n.Asset)return t;let i;if(ArrayBuffer.isView(t)){const e=t.length;i=new t.constructor(e),t._iN$t=i,p_.push(t);for(let n=0;n<e;++n)i[n]=t[n];return i}if(Array.isArray(t)){const n=t.length;i=new Array(n),t._iN$t=i,p_.push(t);for(let s=0;s<n;++s){const n=t[s];i[s]="object"==typeof n&&n?n._iN$t||y_(n,e):n}return i}if(t._objFlags&u_)return null;const s=t.constructor;if(n.Class._isCCClass(s)){if(e)if(e instanceof n.Component){if(t instanceof n._BaseNode||t instanceof n.Component)return t}else if(e instanceof n._BaseNode)if(t instanceof n._BaseNode){if(!t.isChildOf(e))return t}else if(t instanceof n.Component&&t.node&&!t.node.isChildOf(e))return t;i=new s}else if(s===Object)i={};else{if(s)return t;i=Object.create(null)}return g_(t,i,e),i}var v_,x_,b_,S_,A_,C_,T_,w_;let E_,P_;function D_(t,e){return(e<<3)+t}function I_(t){return M_[t]}function R_(t){switch(t){case E_.Uint8:return Uint8Array;case E_.Uint16:return Uint16Array;case E_.Uint32:return Uint32Array;case E_.Int8:return Int8Array;case E_.Int16:return Int16Array;case E_.Int32:return Int32Array;case E_.Float32:return Float32Array;case E_.Float64:return Float64Array}}d_._clone=f_,n.instantiate=d_,function(t){t[t.Uint8=0]="Uint8",t[t.Uint16=1]="Uint16",t[t.Uint32=2]="Uint32",t[t.Int8=3]="Int8",t[t.Int16=4]="Int16",t[t.Int32=5]="Int32",t[t.Float32=6]="Float32",t[t.Float64=7]="Float64"}(E_||(E_={})),function(t){t[t.Scalar=0]="Scalar",t[t.Vec2=1]="Vec2",t[t.Vec3=2]="Vec3",t[t.Vec4=3]="Vec4",t[t.Quat=4]="Quat",t[t.Mat4=5]="Mat4"}(P_||(P_={})),t("CompactValueTypeArray",Vl("cc.CompactValueTypeArray")((w_=T_=class t{constructor(){Tl(this,"_byteOffset",b_,this),Tl(this,"_unitCount",S_,this),Tl(this,"_unitElement",A_,this),Tl(this,"_length",C_,this)}static lengthFor(t,e,i){return I_(e).requiredUnits*t.length*R_(i).BYTES_PER_ELEMENT}static compress(e,i,n,s,r,o){const a=I_(i),l=R_(n),c=a.requiredUnits*e.length,h=new l(s,r,c);for(let t=0;t<e.length;++t)a.compress(h,t,e[t]);const _=new t;return _._unitElement=D_(n,i),_._byteOffset=o,_._unitCount=c,_._length=e.length,_}decompress(t){const{storageUnit:e,elementType:i}={storageUnit:7&(n=this._unitElement),elementType:n>>3};var n;const s=I_(i),r=new(R_(e))(t,this._byteOffset,this._unitCount),o=new Array(this._length);for(let t=0;t<this._length;++t)o[t]=s.decompress(r,t);return o}},T_.StorageUnit=E_,T_.ElementType=P_,b_=wl((x_=w_).prototype,"_byteOffset",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),S_=wl(x_.prototype,"_unitCount",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),A_=wl(x_.prototype,"_unitElement",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return D_(E_.Uint8,P_.Scalar)}}),C_=wl(x_.prototype,"_length",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),v_=x_))||v_);const M_={[P_.Scalar]:{requiredUnits:1,compress(t,e,i){t[e]=i},decompress:(t,e)=>t[e]},[P_.Vec2]:{requiredUnits:2,compress(t,e,i){t[2*e]=i.x,t[2*e+1]=i.y},decompress:(t,e)=>new Ni(t[2*e],t[2*e+1])},[P_.Vec3]:{requiredUnits:3,compress(t,e,i){t[3*e]=i.x,t[3*e+1]=i.y,t[3*e+2]=i.z},decompress:(t,e)=>new Ni(t[3*e],t[3*e+1],t[3*e+2])},[P_.Vec4]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new rn(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[P_.Quat]:{requiredUnits:4,compress(t,e,i){t[4*e]=i.x,t[4*e+1]=i.y,t[4*e+2]=i.z,t[4*e+3]=i.w},decompress:(t,e)=>new ki(t[4*e],t[4*e+1],t[4*e+2],t[4*e+3])},[P_.Mat4]:{requiredUnits:16,compress(t,e,i){$i.toArray(t,i,16*e)},decompress:(t,e)=>$i.fromArray(new $i,t,16*e)}};function O_(){return 0}function B_(t){return t}function N_(t){return t*t}function L_(t){return t*(2-t)}function F_(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}function z_(t){return t*t*t}function V_(t){return--t*t*t+1}function U_(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}function G_(t){return t*t*t*t}function k_(t){return 1- --t*t*t*t}function H_(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}function j_(t){return t*t*t*t*t}function W_(t){return--t*t*t*t*t+1}function q_(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}function X_(t){return 1===t?1:1-Math.cos(t*Math.PI/2)}function Y_(t){return Math.sin(t*Math.PI/2)}function K_(t){return.5*(1-Math.cos(Math.PI*t))}function $_(t){return 0===t?0:Math.pow(1024,t-1)}function J_(t){return 1===t?1:1-Math.pow(2,-10*t)}function Z_(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}function Q_(t){return 1-Math.sqrt(1-t*t)}function tu(t){return Math.sqrt(1- --t*t)}function eu(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}function iu(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4))}function nu(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin(2*(t-e)*Math.PI/.4)+1)}function su(t){let e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin(2*(t-e)*Math.PI/.4)*.5+1)}function ru(t){if(1===t)return 1;const e=1.70158;return t*t*((e+1)*t-e)}function ou(t){if(0===t)return 0;const e=1.70158;return--t*t*((e+1)*t+e)+1}function au(t){const e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}function lu(t){return 1-cu(1-t)}function cu(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375}function hu(t){return t<.5?.5*lu(2*t):.5*cu(2*t-1)+.5}function _u(t){return t<=0?0:t>=1?1:t*t*(3-2*t)}function uu(t){return t<=0?0:t>=1?1:t*t*t*(t*(6*t-15)+10)}n._decorator=Rc;const mu=Au(N_,L_),pu=Au(z_,V_),du=Au(G_,k_),fu=Au(j_,W_),gu=Au(X_,Y_),yu=Au($_,J_),vu=Au(Q_,tu),xu=Au(iu,nu),bu=Au(ru,ou),Su=Au(lu,cu);function Au(t,e){return i=>i<.5?e(2*i)/2:t(2*i-1)/2+.5}var Cu=Object.freeze({__proto__:null,constant:O_,linear:B_,quadIn:N_,quadOut:L_,quadInOut:F_,cubicIn:z_,cubicOut:V_,cubicInOut:U_,quartIn:G_,quartOut:k_,quartInOut:H_,quintIn:j_,quintOut:W_,quintInOut:q_,sineIn:X_,sineOut:Y_,sineInOut:K_,expoIn:$_,expoOut:J_,expoInOut:Z_,circIn:Q_,circOut:tu,circInOut:eu,elasticIn:iu,elasticOut:nu,elasticInOut:su,backIn:ru,backOut:ou,backInOut:au,bounceIn:lu,bounceOut:cu,bounceInOut:hu,smooth:_u,fade:uu,quadOutIn:mu,cubicOutIn:pu,quartOutIn:du,quintOutIn:fu,sineOutIn:gu,expoOutIn:yu,circOutIn:vu,elasticOutIn:xu,backOutIn:bu,bounceOutIn:Su});let Tu;t("easing",Cu),function(t){t[t.LINEAR=0]="LINEAR",t[t.CONSTANT=1]="CONSTANT",t[t.QUAD_IN=2]="QUAD_IN",t[t.QUAD_OUT=3]="QUAD_OUT",t[t.QUAD_IN_OUT=4]="QUAD_IN_OUT",t[t.QUAD_OUT_IN=5]="QUAD_OUT_IN",t[t.CUBIC_IN=6]="CUBIC_IN",t[t.CUBIC_OUT=7]="CUBIC_OUT",t[t.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",t[t.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",t[t.QUART_IN=10]="QUART_IN",t[t.QUART_OUT=11]="QUART_OUT",t[t.QUART_IN_OUT=12]="QUART_IN_OUT",t[t.QUART_OUT_IN=13]="QUART_OUT_IN",t[t.QUINT_IN=14]="QUINT_IN",t[t.QUINT_OUT=15]="QUINT_OUT",t[t.QUINT_IN_OUT=16]="QUINT_IN_OUT",t[t.QUINT_OUT_IN=17]="QUINT_OUT_IN",t[t.SINE_IN=18]="SINE_IN",t[t.SINE_OUT=19]="SINE_OUT",t[t.SINE_IN_OUT=20]="SINE_IN_OUT",t[t.SINE_OUT_IN=21]="SINE_OUT_IN",t[t.EXPO_IN=22]="EXPO_IN",t[t.EXPO_OUT=23]="EXPO_OUT",t[t.EXPO_IN_OUT=24]="EXPO_IN_OUT",t[t.EXPO_OUT_IN=25]="EXPO_OUT_IN",t[t.CIRC_IN=26]="CIRC_IN",t[t.CIRC_OUT=27]="CIRC_OUT",t[t.CIRC_IN_OUT=28]="CIRC_IN_OUT",t[t.CIRC_OUT_IN=29]="CIRC_OUT_IN",t[t.ELASTIC_IN=30]="ELASTIC_IN",t[t.ELASTIC_OUT=31]="ELASTIC_OUT",t[t.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",t[t.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",t[t.BACK_IN=34]="BACK_IN",t[t.BACK_OUT=35]="BACK_OUT",t[t.BACK_IN_OUT=36]="BACK_IN_OUT",t[t.BACK_OUT_IN=37]="BACK_OUT_IN",t[t.BOUNCE_IN=38]="BOUNCE_IN",t[t.BOUNCE_OUT=39]="BOUNCE_OUT",t[t.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",t[t.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",t[t.SMOOTH=42]="SMOOTH",t[t.FADE=43]="FADE"}(Tu||(Tu={}));const wu={[Tu.CONSTANT]:O_,[Tu.LINEAR]:B_,[Tu.QUAD_IN]:N_,[Tu.QUAD_OUT]:L_,[Tu.QUAD_IN_OUT]:F_,[Tu.QUAD_OUT_IN]:mu,[Tu.CUBIC_IN]:z_,[Tu.CUBIC_OUT]:V_,[Tu.CUBIC_IN_OUT]:U_,[Tu.CUBIC_OUT_IN]:pu,[Tu.QUART_IN]:G_,[Tu.QUART_OUT]:k_,[Tu.QUART_IN_OUT]:H_,[Tu.QUART_OUT_IN]:du,[Tu.QUINT_IN]:j_,[Tu.QUINT_OUT]:W_,[Tu.QUINT_IN_OUT]:q_,[Tu.QUINT_OUT_IN]:fu,[Tu.SINE_IN]:X_,[Tu.SINE_OUT]:Y_,[Tu.SINE_IN_OUT]:K_,[Tu.SINE_OUT_IN]:gu,[Tu.EXPO_IN]:$_,[Tu.EXPO_OUT]:J_,[Tu.EXPO_IN_OUT]:Z_,[Tu.EXPO_OUT_IN]:yu,[Tu.CIRC_IN]:Q_,[Tu.CIRC_OUT]:tu,[Tu.CIRC_IN_OUT]:eu,[Tu.CIRC_OUT_IN]:vu,[Tu.ELASTIC_IN]:iu,[Tu.ELASTIC_OUT]:nu,[Tu.ELASTIC_IN_OUT]:su,[Tu.ELASTIC_OUT_IN]:xu,[Tu.BACK_IN]:ru,[Tu.BACK_OUT]:ou,[Tu.BACK_IN_OUT]:au,[Tu.BACK_OUT_IN]:bu,[Tu.BOUNCE_IN]:lu,[Tu.BOUNCE_OUT]:cu,[Tu.BOUNCE_IN_OUT]:hu,[Tu.BOUNCE_OUT_IN]:Su,[Tu.SMOOTH]:_u,[Tu.FADE]:uu};function Eu(t){return wu[t]}var Pu,Du,Iu,Ru,Mu,Ou,Bu,Nu,Lu,Fu,zu,Vu,Uu,Gu;let ku=Vl("cc.RealKeyframeValue")(Pu=Kl((Iu=wl((Du=class extends Ic{constructor({interpolationMode:t,tangentWeightMode:e,value:i,rightTangent:n,rightTangentWeight:s,leftTangent:r,leftTangentWeight:o,easingMethod:a,[De]:l}={}){super(),Tl(this,"interpolationMode",Iu,this),Tl(this,"tangentWeightMode",Ru,this),Tl(this,"value",Mu,this),Tl(this,"rightTangent",Ou,this),Tl(this,"rightTangentWeight",Bu,this),Tl(this,"leftTangent",Nu,this),Tl(this,"leftTangentWeight",Lu,this),Tl(this,"easingMethod",Fu,this),this.value=null!=i?i:this.value,this.rightTangent=null!=n?n:this.rightTangent,this.rightTangentWeight=null!=s?s:this.rightTangentWeight,this.leftTangent=null!=r?r:this.leftTangent,this.leftTangentWeight=null!=o?o:this.leftTangentWeight,this.interpolationMode=null!=t?t:this.interpolationMode,this.tangentWeightMode=null!=e?e:this.tangentWeightMode,this.easingMethod=null!=a?a:this.easingMethod,l&&(this[De]=l)}}).prototype,"interpolationMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tc.LINEAR}}),Ru=wl(Du.prototype,"tangentWeightMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ec.NONE}}),Mu=wl(Du.prototype,"value",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ou=wl(Du.prototype,"rightTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bu=wl(Du.prototype,"rightTangentWeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Nu=wl(Du.prototype,"leftTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lu=wl(Du.prototype,"leftTangentWeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fu=wl(Du.prototype,"easingMethod",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tu.LINEAR}}),Pu=Du))||Pu)||Pu;function Hu(t){return new ku("number"==typeof t?{value:t}:t)}let ju=t("RealCurve",Vl("cc.RealCurve")((Uu=wl((Vu=class extends Pc{constructor(...t){super(...t),Tl(this,"preExtrapolation",Uu,this),Tl(this,"postExtrapolation",Gu,this)}evaluate(t){const{_times:e,_values:i}=this,n=e.length;if(0===n)return 0;const s=e[0],r=e[n-1];if(t<s){const{preExtrapolation:o}=this,a=i[0];if(o===wc.CLAMP||n<2)return a.value;switch(o){case wc.LINEAR:return om(s,i[0].value,e[1],i[1].value,t);case wc.LOOP:t=sm(t,s,r);break;case wc.PING_PONG:t=rm(t,s,r);break;default:return a.value}}else if(t>r){const{postExtrapolation:o}=this,a=i[n-1];if(o===wc.CLAMP||n<2)return a.value;switch(o){case wc.LINEAR:return om(r,a.value,e[n-2],i[n-2].value,t);case wc.LOOP:t=sm(t,s,r);break;case wc.PING_PONG:t=rm(t,s,r);break;default:return a.value}}const o=Il(e,t);if(o>=0)return i[o].value;const a=~o,l=a-1,c=e[l],h=i[l],_=e[a];return function(t,e,i,n,s){const r=i-t;switch(e.interpolationMode){default:case Tc.CONSTANT:return e.value;case Tc.LINEAR:{const t=e.easingMethod===Tu.LINEAR?s:Eu(e.easingMethod)(s);return pi(e.value,n.value,t)}case Tc.CUBIC:{const o=1/3,{rightTangent:a,rightTangentWeight:l}=e,c=0!=(e.tangentWeightMode&Ec.RIGHT),{leftTangent:h,leftTangentWeight:_}=n,u=0!=(n.tangentWeightMode&Ec.LEFT);if(c||u){let m=0;if(c)m=l;else{const t=r,e=r*a;m=Math.sqrt(t*t+e*e)*o}const p=Math.atan(a),d=Math.cos(p)*m+t,f=Math.sin(p)*m+e.value;let g=0;if(u)g=_;else{const t=r,e=r*h;g=Math.sqrt(t*t+e*e)*o}const y=Math.atan(h),v=(d-t)/r,x=(-Math.cos(y)*g+i-t)/r,b=f,S=-Math.sin(y)*g+n.value,A=[0,0,0],C=function(t,e,i,n,s){const r=i/n,o=e/n,a=r*r,l=1/3*(-1/3*a+o),c=.5*(2/27*r*a-1/3*r*o+t/n),h=l*l*l,_=c*c+h;let u=0;if(Dc(_)){if(Dc(c))return s[0]=0,1;{const t=Math.cbrt(-c);return s[0]=2*t,s[1]=-t,2}}if(_<0){const t=1/3*Math.acos(-c/Math.sqrt(-h)),e=2*Math.sqrt(-l);s[0]=e*Math.cos(t),s[1]=-e*Math.cos(t+Math.PI/3),s[2]=-e*Math.cos(t-Math.PI/3),u=3}else{const t=Math.sqrt(_),e=Math.cbrt(t-c),i=-Math.cbrt(t+c);s[0]=e+i,u=1}const m=1/3*r;for(let t=0;t<u;++t)s[t]-=m;return u}(0-s,3*v,3*x-6*v,3*(v-x)+1,A),T=function(t,e,i){let n=i;if(1===e)n=t[0];else{n=-1/0;for(let i=0;i<e;++i){const e=t[i];e>=0&&e<=1&&e>n&&(n=e)}n===-1/0&&(n=0)}return n}(A,C,s);return am(e.value,b,S,n.value,T)}{const t=e.value+o*a*r,i=n.value-o*h*r;return am(e.value,t,i,n.value,s)}}}}(c,h,_,i[a],(t-c)/(_-c))}addKeyFrame(t,e){return super.addKeyFrame(t,Hu(e))}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>Hu(t))));else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>Hu(t))))}}isConstant(t){if(this._values.length<=1)return!0;const e=this._values[0].value;return this._values.every((i=>_i(i.value,e,t)))}[Fh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:n}=this,s=i.length,r=new DataView(new ArrayBuffer(0+qu+qu+Xu+Yu*s+em*s));let o=0;r.setUint8(o,this.preExtrapolation),o+=qu,r.setUint8(o,this.postExtrapolation),o+=qu,r.setUint32(o,s,!0),o+=Xu,i.forEach(((t,e)=>r.setFloat32(o+Yu*e,t,!0))),o+=Yu*s;for(const t of n)o=im(r,t,o);const a=new Uint8Array(r.buffer,0,o);t.writeProperty("bytes",a);const l=n.map((t=>t[De]));l.some((t=>void 0!==t))&&t.writeProperty("keyframeValueEditorExtras",l)}[zh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;this.preExtrapolation=n.getUint8(s),s+=qu,this.postExtrapolation=n.getUint8(s),s+=qu;const r=n.getUint32(s,!0);s+=Xu;const o=Array.from({length:r},((t,e)=>n.getFloat32(s+Yu*e,!0)));s+=Yu*r;const a=new Array(r);for(let t=0;t<r;++t){const e=Hu({});s=nm(n,e,s),a[t]=e}i.byteLength;const l=t.readProperty("keyframeValueEditorExtras");l&&(l.length,l.forEach(((t,e)=>a[e][De]=t))),this._times=o,this._values=a}}).prototype,"preExtrapolation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wc.CLAMP}}),Gu=wl(Vu.prototype,"postExtrapolation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wc.CLAMP}}),zu=Vu))||zu);var Wu;!function(t){t[t.VALUE=1]="VALUE",t[t.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",t[t.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",t[t.LEFT_TANGENT=8]="LEFT_TANGENT",t[t.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",t[t.RIGHT_TANGENT=32]="RIGHT_TANGENT",t[t.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(Wu||(Wu={}));const qu=1,Xu=4,Yu=4,{interpolationMode:Ku,tangentWeightMode:$u,leftTangent:Ju,leftTangentWeight:Zu,rightTangent:Qu,rightTangentWeight:tm}=Hu({}),em=26;function im(t,e,i){let n=0,s=i;const r=s;s+=4;const{value:o,interpolationMode:a,tangentWeightMode:l,rightTangent:c,rightTangentWeight:h,leftTangent:_,leftTangentWeight:u,easingMethod:m}=e;return t.setFloat32(s,o,!0),s+=4,a!==Ku&&(n|=Wu.INTERPOLATION_MODE,t.setUint8(s,a),s+=1),l!==$u&&(n|=Wu.TANGENT_WEIGHT_MODE,t.setUint8(s,l),s+=1),_!==Ju&&(n|=Wu.LEFT_TANGENT,t.setFloat32(s,_,!0),s+=4),u!==Zu&&(n|=Wu.LEFT_TANGENT_WEIGHT,t.setFloat32(s,u,!0),s+=4),c!==Qu&&(n|=Wu.RIGHT_TANGENT,t.setFloat32(s,c,!0),s+=4),h!==tm&&(n|=Wu.RIGHT_TANGENT_WEIGHT,t.setFloat32(s,h,!0),s+=4),n|=m<<8,t.setUint32(r,n,!0),s}function nm(t,e,i){let n=i;const s=t.getUint32(n,!0);n+=4,e.value=t.getFloat32(n,!0),n+=4,s&Wu.INTERPOLATION_MODE&&(e.interpolationMode=t.getUint8(n),n+=1),s&Wu.TANGENT_WEIGHT_MODE&&(e.tangentWeightMode=t.getUint8(n),n+=1),s&Wu.LEFT_TANGENT&&(e.leftTangent=t.getFloat32(n,!0),n+=4),s&Wu.LEFT_TANGENT_WEIGHT&&(e.leftTangentWeight=t.getFloat32(n,!0),n+=4),s&Wu.RIGHT_TANGENT&&(e.rightTangent=t.getFloat32(n,!0),n+=4),s&Wu.RIGHT_TANGENT_WEIGHT&&(e.rightTangentWeight=t.getFloat32(n,!0),n+=4);const r=(65280&s)>>8;return e.easingMethod=r,n}function sm(t,e,i){return e+Ci(t-e,i-e)}function rm(t,e,i){return e+Ti(t-e,i-e)}function om(t,e,i,n,s){return e+(n-e)/(i-t)*(s-t)}function am(t,e,i,n,s){const r=1-s;return r*r*r*t+3*r*r*s*e+3*r*s*s*i+s*s*s*n}function lm(t,e,i,n,s){const r=1-s;return r*(r*(t+(3*e-t)*s)+3*i*s*s)+n*s*s*s}n.bezier=lm;const cm=Math.cos,hm=Math.acos,_m=Math.max,um=2*Math.PI,mm=Math.sqrt;function pm(t){return t<0?-Math.pow(-t,1/3):Math.pow(t,1/3)}function dm(t,e){const i=function(t,e){const i=e-0,n=e-t[0],s=3*i,r=3*n,o=3*(e-t[2]),a=1/(-i+r-o+(e-1)),l=1/3,c=(s-6*n+o)*a,h=c*l,_=(-s+r)*a,u=(3*_-c*c)*l,m=u*l,p=(2*c*c*c-9*c*_+i*a*27)/27,d=p/2,f=d*d+m*m*m;let g,y,v,x,b;if(f<0){const t=-u*l,e=mm(t*t*t),i=-p/(2*e),n=hm(i<-1?-1:i>1?1:i),s=2*pm(e);return v=s*cm(n*l)-h,x=s*cm((n+um)*l)-h,b=s*cm((n+2*um)*l)-h,v>=0&&v<=1?x>=0&&x<=1?b>=0&&b<=1?_m(v,x,b):_m(v,x):b>=0&&b<=1?_m(v,b):v:x>=0&&x<=1?b>=0&&b<=1?_m(x,b):x:b}if(0===f)return g=d<0?pm(-d):-pm(d),v=2*g-h,x=-g-h,v>=0&&v<=1?x>=0&&x<=1?_m(v,x):v:x;{const t=mm(f);return g=pm(-d+t),y=pm(d+t),v=g-y-h,v}}(t,e),n=t[1];return((1-i)*(n+(t[3]-n)*i)*3+i*i)*i}var fm,gm,ym,vm,xm,bm,Sm,Am,Cm;let Tm;n.bezierByTime=dm,function(t){t[t.SLERP=0]="SLERP",t[t.CONSTANT=1]="CONSTANT"}(Tm||(Tm=t("QuatInterpolationMode",{})));let wm=Vl("cc.QuatKeyframeValue")(fm=Kl((ym=wl((gm=class{constructor({value:t,interpolationMode:e,easingMethod:i}={}){Tl(this,"interpolationMode",ym,this),Tl(this,"value",vm,this),Tl(this,"easingMethod",xm,this),this.value=t?ki.clone(t):this.value,this.interpolationMode=null!=e?e:this.interpolationMode,this.easingMethod=null!=i?i:this.easingMethod}}).prototype,"interpolationMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tm.SLERP}}),vm=wl(gm.prototype,"value",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ki.clone(ki.IDENTITY)}}),xm=wl(gm.prototype,"easingMethod",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tu.LINEAR}}),fm=gm))||fm)||fm;function Em(t){return new wm(t)}let Pm=t("QuatCurve",Vl("cc.QuatCurve")((Am=wl((Sm=class extends Pc{constructor(...t){super(...t),Tl(this,"preExtrapolation",Am,this),Tl(this,"postExtrapolation",Cm,this)}evaluate(t,e){var i;null!==(i=e)&&void 0!==i||(e=new ki);const{_times:n,_values:s,postExtrapolation:r,preExtrapolation:o}=this,a=n.length;if(0===a)return e;const l=n[0],c=n[a-1];if(t<l){const i=s[0];switch(o){case wc.LOOP:t=l+Ci(t-l,c-l);break;case wc.PING_PONG:t=l+Ti(t-l,c-l);break;case wc.CLAMP:default:return ki.copy(e,i.value)}}else if(t>c){const i=s[a-1];switch(r){case wc.LOOP:t=l+Ci(t-l,c-l);break;case wc.PING_PONG:t=l+Ti(t-l,c-l);break;case wc.CLAMP:default:return ki.copy(e,i.value)}}const h=Il(n,t);if(h>=0)return ki.copy(e,s[h].value);const _=~h,u=_-1,m=n[u],p=s[u],d=n[_],f=s[_],g=(t-m)/(d-m);switch(p.interpolationMode){default:case Tm.CONSTANT:return ki.copy(e,p.value);case Tm.SLERP:{const{easingMethod:t}=p,i=t===Tu.LINEAR?g:Array.isArray(t)?dm(t,g):Eu(t)(g);return ki.slerp(e,p.value,f.value,i)}}}addKeyFrame(t,e){const i=new wm(e);return super.addKeyFrame(t,i)}assignSorted(t,e){if(void 0!==e)this.setKeyframes(t.slice(),e.map((t=>Em(t))));else{const e=Array.from(t);this.setKeyframes(e.map((([t])=>t)),e.map((([,t])=>Em(t))))}}[Fh](t,e){if(!e.toCCON)return void t.writeThis();const{_times:i,_values:n}=this;let s=!0;n.forEach(((t,e,[i])=>{s&&t.interpolationMode!==i.interpolationMode&&(s=!1)}));const r=i.length,o=Bm*(s?1:r),a=n.reduce(((t,{easingMethod:e})=>t+(Array.isArray(e)?Nm+4*Fm:Nm)),0);let l=0;l+=Im+Rm+Mm*r+4*Om*r+a+o+0;const c=new DataView(new ArrayBuffer(l));let h=0,_=0;s&&(_|=Dm.INTERPOLATION_MODE),c.setUint32(h,_,!0),h+=Im,c.setUint32(h,r,!0),h+=Rm,i.forEach(((t,e)=>c.setFloat32(h+Mm*e,t,!0))),h+=Mm*r,n.forEach((({value:{x:t,y:e,z:i,w:n}},s)=>{const r=h+4*Om*s;c.setFloat32(r+0*Om,t,!0),c.setFloat32(r+1*Om,e,!0),c.setFloat32(r+2*Om,i,!0),c.setFloat32(r+3*Om,n,!0)})),h+=4*Om*r,n.forEach((({easingMethod:t})=>{Array.isArray(t)?(c.setUint8(h,Lm),++h,c.setFloat32(h+0*Fm,t[0],!0),c.setFloat32(h+1*Fm,t[1],!0),c.setFloat32(h+2*Fm,t[2],!0),c.setFloat32(h+3*Fm,t[3],!0),h+=4*Fm):(c.setUint8(h,t),++h)}));const u=h;h+=o;let m=u;n.forEach((({interpolationMode:t})=>{c.setUint8(m,t),s||(m+=Bm)}));const p=new Uint8Array(c.buffer);t.writeProperty("bytes",p)}[zh](t,e){if(!e.fromCCON)return void t.readThis();const i=t.readProperty("bytes"),n=new DataView(i.buffer,i.byteOffset,i.byteLength);let s=0;const r=n.getUint32(s,!0);s+=Im;const o=r&Dm.INTERPOLATION_MODE,a=n.getUint32(s,!0);s+=Rm;const l=Array.from({length:a},((t,e)=>n.getFloat32(s+Mm*e,!0)));s+=Mm*a;const c=s;s+=4*Om*a;const h=Array.from({length:a},((t,e)=>{const i=c+4*Om*e,r=n.getFloat32(i+0*Om,!0),o=n.getFloat32(i+1*Om,!0),a=n.getFloat32(i+2*Om,!0),l=n.getFloat32(i+3*Om,!0),h=n.getUint8(s);++s;const _=Em({value:{x:r,y:o,z:a,w:l}});return h!==Lm?_.easingMethod=h:(_.easingMethod=[n.getFloat32(s+0*Fm,!0),n.getFloat32(s+1*Fm,!0),n.getFloat32(s+2*Fm,!0),n.getFloat32(s+3*Fm,!0)],s+=4*Fm),_}));if(o){const t=n.getUint8(s);++s;for(let e=0;e<a;++e)h[e].interpolationMode=t}else{for(let t=0;t<a;++t){const e=n.getUint8(s+t);h[t].interpolationMode=e}s+=a}this._times=l,this._values=h}}).prototype,"preExtrapolation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wc.CLAMP}}),Cm=wl(Sm.prototype,"postExtrapolation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wc.CLAMP}}),bm=Sm))||bm);var Dm;!function(t){t[t.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(Dm||(Dm={}));const Im=1,Rm=4,Mm=4,Om=4,Bm=1,Nm=1,Lm=255,Fm=4;var zm;let Vm=t("ObjectCurve",Vl("cc.ObjectCurve")(zm=class extends Pc{evaluate(t){const e=this.searchKeyframe(t);if(e>=0)return this._values[e];const i=ui(~e-1,0,this._values.length-1);return this._values[i]}})||zm);var Um,Gm,km,Hm,jm;class Wm{constructor(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0}}we.fastDefine("cc.Keyframe",Wm,{time:0,value:0,inTangent:0,outTangent:0});class qm{constructor(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}evaluate(t){return e=t-this.time,i=this.coefficient,e*(e*(e*i[0]+i[1])+i[2])+i[3];var e,i}}let Xm=Vl("cc.AnimationCurve")((jm=Hm=class{get _internalCurve(){return this._curve}get keyFrames(){return Array.from(this._curve.keyframes()).map((([t,e])=>{const i=new Wm;return i.time=t,i.value=e.value,i.inTangent=e.leftTangent,i.outTangent=e.rightTangent,i}))}set keyFrames(t){this._curve.assignSorted(t.map((t=>[t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}])))}get preWrapMode(){return Km(this._curve.preExtrapolation)}set preWrapMode(t){this._curve.preExtrapolation=Ym(t)}get postWrapMode(){return Km(this._curve.postExtrapolation)}set postWrapMode(t){this._curve.postExtrapolation=Ym(t)}constructor(t=null){if(Tl(this,"_curve",km,this),this.cachedKey=void 0,t instanceof ju)this._curve=t;else{const e=new ju;this._curve=e,e.preExtrapolation=wc.LOOP,e.postExtrapolation=wc.CLAMP,t?e.assignSorted(t.map((t=>[t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}]))):e.assignSorted([[0,{interpolationMode:Tc.CUBIC,value:1}],[1,{interpolationMode:Tc.CUBIC,value:1}]])}this.cachedKey=new qm}addKey(t){t?this._curve.addKeyFrame(t.time,{interpolationMode:Tc.CUBIC,value:t.value,leftTangent:t.inTangent,rightTangent:t.outTangent}):this._curve.clear()}evaluate_slow(t){return this._curve.evaluate(t)}evaluate(t){const{cachedKey:e,_curve:i}=this,n=i.keyFramesCount-1;let s=t;const r=t<0?i.preExtrapolation:i.postExtrapolation,o=i.getKeyframeTime(0),a=i.getKeyframeTime(n);switch(r){case wc.LOOP:s=Ci(t-o,a-o)+o;break;case wc.PING_PONG:s=Ti(t-o,a-o)+o;break;case wc.CLAMP:default:s=ui(t,o,a)}if(s>=e.time&&s<e.endTime)return e.evaluate(s);const l=this.findIndex(e,s),c=Math.min(l+1,n);return this.calcOptimizedKey(e,l,c),e.evaluate(s)}calcOptimizedKey(t,e,i){const n=this._curve.getKeyframeTime(e),s=this._curve.getKeyframeTime(i),{value:r,leftTangent:o}=this._curve.getKeyframeValue(e),{value:a,rightTangent:l}=this._curve.getKeyframeValue(i);t.index=e,t.time=n,t.endTime=s;const c=s-n,h=a-r,_=1/(c*c),u=o*c,m=l*c;t.coefficient[0]=(u+m-h-h)*_/c,t.coefficient[1]=(h+h+h-u-u-m)*_,t.coefficient[2]=o,t.coefficient[3]=r}findIndex(t,e){const{_curve:i}=this,n=i.keyFramesCount,s=t.index;if(-1!==s)if(e>i.getKeyframeTime(s))for(let t=0;t<3;t++){const r=s+t;if(r+1<n&&i.getKeyframeTime(r+1)>e)return r}else for(let t=0;t<3;t++){const n=s-t;if(n>=0&&i.getKeyframeTime(n-1)<=e)return n-1}let r,o=0,a=n;for(;a-o>1;)r=Math.floor((o+a)/2),i.getKeyframeTime(r)>=e?a=r:o=r;return o}},Hm.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],km=wl((Gm=jm).prototype,"_curve",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Um=Gm))||Um;function Ym(t){switch(t){default:case El.Default:case El.Normal:case El.Clamp:return wc.CLAMP;case El.PingPong:return wc.PING_PONG;case El.Loop:return wc.LOOP}}function Km(t){switch(t){default:case wc.LINEAR:case wc.CLAMP:return El.Clamp;case wc.PING_PONG:return El.PingPong;case wc.LOOP:return El.Loop}}function $m(t,e){console.warn(`${t} is deprecated, please use ${e} instead.`)}Ze(Ha,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Jm=Object.freeze({__proto__:null,distance:fs,enums:gs,intersect:Ha,Line:ys,Plane:Ya,Ray:vs,Triangle:ws,Sphere:Ts,AABB:gl,OBB:bl,Capsule:Sl,Frustum:Cl,Keyframe:Wm,AnimationCurve:Xm,get ERaycastMode(){return ra},line:class extends ys{constructor(){super(),$m("line","Line")}},plane:class extends Ya{constructor(){super(),$m("plane","Plane")}},ray:class extends vs{constructor(){super(),$m("ray","Ray")}},triangle:class extends ws{constructor(){super(),$m("triangle","Triangle")}},sphere:class extends Ts{constructor(){super(),$m("sphere","Sphere")}},aabb:class extends gl{constructor(){super(),$m("aabb","AABB")}},obb:class extends bl{constructor(){super(),$m("obb","OBB")}},capsule:class extends Sl{constructor(){super(),$m("capsule","Capsule")}},frustum:class extends Cl{constructor(){super(),$m("frustum","Frustum")}}});t("geometry",Jm);const Zm={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295};class Qm{static makeMaskInclude(t){let e=0;for(const i of t)e|=i;return e}static makeMaskExclude(t){return~Qm.makeMaskInclude(t)}static addLayer(t,e){void 0!==e?e>19||e<0?console.warn("maximum layers reached."):(Qm.Enum[t]=1<<e,Qm.Enum[e]=t,Qm.BitMask[t]=1<<e,Qm.BitMask[e]=t):console.warn("bitNum can't be undefined")}static deleteLayer(t){t>19||t<0?console.warn("do not change buildin layers."):(delete Qm.Enum[Qm.Enum[t]],delete Qm.Enum[t],delete Qm.BitMask[Qm.BitMask[t]],delete Qm.BitMask[t])}static nameToLayer(t){return void 0===t?(console.warn("name can't be undefined"),-1):Xe(Qm.Enum[t])}static layerToName(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):Qm.Enum[t]}}let tp,ep;t("Layers",Qm),Qm.Enum=Nt(Zm),Qm.BitMask=Bt({...Zm}),n.Layers=Qm,function(t){t[t.DEFAULT=100]="DEFAULT",t[t.UI=200]="UI"}(tp||(tp={})),n.RenderPassStage=tp,function(t){t[t.MIN=0]="MIN",t[t.MAX=255]="MAX",t[t.DEFAULT=128]="DEFAULT"}(ep||(ep={}));const ip={bindings:[],layouts:{}},np={bindings:[],layouts:{}};let sp;!function(t){t[t.UBO_GLOBAL=0]="UBO_GLOBAL",t[t.UBO_CAMERA=1]="UBO_CAMERA",t[t.UBO_SHADOW=2]="UBO_SHADOW",t[t.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",t[t.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",t[t.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",t[t.SAMPLER_GBUFFER_ALBEDOMAP=6]="SAMPLER_GBUFFER_ALBEDOMAP",t[t.SAMPLER_GBUFFER_POSITIONMAP=7]="SAMPLER_GBUFFER_POSITIONMAP",t[t.SAMPLER_GBUFFER_NORMALMAP=8]="SAMPLER_GBUFFER_NORMALMAP",t[t.SAMPLER_GBUFFER_EMISSIVEMAP=9]="SAMPLER_GBUFFER_EMISSIVEMAP",t[t.SAMPLER_LIGHTING_RESULTMAP=10]="SAMPLER_LIGHTING_RESULTMAP",t[t.COUNT=11]="COUNT"}(sp||(sp={}));const rp=sp.SAMPLER_SHADOWMAP,op=sp.COUNT-rp;let ap;!function(t){t[t.UBO_LOCAL=0]="UBO_LOCAL",t[t.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",t[t.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",t[t.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",t[t.UBO_MORPH=4]="UBO_MORPH",t[t.SAMPLER_JOINTS=5]="SAMPLER_JOINTS",t[t.SAMPLER_MORPH_POSITION=6]="SAMPLER_MORPH_POSITION",t[t.SAMPLER_MORPH_NORMAL=7]="SAMPLER_MORPH_NORMAL",t[t.SAMPLER_MORPH_TANGENT=8]="SAMPLER_MORPH_TANGENT",t[t.SAMPLER_LIGHTMAP=9]="SAMPLER_LIGHTMAP",t[t.SAMPLER_SPRITE=10]="SAMPLER_SPRITE",t[t.SAMPLER_REFLECTION=11]="SAMPLER_REFLECTION",t[t.STORAGE_REFLECTION=12]="STORAGE_REFLECTION",t[t.COUNT=13]="COUNT"}(ap||(ap={}));const lp=ap.SAMPLER_JOINTS,cp=ap.COUNT-lp;let hp;!function(t){t[t.GLOBAL=0]="GLOBAL",t[t.MATERIAL=1]="MATERIAL",t[t.LOCAL=2]="LOCAL"}(hp||(hp={}));const _p=new Er;_p.bufferOffsets=[0,rp+lp,rp],_p.samplerOffsets=[-rp,op+cp,op-lp],_p.flexibleSet=1;class up{}up.TIME_OFFSET=0,up.NATIVE_SIZE_OFFSET=up.TIME_OFFSET+4,up.SCREEN_SIZE_OFFSET=up.NATIVE_SIZE_OFFSET+4,up.COUNT=up.SCREEN_SIZE_OFFSET+4,up.SIZE=4*up.COUNT,up.NAME="CCGlobal",up.BINDING=sp.UBO_GLOBAL,up.DESCRIPTOR=new io(up.BINDING,hr.UNIFORM_BUFFER,1,Js.ALL),up.LAYOUT=new Fr(hp.GLOBAL,up.BINDING,up.NAME,[new Lr("cc_time",Ns.FLOAT4,1),new Lr("cc_screenSize",Ns.FLOAT4,1),new Lr("cc_nativeSize",Ns.FLOAT4,1)],1),ip.layouts[up.NAME]=up.LAYOUT,ip.bindings[up.BINDING]=up.DESCRIPTOR;class mp{}mp.MAT_VIEW_OFFSET=0,mp.MAT_VIEW_INV_OFFSET=mp.MAT_VIEW_OFFSET+16,mp.MAT_PROJ_OFFSET=mp.MAT_VIEW_INV_OFFSET+16,mp.MAT_PROJ_INV_OFFSET=mp.MAT_PROJ_OFFSET+16,mp.MAT_VIEW_PROJ_OFFSET=mp.MAT_PROJ_INV_OFFSET+16,mp.MAT_VIEW_PROJ_INV_OFFSET=mp.MAT_VIEW_PROJ_OFFSET+16,mp.CAMERA_POS_OFFSET=mp.MAT_VIEW_PROJ_INV_OFFSET+16,mp.SCREEN_SCALE_OFFSET=mp.CAMERA_POS_OFFSET+4,mp.EXPOSURE_OFFSET=mp.SCREEN_SCALE_OFFSET+4,mp.MAIN_LIT_DIR_OFFSET=mp.EXPOSURE_OFFSET+4,mp.MAIN_LIT_COLOR_OFFSET=mp.MAIN_LIT_DIR_OFFSET+4,mp.AMBIENT_SKY_OFFSET=mp.MAIN_LIT_COLOR_OFFSET+4,mp.AMBIENT_GROUND_OFFSET=mp.AMBIENT_SKY_OFFSET+4,mp.GLOBAL_FOG_COLOR_OFFSET=mp.AMBIENT_GROUND_OFFSET+4,mp.GLOBAL_FOG_BASE_OFFSET=mp.GLOBAL_FOG_COLOR_OFFSET+4,mp.GLOBAL_FOG_ADD_OFFSET=mp.GLOBAL_FOG_BASE_OFFSET+4,mp.COUNT=mp.GLOBAL_FOG_ADD_OFFSET+4,mp.SIZE=4*mp.COUNT,mp.NAME="CCCamera",mp.BINDING=sp.UBO_CAMERA,mp.DESCRIPTOR=new io(mp.BINDING,hr.UNIFORM_BUFFER,1,Js.ALL),mp.LAYOUT=new Fr(hp.GLOBAL,mp.BINDING,mp.NAME,[new Lr("cc_matView",Ns.MAT4,1),new Lr("cc_matViewInv",Ns.MAT4,1),new Lr("cc_matProj",Ns.MAT4,1),new Lr("cc_matProjInv",Ns.MAT4,1),new Lr("cc_matViewProj",Ns.MAT4,1),new Lr("cc_matViewProjInv",Ns.MAT4,1),new Lr("cc_cameraPos",Ns.FLOAT4,1),new Lr("cc_screenScale",Ns.FLOAT4,1),new Lr("cc_exposure",Ns.FLOAT4,1),new Lr("cc_mainLitDir",Ns.FLOAT4,1),new Lr("cc_mainLitColor",Ns.FLOAT4,1),new Lr("cc_ambientSky",Ns.FLOAT4,1),new Lr("cc_ambientGround",Ns.FLOAT4,1),new Lr("cc_fogColor",Ns.FLOAT4,1),new Lr("cc_fogBase",Ns.FLOAT4,1),new Lr("cc_fogAdd",Ns.FLOAT4,1)],1),ip.layouts[mp.NAME]=mp.LAYOUT,ip.bindings[mp.BINDING]=mp.DESCRIPTOR;class pp{}pp.MAT_LIGHT_PLANE_PROJ_OFFSET=0,pp.MAT_LIGHT_VIEW_OFFSET=pp.MAT_LIGHT_PLANE_PROJ_OFFSET+16,pp.MAT_LIGHT_VIEW_PROJ_OFFSET=pp.MAT_LIGHT_VIEW_OFFSET+16,pp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=pp.MAT_LIGHT_VIEW_PROJ_OFFSET+16,pp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=pp.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+4,pp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=pp.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+4,pp.SHADOW_COLOR_OFFSET=pp.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+4,pp.COUNT=pp.SHADOW_COLOR_OFFSET+4,pp.SIZE=4*pp.COUNT,pp.NAME="CCShadow",pp.BINDING=sp.UBO_SHADOW,pp.DESCRIPTOR=new io(pp.BINDING,hr.UNIFORM_BUFFER,1,Js.ALL),pp.LAYOUT=new Fr(hp.GLOBAL,pp.BINDING,pp.NAME,[new Lr("cc_matLightPlaneProj",Ns.MAT4,1),new Lr("cc_matLightView",Ns.MAT4,1),new Lr("cc_matLightViewProj",Ns.MAT4,1),new Lr("cc_shadowNFLSInfo",Ns.FLOAT4,1),new Lr("cc_shadowWHPBInfo",Ns.FLOAT4,1),new Lr("cc_shadowLPNNInfo",Ns.FLOAT4,1),new Lr("cc_shadowColor",Ns.FLOAT4,1)],1),ip.layouts[pp.NAME]=pp.LAYOUT,ip.bindings[pp.BINDING]=pp.DESCRIPTOR;const dp=sp.SAMPLER_SHADOWMAP,fp=new io(dp,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),gp=new zr(hp.GLOBAL,dp,"cc_shadowMap",Ns.SAMPLER2D,1);ip.layouts.cc_shadowMap=gp,ip.bindings[dp]=fp;const yp=sp.SAMPLER_GBUFFER_ALBEDOMAP,vp=new io(yp,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),xp=new zr(hp.GLOBAL,yp,"cc_gbuffer_albedoMap",Ns.SAMPLER2D,1);ip.layouts.cc_gbuffer_albedoMap=xp,ip.bindings[yp]=vp;const bp=sp.SAMPLER_GBUFFER_POSITIONMAP,Sp=new io(bp,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),Ap=new zr(hp.GLOBAL,bp,"cc_gbuffer_positionMap",Ns.SAMPLER2D,1);ip.layouts.cc_gbuffer_positionMap=Ap,ip.bindings[bp]=Sp;const Cp=sp.SAMPLER_GBUFFER_NORMALMAP,Tp=new io(Cp,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),wp=new zr(hp.GLOBAL,Cp,"cc_gbuffer_normalMap",Ns.SAMPLER2D,1);ip.layouts.cc_gbuffer_normalMap=wp,ip.bindings[Cp]=Tp;const Ep=sp.SAMPLER_LIGHTING_RESULTMAP,Pp=new io(Ep,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),Dp=new zr(hp.GLOBAL,Ep,"cc_lighting_resultMap",Ns.SAMPLER2D,1);ip.layouts.cc_lighting_resultMap=Dp,ip.bindings[Ep]=Pp;const Ip=sp.SAMPLER_GBUFFER_EMISSIVEMAP,Rp=new io(Ip,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),Mp=new zr(hp.GLOBAL,Ip,"cc_gbuffer_emissiveMap",Ns.SAMPLER2D,1);ip.layouts.cc_gbuffer_emissiveMap=Mp,ip.bindings[Ip]=Rp;const Op=sp.SAMPLER_ENVIRONMENT,Bp=new io(Op,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),Np=new zr(hp.GLOBAL,Op,"cc_environment",Ns.SAMPLER_CUBE,1);ip.layouts.cc_environment=Np,ip.bindings[Op]=Bp;const Lp=sp.SAMPLER_SPOT_LIGHTING_MAP,Fp=new io(Lp,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),zp=new zr(hp.GLOBAL,Lp,"cc_spotLightingMap",Ns.SAMPLER2D,1);ip.layouts.cc_spotLightingMap=zp,ip.bindings[Lp]=Fp;class Vp{}Vp.MAT_WORLD_OFFSET=0,Vp.MAT_WORLD_IT_OFFSET=Vp.MAT_WORLD_OFFSET+16,Vp.LIGHTINGMAP_UVPARAM=Vp.MAT_WORLD_IT_OFFSET+16,Vp.COUNT=Vp.LIGHTINGMAP_UVPARAM+4,Vp.SIZE=4*Vp.COUNT,Vp.NAME="CCLocal",Vp.BINDING=ap.UBO_LOCAL,Vp.DESCRIPTOR=new io(Vp.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX|Js.COMPUTE),Vp.LAYOUT=new Fr(hp.LOCAL,Vp.BINDING,Vp.NAME,[new Lr("cc_matWorld",Ns.MAT4,1),new Lr("cc_matWorldIT",Ns.MAT4,1),new Lr("cc_lightingMapUVParam",Ns.FLOAT4,1)],1),np.layouts[Vp.NAME]=Vp.LAYOUT,np.bindings[Vp.BINDING]=Vp.DESCRIPTOR;class Up{}Up.BATCHING_COUNT=10,Up.MAT_WORLDS_OFFSET=0,Up.COUNT=16*Up.BATCHING_COUNT,Up.SIZE=4*Up.COUNT,Up.NAME="CCLocalBatched",Up.BINDING=ap.UBO_LOCAL,Up.DESCRIPTOR=new io(Up.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX|Js.COMPUTE),Up.LAYOUT=new Fr(hp.LOCAL,Up.BINDING,Up.NAME,[new Lr("cc_matWorlds",Ns.MAT4,Up.BATCHING_COUNT)],1),np.layouts[Up.NAME]=Up.LAYOUT,np.bindings[Up.BINDING]=Up.DESCRIPTOR;class Gp{}Gp.LIGHTS_PER_PASS=1,Gp.LIGHT_POS_OFFSET=0,Gp.LIGHT_COLOR_OFFSET=Gp.LIGHT_POS_OFFSET+4*Gp.LIGHTS_PER_PASS,Gp.LIGHT_SIZE_RANGE_ANGLE_OFFSET=Gp.LIGHT_COLOR_OFFSET+4*Gp.LIGHTS_PER_PASS,Gp.LIGHT_DIR_OFFSET=Gp.LIGHT_SIZE_RANGE_ANGLE_OFFSET+4*Gp.LIGHTS_PER_PASS,Gp.COUNT=Gp.LIGHT_DIR_OFFSET+4*Gp.LIGHTS_PER_PASS,Gp.SIZE=4*Gp.COUNT,Gp.NAME="CCForwardLight",Gp.BINDING=ap.UBO_FORWARD_LIGHTS,Gp.DESCRIPTOR=new io(Gp.BINDING,hr.DYNAMIC_UNIFORM_BUFFER,1,Js.FRAGMENT),Gp.LAYOUT=new Fr(hp.LOCAL,Gp.BINDING,Gp.NAME,[new Lr("cc_lightPos",Ns.FLOAT4,Gp.LIGHTS_PER_PASS),new Lr("cc_lightColor",Ns.FLOAT4,Gp.LIGHTS_PER_PASS),new Lr("cc_lightSizeRangeAngle",Ns.FLOAT4,Gp.LIGHTS_PER_PASS),new Lr("cc_lightDir",Ns.FLOAT4,Gp.LIGHTS_PER_PASS)],1),np.layouts[Gp.NAME]=Gp.LAYOUT,np.bindings[Gp.BINDING]=Gp.DESCRIPTOR;class kp{}kp.JOINTS_TEXTURE_INFO_OFFSET=0,kp.COUNT=kp.JOINTS_TEXTURE_INFO_OFFSET+4,kp.SIZE=4*kp.COUNT,kp.NAME="CCSkinningTexture",kp.BINDING=ap.UBO_SKINNING_TEXTURE,kp.DESCRIPTOR=new io(kp.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX),kp.LAYOUT=new Fr(hp.LOCAL,kp.BINDING,kp.NAME,[new Lr("cc_jointTextureInfo",Ns.FLOAT4,1)],1),np.layouts[kp.NAME]=kp.LAYOUT,np.bindings[kp.BINDING]=kp.DESCRIPTOR;class Hp{}Hp.JOINTS_ANIM_INFO_OFFSET=0,Hp.COUNT=Hp.JOINTS_ANIM_INFO_OFFSET+4,Hp.SIZE=4*Hp.COUNT,Hp.NAME="CCSkinningAnimation",Hp.BINDING=ap.UBO_SKINNING_ANIMATION,Hp.DESCRIPTOR=new io(Hp.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX),Hp.LAYOUT=new Fr(hp.LOCAL,Hp.BINDING,Hp.NAME,[new Lr("cc_jointAnimInfo",Ns.FLOAT4,1)],1),np.layouts[Hp.NAME]=Hp.LAYOUT,np.bindings[Hp.BINDING]=Hp.DESCRIPTOR;class jp{}jp.JOINTS_OFFSET=0,jp.COUNT=jp.JOINTS_OFFSET+360,jp.SIZE=4*jp.COUNT,jp.NAME="CCSkinning",jp.BINDING=ap.UBO_SKINNING_TEXTURE,jp.DESCRIPTOR=new io(jp.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX),jp.LAYOUT=new Fr(hp.LOCAL,jp.BINDING,jp.NAME,[new Lr("cc_joints",Ns.FLOAT4,90)],1),np.layouts[jp.NAME]=jp.LAYOUT,np.bindings[jp.BINDING]=jp.DESCRIPTOR;class Wp{}Wp.MAX_MORPH_TARGET_COUNT=60,Wp.OFFSET_OF_WEIGHTS=0,Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Wp.MAX_MORPH_TARGET_COUNT,Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH+4,Wp.OFFSET_OF_VERTICES_COUNT=Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT+4,Wp.COUNT_BASE_4_BYTES=4*Math.ceil(Wp.MAX_MORPH_TARGET_COUNT/4)+4,Wp.SIZE=4*Wp.COUNT_BASE_4_BYTES,Wp.NAME="CCMorph",Wp.BINDING=ap.UBO_MORPH,Wp.DESCRIPTOR=new io(Wp.BINDING,hr.UNIFORM_BUFFER,1,Js.VERTEX),Wp.LAYOUT=new Fr(hp.LOCAL,Wp.BINDING,Wp.NAME,[new Lr("cc_displacementWeights",Ns.FLOAT4,Wp.MAX_MORPH_TARGET_COUNT/4),new Lr("cc_displacementTextureInfo",Ns.FLOAT4,1)],1),np.layouts[Wp.NAME]=Wp.LAYOUT,np.bindings[Wp.BINDING]=Wp.DESCRIPTOR;const qp=ap.SAMPLER_JOINTS,Xp=new io(qp,hr.SAMPLER_TEXTURE,1,Js.VERTEX),Yp=new zr(hp.LOCAL,qp,"cc_jointTexture",Ns.SAMPLER2D,1);np.layouts.cc_jointTexture=Yp,np.bindings[qp]=Xp;const Kp=ap.SAMPLER_MORPH_POSITION,$p=new io(Kp,hr.SAMPLER_TEXTURE,1,Js.VERTEX),Jp=new zr(hp.LOCAL,Kp,"cc_PositionDisplacements",Ns.SAMPLER2D,1);np.layouts.cc_PositionDisplacements=Jp,np.bindings[Kp]=$p;const Zp=ap.SAMPLER_MORPH_NORMAL,Qp=new io(Zp,hr.SAMPLER_TEXTURE,1,Js.VERTEX),td=new zr(hp.LOCAL,Zp,"cc_NormalDisplacements",Ns.SAMPLER2D,1);np.layouts.cc_NormalDisplacements=td,np.bindings[Zp]=Qp;const ed=ap.SAMPLER_MORPH_TANGENT,id=new io(ed,hr.SAMPLER_TEXTURE,1,Js.VERTEX),nd=new zr(hp.LOCAL,ed,"cc_TangentDisplacements",Ns.SAMPLER2D,1);np.layouts.cc_TangentDisplacements=nd,np.bindings[ed]=id;const sd=ap.SAMPLER_LIGHTMAP,rd=new io(sd,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),od=new zr(hp.LOCAL,sd,"cc_lightingMap",Ns.SAMPLER2D,1);np.layouts.cc_lightingMap=od,np.bindings[sd]=rd;const ad=ap.SAMPLER_SPRITE,ld=new io(ad,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),cd=new zr(hp.LOCAL,ad,"cc_spriteTexture",Ns.SAMPLER2D,1);np.layouts.cc_spriteTexture=cd,np.bindings[ad]=ld;const hd=ap.SAMPLER_REFLECTION,_d=new io(hd,hr.SAMPLER_TEXTURE,1,Js.FRAGMENT),ud=new zr(hp.LOCAL,hd,"cc_reflectionTexture",Ns.SAMPLER2D,1);np.layouts.cc_reflectionTexture=ud,np.bindings[hd]=_d;const md=ap.STORAGE_REFLECTION,pd=new io(md,hr.STORAGE_IMAGE,1,Js.COMPUTE),dd=new Gr(hp.LOCAL,md,"cc_reflectionStorage",Ns.IMAGE2D,1);np.layouts.cc_reflectionStorage=dd,np.bindings[md]=pd;const fd=Qm.makeMaskExclude([Qm.BitMask.UI_2D,Qm.BitMask.GIZMOS,Qm.BitMask.EDITOR,Qm.BitMask.SCENE_GIZMO,Qm.BitMask.PROFILER]);let gd,yd,vd,xd,bd;Qm.makeMaskExclude([Qm.BitMask.UI_2D,Qm.BitMask.PROFILER]),Qm.Enum.ALL,function(t){t[t.VERTICAL=0]="VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL"}(gd||(gd={})),function(t){t[t.ORTHO=0]="ORTHO",t[t.PERSPECTIVE=1]="PERSPECTIVE"}(yd||(yd={})),function(t){t[t.F1_8=0]="F1_8",t[t.F2_0=1]="F2_0",t[t.F2_2=2]="F2_2",t[t.F2_5=3]="F2_5",t[t.F2_8=4]="F2_8",t[t.F3_2=5]="F3_2",t[t.F3_5=6]="F3_5",t[t.F4_0=7]="F4_0",t[t.F4_5=8]="F4_5",t[t.F5_0=9]="F5_0",t[t.F5_6=10]="F5_6",t[t.F6_3=11]="F6_3",t[t.F7_1=12]="F7_1",t[t.F8_0=13]="F8_0",t[t.F9_0=14]="F9_0",t[t.F10_0=15]="F10_0",t[t.F11_0=16]="F11_0",t[t.F13_0=17]="F13_0",t[t.F14_0=18]="F14_0",t[t.F16_0=19]="F16_0",t[t.F18_0=20]="F18_0",t[t.F20_0=21]="F20_0",t[t.F22_0=22]="F22_0"}(vd||(vd={})),function(t){t[t.ISO100=0]="ISO100",t[t.ISO200=1]="ISO200",t[t.ISO400=2]="ISO400",t[t.ISO800=3]="ISO800"}(xd||(xd={})),function(t){t[t.D1=0]="D1",t[t.D2=1]="D2",t[t.D4=2]="D4",t[t.D8=3]="D8",t[t.D15=4]="D15",t[t.D30=5]="D30",t[t.D60=6]="D60",t[t.D125=7]="D125",t[t.D250=8]="D250",t[t.D500=9]="D500",t[t.D1000=10]="D1000",t[t.D2000=11]="D2000",t[t.D4000=12]="D4000"}(bd||(bd={}));const Sd=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],Ad=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],Cd=[100,200,400,800],Td=new Ni,wd=new Ni,Ed=new $i,Pd=mr.STENCIL<<1,Dd=[];class Id{constructor(t){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=gd.VERTICAL,this._fov=di(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new wr(.2,.2,.2,1),this._viewport=new hn(0,0,1,1),this._curTransform=Rs.IDENTITY,this._isProjDirty=!0,this._matView=new $i,this._matViewInv=null,this._matProj=new $i,this._matProjInv=new $i,this._matViewProj=new $i,this._matViewProjInv=new $i,this._frustum=new Cl,this._forward=new Ni,this._position=new Ni,this._priority=0,this._aperture=vd.F16_0,this._apertureValue=void 0,this._shutter=bd.D125,this._shutterValue=0,this._iso=xd.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=mr.NONE,this._clearDepth=1,this._visibility=fd,this._exposure=0,this._clearStencil=0,this._device=t,this._apertureValue=Sd[this._aperture],this._shutterValue=Ad[this._shutter],this._isoValue=Cd[this._iso],this._aspect=this.screenScale=1,!Dd.length){const e=t.capabilities.clipSpaceSignY;Dd[Rs.IDENTITY]=new $i(1,0,0,0,0,e),Dd[Rs.ROTATE_90]=new $i(0,1,0,0,-e,0),Dd[Rs.ROTATE_180]=new $i(-1,0,0,0,0,-e),Dd[Rs.ROTATE_270]=new $i(0,-1,0,0,e,0)}}_setWidth(t){this._width=t,this._nativeObj.width=t}_setHeight(t){this._height=t,this._nativeObj.height=t}_setScene(t){this._scene=t,this._nativeObj.scene=t?t.native:null}_init(t){this._nativeObj=new Yn,this._scene&&(this._nativeObj.scene=this._scene.native),this._nativeObj.frustum=this._frustum}initialize(t){this._init(t),this.node=t.node,this._setWidth(1),this._setHeight(1),this.clearFlag=mr.NONE,this.clearDepth=1,this.visibility=fd,this._name=t.name,this._proj=t.projection,this._priority=t.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(t.window)}_destroy(){this._nativeObj=null}destroy(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()}attachToScene(t){this._enabled=!0,this._setScene(t)}detachFromScene(){this._enabled=!1,this._setScene(null)}resize(t,e){this._window&&(this._setWidth(t),this._setHeight(e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this._isProjDirty=!0)}setFixedSize(t,e){this._setWidth(t),this._setHeight(e),this._aspect=t*this._viewport.width/(e*this._viewport.height),this.isWindowSize=!1}update(t=!1){if(!this._node)return;let e=!1;(this._node.hasChangedFlags||t)&&($i.invert(this._matView,this._node.worldMatrix),this._nativeObj.matView=this._matView,this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),this._nativeObj.position=this._position,this._nativeObj.forward=this._forward,e=!0);let i=this._device.surfaceTransform;if(this._isProjDirty||this._curTransform!==i){var n;this._curTransform=i;const t=this._device.capabilities.clipSpaceSignY;if((null===(n=this.window)||void 0===n?void 0:n.hasOffScreenAttachments)&&(i=Rs.IDENTITY),this._proj===yd.PERSPECTIVE)$i.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===gd.VERTICAL,this._device.capabilities.clipSpaceMinZ,t,i);else{const e=this._orthoHeight*this._aspect,n=this._orthoHeight;$i.ortho(this._matProj,-e,e,-n,n,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,t,i)}$i.invert(this._matProjInv,this._matProj),this._nativeObj.matProj=this._matProj,this._nativeObj.matProjInv=this._matProjInv,e=!0,this._isProjDirty=!1}e&&($i.multiply(this._matViewProj,this._matProj,this._matView),$i.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv),this._nativeObj.matViewProj=this._matViewProj,this._nativeObj.matViewProjInv=this._matViewProjInv,this._nativeObj.frustum=this._frustum)}set node(t){this._node=t,this._nativeObj.node=this._node.native}get node(){return this._node}set enabled(t){this._enabled=t}get enabled(){return this._enabled}set orthoHeight(t){this._orthoHeight=t,this._isProjDirty=!0}get orthoHeight(){return this._orthoHeight}set projectionType(t){this._proj=t,this._isProjDirty=!0}get projectionType(){return this._proj}set fovAxis(t){this._fovAxis=t,this._isProjDirty=!0}get fovAxis(){return this._fovAxis}set fov(t){this._fov=t,this._isProjDirty=!0}get fov(){return this._fov}set nearClip(t){this._nearClip=t,this._isProjDirty=!0}get nearClip(){return this._nearClip}set farClip(t){this._farClip=t,this._isProjDirty=!0}get farClip(){return this._farClip}set clearColor(t){this._clearColor.x=t.x,this._clearColor.y=t.y,this._clearColor.z=t.z,this._clearColor.w=t.w,this._nativeObj.clearColor=this._clearColor}get clearColor(){return this._clearColor}get viewport(){return this._viewport}set viewport(t){const{x:e,width:i,height:n}=t,s=this._device.capabilities.clipSpaceSignY<0?1-t.y-n:t.y;switch(this._device.surfaceTransform){case Rs.ROTATE_90:this._viewport.x=1-s-n,this._viewport.y=e,this._viewport.width=n,this._viewport.height=i;break;case Rs.ROTATE_180:this._viewport.x=1-e-i,this._viewport.y=1-s-n,this._viewport.width=i,this._viewport.height=n;break;case Rs.ROTATE_270:this._viewport.x=s,this._viewport.y=1-e-i,this._viewport.width=n,this._viewport.height=i;break;case Rs.IDENTITY:this._viewport.x=e,this._viewport.y=s,this._viewport.width=i,this._viewport.height=n}this._nativeObj.viewPort=this._viewport,this.resize(this.width,this.height)}get scene(){return this._scene}get name(){return this._name}get width(){return this._width}get height(){return this._height}get aspect(){return this._aspect}set matView(t){this._matView=t,this._nativeObj.matView=this._matView}get matView(){return this._matView}set matViewInv(t){this._matViewInv=t}get matViewInv(){return this._matViewInv||this._node.worldMatrix}set matProj(t){this._matProj=t,this._nativeObj.matProj=this._matProj}get matProj(){return this._matProj}set matProjInv(t){this._matProjInv=t,this._nativeObj.matProjInv=this._matProjInv}get matProjInv(){return this._matProjInv}set matViewProj(t){this._matViewProj=t,this._nativeObj.matViewProj=this._matViewProj}get matViewProj(){return this._matViewProj}set matViewProjInv(t){this._matViewProjInv=t,this._nativeObj.matViewProjInv=this._matViewProjInv}get matViewProjInv(){return this._matViewProjInv}set frustum(t){this._frustum=t,this._nativeObj.frustum=this._frustum}get frustum(){return this._frustum}set window(t){this._window=t,t&&(this._nativeObj.window=this._window.native)}get window(){return this._window}set forward(t){this._forward=t,this._nativeObj.forward=this._forward}get forward(){return this._forward}set position(t){this._position=t,this._nativeObj.position=this._position}get position(){return this._position}set visibility(t){this._visibility=t,this._nativeObj.visibility=this._visibility}get visibility(){return this._visibility}get priority(){return this._priority}set priority(t){this._priority=t}set aperture(t){this._aperture=t,this._apertureValue=Sd[this._aperture],this.updateExposure()}get aperture(){return this._aperture}get apertureValue(){return this._apertureValue}set shutter(t){this._shutter=t,this._shutterValue=Ad[this._shutter],this.updateExposure()}get shutter(){return this._shutter}get shutterValue(){return this._shutterValue}set iso(t){this._iso=t,this._isoValue=Cd[this._iso],this.updateExposure()}get iso(){return this._iso}get isoValue(){return this._isoValue}set ec(t){this._ec=t}get ec(){return this._ec}get exposure(){return this._exposure}get clearFlag(){return this._clearFlag}set clearFlag(t){this._clearFlag=t,this._nativeObj.clearFlag=t}get clearDepth(){return this._clearDepth}set clearDepth(t){this._clearDepth=t,this._nativeObj.clearDepth=t}get clearStencil(){return this._clearStencil}set clearStencil(t){this._clearStencil=t,this._nativeObj.clearStencil=t}get native(){return this._nativeObj}changeTargetWindow(t=null){this._window&&this._window.detachCamera(this);const e=t||n.director.root.mainWindow;e&&(e.attachCamera(this),this.window=e,this.resize(e.width,e.height))}detachCamera(){this._window&&this._window.detachCamera(this)}screenPointToRay(t,e,i){if(!this._node)return null;const n=this.width,s=this.height,r=this._viewport.x*n,o=this._viewport.y*s,a=this._viewport.width*n,l=this._viewport.height*s,c=this._proj===yd.PERSPECTIVE,h=this._device.capabilities.clipSpaceSignY,_=Ki[this._curTransform];Ni.set(Td,(e-r)/a*2-1,(i-o)/l*2-1,c?1:-1);const{x:u,y:m}=Td;return Td.x=u*_[0]+m*_[2]*h,Td.y=u*_[1]+m*_[3]*h,Ni.transformMat4(c?Td:t.o,Td,this._matViewProjInv),c?(this._node.getWorldPosition(wd),vs.fromPoints(t,wd,Td)):Ni.transformQuat(t.d,Ni.FORWARD,this._node.worldRotation),t}screenToWorld(t,e){const i=this.width,n=this.height,s=this._viewport.x*i,r=this._viewport.y*n,o=this._viewport.width*i,a=this._viewport.height*n,l=this._device.capabilities.clipSpaceSignY,c=Ki[this._curTransform];if(this._proj===yd.PERSPECTIVE){Ni.set(t,(e.x-s)/o*2-1,(e.y-r)/a*2-1,1);const{x:i,y:n}=t;t.x=i*c[0]+n*c[2]*l,t.y=i*c[1]+n*c[3]*l,Ni.transformMat4(t,t,this._matViewProjInv),this._node&&this._node.getWorldPosition(Td),Ni.lerp(t,Td,t,pi(this._nearClip/this._farClip,1,e.z))}else{Ni.set(t,(e.x-s)/o*2-1,(e.y-r)/a*2-1,2*e.z-1);const{x:i,y:n}=t;t.x=i*c[0]+n*c[2]*l,t.y=i*c[1]+n*c[3]*l,Ni.transformMat4(t,t,this._matViewProjInv)}return t}worldToScreen(t,e){const i=this.width,n=this.height,s=this._viewport.x*i,r=this._viewport.y*n,o=this._viewport.width*i,a=this._viewport.height*n,l=this._device.capabilities.clipSpaceSignY,c=Ki[this._curTransform];Ni.transformMat4(t,e,this._matViewProj);const{x:h,y:_}=t;return t.x=h*c[0]+_*c[2]*l,t.y=h*c[1]+_*c[3]*l,t.x=s+.5*(t.x+1)*o,t.y=r+.5*(t.y+1)*a,t.z=.5*t.z+.5,t}worldMatrixToScreen(t,e,i,n){$i.multiply(t,this._matViewProj,e),$i.multiply(t,Dd[this._curTransform],t);const s=i/2,r=n/2;return $i.identity(Ed),$i.transform(Ed,Ed,Ni.set(Td,s,r,0)),$i.scale(Ed,Ed,Ni.set(Td,s,r,1)),$i.multiply(t,Ed,t),t}setExposure(t){this._exposure=.833333/2**t,this._nativeObj.exposure=this._exposure}updateExposure(){const t=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(t)}}let Rd,Md,Od,Bd=1024;var Nd,Ld,Fd,zd;function Vd(t){return!!(n.sys.capabilities.imageBitmap&&t instanceof ImageBitmap)}!function(t){t[t.RGB565=Os.R5G6B5]="RGB565",t[t.RGB5A1=Os.RGB5A1]="RGB5A1",t[t.RGBA4444=Os.RGBA4]="RGBA4444",t[t.RGB888=Os.RGB8]="RGB888",t[t.RGB32F=Os.RGB32F]="RGB32F",t[t.RGBA8888=Os.RGBA8]="RGBA8888",t[t.RGBA32F=Os.RGBA32F]="RGBA32F",t[t.A8=Os.A8]="A8",t[t.I8=Os.L8]="I8",t[t.AI8=Os.LA8]="AI8",t[t.RGB_PVRTC_2BPPV1=Os.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",t[t.RGBA_PVRTC_2BPPV1=Os.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",t[t.RGB_A_PVRTC_2BPPV1=Bd++]="RGB_A_PVRTC_2BPPV1",t[t.RGB_PVRTC_4BPPV1=Os.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",t[t.RGBA_PVRTC_4BPPV1=Os.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",t[t.RGB_A_PVRTC_4BPPV1=Bd++]="RGB_A_PVRTC_4BPPV1",t[t.RGB_ETC1=Os.ETC_RGB8]="RGB_ETC1",t[t.RGBA_ETC1=Bd++]="RGBA_ETC1",t[t.RGB_ETC2=Os.ETC2_RGB8]="RGB_ETC2",t[t.RGBA_ETC2=Os.ETC2_RGBA8]="RGBA_ETC2",t[t.RGBA_ASTC_4x4=Os.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",t[t.RGBA_ASTC_5x4=Os.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",t[t.RGBA_ASTC_5x5=Os.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",t[t.RGBA_ASTC_6x5=Os.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",t[t.RGBA_ASTC_6x6=Os.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",t[t.RGBA_ASTC_8x5=Os.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",t[t.RGBA_ASTC_8x6=Os.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",t[t.RGBA_ASTC_8x8=Os.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",t[t.RGBA_ASTC_10x5=Os.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",t[t.RGBA_ASTC_10x6=Os.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",t[t.RGBA_ASTC_10x8=Os.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",t[t.RGBA_ASTC_10x10=Os.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",t[t.RGBA_ASTC_12x10=Os.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",t[t.RGBA_ASTC_12x12=Os.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Rd||(Rd={})),function(t){t[t.REPEAT=Ws.WRAP]="REPEAT",t[t.CLAMP_TO_EDGE=Ws.CLAMP]="CLAMP_TO_EDGE",t[t.MIRRORED_REPEAT=Ws.MIRROR]="MIRRORED_REPEAT",t[t.CLAMP_TO_BORDER=Ws.BORDER]="CLAMP_TO_BORDER"}(Md||(Md={})),function(t){t[t.NONE=js.NONE]="NONE",t[t.LINEAR=js.LINEAR]="LINEAR",t[t.NEAREST=js.POINT]="NEAREST"}(Od||(Od={}));let Ud,Gd=t("ImageAsset",Vl("cc.ImageAsset")((zd=Fd=class t extends _h{get _nativeAsset(){return this._nativeData}set _nativeAsset(t){t instanceof HTMLElement||Vd(t)||(t.format=t.format||this._format),this.reset(t)}get data(){return this._nativeData&&!0!==(t=this._nativeData)._compressed&&(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||Vd(t))?this._nativeData:this._nativeData&&this._nativeData._data;var t}get width(){return this._nativeData.width||this._width}get height(){return this._nativeData.height||this._height}get format(){return this._format}get isCompressed(){return this._format>=Rd.RGB_ETC1&&this._format<=Rd.RGBA_ASTC_12x12||this._format>=Rd.RGB_A_PVRTC_2BPPV1&&this._format<=Rd.RGBA_ETC1}get url(){return this.nativeUrl}constructor(t){super(),this._nativeData=void 0,this._exportedExts=void 0,this._format=Rd.RGBA8888,this._width=0,this._height=0,this._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&this.reset(t)}reset(t){Vd(t)||t instanceof HTMLElement?this._nativeData=t:(this._nativeData=t,this._format=t.format)}destroy(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset(""),this.data.destroy()):Vd(this.data)&&this.data.close&&this.data.close(),super.destroy()}_serialize(){}_deserialize(e){let i="";"string"==typeof e?i=e:(this._width=e.w,this._height=e.h,i=e.fmt);const s=n.director.root?n.director.root.device:null,r=i.split("_");let o="",a=Number.MAX_VALUE,l=this._format,c="";const h=n.macro.SUPPORT_TEXTURE_FORMATS;for(const e of r){const i=e.split("@"),r=parseInt(i[0],void 0),_=t.extnames[r]||i[0],u=h.indexOf(_);if(-1!==u&&u<a){const t=i[1]?parseInt(i[1]):this._format;if(!(".astc"!==_||s&&s.hasFeature(Ms.FORMAT_ASTC)))continue;if(!(".pvr"!==_||s&&s.hasFeature(Ms.FORMAT_PVRTC)))continue;if(!(t!==Rd.RGB_ETC1&&t!==Rd.RGBA_ETC1||s&&s.hasFeature(Ms.FORMAT_ETC1)))continue;if(!(t!==Rd.RGB_ETC2&&t!==Rd.RGBA_ETC2||s&&s.hasFeature(Ms.FORMAT_ETC2)))continue;if(".webp"===_&&!n.sys.capabilities.webp)continue;a=u,c=_,l=t}else o||(o=_)}c?(this._setRawAsset(c),this._format=l):o?(this._setRawAsset(o),A(3120,o,o)):A(3121)}initDefault(e){if(super.initDefault(e),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{const e=document.createElement("canvas"),i=e.getContext("2d"),n=e.width=e.height=2;i.fillStyle="#ff00ff",i.fillRect(0,0,n,n),this.reset(e),t._sharedPlaceHolderCanvas=e}}validate(){return!!this.data}},Fd.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Fd._sharedPlaceHolderCanvas=null,wl((Ld=zd).prototype,"_nativeAsset",[vc],Object.getOwnPropertyDescriptor(Ld.prototype,"_nativeAsset"),Ld.prototype),Nd=Ld))||Nd);n.ImageAsset=Gd,function(t){t[t.minFilter=0]="minFilter",t[t.magFilter=1]="magFilter",t[t.mipFilter=2]="mipFilter",t[t.addressU=3]="addressU",t[t.addressV=4]="addressV",t[t.addressW=5]="addressW",t[t.maxAnisotropy=6]="maxAnisotropy",t[t.cmpFunc=7]="cmpFunc",t[t.mipLODBias=8]="mipLODBias",t[t.total=9]="total"}(Ud||(Ud={}));const kd=[js.LINEAR,js.LINEAR,js.NONE,Ws.WRAP,Ws.WRAP,Ws.WRAP,0,qs.NEVER,0],Hd=qd(kd),jd=new wr,Wd=new Nr;function qd(t){let e=0,i=0;for(let n=0;n<kd.length;n++)switch(e=t[n]||kd[n],n){case Ud.minFilter:i|=e;break;case Ud.magFilter:i|=e<<2;break;case Ud.mipFilter:i|=e<<4;break;case Ud.addressU:i|=e<<6;break;case Ud.addressV:i|=e<<8;break;case Ud.addressW:i|=e<<10;break;case Ud.maxAnisotropy:i|=e<<12;break;case Ud.cmpFunc:i|=e<<16;break;case Ud.mipLODBias:i|=e<<28}return i}const Xd=new class{constructor(){this._cache={}}getSampler(t,e){e||(e=Hd);const i=this._cache[e];return i||(Wd.minFilter=3&e,Wd.magFilter=e>>2&3,Wd.mipFilter=e>>4&3,Wd.addressU=e>>6&3,Wd.addressV=e>>8&3,Wd.addressW=e>>10&3,Wd.maxAnisotropy=e>>12&15,Wd.cmpFunc=e>>16&15,Wd.mipLODBias=e>>28&15,Wd.borderColor=jd,this._cache[e]=t.createSampler(Wd))}};var Yd,Kd,$d,Jd,Zd,Qd,tf,ef,nf,sf,rf,of;n.samplerLib=Xd;const af=new X("Tex");let lf=Vl("cc.TextureBase")((of=rf=class extends _h{get isCompressed(){return this._format>=Rd.RGB_ETC1&&this._format<=Rd.RGBA_ASTC_12x12||this._format>=Rd.RGB_A_PVRTC_2BPPV1&&this._format<=Rd.RGBA_ETC1}get width(){return this._width}get height(){return this._height}constructor(){super(),Tl(this,"_format",$d,this),Tl(this,"_minFilter",Jd,this),Tl(this,"_magFilter",Zd,this),Tl(this,"_mipFilter",Qd,this),Tl(this,"_wrapS",tf,this),Tl(this,"_wrapT",ef,this),Tl(this,"_wrapR",nf,this),Tl(this,"_anisotropy",sf,this),this._width=1,this._height=1,this._id=void 0,this._samplerInfo=[],this._samplerHash=0,this._gfxSampler=null,this._gfxDevice=null,this._textureHash=0,this._id=af.getNewId(),this._gfxDevice=this._getGFXDevice(),this._textureHash=Uo(this._id,666)}getId(){return this._id}getPixelFormat(){return this._format}getAnisotropy(){return this._anisotropy}setWrapMode(t,e,i){this._wrapS=t,this._samplerInfo[Ud.addressU]=t,this._wrapT=e,this._samplerInfo[Ud.addressV]=e,void 0!==i&&(this._wrapR=i,this._samplerInfo[Ud.addressW]=i),this._samplerHash=qd(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Xd.getSampler(this._gfxDevice,this._samplerHash))}setFilters(t,e){this._minFilter=t,this._samplerInfo[Ud.minFilter]=t,this._magFilter=e,this._samplerInfo[Ud.magFilter]=e,this._samplerHash=qd(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Xd.getSampler(this._gfxDevice,this._samplerHash))}setMipFilter(t){this._mipFilter=t,this._samplerInfo[Ud.mipFilter]=t,this._samplerHash=qd(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Xd.getSampler(this._gfxDevice,this._samplerHash))}setAnisotropy(t){this._anisotropy=t,this._samplerInfo[Ud.maxAnisotropy]=t,this._samplerHash=qd(this._samplerInfo),this._gfxDevice&&(this._gfxSampler=Xd.getSampler(this._gfxDevice,this._samplerHash))}destroy(){var t;const e=super.destroy();return e&&(null===(t=n.director.root)||void 0===t?void 0:t.batcher2D)&&n.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),e}getHash(){return this._textureHash}getGFXTexture(){return null}getSamplerHash(){return this._samplerHash}getGFXSampler(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=Xd.getSampler(this._gfxDevice,this._samplerHash):T(9302)),this._gfxSampler}_serialize(t){return""}_deserialize(t,e){const i=t.split(",");i.unshift(""),i.length>=5&&(this.setFilters(parseInt(i[1]),parseInt(i[2])),this.setWrapMode(parseInt(i[3]),parseInt(i[4]))),i.length>=7&&(this.setMipFilter(parseInt(i[5])),this.setAnisotropy(parseInt(i[6])))}_getGFXDevice(){return n.director.root?n.director.root.device:null}_getGFXFormat(){return this._getGFXPixelFormat(this._format)}_setGFXFormat(t){this._format=void 0===t?Rd.RGBA8888:t}_getGFXPixelFormat(t){return t===Rd.RGBA_ETC1?t=Rd.RGB_ETC1:t===Rd.RGB_A_PVRTC_4BPPV1?t=Rd.RGB_PVRTC_4BPPV1:t===Rd.RGB_A_PVRTC_2BPPV1&&(t=Rd.RGB_PVRTC_2BPPV1),t}},rf.PixelFormat=Rd,rf.WrapMode=Md,rf.Filter=Od,$d=wl((Kd=of).prototype,"_format",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rd.RGBA8888}}),Jd=wl(Kd.prototype,"_minFilter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Od.LINEAR}}),Zd=wl(Kd.prototype,"_magFilter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Od.LINEAR}}),Qd=wl(Kd.prototype,"_mipFilter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Od.NONE}}),tf=wl(Kd.prototype,"_wrapS",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Md.REPEAT}}),ef=wl(Kd.prototype,"_wrapT",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Md.REPEAT}}),nf=wl(Kd.prototype,"_wrapR",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Md.REPEAT}}),sf=wl(Kd.prototype,"_anisotropy",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Yd=Kd))||Yd;n.TextureBase=lf;const cf=new WeakMap,hf=new WeakSet,_f=new WeakSet;function uf(t,e){let i;i=Lh.safeFindClass;const n=Jh.pool.get();let s;try{s=c_(t,n,{classFinder:i,customEnv:e})}catch(t){throw p(t),Jh.pool.put(n),t}s._uuid=e.__uuid__||"";const r=n.uuidList,o=n.uuidObjList,a=n.uuidPropList,l=n.uuidTypeList||[],c=[];for(let t=0;t<r.length;t++){const e=r[t];c[t]={uuid:Kc(e),owner:o[t],prop:a[t],type:Ot._getClassById(l[t])}}return cf.set(s,c),s._native&&hf.add(s),Jh.pool.put(n),s}var mf,pf=new class{constructor(){this._depends=new Mc}init(){this._depends.clear()}getNativeDep(t){const e=this._depends.get(t);return e&&e.nativeDep?{...e.nativeDep}:null}getDeps(t){return this._depends.has(t)?this._depends.get(t).deps:[]}getDepsRecursively(t){const e=Object.create(null),i=[];return this._descend(t,e,i),i}remove(t){this._depends.remove(t)}parse(t,e){let i=null;if(Array.isArray(e)||e.__type__||e instanceof Vh){if(this._depends.has(t))return this._depends.get(t);if(Array.isArray(e)&&!function(t){const e=t[5],i=e[e.length-1];return"number"==typeof i&&i<0}(e))i={deps:this._parseDepsFromJson(e)};else try{const n=uf(e,{__uuid__:t});i=this._parseDepsFromAsset(n),i.nativeDep&&(i.nativeDep.uuid=t),Lc.add(`${t}@import`,n)}catch(e){Nc.remove(`${t}@import`),i={deps:[]}}}else{if(this._depends.has(t)&&(i=this._depends.get(t),i.parsedFromExistAsset))return i;i=this._parseDepsFromAsset(e)}return this._depends.add(t,i),i}_parseDepsFromAsset(t){const e={deps:[],parsedFromExistAsset:!0},i=cf.get(t);for(let t=0,n=i.length;t<n;t++)e.deps.push(i[t].uuid);return hf.has(t)&&(e.nativeDep=t._nativeDep),e}_parseDepsFromJson(t){const e=function(t){const e=t[1];return t[10].map((t=>e[t]))}(t);return e.forEach(((t,i)=>e[i]=Kc(t))),e}_descend(t,e,i){const n=this.getDeps(t);for(let t=0;t<n.length;t++){const s=n[t];e[s]||(e[s]=!0,i.push(s),this._descend(s,e,i))}}};const df=[new Cr];function ff(t){return t&&0==(t&t-1)}let gf=Vl("cc.SimpleTexture")(mf=class extends lf{constructor(...t){super(...t),this._gfxTexture=null,this._mipmapLevel=1,this._textureWidth=0,this._textureHeight=0}get mipmapLevel(){return this._mipmapLevel}getGFXTexture(){return this._gfxTexture}destroy(){return this._tryDestroyTexture(),super.destroy()}updateImage(){this.updateMipmaps(0)}updateMipmaps(t=0,e){}uploadData(t,e=0,i=0){if(!this._gfxTexture||this._mipmapLevel<=e)return;const n=this._getGFXDevice();if(!n)return;const s=df[0];s.texExtent.width=this._textureWidth>>e,s.texExtent.height=this._textureHeight>>e,s.texSubres.mipLevel=e,s.texSubres.baseArrayLayer=i,ArrayBuffer.isView(t)?n.copyBuffersToTexture([t],this._gfxTexture,df):n.copyTexImagesToTexture([t],this._gfxTexture,df)}_assignImage(t,e,i){const n=t.data;if(n&&(this.uploadData(n,e,i),this._checkTextureLoaded(),Ut.CLEANUP_IMAGE_CACHE)){const e=pf.getDeps(this._uuid),i=e.indexOf(t._uuid);-1!==i&&(H(e,i),t.decRef())}}_checkTextureLoaded(){this._textureReady()}_textureReady(){this.loaded=!0,this.emit("load")}_setMipmapLevel(t){this._mipmapLevel=t<1?1:t}_getGfxTextureCreateInfo(t){return null}_tryReset(){if(this._tryDestroyTexture(),0===this._mipmapLevel)return;const t=this._getGFXDevice();t&&this._createTexture(t)}_createTexture(t){if(0===this._width||0===this._height)return;let e=ks.NONE;this._mipFilter!==Od.NONE&&function(t,e,i){return!(t.gfxAPI===Is.WEBGL)||ff(e)&&ff(i)}(t,this._width,this._height)&&(this._mipmapLevel=function(t,e){let i=Math.max(t,e),n=0;for(;i;)i>>=1,n++;return n}(this._width,this._height),e=ks.GEN_MIPMAP);const i=this._getGfxTextureCreateInfo({usage:Gs.SAMPLED|Gs.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:e|ks.IMMUTABLE});if(!i)return;const n=t.createTexture(i);this._textureWidth=i.width,this._textureHeight=i.height,this._gfxTexture=n}_tryDestroyTexture(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)}})||mf;var yf,vf,xf,bf,Sf;n.SimpleTexture=gf;let Af=t("Texture2D",(yf=Vl("cc.Texture2D"),vf=yc([Gd]),yf((Sf=wl((bf=class extends gf{constructor(...t){super(...t),Tl(this,"_mipmaps",Sf,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0];this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{this._assignImage(t,e)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}initialize(){this.mipmaps=this._mipmaps}onLoaded(){this.initialize()}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}create(t,e,i=Rd.RGBA8888,n=1){this.reset({width:t,height:e,format:i,mipmapLevel:n})}toString(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;this._assignImage(this._mipmaps[i],i)}}getHtmlElementObj(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null}destroy(){return this._mipmaps=[],super.destroy()}description(){return`<cc.Texture2D | Name = ${this._mipmaps[0]?this._mipmaps[0].url:""} | Dimension = ${this.width} x ${this.height}>`}releaseTexture(){this.destroy()}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){if(this._mipmaps[t]=new Gd,!i.mipmaps[t])continue;const n=i.mipmaps[t];e.result.push(this._mipmaps,`${t}`,n,Ot._getClassId(Gd))}}_getGfxTextureCreateInfo(t){const e=new Or(Us.TEX2D);return e.width=this._width,e.height=this._height,Object.assign(e,t)}initDefault(t){super.initDefault(t);const e=new Gd;e.initDefault(),this.image=e}validate(){return this.mipmaps&&0!==this.mipmaps.length}}).prototype,"_mipmaps",[vf],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xf=bf))||xf));var Cf,Tf,wf,Ef,Pf,Df,If;n.Texture2D=Af,function(t){t[t.right=0]="right",t[t.left=1]="left",t[t.top=2]="top",t[t.bottom=3]="bottom",t[t.front=4]="front",t[t.back=5]="back"}(If||(If={}));let Rf=t("TextureCube",Vl("cc.TextureCube")((Df=Pf=class t extends gf{constructor(...t){super(...t),Tl(this,"isRGBE",wf,this),Tl(this,"_mipmaps",Ef,this)}get mipmaps(){return this._mipmaps}set mipmaps(t){if(this._mipmaps=t,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){const t=this._mipmaps[0].front;this.reset({width:t.width,height:t.height,format:t.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach(((t,e)=>{Mf(t,((t,i)=>{this._assignImage(t,e,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}get image(){return 0===this._mipmaps.length?null:this._mipmaps[0]}set image(t){this.mipmaps=t?[t]:[]}static fromTexture2DArray(e,i){const n=[],s=e.length/6;for(let t=0;t<s;t++){const i=6*t;n.push({front:e[i+If.front].image,back:e[i+If.back].image,left:e[i+If.left].image,right:e[i+If.right].image,top:e[i+If.top].image,bottom:e[i+If.bottom].image})}return(i=i||new t).mipmaps=n,i}onLoaded(){this.mipmaps=this._mipmaps}reset(t){this._width=t.width,this._height=t.height,this._setGFXFormat(t.format),this._setMipmapLevel(t.mipmapLevel||1),this._tryReset()}updateMipmaps(t=0,e){if(t>=this._mipmaps.length)return;const i=Math.min(void 0===e?this._mipmaps.length:e,this._mipmaps.length-t);for(let e=0;e<i;++e){const i=t+e;Mf(this._mipmaps[i],((t,e)=>{this._assignImage(t,i,e)}))}}destroy(){return this._mipmaps=[],super.destroy()}releaseTexture(){this.mipmaps=[]}_serialize(t){return null}_deserialize(t,e){const i=t;super._deserialize(i.base,e),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(let t=0;t<i.mipmaps.length;++t){this._mipmaps[t]={front:new Gd,back:new Gd,left:new Gd,right:new Gd,top:new Gd,bottom:new Gd};const n=i.mipmaps[t],s=Ot._getClassId(Gd);e.result.push(this._mipmaps[t],"front",n.front,s),e.result.push(this._mipmaps[t],"back",n.back,s),e.result.push(this._mipmaps[t],"left",n.left,s),e.result.push(this._mipmaps[t],"right",n.right,s),e.result.push(this._mipmaps[t],"top",n.top,s),e.result.push(this._mipmaps[t],"bottom",n.bottom,s)}}_getGfxTextureCreateInfo(t){const e=new Or(Us.CUBE);return e.width=this._width,e.height=this._height,e.layerCount=6,Object.assign(e,t),e}initDefault(t){super.initDefault(t);const e=new Gd;e.initDefault(),this.mipmaps=[{front:e,back:e,top:e,bottom:e,left:e,right:e}]}validate(){return 0!==this._mipmaps.length&&!this._mipmaps.find((t=>!(t.top&&t.bottom&&t.front&&t.back&&t.left&&t.right)))}},Pf.FaceIndex=If,wf=wl((Tf=Df).prototype,"isRGBE",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ef=wl(Tf.prototype,"_mipmaps",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Cf=Tf))||Cf);function Mf(t,e){e(t.front,If.front),e(t.back,If.back),e(t.left,If.left),e(t.right,If.right),e(t.top,If.top),e(t.bottom,If.bottom)}n.TextureCube=Rf;const Of=t("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:308883658,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:50,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0}]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:3113634185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_dist",type:13,count:1,defines:[],stageFlags:1,format:11,location:2}]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:3001336778,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],attributes:[{name:"a_position_starttime",type:16,count:1,defines:[],stageFlags:1,format:44,location:0},{name:"a_size_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_rotation_uv",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_dir_life",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_rndSeed",type:13,count:1,defines:[],stageFlags:1,format:11,location:5},{name:"a_texCoord",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_color1",type:16,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:44,location:9}]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:2637621064,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:16,count:1,defines:[],stageFlags:1,format:44,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4}]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:1675533382,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:49,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:38},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord1",type:15,count:1,defines:[],stageFlags:1,format:32,location:2},{name:"a_texCoord2",type:15,count:1,defines:[],stageFlags:1,format:32,location:3},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:4},{name:"a_color1",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:8},{name:"a_texCoord3",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:6},{name:"a_normal",type:15,count:1,defines:["CC_RENDER_MODE"],stageFlags:1,format:32,location:7}]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:1867464226,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2},{name:"a_color2",type:16,count:1,defines:["TWO_COLORED"],stageFlags:1,format:44,location:3}]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1559944983,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:46,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:2}]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},normalStrenth:{value:[1],type:13,handleInfo:["miscParams",0,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},miscParams:{type:16,value:[1,0,0,0]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},normalStrenth:{value:[1],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,1]},emissiveScaleParam:{type:16,value:[1,1,1,0]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:3887038508,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:217,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:60},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_STANDARD_TRANSPARENT",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:14}]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:3621922986,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:180,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:23},globals:{blocks:[{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"miscParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_texCoord1",type:14,count:1,defines:[],stageFlags:1,format:21,location:13}]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"deferred",propertyIndex:0,blendState:{targets:[{blend:!1},{blend:!1},{blend:!1},{blend:!1}]},program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:1309646336,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:64,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:55},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]}]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_BATCHING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_STANDARD_TRANSPARENT",type:"boolean"}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:1471860764,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:62,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[]}},defines:[],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2}]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:1017648509,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:195,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12},{name:"a_color",type:16,count:1,defines:["USE_VERTEX_COLOR"],stageFlags:1,format:44,location:13}]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:1887156831,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_gbuffer_albedoMap",defines:[]},{name:"cc_gbuffer_positionMap",defines:[]},{name:"cc_gbuffer_normalMap",defines:[]},{name:"cc_gbuffer_emissiveMap",defines:[]}]},locals:{blocks:[{name:"CCForwardLight",defines:[]}],samplerTextures:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_STANDARD_TRANSPARENT",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:649108546,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:210,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:53},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7},{name:"a_matWorld0",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:8},{name:"a_matWorld1",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:9},{name:"a_matWorld2",type:16,count:1,defines:["USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",type:16,count:1,defines:["USE_INSTANCING","USE_LIGHTMAP"],stageFlags:1,format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",type:13,count:1,defines:["!USE_INSTANCING","USE_BATCHING"],stageFlags:1,format:11,location:12}]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:1780456825,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:145,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_lighting_resultMap",defines:[]}]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3},{name:"a_vertexId",type:13,count:1,defines:["CC_USE_MORPH"],stageFlags:1,format:11,location:6},{name:"a_joints",type:"u32vec4",count:1,defines:["CC_USE_SKINNING"],stageFlags:1,location:4},{name:"a_weights",type:16,count:1,defines:["CC_USE_SKINNING"],stageFlags:1,format:44,location:5},{name:"a_jointAnimInfo",type:16,count:1,defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],stageFlags:1,format:44,isInstanced:!0,location:7}]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:3169038185,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:37,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],blocks:[],samplerTextures:[],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_normal",type:15,count:1,defines:[],stageFlags:1,format:32,location:1},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:2},{name:"a_tangent",type:16,count:1,defines:[],stageFlags:1,format:44,location:3}]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:3552712539,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:58,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:37},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[{name:"CC_USE_HDR",type:"boolean"}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],attributes:[{name:"a_position",type:15,count:1,defines:[],stageFlags:1,format:32,location:0},{name:"a_color",type:16,count:1,defines:[],stageFlags:1,format:44,location:1}]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},precent:{value:[.5],type:13,handleInfo:["u_buffer0",2,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,.5,0]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:1349506124,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[]},locals:{blocks:[],samplerTextures:[]}},defines:[],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],attributes:[{name:"a_position",type:14,count:1,defines:[],stageFlags:1,format:21,location:0},{name:"a_texCoord",type:14,count:1,defines:[],stageFlags:1,format:21,location:1}]}]}]),Bf=4026531840,Nf=264241152,Lf=3145728,Ff=1032192;let zf;!function(t){t[t.BUFFER=0]="BUFFER",t[t.TEXTURE=1]="TEXTURE"}(zf||(zf={}));const Vf=(t,e,i,n,s=0)=>t<<28&Bf|n<<22&Nf|e<<20&Lf|i<<14&Ff|16383&s,Uf=t=>(t&Bf)>>>28,Gf=t=>(t&Nf)>>>22,kf=t=>(t&Ff)>>>14,Hf=t=>16383&t,jf=(t,e)=>t&~Nf|e<<22&Nf,Wf={[Ns.UNKNOWN]:()=>console.warn("illegal uniform handle"),[Ns.INT]:(t,e,i=0)=>t[i],[Ns.INT2]:(t,e,i=0)=>tn.fromArray(e,t,i),[Ns.INT3]:(t,e,i=0)=>Ni.fromArray(e,t,i),[Ns.INT4]:(t,e,i=0)=>rn.fromArray(e,t,i),[Ns.FLOAT]:(t,e,i=0)=>t[i],[Ns.FLOAT2]:(t,e,i=0)=>tn.fromArray(e,t,i),[Ns.FLOAT3]:(t,e,i=0)=>Ni.fromArray(e,t,i),[Ns.FLOAT4]:(t,e,i=0)=>rn.fromArray(e,t,i),[Ns.MAT3]:(t,e,i=0)=>Vi.fromArray(e,t,i),[Ns.MAT4]:(t,e,i=0)=>$i.fromArray(e,t,i)},qf={[Ns.UNKNOWN]:()=>console.warn("illegal uniform handle"),[Ns.INT]:(t,e,i=0)=>t[i]=e,[Ns.INT2]:(t,e,i=0)=>tn.toArray(t,e,i),[Ns.INT3]:(t,e,i=0)=>Ni.toArray(t,e,i),[Ns.INT4]:(t,e,i=0)=>rn.toArray(t,e,i),[Ns.FLOAT]:(t,e,i=0)=>t[i]=e,[Ns.FLOAT2]:(t,e,i=0)=>tn.toArray(t,e,i),[Ns.FLOAT3]:(t,e,i=0)=>Ni.toArray(t,e,i),[Ns.FLOAT4]:(t,e,i=0)=>rn.toArray(t,e,i),[Ns.MAT3]:(t,e,i=0)=>Vi.toArray(t,e,i),[Ns.MAT4]:(t,e,i=0)=>$i.toArray(t,e,i)},Xf=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function Yf(t){switch(t){case Ns.BOOL:case Ns.INT:case Ns.UINT:case Ns.FLOAT:return Xf[0];case Ns.BOOL2:case Ns.INT2:case Ns.UINT2:case Ns.FLOAT2:return Xf[1];case Ns.BOOL4:case Ns.INT4:case Ns.UINT4:case Ns.FLOAT4:return Xf[2];case Ns.MAT4:return Xf[3];case Ns.SAMPLER2D:return"default-texture";case Ns.SAMPLER_CUBE:return"default-cube-texture"}return Xf[0]}function Kf(t,e){const i=Object.entries(e);let n=!1;for(let e=0;e<i.length;e++)t[i[e][0]]!==i[e][1]&&(t[i[e][0]]=i[e][1],n=!0);return n}const $f=new no;function Jf(t){return Math.ceil(Math.log2(Math.max(t,2)))}function Zf(t,e){switch(t.type){case"boolean":return"number"==typeof e?e.toString():e?"1":"0";case"string":return void 0!==e?e:t.options[0];case"number":return void 0!==e?e.toString():t.range[0].toString();default:return console.warn(`unknown define type '${t.type}'`),"-1"}}function Qf(t,e,i,n,s){const r=t.builtins[n],o=[];for(let t=0;t<r.blocks.length;t++){const e=r.blocks[t],n=i.layouts[e.name],a=n&&i.bindings.find((t=>t.binding===n.binding));n&&a&&a.descriptorType&go?(o.push(n),s&&!s.includes(a)&&s.push(a)):console.warn(`builtin UBO '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxBlocks,o);const a=[];for(let t=0;t<r.samplerTextures.length;t++){const e=r.samplerTextures[t],n=i.layouts[e.name],o=n&&i.bindings.find((t=>t.binding===n.binding));n&&o&&o.descriptorType&yo?(a.push(n),s&&!s.includes(o)&&s.push(o)):console.warn(`builtin samplerTexture '${e.name}' not available!`)}Array.prototype.unshift.apply(e.gfxSamplerTextures,a),s&&s.sort(((t,e)=>t.binding-e.binding))}function tg(t){return t.members.reduce(((t,e)=>t+Co(e.type)*e.count),0)}function eg(t,e){for(let i=0;i<t.length;i++){const n=t[i];if("!"===n[0]){if(e[n.slice(1)])return!1}else if(!e[n])return!1}return!0}function ig(t){switch(t.gfxAPI){case Is.GLES2:case Is.WEBGL:return"glsl1";case Is.GLES3:case Is.WEBGL2:return"glsl3";default:return"glsl4"}}const ng=new class{constructor(){this._templates={},this._cache={},this._templateInfos={}}register(t){for(let e=0;e<t.shaders.length;e++)this.define(t.shaders[e]).effectName=t.name}define(t){const e=this._templates[t.name];if(e&&e.hash===t.hash)return e;const i={...t};let n=0;for(let t=0;t<i.defines.length;t++){const e=i.defines[t];let s=1;if("number"===e.type){const t=e.range;s=Jf(t[1]-t[0]+1),e._map=e=>e-t[0]}else"string"===e.type?(s=Jf(e.options.length),e._map=t=>Math.max(0,e.options.findIndex((e=>e===t)))):"boolean"===e.type&&(e._map=t=>t?1:0);e._offset=n,n+=s}n>31&&(i.uber=!0),i.constantMacros="";for(const t in i.builtins.statistics)i.constantMacros+=`#define ${t} ${i.builtins.statistics[t]}\n`;if(this._templates[t.name]=i,!this._templateInfos[i.hash]){const t={};t.samplerStartBinding=i.blocks.length,t.gfxBlocks=[],t.gfxSamplerTextures=[],t.bindings=[],t.blockSizes=[];for(let e=0;e<i.blocks.length;e++){const n=i.blocks[e];t.blockSizes.push(tg(n)),t.bindings.push(new io(n.binding,n.descriptorType||hr.UNIFORM_BUFFER,1,n.stageFlags)),t.gfxBlocks.push(new Fr(hp.MATERIAL,n.binding,n.name,n.members.map((t=>new Lr(t.name,t.type,t.count))),1))}for(let e=0;e<i.samplerTextures.length;e++){const n=i.samplerTextures[e];t.bindings.push(new io(n.binding,n.descriptorType||hr.SAMPLER_TEXTURE,n.count,n.stageFlags)),t.gfxSamplerTextures.push(new zr(hp.MATERIAL,n.binding,n.name,n.type,n.count))}t.gfxAttributes=[];for(let e=0;e<i.attributes.length;e++){const n=i.attributes[e];t.gfxAttributes.push(new Wr(n.name,n.format,n.isNormalized,0,n.isInstanced,n.location))}Qf(i,t,np,"locals"),t.gfxStages=[],t.gfxStages.push(new jr(Js.VERTEX,"")),t.gfxStages.push(new jr(Js.FRAGMENT,"")),t.handleMap=function(t){const e={};for(let i=0;i<t.blocks.length;i++){const n=t.blocks[i],s=n.members;let r=0;for(let t=0;t<s.length;t++){const i=s[t];e[i.name]=Vf(zf.BUFFER,hp.MATERIAL,n.binding,i.type,r),r+=(Co(i.type)>>2)*i.count}}for(let i=0;i<t.samplerTextures.length;i++){const n=t.samplerTextures[i];e[n.name]=Vf(zf.TEXTURE,hp.MATERIAL,n.binding,n.type)}return e}(i),t.setLayouts=[],this._templateInfos[i.hash]=t}return i}getTemplate(t){return this._templates[t]}getTemplateInfo(t){const e=this._templates[t].hash;return this._templateInfos[e]}getDescriptorSetLayout(t,e,i=!1){const n=this._templates[e],s=this._templateInfos[n.hash];return s.setLayouts.length||($f.bindings=s.bindings,s.setLayouts[hp.MATERIAL]=t.createDescriptorSetLayout($f),$f.bindings=np.bindings,s.setLayouts[hp.LOCAL]=t.createDescriptorSetLayout($f)),s.setLayouts[i?hp.LOCAL:hp.MATERIAL]}hasProgram(t){return void 0!==this._templates[t]}getKey(t,e){const i=this._templates[t],n=i.defines;if(i.uber){let t="";for(let i=0;i<n.length;i++){const s=n[i],r=e[s.name];if(!r||!s._map)continue;const o=s._map(r);t+=`${s._offset}${o}|`}return`${t}${i.hash}`}let s=0;for(let t=0;t<n.length;t++){const i=n[t],r=e[i.name];r&&i._map&&(s|=i._map(r)<<i._offset)}return`${s.toString(16)}|${i.hash}`}destroyShaderByDefines(t){const e=Object.keys(t);if(!e.length)return;const i=e.map((e=>{let i=t[e];return"boolean"==typeof i&&(i=i?"1":"0"),new RegExp(`${e}${i}`)})),n=Object.keys(this._cache).filter((t=>i.every((e=>e.test(this._cache[t].name)))));for(let t=0;t<n.length;t++){const e=n[t],i=this._cache[e];f(`destroyed shader ${i.name}`),i.destroy(),delete this._cache[e]}}getGFXShader(t,e,i,n,s){Object.assign(i,n.macros),s||(s=this.getKey(e,i));const r=this._cache[s];if(r)return r;const o=this._templates[e],a=this._templateInfos[o.hash];a.pipelineLayout||(this.getDescriptorSetLayout(t,e),Qf(o,a,ip,"globals"),a.setLayouts[hp.GLOBAL]=n.descriptorSetLayout,a.pipelineLayout=t.createPipelineLayout(new ro(a.setLayouts)));const l=function(t,e){const i=[];for(let n=0;n<e.length;n++){const s=e[n],r=s.name,o=t[r],a=Zf(s,o),l=!o||"0"===o;i.push({name:r,value:a,isDefault:l})}return i}(i,o.defines),c=n.constantMacros+o.constantMacros+l.reduce(((t,e)=>`${t}#define ${e.name} ${e.value}\n`),"");let h=o.glsl3;const _=ig(t);_?h=o[_]:console.error("Invalid GFX API!"),a.gfxStages[0].source=c+h.vert,a.gfxStages[1].source=c+h.frag;const u=function(t,e,i){const n=[],s=t.attributes,r=e.gfxAttributes;for(let t=0;t<s.length;t++)eg(s[t].defines,i)&&n.push(r[t]);return n}(o,a,i),m=function(t,e){return t+e.reduce(((t,e)=>e.isDefault?t:`${t}|${e.name}${e.value}`),"")}(e,l),p=new qr(m,a.gfxStages,u,a.gfxBlocks);return p.samplerTextures=a.gfxSamplerTextures,this._cache[s]=t.createShader(p)}};n.programLib=ng;const sg={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 miscParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nvarying float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(s.position, s.roughness);\ngl_FragData[2] = vec4(s.normal, s.metallic);\ngl_FragData[3] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying float v_fog_factor;\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_fogColor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture2D(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_exposure;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform lowp vec4 cc_shadowNFLSInfo;\nuniform lowp vec4 cc_shadowWHPBInfo;\nuniform lowp vec4 cc_shadowLPNNInfo;\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture2D(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture2D(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvarying vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture2D(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture2D(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture2D(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\ngl_FragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform highp mat4 cc_matLightPlaneProj;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\nvarying vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_exposure;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nvarying float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nin float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin float v_fog_factor;\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nout float v_fog_factor;\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nuniform sampler2D cc_shadowMap;\nuniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nin vec2 v_uv;\nuniform sampler2D cc_gbuffer_albedoMap;\nuniform sampler2D cc_gbuffer_positionMap;\nuniform sampler2D cc_gbuffer_normalMap;\nuniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec2 v_uv;\nuniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nout float v_percent;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nin float v_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]],glsl4:[[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(set = 1, binding = 1) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 3) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 2) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(location = 0) in vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec4 v_color;\nlayout(location = 2) in float a_dist;\nlayout(location = 1) out float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(location = 0) in vec4 v_color;\nlayout(location = 1) in float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(set = 1, binding = 1) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(set = 1, binding = 2) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nlayout(location = 0) in vec4 a_position_starttime;\nlayout(location = 1) in vec4 a_size_uv;\nlayout(location = 2) in vec4 a_rotation_uv;\nlayout(location = 3) in vec4 a_color;\nlayout(location = 4) in vec4 a_dir_life;\nlayout(location = 5) in float a_rndSeed;\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord;\nlayout(location = 7) in vec3 a_texCoord3;\nlayout(location = 8) in vec3 a_normal;\nlayout(location = 9) in vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom (float seed) {\nseed = mod(seed, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 10) uniform sampler2D color_over_time_tex0;\nlayout(set = 1, binding = 3) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 11) uniform sampler2D rotation_over_time_tex0;\nlayout(set = 1, binding = 4) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 12) uniform sampler2D size_over_time_tex0;\nlayout(set = 1, binding = 5) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 13) uniform sampler2D force_over_time_tex0;\nlayout(set = 1, binding = 6) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nlayout(set = 1, binding = 14) uniform sampler2D velocity_over_time_tex0;\nlayout(set = 1, binding = 7) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nlayout(set = 1, binding = 15) uniform sampler2D texture_animation_tex0;\nlayout(set = 1, binding = 8) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 toQuat(vec3 rotation) {\nvec3 rotTmp = rotation;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\nreturn rot;\n}\nmat3 QuatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 Mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 EulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\nvec4 rot = toQuat(startRotation);\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = EulerToQuat(euler);\nmat3 mLocal = QuatToMat3(quat);\nmat3 mStart = QuatToMat3(rot);\nrot = Mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 16) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 9) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) out vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\n#if CC_DRAW_WIRE_FRAME\nlayout(location = 2) in vec3 vBarycentric;\n#endif\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(location = 0) out mediump vec2 uv;\nlayout(location = 1) out mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_texCoord;\nlayout(location = 2) in vec3 a_texCoord1;\nlayout(location = 3) in vec3 a_texCoord2;\nlayout(location = 4) in vec4 a_color;\n#if CC_RENDER_MODE == 1\nlayout(location = 8) in vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nlayout(location = 6) in vec3 a_texCoord3;\nlayout(location = 7) in vec3 a_normal;\nlayout(location = 8) in vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z);\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 uv;\nlayout(location = 1) in vec4 color;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nlayout(set = 1, binding = 1) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 v_light;\nlayout(location = 1) out vec2 uv0;\n#if TWO_COLORED\nlayout(location = 3) in vec4 a_color2;\nlayout(location = 2) out vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 v_light;\n#if TWO_COLORED\nlayout(location = 2) in vec4 v_dark;\n#endif\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_LOCAL\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 2) in vec4 a_color;\nlayout(location = 0) out vec4 color;\nlayout(location = 1) out vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(set = 1, binding = 0) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nlayout(location = 0) in vec4 color;\n#if USE_TEXTURE\nlayout(location = 1) in vec2 uv0;\nlayout(set = 2, binding = 10) uniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nlayout(location = 13) in vec4 a_color;\nlayout(location = 2) out vec4 v_color;\n#endif\nlayout(location = 3) out vec3 v_position;\nlayout(location = 4) out vec3 v_normal;\nlayout(location = 5) out vec2 v_uv;\nlayout(location = 6) out vec2 v_uv1;\n#if USE_NORMAL_MAP\nlayout(location = 7) out vec3 v_tangent;\nlayout(location = 8) out vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 14) in vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) out vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(pos);\n#else\nv_fog_factor = 1.0;\n#endif\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(location = 0) in float v_fog_factor;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 9) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 3) in vec3 v_position;\nlayout(location = 5) in vec2 v_uv;\nlayout(location = 6) in vec2 v_uv1;\nlayout(location = 4) in vec3 v_normal;\n#if USE_VERTEX_COLOR\nlayout(location = 2) in vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nlayout(location = 7) in vec3 v_tangent;\nlayout(location = 8) in vec3 v_bitangent;\nlayout(set = 1, binding = 2) uniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nlayout(set = 1, binding = 3) uniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nlayout(set = 1, binding = 4) uniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nlayout(set = 1, binding = 5) uniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nlayout(set = 1, binding = 6) uniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * miscParams.x) * normalize(v_tangent) +\n(nmmp.y * miscParams.x) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\ns.position = v_position;\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.w;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = clamp(pbr.x, 0.0, 0.96);\ns.roughness = clamp(pbr.y, 0.04, 1.0);\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nlayout(location = 13) in vec2 a_texCoord1;\n#endif\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out vec2 v_uv1;\nlayout(location = 2) out vec4 v_worldPos;\nlayout(location = 3) out float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 miscParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in vec2 v_uv1;\nlayout(location = 2) in vec4 v_worldPos;\nlayout(location = 3) in float v_clip_depth;\n#if USE_ALBEDO_MAP\nlayout(set = 1, binding = 1) uniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nvec4 viewStartPos = cc_matLightView * v_worldPos;\nfloat dist = length(viewStartPos.xyz);\nfloat linearDepth = cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\nreturn vec4(linearDepth, 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\nlayout(location = 1) out highp vec4 v_shadowPos;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\n#endif\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 2) out highp vec3 v_position;\nlayout(location = 3) out mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) out mediump vec3 v_tangent;\nlayout(location = 5) out mediump vec3 v_binormal;\n#endif\nlayout(location = 6) out mediump vec2 uvw;\nlayout(location = 7) out mediump vec2 uv0;\nlayout(location = 8) out mediump vec2 uv1;\nlayout(location = 9) out mediump vec2 uv2;\nlayout(location = 10) out mediump vec2 uv3;\nlayout(location = 11) out mediump vec3 luv;\nlayout(location = 12) out mediump vec3 diffuse;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(vec4(worldPos, 1.0));\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(vec4(worldPos, 1.0));\n#else\nv_fog_factor = 1.0;\n#endif\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\nlayout(location = 1) in highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nlayout(location = 13) in vec3 v_luv;\nlayout(set = 2, binding = 9) uniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nlayout(location = 2) in highp vec3 v_position;\nlayout(location = 3) in mediump vec3 v_normal;\n#if USE_NORMALMAP\nlayout(location = 4) in mediump vec3 v_tangent;\nlayout(location = 5) in mediump vec3 v_binormal;\n#endif\nlayout(location = 6) in mediump vec2 uvw;\nlayout(location = 7) in mediump vec2 uv0;\nlayout(location = 8) in mediump vec2 uv1;\nlayout(location = 9) in mediump vec2 uv2;\nlayout(location = 10) in mediump vec2 uv3;\nlayout(location = 12) in mediump vec3 diffuse;\nlayout(location = 11) in mediump vec3 luv;\nlayout(set = 1, binding = 1) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nlayout(set = 1, binding = 2) uniform sampler2D weightMap;\nlayout(set = 1, binding = 3) uniform sampler2D detailMap0;\nlayout(set = 1, binding = 4) uniform sampler2D detailMap1;\nlayout(set = 1, binding = 5) uniform sampler2D detailMap2;\nlayout(set = 1, binding = 6) uniform sampler2D detailMap3;\nlayout(set = 1, binding = 7) uniform sampler2D normalMap0;\nlayout(set = 1, binding = 8) uniform sampler2D normalMap1;\nlayout(set = 1, binding = 9) uniform sampler2D normalMap2;\nlayout(set = 1, binding = 10) uniform sampler2D normalMap3;\nlayout(set = 1, binding = 11) uniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\ns.position = v_position;\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_STANDARD_TRANSPARENT)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, v_fog_factor), color.a);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nlayout(location = 3) out vec4 fragColor3;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(s.position, s.roughness);\nfragColor2 = vec4(s.normal, s.metallic);\nfragColor3 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 160581375.0) * depth;\nret = fract(ret);\nret -= ret.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);\nreturn ret;\n}\nlayout(location = 0) in vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) out float v_fog_factor;\n#if USE_VERTEX_COLOR\nlayout(location = 13) in lowp vec4 a_color;\nlayout(location = 1) out lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nlayout(location = 2) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\n#if CC_USE_FOG == 0\nv_fog_factor = LinearFog(matWorld * position);\n#elif CC_USE_FOG == 1\nv_fog_factor = ExpFog(matWorld * position);\n#elif CC_USE_FOG == 2\nv_fog_factor = ExpSquaredFog(matWorld * position);\n#elif CC_USE_FOG == 3\nv_fog_factor = LayeredFog(matWorld * position);\n#else\nv_fog_factor = 1.0;\n#endif\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in float v_fog_factor;\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nlayout(location = 2) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\n#endif\nlayout(set = 1, binding = 1) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nlayout(location = 1) in lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no *= v_color;\n#endif\n#if USE_TEXTURE\no *= texture(mainTexture, v_uv);\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\no = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, o.rgb, v_fog_factor), o.a);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\n#if CC_RECEIVE_SHADOW\nlayout(set = 0, binding = 3) uniform sampler2D cc_shadowMap;\nlayout(set = 0, binding = 5) uniform sampler2D cc_spotLightingMap;\nfloat CCGetLinearDepth (vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nfloat dist = length(viewStartPos.xyz);\nreturn cc_shadowNFLSInfo.x + (-dist / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x));\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z- cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z - cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat bias = cc_shadowWHPBInfo.w;\nfloat offsetDepth = clipPos.z - bias;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth - cc_shadowWHPBInfo.w, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = dot(texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n} else {\nfloat closestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x - offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y - offsety)).x;\nshadow += step(offsetDepth, closestDepth);\nclosestDepth = texture(cc_spotLightingMap, vec2(clipPos.x + offsetx, clipPos.y + offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\nreturn shadow / 5.0;\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec3 clipPos = shadowPos.xyz / shadowPos.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z <-1.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetx = 1.0 / cc_shadowWHPBInfo.x;\nfloat offsety = 1.0 / cc_shadowWHPBInfo.y;\nfloat shadow = 0.0;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat offsetDepth = depth - cc_shadowWHPBInfo.w;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = dot(texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 160581375.0));\nshadow += step(offsetDepth, closestDepth);\n}\n}\n} else {\nfor (int i = -1; i <= 1; i++) {\nfor (int j = -1; j <= 1; j++) {\nfloat closestDepth = texture(cc_spotLightingMap, clipPos.xy + vec2(i, j) * vec2(offsetx, offsety)).x;\nshadow += step(offsetDepth, closestDepth);\n}\n}\n}\nreturn shadow / 9.0;\n}\n#endif\n#if CC_USE_IBL\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\nstruct StandardSurface {\nvec4 albedo;\nvec3 position;\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nvec3 projWorldPos = shadowPos.xyz + (1.0 - NL) * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb) * cc_ambientSky.w;\nfinalColor += (ambDiff.rgb * diffuse) * s.occlusion;\n#if CC_USE_IBL\nvec3 R = normalize(reflect(-V, N));\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\n#if CC_USE_HDR\ns.emissive *= cc_exposure.w;\n#endif\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\nlayout(set = 2, binding = 1) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - s.position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - s.position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nfloat cosAngle = clamp(1.0 - dot(N, normalize(cc_lightPos[i].xyz - s.position.xyz)), 0.0, 1.0);\nvec3 projWorldPos = shadowPos.xyz + cosAngle * cc_shadowLPNNInfo.z * N;\nvec4 pos = vec4(projWorldPos.xyz, shadowPos.w);\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(pos, s.position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(pos, s.position);\nelse shadow = CCGetSpotLightShadowFactorHard(pos, s.position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = distance(cc_cameraPos, wPos) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 6) uniform sampler2D cc_gbuffer_albedoMap;\nlayout (set = 0, binding = 7) uniform sampler2D cc_gbuffer_positionMap;\nlayout (set = 0, binding = 8) uniform sampler2D cc_gbuffer_normalMap;\nlayout (set = 0, binding = 9) uniform sampler2D cc_gbuffer_emissiveMap;\nlayout(location = 0) out vec4 fragColor;\nvoid main () {\nStandardSurface s;\nvec4 albedoMap = texture(cc_gbuffer_albedoMap,v_uv);\nvec4 positionMap = texture(cc_gbuffer_positionMap,v_uv);\nvec4 normalMap = texture(cc_gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(cc_gbuffer_emissiveMap,v_uv);\ns.albedo = albedoMap;\ns.position = positionMap.xyz;\ns.roughness = positionMap.w;\ns.normal = normalMap.xyz;\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\n#if CC_USE_FOG == 0\nfogFactor = LinearFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 1\nfogFactor = ExpFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 2\nfogFactor = ExpSquaredFog(vec4(s.position, 1));\n#elif CC_USE_FOG == 3\nfogFactor = LayeredFog(vec4(s.position, 1));\n#else\nfogFactor = 1.0;\n#endif\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(s.position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\nCCStandardShadingAdditive(s, shadowPos);\ncolor = vec4(mix(CC_FORWARD_ADD > 0 ? vec3(0.0) : cc_fogColor.rgb, color.rgb, fogFactor), color.a);\nfragColor = CCFragOutput(color);\n}"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\n#if USE_INSTANCING\nlayout(location = 8) in vec4 a_matWorld0;\nlayout(location = 9) in vec4 a_matWorld1;\nlayout(location = 10) in vec4 a_matWorld2;\n#if USE_LIGHTMAP\nlayout(location = 11) in vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nlayout(location = 12) in float a_dyn_batch_id;\nlayout(set = 2, binding = 0) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(set = 2, binding = 0) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nposition = cc_matProj * (cc_matView * cc_matLightPlaneProj * matWorld) * position;\nposition.z -= 0.0001;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 2) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nlowp  vec4 cc_shadowNFLSInfo;\nlowp  vec4 cc_shadowWHPBInfo;\nlowp  vec4 cc_shadowLPNNInfo;\nlowp  vec4 cc_shadowColor;\n};\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nvec4 frag () {\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"#extension GL_EXT_shader_explicit_arithmetic_types_int32: require\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\n#if CC_USE_MORPH\nint getVertexId() {\nreturn gl_VertexIndex;\n}\nlayout(set = 2, binding = 4) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nlayout(set = 2, binding = 6) uniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nlayout(set = 2, binding = 7) uniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nlayout(set = 2, binding = 8) uniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nlayout(location = 4) in u32vec4 a_joints;\nlayout(location = 5) in vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nlayout(location = 7) in highp vec4 a_jointAnimInfo;\n#endif\nlayout(set = 2, binding = 3) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(set = 2, binding = 2) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nlayout(set = 2, binding = 5) uniform highp sampler2D cc_jointTexture;\n#else\nlayout(set = 2, binding = 3) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) out vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec2 v_uv;\nlayout (set = 0, binding = 10) uniform sampler2D cc_lighting_resultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(cc_lighting_resultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n}"}],[{vert:"\nprecision highp float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec3 a_normal;\nlayout(location = 2) in vec2 a_texCoord;\nlayout(location = 3) in vec4 a_tangent;\nlayout(location = 0) out mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nmat4 matProj = cc_matProj;\nif (matProj[3].w > 0.0) {\nvec2 scale = vec2(48.0, 24.0);\nmatProj[0].xy *= scale;\nmatProj[1].xy *= scale;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\n}\nvec4 pos = matProj * matViewRotOnly * viewDir;\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(set = 0, binding = 4) uniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if !CC_USE_HDR\ncolor.rgb = sqrt(ACESToneMap(color.rgb));\n#endif\nreturn color;\n}\nlayout(location = 0) in mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nlayout(location = 0) in vec3 a_position;\nlayout(location = 1) in vec4 a_color;\nlayout(location = 0) out vec2 v_uv;\nlayout(set = 1, binding = 0) uniform Constants {\nvec4 offset;\n};\nlayout(set = 1, binding = 1) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nvec4 position = cc_matViewProj * vec4(a_position, 1.0);\nposition.xy += offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(set = 0, binding = 0) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(set = 0, binding = 1) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = mix(color.rgb, SRGBToLinear(color.rgb) * cc_exposure.w, vec3(cc_exposure.z));\n#endif\nreturn color;\n}\nlayout(location = 0) in vec2 v_uv;\nlayout(set = 1, binding = 2) uniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(location = 0) in vec2 a_position;\nlayout(location = 1) in vec2 a_texCoord;\nlayout(location = 0) out vec2 v_uv;\nlayout(location = 1) out float v_percent;\nlayout(set = 1, binding = 0) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nv_percent = u_buffer0.z;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(location = 0) in vec2 v_uv;\nlayout(location = 1) in float v_percent;\nlayout(set = 1, binding = 1) uniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat precent = clamp(v_percent, 0.0, 1.0);\ncolor.xyz *= precent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},rg=t("builtinResMgr",n.builtinResMgr=new class{constructor(){this._device=null,this._resources={}}initBuiltinRes(t){this._device=t;const e=this._resources,i=document.createElement("canvas"),s=i.getContext("2d"),r=new Gd(i),o=i.width=i.height=2;s.fillStyle="#000",s.fillRect(0,0,o,o);const a=new Af;a._uuid="black-texture",a.image=r,e[a._uuid]=a,s.fillStyle="rgba(0,0,0,0)",s.fillRect(0,0,o,o);const l=new Af;l._uuid="empty-texture",l.image=r,e[l._uuid]=l;const c=new Rf;c._uuid="black-cube-texture",c.setMipFilter(Rf.Filter.NEAREST),c.image={front:new Gd(i),back:new Gd(i),left:new Gd(i),right:new Gd(i),top:new Gd(i),bottom:new Gd(i)},e[c._uuid]=c,s.fillStyle="#777",s.fillRect(0,0,o,o);const h=new Af;h._uuid="grey-texture",h.image=r,e[h._uuid]=h,s.fillStyle="#fff",s.fillRect(0,0,o,o);const _=new Af;_._uuid="white-texture",_.image=r,e[_._uuid]=_;const u=new Rf;u._uuid="white-cube-texture",u.setMipFilter(Rf.Filter.NEAREST),u.image={front:new Gd(i),back:new Gd(i),left:new Gd(i),right:new Gd(i),top:new Gd(i),bottom:new Gd(i)},e[u._uuid]=u,s.fillStyle="#7f7fff",s.fillRect(0,0,o,o);const m=new Af;m._uuid="normal-texture",m.image=r,e[m._uuid]=m,i.width=i.height=16,s.fillStyle="#ddd",s.fillRect(0,0,16,16),s.fillStyle="#555",s.fillRect(0,0,8,8),s.fillStyle="#555",s.fillRect(8,8,8,8);const p=new Af;p._uuid="default-texture",p.image=r,e[p._uuid]=p;const d=new Rf;if(d.setMipFilter(Rf.Filter.NEAREST),d._uuid="default-cube-texture",d.image={front:new Gd(i),back:new Gd(i),left:new Gd(i),right:new Gd(i),top:new Gd(i),bottom:new Gd(i)},e[d._uuid]=d,n.SpriteFrame){const t=new n.SpriteFrame,i=r,s=new Af;s.image=i,t.texture=s,t._uuid="default-spriteframe",e[t._uuid]=t}const f=ig(t);if(!f)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));const g=sg[f];return g?Promise.resolve().then((()=>{Of.forEach(((t,e)=>{const i=Object.assign(new n.EffectAsset,t);i.shaders.forEach(((t,i)=>{const n=g[e][i];n&&(t[f]=n)})),i.hideInEditor=!0,i.onLoaded()})),this._initMaterials()})):Promise.reject(Error(`Current device is requiring builtin shaders of version ${f} but shaders of that version are not assembled in this build.`))}get(t){return this._resources[t]}_initMaterials(){const t=this._resources,e=[],i=new n.Material;i._uuid="standard-material",i.initialize({effectName:"standard"}),t[i._uuid]=i,e.push(i);const s=new n.Material;s._uuid="missing-effect-material",s.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),s.setProperty("mainColor",n.color("#ffff00")),t[s._uuid]=s,e.push(s);const r=new n.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",n.color("#ff00ff")),t[r._uuid]=r,e.push(r);const o=new n.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),t[o._uuid]=o,e.push(o);const a=new n.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),t[a._uuid]=a,e.push(a);const l=new n.Material;l._uuid="ui-sprite-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[l._uuid]=l,e.push(l);const c=new n.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),t[c._uuid]=c,e.push(c);const h=new n.Material;h._uuid="ui-sprite-gray-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),t[h._uuid]=h,e.push(h);const _=new n.Material;_._uuid="ui-sprite-alpha-sep-material",_.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),t[_._uuid]=_,e.push(_);const u=new n.Material;u._uuid="ui-sprite-gray-alpha-sep-material",u.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),t[u._uuid]=u,e.push(u);const m=new n.Material;m._uuid="ui-graphics-material",m.initialize({effectName:"graphics"}),t[m._uuid]=m,e.push(m);const p=new n.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),t[p._uuid]=p,e.push(p);const d=new n.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),t[d._uuid]=d,e.push(d);const f=new n.Material;f._uuid="default-trail-material",f.initialize({effectName:"particle-trail"}),t[f._uuid]=f,e.push(f);const g=new n.Material;g._uuid="default-billboard-material",g.initialize({effectName:"billboard"}),t[g._uuid]=g,e.push(g);const y=new n.Material;y._uuid="default-spine-material",y.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),t[y._uuid]=y,e.push(y),n.game.on(n.Game.EVENT_GAME_INITED,(()=>{for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.passes.length;++t)i.passes[t].tryCompile()}}))}}),og=(()=>{const t=new Map;let e=0;return i=>"number"==typeof i?i:(t.has(i)||(t.set(i,1<<e),e++),t.get(i))})(),ag=new Pr(Ls.UNIFORM|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE),lg=new Dr(null),cg=new so(null);let hg;!function(t){t[t.NONE=0]="NONE",t[t.INSTANCING=1]="INSTANCING",t[t.VB_MERGING=2]="VB_MERGING"}(hg||(hg={}));class _g{static fillPipelineInfo(t,e){void 0!==e.priority&&t._setPriority(e.priority),void 0!==e.primitive&&t._setPrimitive(e.primitive),void 0!==e.stage&&t._setStage(e.stage),void 0!==e.dynamicStates&&t._setDynamicState(e.dynamicStates),void 0!==e.phase&&t._setPhase(og(e.phase));const i=t._bs;if(e.blendState){const t=e.blendState,{targets:n}=t;n&&n.forEach(((t,e)=>{i.setTarget(e,t)})),void 0!==t.isA2C&&(i.isA2C=t.isA2C),void 0!==t.isIndepend&&(i.isIndepend=t.isIndepend),void 0!==t.blendColor&&(i.blendColor=t.blendColor)}t._rs.assign(e.rasterizerState),t._dss.assign(e.depthStencilState)}static getPassHash(t){let e=`${ng.getKey(t.program,t.defines)},${t._primitive},${t._dynamicStates}`;var i;return e+=function(t){let e=`,bs,${t.isA2C}`;for(const i of t.targets)e+=`,bt,${i.blend},${i.blendEq},${i.blendAlphaEq},${i.blendColorMask}`,e+=`,${i.blendSrc},${i.blendDst},${i.blendSrcAlpha},${i.blendDstAlpha}`;return e}(t._bs),e+=function(t){let e=`,dss,${t.depthTest},${t.depthWrite},${t.depthFunc}`;return e+=`,${t.stencilTestFront},${t.stencilFuncFront},${t.stencilRefFront},${t.stencilReadMaskFront}`,e+=`,${t.stencilFailOpFront},${t.stencilZFailOpFront},${t.stencilPassOpFront},${t.stencilWriteMaskFront}`,e+=`,${t.stencilTestBack},${t.stencilFuncBack},${t.stencilRefBack},${t.stencilReadMaskBack}`,e+=`,${t.stencilFailOpBack},${t.stencilZFailOpBack},${t.stencilPassOpBack},${t.stencilWriteMaskBack}`,e}(t._dss),e+=`,rs,${(i=t._rs).cullMode},${i.depthBias},${i.isFrontFaceCCW}`,Uo(e,666)}get native(){return this._nativeObj}constructor(t){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new ta,this._dss=new ia,this._rs=new ea,this._priority=ep.DEFAULT,this._stage=tp.DEFAULT,this._phase=og("default"),this._primitive=sr.TRIANGLE_LIST,this._batchingScheme=hg.NONE,this._dynamicStates=lr.NONE,this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=t,this._device=t.device}initialize(t){this._doInit(t),this.resetUBOs(),this.resetTextures(),this.tryCompile()}getHandle(t,e=0,i=Ns.UNKNOWN){let n=this._propertyHandleMap[t];return n?(i?n=jf(n,i):e&&(n=jf(n,Gf(n)-e)),n+e):0}getBinding(t){const e=this.getHandle(t);return e?_g.getBindingFromHandle(e):-1}setUniform(t,e){const i=_g.getBindingFromHandle(t),n=_g.getTypeFromHandle(t),s=_g.getOffsetFromHandle(t),r=this._blocks[i];qf[n](r,e,s),this._setRootBufferDirty(!0)}getUniform(t,e){const i=_g.getBindingFromHandle(t),n=_g.getTypeFromHandle(t),s=_g.getOffsetFromHandle(t),r=this._blocks[i];return Wf[n](r,e,s)}setUniformArray(t,e){const i=_g.getBindingFromHandle(t),n=_g.getTypeFromHandle(t),s=Co(n)>>2,r=this._blocks[i];let o=_g.getOffsetFromHandle(t);for(let t=0;t<e.length;t++,o+=s)null!==e[t]&&qf[n](r,e[t],o);this._setRootBufferDirty(!0)}bindTexture(t,e,i){this._descriptorSet.bindTexture(t,e,i||0)}bindSampler(t,e,i){this._descriptorSet.bindSampler(t,e,i||0)}setDynamicState(t,e){const i=this._dynamics[t];i&&i.value===e||(i.value=e,i.dirty=!0)}overridePipelineStates(t,e){console.warn("base pass cannot override states, please use pass instance instead.")}_setRootBufferDirty(t){this._rootBufferDirty=t,this._nativeObj.setRootBufferDirty(t)}update(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update(),this._nativeObj.update()):T(12006)}_initNative(){this._nativeObj||(this._nativeObj=new Zn,this._passHandle=ol.alloc(),this._nativePriority=ol.getTypedArray(this._passHandle,nl.PRIORITY),this._nativeStage=ol.getTypedArray(this._passHandle,nl.STAGE),this._nativePhase=ol.getTypedArray(this._passHandle,nl.PHASE),this._nativePrimitive=ol.getTypedArray(this._passHandle,nl.PRIMITIVE),this._nativeBatchingScheme=ol.getTypedArray(this._passHandle,nl.BATCHING_SCHEME),this._nativeDynamicStates=ol.getTypedArray(this._passHandle,nl.DYNAMIC_STATE),this._nativeHash=ol.getTypedArray(this._passHandle,nl.HASH),this._nativeObj.initWithData(ol.getBuffer(this._passHandle)))}_destroy(){this._nativeObj=null,this._passHandle&&ol.free(this._passHandle)}destroy(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t];this._buffers[e.binding].destroy()}this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()}resetUniform(t){const e=this.getHandle(t);if(!e)return;const i=_g.getTypeFromHandle(e),n=_g.getBindingFromHandle(e),s=_g.getOffsetFromHandle(e),r=this._blocks[n],o=this._properties[t],a=o&&o.value||Yf(i);qf[i](r,a,s),this._setRootBufferDirty(!0)}resetTexture(t,e){const i=this.getHandle(t);if(!i)return;const n=_g.getTypeFromHandle(i),s=_g.getBindingFromHandle(i),r=this._properties[t],o=r&&r.value,a=o?`${o}-texture`:Yf(n),l=rg.get(a),c=l&&l.getGFXTexture(),h=r&&void 0!==r.samplerHash?r.samplerHash:l&&l.getSamplerHash(),_=Xd.getSampler(this._device,h);this._descriptorSet.bindSampler(s,_,e),this._descriptorSet.bindTexture(s,c,e)}resetUBOs(){for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding];let n=0;for(let t=0;t<e.members.length;t++){const s=e.members[t],r=this._properties[s.name],o=r&&r.value||Yf(s.type),a=(Co(s.type)>>2)*s.count;for(let t=0;t+o.length<=a;t+=o.length)i.set(o,n+t);n+=a}}this._setRootBufferDirty(!0)}resetTextures(){for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++)this.resetTexture(e.name,t)}}tryCompile(){const{pipeline:t}=this._root;if(!t)return!1;this._syncBatchingScheme();const e=ng.getGFXShader(this._device,this._programName,this._defines,t);return e?(this._shader=e,this._setPipelineLayout(ng.getTemplateInfo(this._programName).pipelineLayout),this._setHash(_g.getPassHash(this)),!0):(console.warn(`create shader ${this._programName} failed`),!1)}getShaderVariant(t=null){if(!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!t)return this._shader;const{pipeline:e}=this._root;for(let e=0;e<t.length;e++){const i=t[e];this._defines[i.name]=i.value}const i=ng.getGFXShader(this._device,this._programName,this._defines,e);for(let e=0;e<t.length;e++){const i=t[e];delete this._defines[i.name]}return i}beginChangeStatesSilently(){}endChangeStatesSilently(){}_setPriority(t){this._priority=t,this._nativePriority[0]=t}_setStage(t){this._stage=t,this._nativeStage[0]=t}_setPhase(t){this._phase=t,this._nativePhase[0]=t}_setPrimitive(t){this._primitive=t,this._nativePrimitive[0]=t}_setState(t,e,i,n){this._bs=t,this._dss=e,this._rs=i,this._descriptorSet=n,this._nativeObj.blendState=t.native,this._nativeObj.depthStencilState=e.native,this._nativeObj.rasterizerState=i.native,this._nativeObj.descriptorSet=n}_doInit(t,e=!1){this._initNative(),this._setPriority(ep.DEFAULT),this._setStage(tp.DEFAULT),this._setPhase(og("default")),this._setPrimitive(sr.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=e?{...t.defines}:t.defines,this._shaderInfo=ng.getTemplate(t.program),this._properties=t.properties||this._properties;const i=this._device;_g.fillPipelineInfo(this,t),t.stateOverrides&&_g.fillPipelineInfo(this,t.stateOverrides),cg.layout=ng.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(cg),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);const n=this._shaderInfo.blocks,s=ng.getTemplateInfo(t.program),{blockSizes:r,handleMap:o}=s,a=i.capabilities.uboOffsetAlignment,l=[];let c=0,h=0;for(let t=0;t<n.length;t++){const e=r[t];l.push(h),h+=Math.ceil(e/a)*a,c=e}const _=l[l.length-1]+c;_&&(ag.size=16*Math.ceil(_/16),this._rootBuffer=i.createBuffer(ag),this._rootBlock=new ArrayBuffer(_),this._nativeObj.setRootBufferAndBlock(this._rootBuffer,this._rootBlock));for(let t=0,e=0;t<n.length;t++){const{binding:s}=n[t],o=r[t];lg.buffer=this._rootBuffer,lg.offset=l[e++],lg.range=16*Math.ceil(o/16);const a=this._buffers[s]=i.createBuffer(lg);this._blocks[s]=new Float32Array(this._rootBlock,lg.offset,o/Float32Array.BYTES_PER_ELEMENT),this._descriptorSet.bindBuffer(s,a)}const u=this._propertyHandleMap=o,m={};for(const t in this._properties){const e=this._properties[t];e.handleInfo&&(m[t]=this.getHandle.apply(this,e.handleInfo))}Object.assign(u,m)}_syncBatchingScheme(){this._defines.USE_INSTANCING?this._device.hasFeature(Ms.INSTANCED_ARRAYS)?this._setBatchingScheme(hg.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(hg.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(hg.VB_MERGING):this._setBatchingScheme(hg.NONE)}_setBatchingScheme(t){this._batchingScheme=t,this._nativeBatchingScheme[0]=t}_setDynamicState(t){this._dynamicStates=t,this._nativeDynamicStates[0]=t}_setHash(t){this._hash=t,this._nativeHash[0]=t}_setPipelineLayout(t){this._pipelineLayout=t,this._nativeObj.setPipelineLayout(t)}_initPassFromTarget(t,e,i,n){this._initNative(),this._setPriority(t.priority),this._setStage(t.stage),this._setPhase(t.phase),this._setBatchingScheme(t.batchingScheme),this._setPrimitive(t.primitive),this._setDynamicState(t.dynamicStates),this._setState(i,e,t.rasterizerState,t.descriptorSet),this._passIndex=t.passIndex,this._propertyIndex=t.propertyIndex,this._programName=t.program,this._defines=t.defines,this._shaderInfo=t._shaderInfo,this._properties=t._properties,this._blocks=t._blocks,this._dynamics=t._dynamics,this._shader=t._shader,this._setPipelineLayout(ng.getTemplateInfo(this._programName).pipelineLayout),this._setHash(t._hash^n)}get root(){return this._root}get device(){return this._device}get shaderInfo(){return this._shaderInfo}get localSetLayout(){return ng.getDescriptorSetLayout(this._device,this._programName,!0)}get program(){return this._programName}get properties(){return this._properties}get defines(){return this._defines}get passIndex(){return this._passIndex}get propertyIndex(){return this._propertyIndex}get dynamics(){return this._dynamics}get blocks(){return this._blocks}get rootBufferDirty(){return this._rootBufferDirty}get priority(){return this._priority}get primitive(){return this._primitive}get stage(){return this._stage}get phase(){return this._phase}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get dynamicStates(){return this._dynamicStates}get batchingScheme(){return this._batchingScheme}get descriptorSet(){return this._descriptorSet}get hash(){return this._hash}get pipelineLayout(){return this._pipelineLayout}}_g.PropertyType=zf,_g.getPropertyTypeFromHandle=Uf,_g.getTypeFromHandle=Gf,_g.getBindingFromHandle=kf,_g.getOffsetFromHandle=Hf;const ug=new so(null);class mg{constructor(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=ep.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}_destroyDescriptorSet(){this._descriptorSet.destroy(),this._nativeObj.setDescriptorSet(null),this._descriptorSet=null}_destroyInputAssembler(){this._inputAssembler.destroy(),this._nativeObj.setInputAssembler(null),this._inputAssembler=null}_createDescriptorSet(t){this._descriptorSet=this._device.createDescriptorSet(t),this._nativeObj.setDescriptorSet(this._descriptorSet)}set passes(t){t.length>8?T(12004,8):(this._passes=t,this._flushPassInfo(),this._descriptorSet&&(this._destroyDescriptorSet(),ug.layout=t[0].localSetLayout,this._createDescriptorSet(ug)))}get passes(){return this._passes}get shaders(){return this._shaders}set subMesh(t){this._setSubMesh(t),this._inputAssembler.destroy(),this._inputAssembler.initialize(t.iaInfo),this._passes[0].batchingScheme===hg.VB_MERGING&&this.subMesh.genFlatBuffers()}get subMesh(){return this._subMesh}set priority(t){this._priority=t,this._nativeObj.setPriority(t)}get priority(){return this._priority}get inputAssembler(){return this._inputAssembler}get descriptorSet(){return this._descriptorSet}get patches(){return this._patches}get planarInstanceShader(){return this._planarInstanceShader}get planarShader(){return this._planarShader}_setInputAssembler(t){this._inputAssembler=this._device.createInputAssembler(t),this._nativeObj.setInputAssembler(this._inputAssembler)}_setSubMesh(t){this._subMesh=t,this._nativeObj.setSubMeshBuffers(t.flatBuffers)}get native(){return this._nativeObj}_init(){this._nativeObj=new Qn}initialize(t,e,i=null){if(this._device=n.director.root.device,ug.layout=e[0].localSetLayout,this._init(),this._setInputAssembler(t.iaInfo),this._createDescriptorSet(ug),this._setSubMesh(t),this._patches=i,this._passes=e,this._flushPassInfo(),e[0].batchingScheme===hg.VB_MERGING&&this.subMesh.genFlatBuffers(),this.priority=ep.DEFAULT,e[0].phase===og("reflection")){let t=this._device.width,e=this._device.height;const i=512;e<t?(t=i*t/e,e=i):(t=i,e=i*e/t),this._reflectionTex=this._device.createTexture(new Or(Us.TEX2D,Gs.STORAGE|Gs.TRANSFER_SRC|Gs.SAMPLED,Os.RGBA8,t,e,ks.IMMUTABLE)),this.descriptorSet.bindTexture(hd,this._reflectionTex);const n=qd([js.LINEAR,js.LINEAR,js.NONE,Ws.CLAMP,Ws.CLAMP,Ws.CLAMP]);this._reflectionSampler=Xd.getSampler(this._device,n),this.descriptorSet.bindSampler(hd,this._reflectionSampler),this.descriptorSet.bindTexture(md,this._reflectionTex)}}_initNativePlanarShadowShader(t){this._planarShader=t.getPlanarShader(this._patches),this._nativeObj.setPlanarShader(this._planarShader)}initPlanarShadowShader(){const t=n.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(t)}_initNativePlanarShadowInstanceShader(t){this._planarInstanceShader=t.getPlanarInstanceShader(this._patches),this._nativeObj.setPlanarInstanceShader(this._planarInstanceShader)}initPlanarShadowInstanceShader(){const t=n.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(t)}_destroy(){this._nativeObj=null}destroy(){this._destroyDescriptorSet(),this._destroyInputAssembler(),this.priority=ep.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler&&this._reflectionSampler.destroy(),this._reflectionSampler=null,this._destroy()}update(){for(let t=0;t<this._passes.length;++t)this._passes[t].update();this._descriptorSet.update()}onPipelineStateChanged(){const t=this._passes;if(t){for(let e=0;e<t.length;e++){const i=t[e];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}onMacroPatchesStateChanged(t){this._patches=t;const e=this._passes;if(e){for(let t=0;t<e.length;t++){const i=e[t];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}}_flushPassInfo(){const t=this._passes;if(t){this._shaders||(this._shaders=[]),this._shaders.length=t.length;for(let e=0,i=t.length;e<i;e++)this._shaders[e]=t[e].getShaderVariant(this.patches);{const e=t.map((t=>t.native));this._nativeObj.setPasses(e),this._nativeObj.setShaders(this._shaders)}}}}class pg{static get(t,e=0){const i=pg._buffers;i.has(t)||i.set(t,{});const n=i.get(t);return n[e]||(n[e]=new pg(t))}constructor(t){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=t.device,this.pass=t}destroy(){for(let t=0;t<this.instances.length;++t){const e=this.instances[t];e.vb.destroy(),e.ia.destroy()}this.instances.length=0}merge(t,e,i,n=null){const s=e.buffer.length;if(!s)return;const r=t.inputAssembler,o=t.descriptorSet.getTexture(sd);let a=n;a||(a=t.shaders[i]);const l=t.descriptorSet;for(let t=0;t<this.instances.length;++t){const i=this.instances[t];if(!(i.ia.indexBuffer!==r.indexBuffer||i.count>=1024)&&i.lightingMap===o){if(i.stride!==s)return;if(i.count>=i.capacity){i.capacity<<=1;const t=i.stride*i.capacity,e=i.data;i.data=new Uint8Array(t),i.data.set(e),i.vb.resize(t)}return i.shader!==a&&(i.shader=a),i.descriptorSet!==l&&(i.descriptorSet=l),i.data.set(e.buffer,i.stride*i.count++),void(this.hasPendingModels=!0)}}const c=this._device.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,32*s,s)),h=new Uint8Array(32*s),_=r.vertexBuffers.slice(),u=r.attributes.slice(),m=r.indexBuffer;for(let t=0;t<e.attributes.length;t++){const i=e.attributes[t],n=new Wr(i.name,i.format,i.isNormalized,_.length,!0);u.push(n)}h.set(e.buffer),_.push(c);const p=new Xr(u,_,m),d=this._device.createInputAssembler(p);this.instances.push({count:1,capacity:32,vb:c,data:h,ia:d,stride:s,shader:a,descriptorSet:l,lightingMap:o}),this.hasPendingModels=!0}uploadBuffers(t){for(let e=0;e<this.instances.length;++e){const i=this.instances[e];i.count&&(i.ia.instanceCount=i.count,t.updateBuffer(i.vb,i.data))}}clear(){for(let t=0;t<this.instances.length;++t)this.instances[t].count=0;this.hasPendingModels=!1}}pg._buffers=new Map;const dg=new $i,fg=(new z((()=>new mg),32),[{name:"CC_RECEIVE_SHADOW",value:!0}]);let gg;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.SKINNING=1]="SKINNING",t[t.BAKED_SKINNING=2]="BAKED_SKINNING",t[t.BATCH_2D=3]="BATCH_2D",t[t.PARTICLE_BATCH=4]="PARTICLE_BATCH",t[t.LINE=5]="LINE"}(gg||(gg={}));const yg=qd([js.LINEAR,js.LINEAR,js.NONE,Ws.CLAMP,Ws.CLAMP,Ws.CLAMP]),vg=qd([js.LINEAR,js.LINEAR,js.LINEAR,Ws.CLAMP,Ws.CLAMP,Ws.CLAMP]);class xg{get subModels(){return this._subModels}get inited(){return this._inited}get worldBounds(){return this._worldBounds}get modelBounds(){return this._modelBounds}get localBuffer(){return this._localBuffer}get updateStamp(){return this._updateStamp}get isInstancingEnabled(){return this._instMatWorldIdx>=0}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._setReceiveShadow(t),this.onMacroPatchesStateChanged()}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t,this._nativeObj.setCastShadow(t)}get node(){return this._node}set node(t){this._node=t,this._nativeObj.setNode(t.native)}get transform(){return this._transform}set transform(t){this._transform=t,this._nativeObj.setTransform(t.native)}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t,this._nativeObj.seVisFlag(t)}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._nativeObj.setEnabled(t)}get native(){return this._nativeObj}constructor(){this.type=gg.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._transformUpdated=!0,this._localData=new Float32Array(Vp.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new rn,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Qm.Enum.NONE,this._device=n.director.root.device}_setReceiveShadow(t){this._receiveShadow=t,this._nativeObj.setReceiveShadow(t)}_init(){this._nativeObj=new Fn}initialize(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Qm.Enum.NONE,this._inited=!0)}_destroySubmodel(t){t.destroy()}_destroy(){this._nativeObj=null}destroy(){const t=this._subModels;for(let e=0;e<t.length;e++){const t=this._subModels[e];this._destroySubmodel(t)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._transformUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()}attachToScene(t){this.scene=t}detachFromScene(){this.scene=null}updateTransform(t){const e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._transformUpdated=!0;const t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}}updateWorldBound(){const t=this.transform;if(null!==t){t.updateWorldTransform(),this._transformUpdated=!0;const e=this._worldBounds;this._modelBounds&&e&&this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,e)}}_applyLocalData(){}_applyLocalBuffer(){this._nativeObj.setLocalBuffer(this._localBuffer)}updateUBOs(t){const e=this._subModels;for(let t=0;t<e.length;t++)e[t].update();if(this._updateStamp=t,!this._transformUpdated)return;this._transformUpdated=!1;const i=this.transform._mat,n=this._instMatWorldIdx;if(n>=0){const t=this.instancedAttributes.views;!function(t,e,i,n){e[0]=t.m00,e[1]=t.m01,e[2]=t.m02,e[3]=t.m12,i[0]=t.m04,i[1]=t.m05,i[2]=t.m06,i[3]=t.m13,n[0]=t.m08,n[1]=t.m09,n[2]=t.m10,n[3]=t.m14}(i,t[n],t[n+1],t[n+2])}else this._localBuffer&&($i.toArray(this._localData,i,Vp.MAT_WORLD_OFFSET),$i.inverseTranspose(dg,i),$i.toArray(this._localData,dg,Vp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer())}_updateNativeBounds(){this._nativeObj.setBounds(this._worldBounds.native)}createBoundingShape(t,e){t&&e&&(this._modelBounds=gl.fromPoints(gl.create(),t,e),this._worldBounds=gl.clone(this._modelBounds),this._updateNativeBounds())}_createSubModel(){return new mg}initSubModel(t,e,i){this.initialize(),null==this._subModels[t]?this._subModels[t]=this._createSubModel():this._subModels[t].destroy(),this._subModels[t].initialize(e,i.passes,this.getMacroPatches(t)),this._subModels[t].initPlanarShadowShader(),this._subModels[t].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(t),this._nativeObj.setSubModel(t,this._subModels[t].native)}setSubModelMesh(t,e){this._subModels[t]&&(this._subModels[t].subMesh=e)}setSubModelMaterial(t,e){this._subModels[t]&&(this._subModels[t].passes=e.passes,this._updateAttributesAndBinding(t))}onGlobalPipelineStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onPipelineStateChanged()}onMacroPatchesStateChanged(){const t=this._subModels;for(let e=0;e<t.length;e++)t[e].onMacroPatchesStateChanged(this.getMacroPatches(e))}updateLightingmap(t,e){rn.toArray(this._localData,e,Vp.LIGHTINGMAP_UVPARAM),this._applyLocalData(),this._lightmap=t,this._lightmapUVParam=e,null===t&&(t=rg.get("empty-texture"));const i=t.getGFXTexture();if(i){const e=Xd.getSampler(this._device,t.mipmaps.length>1?vg:yg),n=this._subModels;for(let t=0;t<n.length;t++){const{descriptorSet:s}=n[t];s.bindTexture(sd,i),s.bindSampler(sd,e),s.update()}}}getMacroPatches(t){return this.receiveShadow?fg:null}_updateAttributesAndBinding(t){const e=this._subModels[t];if(!e)return;this._initLocalDescriptors(t),this._updateLocalDescriptors(t,e.descriptorSet);const i=e.passes[0].getShaderVariant(e.patches);this._updateInstancedAttributes(i.attributes,e.passes[0])}_getInstancedAttributeIndex(t){const{attributes:e}=this.instancedAttributes;for(let i=0;i<e.length;i++)if(e[i].name===t)return i;return-1}_setInstMatWorldIdx(t){this._instMatWorldIdx=t,this._nativeObj.setInstMatWorldIdx(t)}_updateInstancedAttributes(t,e){if(!e.device.hasFeature(Ms.INSTANCED_ARRAYS))return;let i=0;for(let e=0;e<t.length;e++){const n=t[e];n.isInstanced&&(i+=fo[n.format].size)}const n=this.instancedAttributes;n.buffer=new Uint8Array(i),n.views.length=n.attributes.length=0;let s=0;for(let e=0;e<t.length;e++){const i=t[e];if(!i.isInstanced)continue;const r=new Wr;r.format=i.format,r.name=i.name,r.isNormalized=i.isNormalized,r.location=i.location,n.attributes.push(r);const o=fo[i.format],a=new(To(o))(n.buffer.buffer,s,o.count);n.views.push(a),s+=o.size}e.batchingScheme===hg.INSTANCING&&pg.get(e).destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex("a_matWorld0")),this._transformUpdated=!0,this._nativeObj.setInstancedAttrBlock(n.buffer.buffer,n.views,n.attributes)}_initLocalDescriptors(t){this._localBuffer||(this._localBuffer=this._device.createBuffer(new Pr(Ls.UNIFORM|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,Vp.SIZE,Vp.SIZE)),this._applyLocalBuffer())}_updateLocalDescriptors(t,e){this._localBuffer&&e.bindBuffer(Vp.BINDING,this._localBuffer)}}let bg,Sg;!function(t){t[t.LOCAL=0]="LOCAL",t[t.WORLD=1]="WORLD"}(bg||(bg={})),function(t){t[t.NONE=0]="NONE",t[t.POSITION=1]="POSITION",t[t.ROTATION=2]="ROTATION",t[t.SCALE=4]="SCALE",t[t.RS=t.ROTATION|t.SCALE]="RS",t[t.TRS=t.POSITION|t.ROTATION|t.SCALE]="TRS",t[t.TRS_MASK=~t.TRS]="TRS_MASK"}(Sg||(Sg={})),n.internal.TransformBit=Sg;class Ag{get root(){return this._root}get name(){return this._name}get cameras(){return this._cameras}get mainLight(){return this._mainLight}get sphereLights(){return this._sphereLights}get spotLights(){return this._spotLights}get models(){return this._models}get native(){return this._nativeObj}get batches(){return this._batches}static registerCreateFunc(t){t._createSceneFun=t=>new Ag(t)}constructor(t){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=t,this._createNativeObject()}initialize(t){return this._name=t.name,this._createNativeObject(),!0}update(t){{const e=[];for(let t=0,i=this._batches.length;t<i;++t)e.push(this._batches[t].native);return this._nativeObj.updateBatches(e),void this._nativeObj.update(t)}}_destroy(){this._nativeObj=null}destroy(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()}addCamera(t){t.attachToScene(this),this._cameras.push(t)}removeCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return this._cameras.splice(e,1),void t.detachFromScene()}removeCameras(){for(const t of this._cameras)t.detachFromScene();this._cameras.splice(0)}setMainLight(t){this._mainLight=t,this._nativeObj.setMainLight(t?t.native:null)}unsetMainLight(t){if(this._mainLight===t){const t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=Sg.ROTATION));this.setMainLight(null)}}addDirectionalLight(t){t.attachToScene(this),this._directionalLights.push(t)}removeDirectionalLight(t){for(let e=0;e<this._directionalLights.length;++e)if(this._directionalLights[e]===t)return t.detachFromScene(),void this._directionalLights.splice(e,1)}addSphereLight(t){t.attachToScene(this),this._sphereLights.push(t),this._nativeObj.addSphereLight(t.native)}removeSphereLight(t){for(let e=0;e<this._sphereLights.length;++e)if(this._sphereLights[e]===t)return t.detachFromScene(),this._sphereLights.splice(e,1),void this._nativeObj.removeSphereLight(t.native)}addSpotLight(t){t.attachToScene(this),this._spotLights.push(t),this._nativeObj.addSpotLight(t.native)}removeSpotLight(t){for(let e=0;e<this._spotLights.length;++e)if(this._spotLights[e]===t)return t.detachFromScene(),this._spotLights.splice(e,1),void this._nativeObj.removeSpotLight(t.native)}removeSphereLights(){for(let t=0;t<this._sphereLights.length;++t)this._sphereLights[t].detachFromScene();this._sphereLights.length=0,this._nativeObj.removeSphereLights()}removeSpotLights(){for(let t=0;t<this._spotLights.length;++t)this._spotLights[t].detachFromScene();this._spotLights=[],this._nativeObj.removeSpotLights()}addModel(t){switch(t.attachToScene(this),this._models.push(t),t.type){case gg.SKINNING:this._nativeObj.addSkinningModel(t.native);break;case gg.BAKED_SKINNING:this._nativeObj.addBakedSkinningModel(t.native);break;case gg.DEFAULT:default:this._nativeObj.addModel(t.native)}}removeModel(t){for(let e=0;e<this._models.length;++e)if(this._models[e]===t)return t.detachFromScene(),this._models.splice(e,1),void this._nativeObj.removeModel(e)}removeModels(){for(const t of this._models)t.detachFromScene(),t.destroy();this._models.length=0,this._nativeObj.removeModels()}addBatch(t){this._batches.push(t)}removeBatch(t){for(let e=0;e<this._batches.length;++e)if(this._batches[e]===t)return this._batches.splice(e,1),void this._nativeObj.removeBatch(e)}removeBatches(){this._batches.length=0,this._nativeObj.removeBatches()}onGlobalPipelineStateChanged(){for(const t of this._models)t.onGlobalPipelineStateChanged()}generateModelId(){return this._modelId++}_createNativeObject(){this._nativeObj=new $n}}Qe(Ag.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),Qe(Ag.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);const Cg={};Qe(Cg,"CameraVisFlags",[{name:"GENERAL"}]),Ze(Cg,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Qm.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Qm.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Qm.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Qm.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Qm.BitMask,targetName:"UI_2D"}]),n.CameraVisFlags=Cg;const Tg={};function wg(t,e){e<1e3?e=1e3:e>15e3&&(e=15e3);const i=e*e,n=(.860117757+.000154118254*e+1.28641212e-7*i)/(1+.000842420235*e+7.08145163e-7*i),s=(.317398726+422806245e-13*e+4.20481691e-8*i)/(1-289741816e-13*e+1.61456053e-7*i),r=2*n-8*s+4,o=3*n/r,a=2*s/r,l=1/a*o,c=1/a*(1-o-a);t.x=3.2404542*l-1.5371385+-.4985314*c,t.y=-.969266*l+1.8760108+.041556*c,t.z=.0556434*l-.2040259+1.0572252*c}let Eg;Qe(Tg,"VisibilityFlags",[{name:"GENERAL"}]),Ze(Tg,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Qm.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Qm.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Qm.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Qm.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Qm.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Qm.Enum,targetName:"UI_2D"}]),n.VisibilityFlags=Tg,Ze(_g.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),Qe(Id.prototype,"Camera.prototype",[{name:"getSplitFrustum"}]),function(t){t[t.DIRECTIONAL=0]="DIRECTIONAL",t[t.SPHERE=1]="SPHERE",t[t.SPOT=2]="SPOT",t[t.UNKNOWN=3]="UNKNOWN"}(Eg||(Eg={}));const Pg=t=>4*Math.PI*Math.PI*t*t;class Dg{constructor(){this._baked=!1,this._color=new Ni(1,1,1),this._colorTemp=6550,this._colorTempRGB=new Ni(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=Eg.UNKNOWN}_init(){switch(this._type){case Eg.DIRECTIONAL:this._nativeObj=new Gn;break;case Eg.SPHERE:this._nativeObj=new Hn;break;case Eg.SPOT:this._nativeObj=new kn}this._nativeObj.setType(this._type)}_destroy(){this._nativeObj=null}get baked(){return this._baked}set baked(t){this._baked=t}set color(t){this._color.set(t),this._nativeObj.setColor(t)}get color(){return this._color}set useColorTemperature(t){this._useColorTemperature=t,this._nativeObj.setUseColorTemperature(t)}get useColorTemperature(){return this._useColorTemperature}set colorTemperature(t){this._colorTemp=t,wg(this._colorTempRGB,this._colorTemp),this._nativeObj.setColorTemperatureRGB(this._colorTempRGB)}get colorTemperature(){return this._colorTemp}get colorTemperatureRGB(){return this._colorTempRGB}set node(t){this._node=t,this._node&&(this._node.hasChangedFlags|=Sg.ROTATION,this._nativeObj.setNode(t?t.native:null))}get node(){return this._node}get type(){return this._type}get name(){return this._name}set name(t){this._name=t}get scene(){return this._scene}get native(){return this._nativeObj}initialize(){this._init(),this.color=new Ni(1,1,1),this.colorTemperature=6550}attachToScene(t){this._scene=t}detachFromScene(){this._scene=null}destroy(){this._name=null,this._node=null,this._destroy()}update(){}}const Ig=new Ni(0,0,-1),Rg=new Ni;var Mg,Og,Bg,Ng,Lg,Fg,zg,Vg;let Ug=t("EffectAsset",Vl("cc.EffectAsset")((Vg=zg=class t extends _h{constructor(...t){super(...t),Tl(this,"techniques",Bg,this),Tl(this,"shaders",Ng,this),Tl(this,"combinations",Lg,this),Tl(this,"hideInEditor",Fg,this)}static register(e){t._effects[e.name]=e}static remove(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return void delete t._effects[i]}}static get(e){if(t._effects[e])return t._effects[e];for(const i in t._effects)if(t._effects[i]._uuid===e)return t._effects[i];return null}static getAll(){return t._effects}onLoaded(){ng.register(this),t.register(this),n.game.once(n.Game.EVENT_ENGINE_INITED,this._precompile,this)}_precompile(){const t=n.director.root;for(let e=0;e<this.shaders.length;e++){const i=this.shaders[e],n=this.combinations[e];n&&Object.keys(n).reduce(((t,e)=>t.reduce(((t,i)=>{const s=n[e];for(let n=0;n<s.length;++n){const r={...i};r[e]=s[n],t.push(r)}return t}),[])),[{}]).forEach((e=>ng.getGFXShader(t.device,i.name,e,t.pipeline)))}}destroy(){return t.remove(this),super.destroy()}initDefault(e){super.initDefault(e);const i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques}validate(){return this.techniques.length>0&&this.shaders.length>0}},zg._effects={},Bg=wl((Og=Vg).prototype,"techniques",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ng=wl(Og.prototype,"shaders",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Lg=wl(Og.prototype,"combinations",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fg=wl(Og.prototype,"hideInEditor",[Wl,Xl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Mg=Og))||Mg);var Gg,kg,Hg,jg,Wg,qg,Xg,Yg,Kg;n.EffectAsset=Ug;let $g=t("Material",(Gg=Vl("cc.Material"),kg=yc(Ug),Gg((Wg=wl((jg=class t extends _h{static getHash(t){let e=0;for(const i of t.passes)e^=i.hash;return e}constructor(){super(),Tl(this,"_effectAsset",Wg,this),Tl(this,"_techIdx",qg,this),Tl(this,"_defines",Xg,this),Tl(this,"_states",Yg,this),Tl(this,"_props",Kg,this),this._passes=[],this._hash=0}get effectAsset(){return this._effectAsset}get effectName(){return this._effectAsset?this._effectAsset.name:""}get technique(){return this._techIdx}get passes(){return this._passes}get hash(){return this._hash}get parent(){return null}get owner(){return null}initialize(t){this._passes.length?A(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),void 0!==t.technique&&(this._techIdx=t.technique),t.effectAsset?this._effectAsset=t.effectAsset:t.effectName&&(this._effectAsset=Ug.get(t.effectName)),t.defines&&this._prepareInfo(t.defines,this._defines),t.states&&this._prepareInfo(t.states,this._states),this._update())}reset(t){this.initialize(t)}destroy(){return this._doDestroy(),super.destroy()}recompileShaders(t,e){console.warn(`Shaders in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}overridePipelineStates(t,e){console.warn(`Pipeline states in material asset '${this.name}' cannot be modified at runtime, please instantiate the material first.`)}onLoaded(){this._update()}resetUniforms(t=!0){this._props.length=this._passes.length;for(let t=0;t<this._props.length;t++)this._props[t]={};if(t)for(const t of this._passes)t.resetUBOs(),t.resetTextures()}setProperty(t,e,i){let n=!1;if(void 0===i){const i=this._passes,s=i.length;for(let r=0;r<s;r++){const s=i[r];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}}else{if(i>=this._passes.length)return void console.warn(`illegal pass index: ${i}.`);const s=this._passes[i];this._uploadProperty(s,t,e)&&(this._props[s.propertyIndex][t]=e,n=!0)}n||console.warn(`illegal property name: ${t}.`)}getProperty(t,e){if(void 0===e){const e=this._props,i=e.length;for(let n=0;n<i;n++){const i=e[n];if(t in i)return i[t]}}else{if(e>=this._props.length)return console.warn(`illegal pass index: ${e}.`),null;const i=this._props[this._passes[e].propertyIndex];if(t in i)return i[t]}return null}copy(t){this._techIdx=t._techIdx,this._props.length=t._props.length;for(let e=0;e<t._props.length;e++)this._props[e]={...t._props[e]};this._defines.length=t._defines.length;for(let e=0;e<t._defines.length;e++)this._defines[e]={...t._defines[e]};this._states.length=t._states.length;for(let e=0;e<t._states.length;e++)this._states[e]={...t._states[e]};this._effectAsset=t._effectAsset,this._update()}_prepareInfo(t,e){let i=t;if(!Array.isArray(i)){const t=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;i=Array(t).fill(i)}for(let t=0;t<i.length;++t)Object.assign(e[t]||(e[t]={}),i[t])}_createPasses(){const t=this._effectAsset.techniques[this._techIdx||0];if(!t)return[];const e=t.passes.length,i=[];for(let s=0;s<e;++s){const e=t.passes[s],r=e.passIndex=s,o=e.defines=this._defines[r]||(this._defines[r]={}),a=e.stateOverrides=this._states[r]||(this._states[r]={});if(void 0!==e.propertyIndex&&(Object.assign(o,this._defines[e.propertyIndex]),Object.assign(a,this._states[e.propertyIndex])),void 0!==e.embeddedMacros&&Object.assign(o,e.embeddedMacros),e.switch&&!o[e.switch])continue;const l=new _g(n.director.root);l.initialize(e),i.push(l)}return i}_update(e=!0){if(this._effectAsset){this._passes=this._createPasses();const t=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=t,e)this._passes.forEach(((t,e)=>{let i=this._props[e];i||(i=this._props[e]={}),void 0!==t.propertyIndex&&Object.assign(i,this._props[t.propertyIndex]);for(const e in i)this._uploadProperty(t,e,i[e])}));else for(let t=0;t<this._props.length;t++)this._props[t]={}}this._hash=t.getHash(this)}_uploadProperty(t,e,i){const n=t.getHandle(e);if(!n)return!1;const s=_g.getPropertyTypeFromHandle(n);if(s===zf.BUFFER)Array.isArray(i)?t.setUniformArray(n,i):null!==i?t.setUniform(n,i):t.resetUniform(e);else if(s===zf.TEXTURE)if(Array.isArray(i))for(let e=0;e<i.length;e++)this._bindTexture(t,n,i[e],e);else i?this._bindTexture(t,n,i):t.resetTexture(e);return!0}_bindTexture(t,e,i,n){const s=_g.getBindingFromHandle(e);if(i instanceof Yo)t.bindTexture(s,i,n);else if(i instanceof lf){const e=i.getGFXTexture();if(!e||!e.width||!e.height)return;t.bindTexture(s,e,n),t.bindSampler(s,i.getGFXSampler(),n)}}_doDestroy(){if(this._passes&&this._passes.length)for(const t of this._passes)t.destroy();this._passes.length=0}initDefault(t){super.initDefault(t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Ri("#ff00ff"))}validate(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0}}).prototype,"_effectAsset",[kg],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qg=wl(jg.prototype,"_techIdx",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Xg=wl(jg.prototype,"_defines",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yg=wl(jg.prototype,"_states",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kg=wl(jg.prototype,"_props",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Hg=jg))||Hg));n.Material=$g;const Jg=Nt({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Zg=Nt({Planar:0,ShadowMap:1}),Qg=Nt({HARD:0,SOFT:1,SOFT_2X:2}),ty=Zg.ShadowMap+1;class ey{get enabled(){return this._enabled}set enabled(t){this._setEnable(t),this.activate()}get normal(){return this._normal}set normal(t){Ni.copy(this._normal,t),this._nativeObj.normal=this._normal}get distance(){return this._distance}set distance(t){this._distance=t,this._nativeObj.distance=t}get shadowColor(){return this._shadowColor}set shadowColor(t){this._shadowColor=t,this._nativeObj.color=t}get type(){return this._type}set type(t){this._setType(t),this.activate()}get near(){return this._near}set near(t){this._near=t,this._nativeObj.nearValue=t}get far(){return this._far}set far(t){this._far=t,this._nativeObj.farValue=t}get orthoSize(){return this._orthoSize}set orthoSize(t){this._orthoSize=t,this._nativeObj.orthoSize=t}get size(){return this._size}set size(t){this._size.set(t),this._nativeObj.size=t}get pcf(){return this._pcf}set pcf(t){this._pcf=t,this._nativeObj.pcfType=t}get shadowMapDirty(){return this._shadowMapDirty}set shadowMapDirty(t){this._shadowMapDirty=t,this._nativeObj.shadowMapDirty=t}get bias(){return this._bias}set bias(t){this._bias=t,this._nativeObj.bias=t}get normalBias(){return this._normalBias}set normalBias(t){this._normalBias=t,this._nativeObj.normalBias=t}get saturation(){return this._saturation}set saturation(t){this._saturation=t,this._nativeObj.saturation=t}get autoAdapt(){return this._autoAdapt}set autoAdapt(t){this._autoAdapt=t,this._nativeObj.autoAdapt=t}get matLight(){return this._matLight}get material(){return this._material}get instancingMaterial(){return this._instancingMaterial}get native(){return this._nativeObj}constructor(){this.sphere=new Ts(0,0,0,.01),this.maxReceived=4,this._normal=new Ni(0,1,0),this._shadowColor=new Ri(0,0,0,76),this._matLight=new $i,this._material=null,this._instancingMaterial=null,this._size=new tn(512,512),this._enabled=!1,this._distance=0,this._type=ty,this._near=0,this._far=0,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._autoAdapt=!0,this._saturation=.75,this._nativeObj=new Xn}getPlanarShader(t){return this._material||(this._material=new $g,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._material.passes[0].getShaderVariant(t)}getPlanarInstanceShader(t){return this._instancingMaterial||(this._instancingMaterial=new $g,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native),this._instancingMaterial.passes[0].getShaderVariant(t)}_setEnable(t){this._enabled=t,this._nativeObj.enabled=t,t||this._setType(ty)}_setType(t){this._type=this.enabled?t:ty,this._nativeObj.shadowType=this._type}initialize(t){this.near=t.near,this.far=t.far,this.orthoSize=t.orthoSize,this.size=t.size,this.pcf=t.pcf,this.normal=t.normal,this.distance=t.distance,this.shadowColor=t.shadowColor,this.bias=t.bias,this.normalBias=t.normalBias,this.maxReceived=t.maxReceived,this.autoAdapt=t.autoAdapt,this._setEnable(t.enabled),this._setType(t.type),this.saturation=t.saturation}activate(){if(this.enabled)this.type===Zg.ShadowMap?this._updatePipeline():this._updatePlanarInfo();else{const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}}_updatePlanarInfo(){this._material||(this._material=new $g,this._material.initialize({effectName:"planar-shadow"}),this._nativeObj.planarPass=this._material.passes[0].native),this._instancingMaterial||(this._instancingMaterial=new $g,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}),this._nativeObj.instancePass=this._instancingMaterial.passes[0].native);const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=0,t.onGlobalPipelineStateChanged()}_updatePipeline(){const t=n.director.root;t.pipeline.macros.CC_RECEIVE_SHADOW=1,t.onGlobalPipelineStateChanged()}_destroy(){this._nativeObj=null}destroy(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.sphere.destroy()}}ey.MAX_FAR=2e3,ey.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),n.Shadows=ey;class iy extends _g{get parent(){return this._parent}constructor(t,e){super(t.root),this._parent=void 0,this._owner=void 0,this._dontNotify=!1,this._parent=t,this._owner=e,this._doInit(this._parent,!0);for(let t=0;t<this._shaderInfo.blocks.length;t++){const e=this._shaderInfo.blocks[t],i=this._blocks[e.binding],n=this._parent.blocks[e.binding];i.set(n)}this._setRootBufferDirty(!0);const i=this._parent;for(let t=0;t<this._shaderInfo.samplerTextures.length;t++){const e=this._shaderInfo.samplerTextures[t];for(let t=0;t<e.count;t++){const n=i._descriptorSet.getSampler(e.binding,t),s=i._descriptorSet.getTexture(e.binding,t);this._descriptorSet.bindSampler(e.binding,n,t),this._descriptorSet.bindTexture(e.binding,s,t)}}super.tryCompile()}overridePipelineStates(t,e){this._bs.reset(),this._rs.reset(),this._dss.reset(),_g.fillPipelineInfo(this,t),_g.fillPipelineInfo(this,e),this._onStateChange()}tryCompile(t){if(t&&!Kf(this._defines,t))return!1;const e=super.tryCompile();return this._onStateChange(),e}beginChangeStatesSilently(){this._dontNotify=!0}endChangeStatesSilently(){this._dontNotify=!1}_syncBatchingScheme(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(hg.NONE)}_onStateChange(){this._setHash(_g.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)}}class ny extends $g{get parent(){return this._parent}get owner(){return this._owner}constructor(t){super(),this._passes=[],this._parent=void 0,this._owner=void 0,this._subModelIdx=0,this._parent=t.parent,this._owner=t.owner||null,this._subModelIdx=t.subModelIdx||0,this.copy(this._parent)}recompileShaders(t,e){if(this._passes&&this.effectAsset)if(void 0===e)for(const e of this._passes)e.tryCompile(t);else this._passes[e].tryCompile(t)}overridePipelineStates(t,e){if(!this._passes||!this.effectAsset)return;const i=this.effectAsset.techniques[this.technique].passes;if(void 0===e)for(let e=0;e<this._passes.length;e++){const n=this._passes[e],s=this._states[e]||(this._states[e]={});for(const e in t)s[e]=t[e];n.overridePipelineStates(i[n.passIndex],s)}else{const n=this._states[e]||(this._states[e]={});for(const e in t)n[e]=t[e];this._passes[e].overridePipelineStates(i[e],n)}}destroy(){return this._doDestroy(),!0}onPassStateChange(t){this._hash=$g.getHash(this),!t&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)}_createPasses(){const t=[],e=this._parent.passes;if(!e)return t;for(let i=0;i<e.length;++i)t.push(new iy(e[i],this));return t}}let sy=null,ry=null;class oy{get model(){return this._model}get enabled(){return this._enabled}set enabled(t){this._setEnabled(t),t?this.activate():this._updatePipeline()}get useIBL(){return this._useIBL}set useIBL(t){this._setUseIBL(t),this._updatePipeline()}get isRGBE(){return this._isRGBE}set isRGBE(t){t&&(ry&&ry.recompileShaders({USE_RGBE_CUBEMAP:t}),this._model&&this._model.setSubModelMaterial(0,ry)),this._setIsRGBE(t),this._updatePipeline()}get envmap(){return this._envmap}set envmap(t){this._envmap=t||this._default,this._envmap&&(n.director.root.pipeline.pipelineSceneData.ambient.albedoArray[3]=this._envmap.mipmapLevel,this._updateGlobalBinding())}get native(){return this._nativeObj}constructor(){this._envmap=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._isRGBE=!1,this._nativeObj=new jn}_setEnabled(t){this._enabled=t,this._nativeObj.enabled=t}_setUseIBL(t){this._useIBL=t,this._nativeObj.useIBL=t}_setIsRGBE(t){this._isRGBE=t,this._nativeObj.isRGBE=t}initialize(t){this._setEnabled(t.enabled),this._setUseIBL(t.useIBL),this._setIsRGBE(t.isRGBE),this._envmap=t.envmap}activate(){const t=n.director.root.pipeline,e=t.pipelineSceneData.ambient;if(this._globalDSManager=t.globalDSManager,this._default=rg.get("default-cube-texture"),this._model||(this._model=n.director.root.createModel(n.renderer.scene.Model),this._model._initLocalDescriptors=()=>{},this._nativeObj.model=this._model.native),this._envmap||(this._envmap=this._default),e.albedoArray[3]=this._envmap.mipmapLevel,ry)ry.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE});else{const t=new $g;t.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:this.isRGBE}}),ry=new ny({parent:t})}this.enabled&&(sy||(sy=n.utils.createMesh(n.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,sy.renderingSubMeshes[0],ry)),this._updateGlobalBinding(),this._updatePipeline()}_updatePipeline(){const t=this.useIBL?this.isRGBE?2:1:0,e=n.director.root,i=e.pipeline;i.macros.CC_USE_IBL!==t&&(i.macros.CC_USE_IBL=t,e.onGlobalPipelineStateChanged())}_updateGlobalBinding(){const t=this.envmap.getGFXTexture(),e=Xd.getSampler(n.director._device,this.envmap.getSamplerHash());this._globalDSManager.bindSampler(Op,e),this._globalDSManager.bindTexture(Op,t),this._globalDSManager.update()}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}n.Skybox=oy;const ay=new Ni(0,0,-1),ly=new ki,cy=new $i,hy=new $i,_y=new $i,uy=new $i;var my=Object.freeze({__proto__:null,Ambient:ss,get CameraFOVAxis(){return gd},get CameraProjection(){return yd},get CameraAperture(){return vd},get CameraISO(){return xd},get CameraShutter(){return bd},SKYBOX_FLAG:Pd,Camera:Id,CameraVisFlags:Cg,VisibilityFlags:Tg,DirectionalLight:class extends Dg{set direction(t){Ni.normalize(this._dir,t),this._nativeObj.setDirection(t)}get direction(){return this._dir}set illuminance(t){this._illuminance=t,this._nativeObj.setIlluminance(t)}get illuminance(){return this._illuminance}constructor(){super(),this._dir=new Ni(1,-1,-1),this._illuminance=ss.SUN_ILLUM,this._type=Eg.DIRECTIONAL}initialize(){super.initialize(),this.illuminance=ss.SUN_ILLUM,this.direction=new Ni(1,-1,-1)}update(){this._node&&this._node.hasChangedFlags&&(this.direction=Ni.transformQuat(Rg,Ig,this._node.worldRotation))}},ColorTemperatureToRGB:wg,get LightType(){return Eg},nt2lm:Pg,Light:Dg,get ModelType(){return gg},Model:xg,ShadowSize:Jg,ShadowType:Zg,PCFType:Qg,Shadows:ey,RenderScene:Ag,Skybox:oy,SphereLight:class extends Dg{_init(){super._init(),this._nativeObj.setPosition(this._pos),this._nativeObj.setAABB(this._aabb.native)}_destroy(){super._destroy()}get position(){return this._pos}set size(t){this._size=t,this._nativeObj.setSize(t)}get size(){return this._size}set range(t){this._range=t,this._nativeObj.setRange(t),this._needUpdate=!0}get range(){return this._range}set luminance(t){this._luminance=t,this._nativeObj.setIlluminance(t)}get luminance(){return this._luminance}get aabb(){return this._aabb}constructor(){super(),this._needUpdate=!1,this._size=.15,this._range=1,this._luminance=0,this._pos=void 0,this._aabb=void 0,this._aabb=gl.create(),this._pos=new Ni,this._type=Eg.SPHERE}initialize(){super.initialize(),this.size=.15,this.range=1,this.luminance=1700/Pg(.15)}update(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);const t=this._range;gl.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,t,t,t),this._needUpdate=!1}}},SpotLight:class extends Dg{_init(){super._init();{const t=this._nativeObj;t.setAABB(this._aabb.native),t.setFrustum(this._frustum),t.setDirection(this._dir),t.setPosition(this._pos)}}_destroy(){super._destroy()}_setDirection(t){this._dir.set(t),this._nativeObj.setDirection(t)}get position(){return this._pos}set size(t){this._size=t,this._nativeObj.setSize(t)}get size(){return this._size}set range(t){this._range=t,this._nativeObj.setRange(t),this._needUpdate=!0}get range(){return this._range}set luminance(t){this._luminance=t,this._nativeObj.setIlluminance(t)}get luminance(){return this._luminance}get direction(){return this._dir}get spotAngle(){return this._spotAngle}set spotAngle(t){this._angle=t,this._spotAngle=Math.cos(.5*t),this._nativeObj.setAngle(this._spotAngle),this._needUpdate=!0}set aspect(t){this._aspect=t,this._nativeObj.setAspect(t),this._needUpdate=!0}get aspect(){return this._aspect}get aabb(){return this._aabb}get frustum(){return this._frustum}constructor(){super(),this._dir=new Ni(1,-1,-1),this._range=5,this._spotAngle=Math.cos(Math.PI/6),this._pos=void 0,this._aabb=void 0,this._frustum=void 0,this._angle=0,this._needUpdate=!1,this._size=.15,this._luminance=0,this._aspect=0,this._aabb=gl.create(),this._frustum=Cl.create(),this._pos=new Ni,this._type=Eg.SPOT}initialize(){super.initialize(),this.size=.15,this.aspect=1,this.luminance=1700/Pg(.15),this.range=Math.cos(Math.PI/6),this._setDirection(new Ni(1,-1,-1))}update(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),Ni.transformQuat(this._dir,ay,this._node.getWorldRotation(ly)),Ni.normalize(this._dir,this._dir),gl.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(cy),$i.invert(cy,cy),$i.perspective(hy,this._angle,1,.001,this._range),$i.multiply(_y,hy,cy),this._frustum.update(_y,uy),this._needUpdate=!1)}},SubModel:mg,NativeNode:Nn,NativeScene:Ln,NativeModel:Fn,NativeSkinningModel:zn,NativeBakedSkinningModel:Vn,NativeLight:Un,NativeDirectionalLight:Gn,NativeSpotLight:kn,NativeSphereLight:Hn,NaitveSkybox:jn,NativeFog:Wn,NativeAmbient:qn,NativeShadow:Xn,NativeCamera:Yn,NativeRenderWindow:Kn,NativeRenderScene:$n,NativeDrawBatch2D:Jn,NativePass:Zn,NativeSubModel:Qn,NativeRoot:ts,NativePipelineSharedSceneData:es,NativeAABB:is});let py,dy;function fy(t){return--t,t|=t>>16,t|=t>>8,t|=t>>4,t|=t>>2,t|=t>>1,++t}function gy(t,e){return Math.ceil(t/e)*e}!function(t){t[t.OPAQUE=0]="OPAQUE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OVERLAY=2]="OVERLAY"}(py||(py={})),function(t){t[t.DEFAULT=1]="DEFAULT",t[t.FORWARD=2]="FORWARD",t[t.SHADOWCAST=4]="SHADOWCAST"}(dy||(dy={}));const yy=Bn.addStage;var vy=Object.freeze({__proto__:null,addStage:yy,scene:my,createIA:function(t,e){if(!e.positions)return console.error("The data must have positions field"),null;const i=[],n=e.positions.length/3;for(let t=0;t<n;++t)i.push(e.positions[3*t],e.positions[3*t+1],e.positions[3*t+2]),e.normals&&i.push(e.normals[3*t],e.normals[3*t+1],e.normals[3*t+2]),e.uvs&&i.push(e.uvs[2*t],e.uvs[2*t+1]),e.colors&&i.push(e.colors[3*t],e.colors[3*t+1],e.colors[3*t+2]);const s=[];s.push(new Wr(pr.ATTR_POSITION,Os.RGB32F)),e.normals&&s.push(new Wr(pr.ATTR_NORMAL,Os.RGB32F)),e.uvs&&s.push(new Wr(pr.ATTR_TEX_COORD,Os.RG32F)),e.colors&&s.push(new Wr(pr.ATTR_COLOR,Os.RGB32F));const r=t.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,4*i.length,4*i.length/n));r.update(new Float32Array(i));let o=null;return e.indices&&(o=t.createBuffer(new Pr(Ls.INDEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,2*e.indices.length,2)),o.update(new Uint16Array(e.indices))),t.createInputAssembler(new Xr(s,[r],o))},get RenderQueue(){return py},get PassStage(){return dy},get PropertyType(){return zf},genHandle:Vf,getPropertyTypeFromHandle:Uf,getTypeFromHandle:Gf,getSetIndexFromHandle:t=>(t&Lf)>>>20,getBindingFromHandle:kf,getOffsetFromHandle:Hf,customizeType:jf,type2reader:Wf,type2writer:qf,getDefaultFromType:Yf,overrideMacros:Kf,get BatchingSchemes(){return hg},Pass:_g,getDeviceShaderVersion:ig,programLib:ng,get SamplerInfoIndex(){return Ud},defaultSamplerHash:Hd,genSamplerHash:qd,samplerLib:Xd,nearestPOT:fy,TextureBufferPool:class{constructor(t){this._device=void 0,this._format=Os.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new Cr,this._region1=new Cr,this._region2=new Cr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=t}initialize(t){const e=fo[t.format];this._format=t.format,this._formatSize=e.size,this._channels=e.count,this._bufferViewCtor=To(e),this._roundUpFn=t.roundUpFn||null,this._alignment=t.alignment||1,t.inOrderFree&&(this.alloc=this._McDonaldAlloc)}destroy(){for(let t=0;t<this._chunkCount;++t)this._chunks[t].texture.destroy();this._chunks.length=0,this._handles.length=0}alloc(t,e){t=gy(t,this._alignment);let i=-1,n=-1;if(void 0!==e&&(i=e,n=this._findAvailableSpace(t,i)),n<0)for(let e=0;e<this._chunkCount&&(i=e,n=this._findAvailableSpace(t,i),!(n>=0));++e);if(n>=0){const e=this._chunks[i];e.start+=t;const s={chunkIdx:i,start:n,end:n+t,texture:e.texture};return this._handles.push(s),s}const s=Math.sqrt(t/this._formatSize),r=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,fy(s)),o=this._chunks[this.createChunk(r)];o.start+=t;const a={chunkIdx:this._chunkCount-1,start:0,end:t,texture:o.texture};return this._handles.push(a),a}free(t){for(let e=0;e<this._handles.length;++e)if(this._handles[e]===t)return this._chunks[t.chunkIdx].end=t.end,void this._handles.splice(e,1)}createChunk(t){const e=t*t*this._formatSize;f(`TextureBufferPool: Allocate chunk ${this._chunkCount}, size: ${e}, format: ${this._format}`);const i={texture:this._device.createTexture(new Or(Us.TEX2D,Gs.SAMPLED|Gs.TRANSFER_DST,this._format,t,t,ks.IMMUTABLE)),size:e,start:0,end:e};return this._chunks[this._chunkCount]=i,this._chunkCount++}update(t,e){const i=[],n=[],s=t.start/this._formatSize;let r=e.byteLength/this._formatSize,o=s%t.texture.width,a=Math.floor(s/t.texture.width),l=Math.min(t.texture.width-o,r),c=0;o>0&&(this._region0.texOffset.x=o,this._region0.texOffset.y=a,this._region0.texExtent.width=l,this._region0.texExtent.height=1,i.push(new this._bufferViewCtor(e,c*this._formatSize,l*this._channels)),n.push(this._region0),o=0,a+=1,r-=l,c+=l),r>0&&(this._region1.texOffset.x=o,this._region1.texOffset.y=a,r>t.texture.width?(this._region1.texExtent.width=t.texture.width,this._region1.texExtent.height=Math.floor(r/t.texture.width),l=this._region1.texExtent.width*this._region1.texExtent.height):(l=r,this._region1.texExtent.width=l,this._region1.texExtent.height=1),i.push(new this._bufferViewCtor(e,c*this._formatSize,l*this._channels)),n.push(this._region1),o=0,a+=this._region1.texExtent.height,r-=l,c+=l),r>0&&(this._region2.texOffset.x=o,this._region2.texOffset.y=a,this._region2.texExtent.width=r,this._region2.texExtent.height=1,i.push(new this._bufferViewCtor(e,c*this._formatSize,r*this._channels)),n.push(this._region2)),this._device.copyBuffersToTexture(i,t.texture,n)}_findAvailableSpace(t,e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.size)n=!0;else{s=0;const r=this._handles.filter((t=>t.chunkIdx===e)).sort(((t,e)=>t.start-e.start));for(let e=0;e<r.length;e++){const i=r[e];if(s+t<=i.start){n=!0;break}s=i.end}!n&&s+t<=i.size&&(n=!0)}return n?s:-1}_McDonaldAlloc(t){t=gy(t,this._alignment);for(let e=0;e<this._chunkCount;++e){const i=this._chunks[e];let n=!1,s=i.start;if(s+t<=i.end?n=!0:s>i.end?s+t<=i.size?n=!0:t<=i.end&&(i.start=s=0,n=!0):s===i.end&&(i.start=s=0,i.end=i.size,t<=i.end&&(n=!0)),n){i.start+=t;const n={chunkIdx:e,start:s,end:s+t,texture:i.texture};return this._handles.push(n),n}}const e=Math.sqrt(t/this._formatSize),i=this._roundUpFn&&this._roundUpFn(e,this._formatSize)||Math.max(1024,fy(e)),n=this._chunks[this.createChunk(i)];n.start+=t;const s={chunkIdx:this._chunkCount,start:0,end:t,texture:n.texture};return this._handles.push(s),s}},MaterialInstance:ny,PassInstance:iy,get PoolType(){return Za},NULL_HANDLE:0,get NodeView(){return Qa},NodePool:il,get PassView(){return nl},PassPool:ol,get AABBView(){return al},AABBPool:hl});t("renderer",vy);const xy=Nt({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),by=xy.LAYERED+1;class Sy{set enabled(t){this._setEnable(t),t||(this._type=by),t?this.activate():this._updatePipeline()}get enabled(){return this._enabled}set fogColor(t){this._fogColor.set(t),Ri.toArray(this._colorArray,this._fogColor),this._nativeObj.color=this._fogColor}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._setType(t),this.enabled&&this._updatePipeline()}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._nativeObj.density=t}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._nativeObj.start=t}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._nativeObj.end=t}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._nativeObj.atten=t}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._nativeObj.top=t}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._nativeObj.range=t}get colorArray(){return this._colorArray}get native(){return this._nativeObj}constructor(){this._fogColor=new Ri("#C8C8C8"),this._colorArray=new Float32Array([.2,.2,.2,1]),this._enabled=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2,this._nativeObj=new Wn}_setType(t){this._type=this.enabled?t:by,this._nativeObj.type=this._type}_setEnable(t){this._enabled=t,this._nativeObj.enabled=t}initialize(t){this.fogColor=t.fogColor,this._setEnable(t.enabled),this._setType(t.type),this.fogDensity=t.fogDensity,this.fogStart=t.fogStart,this.fogEnd=t.fogEnd,this.fogAtten=t.fogAtten,this.fogTop=t.fogTop,this.fogRange=t.fogRange}activate(){this._updatePipeline()}_updatePipeline(){const t=n.director.root,e=this.enabled?this.type:by,i=t.pipeline;i.macros.CC_USE_FOG!==e&&(i.macros.CC_USE_FOG=e,t.onGlobalPipelineStateChanged())}_destroy(){this._nativeObj=null}destroy(){this._destroy()}}n.Fog=Sy;class Ay{_init(){this._nativeObj=new es,this._nativeObj.fog=this.fog.native,this._nativeObj.ambient=this.ambient.native,this._nativeObj.skybox=this.skybox.native,this._nativeObj.shadow=this.shadows.native}get native(){return this._nativeObj}get isHDR(){return this._isHDR}set isHDR(t){this._isHDR=t,this._nativeObj.isHDR=t}get shadingScale(){return this._shadingScale}set shadingScale(t){this._shadingScale=t,this._nativeObj.shadingScale=t}get fpScale(){return this._fpScale}set fpScale(t){this._fpScale=t,this._fpScale=t}constructor(){this.fog=new Sy,this.ambient=new ss,this.skybox=new oy,this.shadows=new ey,this.renderObjects=[],this.shadowObjects=[],this.shadowFrameBufferMap=new Map,this._isHDR=!1,this._shadingScale=1,this._fpScale=1/1024,this._init(),this.shadingScale=1,this.fpScale=1/1024}activate(t,e){return this._device=t,this._pipeline=e,!0}onGlobalPipelineStateChanged(){}destroy(){this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this._nativeObj=null}}function Cy(t,e){for(const i of e)Array.isArray(i)?Cy(t,i):t.push(i)}function Ty(t){const e=[];return Cy(e,t),e.join("")}const wy=Me.Flags.Destroyed,Ey=Me.Flags.PersistentMask,Py=we.IDENTIFIER_RE,Dy="var ",Iy="o",Ry={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},My=we.escapeForJS;class Oy{constructor(t,e){this.varName=void 0,this.expression=void 0,this.varName=t,this.expression=e}toString(){return`${Dy+this.varName}=${this.expression};`}}function By(t,e){return e instanceof Oy?new Oy(e.varName,t+e.expression):t+e}function Ny(t,e,i){Array.isArray(i)?(i[0]=By(e,i[0]),t.push(i)):t.push(`${By(e,i)};`)}class Ly{constructor(t){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=t}append(t,e){this._exps.push([t,e])}writeCode(t){let e;if(this._exps.length>1)t.push(`t=${this._targetExp};`),e="t";else{if(1!==this._exps.length)return;e=this._targetExp}for(let i=0;i<this._exps.length;i++){const n=this._exps[i];Ny(t,`${e+Fy(n[0])}=`,n[1])}}}function Fy(t){return Py.test(t)?`.${t}`:`[${My(t)}]`}Ly.pool=void 0,Ly.pool=new Rt((t=>{t._exps.length=0,t._targetExp=null}),1),Ly.pool.get=function(t){const e=this._get()||new Ly;return e._targetExp=t,e};class zy{constructor(t,e){let i;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=e,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=st(),dt(this.funcModuleCache,Ry),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{",`o=R=new ${this.getFuncModule(t.constructor,!0)}();`,"}"),t._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(t),this.enumerateObject(this.codeArray,t),this.globalVariables.length>0&&(i=`${Dy+this.globalVariables.join(",")};`);const n=Ty(["return (function(R){",i||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",n)(this.objs,this.funcs);for(let t=0,e=this.objsToClear_iN$t.length;t<e;++t)this.objsToClear_iN$t[t]._iN$t=null;this.objsToClear_iN$t.length=0}getFuncModule(t,e){const i=rt(t);if(i){const e=this.funcModuleCache[i];if(e)return e;if(void 0===e){let e=-1!==i.indexOf(".");if(e)try{if(e=t===Function(`return ${i}`)(),e)return this.funcModuleCache[i]=i,i}catch(t){}}}let n=this.funcs.indexOf(t);n<0&&(n=this.funcs.length,this.funcs.push(t));let s=`F[${n}]`;return e&&(s=`(${s})`),this.funcModuleCache[i]=s,s}getObjRef(t){let e=this.objs.indexOf(t);return e<0&&(e=this.objs.length,this.objs.push(t)),`O[${e}]`}setValueType(t,e,i,n){const s=Ly.pool.get(n);let r=e.constructor.__props__;r||(r=Object.keys(e));for(let t=0;t<r.length;t++){const n=r[t],o=i[n];if(e[n]===o)continue;const a=this.enumerateField(i,n,o);s.append(n,a)}s.writeCode(t),Ly.pool.put(s)}enumerateCCClass(t,e,i){const s=i.__values__,r=ne(i);for(let i=0;i<s.length;i++){const o=s[i],a=e[o];let l=r[o+"$_$default"];if(!Vy(l,a))if("object"==typeof a&&a instanceof n.ValueType&&(l=we.getDefault(l),l&&l.constructor===a.constructor)){const e=Iy+Fy(o);this.setValueType(t,l,a,e)}else this.setObjProp(t,e,o,a)}}instantiateArray(t){if(0===t.length)return"[]";const e="a"+ ++this.localVariableId,i=[new Oy(e,`new Array(${t.length})`)];t._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(t);for(let n=0;n<t.length;++n)Ny(i,`${e}[${n}]=`,this.enumerateField(t,n,t[n]));return i}instantiateTypedArray(t){const e=t.constructor.name;if(0===t.length)return`new ${e}`;const i="a"+ ++this.localVariableId,n=[new Oy(i,`new ${e}(${t.length})`)];t._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(t);for(let e=0;e<t.length;++e)0!==t[e]&&Ny(n,`${i}[${e}]=`,t[e]);return n}enumerateField(t,e,i){if("object"==typeof i&&i){const t=i._iN$t;if(t){let e=t.globalVar;if(!e){e=t.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(e);const i=t.source[0];t.source[0]=By(`${e}=`,i)}return e}return ArrayBuffer.isView(i)?this.instantiateTypedArray(i):Array.isArray(i)?this.instantiateArray(i):this.instantiateObj(i)}return"function"==typeof i?this.getFuncModule(i):"string"==typeof i?My(i):("_objFlags"===e&&t instanceof Me&&(i&=Ey),i)}setObjProp(t,e,i,n){Ny(t,`${Iy+Fy(i)}=`,this.enumerateField(e,i,n))}enumerateObject(t,e){const i=e.constructor;if(n.Class._isCCClass(i))this.enumerateCCClass(t,e,i);else for(const i in e){if(!e.hasOwnProperty(i)||95===i.charCodeAt(0)&&95===i.charCodeAt(1)&&"__type__"!==i)continue;const n=e[i];"object"==typeof n&&n&&n===e._iN$t||this.setObjProp(t,e,i,n)}}instantiateObj(t){if(t instanceof n.ValueType)return we.getNewValueTypeCode(t);if(t instanceof n.Asset)return this.getObjRef(t);if(t._objFlags&wy)return null;let e;const i=t.constructor;if(n.Class._isCCClass(i)){if(this.parent)if(this.parent instanceof n.Component){if(t instanceof n._BaseNode||t instanceof n.Component)return this.getObjRef(t)}else if(this.parent instanceof n._BaseNode)if(t instanceof n._BaseNode){if(!t.isChildOf(this.parent))return this.getObjRef(t)}else if(t instanceof n.Component&&!t.node.isChildOf(this.parent))return this.getObjRef(t);e=new Oy(Iy,`new ${this.getFuncModule(i,!0)}()`)}else if(i===Object)e=new Oy(Iy,"{}");else{if(i)return this.getObjRef(t);e=new Oy(Iy,"Object.create(null)")}const s=[e];return t._iN$t={globalVar:"",source:s},this.objsToClear_iN$t.push(t),this.enumerateObject(s,t),["(function(){",s,"return o;})();"]}}function Vy(t,e){if("function"==typeof t)try{t=t()}catch(t){return!1}if(t===e)return!0;if(t&&e&&"object"==typeof t&&"object"==typeof e&&t.constructor===e.constructor)if(t instanceof n.ValueType){if(t.equals(e))return!0}else{if(Array.isArray(t))return 0===t.length&&0===e.length;if(t.constructor===Object)return Q(t)&&Q(e)}return!1}class Uy{get uiTransformComp(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp}set uiTransformComp(t){this._uiTransformComp=t}get uiComp(){return this._uiComp}set uiComp(t){this._uiComp&&t?A(12002):this._uiComp=t}constructor(t){this._uiComp=null,this.opacity=1,this.localOpacity=1,this._uiTransformComp=null,this._node=void 0,this.uiTransformDirty=!0,this._node=t}}let Gy;!function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(Gy||(Gy=t("SystemEventType",{}))),zt(Gy),n.SystemEventType=Gy;class ky{static create(t){E(t&&t.event,1900);const e=t.event;delete t.event;let i=null;if(e===n.EventListener.TOUCH_ONE_BY_ONE?i=new Wy:e===n.EventListener.TOUCH_ALL_AT_ONCE?i=new qy:e===n.EventListener.MOUSE?i=new jy:e===n.EventListener.KEYBOARD?i=new Yy:e===n.EventListener.ACCELERATION&&(i=new Xy(t.callback),delete t.callback),i)for(const e of Object.keys(t))i[e]=t[e];return i}get onEvent(){return this._onEvent}constructor(t,e,i){this._cameraPriority=0,this.owner=null,this.mask=null,this._previousIn=!1,this._target=null,this._onEvent=void 0,this._type=void 0,this._listenerID=void 0,this._registered=!1,this._fixedPriority=0,this._node=null,this._paused=!0,this._isEnabled=!0,this._onEvent=i,this._type=t||0,this._listenerID=e||""}_setPaused(t){this._paused=t}_isPaused(){return this._paused}_setRegistered(t){this._registered=t}_isRegistered(){return this._registered}_getType(){return this._type}_getListenerID(){return this._listenerID}_setFixedPriority(t){this._fixedPriority=t}_getFixedPriority(){return this._fixedPriority}_setSceneGraphPriority(t){this._target=t,this._node=t}_getSceneGraphPriority(){return this._node}checkAvailable(){return null!==this._onEvent}clone(){return null}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}}ky.UNKNOWN=0,ky.TOUCH_ONE_BY_ONE=1,ky.TOUCH_ALL_AT_ONCE=2,ky.KEYBOARD=3,ky.MOUSE=4,ky.ACCELERATION=6,ky.CUSTOM=8,ky.ListenerID={MOUSE:"__cc_mouse",TOUCH_ONE_BY_ONE:"__cc_touch_one_by_one",TOUCH_ALL_AT_ONCE:"__cc_touch_all_at_once",KEYBOARD:"__cc_keyboard",ACCELERATION:"__cc_acceleration"};const Hy=ky.ListenerID;class jy extends ky{constructor(){super(ky.MOUSE,Hy.MOUSE,null),this.onMouseDown=null,this.onMouseUp=null,this.onMouseMove=null,this.onMouseScroll=null,this._onEvent=t=>this._callback(t)}_callback(t){switch(t.type){case Gy.MOUSE_DOWN:this.onMouseDown&&this.onMouseDown(t);break;case Gy.MOUSE_UP:this.onMouseUp&&this.onMouseUp(t);break;case Gy.MOUSE_MOVE:this.onMouseMove&&this.onMouseMove(t);break;case Gy.MOUSE_WHEEL:this.onMouseScroll&&this.onMouseScroll(t)}}clone(){const t=new jy;return t.onMouseDown=this.onMouseDown,t.onMouseUp=this.onMouseUp,t.onMouseMove=this.onMouseMove,t.onMouseScroll=this.onMouseScroll,t}checkAvailable(){return!0}}class Wy extends ky{constructor(){super(ky.TOUCH_ONE_BY_ONE,Hy.TOUCH_ONE_BY_ONE,null),this.swallowTouches=!1,this.onTouchBegan=null,this.onTouchMoved=null,this.onTouchEnded=null,this.onTouchCancelled=null,this._claimedTouches=[]}setSwallowTouches(t){this.swallowTouches=t}isSwallowTouches(){return this.swallowTouches}clone(){const t=new Wy;return t.onTouchBegan=this.onTouchBegan,t.onTouchMoved=this.onTouchMoved,t.onTouchEnded=this.onTouchEnded,t.onTouchCancelled=this.onTouchCancelled,t.swallowTouches=this.swallowTouches,t}checkAvailable(){return!!this.onTouchBegan||(b(1801),!1)}}class qy extends ky{constructor(){super(ky.TOUCH_ALL_AT_ONCE,Hy.TOUCH_ALL_AT_ONCE,null),this.onTouchesBegan=null,this.onTouchesMoved=null,this.onTouchesEnded=null,this.onTouchesCancelled=null}clone(){const t=new qy;return t.onTouchesBegan=this.onTouchesBegan,t.onTouchesMoved=this.onTouchesMoved,t.onTouchesEnded=this.onTouchesEnded,t.onTouchesCancelled=this.onTouchesCancelled,t}checkAvailable(){return null!==this.onTouchesBegan||null!==this.onTouchesMoved||null!==this.onTouchesEnded||null!==this.onTouchesCancelled||(b(1802),!1)}}class Xy extends ky{constructor(t){super(ky.ACCELERATION,Hy.ACCELERATION,null),this._onAccelerationEvent=null,this._onEvent=t=>this._callback(t),this._onAccelerationEvent=t}_callback(t){this._onAccelerationEvent&&this._onAccelerationEvent(t.acc,t)}checkAvailable(){return E(this._onAccelerationEvent,1803),!0}clone(){return new Xy(this._onAccelerationEvent)}}class Yy extends ky{constructor(){super(ky.KEYBOARD,Hy.KEYBOARD,null),this.onKeyDown=void 0,this.onKeyPressed=void 0,this.onKeyReleased=void 0,this._onEvent=t=>this._callback(t)}_callback(t){var e,i;switch(t.type){case Gy.KEY_DOWN:null===(e=this.onKeyPressed)||void 0===e||e.call(this,t.keyCode,t);break;case Gy.KEY_UP:null===(i=this.onKeyReleased)||void 0===i||i.call(this,t.keyCode,t)}}clone(){const t=new Yy;return t.onKeyDown=this.onKeyDown,t.onKeyPressed=this.onKeyPressed,t.onKeyReleased=this.onKeyReleased,t}checkAvailable(){return null!==this.onKeyDown||null!==this.onKeyPressed||null!==this.onKeyReleased||(b(1800),!1)}}n.EventListener=ky;const Ky=ky.ListenerID,$y=[Gy.TOUCH_START,Gy.TOUCH_MOVE,Gy.TOUCH_END,Gy.TOUCH_CANCEL],Jy=[Gy.MOUSE_DOWN,Gy.MOUSE_MOVE,Gy.MOUSE_UP,Gy.MOUSE_WHEEL],Zy=[Gy.KEY_DOWN,Gy.KEY_UP];class Qy{constructor(){this.gt0Index=0,this._fixedListeners=[],this._sceneGraphListeners=[]}size(){return this._fixedListeners.length+this._sceneGraphListeners.length}empty(){return 0===this._fixedListeners.length&&0===this._sceneGraphListeners.length}push(t){0===t._getFixedPriority()?this._sceneGraphListeners.push(t):this._fixedListeners.push(t)}clearSceneGraphListeners(){this._sceneGraphListeners.length=0}clearFixedListeners(){this._fixedListeners.length=0}clear(){this._sceneGraphListeners.length=0,this._fixedListeners.length=0}getFixedPriorityListeners(){return this._fixedListeners}getSceneGraphPriorityListeners(){return this._sceneGraphListeners}}const tv=new class{constructor(){this._listenersMap={},this._priorityDirtyFlagMap={},this._nodeListenersMap={},this._toAddedListeners=[],this._toRemovedListeners=[],this._dirtyListeners={},this._inDispatch=0,this._isEnabled=!1,this._internalCustomListenerIDs=[],this._currentTouch=null,this._currentTouchListener=null}pauseTarget(t,e=!1){if(!(t instanceof n._BaseNode))return void A(3506);const i=this._nodeListenersMap[t.uuid];if(i)for(let t=0,e=i.length;t<e;t++){const e=i[t];e._setPaused(!0),e instanceof Wy&&e._claimedTouches.includes(this._currentTouch)&&this._clearCurTouch()}if(!0===e){const e=t.children;if(e)for(let t=0;t<e.length;++t){const i=e[t];this.pauseTarget(i,!0)}}}resumeTarget(t,e=!1){if(!(t instanceof n._BaseNode))return void A(3506);const i=this._nodeListenersMap[t.uuid];if(i)for(let t=0;t<i.length;++t)i[t]._setPaused(!1);if(this._setDirtyForNode(t),!0===e&&t.children.length>0){const e=t.children;if(e)for(let t=0;t<e.length;++t){const i=e[t];this.resumeTarget(i,!0)}}}frameUpdateListeners(){const t=this._listenersMap,e=this._priorityDirtyFlagMap;for(const i in t)t[i].empty()&&(delete e[i],delete t[i]);const i=this._toAddedListeners;if(0!==i.length){for(let t=0,e=i.length;t<e;t++)this._forceAddEventListener(i[t]);i.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}hasEventListener(t){return!!this._getListeners(t)}addListener(t,e){if(E(t&&e,3503),!(n.js.isNumber(e)||e instanceof n._BaseNode))return A(3506),null;if(t instanceof n.EventListener){if(t._isRegistered())return b(3505),null}else E(!n.js.isNumber(e),3504),t=n.EventListener.create(t);if(!t.checkAvailable())return null;if(n.js.isNumber(e)){if(0===e)return b(3500),null;t._setSceneGraphPriority(null),t._setFixedPriority(e),t._setRegistered(!0),t._setPaused(!1),this._addListener(t)}else{if(!(i=e)||!i.getComponent("cc.UITransform"))return b(3512),null;t._setSceneGraphPriority(e),t._setFixedPriority(0),t._setRegistered(!0),this._addListener(t)}var i;return t}addCustomListener(t,e){const i=ky.create({event:n.EventListener.CUSTOM,eventName:t,callback:e});return this.addListener(i,1),i}removeListener(t){if(null==t)return;let e=!1;const i=this._listenersMap;t===this._currentTouchListener&&(this._currentTouchListener=this._currentTouch=null);for(const n in i){const s=i[n],r=s.getFixedPriorityListeners(),o=s.getSceneGraphPriorityListeners();if(e=this._removeListenerInVector(o,t),e?this._setDirty(t._getListenerID(),2):(e=this._removeListenerInVector(r,t),e&&this._setDirty(t._getListenerID(),1)),s.empty()&&(delete this._priorityDirtyFlagMap[t._getListenerID()],delete i[n]),e)break}if(!e){const e=this._toAddedListeners;for(let i=e.length-1;i>=0;i--){const s=e[i];if(s===t){n.js.array.removeAt(e,i),s._setRegistered(!1);break}}}}removeListeners(t,e=!1){if(n.js.isNumber(t)||t instanceof n._BaseNode)if(void 0!==t._id){const i=this._nodeListenersMap[t._id];if(i){const e=n.js.array.copy(i);for(let t=0;t<e.length;++t){const i=e[t];this.removeListener(i)}delete this._nodeListenersMap[t._id]}const s=this._toAddedListeners;for(let e=0;e<s.length;){const i=s[e];i._getSceneGraphPriority()===t?(i._setSceneGraphPriority(null),i._setRegistered(!1),s.splice(e,1)):++e}if(!0===e){const e=t.getChildren();for(let t=0;t<e.length;++t){const i=e[t];this.removeListeners(i,!0)}}}else t===n.EventListener.TOUCH_ONE_BY_ONE?this._removeListenersForListenerID(Ky.TOUCH_ONE_BY_ONE):t===n.EventListener.TOUCH_ALL_AT_ONCE?this._removeListenersForListenerID(Ky.TOUCH_ALL_AT_ONCE):t===n.EventListener.MOUSE?this._removeListenersForListenerID(Ky.MOUSE):t===n.EventListener.ACCELERATION?this._removeListenersForListenerID(Ky.ACCELERATION):t===n.EventListener.KEYBOARD?this._removeListenersForListenerID(Ky.KEYBOARD):b(3501);else A(3506)}removeCustomListeners(t){this._removeListenersForListenerID(t)}removeAllListeners(){const t=this._listenersMap,e=this._internalCustomListenerIDs;for(const i in t)-1===e.indexOf(i)&&this._removeListenersForListenerID(i)}setPriority(t,e){if(null==t)return;const i=this._listenersMap;for(const n in i){const s=i[n].getFixedPriorityListeners();if(s&&-1!==s.indexOf(t))return null!=t._getSceneGraphPriority()&&b(3502),void(t._getFixedPriority()!==e&&(t._setFixedPriority(e),this._setDirty(t._getListenerID(),1)))}}setEnabled(t){this._isEnabled=t}isEnabled(){return this._isEnabled}dispatchEvent(t){if(!this._isEnabled)return;if(this._updateDirtyFlagForSceneGraph(),this._inDispatch++,!t||!t.getType)return void T(3511);if($y.includes(t.getType()))return this._dispatchTouchEvent(t),void this._inDispatch--;const e=function(t){const e=t.type;return e===Gy.DEVICEMOTION?Ky.ACCELERATION:Zy.includes(e)?Ky.KEYBOARD:Jy.includes(e)?Ky.MOUSE:($y.includes(e)&&b(2e3),"")}(t);this._sortEventListeners(e);const i=this._listenersMap[e];null!=i&&(this._dispatchEventToListeners(i,this._onListenerCallback,t),this._onUpdateListeners(i)),this._inDispatch--}_onListenerCallback(t,e){e.currentTarget=t._target;const i=t.onEvent;return i&&i(e),e.isStopped()}dispatchCustomEvent(t,e){const i=new n.Event.EventCustom(t);i.setUserData(e),this.dispatchEvent(i)}_setDirtyForNode(t){const e=this._nodeListenersMap[t._id];if(void 0!==e)for(let t=0,i=e.length;t<i;t++){const i=e[t]._getListenerID();this._dirtyListeners[i]||(this._dirtyListeners[i]=!0)}if(t.children.length>0){const e=t.children;for(let t=0,i=e?e.length:0;t<i;t++)this._setDirtyForNode(e[t])}}_addListener(t){0===this._inDispatch?this._forceAddEventListener(t):this._toAddedListeners.push(t)}_forceAddEventListener(t){const e=t._getListenerID();let i=this._listenersMap[e];if(i||(i=new Qy,this._listenersMap[e]=i),i.push(t),0===t._getFixedPriority()){this._setDirty(e,2);const i=t._getSceneGraphPriority();null===i&&b(3507),this._associateNodeAndEventListener(i,t),i.activeInHierarchy&&this.resumeTarget(i)}else this._setDirty(e,1)}_getListeners(t){return this._listenersMap[t]}_updateDirtyFlagForSceneGraph(){const t=this._dirtyListeners;for(const e in t)this._setDirty(e,2),t[e]=!1}_removeAllListenersInVector(t){if(!t)return;let e;for(let i=t.length-1;i>=0;i--)e=t[i],e._setRegistered(!1),null!=e._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(e._getSceneGraphPriority(),e),e._setSceneGraphPriority(null)),0===this._inDispatch&&n.js.array.removeAt(t,i)}_removeListenersForListenerID(t){const e=this._listenersMap[t];if(e){const i=e.getFixedPriorityListeners(),n=e.getSceneGraphPriorityListeners();this._removeAllListenersInVector(n),this._removeAllListenersInVector(i),delete this._priorityDirtyFlagMap[t],this._inDispatch||(e.clear(),delete this._listenersMap[t])}const i=this._toAddedListeners;for(let e=i.length-1;e>=0;e--){const s=i[e];s&&s._getListenerID()===t&&n.js.array.removeAt(i,e)}}_sortEventListeners(t){let e=0;const i=this._priorityDirtyFlagMap;i[t]&&(e=i[t]),0!==e&&(i[t]=0,1&e&&this._sortListenersOfFixedPriority(t),2&e)&&n.director.getScene()&&this._sortListenersOfSceneGraphPriority(t)}_sortListenersOfSceneGraphPriority(t){const e=this._getListeners(t);if(!e)return;const i=e.getSceneGraphPriorityListeners();if(!i||0===i.length)return;const n=e.getSceneGraphPriorityListeners();n.forEach((t=>{const e=t._getSceneGraphPriority()._uiProps.uiTransformComp;t._cameraPriority=e.cameraPriority})),n.sort(this._sortEventListenersOfSceneGraphPriorityDes)}_sortEventListenersOfSceneGraphPriorityDes(t,e){const i=t._getSceneGraphPriority(),n=e._getSceneGraphPriority();if(!(e&&n&&n._activeInHierarchy&&n._uiProps.uiTransformComp))return-1;if(!(t&&i&&i._activeInHierarchy&&i._uiProps.uiTransformComp))return 1;let s=i,r=n,o=!1;if(t._cameraPriority!==e._cameraPriority)return e._cameraPriority-t._cameraPriority;for(;s.parent._id!==r.parent._id;)s=null===s.parent.parent?(o=!0)&&n:s.parent,r=null===r.parent.parent?(o=!0)&&i:r.parent;if(s._id===r._id){if(s._id===n._id)return-1;if(s._id===i._id)return 1}const a=s.getSiblingIndex(),l=r.getSiblingIndex();return o?a-l:l-a}_sortListenersOfFixedPriority(t){const e=this._listenersMap[t];if(!e)return;const i=e.getFixedPriorityListeners();if(!i||0===i.length)return;i.sort(this._sortListenersOfFixedPriorityAsc);let n=0;for(const t=i.length;n<t&&!(i[n]._getFixedPriority()>=0);)++n;e.gt0Index=n}_sortListenersOfFixedPriorityAsc(t,e){return t._getFixedPriority()-e._getFixedPriority()}_onUpdateListeners(t){const e=t.getFixedPriorityListeners(),i=t.getSceneGraphPriorityListeners(),s=this._toRemovedListeners;if(i)for(let t=i.length-1;t>=0;t--){const e=i[t];if(!e._isRegistered()){n.js.array.removeAt(i,t);const r=s.indexOf(e);-1!==r&&s.splice(r,1)}}if(e)for(let t=e.length-1;t>=0;t--){const i=e[t];if(!i._isRegistered()){n.js.array.removeAt(e,t);const r=s.indexOf(i);-1!==r&&s.splice(r,1)}}i&&0===i.length&&t.clearSceneGraphListeners(),e&&0===e.length&&t.clearFixedListeners()}_updateTouchListeners(t){const e=this._inDispatch;if(E(e>0,3508),e>1)return;let i;i=this._listenersMap[Ky.TOUCH_ONE_BY_ONE],i&&this._onUpdateListeners(i),i=this._listenersMap[Ky.TOUCH_ALL_AT_ONCE],i&&this._onUpdateListeners(i),E(1===e,3509);const n=this._toAddedListeners;if(0!==n.length){for(let t=0,e=n.length;t<e;t++)this._forceAddEventListener(n[t]);this._toAddedListeners.length=0}0!==this._toRemovedListeners.length&&this._cleanToRemovedListeners()}_cleanToRemovedListeners(){const t=this._toRemovedListeners;for(let e=0;e<t.length;++e){const i=t[e],n=this._listenersMap[i._getListenerID()];if(!n)continue;const s=n.getFixedPriorityListeners(),r=n.getSceneGraphPriorityListeners();if(r){const t=r.indexOf(i);-1!==t&&r.splice(t,1)}if(s){const t=s.indexOf(i);-1!==t&&s.splice(t,1)}}t.length=0}_onTouchEventCallback(t,e){if(!t._isRegistered())return!1;const i=e.event,n=i.touch;i.currentTarget=t._getSceneGraphPriority();let s=!1,r=-1;const o=i.type;if(o===Gy.TOUCH_START){if(!Ut.ENABLE_MULTI_TOUCH&&tv._currentTouch){const t=tv._currentTouchListener._node;if(!t||t.activeInHierarchy)return!1}t.onTouchBegan&&(s=t.onTouchBegan(n,i),s&&t._isRegistered()&&!t._isPaused()&&(t._claimedTouches.push(n),!Ut.ENABLE_MULTI_TOUCH&&tv._currentTouch||(tv._currentTouch=n),tv._currentTouchListener=t))}else if(t._claimedTouches.length>0&&(r=t._claimedTouches.indexOf(n),-1!==r)){if(s=!0,!Ut.ENABLE_MULTI_TOUCH&&tv._currentTouch&&tv._currentTouch!==n)return!1;o===Gy.TOUCH_MOVE&&t.onTouchMoved?t.onTouchMoved(n,i):o===Gy.TOUCH_END?(t.onTouchEnded&&t.onTouchEnded(n,i),t._isRegistered()&&t._claimedTouches.splice(r,1),(Ut.ENABLE_MULTI_TOUCH||tv._currentTouch===n)&&(tv._currentTouch=null),tv._currentTouchListener=null):o===Gy.TOUCH_CANCEL&&(t.onTouchCancelled&&t.onTouchCancelled(n,i),t._isRegistered()&&t._claimedTouches.splice(r,1),(Ut.ENABLE_MULTI_TOUCH||tv._currentTouch===n)&&(tv._currentTouch=null),tv._currentTouchListener=null)}return i.isStopped()?(tv._updateTouchListeners(i),!0):!!(s&&t._isRegistered()&&t.swallowTouches)&&(e.needsMutableSet&&e.touches.splice(n,1),!0)}_dispatchTouchEvent(t){this._sortEventListeners(Ky.TOUCH_ONE_BY_ONE),this._sortEventListeners(Ky.TOUCH_ALL_AT_ONCE);const e=this._getListeners(Ky.TOUCH_ONE_BY_ONE),i=this._getListeners(Ky.TOUCH_ALL_AT_ONCE);if(null===e&&null===i)return;const s=t.getTouches(),r=n.js.array.copy(s),o={event:t,needsMutableSet:e&&i,touches:r,selTouch:null};if(e)for(let i=0;i<s.length;++i){const n=s[i];t.touch=n,t.propagationStopped=t.propagationImmediateStopped=!1,this._dispatchEventToListeners(e,this._onTouchEventCallback,o)}i&&r.length>0&&(this._dispatchEventToListeners(i,this._onTouchesEventCallback,{event:t,touches:r}),t.isStopped())||this._updateTouchListeners(t)}_onTouchesEventCallback(t,e){if(!t._isRegistered())return!1;const i=e.event,n=e.touches,s=i.type;return i.currentTarget=t._getSceneGraphPriority(),s===Gy.TOUCH_START&&t.onTouchesBegan?t.onTouchesBegan(n,i):s===Gy.TOUCH_MOVE&&t.onTouchesMoved?t.onTouchesMoved(n,i):s===Gy.TOUCH_END&&t.onTouchesEnded?t.onTouchesEnded(n,i):s===Gy.TOUCH_CANCEL&&t.onTouchesCancelled&&t.onTouchesCancelled(n,i),!!i.isStopped()&&(tv._updateTouchListeners(i),!0)}_associateNodeAndEventListener(t,e){let i=this._nodeListenersMap[t.uuid];i||(i=[],this._nodeListenersMap[t.uuid]=i),i.push(e)}_dissociateNodeAndEventListener(t,e){const i=this._nodeListenersMap[t.uuid];i&&(n.js.array.remove(i,e),0===i.length&&delete this._nodeListenersMap[t.uuid])}_dispatchEventToListeners(t,e,i){let n=!1;const s=t.getFixedPriorityListeners(),r=t.getSceneGraphPriorityListeners();let o=0;if(s&&0!==s.length)for(;o<t.gt0Index;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,i)){n=!0;break}}if(r&&!n)for(let t=0;t<r.length;++t){const s=r[t];if(s.isEnabled()&&!s._isPaused()&&s._isRegistered()&&e(s,i)){n=!0;break}}if(s&&!n)for(;o<s.length;++o){const t=s[o];if(t.isEnabled()&&!t._isPaused()&&t._isRegistered()&&e(t,i)){n=!0;break}}}_setDirty(t,e){const i=this._priorityDirtyFlagMap;null==i[t]?i[t]=e:i[t]|=e}_sortNumberAsc(t,e){return t-e}_clearCurTouch(){this._currentTouchListener=null,this._currentTouch=null}_removeListenerInCallback(t,e){if(null==t)return!1;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s._onCustomEvent===e||s.onEvent===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(t,i):this._toRemovedListeners.push(s),!0}return!1}_removeListenerInVector(t,e){if(null==t)return!1;for(let i=t.length-1;i>=0;i--){const s=t[i];if(s===e)return s._setRegistered(!1),null!=s._getSceneGraphPriority()&&(this._dissociateNodeAndEventListener(s._getSceneGraphPriority(),s),s._setSceneGraphPriority(null)),0===this._inDispatch?n.js.array.removeAt(t,i):this._toRemovedListeners.push(s),!0}return!1}};let ev;var iv,nv,sv,rv,ov,av,lv,cv,hv;Me.Flags.Destroying,function(t){t.TOUCH_START="touch-start",t.TOUCH_MOVE="touch-move",t.TOUCH_END="touch-end",t.TOUCH_CANCEL="touch-cancel",t.MOUSE_DOWN="mouse-down",t.MOUSE_MOVE="mouse-move",t.MOUSE_UP="mouse-up",t.MOUSE_WHEEL="mouse-wheel",t.MOUSE_ENTER="mouse-enter",t.MOUSE_LEAVE="mouse-leave",t.KEY_DOWN="keydown",t.KEY_UP="keyup",t.DEVICEMOTION="devicemotion",t.TRANSFORM_CHANGED="transform-changed",t.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",t.SIZE_CHANGED="size-changed",t.ANCHOR_CHANGED="anchor-changed",t.COLOR_CHANGED="color-changed",t.CHILD_ADDED="child-added",t.CHILD_REMOVED="child-removed",t.PARENT_CHANGED="parent-changed",t.NODE_DESTROYED="node-destroyed",t.LAYER_CHANGED="layer-changed",t.SIBLING_ORDER_CHANGED="sibling-order-changed"}(ev||(ev={}));const _v=Me.Flags.Destroying,uv=Me.Flags.DontDestroy,mv=Me.Flags.Deactivating,pv=new X("Node");function dv(t){return t?"string"==typeof t?Dt(t):t:(T(3804),null)}let fv=t("BaseNode",Vl("cc.BaseNode")((hv=cv=class t extends Me{get components(){return this._components}get _persistNode(){return(this._objFlags&uv)>0}set _persistNode(t){t?this._objFlags|=uv:this._objFlags&=~uv}get name(){return this._name}set name(t){this._name=t}get uuid(){return this._id}get children(){return this._children}get active(){return this._active}set active(t){if(this._active!==t){this._active=t;const e=this._parent;e&&e._activeInHierarchy&&n.director._nodeActivator.activateNode(this,t)}}get activeInHierarchy(){return this._activeInHierarchy}get parent(){return this._parent}set parent(t){this.setParent(t)}get scene(){return this._scene}get eventProcessor(){return this._eventProcessor}static _setScene(t){t._updateScene()}static _findComponent(t,e){const i=e,n=t._components;if(i._sealed)for(let t=0;t<n.length;++t){const i=n[t];if(i.constructor===e)return i}else for(let t=0;t<n.length;++t){const i=n[t];if(i instanceof e)return i}return null}static _findComponents(t,e,i){const n=e,s=t._components;if(n._sealed)for(let t=0;t<s.length;++t){const n=s[t];n.constructor===e&&i.push(n)}else for(let t=0;t<s.length;++t){const n=s[t];n instanceof e&&i.push(n)}}static _findChildComponent(e,i){for(let n=0;n<e.length;++n){const s=e[n];let r=t._findComponent(s,i);if(r)return r;if(s._children.length>0&&(r=t._findChildComponent(s._children,i),r))return r}return null}static _findChildComponents(e,i,n){for(let s=0;s<e.length;++s){const r=e[s];t._findComponents(r,i,n),r._children.length>0&&t._findChildComponents(r._children,i,n)}}_updateScene(){null==this._parent?p("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene}constructor(t){super(t),Tl(this,"_parent",sv,this),Tl(this,"_children",rv,this),Tl(this,"_active",ov,this),Tl(this,"_components",av,this),Tl(this,"_prefab",lv,this),this._scene=null,this._activeInHierarchy=!1,this._id=pv.getNewId(),this._name=void 0,this._eventProcessor=new n.NodeEventProcessor(this),this._eventMask=0,this._siblingIndex=0,this._originalSceneId="",this._registerIfAttached=void 0,this._name=void 0!==t?t:"New Node"}attr(t){dt(this,t)}getParent(){return this._parent}setParent(t,e=!1){if(this._parent===t)return;const i=this._parent,n=t;if(this._parent=n,this._siblingIndex=0,this._onSetParent(i,e),this.emit&&this.emit(ev.PARENT_CHANGED,i),i&&!(i._objFlags&_v)){const t=i._children.indexOf(this);i._children.splice(t,1),i._updateSiblingIndex(),i.emit&&i.emit(ev.CHILD_REMOVED,this)}n&&(n._children.push(this),this._siblingIndex=n._children.length-1,n.emit&&n.emit(ev.CHILD_ADDED,this)),this._onHierarchyChanged(i)}getChildByUuid(t){if(!t)return u("Invalid uuid"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._id===t)return e[i];return null}getChildByName(t){if(!t)return u("Invalid name"),null;const e=this._children;for(let i=0,n=e.length;i<n;i++)if(e[i]._name===t)return e[i];return null}getChildByPath(t){const e=t.split("/");let i=this;for(let t=0;t<e.length;++t){const n=e[t];if(0===n.length)continue;const s=i.children.find((t=>t.name===n));if(!s)return null;i=s}return i}addChild(t){t.setParent(this)}insertChild(t,e){t.parent=this,t.setSiblingIndex(e)}getSiblingIndex(){return this._siblingIndex}setSiblingIndex(t){if(!this._parent)return;if(this._parent._objFlags&mv)return void T(3821);const e=this._parent._children;t=-1!==t?t:e.length-1;const i=e.indexOf(this);t!==i&&(e.splice(i,1),t<e.length?e.splice(t,0,this):e.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(t))}walk(e,i){let n=1,s=null,r=null,o=0,a=t._stacks[t._stackId];a||(a=[],t._stacks.push(a)),t._stackId++,a.length=0,a[0]=this;let l=null,c=!1;for(;n;)if(n--,r=a[n],r)if(!c&&e?e(r):c&&i&&i(r),a[n]=null,c){if(l===this._parent)break;if(c=!1,s)if(o++,s[o])a[n]=s[o],n++;else if(l&&(a[n]=l,n++,c=!0,l._parent?(s=l._parent._children,o=s.indexOf(l),l=l._parent):(l=null,s=null),o<0))break}else r._children.length>0?(l=r,s=r._children,o=0,a[n]=s[o],n++):(a[n]=r,n++,c=!0);a.length=0,t._stackId--}removeFromParent(){this._parent&&this._parent.removeChild(this)}removeChild(t){this._children.indexOf(t)>-1&&(t.parent=null)}removeAllChildren(){const t=this._children;for(let e=t.length-1;e>=0;e--){const i=t[e];i&&(i.parent=null)}this._children.length=0}isChildOf(t){let e=this;do{if(e===t)return!0;e=e._parent}while(e);return!1}getComponent(e){const i=dv(e);return i?t._findComponent(this,i):null}getComponents(e){const i=dv(e),n=[];return i&&t._findComponents(this,i,n),n}getComponentInChildren(e){const i=dv(e);return i?t._findChildComponent(this._children,i):null}getComponentsInChildren(e){const i=dv(e),n=[];return i&&(t._findComponents(this,i,n),t._findChildComponents(this._children,i,n)),n}addComponent(t){let e;if("string"==typeof t){if(e=Dt(t),!e)throw n._RF.peek()&&T(3808,t),TypeError(D(3807,t))}else{if(!t)throw TypeError(D(3804));e=t}if("function"!=typeof e)throw TypeError(D(3809));if(!yt(e,n.Component))throw TypeError(D(3810));const i=e._requireComponent;i&&!this.getComponent(i)&&this.addComponent(i);const s=new e;return s.node=this,this._components.push(s),this._activeInHierarchy&&n.director._nodeActivator.activateComp(s),s}removeComponent(t){if(!t)return void T(3813);let e=null;e=t instanceof Rh?t:this.getComponent(t),e&&e.destroy()}on(t,e,i,n=!1){switch(t){case ev.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(t,e,i,n)}off(t,e,i,n=!1){if(this._eventProcessor.off(t,e,i,n),!this._eventProcessor.hasEventListener(t))switch(t){case ev.TRANSFORM_CHANGED:this._eventMask&=-2}}once(t,e,i,n){this._eventProcessor.once(t,e,i,n)}emit(t,e,i,n,s,r){this._eventProcessor.emit(t,e,i,n,s,r)}dispatchEvent(t){this._eventProcessor.dispatchEvent(t)}hasEventListener(t,e,i){return this._eventProcessor.hasEventListener(t,e,i)}targetOff(t){this._eventProcessor.targetOff(t),1&this._eventMask&&!this._eventProcessor.hasEventListener(ev.TRANSFORM_CHANGED)&&(this._eventMask&=-2)}destroy(){return!!super.destroy()&&(this.active=!1,!0)}destroyAllChildren(){const t=this._children;for(let e=0;e<t.length;++e)t[e].destroy()}_removeComponent(t){if(t){if(!(this._objFlags&_v)){const e=this._components.indexOf(t);-1!==e?this._components.splice(e,1):t.node!==this&&T(3815)}}else T(3814)}_updateSiblingIndex(){for(let t=0;t<this._children.length;++t)this._children[t]._siblingIndex=t;this.emit(ev.SIBLING_ORDER_CHANGED)}_onSetParent(e,i=!1){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(t._setScene))}_onPostActivated(t){}_onBatchCreated(t){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))}_onPreDestroy(){this._onPreDestroyBase()}_onHierarchyChanged(t){return this._onHierarchyChangedBase(t)}_instantiate(t,e){return t||(t=n.instantiate._clone(this,this)),t._prefab,t._parent=null,t._onBatchCreated(e),t}_onHierarchyChangedBase(t){const e=this._parent;!this._persistNode||e instanceof n.Scene||n.game.removePersistRootNode(this);const i=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==i&&n.director._nodeActivator.activateNode(this,i)}_onPreDestroyBase(){this._objFlags|=_v;const t=this._parent,e=!!t&&0!=(t._objFlags&_v);if(this._persistNode&&n.game.removePersistRootNode(this),!e&&t){this.emit(ev.PARENT_CHANGED,this);const e=t._children.indexOf(this);t._children.splice(e,1),this._siblingIndex=0,t._updateSiblingIndex(),t.emit&&t.emit(ev.CHILD_REMOVED,this)}this.emit(ev.NODE_DESTROYED,this),this._eventProcessor.destroy();const i=this._children;for(let t=0;t<i.length;++t)i[t]._destroyImmediate();const s=this._components;for(let t=0;t<s.length;++t)s[t]._destroyImmediate();return e}},cv.idGenerator=pv,cv._stacks=[[]],cv._stackId=0,wl((nv=hv).prototype,"_persistNode",[Hl],Object.getOwnPropertyDescriptor(nv.prototype,"_persistNode"),nv.prototype),wl(nv.prototype,"name",[ic],Object.getOwnPropertyDescriptor(nv.prototype,"name"),nv.prototype),wl(nv.prototype,"children",[ic],Object.getOwnPropertyDescriptor(nv.prototype,"children"),nv.prototype),wl(nv.prototype,"active",[ic],Object.getOwnPropertyDescriptor(nv.prototype,"active"),nv.prototype),wl(nv.prototype,"activeInHierarchy",[ic],Object.getOwnPropertyDescriptor(nv.prototype,"activeInHierarchy"),nv.prototype),wl(nv.prototype,"parent",[ic],Object.getOwnPropertyDescriptor(nv.prototype,"parent"),nv.prototype),sv=wl(nv.prototype,"_parent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rv=wl(nv.prototype,"_children",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ov=wl(nv.prototype,"_active",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),av=wl(nv.prototype,"_components",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lv=wl(nv.prototype,"_prefab",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),iv=nv))||iv);function gv(t){const e=t._prefab;if(!e)return;if(!e.instance)return;if(!e.asset)return T(3701,t.name),void(e.instance=void 0);const i=t._objFlags,s=t._parent,r=t._id,o=t._prefab;t[De],n.game._isCloning=!0,e.asset._doInstantiate(t),n.game._isCloning=!1,t._objFlags=i,t._parent=s,t._id=r,t._prefab&&(t._prefab.instance=null==o?void 0:o.instance)}function yv(t,e,i){var n;if(!e)return;let s=e;const r=null===(n=t._prefab)||void 0===n?void 0:n.instance;!i&&r&&(e[r.fileId]={},s=e[r.fileId]);const o=t._prefab;o&&(s[o.fileId]=t);const a=t.components;for(let t=0;t<a.length;t++){const e=a[t];e.__prefab&&(s[e.__prefab.fileId]=e)}for(let e=0;e<t.children.length;e++)yv(t.children[e],s,!1)}function vv(t,e){if(!t)return null;let i=null,n=e;for(let e=0;e<t.length;e++){if(!n)return null;n=n[t[e]]}return i=n,i}function xv(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=vv(n.targetInfo.localID,i);if(!t)continue;let e=i;const s=n.targetInfo.localID;if(s.length>0)for(let t=0;t<s.length-1;t++)e=e[s[t]];if(n.nodes)for(let i=0;i<n.nodes.length;i++){const s=n.nodes[i];s&&(t._children.push(s),s._parent=t,yv(s,e,!1),s._siblingIndex=t._children.length-1,s._onBatchCreated(!1))}}}}function bv(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n&&n.targetInfo){const t=vv(n.targetInfo.localID,i);if(!t)continue;if(n.components)for(let e=0;e<n.components.length;e++){const i=n.components[e];i&&(i.node=t,t._components.push(i))}}}}function Sv(t,e,i){if(e)for(let t=0;t<e.length;t++){const n=e[t];if(n){const t=vv(n.localID,i);if(!t||!t.node)continue;const e=t.node.components.indexOf(t);e>=0&&t.node._components.splice(e,1)}}}function Av(t,e,i){if(e.length<=0)return;let n=null;for(let t=0;t<e.length;t++){const s=e[t];if(s&&s.targetInfo){if(n=vv(s.targetInfo.localID,i),!n)continue;let t=n;const e=s.propertyPath.slice();if(e.length>0){const i=e.pop();if(!i)continue;for(let i=0;i<e.length&&(t=t[e[i]],t);i++);if(!t)continue;if(Array.isArray(t))if("length"===i)t[i]=s.value;else{const e=Number.parseInt(i);Number.isInteger(e)&&e<t.length&&(t[i]=s.value)}else t[i]=s.value}}}}function Cv(t){var e;const i=null===(e=t._prefab)||void 0===e?void 0:e.targetOverrides;if(i)for(let t=0;t<i.length;t++){var n,s;const e=i[t];let a=e.source;const l=e.sourceInfo;if(l){var r,o;const t=null===(r=e.source)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;t&&t.targetMap&&(a=vv(l.localID,t.targetMap))}if(!a)continue;let c=null;const h=e.targetInfo;if(!h)continue;const _=null===(n=e.target)||void 0===n||null===(s=n._prefab)||void 0===s?void 0:s.instance;if(!_||!_.targetMap)continue;if(c=vv(h.localID,_.targetMap),!c)continue;const u=e.propertyPath.slice();let m=a;if(u.length>0){const t=u.pop();if(!t)return;for(let t=0;t<u.length&&(m=m[u[t]],m);t++);if(!m)continue;m[t]=c}}}var Tv,wv,Ev,Pv,Dv,Iv,Rv,Mv,Ov,Bv,Nv;n._BaseNode=fv;const Lv=new Ni,Fv=new ki,zv=new ki,Vv=new ki,Uv=new Vi,Gv=new Vi,kv=new $i,Hv=[],jv=[];class Wv{constructor(){this._chunks=[],this._freelists=[],this._createChunk()}alloc(){const t=this._freelists.length;for(let e=0;e<t;++e)if(this._freelists[e].length)return this._createView(e);return this._createChunk(),this._createView(t)}free(t,e){const i=this._freelists.length;for(let n=0;n<i;++n)if(this._chunks[n]===t)return void this._freelists[n].push(e)}clear(){const t=this._chunks.length;for(let e=0;e<t;++e)this._chunks[e].fill(0)}_createChunk(){this._chunks.push(new Uint32Array(Wv.CAPACITY_PER_CHUNK));const t=[];for(let e=0;e<Wv.CAPACITY_PER_CHUNK;++e)t.push(e);this._freelists.push(t)}_createView(t){return[this._chunks[t],this._freelists[t].pop()]}}Wv.CAPACITY_PER_CHUNK=256;const qv=new Wv,Xv=Symbol("ReserveContentsForAllSyncablePrefab");let Yv=t("Node",(Tv=Vl("cc.Node"),wv=yc(Ni),Tv((Nv=Bv=class t extends fv{get _dirtyFlags(){return this._dirtyFlagsPri}set _dirtyFlags(t){this._dirtyFlagsPri=t,this._nativeDirtyFlag[0]=t}_init(){const[t,e]=qv.alloc();this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=e;{this._nodeHandle=il.alloc(),this._pos=new Ni(il.getTypedArray(this._nodeHandle,Qa.WORLD_POSITION)),this._rot=new ki(il.getTypedArray(this._nodeHandle,Qa.WORLD_ROTATION)),this._scale=new Ni(il.getTypedArray(this._nodeHandle,Qa.WORLD_SCALE)),this._lpos=new Ni(il.getTypedArray(this._nodeHandle,Qa.LOCAL_POSITION)),this._lrot=new ki(il.getTypedArray(this._nodeHandle,Qa.LOCAL_ROTATION)),this._lscale=new Ni(il.getTypedArray(this._nodeHandle,Qa.LOCAL_SCALE)),this._mat=new $i(il.getTypedArray(this._nodeHandle,Qa.WORLD_MATRIX)),this._nativeLayer=il.getTypedArray(this._nodeHandle,Qa.LAYER),this._nativeDirtyFlag=il.getTypedArray(this._nodeHandle,Qa.DIRTY_FLAG),this._scale.set(1,1,1),this._lscale.set(1,1,1),this._nativeLayer[0]=this._layer,this._nativeObj=new Nn;const i=new Uint32Array(t.buffer,t.byteOffset+4*e,1);this._nativeObj.initWithData(il.getBuffer(this._nodeHandle),i,jv)}}constructor(t){super(t),this._uiProps=new Uy(this),this._static=!1,Tl(this,"_lpos",Dv,this),Tl(this,"_lrot",Iv,this),Tl(this,"_lscale",Rv,this),Tl(this,"_layer",Mv,this),Tl(this,"_euler",Ov,this),this._dirtyFlagsPri=Sg.NONE,this._eulerDirty=!1,this._nodeHandle=0,this._init()}static isNode(e){return e instanceof t&&(e.constructor===t||!(e instanceof n.Scene))}_onPreDestroy(){const t=this._onPreDestroyBase();return this._nodeHandle&&(il.free(this._nodeHandle),this._nodeHandle=0),this._nativeObj=null,qv.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),t}get native(){return this._nativeObj}get position(){return this._lpos}set position(t){this.setPosition(t)}get worldPosition(){return this.updateWorldTransform(),this._pos}set worldPosition(t){this.setWorldPosition(t)}get rotation(){return this._lrot}set rotation(t){this.setRotation(t)}set eulerAngles(t){this.setRotationFromEuler(t.x,t.y,t.z)}get eulerAngles(){return this._eulerDirty&&(ki.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler}get angle(){return this._euler.z}set angle(t){Ni.set(this._euler,0,0,t),ki.fromAngleZ(this._lrot,t),this._eulerDirty=!1,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}get worldRotation(){return this.updateWorldTransform(),this._rot}set worldRotation(t){this.setWorldRotation(t)}get scale(){return this._lscale}set scale(t){this.setScale(t)}get worldScale(){return this.updateWorldTransform(),this._scale}set worldScale(t){this.setWorldScale(t)}set matrix(t){$i.toRTS(t,this._lrot,this._lpos,this._lscale),this.invalidateChildren(Sg.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.TRS)}get worldMatrix(){return this.updateWorldTransform(),this._mat}get forward(){return Ni.transformQuat(new Ni,Ni.FORWARD,this.worldRotation)}set forward(t){const e=t.length();Ni.multiplyScalar(Lv,t,-1/e),ki.fromViewUp(Fv,Lv),this.setWorldRotation(Fv)}get up(){return Ni.transformQuat(new Ni,Ni.UP,this.worldRotation)}get right(){return Ni.transformQuat(new Ni,Ni.RIGHT,this.worldRotation)}set layer(t){this._layer=t,this._nativeLayer[0]=this._layer,this.emit(ev.LAYER_CHANGED,this._layer)}get layer(){return this._layer}get hasChangedFlags(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]}set hasChangedFlags(t){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=t}[Fh](t,e){t.writeThis()}setParent(t,e=!1){e&&this.updateWorldTransform(),super.setParent(t,e),this._nativeObj.setParent(this.parent?this.parent.native:null)}_onSetParent(t,e){if(super._onSetParent(t,e),e){const t=this._parent;t?(t.updateWorldTransform(),$i.multiply(kv,$i.invert(kv,t._mat),this._mat),$i.toRTS(kv,this._lrot,this._lpos,this._lscale)):(Ni.copy(this._lpos,this._pos),ki.copy(this._lrot,this._rot),Ni.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(Sg.TRS)}_onHierarchyChanged(t){this.eventProcessor.reattach(),super._onHierarchyChangedBase(t)}_onBatchCreated(t){var e,i;this._nativeLayer[0]=this._layer,this._nativeObj.setParent(null===(i=this.parent)||void 0===i?void 0:i.native);const n=null===(e=this._prefab)||void 0===e?void 0:e.instance;!t&&n&&gv(this),this.hasChangedFlags=Sg.TRS,this._dirtyFlags|=Sg.TRS,this._uiProps.uiTransformDirty=!0;const s=this._children.length;for(let e=0;e<s;++e)this._children[e]._siblingIndex=e,this._children[e]._onBatchCreated(t);if(!t&&n){const t={};n.targetMap=t,yv(this,t,!0),xv(0,n.mountedChildren,t),Sv(0,n.removedComponents,t),bv(0,n.mountedComponents,t),Av(0,n.propertyOverrides,t)}Cv(this)}_onBeforeSerialize(){this.eulerAngles}_onPostActivated(t){t?(tv.resumeTarget(this),this.invalidateChildren(Sg.TRS)):tv.pauseTarget(this)}translate(t,e){const i=e||bg.LOCAL;if(i===bg.LOCAL)Ni.transformQuat(Lv,t,this._lrot),this._lpos.x+=Lv.x,this._lpos.y+=Lv.y,this._lpos.z+=Lv.z;else if(i===bg.WORLD)if(this._parent){ki.invert(Fv,this._parent.worldRotation),Ni.transformQuat(Lv,t,Fv);const e=this.worldScale;this._lpos.x+=Lv.x/e.x,this._lpos.y+=Lv.y/e.y,this._lpos.z+=Lv.z/e.z}else this._lpos.x+=t.x,this._lpos.y+=t.y,this._lpos.z+=t.z;this.invalidateChildren(Sg.POSITION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.POSITION)}rotate(t,e){const i=e||bg.LOCAL;if(ki.normalize(Fv,t),i===bg.LOCAL)ki.multiply(this._lrot,this._lrot,Fv);else if(i===bg.WORLD){const t=this.worldRotation;ki.multiply(zv,Fv,t),ki.invert(Fv,t),ki.multiply(zv,Fv,zv),ki.multiply(this._lrot,this._lrot,zv)}this._eulerDirty=!0,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}lookAt(t,e){this.getWorldPosition(Lv),Ni.subtract(Lv,Lv,t),Ni.normalize(Lv,Lv),ki.fromViewUp(Fv,Lv,e),this.setWorldRotation(Fv)}_setDirtyNode(t,e){Hv[t]=e,jv[t]=e.native}invalidateChildren(t){const e=t|Sg.POSITION;this._setDirtyNode(0,this);let i=0;for(;i>=0;){const n=Hv[i--],s=n.hasChangedFlags;if(n.isValid&&(n._dirtyFlags&s&t)!==t){n._dirtyFlags|=t,n._uiProps.uiTransformDirty=!0,n.hasChangedFlags=s|t;const e=n._children,r=e.length;for(let t=0;t<r;++t)this._setDirtyNode(++i,e[t])}t=e}}updateWorldTransform(){if(!this._dirtyFlags)return;let t,e=this,i=0;for(;e&&e._dirtyFlags;)this._setDirtyNode(i++,e),e=e._parent;let n=0;for(;i;)t=Hv[--i],n|=t._dirtyFlags,e?(n&Sg.POSITION&&(Ni.transformMat4(t._pos,t._lpos,e._mat),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&Sg.RS&&($i.fromRTS(t._mat,t._lrot,t._lpos,t._lscale),$i.multiply(t._mat,e._mat,t._mat),n&Sg.ROTATION&&ki.multiply(t._rot,e._rot,t._lrot),Vi.fromQuat(Uv,ki.conjugate(Vv,t._rot)),Vi.multiplyMat4(Uv,Uv,t._mat),t._scale.x=Uv.m00,t._scale.y=Uv.m04,t._scale.z=Uv.m08)):(n&Sg.POSITION&&(Ni.copy(t._pos,t._lpos),t._mat.m12=t._pos.x,t._mat.m13=t._pos.y,t._mat.m14=t._pos.z),n&Sg.RS&&(n&Sg.ROTATION&&ki.copy(t._rot,t._lrot),n&Sg.SCALE&&(Ni.copy(t._scale,t._lscale),$i.fromRTS(t._mat,t._rot,t._pos,t._scale)))),t._dirtyFlags=Sg.NONE,e=t}setPosition(t,e,i){void 0===e&&void 0===i?Ni.copy(this._lpos,t):void 0===i?Ni.set(this._lpos,t,e,this._lpos.z):Ni.set(this._lpos,t,e,i),this.invalidateChildren(Sg.POSITION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.POSITION)}getPosition(t){return t?Ni.set(t,this._lpos.x,this._lpos.y,this._lpos.z):Ni.copy(new Ni,this._lpos)}setRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?ki.copy(this._lrot,t):ki.set(this._lrot,t,e,i,n),this._eulerDirty=!0,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}setRotationFromEuler(t,e,i){const n=void 0===i?this._euler.z:i;void 0===e?(Ni.copy(this._euler,t),ki.fromEuler(this._lrot,t.x,t.y,t.z)):(Ni.set(this._euler,t,e,n),ki.fromEuler(this._lrot,t,e,n)),this._eulerDirty=!1,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}getRotation(t){return t?ki.set(t,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):ki.copy(new ki,this._lrot)}setScale(t,e,i){void 0===e&&void 0===i?Ni.copy(this._lscale,t):void 0===i?Ni.set(this._lscale,t,e,this._lscale.z):Ni.set(this._lscale,t,e,i),this.invalidateChildren(Sg.SCALE),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.SCALE)}getScale(t){return t?Ni.set(t,this._lscale.x,this._lscale.y,this._lscale.z):Ni.copy(new Ni,this._lscale)}inverseTransformPoint(t,e){Ni.copy(t,e);let i=this,n=0;for(;i._parent;)this._setDirtyNode(n++,i),i=i._parent;for(;n>=0;)Ni.transformInverseRTS(t,t,i._lrot,i._lpos,i._lscale),i=Hv[--n];return t}setWorldPosition(t,e,i){void 0===e||void 0===i?Ni.copy(this._pos,t):Ni.set(this._pos,t,e,i);const n=this._parent,s=this._lpos;n?(n.updateWorldTransform(),Ni.transformMat4(s,this._pos,$i.invert(kv,n._mat))):Ni.copy(s,this._pos),this.invalidateChildren(Sg.POSITION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.POSITION)}getWorldPosition(t){return this.updateWorldTransform(),t?Ni.copy(t,this._pos):Ni.copy(new Ni,this._pos)}setWorldRotation(t,e,i,n){void 0===e||void 0===i||void 0===n?ki.copy(this._rot,t):ki.set(this._rot,t,e,i,n),this._parent?(this._parent.updateWorldTransform(),ki.multiply(this._lrot,ki.conjugate(this._lrot,this._parent._rot),this._rot)):ki.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}setWorldRotationFromEuler(t,e,i){ki.fromEuler(this._rot,t,e,i),this._parent?(this._parent.updateWorldTransform(),ki.multiply(this._lrot,ki.conjugate(this._lrot,this._parent._rot),this._rot)):ki.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(Sg.ROTATION),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.ROTATION)}getWorldRotation(t){return this.updateWorldTransform(),t?ki.copy(t,this._rot):ki.copy(new ki,this._rot)}setWorldScale(t,e,i){void 0===e||void 0===i?Ni.copy(this._scale,t):Ni.set(this._scale,t,e,i);const n=this._parent;n?(n.updateWorldTransform(),Vi.fromQuat(Uv,ki.conjugate(Vv,n._rot)),Vi.multiplyMat4(Uv,Uv,n._mat),Gv.m00=this._scale.x,Gv.m04=this._scale.y,Gv.m08=this._scale.z,Vi.multiply(Uv,Gv,Vi.invert(Uv,Uv)),this._lscale.x=Ni.set(Lv,Uv.m00,Uv.m01,Uv.m02).length(),this._lscale.y=Ni.set(Lv,Uv.m03,Uv.m04,Uv.m05).length(),this._lscale.z=Ni.set(Lv,Uv.m06,Uv.m07,Uv.m08).length()):Ni.copy(this._lscale,this._scale),this.invalidateChildren(Sg.SCALE),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,Sg.SCALE)}getWorldScale(t){return this.updateWorldTransform(),t?Ni.copy(t,this._scale):Ni.copy(new Ni,this._scale)}getWorldMatrix(t){this.updateWorldTransform();const e=t||new $i;return $i.copy(e,this._mat)}getWorldRS(t){this.updateWorldTransform();const e=t||new $i;return $i.copy(e,this._mat),e.m12=0,e.m13=0,e.m14=0,e}getWorldRT(t){this.updateWorldTransform();const e=t||new $i;return $i.fromRT(e,this._rot,this._pos)}setRTS(t,e,i){let n=0;t&&(n|=Sg.ROTATION,void 0!==t.w?(ki.copy(this._lrot,t),this._eulerDirty=!0):(Ni.copy(this._euler,t),ki.fromEuler(this._lrot,t.x,t.y,t.z),this._eulerDirty=!1)),e&&(Ni.copy(this._lpos,e),n|=Sg.POSITION),i&&(Ni.copy(this._lscale,i),n|=Sg.SCALE),n&&(this.invalidateChildren(n),1&this._eventMask&&this.emit(ev.TRANSFORM_CHANGED,n))}pauseSystemEvents(t){tv.pauseTarget(this,t)}resumeSystemEvents(t){tv.resumeTarget(this,t)}static resetHasChangedFlags(){qv.clear()}static clearNodeArray(){t.ClearFrame<t.ClearRound?t.ClearFrame++:(t.ClearFrame=0,Hv.length=0,jv.length=0)}},Bv.EventType=ev,Bv.NodeSpace=bg,Bv.TransformDirtyBit=Sg,Bv.TransformBit=Sg,Bv.reserveContentsForAllSyncablePrefabTag=Xv,Bv.ClearFrame=0,Bv.ClearRound=1e3,Dv=wl((Pv=Nv).prototype,"_lpos",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),Iv=wl(Pv.prototype,"_lrot",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ki}}),Rv=wl(Pv.prototype,"_lscale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(1,1,1)}}),Mv=wl(Pv.prototype,"_layer",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qm.Enum.DEFAULT}}),Ov=wl(Pv.prototype,"_euler",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni}}),wl(Pv.prototype,"eulerAngles",[wv],Object.getOwnPropertyDescriptor(Pv.prototype,"eulerAngles"),Pv.prototype),wl(Pv.prototype,"angle",[ic],Object.getOwnPropertyDescriptor(Pv.prototype,"angle"),Pv.prototype),wl(Pv.prototype,"layer",[ic],Object.getOwnPropertyDescriptor(Pv.prototype,"layer"),Pv.prototype),Ev=Pv))||Ev));var Kv,$v,Jv,Zv,Qv,tx,ex,ix,nx,sx,rx,ox,ax,lx,cx,hx,_x,ux,mx,px,dx,fx,gx,yx,vx,xx,bx,Sx,Ax,Cx,Tx,wx,Ex,Px,Dx,Ix,Rx,Mx,Ox,Bx,Nx,Lx,Fx,zx,Vx,Ux,Gx,kx,Hx,jx,Wx,qx,Xx,Yx,Kx,$x,Jx,Zx,Qx,tb,eb,ib,nb,sb;n.Node=Yv;let rb=Vl("cc.TargetInfo")((Jv=wl(($v=class{constructor(){Tl(this,"localID",Jv,this)}}).prototype,"localID",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kv=$v))||Kv,ob=(Zv=Vl("cc.TargetOverrideInfo"),Qv=yc(Me),tx=yc(rb),ex=yc(Yv),ix=yc(rb),Zv((rx=wl((sx=class{constructor(){Tl(this,"source",rx,this),Tl(this,"sourceInfo",ox,this),Tl(this,"propertyPath",ax,this),Tl(this,"target",lx,this),Tl(this,"targetInfo",cx,this)}}).prototype,"source",[Wl,Qv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ox=wl(sx.prototype,"sourceInfo",[Wl,tx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ax=wl(sx.prototype,"propertyPath",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),lx=wl(sx.prototype,"target",[Wl,ex],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),cx=wl(sx.prototype,"targetInfo",[Wl,ix],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nx=sx))||nx),ab=Vl("cc.CompPrefabInfo")((ux=wl((_x=class{constructor(){Tl(this,"fileId",ux,this)}}).prototype,"fileId",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hx=_x))||hx,lb=(mx=Vl("CCPropertyOverrideInfo"),px=yc(rb),mx((gx=wl((fx=class{constructor(){Tl(this,"targetInfo",gx,this),Tl(this,"propertyPath",yx,this),Tl(this,"value",vx,this)}isTarget(t,e){}}).prototype,"targetInfo",[Wl,px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yx=wl(fx.prototype,"propertyPath",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),vx=wl(fx.prototype,"value",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dx=fx))||dx),cb=(xx=Vl("cc.MountedChildrenInfo"),bx=yc(rb),Sx=yc([Yv]),xx((Tx=wl((Cx=class{constructor(){Tl(this,"targetInfo",Tx,this),Tl(this,"nodes",wx,this)}isTarget(t){}}).prototype,"targetInfo",[Wl,bx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wx=wl(Cx.prototype,"nodes",[Wl,Sx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ax=Cx))||Ax),hb=(Ex=Vl("cc.MountedComponentsInfo"),Px=yc(rb),Dx=yc([Rh]),Ex((Mx=wl((Rx=class{constructor(){Tl(this,"targetInfo",Mx,this),Tl(this,"components",Ox,this)}isTarget(t){}}).prototype,"targetInfo",[Wl,Px],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ox=wl(Rx.prototype,"components",[Wl,Dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ix=Rx))||Ix),_b=(Bx=Vl("cc.PrefabInstance"),Nx=yc(Yv),Lx=yc([cb]),Fx=yc([hb]),zx=yc([lb]),Vx=yc([rb]),Bx((kx=wl((Gx=class{constructor(){Tl(this,"fileId",kx,this),Tl(this,"prefabRootNode",Hx,this),Tl(this,"mountedChildren",jx,this),Tl(this,"mountedComponents",Wx,this),Tl(this,"propertyOverrides",qx,this),Tl(this,"removedComponents",Xx,this),this.targetMap={}}findPropertyOverride(t,e){}removePropertyOverride(t,e){}}).prototype,"fileId",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hx=wl(Gx.prototype,"prefabRootNode",[Wl,Nx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),jx=wl(Gx.prototype,"mountedChildren",[Wl,Lx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wx=wl(Gx.prototype,"mountedComponents",[Wl,Fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qx=wl(Gx.prototype,"propertyOverrides",[Wl,zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xx=wl(Gx.prototype,"removedComponents",[Wl,Vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ux=Gx))||Ux),ub=(Yx=Vl("cc.PrefabInfo"),Kx=yc(Yv),$x=yc(_b),Jx=yc([ob]),Yx((tb=wl((Qx=class{constructor(){Tl(this,"root",tb,this),Tl(this,"asset",eb,this),Tl(this,"fileId",ib,this),Tl(this,"instance",nb,this),Tl(this,"targetOverrides",sb,this)}}).prototype,"root",[Wl,Kx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),eb=wl(Qx.prototype,"asset",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ib=wl(Qx.prototype,"fileId",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nb=wl(Qx.prototype,"instance",[Wl,$x],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),sb=wl(Qx.prototype,"targetOverrides",[Wl,Jx],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zx=Qx))||Zx);n._PrefabInfo=ub;var mb,pb,db,fb,gb,yb,vb=Object.freeze({__proto__:null,TargetInfo:rb,TargetOverrideInfo:ob,CompPrefabInfo:ab,PropertyOverrideInfo:lb,MountedChildrenInfo:cb,MountedComponentsInfo:hb,PrefabInstance:_b,PrefabInfo:ub,createNodeWithPrefab:gv,generateTargetMap:yv,getTarget:vv,applyMountedChildren:xv,applyMountedComponents:bv,applyRemovedComponents:Sv,applyPropertyOverrides:Av,applyTargetOverrides:Cv});const xb=Nt({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2});let bb=t("Prefab",Vl("cc.Prefab")((yb=gb=class t extends _h{constructor(){super(),Tl(this,"data",db,this),Tl(this,"optimizationPolicy",fb,this),this._createFunction=void 0,this._instantiatedTimes=void 0,this._createFunction=null,this._instantiatedTimes=0}createNode(t){const e=n.instantiate(this);e.name=this.name,t(null,e)}compileCreateFunction(){this._createFunction=function(t){const e=t instanceof n._BaseNode&&t;return new zy(t,e).result}(this.data)}_doInstantiate(t){return this.data._prefab||A(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(t)}_instantiate(){let e,i=!1;return i=this.optimizationPolicy!==xb.SINGLE_INSTANCE&&(this.optimizationPolicy===xb.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold),i?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e}initDefault(t){super.initDefault(t),this.data=new Yv,this.data.name="(Missing Node)";const e=new n._PrefabInfo;e.asset=this,e.root=this.data,this.data._prefab=e}validate(){return!!this.data}},gb.OptimizationPolicy=xb,gb.OptimizationPolicyThreshold=3,db=wl((pb=yb).prototype,"data",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fb=wl(pb.prototype,"optimizationPolicy",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xb.AUTO}}),mb=pb))||mb);var Sb,Ab,Cb,Tb,wb,Eb;Ot.value(bb,"_utils",vb),n.Prefab=bb,ot(n,"cc._Prefab","Prefab"),t("PrefabLink",(Sb=Vl("cc.PrefabLink"),Ab=yc(bb),Cb=nc(),Sb((Eb=wl((wb=class extends Rh{constructor(...t){super(...t),Tl(this,"prefab",Eb,this)}}).prototype,"prefab",[Ab,Wl,Cb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tb=wb))||Tb));const Pb=new Ni;function Db(t,e,i,n){n||(n=new Ni),t.convertToUINode(e,i,n);const s=i.position;return n.add(s),n}function Ib(t,e,i){return i||(i=new Ni),t.worldToScreen(e,i),i.x/=n.view.getScaleX(),i.y/=n.view.getScaleY(),i}const Rb=t("convertUtils",{WorldNode3DToLocalNodeUI:Db,WorldNode3DToWorldNodeUI:Ib});var Mb,Ob,Bb,Nb,Lb,Fb,zb,Vb,Ub;n.pipelineUtils=Rb,Ze(n.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction(...t){const e=t[0],i=t[3]||Pb;return e.convertToUINode(t[1],t[2],i),i.add(t[2].position),t[3]||i.clone()}}]);const Gb=new Yr;Gb.endAccesses=[tr.FRAGMENT_SHADER_READ_TEXTURE];const kb=new Kr,Hb=new Zr([Gb],kb),jb={width:1,height:1,renderPassInfo:Hb};let Wb=t("RenderTexture",(Mb=Vl("cc.RenderTexture"),Ob=ac(),Bb=lc(),Nb=ac(),Lb=lc(),Mb((Vb=wl((zb=class extends lf{constructor(...t){super(...t),Tl(this,"_width",Vb,this),Tl(this,"_height",Ub,this),this._window=null}get width(){return this._width}get height(){return this._height}get window(){return this._window}initialize(t){this._name=t.name||"",this._width=t.width,this._height=t.height,this._initWindow(t)}reset(t){this.initialize(t)}destroy(){if(this._window){const t=n.director.root;null==t||t.destroyWindow(this._window),this._window=null}return super.destroy()}resize(t,e){this._width=t,this._height=e,this._window&&this._window.resize(t,e),this.emit("resize",this._window)}get _serialize(){return null}get _deserialize(){return null}getGFXTexture(){return this._window&&this._window.framebuffer.colorTextures[0]}getGFXSampler(){const t=n.director.root;return Xd.getSampler(t.device,Hd)}getSamplerHash(){return Hd}onLoaded(){this._initWindow()}_initWindow(t){const e=n.director.root;jb.title=this._name,jb.width=this._width,jb.height=this._height,jb.renderPassInfo=t&&t.passInfo?t.passInfo:Hb,this._window?(this._window.destroy(),this._window.initialize(e.device,jb)):this._window=e.createWindow(jb)}initDefault(t){super.initDefault(t),this._width=this._height=1,this._initWindow()}validate(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048}}).prototype,"_width",[Wl,Ob,Bb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ub=wl(zb.prototype,"_height",[Wl,Nb,Lb],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Fb=zb))||Fb));var qb,Xb;n.RenderTexture=Wb,Qe(lf.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),Ze(Wb.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction(){return this._window}}]);let Yb=t("BufferAsset",Vl("cc.BufferAsset")((wl((Xb=class extends _h{constructor(...t){super(...t),this._buffer=null}get _nativeAsset(){return this._buffer}set _nativeAsset(t){t instanceof ArrayBuffer?this._buffer=t:this._buffer=t.buffer}buffer(){return this._buffer}validate(){return!!this.buffer}}).prototype,"_nativeAsset",[vc],Object.getOwnPropertyDescriptor(Xb.prototype,"_nativeAsset"),Xb.prototype),qb=Xb))||qb);n.BufferAsset=Yb;const Kb={[Bs.UNORM]:"Uint",[Bs.SNORM]:"Int",[Bs.UINT]:"Uint",[Bs.INT]:"Int",[Bs.UFLOAT]:"Float",[Bs.FLOAT]:"Float",default:"Uint"};function $b(t){return`${Kb[t.type]||Kb.default}${t.size/t.count*8}`}function Jb(t,e,i=Os.R32F,n=0,s=0){const r=fo[i];s||(s=r.size);const o=`set${$b(r)}`,a=r.size/r.count,l=Math.floor(e.length/r.count),c=yn.isLittleEndian;for(let i=0;i<l;++i){const l=n+s*i;for(let n=0;n<r.count;++n){const s=l+a*n;t[o](s,e[r.count*i+n],c)}}}function Zb(t,e,i=Os.R32F,n=0,s=t.byteLength-n,r=0,o){o||(o=new DataView(t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength)));const a=fo[i];r||(r=a.size);const l=`set${$b(a)}`,c=`get${$b(a)}`,h=a.size/a.count,_=Math.floor(s/r),u=yn.isLittleEndian;for(let i=0;i<_;++i){const s=n+r*i;for(let i=0;i<a.count;++i){const n=s+h*i,r=t[c](n,u);o[l](n,e(r,i,t),u)}}return o}class Qb{_init(){}constructor(t,e,i,n=null,s=null){this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=e,this._vertexBuffers=t,this._indexBuffer=n,this._indirectBuffer=s,this._primitiveMode=i,this._iaInfo=new Xr(e,t,n,s),this._init()}get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}get indirectBuffer(){return this._indirectBuffer}get primitiveMode(){return this._primitiveMode}get geometricInfo(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ni.ZERO,max:Ni.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:Ni.ZERO,max:Ni.ZERO}};const{mesh:t}=this,e=this.subMeshIdx,i=t.readAttribute(e,pr.ATTR_POSITION),n=t.readIndices(e),s=new Ni,r=new Ni,o=this.attributes.find((t=>t.name===pr.ATTR_POSITION));if(o){const t=fo[o.format].count;2===t?(s.set(i[0],i[1],0),r.set(i[0],i[1],0)):(s.set(i[0],i[1],i[2]),r.set(i[0],i[1],i[2]));for(let e=0;e<i.length;e+=t)2===t?(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y):(s.x=i[e]>s.x?i[e]:s.x,s.y=i[e+1]>s.y?i[e+1]:s.y,s.z=i[e+2]>s.z?i[e+2]:s.z,r.x=i[e]<r.x?i[e]:r.x,r.y=i[e+1]<r.y?i[e+1]:r.y,r.z=i[e+2]<r.z?i[e+2]:r.z)}return this._geometricInfo={positions:i,indices:n,boundingBox:{max:s,min:r}},this._geometricInfo}get flatBuffers(){return this._flatBuffers}genFlatBuffers(){if(this._flatBuffers.length||!this.mesh||void 0===this.subMeshIdx)return;const{mesh:t}=this;let e=0;const i=t.struct.primitives[this.subMeshIdx];i.indexView&&(e=i.indexView.count);for(let n=0;n<i.vertexBundelIndices.length;n++){const s=i.vertexBundelIndices[n],r=t.struct.vertexBundles[s],o=i.indexView?i.indexView.count:r.view.count,a=r.view.stride,l=a*o,c=new Uint8Array(t.data.buffer,r.view.offset,r.view.length),h=new Uint8Array(i.indexView?l:r.view.length);if(!i.indexView){h.set(t.data.subarray(r.view.offset,r.view.offset+r.view.length)),this._flatBuffers.push({stride:a,count:o,buffer:h});continue}const _=t.readIndices(this.subMeshIdx);for(let t=0;t<e;++t){const e=t*a,i=_[t]*a;for(let t=0;t<a;++t)h[e+t]=c[i+t]}this._flatBuffers.push({stride:a,count:o,buffer:h})}}get jointMappedBuffers(){if(this._jointMappedBuffers)return this._jointMappedBuffers;const t=this._jointMappedBuffers=[],e=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;const{struct:i}=this.mesh,s=i.primitives[this.subMeshIdx];if(!i.jointMaps||void 0===s.jointMapIndex||!i.jointMaps[s.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;let r,o;const{device:a}=n.director.root;for(let n=0;n<s.vertexBundelIndices.length;n++){const l=i.vertexBundles[s.vertexBundelIndices[n]];o=0,r=Os.UNKNOWN;for(let t=0;t<l.attributes.length;t++){const e=l.attributes[t];if(e.name===pr.ATTR_JOINTS){r=e.format;break}o+=fo[e.format].size}if(r){const c=new Uint8Array(this.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(c.slice().buffer),_=i.jointMaps[s.jointMapIndex];Zb(h,(t=>_.indexOf(t)),r,o,l.view.length,l.view.stride,h);const u=a.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.DEVICE,l.view.length,l.view.stride));u.update(h.buffer),t.push(u),e.push(n)}else t.push(this.vertexBuffers[s.vertexBundelIndices[n]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(a)),t}get iaInfo(){return this._iaInfo}destroy(){for(let t=0;t<this.vertexBuffers.length;t++)this.vertexBuffers[t].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(let t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)}enableVertexIdChannel(t){if(this._vertexIdChannel)return;const e=this.vertexBuffers.length,i=this.attributes.length,n=this._allocVertexIdBuffer(t);this._vertexBuffers.push(n),this._attributes.push(new Wr("a_vertexId",Os.R32F,!1,e)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:e,index:i}}_allocVertexIdBuffer(t){const e=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,i=new Float32Array(e);for(let t=0;t<e;++t)i[t]=t+.5;const n=t.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.DEVICE,i.byteLength,i.BYTES_PER_ELEMENT));return n.update(i),n}}t("RenderingSubMesh",Qb);const tS=new Array(16);let eS=null,iS=new tn;const nS=[ev.TOUCH_START,ev.TOUCH_MOVE,ev.TOUCH_END,ev.TOUCH_CANCEL],sS=[ev.MOUSE_DOWN,ev.MOUSE_ENTER,ev.MOUSE_MOVE,ev.MOUSE_LEAVE,ev.MOUSE_UP,ev.MOUSE_WHEEL];function rS(t,e){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(t.getUILocation(iS),!i._uiProps.uiTransformComp.isHit(iS,this)||(e.type=ev.TOUCH_START,e.touch=t,e.bubbles=!0,i.dispatchEvent(e),0)))}function oS(t,e){const i=this.owner;return!(!i||!i._uiProps.uiTransformComp||(e.type=ev.TOUCH_MOVE,e.touch=t,e.bubbles=!0,i.dispatchEvent(e),0))}function aS(t,e){const i=this.owner;i&&i._uiProps.uiTransformComp&&(t.getUILocation(iS),i._uiProps.uiTransformComp.isHit(iS,this)?e.type=ev.TOUCH_END:e.type=ev.TOUCH_CANCEL,e.touch=t,e.bubbles=!0,i.dispatchEvent(e))}function lS(t,e){const i=this.owner;i&&i._uiProps.uiTransformComp&&(e.type=ev.TOUCH_CANCEL,e.touch=t,e.bubbles=!0,i.dispatchEvent(e))}function cS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(iS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(iS,this)&&(t.type=ev.MOUSE_DOWN,t.bubbles=!0,e.dispatchEvent(t)))}function hS(t){const e=this.owner;if(e&&e._uiProps.uiTransformComp){if(iS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(iS,this))this._previousIn||(eS&&eS.eventProcessor.mouseListener&&(t.type=ev.MOUSE_LEAVE,eS.dispatchEvent(t),eS.eventProcessor.mouseListener&&(eS.eventProcessor.mouseListener._previousIn=!1)),eS=e,t.type=ev.MOUSE_ENTER,e.dispatchEvent(t),this._previousIn=!0),t.type=ev.MOUSE_MOVE,t.bubbles=!0,e.dispatchEvent(t);else{if(!this._previousIn)return;t.type=ev.MOUSE_LEAVE,e.dispatchEvent(t),this._previousIn=!1,eS=null}t.propagationStopped=!0}}function _S(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(iS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(iS,this)&&(t.type=ev.MOUSE_UP,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function uS(t){const e=this.owner;e&&e._uiProps.uiTransformComp&&(iS=t.getUILocation(),e._uiProps.uiTransformComp.isHit(iS,this)&&(t.type=ev.MOUSE_WHEEL,t.bubbles=!0,e.dispatchEvent(t),t.propagationStopped=!0))}function mS(t,e){if(e){let i=0,n=[];for(let s=t;s&&Yv.isNode(s);s=s.parent,++i){const t=s.getComponent(e);if(t){const e={index:i,comp:t};n?n.push(e):n=[e]}}return n.length>0?n:null}return null}function pS(t,e){if(!t._persistNode){if(t.eventProcessor.bubblingTargets)for(let i=0;i<e.length;++i)if(t.eventProcessor.bubblingTargets.hasEventListener(e[i]))return!0;if(t.eventProcessor.capturingTargets)for(let i=0;i<e.length;++i)if(t.eventProcessor.capturingTargets.hasEventListener(e[i]))return!0;return!1}return!0}class dS{get node(){return this._node}constructor(t){this.bubblingTargets=null,this.capturingTargets=null,this.touchListener=null,this.mouseListener=null,this._node=void 0,this._node=t}reattach(){let t;this.node.walk((e=>{t||(t=mS(e,dS._comp)),e.eventProcessor.touchListener&&(e.eventProcessor.touchListener.mask=t),e.eventProcessor.mouseListener&&(e.eventProcessor.mouseListener.mask=t)}))}destroy(){eS===this._node&&(eS=null),(this.touchListener||this.mouseListener)&&(tv.removeListeners(this._node),this.touchListener&&(this.touchListener.owner=null,this.touchListener.mask=null,this.touchListener=null),this.mouseListener&&(this.mouseListener.owner=null,this.mouseListener.mask=null,this.mouseListener=null)),this.capturingTargets&&this.capturingTargets.clear(),this.bubblingTargets&&this.bubblingTargets.clear()}on(t,e,i,n){return this._checknSetupSysEvent(t)?this._onDispatch(t,e,i,n):(this.bubblingTargets||(this.bubblingTargets=new Ge),this.bubblingTargets.on(t,e,i))}once(t,e,i,n){let s;s=this._checknSetupSysEvent(t)&&n?this.capturingTargets=this.capturingTargets||new Ge:this.bubblingTargets=this.bubblingTargets||new Ge,s.on(t,e,i,!0),s.on(t,(()=>{this.off(t,e,i)}),void 0,!0)}off(t,e,i,n){const s=-1!==nS.indexOf(t),r=!s&&-1!==sS.indexOf(t);s||r?(this._offDispatch(t,e,i,n),s?this.touchListener&&!pS(this._node,nS)&&(tv.removeListener(this.touchListener),this.touchListener=null):r&&this.mouseListener&&!pS(this._node,sS)&&(tv.removeListener(this.mouseListener),this.mouseListener=null)):this.bubblingTargets&&this.bubblingTargets.off(t,e,i)}emit(t,e,i,n,s,r){this.bubblingTargets&&this.bubblingTargets.emit(t,e,i,n,s,r)}dispatchEvent(t){!function(t,e){let i,n=0;for(e.target=t,tS.length=0,t.eventProcessor.getCapturingTargets(e.type,tS),e.eventPhase=1,n=tS.length-1;n>=0;--n)if(i=tS[n],i.eventProcessor.capturingTargets&&(e.currentTarget=i,i.eventProcessor.capturingTargets.emit(e.type,e,tS),e.propagationStopped))return void(tS.length=0);if(tS.length=0,e.eventPhase=2,e.currentTarget=t,t.eventProcessor.capturingTargets&&t.eventProcessor.capturingTargets.emit(e.type,e),!e.propagationImmediateStopped&&t.eventProcessor.bubblingTargets&&t.eventProcessor.bubblingTargets.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(t.eventProcessor.getBubblingTargets(e.type,tS),e.eventPhase=3,n=0;n<tS.length;++n)if(i=tS[n],i.eventProcessor.bubblingTargets&&(e.currentTarget=i,i.eventProcessor.bubblingTargets.emit(e.type,e),e.propagationStopped))return void(tS.length=0);tS.length=0}(this._node,t),tS.length=0}hasEventListener(t,e,i){let n=!1;return this.bubblingTargets&&(n=this.bubblingTargets.hasEventListener(t,e,i)),!n&&this.capturingTargets&&(n=this.capturingTargets.hasEventListener(t,e,i)),n}targetOff(t){this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t),this.touchListener&&!pS(this.node,nS)&&(tv.removeListener(this.touchListener),this.touchListener=null),this.mouseListener&&!pS(this.node,sS)&&(tv.removeListener(this.mouseListener),this.mouseListener=null)}getCapturingTargets(t,e){let i=this._node.parent;for(;i;)i.eventProcessor.capturingTargets&&i.eventProcessor.capturingTargets.hasEventListener(t)&&e.push(i),i=i.parent}getBubblingTargets(t,e){let i=this._node.parent;for(;i;)i.eventProcessor.bubblingTargets&&i.eventProcessor.bubblingTargets.hasEventListener(t)&&e.push(i),i=i.parent}_checknSetupSysEvent(t){let e=!1,i=!1;return-1!==nS.indexOf(t)?(this.touchListener||(this.touchListener=n.EventListener.create({event:n.EventListener.TOUCH_ONE_BY_ONE,swallowTouches:!0,owner:this._node,mask:mS(this._node,dS._comp),onTouchBegan:rS,onTouchMoved:oS,onTouchEnded:aS,onTouchCancelled:lS}),tv.addListener(this.touchListener,this._node),e=!0),i=!0):-1!==sS.indexOf(t)&&(this.mouseListener||(this.mouseListener=n.EventListener.create({event:n.EventListener.MOUSE,_previousIn:!1,owner:this._node,mask:mS(this._node,dS._comp),onMouseDown:cS,onMouseMove:hS,onMouseUp:_S,onMouseScroll:uS}),tv.addListener(this.mouseListener,this._node),e=!0),i=!0),e&&!this._node.activeInHierarchy&&n.director.getScheduler().schedule((()=>{this._node.activeInHierarchy||tv.pauseTarget(this._node)}),this._node,0,0,0,!1),i}_onDispatch(t,e,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,!e)return void T(6800);let s=null;return s=n?this.capturingTargets=this.capturingTargets||new Ge:this.bubblingTargets=this.bubblingTargets||new Ge,s.hasEventListener(t,e,i)||s.on(t,e,i),e}_offDispatch(t,e,i,n){if("boolean"==typeof i?(n=i,i=void 0):n=!!n,e){const s=n?this.capturingTargets:this.bubblingTargets;s&&s.off(t,e,i)}else this.capturingTargets&&this.capturingTargets.removeAll(t),this.bubblingTargets&&this.bubblingTargets.removeAll(t)}}var fS,gS,yS,vS,xS,bS,SS,AS,CS,TS,wS,ES,PS,DS,IS,RS,MS,OS,BS,NS,LS,FS,zS,VS,US,GS,kS,HS,jS,WS,qS,XS,YS,KS,$S,JS,ZS,QS,tA,eA,iA,nA,sA,rA,oA,aA,lA,cA,hA,_A,uA,mA,pA,dA,fA,gA,yA,vA,xA,bA,SA,AA,CA,TA,wA,EA,PA,DA,IA,RA,MA,OA,BA,NA,LA,FA,zA,VA,UA,GA,kA,HA,jA,WA,qA,XA,YA,KA,$A,JA,ZA,QA,tC,eC,iC,nC,sC,rC,oC,aC,lC,cC,hC,_C,uC,mC,pC,dC,fC;dS._comp=null,n.NodeEventProcessor=dS;const gC=new Ni(0,1,0),yC=new Ni,vC=new ki;let xC=(fS=Vl("cc.AmbientInfo"),gS=yc(ae),fS((xS=wl((vS=class{constructor(){Tl(this,"_skyColor",xS,this),Tl(this,"_skyIllum",bS,this),Tl(this,"_groundAlbedo",SS,this),this._resource=null}set skyColor(t){this._skyColor.set(t),this._resource&&(this._resource.skyColor=this._skyColor)}get skyColor(){return this._skyColor}set skyIllum(t){this._skyIllum=t,this._resource&&(this._resource.skyIllum=this.skyIllum)}get skyIllum(){return this._skyIllum}set groundAlbedo(t){this._groundAlbedo.set(t),this._resource&&(this._resource.groundAlbedo=this._groundAlbedo)}get groundAlbedo(){return this._groundAlbedo}activate(t){this._resource=t,this._resource.initialize(this)}}).prototype,"_skyColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(51,128,204,1)}}),bS=wl(vS.prototype,"_skyIllum",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ss.SKY_ILLUM}}),SS=wl(vS.prototype,"_groundAlbedo",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(51,51,51,255)}}),wl(vS.prototype,"skyColor",[ic],Object.getOwnPropertyDescriptor(vS.prototype,"skyColor"),vS.prototype),wl(vS.prototype,"skyIllum",[ic,gS],Object.getOwnPropertyDescriptor(vS.prototype,"skyIllum"),vS.prototype),wl(vS.prototype,"groundAlbedo",[ic],Object.getOwnPropertyDescriptor(vS.prototype,"groundAlbedo"),vS.prototype),yS=vS))||yS);n.AmbientInfo=xC;let bC=(AS=Vl("cc.SkyboxInfo"),CS=yc(Rf),TS=yc(Rf),AS((PS=wl((ES=class{constructor(){Tl(this,"_envmap",PS,this),Tl(this,"_isRGBE",DS,this),Tl(this,"_enabled",IS,this),Tl(this,"_useIBL",RS,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=this._enabled))}get enabled(){return this._enabled}set useIBL(t){this._useIBL=t,this._resource&&(this._resource.useIBL=this._useIBL)}get useIBL(){return this._useIBL}set envmap(t){this._envmap=t,this._resource&&(this._resource.envmap=this._envmap)}get envmap(){return this._envmap}set isRGBE(t){this._isRGBE=t,this._resource&&(this._resource.isRGBE=this._isRGBE)}get isRGBE(){return this._isRGBE}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_envmap",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DS=wl(ES.prototype,"_isRGBE",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),IS=wl(ES.prototype,"_enabled",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),RS=wl(ES.prototype,"_useIBL",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wl(ES.prototype,"enabled",[ic],Object.getOwnPropertyDescriptor(ES.prototype,"enabled"),ES.prototype),wl(ES.prototype,"useIBL",[ic],Object.getOwnPropertyDescriptor(ES.prototype,"useIBL"),ES.prototype),wl(ES.prototype,"envmap",[ic,TS],Object.getOwnPropertyDescriptor(ES.prototype,"envmap"),ES.prototype),wl(ES.prototype,"isRGBE",[ic],Object.getOwnPropertyDescriptor(ES.prototype,"isRGBE"),ES.prototype),wS=ES))||wS);n.SkyboxInfo=bC;let SC=(MS=Vl("cc.FogInfo"),OS=yc(xy),BS=nc(),NS=yc(ae),LS=oc(),FS=cc(),zS=_c(),VS=nc(),US=yc(ae),GS=cc(),kS=_c(),HS=nc(),jS=yc(ae),WS=cc(),qS=_c(),XS=nc(),YS=yc(ae),KS=ac(),$S=cc(),JS=_c(),ZS=nc(),QS=yc(ae),tA=cc(),eA=_c(),iA=nc(),nA=yc(ae),sA=cc(),rA=_c(),MS((yA=gA=class{constructor(){Tl(this,"_type",lA,this),Tl(this,"_fogColor",cA,this),Tl(this,"_enabled",hA,this),Tl(this,"_fogDensity",_A,this),Tl(this,"_fogStart",uA,this),Tl(this,"_fogEnd",mA,this),Tl(this,"_fogAtten",pA,this),Tl(this,"_fogTop",dA,this),Tl(this,"_fogRange",fA,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set fogColor(t){this._fogColor.set(t),this._resource&&(this._resource.fogColor=this._fogColor)}get fogColor(){return this._fogColor}get type(){return this._type}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get fogDensity(){return this._fogDensity}set fogDensity(t){this._fogDensity=t,this._resource&&(this._resource.fogDensity=t)}get fogStart(){return this._fogStart}set fogStart(t){this._fogStart=t,this._resource&&(this._resource.fogStart=t)}get fogEnd(){return this._fogEnd}set fogEnd(t){this._fogEnd=t,this._resource&&(this._resource.fogEnd=t)}get fogAtten(){return this._fogAtten}set fogAtten(t){this._fogAtten=t,this._resource&&(this._resource.fogAtten=t)}get fogTop(){return this._fogTop}set fogTop(t){this._fogTop=t,this._resource&&(this._resource.fogTop=t)}get fogRange(){return this._fogRange}set fogRange(t){this._fogRange=t,this._resource&&(this._resource.fogRange=t)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}},gA.FogType=xy,lA=wl((aA=yA).prototype,"_type",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xy.LINEAR}}),cA=wl(aA.prototype,"_fogColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri("#C8C8C8")}}),hA=wl(aA.prototype,"_enabled",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_A=wl(aA.prototype,"_fogDensity",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),uA=wl(aA.prototype,"_fogStart",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),mA=wl(aA.prototype,"_fogEnd",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),pA=wl(aA.prototype,"_fogAtten",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),dA=wl(aA.prototype,"_fogTop",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),fA=wl(aA.prototype,"_fogRange",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),wl(aA.prototype,"enabled",[ic],Object.getOwnPropertyDescriptor(aA.prototype,"enabled"),aA.prototype),wl(aA.prototype,"fogColor",[ic],Object.getOwnPropertyDescriptor(aA.prototype,"fogColor"),aA.prototype),wl(aA.prototype,"type",[ic,OS],Object.getOwnPropertyDescriptor(aA.prototype,"type"),aA.prototype),wl(aA.prototype,"fogDensity",[BS,NS,LS,FS,hc,zS],Object.getOwnPropertyDescriptor(aA.prototype,"fogDensity"),aA.prototype),wl(aA.prototype,"fogStart",[VS,US,GS,kS],Object.getOwnPropertyDescriptor(aA.prototype,"fogStart"),aA.prototype),wl(aA.prototype,"fogEnd",[HS,jS,WS,qS],Object.getOwnPropertyDescriptor(aA.prototype,"fogEnd"),aA.prototype),wl(aA.prototype,"fogAtten",[XS,YS,KS,$S,JS],Object.getOwnPropertyDescriptor(aA.prototype,"fogAtten"),aA.prototype),wl(aA.prototype,"fogTop",[ZS,QS,tA,eA],Object.getOwnPropertyDescriptor(aA.prototype,"fogTop"),aA.prototype),wl(aA.prototype,"fogRange",[iA,nA,sA,rA],Object.getOwnPropertyDescriptor(aA.prototype,"fogRange"),aA.prototype),oA=aA))||oA),AC=(vA=Vl("cc.ShadowsInfo"),xA=yc(Zg),bA=nc(),SA=nc(),AA=yc(ae),CA=nc(),TA=oc(),wA=yc(ae),EA=nc(),PA=yc(Qg),DA=nc(),IA=yc(oe),RA=nc(),MA=yc(ae),OA=nc(),BA=yc(ae),NA=nc(),LA=yc(Jg),FA=nc(),zA=yc(le),VA=nc(),UA=yc(ae),GA=nc(),kA=yc(ae),HA=nc(),jA=yc(ae),WA=nc(),vA((YA=wl((XA=class{constructor(){Tl(this,"_type",YA,this),Tl(this,"_enabled",KA,this),Tl(this,"_normal",$A,this),Tl(this,"_distance",JA,this),Tl(this,"_shadowColor",ZA,this),Tl(this,"_autoAdapt",QA,this),Tl(this,"_pcf",tC,this),Tl(this,"_bias",eC,this),Tl(this,"_normalBias",iC,this),Tl(this,"_near",nC,this),Tl(this,"_far",sC,this),Tl(this,"_orthoSize",rC,this),Tl(this,"_maxReceived",oC,this),Tl(this,"_size",aC,this),Tl(this,"_saturation",lC,this),this._resource=null}set enabled(t){this._enabled!==t&&(this._enabled=t,this._resource&&(this._resource.enabled=t,t&&(this._resource.type=this._type)))}get enabled(){return this._enabled}set type(t){this._type=t,this._resource&&(this._resource.type=t)}get type(){return this._type}set shadowColor(t){this._shadowColor.set(t),this._resource&&(this._resource.shadowColor=t)}get shadowColor(){return this._shadowColor}set normal(t){Ni.copy(this._normal,t),this._resource&&(this._resource.normal=t)}get normal(){return this._normal}set distance(t){this._distance=t,this._resource&&(this._resource.distance=t)}get distance(){return this._distance}set saturation(t){t>1?(this._saturation=t/t,this._resource&&(this._resource.saturation=t/t)):(this._saturation=t,this._resource&&(this._resource.saturation=t))}get saturation(){return this._saturation}set pcf(t){this._pcf=t,this._resource&&(this._resource.pcf=t)}get pcf(){return this._pcf}set maxReceived(t){this._maxReceived=t,this._resource&&(this._resource.maxReceived=t)}get maxReceived(){return this._maxReceived}set bias(t){this._bias=t,this._resource&&(this._resource.bias=t)}get bias(){return this._bias}set normalBias(t){this._normalBias=t,this._resource&&(this._resource.normalBias=t)}get normalBias(){return this._normalBias}set shadowMapSize(t){this._size.set(t,t),this._resource&&(this._resource.size.set(t,t),this._resource.shadowMapDirty=!0)}get shadowMapSize(){return this._size.x}get size(){return this._size}set autoAdapt(t){this._autoAdapt=t,this._resource&&(this._resource.autoAdapt=t)}get autoAdapt(){return this._autoAdapt}set near(t){this._near=t,this._resource&&(this._resource.near=t)}get near(){return this._near}set far(t){this._far=t,this._resource&&(this._resource.far=t)}get far(){return this._far}set orthoSize(t){this._orthoSize=t,this._resource&&(this._resource.orthoSize=t)}get orthoSize(){return this._orthoSize}setPlaneFromNode(t){t.getWorldRotation(vC),this.normal=Ni.transformQuat(yC,gC,vC),t.getWorldPosition(yC),this.distance=Ni.dot(this._normal,yC)}activate(t){this._resource=t,this._resource.initialize(this),this._resource.activate()}}).prototype,"_type",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zg.Planar}}),KA=wl(XA.prototype,"_enabled",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$A=wl(XA.prototype,"_normal",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ni(0,1,0)}}),JA=wl(XA.prototype,"_distance",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ZA=wl(XA.prototype,"_shadowColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(0,0,0,76)}}),QA=wl(XA.prototype,"_autoAdapt",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tC=wl(XA.prototype,"_pcf",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qg.HARD}}),eC=wl(XA.prototype,"_bias",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),iC=wl(XA.prototype,"_normalBias",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nC=wl(XA.prototype,"_near",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sC=wl(XA.prototype,"_far",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 30}}),rC=wl(XA.prototype,"_orthoSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),oC=wl(XA.prototype,"_maxReceived",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),aC=wl(XA.prototype,"_size",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn(512,512)}}),lC=wl(XA.prototype,"_saturation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),wl(XA.prototype,"enabled",[ic],Object.getOwnPropertyDescriptor(XA.prototype,"enabled"),XA.prototype),wl(XA.prototype,"type",[ic,xA],Object.getOwnPropertyDescriptor(XA.prototype,"type"),XA.prototype),wl(XA.prototype,"shadowColor",[bA],Object.getOwnPropertyDescriptor(XA.prototype,"shadowColor"),XA.prototype),wl(XA.prototype,"normal",[SA],Object.getOwnPropertyDescriptor(XA.prototype,"normal"),XA.prototype),wl(XA.prototype,"distance",[AA,CA],Object.getOwnPropertyDescriptor(XA.prototype,"distance"),XA.prototype),wl(XA.prototype,"saturation",[ic,TA,hc,wA,EA],Object.getOwnPropertyDescriptor(XA.prototype,"saturation"),XA.prototype),wl(XA.prototype,"pcf",[PA,DA],Object.getOwnPropertyDescriptor(XA.prototype,"pcf"),XA.prototype),wl(XA.prototype,"maxReceived",[IA,RA],Object.getOwnPropertyDescriptor(XA.prototype,"maxReceived"),XA.prototype),wl(XA.prototype,"bias",[MA,OA],Object.getOwnPropertyDescriptor(XA.prototype,"bias"),XA.prototype),wl(XA.prototype,"normalBias",[BA,NA],Object.getOwnPropertyDescriptor(XA.prototype,"normalBias"),XA.prototype),wl(XA.prototype,"shadowMapSize",[LA,FA],Object.getOwnPropertyDescriptor(XA.prototype,"shadowMapSize"),XA.prototype),wl(XA.prototype,"autoAdapt",[zA,VA],Object.getOwnPropertyDescriptor(XA.prototype,"autoAdapt"),XA.prototype),wl(XA.prototype,"near",[UA,GA],Object.getOwnPropertyDescriptor(XA.prototype,"near"),XA.prototype),wl(XA.prototype,"far",[kA,HA],Object.getOwnPropertyDescriptor(XA.prototype,"far"),XA.prototype),wl(XA.prototype,"orthoSize",[jA,WA],Object.getOwnPropertyDescriptor(XA.prototype,"orthoSize"),XA.prototype),qA=XA))||qA);n.ShadowsInfo=AC;let CC=(cC=Vl("cc.SceneGlobals"),hC=yc(bC),cC((mC=wl((uC=class{constructor(){Tl(this,"ambient",mC,this),Tl(this,"shadows",pC,this),Tl(this,"_skybox",dC,this),Tl(this,"fog",fC,this)}get skybox(){return this._skybox}set skybox(t){this._skybox=t}activate(){const t=n.director.root.pipeline.pipelineSceneData;this.ambient.activate(t.ambient),this.skybox.activate(t.skybox),this.shadows.activate(t.shadows),this.fog.activate(t.fog)}}).prototype,"ambient",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xC}}),pC=wl(uC.prototype,"shadows",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new AC}}),dC=wl(uC.prototype,"_skybox",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new bC}}),fC=wl(uC.prototype,"fog",[ic,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new SC}}),wl(uC.prototype,"skybox",[ic,hC],Object.getOwnPropertyDescriptor(uC.prototype,"skybox"),uC.prototype),_C=uC))||_C);var TC;n.SceneGlobals=CC,Ze(fv.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter(){return this.children.length}}]),Ze(Yv.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.width},customSetter(t){this._uiProps.uiTransformComp.width=t}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.height},customSetter(t){this._uiProps.uiTransformComp.height=t}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorX},customSetter(t){this._uiProps.uiTransformComp.anchorX=t}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter(){return this._uiProps.uiTransformComp.anchorY},customSetter(t){this._uiProps.uiTransformComp.anchorY=t}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new tn),t.set(this._uiProps.uiTransformComp.anchorPoint),t}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction(t,e){this._uiProps.uiTransformComp.setAnchorPoint(t,e)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction(t){return t||(t=new ln),t.set(this._uiProps.uiTransformComp.contentSize),t}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction(t,e){"number"==typeof t?this._uiProps.uiTransformComp.setContentSize(t,e):this._uiProps.uiTransformComp.setContentSize(t)}}]),Qe(CC.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"}]),Qe(Yv.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),Qe(Qm,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),Ze(Qm,"Layers",[{name:"Default",newName:"DEFAULT",target:Qm.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Qm.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Qm.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Qm.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Qm.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Qm.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Qm.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Qm.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Qm,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Qm,targetName:"Layers"}]),Qe(Qm.Enum,"Layers.Enum",[{name:"ALWAYS"}]),Qe(Qm.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);const wC=Me.Flags.HideInHierarchy,EC=Me.Flags.DontSave;let PC=t("PrivateNode",Vl("cc.PrivateNode")(TC=class extends Yv{constructor(t){super(t),A(12003,this.name),this.hideFlags|=EC|wC}})||TC);var DC,IC,RC,MC;n.PrivateNode=PC;let OC=t("Scene",Vl("cc.Scene")((wl((IC=class extends fv{get renderScene(){return this._renderScene}get globals(){return this._globals}_updateScene(){this._scene=this}get native(){return this._nativeObj}_init(){this._nativeObj=new Ln}constructor(t){super(t),Tl(this,"autoReleaseAssets",RC,this),Tl(this,"_globals",MC,this),this._renderScene=null,this.dependAssets=null,this._inited=void 0,this._prefabSyncedInLiveReload=!1,this._pos=Ni.ZERO,this._rot=ki.IDENTITY,this._scale=Ni.ONE,this._mat=$i.IDENTITY,this._dirtyFlags=0,this._activeInHierarchy=!1,n.director&&n.director.root&&(this._renderScene=n.director.root.createScene({})),this._inited=!n.game||!n.game._isCloning,this._init()}destroy(){const t=Me.prototype.destroy.call(this);if(t){const t=this._children;for(let e=0;e<t.length;++e)t[e].active=!1}return this._renderScene&&n.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,t}addComponent(){throw new Error(D(3822))}_onHierarchyChanged(){}_onBatchCreated(t){super._onBatchCreated(t);const e=this._children.length;for(let i=0;i<e;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t);Cv(this)}getPosition(t){return Ni.copy(t||new Ni,Ni.ZERO)}getRotation(t){return ki.copy(t||new ki,ki.IDENTITY)}getScale(t){return Ni.copy(t||new Ni,Ni.ONE)}getWorldPosition(t){return Ni.copy(t||new Ni,Ni.ZERO)}getWorldRotation(t){return ki.copy(t||new ki,ki.IDENTITY)}getWorldScale(t){return Ni.copy(t||new Ni,Ni.ONE)}getWorldMatrix(t){return $i.copy(t||new $i,$i.IDENTITY)}getWorldRS(t){return $i.copy(t||new $i,$i.IDENTITY)}getWorldRT(t){return $i.copy(t||new $i,$i.IDENTITY)}get position(){return Ni.ZERO}get worldPosition(){return Ni.ZERO}get rotation(){return ki.IDENTITY}get worldRotation(){return ki.IDENTITY}get scale(){return Ni.ONE}get worldScale(){return Ni.ONE}get eulerAngles(){return Ni.ZERO}get worldMatrix(){return $i.IDENTITY}updateWorldTransform(){}_instantiate(){}_load(){this._inited||(this._onBatchCreated(false),this._inited=!0),this.walk(fv._setScene)}_activate(t){t=!1!==t,n.director._nodeActivator.activateNode(this,t),this._globals.activate()}}).prototype,"globals",[ic],Object.getOwnPropertyDescriptor(IC.prototype,"globals"),IC.prototype),RC=wl(IC.prototype,"autoReleaseAssets",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),MC=wl(IC.prototype,"_globals",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new CC}}),DC=IC))||DC);function BC(t,e){if(!e){const t=n.director.getScene();if(!t)return null;e=t}return e.getChildByPath(t)}n.Scene=OC,n.find=BC;const NC=Mt.fastRemoveAt,LC=Me.Flags.IsStartCalled,FC=Me.Flags.IsOnEnableCalled;function zC(t,e){const i=e.constructor._executionOrder,n=e._id;let s=0;for(let e=t.length-1,r=e>>>1;s<=e;r=s+e>>>1){const o=t[r],a=o.constructor._executionOrder;if(a>i)e=r-1;else if(a<i)s=r+1;else{const t=o._id;if(t>n)e=r-1;else{if(!(t<n))return r;s=r+1}}}return~s}function VC(t,e){const i=t.array;let n=t.i+1;for(;n<i.length;){const s=i[n];s.node._activeInHierarchy?++n:(t.removeAt(n),e&&(s._objFlags&=~e))}}Me.Flags.IsEditorOnEnableCalled;class UC{constructor(t){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;const e=G;this._zero=new e([]),this._neg=new e([]),this._pos=new e([]),this._invoke=t}}function GC(t,e){return t.constructor._executionOrder-e.constructor._executionOrder}UC.stableRemoveInactive=VC;class kC extends UC{add(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).array.push(t)}remove(t){const e=t.constructor._executionOrder;(0===e?this._zero:e<0?this._neg:this._pos).fastRemove(t)}cancelInactive(t){VC(this._zero,t),VC(this._neg,t),VC(this._pos,t)}invoke(){const t=this._neg;t.array.length>0&&(t.array.sort(GC),this._invoke(t),t.array.length=0),this._invoke(this._zero),this._zero.array.length=0;const e=this._pos;e.array.length>0&&(e.array.sort(GC),this._invoke(e),e.array.length=0)}}class HC extends UC{add(t){const e=t.constructor._executionOrder;if(0===e)this._zero.array.push(t);else{const i=e<0?this._neg.array:this._pos.array,n=zC(i,t);n<0&&i.splice(~n,0,t)}}remove(t){const e=t.constructor._executionOrder;if(0===e)this._zero.fastRemove(t);else{const i=e<0?this._neg:this._pos,n=zC(i.array,t);n>=0&&i.removeAt(n)}}invoke(t){this._neg.array.length>0&&this._invoke(this._neg,t),this._invoke(this._zero,t),this._pos.array.length>0&&this._invoke(this._pos,t)}}function jC(t,e,i){const s=`var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];${t}}`,r=e?Function("it","dt",s):Function("it",s);return function(t,e,i){return(s,r)=>{try{e(s,r)}catch(e){n._throw(e);const o=s.array;for(i&&(o[s.i]._objFlags|=i),++s.i;s.i<o.length;++s.i)try{t(o[s.i],r)}catch(t){n._throw(t),i&&(o[s.i]._objFlags|=i)}}}}(Function("c","dt",t),r,i)}const WC=jC(`c.start();c._objFlags|=${LC}`,!1,LC),qC=jC("c.update(dt)",!0),XC=jC("c.lateUpdate(dt)",!0),YC=t=>{const e=n.director._compScheduler,i=t.array;for(t.i=0;t.i<i.length;++t.i){const n=i[t.i];n._enabled&&(n.onEnable(),!n.node._activeInHierarchy||e._onEnabled(n))}};class KC{constructor(){this._deferredComps=[],this.unscheduleAll()}unscheduleAll(){this.startInvoker=new kC(WC),this.updateInvoker=new HC(qC),this.lateUpdateInvoker=new HC(XC),this._updating=!1}_onEnabled(t){n.director.getScheduler().resumeTarget(t),t._objFlags|=FC,this._updating?this._deferredComps.push(t):this._scheduleImmediate(t)}_onDisabled(t){n.director.getScheduler().pauseTarget(t),t._objFlags&=~FC;const e=this._deferredComps.indexOf(t);e>=0?NC(this._deferredComps,e):(!t.start||t._objFlags&LC||this.startInvoker.remove(t),t.update&&this.updateInvoker.remove(t),t.lateUpdate&&this.lateUpdateInvoker.remove(t))}enableComp(t,e){if(!(t._objFlags&FC)){if(t.onEnable){if(e)return void e.add(t);if(t.onEnable(),!t.node._activeInHierarchy)return}this._onEnabled(t)}}disableComp(t){t._objFlags&FC&&(t.onDisable&&t.onDisable(),this._onDisabled(t))}startPhase(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()}updatePhase(t){this.updateInvoker.invoke(t)}lateUpdatePhase(t){this.lateUpdateInvoker.invoke(t),this._updating=!1,this._startForNewComps()}_startForNewComps(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())}_scheduleImmediate(t){"function"!=typeof t.start||t._objFlags&LC||this.startInvoker.add(t),"function"==typeof t.update&&this.updateInvoker.add(t),"function"==typeof t.lateUpdate&&this.lateUpdateInvoker.add(t)}_deferredSchedule(){const t=this._deferredComps;for(let e=0,i=t.length;e<i;e++)this._scheduleImmediate(t[e]);t.length=0}}const $C=Me.Flags.IsPreloadStarted,JC=Me.Flags.IsOnLoadStarted,ZC=Me.Flags.IsOnLoadCalled,QC=Me.Flags.Deactivating;class tT extends UC{add(t){this._zero.array.push(t)}remove(t){this._zero.fastRemove(t)}cancelInactive(t){UC.stableRemoveInactive(this._zero,t)}invoke(){this._invoke(this._zero),this._zero.array.length=0}}const eT=jC("c.__preload();"),iT=jC(`c.onLoad();c._objFlags|=${ZC}`,!1,ZC),nT=new Rt(4);function sT(t,e,i){e?t._removeComponent(e):Mt.removeAt(t._components,i)}nT.get=function(){const t=this._get()||{preload:new tT(eT),onLoad:new kC(iT),onEnable:new kC(YC)};t.preload._zero.i=-1;let e=t.onLoad;return e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,e=t.onEnable,e._zero.i=-1,e._neg.i=-1,e._pos.i=-1,t};class rT{constructor(){this.resetComp=void 0,this.reset()}reset(){this._activatingStack=[]}activateNode(t,e){if(e){const e=nT.get();this._activatingStack.push(e),this._activateNodeRecursively(t,e.preload,e.onLoad,e.onEnable),e.preload.invoke(),e.onLoad.invoke(),e.onEnable.invoke(),this._activatingStack.pop(),nT.put(e)}else{this._deactivateNodeRecursively(t);const e=this._activatingStack;for(const t of e)t.preload.cancelInactive($C),t.onLoad.cancelInactive(JC),t.onEnable.cancelInactive()}t.emit("active-in-hierarchy-changed",t)}activateComp(t,e,i,s){if(Be(t,!0)&&(t._objFlags&$C||(t._objFlags|=$C,t.__preload&&(e?e.add(t):t.__preload())),t._objFlags&JC||(t._objFlags|=JC,t.onLoad?i?i.add(t):(t.onLoad(),t._objFlags|=ZC):t._objFlags|=ZC),t._enabled)){if(!t.node._activeInHierarchy)return;n.director._compScheduler.enableComp(t,s)}}destroyComp(t){n.director._compScheduler.disableComp(t),t.onDestroy&&t._objFlags&ZC&&t.onDestroy()}_activateNodeRecursively(t,e,i,s){if(t._objFlags&QC)return void T(3816,t.name);t._activeInHierarchy=!0;let r=t._components.length;for(let o=0;o<r;++o){const a=t._components[o];a instanceof n.Component?this.activateComp(a,e,i,s):(sT(t,a,o),--o,--r)}t._childArrivalOrder=t._children.length;for(let n=0,r=t._children.length;n<r;++n){const r=t._children[n];r._active&&this._activateNodeRecursively(r,e,i,s)}t._onPostActivated(!0)}_deactivateNodeRecursively(t){t._objFlags|=QC,t._activeInHierarchy=!1;const e=t._components.length;for(let i=0;i<e;++i){const e=t._components[i];if(e._enabled&&(n.director._compScheduler.disableComp(e),t._activeInHierarchy))return void(t._objFlags&=~QC)}for(let e=0,i=t._children.length;e<i;++e){const i=t._children[e];if(i._activeInHierarchy&&(this._deactivateNodeRecursively(i),t._activeInHierarchy))return void(t._objFlags&=~QC)}t._onPostActivated(!1),t._objFlags&=~QC}}var oT,aT,lT;t("NodeActivator",rT);let cT=t("SceneAsset",Vl("cc.SceneAsset")((lT=wl((aT=class extends _h{constructor(...t){super(...t),Tl(this,"scene",lT,this)}initDefault(t){super.initDefault(t),this.scene=new OC("New Scene")}validate(){return!!this.scene}}).prototype,"scene",[ic,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oT=aT))||oT);var hT,_T,uT;n.SceneAsset=cT;let mT=t("TextAsset",Vl("cc.TextAsset")((uT=wl((_T=class extends _h{constructor(...t){super(...t),Tl(this,"text",uT,this)}toString(){return this.text}}).prototype,"text",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),hT=_T))||hT);var pT,dT,fT;n.TextAsset=mT;let gT=t("JsonAsset",Vl("cc.JsonAsset")((fT=wl((dT=class extends _h{constructor(...t){super(...t),Tl(this,"json",fT,this)}}).prototype,"json",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pT=dT))||pT);n.JsonAsset=gT;class yT extends Ay{get deferredLightingMaterial(){return this._deferredLightingMaterial}set deferredLightingMaterial(t){this._deferredLightingMaterial!==t&&t&&(this._deferredLightingMaterial=t,this.updateDeferredPassInfo())}get deferredPostMaterial(){return this._deferredPostMaterial}set deferredPostMaterial(t){this._deferredPostMaterial!==t&&t&&(this._deferredPostMaterial=t,this.updateDeferredPassInfo())}onGlobalPipelineStateChanged(){this.updateDeferredPassInfo()}initPipelinePassInfo(){const t=new $g;t._uuid="builtin-deferred-material",t.initialize({effectName:"deferred-lighting"});for(let e=0;e<t.passes.length;++e)t.passes[e].tryCompile();this._deferredLightingMaterial=t;const e=new $g;e._uuid="builtin-post-process-material",e.initialize({effectName:"post-process"});for(let t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredPostMaterial=e,this.updateDeferredPassInfo()}activate(t,e){return super.activate(t,e),this.initPipelinePassInfo(),!0}updateDeferredPassInfo(){this.updateDeferredLightPass(),this.updateDeferredPostPass()}updateDeferredLightPass(){if(!this._deferredLightingMaterial)return;const t=this._deferredLightingMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently(),this._nativeObj.deferredLightPassShader=t.getShaderVariant(),this._nativeObj.deferredLightPass=t.native}updateDeferredPostPass(){if(!this.deferredPostMaterial)return;const t=this.deferredPostMaterial.passes[0];t.beginChangeStatesSilently(),t.tryCompile(),t.endChangeStatesSilently(),this._nativeObj.deferredPostPassShader=t.getShaderVariant(),this._nativeObj.deferredPostPass=t.native}}nr.getPhaseID=og;const vT=t("RenderPipeline",nr.RenderPipeline),xT=(t("RenderFlow",nr.RenderFlow),t("RenderStage",nr.RenderStage),t("InstancedBuffer",nr.InstancedBuffer),t("PipelineStateManager",nr.PipelineStateManager));nr.InstancedBuffer.get;let bT=nr.PipelineStateManager.getOrCreatePipelineState;function ST(){const t=new AT;return t.init(),t}nr.PipelineStateManager.getOrCreatePipelineState=function(t,e,i,n,s){return bT.call(t,e.native,i,n,s)};class AT extends nr.ForwardPipeline{constructor(){super(),this.pipelineSceneData=new Ay,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native);for(let t=0;t<this._flows.length;t++)this._flows[t].init();const t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(t){let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].native);super.render(e)}destroy(){this.pipelineSceneData.destroy(),super.destroy()}}t("ForwardPipeline",AT),dt(AT.prototype,_h.prototype);const CT=AT.prototype.onLoaded;AT.prototype.onLoaded=function(){CT&&CT.call(this),this.init()};class TT extends nr.ForwardFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ForwardFlow",TT);class wT extends nr.ShadowFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(){for(let t=0;t<this._stages.length;t++)this._stages[t].init();const t=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(t)}}t("ShadowFlow",wT);class ET extends nr.ForwardStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(){const t=[];for(let e=0;e<this.renderQueues.length;e++)t.push(this.renderQueues[e].init());const e=new nr.RenderStageInfo(this._name,this._priority,this._tag,t);this.initialize(e)}}t("ForwardStage",ET);class PT extends nr.ShadowStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0}init(){const t=new nr.RenderStageInfo(this._name,this._priority,this._tag,[]);this.initialize(t)}}t("ShadowStage",PT);class DT{constructor(){this.isTransparent=!1,this.sortMode=0,this.stages=[],this.isTransparent=!1,this.sortMode=0,this.stages=[]}init(){return new nr.RenderQueueDesc(this.isTransparent,this.sortMode,this.stages)}}t("RenderQueueDesc",DT);class IT extends nr.DeferredPipeline{constructor(){super(),this.pipelineSceneData=new yT,this._tag=0,this._flows=[],this.renderTextures=[],this.materials=[]}init(){this.setPipelineSharedSceneData(this.pipelineSceneData.native);for(let t=0;t<this._flows.length;t++)this._flows[t].init(this);let t=new nr.RenderPipelineInfo(this._tag,this._flows);this.initialize(t)}activate(){return super.activate()&&this.pipelineSceneData.activate(n.director.root.device,this)}render(t){let e=[];for(let i=0,n=t.length;i<n;++i)e.push(t[i].native);super.render(e)}destroy(){this.fog.destroy(),this.ambient.destroy(),this.skybox.destroy(),this.shadows.destroy(),this.pipelineSceneData.destroy(),super.destroy()}}t("DeferredPipeline",IT),dt(IT.prototype,_h.prototype);const RT=IT.prototype.onLoaded;IT.prototype.onLoaded=function(){RT&&RT.call(this),this.init()};class MT extends nr.GbufferFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(t){for(let e=0;e<this._stages.length;e++)this._stages[e].init(t);let e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}t("GbufferFlow",MT);class OT extends nr.GbufferStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[]}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("GbufferStage",OT);class BT extends nr.LightingFlow{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this._stages=[]}init(t){for(let e=0;e<this._stages.length;e++)this._stages[e].init(t);let e=new nr.RenderFlowInfo(this._name,this._priority,this._tag,this._stages);this.initialize(e)}}class NT extends nr.LightingStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._deferredMaterial=null}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("LightingStage",NT);class LT extends nr.PostprocessStage{constructor(){super(),this._name=0,this._priority=0,this._tag=0,this.renderQueues=[],this._postProcessMaterial=null}init(t){const e=[];for(let t=0;t<this.renderQueues.length;t++)e.push(this.renderQueues[t].init());t.pipelineSceneData.deferredPostMaterial=this._postProcessMaterial;let i=new nr.RenderStageInfo(this._name,this._priority,this._tag,e);this.initialize(i)}}t("PostprocessStage",LT),Tt("DeferredPipeline",IT),Tt("GbufferFlow",MT),Tt("GbufferStage",OT),Tt("LightingFlow",BT),Tt("LightingStage",NT),Tt("PostprocessStage",LT),Tt("ForwardPipeline",AT),Tt("ForwardFlow",TT),Tt("ShadowFlow",wT),Tt("ForwardStage",ET),Tt("ShadowStage",PT),Tt("RenderQueueDesc",DT),Ze(Gy,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]);class FT{constructor(){this.support=void 0,this._intervalInSeconds=.2,this._intervalId=void 0,this._isEnabled=!1,this._eventTarget=new He,this._didAccelerateFunc=void 0;const t=qe.isMobile;this.support=t,this._didAccelerateFunc=this._didAccelerate.bind(this)}_didAccelerate(){const t=jsb.device.getDeviceMotionValue();let e=.1*t[3],i=.1*t[4];const n=.1*t[5],s=dn.orientation,r=e;s===mn.LANDSCAPE_RIGHT?(e=-i,i=r):s===mn.LANDSCAPE_LEFT?(e=i,i=-r):s===mn.PORTRAIT_UPSIDE_DOWN&&(e=-e,i=-i),qe.os!==L.ANDROID&&qe.os!==L.OHOS||(e=-e,i=-i);const o={type:Gy.DEVICEMOTION,x:e,y:i,z:n,timestamp:performance.now()};this._eventTarget.emit(Gy.DEVICEMOTION,o)}start(){this._intervalId&&clearInterval(this._intervalId),this._intervalId=setInterval(this._didAccelerateFunc,1e3*this._intervalInSeconds),jsb.device.setAccelerometerInterval(this._intervalInSeconds),jsb.device.setAccelerometerEnabled(!0),this._isEnabled=!0}stop(){this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),jsb.device.setAccelerometerEnabled(!1),this._isEnabled=!1}setInterval(t){this._intervalInSeconds=t/1e3,jsb.device.setAccelerometerInterval(this._intervalInSeconds),this._isEnabled&&(jsb.device.setAccelerometerEnabled(!1),jsb.device.setAccelerometerEnabled(!0))}onChange(t){this._eventTarget.on(Gy.DEVICEMOTION,t)}}class zT{constructor(){this.support=void 0,this.support=!0}show(){throw new Error("Method not implemented.")}hide(){throw new Error("Method not implemented.")}onChange(){throw new Error("Method not implemented.")}onComplete(){throw new Error("Method not implemented.")}offChange(){throw new Error("Method not implemented.")}offComplete(){throw new Error("Method not implemented.")}}let VT;!function(t){t[t.NONE=0]="NONE",t[t.BACKSPACE=8]="BACKSPACE",t[t.TAB=9]="TAB",t[t.ENTER=13]="ENTER",t[t.SHIFT_LEFT=16]="SHIFT_LEFT",t[t.CTRL_LEFT=17]="CTRL_LEFT",t[t.ALT_LEFT=18]="ALT_LEFT",t[t.PAUSE=19]="PAUSE",t[t.CAPS_LOCK=20]="CAPS_LOCK",t[t.ESCAPE=27]="ESCAPE",t[t.SPACE=32]="SPACE",t[t.PAGE_UP=33]="PAGE_UP",t[t.PAGE_DOWN=34]="PAGE_DOWN",t[t.END=35]="END",t[t.HOME=36]="HOME",t[t.ARROW_LEFT=37]="ARROW_LEFT",t[t.ARROW_UP=38]="ARROW_UP",t[t.ARROW_RIGHT=39]="ARROW_RIGHT",t[t.ARROW_DOWN=40]="ARROW_DOWN",t[t.INSERT=45]="INSERT",t[t.DELETE=46]="DELETE",t[t.DIGIT_0=48]="DIGIT_0",t[t.DIGIT_1=49]="DIGIT_1",t[t.DIGIT_2=50]="DIGIT_2",t[t.DIGIT_3=51]="DIGIT_3",t[t.DIGIT_4=52]="DIGIT_4",t[t.DIGIT_5=53]="DIGIT_5",t[t.DIGIT_6=54]="DIGIT_6",t[t.DIGIT_7=55]="DIGIT_7",t[t.DIGIT_8=56]="DIGIT_8",t[t.DIGIT_9=57]="DIGIT_9",t[t.KEY_A=65]="KEY_A",t[t.KEY_B=66]="KEY_B",t[t.KEY_C=67]="KEY_C",t[t.KEY_D=68]="KEY_D",t[t.KEY_E=69]="KEY_E",t[t.KEY_F=70]="KEY_F",t[t.KEY_G=71]="KEY_G",t[t.KEY_H=72]="KEY_H",t[t.KEY_I=73]="KEY_I",t[t.KEY_J=74]="KEY_J",t[t.KEY_K=75]="KEY_K",t[t.KEY_L=76]="KEY_L",t[t.KEY_M=77]="KEY_M",t[t.KEY_N=78]="KEY_N",t[t.KEY_O=79]="KEY_O",t[t.KEY_P=80]="KEY_P",t[t.KEY_Q=81]="KEY_Q",t[t.KEY_R=82]="KEY_R",t[t.KEY_S=83]="KEY_S",t[t.KEY_T=84]="KEY_T",t[t.KEY_U=85]="KEY_U",t[t.KEY_V=86]="KEY_V",t[t.KEY_W=87]="KEY_W",t[t.KEY_X=88]="KEY_X",t[t.KEY_Y=89]="KEY_Y",t[t.KEY_Z=90]="KEY_Z",t[t.NUM_0=96]="NUM_0",t[t.NUM_1=97]="NUM_1",t[t.NUM_2=98]="NUM_2",t[t.NUM_3=99]="NUM_3",t[t.NUM_4=100]="NUM_4",t[t.NUM_5=101]="NUM_5",t[t.NUM_6=102]="NUM_6",t[t.NUM_7=103]="NUM_7",t[t.NUM_8=104]="NUM_8",t[t.NUM_9=105]="NUM_9",t[t.NUM_MULTIPLY=106]="NUM_MULTIPLY",t[t.NUM_PLUS=107]="NUM_PLUS",t[t.NUM_SUBTRACT=109]="NUM_SUBTRACT",t[t.NUM_DECIMAL=110]="NUM_DECIMAL",t[t.NUM_DIVIDE=111]="NUM_DIVIDE",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NUM_LOCK=144]="NUM_LOCK",t[t.SCROLL_LOCK=145]="SCROLL_LOCK",t[t.SEMICOLON=186]="SEMICOLON",t[t.EQUAL=187]="EQUAL",t[t.COMMA=188]="COMMA",t[t.DASH=189]="DASH",t[t.PERIOD=190]="PERIOD",t[t.SLASH=191]="SLASH",t[t.BACK_QUOTE=192]="BACK_QUOTE",t[t.BRACKET_LEFT=219]="BRACKET_LEFT",t[t.BACKSLASH=220]="BACKSLASH",t[t.BRACKET_RIGHT=221]="BRACKET_RIGHT",t[t.QUOTE=222]="QUOTE",t[t.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",t[t.CTRL_RIGHT=2001]="CTRL_RIGHT",t[t.ALT_RIGHT=2002]="ALT_RIGHT",t[t.NUM_ENTER=2003]="NUM_ENTER"}(VT||(VT=t("KeyCode",{})));const UT={12:VT.NUM_LOCK,10048:VT.NUM_0,10049:VT.NUM_1,10050:VT.NUM_2,10051:VT.NUM_3,10052:VT.NUM_4,10053:VT.NUM_5,10054:VT.NUM_6,10055:VT.NUM_7,10056:VT.NUM_8,10057:VT.NUM_9,20013:VT.NUM_ENTER,20016:VT.SHIFT_RIGHT,20017:VT.CTRL_RIGHT,20018:VT.ALT_RIGHT};function GT(t){return UT[t]||t}class kT{constructor(){this.support=void 0,this._eventTarget=new He,this._keyStateMap={},this.support=!qe.isMobile,this._registerEvent()}_registerEvent(){jsb.onKeyDown=t=>{const e=GT(t.keyCode),i=this._getInputEvent(t,Gy.KEY_DOWN);this._eventTarget.emit(Gy.KEY_DOWN,i),this._keyStateMap[e]=!0},jsb.onKeyUp=t=>{const e=GT(t.keyCode),i={type:Gy.KEY_UP,code:e,timestamp:performance.now()};this._keyStateMap[e]=!1,this._eventTarget.emit(Gy.KEY_UP,i)}}_getInputEvent(t,e){return{type:e,code:GT(t.keyCode),timestamp:performance.now()}}onDown(t){this._eventTarget.on("keypress",t)}onPressing(t){this._eventTarget.on(Gy.KEY_DOWN,t)}onUp(t){this._eventTarget.on(Gy.KEY_UP,t)}}class HT{constructor(){this.support=void 0,this._eventTarget=new He,this._preMousePos=new tn,this.support=!qe.isMobile,this._registerEvent()}_getLocation(t){return new tn(t.x,t.y)}_registerEvent(){jsb.onMouseDown=this._createCallback(Gy.MOUSE_DOWN),jsb.onMouseMove=this._createCallback(Gy.MOUSE_MOVE),jsb.onMouseUp=this._createCallback(Gy.MOUSE_UP),jsb.onMouseWheel=t=>{const e=this._getLocation(t),i=dn.windowSize,n={type:Gy.MOUSE_WHEEL,x:e.x,y:i.height-e.y,button:t.button,deltaX:120*t.wheelDeltaX,deltaY:120*t.wheelDeltaY,timestamp:performance.now()};this._eventTarget.emit(Gy.MOUSE_WHEEL,n)}}_createCallback(t){return e=>{const i=this._getLocation(e),n=dn.windowSize,s=i.x,r=n.height-i.y,o={type:t,x:s,y:r,movementX:s-this._preMousePos.x,movementY:this._preMousePos.y-r,button:e.button,timestamp:performance.now()};this._preMousePos.set(o.x,o.y),this._eventTarget.emit(t,o)}}onDown(t){this._eventTarget.on(Gy.MOUSE_DOWN,t)}onMove(t){this._eventTarget.on(Gy.MOUSE_MOVE,t)}onUp(t){this._eventTarget.on(Gy.MOUSE_UP,t)}onWheel(t){this._eventTarget.on(Gy.MOUSE_WHEEL,t)}}class jT{constructor(){this.support=void 0,this._eventTarget=new He,this.support=!0,this._registerEvent()}_registerEvent(){jsb.onTouchStart=this._createCallback(Gy.TOUCH_START),jsb.onTouchMove=this._createCallback(Gy.TOUCH_MOVE),jsb.onTouchEnd=this._createCallback(Gy.TOUCH_END),jsb.onTouchCancel=this._createCallback(Gy.TOUCH_CANCEL)}_createCallback(t){return e=>{const i=[],n=e.length,s=dn.windowSize;for(let t=0;t<n;++t){const n=e[t],r=this._getLocation(n),o=r.x,a=s.height-r.y,l={identifier:n.identifier,x:o,y:a,force:n.force};i.push(l)}const r={type:t,changedTouches:i,timestamp:performance.now()};this._eventTarget.emit(t,r)}}_getLocation(t){return new tn(t.clientX,t.clientY)}onStart(t){this._eventTarget.on(Gy.TOUCH_START,t)}onMove(t){this._eventTarget.on(Gy.TOUCH_MOVE,t)}onEnd(t){this._eventTarget.on(Gy.TOUCH_END,t)}onCancel(t){this._eventTarget.on(Gy.TOUCH_CANCEL,t)}}const WT=new class{constructor(){this._touch=new jT,this._mouse=new HT,this._keyboard=new kT,this._accelerometer=new FT,this._inputBox=new zT,this._touchEvents=[],this._mouseEvents=[],this._keyboardEvents=[],this._accelerometerEvents=[],this._registerEvent()}_registerEvent(){if(this._touch.support){const t=this._touchEvents;this._touch.onStart((e=>{t.push(e)})),this._touch.onMove((e=>{t.push(e)})),this._touch.onEnd((e=>{t.push(e)})),this._touch.onCancel((e=>{t.push(e)}))}if(this._mouse.support){const t=this._mouseEvents;this._mouse.onDown((e=>{t.push(e)})),this._mouse.onMove((e=>{t.push(e)})),this._mouse.onUp((e=>{t.push(e)})),this._mouse.onWheel((e=>{t.push(e)}))}if(this._keyboard.support){const t=this._keyboardEvents;this._keyboard.onPressing((e=>{t.push(e)})),this._keyboard.onUp((e=>{t.push(e)}))}if(this._accelerometer.support){const t=this._accelerometerEvents;this._accelerometer.onChange((e=>{t.push(e)}))}}startAccelerometer(){this._accelerometer.start()}stopAccelerometer(){this._accelerometer.stop()}setAccelerometerInterval(t){this._accelerometer.setInterval(t)}pollTouchEvents(){const t=Ot.array.copy(this._touchEvents);return this._touchEvents.length=0,t}pollMouseEvents(){const t=Ot.array.copy(this._mouseEvents);return this._mouseEvents.length=0,t}pollKeyboardEvents(){const t=Ot.array.copy(this._keyboardEvents);return this._keyboardEvents.length=0,t}pollAccelerometerEvents(){const t=Ot.array.copy(this._accelerometerEvents);return this._accelerometerEvents.length=0,t}},qT=new tn;class XT extends nh{get eventType(){return this._eventType}constructor(t,e,i){super(t,e),this.movementX=0,this.movementY=0,this._eventType=void 0,this._button=XT.BUTTON_MISSING,this._x=0,this._y=0,this._prevX=0,this._prevY=0,this._scrollX=0,this._scrollY=0,this._eventType=t,i&&(this._prevX=i.x,this._prevY=i.y)}setScrollData(t,e){this._scrollX=t,this._scrollY=e}getScrollX(){return this._scrollX}getScrollY(){return this._scrollY}setLocation(t,e){this._x=t,this._y=e}getLocation(t){return t||(t=new tn),tn.set(t,this._x,this._y),t}getLocationInView(t){return t||(t=new tn),tn.set(t,this._x,n.view._designResolutionSize.height-this._y),t}getUILocation(t){return t||(t=new tn),tn.set(t,this._x,this._y),n.view._convertPointWithScale(t),t}getPreviousLocation(t){return t||(t=new tn),tn.set(t,this._prevX,this._prevY),t}getUIPreviousLocation(t){return t||(t=new tn),tn.set(t,this._prevX,this._prevY),n.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new tn),tn.set(t,this._x-this._prevX,this._y-this._prevY),t}getDeltaX(){return this._x-this._prevX}getDeltaY(){return this._y-this._prevY}getUIDelta(t){return t||(t=new tn),tn.set(t,(this._x-this._prevX)/n.view.getScaleX(),(this._y-this._prevY)/n.view.getScaleY()),t}getUIDeltaX(){return(this._x-this._prevX)/n.view.getScaleX()}getUIDeltaY(){return(this._y-this._prevY)/n.view.getScaleY()}setButton(t){this._button=t}getButton(){return this._button}getLocationX(){return this._x}getLocationY(){return this._y}getUILocationX(){const t=n.view.getViewportRect();return(this._x-t.x)/n.view.getScaleX()}getUILocationY(){const t=n.view.getViewportRect();return(this._y-t.y)/n.view.getScaleY()}}t("EventMouse",XT),XT.BUTTON_MISSING=-1,XT.BUTTON_LEFT=0,XT.BUTTON_RIGHT=2,XT.BUTTON_MIDDLE=1,XT.BUTTON_4=3,XT.BUTTON_5=4,XT.BUTTON_6=5,XT.BUTTON_7=6,XT.BUTTON_8=7;class YT extends nh{constructor(t,e,i,n=[]){super(i,e),this.touch=null,this.simulate=!1,this._eventCode=void 0,this._touches=void 0,this._allTouches=void 0,this._eventCode=i,this._touches=t||[],this._allTouches=n}getEventCode(){return this._eventCode}getTouches(){return this._touches}getAllTouches(){return this._allTouches}setLocation(t,e){this.touch&&this.touch.setTouchInfo(this.touch.getID(),t,e)}getLocation(t){return this.touch?this.touch.getLocation(t):new tn}getUILocation(t){return this.touch?this.touch.getUILocation(t):new tn}getLocationInView(t){return this.touch?this.touch.getLocationInView(t):new tn}getPreviousLocation(t){return this.touch?this.touch.getPreviousLocation(t):new tn}getStartLocation(t){return this.touch?this.touch.getStartLocation(t):new tn}getUIStartLocation(t){return this.touch?this.touch.getUIStartLocation(t):new tn}getID(){return this.touch?this.touch.getID():null}getDelta(t){return this.touch?this.touch.getDelta(t):new tn}getUIDelta(t){return this.touch?this.touch.getUIDelta(t):new tn}getDeltaX(){return this.touch?this.touch.getDelta(qT).x:0}getDeltaY(){return this.touch?this.touch.getDelta(qT).y:0}getLocationX(){return this.touch?this.touch.getLocationX():0}getLocationY(){return this.touch?this.touch.getLocationY():0}}t("EventTouch",YT),YT.MAX_TOUCHES=5;class KT extends nh{constructor(t,e){super(Gy.DEVICEMOTION,e),this.acc=void 0,this.acc=t}}t("EventAcceleration",KT);class $T extends nh{get isPressed(){return this._isPressed}constructor(t,e,i){"boolean"==typeof e&&(e=e?Gy.KEY_DOWN:Gy.KEY_UP),super(e,i),this.keyCode=void 0,this.rawEvent=void 0,this._isPressed=void 0,this._isPressed=e!==Gy.KEY_UP,"number"==typeof t?this.keyCode=t:(this.keyCode=t.keyCode,this.rawEvent=t)}}t("EventKeyboard",$T),nh.EventMouse=XT,nh.EventTouch=YT,nh.EventAcceleration=KT,nh.EventKeyboard=$T;const JT=new tn;class ZT{get lastModified(){return this._lastModified}constructor(t,e,i=0){this._point=new tn,this._prevPoint=new tn,this._lastModified=0,this._id=0,this._startPoint=new tn,this._startPointCaptured=!1,this.setTouchInfo(i,t,e)}getLocation(t){return t||(t=new tn),t.set(this._point.x,this._point.y),t}getLocationX(){return this._point.x}getLocationY(){return this._point.y}getUILocation(t){return t||(t=new tn),t.set(this._point.x,this._point.y),n.view._convertPointWithScale(t),t}getUILocationX(){const t=n.view.getViewportRect();return(this._point.x-t.x)/n.view.getScaleX()}getUILocationY(){const t=n.view.getViewportRect();return(this._point.y-t.y)/n.view.getScaleY()}getPreviousLocation(t){return t||(t=new tn),t.set(this._prevPoint.x,this._prevPoint.y),t}getUIPreviousLocation(t){return t||(t=new tn),t.set(this._prevPoint.x,this._prevPoint.y),n.view._convertPointWithScale(t),t}getStartLocation(t){return t||(t=new tn),t.set(this._startPoint.x,this._startPoint.y),t}getUIStartLocation(t){return t||(t=new tn),t.set(this._startPoint.x,this._startPoint.y),n.view._convertPointWithScale(t),t}getDelta(t){return t||(t=new tn),t.set(this._point),t.subtract(this._prevPoint),t}getUIDelta(t){return t||(t=new tn),JT.set(this._point),JT.subtract(this._prevPoint),t.set(n.view.getScaleX(),n.view.getScaleY()),tn.divide(t,JT,t),t}getLocationInView(t){return t||(t=new tn),t.set(this._point.x,n.view._designResolutionSize.height-this._point.y),t}getPreviousLocationInView(t){return t||(t=new tn),t.set(this._prevPoint.x,n.view._designResolutionSize.height-this._prevPoint.y),t}getStartLocationInView(t){return t||(t=new tn),t.set(this._startPoint.x,n.view._designResolutionSize.height-this._startPoint.y),t}getID(){return this._id}setTouchInfo(t=0,e,i){this._prevPoint=this._point,this._point=new tn(e||0,i||0),this._id=t,this._startPointCaptured||(this._startPoint=new tn(this._point),this._startPointCaptured=!0)}setPoint(t,e){"object"==typeof t?(this._point.x=t.x,this._point.y=t.y):(this._point.x=t||0,this._point.y=e||0),this._lastModified=n.game.frameStartTime}setPrevPoint(t,e){this._prevPoint="object"==typeof t?new tn(t.x,t.y):new tn(t||0,e||0),this._lastModified=n.game.frameStartTime}}t("Touch",ZT),n.Touch=ZT;class QT{constructor(t=0,e=0,i=0,n=0){this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=t,this.y=e,this.z=i,this.timestamp=n}}const tw=Ut.TOUCH_TIMEOUT,ew=new tn,iw=new tn,nw=new class{constructor(){this._preTouchPoint=new tn,this._prevMousePoint=new tn,this._preTouchPool=[],this._preTouchPoolPointer=0,this._touches=[],this._touchesIntegerDict={},this._indexBitsUsed=0,this._maxTouches=8,this._glView=null}clearEvents(){WT.pollMouseEvents(),WT.pollTouchEvents(),WT.pollKeyboardEvents(),WT.pollAccelerometerEvents()}frameDispatchEvents(){const t=WT.pollMouseEvents();for(let e=0,i=t.length;e<i;++e){const i=t[e];this._dispatchMouseEvent(i)}const e=WT.pollTouchEvents();for(let t=0,i=e.length;t<i;++t){const i=e[t];this._dispatchTouchEvent(i)}const i=WT.pollKeyboardEvents();for(let t=0,e=i.length;t<e;++t){const e=i[t];this._dispatchKeyboardEvent(e)}const n=WT.pollAccelerometerEvents();for(let t=0,e=n.length;t<e;++t){const e=n[t];this._dispatchAccelerometerEvent(e)}}_dispatchMouseEvent(t){let e,i;switch(t.type){case Gy.MOUSE_DOWN:e=this._getMouseEvent(t),i=this._getTouch(t),this._handleTouchesStart([i]),tv.dispatchEvent(e);break;case Gy.MOUSE_MOVE:e=this._getMouseEvent(t),i=this._getTouch(t),this._handleTouchesMove([i]),tv.dispatchEvent(e);break;case Gy.MOUSE_UP:e=this._getMouseEvent(t),i=this._getTouch(t),this._handleTouchesEnd([i]),tv.dispatchEvent(e);break;case Gy.MOUSE_WHEEL:e=this._getMouseEvent(t),e.setScrollData(t.deltaX,t.deltaY),tv.dispatchEvent(e)}}_dispatchTouchEvent(t){const e=this._getTouchList(t);switch(t.type){case Gy.TOUCH_START:this._handleTouchesStart(e);break;case Gy.TOUCH_MOVE:this._handleTouchesMove(e);break;case Gy.TOUCH_END:this._handleTouchesEnd(e);break;case Gy.TOUCH_CANCEL:this._handleTouchesCancel(e)}}_handleTouchesStart(t){const e=[],i=this._touchesIntegerDict;for(let n=0;n<t.length;++n){const s=t[n],r=s.getID();if(null!==r&&void 0===i[r]){const t=this._getUnUsedIndex();if(-1===t){b(2300,t);continue}s.getLocation(ew);const n=new ZT(ew.x,ew.y,r);this._touches[t]=n,s.getPreviousLocation(ew),n.setPrevPoint(ew),i[r]=t,e.push(n)}}if(e.length>0){const t=new YT(e,!1,Gy.TOUCH_START,Ut.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);tv.dispatchEvent(t)}}_handleTouchesMove(t){const e=[],i=this._touches;for(let n=0;n<t.length;++n){const s=t[n],r=s.getID();if(null===r)continue;const o=this._touchesIntegerDict[r];void 0!==o&&i[o]&&(s.getLocation(ew),i[o].setPoint(ew),s.getPreviousLocation(ew),i[o].setPrevPoint(ew),e.push(i[o]))}if(e.length>0){const t=new YT(e,!1,Gy.TOUCH_MOVE,Ut.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);tv.dispatchEvent(t)}}_handleTouchesEnd(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new YT(e,!1,Gy.TOUCH_END,Ut.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);tv.dispatchEvent(t)}this._preTouchPool.length=0}_handleTouchesCancel(t){const e=this.getSetOfTouchesEndOrCancel(t);if(e.length>0){const t=new YT(e,!1,Gy.TOUCH_CANCEL,Ut.ENABLE_MULTI_TOUCH?this._getUsefulTouches():e);tv.dispatchEvent(t)}this._preTouchPool.length=0}getSetOfTouchesEndOrCancel(t){const e=[],i=this._touches,n=this._touchesIntegerDict;for(let s=0;s<t.length;++s){const r=t[s],o=r.getID();if(null===o)continue;const a=n[o];void 0!==a&&i[a]&&(r.getLocation(ew),i[a].setPoint(ew),r.getPreviousLocation(ew),i[a].setPrevPoint(ew),e.push(i[a]),this._removeUsedIndexBit(a),delete n[o])}return e}_getPreTouch(t){let e=null;const i=this._preTouchPool,n=t.getID();for(let t=i.length-1;t>=0;t--)if(i[t].getID()===n){e=i[t];break}return e||(e=t),e}_setPreTouch(t){let e=!1;const i=this._preTouchPool,n=t.getID();for(let s=i.length-1;s>=0;s--)if(i[s].getID()===n){i[s]=t,e=!0;break}e||(i.length<=50?i.push(t):(i[this._preTouchPoolPointer]=t,this._preTouchPoolPointer=(this._preTouchPoolPointer+1)%50))}_getViewPixelRatio(){return this._glView||(this._glView=n.view),this._glView?this._glView._devicePixelRatio:1}_getTouch(t){const e=this._preTouchPoint,i=this._getViewPixelRatio(),n=t.x*i,s=t.y*i,r=new ZT(n,s,0);return r.setPrevPoint(e.x,e.y),e.x=n,e.y=s,r}_getMouseEvent(t){const e=this._prevMousePoint,i=new XT(t.type,!1,e),s=this._getViewPixelRatio();return e.x=t.x*s,e.y=t.y*s,n.GAME_VIEW&&(e.x/=n.gameView.canvas.width/n.game.canvas.width,e.y/=n.gameView.canvas.height/n.game.canvas.height),i.setLocation(e.x,e.y),i.setButton(t.button),t.movementX&&(i.movementX=t.movementX),t.movementY&&(i.movementY=t.movementY),i}_getTouchList(t){const e=[],i=this._preTouchPoint,n=t.changedTouches.length,s=this._getViewPixelRatio();for(let r=0;r<n;r++){const n=t.changedTouches[r],o=n.x*s,a=n.y*s,l=new ZT(o,a,n.identifier);if(this._getPreTouch(l).getLocation(iw),l.setPrevPoint(iw.x,iw.y),this._setPreTouch(l),i.x=o,i.y=a,e.push(l),!Ut.ENABLE_MULTI_TOUCH)break}return e}_getUnUsedIndex(){let t=this._indexBitsUsed;const e=n.game.frameStartTime;for(let i=0;i<this._maxTouches;i++){if(!(1&t))return this._indexBitsUsed|=1<<i,i;{const t=this._touches[i];if(e-t.lastModified>tw){this._removeUsedIndexBit(i);const e=t.getID();return null!==e&&delete this._touchesIntegerDict[e],i}}t>>=1}return-1}_removeUsedIndexBit(t){if(t<0||t>=this._maxTouches)return;let e=1<<t;e=~e,this._indexBitsUsed&=e}_getUsefulTouches(){const t=[],e=this._touchesIntegerDict;for(const i in e){const n=e[parseInt(i)];if(null==n)continue;const s=this._touches[n];t.push(s)}return t}_dispatchKeyboardEvent(t){switch(t.type){case Gy.KEY_DOWN:tv.dispatchEvent(new $T(t.code,Gy.KEY_DOWN));break;case Gy.KEY_UP:tv.dispatchEvent(new $T(t.code,Gy.KEY_UP))}}_dispatchAccelerometerEvent(t){if(t.type===Gy.DEVICEMOTION){const{x:e,y:i,z:n,timestamp:s}=t;tv.dispatchEvent(new KT(new QT(e,i,n,s)))}}setAccelerometerEnabled(t){t?WT.startAccelerometer():WT.stopAccelerometer()}setAccelerometerInterval(t){WT.setAccelerometerInterval(t)}};n.internal.inputManager=nw;let sw=null,rw=null,ow=null,aw=null;class lw extends He{constructor(){super()}setAccelerometerEnabled(t){t&&window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((t=>{b(3520,t),nw.setAccelerometerEnabled("granted"===t)})).catch((t=>{A(3521,t.message),nw.setAccelerometerEnabled(!1)})):nw.setAccelerometerEnabled(t)}setAccelerometerInterval(t){nw.setAccelerometerInterval(t)}on(t,e,i,s){return super.on(t,e,i,s),t!==Gy.KEY_DOWN&&t!==Gy.KEY_UP||sw||(sw=ky.create({event:ky.KEYBOARD,onKeyDown(t,e){cw.emit(e.type,e)},onKeyPressed(t,e){cw.emit(e.type,e)},onKeyReleased(t,e){cw.emit(e.type,e)}}),tv.addListener(sw,256)),t===Gy.DEVICEMOTION&&(rw||(rw=ky.create({event:ky.ACCELERATION,callback(t,e){n.systemEvent.emit(e.type,e)}}),tv.addListener(rw,256))),t!==Gy.TOUCH_START&&t!==Gy.TOUCH_MOVE&&t!==Gy.TOUCH_END&&t!==Gy.TOUCH_CANCEL||ow||(ow=ky.create({event:ky.TOUCH_ONE_BY_ONE,onTouchBegan:(t,e)=>(n.systemEvent.emit(e.type,t,e),!0),onTouchMoved(t,e){n.systemEvent.emit(e.type,t,e)},onTouchEnded(t,e){n.systemEvent.emit(e.type,t,e)},onTouchCancelled(t,e){n.systemEvent.emit(e.type,t,e)}}),tv.addListener(ow,256)),t!==Gy.MOUSE_DOWN&&t!==Gy.MOUSE_MOVE&&t!==Gy.MOUSE_UP&&t!==Gy.MOUSE_WHEEL||aw||(aw=ky.create({event:ky.MOUSE,onMouseDown(t){n.systemEvent.emit(t.type,t)},onMouseMove(t){n.systemEvent.emit(t.type,t)},onMouseUp(t){n.systemEvent.emit(t.type,t)},onMouseScroll(t){n.systemEvent.emit(t.type,t)}}),tv.addListener(aw,256)),e}off(t,e,i){if(super.off(t,e,i),sw&&(t===Gy.KEY_DOWN||t===Gy.KEY_UP)){const t=this.hasEventListener(Gy.KEY_DOWN),e=this.hasEventListener(Gy.KEY_UP);t||e||(tv.removeListener(sw),sw=null)}if(rw&&t===Gy.DEVICEMOTION&&(tv.removeListener(rw),rw=null),ow&&(t===Gy.TOUCH_START||t===Gy.TOUCH_MOVE||t===Gy.TOUCH_END||t===Gy.TOUCH_CANCEL)){const t=this.hasEventListener(Gy.TOUCH_START),e=this.hasEventListener(Gy.TOUCH_MOVE),i=this.hasEventListener(Gy.TOUCH_END),n=this.hasEventListener(Gy.TOUCH_CANCEL);t||e||i||n||(tv.removeListener(ow),ow=null)}if(aw&&(t===Gy.MOUSE_DOWN||t===Gy.MOUSE_MOVE||t===Gy.MOUSE_UP||t===Gy.MOUSE_WHEEL)){const t=this.hasEventListener(Gy.MOUSE_DOWN),e=this.hasEventListener(Gy.MOUSE_MOVE),i=this.hasEventListener(Gy.MOUSE_UP),n=this.hasEventListener(Gy.MOUSE_WHEEL);t||e||i||n||(tv.removeListener(aw),aw=null)}}}t("SystemEvent",lw),lw.EventType=Gy,n.SystemEvent=lw;const cw=t("systemEvent",new lw);n.systemEvent=cw;class hw extends He{constructor(...t){super(...t),this.frame=null,this.container=null,this.canvas=null,this.renderType=-1,this.eventTargetOn=super.on,this.eventTargetOnce=super.once,this.config={},this.onStart=null,this.frameTime=1e3/60,this.collisionMatrix=[],this.groupList=[],this._persistRootNodes={},this._gfxDevice=null,this._configLoaded=!1,this._isCloning=!1,this._inited=!1,this._engineInited=!1,this._rendererInitialized=!1,this._paused=!0,this._frameRate=60,this._intervalId=0,this._initTime=0,this._startTime=0,this._deltaTime=0}get inited(){return this._inited}get frameRate(){return this._frameRate}set frameRate(t){"number"!=typeof t&&(t=parseInt(t,10),Number.isNaN(t)&&(t=60)),this._frameRate=t,this.frameTime=1e3/t,this._setAnimFrame()}get deltaTime(){return this._deltaTime}get totalTime(){return performance.now()-this._initTime}get frameStartTime(){return this._startTime}setFrameRate(t){this.frameRate=t}getFrameRate(){return this.frameRate}step(){n.director.tick(this.frameTime/1e3)}pause(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))}resume(){this._paused&&(nw.clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))}isPaused(){return this._paused}restart(){return new Promise((t=>n.director.once(n.Director.EVENT_END_FRAME,(()=>t())))).then((()=>{for(const t in this._persistRootNodes)this.removePersistRootNode(this._persistRootNodes[t]);return n.director.getScene().destroy(),n.Object._deferredDestroy(),n.director.reset(),this.pause(),this._setRenderPipelineNShowSplash().then((()=>{this.resume(),this._safeEmit(hw.EVENT_RESTART)}))}))}end(){qe.close()}on(t,e,i,n){return(this._engineInited&&t===hw.EVENT_ENGINE_INITED||this._inited&&t===hw.EVENT_GAME_INITED||this._rendererInitialized&&t===hw.EVENT_RENDERER_INITED)&&e.call(i),this.eventTargetOn(t,e,i,n)}once(t,e,i){return this._engineInited&&t===hw.EVENT_ENGINE_INITED?e.call(i):this.eventTargetOnce(t,e,i)}init(t){if(this._initConfig(t),this.config.assetOptions&&n.assetManager.init(this.config.assetOptions),this.config.layers){const t=this.config.layers;for(let e=0;e<t.length;e++){const i=t[e],n=Xe(i.value);Qm.addLayer(i.name,n)}}return this._initEngine().then((()=>(this._initEvents(),n.director.root&&n.director.root.dataPoolManager&&n.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(t.customJointTextureLayouts),this._engineInited)))}run(t,e){let i;return"function"!=typeof t&&t?(i=this.init(t),this.onStart=null!=e?e:null):this.onStart=null!=t?t:null,sh.init(),Promise.resolve(i).then((()=>this._setRenderPipelineNShowSplash()))}addPersistRootNode(t){if(!n.Node.isNode(t)||!t.uuid)return void A(3800);const e=t.uuid;if(!this._persistRootNodes[e]){const i=n.director._scene;if(n.isValid(i))if(t.parent){if(!(t.parent instanceof n.Scene))return void A(3801);if(t.parent!==i)return void A(3802);t._originalSceneId=i.uuid}else t.parent=i;this._persistRootNodes[e]=t,t._persistNode=!0,n.assetManager._releaseManager._addPersistNodeRef(t)}}removePersistRootNode(t){const e=t.uuid||"";t===this._persistRootNodes[e]&&(delete this._persistRootNodes[e],t._persistNode=!1,t._originalSceneId="",n.assetManager._releaseManager._removePersistNodeRef(t))}isPersistRootNode(t){return!!t._persistNode}_initEngine(){return this._initDevice(),Promise.resolve(n.director._init()).then((()=>{u(`Cocos Creator v${s}`),this.emit(hw.EVENT_ENGINE_INITED),this._engineInited=!0,n.internal.dynamicAtlasManager&&(n.internal.dynamicAtlasManager.enabled=!Ut.CLEANUP_IMAGE_CACHE)}))}_setAnimFrame(){const t=this._frameRate;jsb.setPreferredFramesPerSecond(t),window.rAF=window.requestAnimationFrame,window.cAF=window.cancelAnimationFrame}_stTime(t){const e=performance.now(),i=Math.max(0,e-this._startTime),n=Math.max(0,this.frameTime-i);return window.setTimeout(t,n)}_ctTime(t){window.clearTimeout(t)}_calculateDT(t){return t||(t=performance.now()),this._deltaTime=t>this._startTime?(t-this._startTime)/1e3:0,this._deltaTime>hw.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=t,this._deltaTime}_updateCallback(){const t=n.director;let e;e=e=>{t.tick(this._calculateDT(e)),this._intervalId=window.rAF(this._frameCB)},this._frameCB=e}_runMainLoop(){if(!this._inited)return;const t=this.config,e=n.director;R(!!t.showFPS),e.startAnimation(),this.resume()}_initConfig(t){"number"!=typeof t.debugMode&&(t.debugMode=P.NONE),t.exposeClassName=!!t.exposeClassName,"number"!=typeof t.frameRate&&(t.frameRate=60);const e=t.renderMode;("number"!=typeof e||e>2||e<0)&&(t.renderMode=0),t.showFPS=!!t.showFPS,g(t.debugMode),this.config=t,this._configLoaded=!0,this.frameRate=t.frameRate}_determineRenderType(){const t=this.config,e=parseInt(t.renderMode,10);this.renderType=hw.RENDER_TYPE_CANVAS;let i=!1;if(0===e?yn.capabilities.opengl?(this.renderType=hw.RENDER_TYPE_WEBGL,i=!0):yn.capabilities.canvas&&(this.renderType=hw.RENDER_TYPE_CANVAS,i=!0):1===e&&yn.capabilities.canvas?(this.renderType=hw.RENDER_TYPE_CANVAS,i=!0):2===e&&yn.capabilities.opengl&&(this.renderType=hw.RENDER_TYPE_WEBGL,i=!0),!i)throw new Error(D(3820,e))}_initDevice(){if(this._rendererInitialized)return;const t=this.config.adapter;if(t&&(this.canvas=t.canvas,this.frame=t.frame,this.container=t.container),this._determineRenderType(),this.renderType===hw.RENDER_TYPE_WEBGL){const t=[],e=new po(this.canvas,Ut.ENABLE_WEBGL_ANTIALIAS,!1,window.devicePixelRatio,yn.windowPixelResolution.width,yn.windowPixelResolution.height,_p);if(window.gfx)this._gfxDevice=gfx.DeviceManager.create(e);else{let i=!!window.WebGL2RenderingContext;const s=window.navigator.userAgent.toLowerCase();(-1!==s.indexOf("safari")&&-1===s.indexOf("chrome")||yn.browserType===O.UC)&&(i=!1),i&&n.WebGL2Device&&t.push(n.WebGL2Device),n.WebGLDevice&&t.push(n.WebGLDevice);for(let i=0;i<t.length&&(this._gfxDevice=new t[i],!this._gfxDevice.initialize(e));i++);}}if(!this._gfxDevice)return p("can not support canvas rendering in 3D"),void(this.renderType=hw.RENDER_TYPE_CANVAS);this.canvas.oncontextmenu=()=>!1}_initEvents(){qe.on("show",this._onShow,this),qe.on("hide",this._onHide,this)}_onHide(){this.emit(hw.EVENT_HIDE),this.pause()}_onShow(){this.emit(hw.EVENT_SHOW),this.resume()}_setRenderPipelineNShowSplash(){return Promise.resolve(this._setupRenderPipeline()).then((()=>Promise.resolve(this._showSplashScreen()).then((()=>{this._inited=!0,this._initTime=performance.now(),this._runMainLoop(),this._safeEmit(hw.EVENT_GAME_INITED),this.onStart&&this.onStart()}))))}_setupRenderPipeline(){const{renderPipeline:t}=this.config;return t?new Promise(((e,i)=>{n.assetManager.loadAny(t,((t,n)=>!t&&n instanceof vT?e(n):i(t)))})).then((t=>{this._setRenderPipeline(t)})).catch((e=>{m(e),m(`Failed load render pipeline: ${t}, engine failed to initialize, will fallback to default pipeline`),this._setRenderPipeline()})):this._setRenderPipeline()}_showSplashScreen(){if(n.internal.SplashScreen){const t=n.internal.SplashScreen.instance;return t.main(n.director.root),new Promise((e=>{t.setOnFinish((()=>e())),t.loadFinish=!0}))}return null}_setRenderPipeline(t){n.director.root.setRenderPipeline(t)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(hw.EVENT_RENDERER_INITED)}_safeEmit(t){this.emit(t)}}t("Game",hw),hw.EVENT_HIDE="game_on_hide",hw.EVENT_SHOW="game_on_show",hw.EVENT_LOW_MEMORY="game_on_low_memory",hw.EVENT_GAME_INITED="game_inited",hw.EVENT_ENGINE_INITED="engine_inited",hw.EVENT_RENDERER_INITED="renderer_inited",hw.EVENT_RESTART="game_on_restart",hw.RENDER_TYPE_CANVAS=0,hw.RENDER_TYPE_WEBGL=1,hw.RENDER_TYPE_OPENGL=2,hw.DEBUG_DT_THRESHOLD=1,n.Game=hw;const _w=t("game",n.game=new hw),uw={topLeft:n.v2(0,0),topRight:n.v2(0,0),top:n.v2(0,0),bottomLeft:n.v2(0,0),bottomRight:n.v2(0,0),bottom:n.v2(0,0),center:n.v2(0,0),left:n.v2(0,0),right:n.v2(0,0),width:0,height:0,init(t){const e=this.width=t.width,i=this.height=t.height,n=t.x,s=t.y,r=s+i,o=n+e;this.topLeft.x=n,this.topLeft.y=r,this.topRight.x=o,this.topRight.y=r,this.top.x=n+e/2,this.top.y=r,this.bottomLeft.x=n,this.bottomLeft.y=s,this.bottomRight.x=o,this.bottomRight.y=s,this.bottom.x=n+e/2,this.bottom.y=s,this.center.x=n+e/2,this.center.y=s+i/2,this.left.x=n,this.left.y=s+i/2,this.right.x=o,this.right.y=s+i/2}};n.visibleRect=uw;const mw=t("screen",new class{get supportsFullScreen(){return dn.supportFullScreen}fullScreen(){return dn.isFullScreen}requestFullScreen(t,e,i){return arguments.length>0&&A(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),dn.requestFullScreen().then((()=>{null==e||e()})).catch((t=>{console.error(t),null==i||i()}))}exitFullScreen(){return dn.exitFullScreen()}autoFullScreen(t,e){var i;null===(i=this.requestFullScreen(t,e))||void 0===i||i.catch((()=>{}))}disableAutoFullScreen(t){}});n.screen=mw;const pw=new ln;class dw extends He{constructor(){super(),this._resizeWithBrowserSize=void 0,this._designResolutionSize=void 0,this._frameSize=void 0,this._scaleX=void 0,this._scaleY=void 0,this._viewportRect=void 0,this._visibleRect=void 0,this._autoFullScreen=void 0,this._devicePixelRatio=void 0,this._maxPixelRatio=void 0,this._retinaEnabled=void 0,this._resizeCallback=void 0,this._resizing=void 0,this._orientationChanging=void 0,this._isRotated=void 0,this._orientation=void 0,this._resolutionPolicy=void 0,this._rpExactFit=void 0,this._rpShowAll=void 0,this._rpNoBorder=void 0,this._rpFixedHeight=void 0,this._rpFixedWidth=void 0;const t=fw,e=gw;this._frameSize=new ln(0,0),this._designResolutionSize=new ln(0,0),this._scaleX=1,this._scaleY=1,this._viewportRect=new hn(0,0,0,0),this._visibleRect=new hn(0,0,0,0),this._autoFullScreen=!1,this._devicePixelRatio=1,this._maxPixelRatio=4,this._retinaEnabled=!1,this._resizeCallback=null,this._resizing=!1,this._resizeWithBrowserSize=!1,this._orientationChanging=!0,this._isRotated=!1,this._orientation=n.macro.ORIENTATION_AUTO,this._rpExactFit=new yw(t.EQUAL_TO_FRAME,e.EXACT_FIT),this._rpShowAll=new yw(t.EQUAL_TO_FRAME,e.SHOW_ALL),this._rpNoBorder=new yw(t.EQUAL_TO_FRAME,e.NO_BORDER),this._rpFixedHeight=new yw(t.EQUAL_TO_FRAME,e.FIXED_HEIGHT),this._rpFixedWidth=new yw(t.EQUAL_TO_FRAME,e.FIXED_WIDTH),this._resolutionPolicy=this._rpShowAll,n.game.once(n.Game.EVENT_ENGINE_INITED,this.init,this)}init(){this._initFrameSize();const t=n.game.canvas.width,e=n.game.canvas.height;this._designResolutionSize.width=t,this._designResolutionSize.height=e,this._viewportRect.width=t,this._viewportRect.height=e,this._visibleRect.width=t,this._visibleRect.height=e,pw.width=this._visibleRect.width,pw.height=this._visibleRect.height,uw&&uw.init(this._visibleRect)}resizeWithBrowserSize(t){t?this._resizeWithBrowserSize||(this._resizeWithBrowserSize=!0,dn.on("window-resize",this._resizeEvent,this),dn.on("orientation-change",this._orientationChange,this)):this._resizeWithBrowserSize&&(this._resizeWithBrowserSize=!1,dn.off("window-resize",this._resizeEvent,this),dn.off("orientation-change",this._orientationChange,this))}setResizeCallback(t){"function"!=typeof t&&null!=t||(this._resizeCallback=t)}setOrientation(t){(t&=n.macro.ORIENTATION_AUTO)&&this._orientation!==t&&(this._orientation=t)}adjustViewportMeta(t){}enableRetina(t){this._retinaEnabled=!!t}isRetinaEnabled(){return this._retinaEnabled}enableAutoFullScreen(t){t!==this._autoFullScreen&&(this._autoFullScreen=t,t&&mw.requestFullScreen().catch((()=>{})))}isAutoFullScreenEnabled(){return this._autoFullScreen}setCanvasSize(t,e){const i=n.game.canvas,s=n.game.container;this._devicePixelRatio=window.devicePixelRatio,i.width=yn.windowPixelResolution.width,i.height=yn.windowPixelResolution.height,i.style.width=`${t}px`,i.style.height=`${e}px`,s.style.width=`${t}px`,s.style.height=`${e}px`,this._resizeEvent()}getCanvasSize(){return new ln(n.game.canvas.width,n.game.canvas.height)}getFrameSize(){return new ln(this._frameSize.width,this._frameSize.height)}setFrameSize(t,e){this._frameSize.width=t,this._frameSize.height=e,n.game.frame.style.width=`${t}px`,n.game.frame.style.height=`${e}px`,this._resizeEvent()}getVisibleSize(){return new ln(this._visibleRect.width,this._visibleRect.height)}getVisibleSizeInPixel(){return new ln(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)}getVisibleOrigin(){return new tn(this._visibleRect.x,this._visibleRect.y)}getVisibleOriginInPixel(){return new tn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)}getResolutionPolicy(){return this._resolutionPolicy}setResolutionPolicy(t){if(t instanceof yw)this._resolutionPolicy=t;else{const e=yw;t===e.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),t===e.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),t===e.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),t===e.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),t===e.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}}setDesignResolutionSize(t,e,i){if(!(t>0&&e>0))return void T(2200);this.setResolutionPolicy(i);const n=this._resolutionPolicy;if(n&&n.preApply(this),this._orientationChanging=!0,this._resizing||this._initFrameSize(),!n)return void b(2201);this._designResolutionSize.width=t,this._designResolutionSize.height=e;const s=n.apply(this,this._designResolutionSize);if(s.scale&&2===s.scale.length&&(this._scaleX=s.scale[0],this._scaleY=s.scale[1]),s.viewport){const t=this._viewportRect,e=this._visibleRect,i=s.viewport;t.x=i.x,t.y=i.y,t.width=i.width,t.height=i.height,e.x=0,e.y=0,e.width=i.width/this._scaleX,e.height=i.height/this._scaleY}n.postApply(this),pw.width=this._visibleRect.width,pw.height=this._visibleRect.height,uw&&uw.init(this._visibleRect),this.emit("design-resolution-changed")}getDesignResolutionSize(){return new ln(this._designResolutionSize.width,this._designResolutionSize.height)}setRealPixelResolution(t,e,i){this.setDesignResolutionSize(t,e,i)}getViewportRect(){return this._viewportRect}getScaleX(){return this._scaleX}getScaleY(){return this._scaleY}getDevicePixelRatio(){return this._devicePixelRatio}convertToLocationInView(t,e,i,s){const r=s||new tn,o=this._devicePixelRatio*(t-i.left),a=this._devicePixelRatio*(i.top+i.height-e);return this._isRotated?(r.x=n.game.canvas.width-a,r.y=o):(r.x=o,r.y=a),n.GAME_VIEW&&(r.x/=n.gameView.canvas.width/n.game.canvas.width,r.y/=n.gameView.canvas.height/n.game.canvas.height),r}_convertPointWithScale(t){const e=this._viewportRect;t.x=(t.x-e.x)/this._scaleX,t.y=(t.y-e.y)/this._scaleY}_resizeEvent(){var t;if(this._frameSize.width,this._frameSize.height,this._isRotated,n.sys.isMobile){const t=n.game.container.style,e=t.margin;t.margin="0",t.display="none",this._initFrameSize(),t.margin=e,t.display="block"}else this._initFrameSize();const e=this._designResolutionSize.width,i=this._designResolutionSize.height;this._resizing=!0,e>0&&this.setDesignResolutionSize(e,i,this._resolutionPolicy),this._resizing=!1,this.emit("canvas-resize"),null===(t=this._resizeCallback)||void 0===t||t.call(this)}_orientationChange(){this._orientationChanging=!0,this._resizeEvent()}_initFrameSize(){const t=this._frameSize,e=dn.windowSize,i=e.width,s=e.height,r=i>=s;!n.sys.isMobile||r&&this._orientation&n.macro.ORIENTATION_LANDSCAPE||!r&&this._orientation&n.macro.ORIENTATION_PORTRAIT?(t.width=i,t.height=s,n.game.container.style["-webkit-transform"]="rotate(0deg)",n.game.container.style.transform="rotate(0deg)",this._isRotated=!1):(t.width=s,t.height=i,n.game.container.style["-webkit-transform"]="rotate(90deg)",n.game.container.style.transform="rotate(90deg)",n.game.container.style["-webkit-transform-origin"]="0px 0px 0px",n.game.container.style.transformOrigin="0px 0px 0px",this._isRotated=!0,n.game.canvas.style["-webkit-transform"]="translateZ(0px)",n.game.canvas.style.transform="translateZ(0px)"),this._orientationChanging&&setTimeout((()=>{n.view._orientationChanging=!1}),1e3)}}t("View",dw),dw.instance=void 0;class fw{constructor(){this.name="ContainerStrategy"}preApply(t){}apply(t,e){}postApply(t){}_setupContainer(t,e,i){const s=n.game.canvas,r=n.game.container;yn.os!==L.ANDROID&&yn.os!==L.OHOS||(document.body.style.width=`${t._isRotated?i:e}px`,document.body.style.height=`${t._isRotated?e:i}px`),r.style.width=s.style.width=`${e}px`,r.style.height=s.style.height=`${i}px`,t._devicePixelRatio=1,t.isRetinaEnabled()&&(t._devicePixelRatio=Math.min(t._maxPixelRatio,window.devicePixelRatio||1)),s.width=yn.windowPixelResolution.width,s.height=yn.windowPixelResolution.height}_fixContainer(){document.body.insertBefore(n.game.container,document.body.firstChild);const t=document.body.style;t.width=`${window.innerWidth}px`,t.height=`${window.innerHeight}px`,t.overflow="hidden";const e=n.game.container.style;e.position="fixed",e.left=e.top="0px",document.body.scrollTop=0}}fw.EQUAL_TO_FRAME=void 0,fw.PROPORTION_TO_FRAME=void 0;class gw{constructor(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}preApply(t){}apply(t,e){return{scale:[1,1]}}postApply(t){}_buildResult(t,e,i,n,s,r){Math.abs(t-i)<2&&(i=t),Math.abs(e-n)<2&&(n=e);const o=new hn(Math.round((t-i)/2),Math.round((e-n)/2),i,n);return this._result.scale=[s,r],this._result.viewport=o,this._result}}gw.EXACT_FIT=void 0,gw.SHOW_ALL=void 0,gw.NO_BORDER=void 0,gw.FIXED_HEIGHT=void 0,gw.FIXED_WIDTH=void 0,(()=>{const t=("undefined"==typeof window?global:window).__globalAdapter;t&&(t.adaptContainerStrategy&&t.adaptContainerStrategy(fw.prototype),t.adaptView&&t.adaptView(dw.prototype)),fw.EQUAL_TO_FRAME=new class extends fw{constructor(...t){super(...t),this.name="EqualToFrame"}apply(t){const e=t._frameSize.height,i=n.game.container.style;this._setupContainer(t,t._frameSize.width,t._frameSize.height),t._isRotated?i.margin=`0 0 0 ${e}px`:i.margin="0px",i.padding="0px"}},fw.PROPORTION_TO_FRAME=new class extends fw{constructor(...t){super(...t),this.name="ProportionalToFrame"}apply(t,e){const i=t._frameSize.width,s=t._frameSize.height,r=n.game.container.style,o=e.width,a=e.height,l=i/o,c=s/a;let h,_;l<c?(h=i,_=a*l):(h=o*c,_=s);const u=Math.round((i-h)/2),m=Math.round((s-_)/2);h=i-2*u,_=s-2*m,this._setupContainer(t,h,_),t._isRotated?r.margin=`0 0 0 ${s}px`:r.margin="0px",r.paddingLeft=`${u}px`,r.paddingRight=`${u}px`,r.paddingTop=`${m}px`,r.paddingBottom=`${m}px`}},gw.EXACT_FIT=new class extends gw{constructor(...t){super(...t),this.name="ExactFit"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=i/e.width,o=s/e.height;return this._buildResult(i,s,i,s,r,o)}},gw.SHOW_ALL=new class extends gw{constructor(...t){super(...t),this.name="ShowAll"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=e.width,o=e.height,a=i/r,l=s/o;let c,h,_=0;return a<l?(_=a,c=i,h=o*_):(_=l,c=r*_,h=s),this._buildResult(i,s,c,h,_,_)}},gw.NO_BORDER=new class extends gw{constructor(...t){super(...t),this.name="NoBorder"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=e.width,o=e.height,a=i/r,l=s/o;let c,h,_;return a<l?(c=l,h=r*c,_=s):(c=a,h=i,_=o*c),this._buildResult(i,s,h,_,c,c)}},gw.FIXED_HEIGHT=new class extends gw{constructor(...t){super(...t),this.name="FixedHeight"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=s/e.height,o=i,a=s;return this._buildResult(i,s,o,a,r,r)}},gw.FIXED_WIDTH=new class extends gw{constructor(...t){super(...t),this.name="FixedWidth"}apply(t,e){const i=n.game.canvas.width,s=n.game.canvas.height,r=i/e.width,o=i,a=s;return this._buildResult(i,s,o,a,r,r)}}})();class yw{constructor(t,e){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(t),this.setContentStrategy(e)}get canvasSize(){return new tn(n.game.canvas.width,n.game.canvas.height)}preApply(t){this._containerStrategy.preApply(t),this._contentStrategy.preApply(t)}apply(t,e){return this._containerStrategy.apply(t,e),this._contentStrategy.apply(t,e)}postApply(t){this._containerStrategy.postApply(t),this._contentStrategy.postApply(t)}setContainerStrategy(t){t instanceof fw&&(this._containerStrategy=t)}setContentStrategy(t){t instanceof gw&&(this._contentStrategy=t)}}t("ResolutionPolicy",yw),yw.EXACT_FIT=0,yw.NO_BORDER=1,yw.SHOW_ALL=2,yw.FIXED_HEIGHT=3,yw.FIXED_WIDTH=4,yw.UNKNOWN=5,yw.ContainerStrategy=fw,yw.ContentStrategy=gw,n.ResolutionPolicy=yw;const vw=t("view",dw.instance=n.view=new dw);n.winSize=pw,Qe(dw.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),ti(dw.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"}]),ti(n,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),Ze(nh,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:lw.EventType,targetName:"SystemEvent.EventType"}]),ti(nh,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),Ze(XT,"EventMouse",["DOWN","UP","MOVE"].map((t=>({name:t,newName:`MOUSE_${t}`,target:lw.EventType,targetName:"SystemEvent.EventType"})))),Ze(XT,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:lw.EventType,targetName:"SystemEvent.EventType"}]),ti(XT.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),Ze(YT,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:lw.EventType,targetName:"SystemEvent.EventType"}]),Ze(YT,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:lw.EventType,targetName:"SystemEvent.EventType"}]),Ze(YT,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:lw.EventType,targetName:"SystemEvent.EventType"}]),Ze(YT,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:lw.EventType,targetName:"SystemEvent.EventType"}]),ti(YT.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),ti($T.prototype,"EventKeyboard.prototype",[{name:"isPressed",suggest:"use EventKeyboard.prototype.type !== SystemEvent.EventType.KEY_UP instead"}]),Ze(yn,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((t=>({name:`LANGUAGE_${t}`,newName:t,target:yn.Language,targetName:"sys.Language"})))),Ze(yn,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((t=>({name:`OS_${t}`,newName:t,target:yn.OS,targetName:"sys.OS"})))),Ze(yn,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((t=>({name:`BROWSER_TYPE_${t}`,newName:t,target:yn.BrowserType,targetName:"sys.BrowserType"})))),Ze(yn,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:yn.BrowserType,targetName:"sys.BrowserType"}]),Ze(yn,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((t=>({name:t,target:yn.Platform,targetName:"sys.Platform"})))),Ze(yn,"sys",[{name:"IPHONE",newName:"IOS",target:yn.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:yn.Platform,targetName:"sys.Platform"}]),Qe(yn,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((t=>({name:t})))),Ze(Gy,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((t=>({name:t,target:Yv.EventType,targetName:"Node.EventType"})))),Ze(Yv.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:lw.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:lw.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:lw.EventType,targetName:"SystemEvent.EventType"}]),ti(Ut.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((t=>({name:t})))),ti(Ut.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),ti(Ut.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),ti(Ut.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),ti(Ut,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),ti(mw,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);const xw=new tn;class bw{set splashFinish(t){this._splashFinish=t,this._tryToStart()}set loadFinish(t){this._loadFinish=t,this._tryToStart()}main(t){if(null!=t){if(window._CCSettings&&window._CCSettings.splashScreen){const t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new wr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new wr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{n.view.enableRetina(!0),n.view.resizeWithBrowserSize(!0);const e=window._CCSettings.designResolution;e?n.view.setDesignResolutionSize(e.width,e.height,e.policy):n.view.setDesignResolutionSize(960,640,4),this.root=t,this.device=t.device,n.game.once(n.Game.EVENT_GAME_INITED,(()=>{n.director._lateUpdate=performance.now()}),n.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else p("RENDER ROOT IS NULL.")}setOnFinish(t){if(this._directCall&&t)return bw._ins=void 0,void t();this.callBack=t}_tryToStart(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),n.game.resume())}preInit(){const t=this.settings.clearColor;this.clearColors=[new wr(t.x,t.y,t.z,t.w)];const e=this.device;this.renderArea=new yr(0,0,e.width,e.height),this.framebuffer=this.root.mainWindow.framebuffer,this.cmdBuff=e.commandBuffer;const i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),n=4*Float32Array.BYTES_PER_ELEMENT,s=4*n;this.vertexBuffers=e.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,s,n)),this.vertexBuffers.update(i);const r=new Uint16Array([0,1,2,1,3,2]),o=Uint16Array.BYTES_PER_ELEMENT,a=6*o;this.indicesBuffers=e.createBuffer(new Pr(Ls.INDEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,a,o)),this.indicesBuffers.update(r);const l=[new Wr("a_position",Os.RG32F),new Wr("a_texCoord",Os.RG32F)],c=new Xr(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=e.createInputAssembler(c),this.projection=new $i,$i.ortho(this.projection,-1,1,-1,1,-1,1,e.capabilities.clipSpaceMinZ,e.capabilities.clipSpaceSignY,e.surfaceTransform)}init(){this.initLogo(),this.settings.displayWatermark&&this.initWarterMark();const t=e=>{if(this.cancelAnimate)return;const i=this.settings,n=this.device;$i.ortho(this.projection,-1,1,-1,1,-1,1,n.capabilities.clipSpaceMinZ,n.capabilities.clipSpaceSignY,n.surfaceTransform);const s=n.width,r=n.height,o=s<r?s:r;this.startTime<0&&(this.startTime=e);const a=e-this.startTime;let l=V_(mi(a/i.totalTime));"NONE"===i.effect&&(l=1);const c=this.logoTexture.width,h=this.logoTexture.height,_=o*i.displayRatio;let u=_*c/h,m=_;if(n.surfaceTransform!==Rs.ROTATE_90&&n.surfaceTransform!==Rs.ROTATE_270||(u=_*s/r,m=_*h/c*r/s),this.logoMat.setProperty("resolution",xw.set(s,r),0),this.logoMat.setProperty("scale",xw.set(u,m),0),this.logoMat.setProperty("translate",xw.set(.5*s,.5*r),0),this.logoMat.setProperty("precent",l),this.logoMat.setProperty("u_projection",this.projection),this.logoMat.passes[0].update(),i.displayWatermark&&this.watermarkMat){const t=.5*o,e=this.watermarkTexture.width;let i=t,a=t*this.watermarkTexture.height/e;n.surfaceTransform!==Rs.ROTATE_90&&n.surfaceTransform!==Rs.ROTATE_270||(i=.5*t,a=t*s/r*.5),this.watermarkMat.setProperty("resolution",xw.set(s,r),0),this.watermarkMat.setProperty("scale",xw.set(i,a),0),this.watermarkMat.setProperty("translate",xw.set(.5*s,.1*r),0),this.watermarkMat.setProperty("precent",l),this.watermarkMat.setProperty("u_projection",this.projection),this.watermarkMat.passes[0].update()}this.frame(),a>i.totalTime&&(this.splashFinish=!0),requestAnimationFrame(t)};n.game.pause(),this.handle=requestAnimationFrame(t)}hide(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))}initLogo(){const t=this.device;this.logoMat=new $g,this.logoMat.initialize({effectName:"splash-screen"});const e=new Nr;e.addressU=Ws.CLAMP,e.addressV=Ws.CLAMP,e.addressW=Ws.CLAMP,this.sampler=t.createSampler(e),this.logoTexture=t.createTexture(new Or(Us.TEX2D,Gs.SAMPLED|Gs.TRANSFER_DST,Os.RGBA8,this.logoImage.width,this.logoImage.height));const i=this.logoMat.passes[0],n=i.getBinding("mainTexture");i.bindTexture(n,this.logoTexture),this.shader=i.getShaderVariant();const s=i.descriptorSet;s.bindSampler(n,this.sampler),s.update();const r=new Cr;r.texExtent.width=this.logoImage.width,r.texExtent.height=this.logoImage.height,r.texExtent.depth=1,t.copyTexImagesToTexture([this.logoImage],this.logoTexture,[r])}initWarterMark(){const t=document.createElement("canvas");t.width=330,t.height=30,t.style.width=`${t.width}`,t.style.height=`${t.height}`;const e=t.getContext("2d");e.font="18px Arial",e.textBaseline="top",e.textAlign="left",e.fillStyle="`#424242`";const i="Powered by Cocos Creator",n=e.measureText(i);e.fillText(i,(330-n.width)/2,6);const s=new Cr;s.texExtent.width=t.width,s.texExtent.height=t.height,s.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new Or(Us.TEX2D,Gs.SAMPLED|Gs.TRANSFER_DST,Os.RGBA8,t.width,t.height)),this.device.copyTexImagesToTexture([t],this.watermarkTexture,[s]),this.watermarkMat=new $g,this.watermarkMat.initialize({effectName:"splash-screen"});const r=this.watermarkMat.passes[0],o=r.getBinding("mainTexture");r.bindTexture(o,this.watermarkTexture),r.descriptorSet.update()}frame(){const t=this.device;t.acquire();const e=this.cmdBuff,i=this.framebuffer,n=this.renderArea;n.width=t.width,n.height=t.height,e.begin(),e.beginRenderPass(i.renderPass,i,n,this.clearColors,1,0);const s=this.logoMat.passes[0],r=xT.getOrCreatePipelineState(t,s,this.shader,i.renderPass,this.quadAssmebler);if(e.bindPipelineState(r),e.bindDescriptorSet(hp.MATERIAL,s.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){const n=this.watermarkMat.passes[0],s=xT.getOrCreatePipelineState(t,n,this.shader,i.renderPass,this.quadAssmebler);e.bindPipelineState(s),e.bindDescriptorSet(hp.MATERIAL,n.descriptorSet),e.bindInputAssembler(this.quadAssmebler),e.draw(this.quadAssmebler)}e.endRenderPass(),e.end(),t.flushCommands([e]),t.queue.submit([e]),t.present()}destroy(){this.callBack=null,this.root=null,this.device=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler.destroy(),this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,bw._ins=void 0}static get instance(){return bw._ins||(bw._ins=new bw),bw._ins}constructor(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}}bw._ins=void 0,n.internal.SplashScreen=bw;class Sw{constructor(){this._id="",this._priority=0,this._executeInEditMode=!1}set priority(t){this._priority=t}get priority(){return this._priority}set id(t){this._id=t}get id(){return this._id}static sortByPriority(t,e){return t._priority<e._priority?1:t._priority>e.priority?-1:0}init(){}update(t){}postUpdate(t){}}t("System",Sw),Sw.Priority=Nt({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});const Aw=new X("Scheduler");class Cw{constructor(t,e,i,n){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=t,this.priority=e,this.paused=i,this.markedForDeletion=n}}Cw.get=(t,e,i,n)=>{let s=Cw._listEntries.pop();return s?(s.target=t,s.priority=e,s.paused=i,s.markedForDeletion=n):s=new Cw(t,e,i,n),s},Cw.put=t=>{Cw._listEntries.length<20&&(t.target=null,Cw._listEntries.push(t))},Cw._listEntries=[];class Tw{constructor(t,e,i,n){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=t,this.entry=e,this.target=i,this.callback=n}}Tw.get=(t,e,i,n)=>{let s=Tw._hashUpdateEntries.pop();return s?(s.list=t,s.entry=e,s.target=i,s.callback=n):s=new Tw(t,e,i,n),s},Tw.put=t=>{Tw._hashUpdateEntries.length<20&&(t.list=t.entry=t.target=t.callback=null,Tw._hashUpdateEntries.push(t))},Tw._hashUpdateEntries=[];class ww{constructor(t,e,i,n,s,r){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=t,this.target=e,this.timerIndex=i,this.currentTimer=n,this.currentTimerSalvaged=s,this.paused=r}}ww.get=(t,e,i,n,s,r)=>{let o=ww._hashTimerEntries.pop();return o?(o.timers=t,o.target=e,o.timerIndex=i,o.currentTimer=n,o.currentTimerSalvaged=s,o.paused=r):o=new ww(t,e,i,n,s,r),o},ww.put=t=>{ww._hashTimerEntries.length<20&&(t.timers=t.target=t.currentTimer=null,ww._hashTimerEntries.push(t))},ww._hashTimerEntries=[];class Ew{constructor(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}initWithCallback(t,e,i,s,r,o){return this._lock=!1,this._scheduler=t,this._target=i,this._callback=e,this._elapsed=-1,this._interval=s,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===n.macro.REPEAT_FOREVER,!0}getInterval(){return this._interval}setInterval(t){this._interval=t}update(t){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=t,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))}getCallback(){return this._callback}trigger(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)}cancel(){this._scheduler.unschedule(this._callback,this._target)}}Ew._timers=[],Ew.get=()=>Ew._timers.pop()||new Ew,Ew.put=t=>{Ew._timers.length<20&&!t._lock&&(t._scheduler=t._target=t._callback=null,Ew._timers.push(t))};class Pw extends Sw{static enableForTarget(t){let e=!1;(t.uuid||t.id)&&(e=!0),e||(t.__instanceId?A(1513):t.id=Aw.getNewId())}constructor(){super(),this._timeScale=void 0,this._updatesNegList=void 0,this._updates0List=void 0,this._updatesPosList=void 0,this._hashForUpdates=void 0,this._hashForTimers=void 0,this._currentTarget=void 0,this._currentTargetSalvaged=void 0,this._updateHashLocked=void 0,this._arrayForTimers=void 0,this._timeScale=1,this._updatesNegList=[],this._updates0List=[],this._updatesPosList=[],this._hashForUpdates=st(!0),this._hashForTimers=st(!0),this._currentTarget=null,this._currentTargetSalvaged=!1,this._updateHashLocked=!1,this._arrayForTimers=[]}setTimeScale(t){this._timeScale=t}getTimeScale(){return this._timeScale}update(t){let e,i,n,s,r;for(this._updateHashLocked=!0,1!==this._timeScale&&(t*=this._timeScale),e=0,i=this._updatesNegList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updates0List,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);for(e=0,i=this._updatesPosList,n=i.length;e<n;e++)s=i[e],s.paused||s.markedForDeletion||s.target.update(t);const o=this._arrayForTimers;for(e=0;e<o.length;e++){if(r=o[e],this._currentTarget=r,this._currentTargetSalvaged=!1,!r.paused)for(r.timerIndex=0;r.timerIndex<r.timers.length;++r.timerIndex)r.currentTimer=r.timers[r.timerIndex],r.currentTimerSalvaged=!1,r.currentTimer.update(t),r.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--e)}for(e=0,i=this._updatesNegList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updates0List;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;for(e=0,i=this._updatesPosList;e<i.length;)s=i[e],s.markedForDeletion?this._removeUpdateFromHash(s):e++;this._updateHashLocked=!1,this._currentTarget=null}schedule(t,e,i,s,r,o){if("function"!=typeof t){const i=t;t=e,e=i}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!s,s=n.macro.REPEAT_FOREVER,r=0),E(e,1502);const a=e.uuid||e.id;if(!a)return void T(1510);let l,c,h=this._hashForTimers[a];if(h?h.paused!==o&&A(1511):(h=ww.get(null,e,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[a]=h),null==h.timers)h.timers=[];else for(c=0;c<h.timers.length;++c)if(l=h.timers[c],l&&t===l._callback)return b(1507,l.getInterval(),i),void(l._interval=i);l=Ew.get(),l.initWithCallback(this,t,e,i,s,r),h.timers.push(l),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}scheduleUpdate(t,e,i){const n=t.uuid||t.id;if(!n)return void T(1510);const s=this._hashForUpdates[n];if(s&&s.entry){if(s.entry.priority===e)return s.entry.markedForDeletion=!1,void(s.entry.paused=i);if(this._updateHashLocked)return b(1506),s.entry.markedForDeletion=!1,void(s.entry.paused=i);this.unscheduleUpdate(t)}const r=Cw.get(t,e,i,!1);let o;0===e?(o=this._updates0List,this._appendIn(o,r)):(o=e<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,r,e)),this._hashForUpdates[n]=Tw.get(o,r,t,null)}unschedule(t,e){if(!e||!t)return;const i=e.uuid||e.id;if(!i)return void T(1510);const n=this._hashForTimers[i];if(n){const e=n.timers;for(let i=0,s=e.length;i<s;i++){const s=e[i];if(t===s._callback)return s!==n.currentTimer||n.currentTimerSalvaged||(n.currentTimerSalvaged=!0),e.splice(i,1),Ew.put(s),n.timerIndex>=i&&n.timerIndex--,void(0===e.length&&(this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)))}}}unscheduleUpdate(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForUpdates[e];i&&(this._updateHashLocked?i.entry.markedForDeletion=!0:this._removeUpdateFromHash(i.entry))}unscheduleAllForTarget(t){if(!t)return;const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];if(i){const t=i.timers;t.indexOf(i.currentTimer)>-1&&!i.currentTimerSalvaged&&(i.currentTimerSalvaged=!0);for(let e=0,i=t.length;e<i;e++)Ew.put(t[e]);t.length=0,this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)}this.unscheduleUpdate(t)}unscheduleAll(){this.unscheduleAllWithMinPriority(Sw.Priority.SCHEDULER)}unscheduleAllWithMinPriority(t){let e,i;const n=this._arrayForTimers;for(e=n.length-1;e>=0;e--)i=n[e],this.unscheduleAllForTarget(i.target);let s,r=0;if(t<0)for(e=0;e<this._updatesNegList.length;)r=this._updatesNegList.length,s=this._updatesNegList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesNegList.length&&e++;if(t<=0)for(e=0;e<this._updates0List.length;)r=this._updates0List.length,s=this._updates0List[e],s&&this.unscheduleUpdate(s.target),r===this._updates0List.length&&e++;for(e=0;e<this._updatesPosList.length;)r=this._updatesPosList.length,s=this._updatesPosList[e],s&&s.priority>=t&&this.unscheduleUpdate(s.target),r===this._updatesPosList.length&&e++}isScheduled(t,e){E(t,1508),E(e,1509);const i=e.uuid||e.id;if(!i)return T(1510),!1;const n=this._hashForTimers[i];if(!n)return!1;if(null==n.timers)return!1;{const e=n.timers;for(let i=0;i<e.length;++i)if(t===e[i]._callback)return!0;return!1}}pauseAllTargets(){return this.pauseAllTargetsWithMinPriority(Sw.Priority.SCHEDULER)}pauseAllTargetsWithMinPriority(t){const e=[];let i;const n=this._arrayForTimers;let s,r,o;for(s=0,r=n.length;s<r;s++)i=n[s],i&&(i.paused=!0,e.push(i.target));if(t<0)for(s=0;s<this._updatesNegList.length;s++)o=this._updatesNegList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));if(t<=0)for(s=0;s<this._updates0List.length;s++)o=this._updates0List[s],o&&(o.paused=!0,e.push(o.target));for(s=0;s<this._updatesPosList.length;s++)o=this._updatesPosList[s],o&&o.priority>=t&&(o.paused=!0,e.push(o.target));return e}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)this.resumeTarget(t[e])}pauseTarget(t){E(t,1503);const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];i&&(i.paused=!0);const n=this._hashForUpdates[e];n&&(n.entry.paused=!0)}resumeTarget(t){E(t,1504);const e=t.uuid||t.id;if(!e)return void T(1510);const i=this._hashForTimers[e];i&&(i.paused=!1);const n=this._hashForUpdates[e];n&&(n.entry.paused=!1)}isTargetPaused(t){E(t,1505);const e=t.uuid||t.id;if(!e)return T(1510),!1;const i=this._hashForTimers[e];if(i)return i.paused;const n=this._hashForUpdates[e];return!!n&&n.entry.paused}_removeHashElement(t){const e=t.target.uuid||t.target.id;delete this._hashForTimers[e];const i=this._arrayForTimers;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}ww.put(t)}_removeUpdateFromHash(t){const e=t.target.uuid||t.target.id,i=this._hashForUpdates[e];if(i){const t=i.list,n=i.entry;for(let e=0,i=t.length;e<i;e++)if(t[e]===n){t.splice(e,1);break}delete this._hashForUpdates[e],Cw.put(n),Tw.put(i)}}_priorityIn(t,e,i){for(let n=0;n<t.length;n++)if(i<t[n].priority)return void t.splice(n,0,e);t.push(e)}_appendIn(t,e){t.push(e)}}t("Scheduler",Pw),Pw.ID="scheduler",n.Scheduler=Pw;class Dw{get width(){return this._width}get height(){return this._height}get framebuffer(){return this._framebuffer}get shouldSyncSizeWithSwapchain(){return this._shouldSyncSizeWithSwapchain}get hasOnScreenAttachments(){return this._hasOnScreenAttachments}get hasOffScreenAttachments(){return this._hasOffScreenAttachments}get cameras(){return this._cameras}static registerCreateFunc(t){t._createWindowFun=t=>new Dw(t)}get native(){return this._nativeObj}constructor(t){this._title="",this._width=1,this._height=1,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._swapchainBufferIndices=0,this._shouldSyncSizeWithSwapchain=!1,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}_setHasOffScreenAttachments(t){this._hasOffScreenAttachments=t,this._nativeObj.hasOffScreenAttachments=t}_setHasOnScreenAttachments(t){this._hasOnScreenAttachments=t,this._nativeObj.hasOnScreenAttachments=t}_createFrameBuffer(t,e){this._framebuffer=t.createFramebuffer(new eo(e,this._colorTextures,this._depthStencilTexture)),this._nativeObj.frameBuffer=this._framebuffer}_init(){this._nativeObj=new Kn}initialize(t,e){this._init(),void 0!==e.title&&(this._title=e.title),void 0!==e.swapchainBufferIndices&&(this._swapchainBufferIndices=e.swapchainBufferIndices),void 0!==e.shouldSyncSizeWithSwapchain&&(this._shouldSyncSizeWithSwapchain=e.shouldSyncSizeWithSwapchain),this._width=e.width,this._height=e.height;const{colorAttachments:i,depthStencilAttachment:n}=e.renderPassInfo;for(let e=0;e<i.length;e++)i[e].format===Os.UNKNOWN&&(i[e].format=t.colorFormat);n&&n.format===Os.UNKNOWN&&(n.format=t.depthStencilFormat),this._renderPass=t.createRenderPass(e.renderPassInfo);for(let e=0;e<i.length;e++){let n=null;this._swapchainBufferIndices&1<<e?this._setHasOnScreenAttachments(!0):(n=t.createTexture(new Or(Us.TEX2D,Gs.COLOR_ATTACHMENT|Gs.SAMPLED,i[e].format,this._width,this._height)),this._setHasOffScreenAttachments(!0)),this._colorTextures.push(n)}return n?this._swapchainBufferIndices>=0&&(this._depthStencilTexture=t.createTexture(new Or(Us.TEX2D,Gs.DEPTH_STENCIL_ATTACHMENT|Gs.SAMPLED,n.format,this._width,this._height)),this._setHasOffScreenAttachments(!0)):this._setHasOnScreenAttachments(!0),this._createFrameBuffer(t,this._renderPass),!0}_destroy(){this.framebuffer.destroy(),this._nativeObj=null}destroy(){this.clearCameras(),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(let t=0;t<this._colorTextures.length;t++){const e=this._colorTextures[t];e&&e.destroy()}this._colorTextures.length=0,this._destroy()}resize(t,e){this._width=t,this._height=e;let i=!1;this._depthStencilTexture&&(this._depthStencilTexture.resize(t,e),i=!0);for(let n=0;n<this._colorTextures.length;n++){const s=this._colorTextures[n];s&&(s.resize(t,e),i=!0)}const n=this.framebuffer;i&&n&&(n.destroy(),n.initialize(new eo(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(const i of this._cameras)i.isWindowSize&&i.resize(t,e)}extractRenderCameras(t){for(let e=0;e<this._cameras.length;e++){const i=this._cameras[e];i.enabled&&(i.update(),t.push(i))}}attachCamera(t){for(let e=0;e<this._cameras.length;e++)if(this._cameras[e]===t)return;this._cameras.push(t),this.sortCameras()}detachCamera(t){for(let e=0;e<this._cameras.length;++e)if(this._cameras[e]===t)return void this._cameras.splice(e,1)}clearCameras(){this._cameras.length=0}sortCameras(){this._cameras.sort(((t,e)=>t.priority-e.priority))}}class Iw{_init(){this._naitveObj=new ts}_destroy(){this._naitveObj=null}_setCumulativeTime(t){this._cumulativeTime+=t,this._naitveObj.cumulativeTime=this._cumulativeTime}_setFrameTime(t){this._frameTime=t,this._naitveObj.frameTime=t}get device(){return this._device}get mainWindow(){return this._mainWindow}set curWindow(t){this._curWindow=t}get curWindow(){return this._curWindow}set tempWindow(t){this._tempWindow=t}get tempWindow(){return this._tempWindow}get windows(){return this._windows}get pipeline(){return this._pipeline}get batcher2D(){return this._batcher}get scenes(){return this._scenes}get cumulativeTime(){return this._cumulativeTime}get frameTime(){return this._frameTime}get frameCount(){return this._frameCount}get fps(){return this._fps}set fixedFPS(t){t>0?(this._fixedFPS=t,this._fixedFPSFrameTime=1e3/t):this._fixedFPSFrameTime=0}get fixedFPS(){return this._fixedFPS}get dataPoolManager(){return this._dataPoolMgr}get useDeferredPipeline(){return this._useDeferredPipeline}constructor(t){this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=t,this._dataPoolMgr=n.internal.DataPoolManager&&new n.internal.DataPoolManager(t),Ag.registerCreateFunc(this),Dw.registerCreateFunc(this),this._cameraPool=new z((()=>new Id(this._device)),4)}initialize(t){this._init();const e=new Yr,i=new Kr;i.depthStoreOp=Qs.DISCARD,i.stencilStoreOp=Qs.DISCARD;const s=new Zr([e],i);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:this._device.width,height:this._device.height,renderPassInfo:s,swapchainBufferIndices:-1}),this._curWindow=this._mainWindow,Promise.resolve(rg.initBuiltinRes(this._device)).then((()=>{n.view.on("design-resolution-changed",(()=>{const t=n.game.canvas.width,e=n.game.canvas.height;this.resize(t,e)}),this)}))}destroy(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()}resize(t,e){this._device.resize(t,e),this._mainWindow.resize(t,e);for(const i of this._windows)i.shouldSyncSizeWithSwapchain&&i.resize(t,e);this._pipeline&&this._pipeline.resize(t,e)}setRenderPipeline(t){if(t instanceof IT&&(this._useDeferredPipeline=!0),t||(t=ST()),this._pipeline=t,!this._pipeline.activate())return!1;const e=n.director.getScene();return e&&e.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&n.internal.Batcher2D&&(this._batcher=new n.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))}onGlobalPipelineStateChanged(){for(let t=0;t<this._scenes.length;t++)this._scenes[t].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()}activeWindow(t){this._curWindow=t}resetCumulativeTime(){this._setCumulativeTime(0)}frameMove(t){this._setFrameTime(t),++this._frameCount,this._setCumulativeTime(t),this._fpsTime+=t,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(let t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();this._batcher&&this._batcher.update();const e=this._windows,i=[];for(let t=0;t<e.length;t++)e[t].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire();const t=this._scenes,e=n.director.getTotalFrames();this._batcher&&this._batcher.uploadBuffers();for(let i=0;i<t.length;i++)t[i].update(e);n.director.emit(n.Director.EVENT_BEFORE_COMMIT),i.sort(((t,e)=>t.priority-e.priority)),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()}createWindow(t){const e=this._createWindowFun(this);return e.initialize(this.device,t),this._windows.push(e),e}destroyWindow(t){for(let e=0;e<this._windows.length;++e)if(this._windows[e]===t)return t.destroy(),void this._windows.splice(e,1)}destroyWindows(){for(const t of this._windows)t.destroy();this._windows=[]}createScene(t){const e=this._createSceneFun(this);return e.initialize(t),this._scenes.push(e),e}destroyScene(t){for(let e=0;e<this._scenes.length;++e)if(this._scenes[e]===t)return t.destroy(),void this._scenes.splice(e,1)}destroyScenes(){for(const t of this._scenes)t.destroy();this._scenes=[]}createModel(t){let e=this._modelPools.get(t);e||(this._modelPools.set(t,new z((()=>new t),10)),e=this._modelPools.get(t));const i=e.alloc();return i.initialize(),i}destroyModel(t){const e=this._modelPools.get(t.constructor);e?(e.free(t),t.destroy(),t.scene&&t.scene.removeModel(t)):A(1300,t.constructor.name)}createCamera(){return this._cameraPool.alloc()}createLight(t){let e=this._lightPools.get(t);e||(this._lightPools.set(t,new z((()=>new t),4)),e=this._lightPools.get(t));const i=e.alloc();return i.initialize(),i}destroyLight(t){const e=this._lightPools.get(t.constructor);if(t.destroy(),e&&(e.free(t),t.scene))switch(t.type){case Eg.SPHERE:t.scene.removeSphereLight(t);break;case Eg.SPOT:t.scene.removeSpotLight(t)}}}n.Root=Iw;class Rw extends He{constructor(){super(),this._compScheduler=void 0,this._nodeActivator=void 0,this._invalid=void 0,this._paused=void 0,this._root=void 0,this._loadingScene=void 0,this._scene=void 0,this._totalFrames=void 0,this._scheduler=void 0,this._systems=void 0,this._invalid=!1,this._paused=!1,this._root=null,this._loadingScene="",this._scene=null,this._totalFrames=0,this._scheduler=new Pw,this._compScheduler=new KC,this._nodeActivator=new rT,this._systems=[],_w.once(hw.EVENT_RENDERER_INITED,this._initOnRendererInitialized,this)}calculateDeltaTime(t){}convertToGL(t){const e=_w.container,i=n.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=i._devicePixelRatio*(t.x-r),l=i._devicePixelRatio*(o+s.height-t.y);return i._isRotated?sn(i._viewportRect.width-l,a):sn(a,l)}convertToUI(t){const e=_w.container,i=n.view,s=e.getBoundingClientRect(),r=s.left+window.pageXOffset-e.clientLeft,o=s.top+window.pageYOffset-e.clientTop,a=sn(0,0);return i._isRotated?(a.x=r+t.y/i._devicePixelRatio,a.y=o+s.height-(i._viewportRect.width-t.x)/i._devicePixelRatio):(a.x=r+t.x*i._devicePixelRatio,a.y=o+s.height-t.y*i._devicePixelRatio),a}end(){this.once(Rw.EVENT_END_FRAME,(()=>{this.purgeDirector()}))}pause(){this._paused||(this._paused=!0)}purgeDirector(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),tv&&tv.setEnabled(!1),n.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),n.assetManager.releaseAll()}reset(){this.purgeDirector(),this.emit(Rw.EVENT_RESET),tv&&tv.setEnabled(!0),this.startAnimation()}runSceneImmediate(t,e,i){t instanceof cT&&(t=t.scene),E(t instanceof OC,1216),t._load();const s=Object.keys(_w._persistRootNodes).map((t=>_w._persistRootNodes[t]));for(let e=0;e<s.length;e++){const i=s[e];i.emit(n.Node.SCENE_CHANGED_FOR_PERSISTS,t.renderScene);const r=t.uuid===i._originalSceneId&&t.getChildByUuid(i.uuid);if(r){const e=r.getSiblingIndex();r._destroyImmediate(),t.insertChild(i,e)}else i.parent=t}const r=this._scene;n.isValid(r)&&r.destroy(),n.assetManager._releaseManager._autoRelease(r,t,_w._persistRootNodes),this._scene=null,Me._deferredDestroy(),e&&e(),this.emit(n.Director.EVENT_BEFORE_SCENE_LAUNCH,t),this._scene=t,t._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),i&&i(null,t),this.emit(n.Director.EVENT_AFTER_SCENE_LAUNCH,t)}runScene(t,e,i){t instanceof cT&&(t=t.scene),E(t,1205),E(t instanceof OC,1216),t._load(),this.once(n.Director.EVENT_END_FRAME,(()=>{this.runSceneImmediate(t,e,i)}))}loadScene(t,e,i){if(this._loadingScene)return A(1208,t,this._loadingScene),!1;const s=n.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));return s?(this.emit(n.Director.EVENT_BEFORE_SCENE_LOADING,t),this._loadingScene=t,console.time(`LoadScene ${t}`),s.loadScene(t,((n,s)=>{console.timeEnd(`LoadScene ${t}`),this._loadingScene="",n?(p(n),e&&e(n)):this.runSceneImmediate(s,i,e)})),!0):(T(1209,t),!1)}preloadScene(t,e,i){const s=n.assetManager.bundles.find((e=>!!e.getSceneInfo(t)));if(s)s.preloadScene(t,null,e,i);else{const e=`Can not preload the scene "${t}" because it is not in the build settings.`;i&&i(new Error(e)),p(`preloadScene: ${e}`)}}resume(){this._paused&&(this._paused=!1)}get root(){return this._root}getScene(){return this._scene}getDeltaTime(){return _w.deltaTime}getTotalTime(){return _w.totalTime}getCurrentTime(){return _w.frameStartTime}getTotalFrames(){return this._totalFrames}isPaused(){return this._paused}getScheduler(){return this._scheduler}setScheduler(t){this._scheduler!==t&&(this.unregisterSystem(this._scheduler),this._scheduler=t,this.registerSystem(Pw.ID,t,200))}registerSystem(t,e,i){e.id=t,e.priority=i,e.init(),this._systems.push(e),this._systems.sort(Sw.sortByPriority)}unregisterSystem(t){Mt.fastRemove(this._systems,t),this._systems.sort(Sw.sortByPriority)}getSystem(t){return this._systems.find((e=>e.id===t))}getAnimationManager(){return this.getSystem(n.AnimationManager.ID)}startAnimation(){this._invalid=!1}stopAnimation(){this._invalid=!0}mainLoop(t){let e;e=_w._calculateDT(t),this.tick(e)}tick(t){if(!this._invalid){if(this.emit(Rw.EVENT_BEGIN_FRAME),nw.frameDispatchEvents(),!this._paused){this.emit(Rw.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(t);for(let e=0;e<this._systems.length;++e)this._systems[e].update(t);this._compScheduler.lateUpdatePhase(t),this.emit(Rw.EVENT_AFTER_UPDATE),Me._deferredDestroy();for(let e=0;e<this._systems.length;++e)this._systems[e].postUpdate(t)}this.emit(Rw.EVENT_BEFORE_DRAW),this._root.frameMove(t),this.emit(Rw.EVENT_AFTER_DRAW),tv.frameUpdateListeners(),Yv.resetHasChangedFlags(),Yv.clearNodeArray(),this.emit(Rw.EVENT_END_FRAME),this._totalFrames++}}_initOnRendererInitialized(){this._totalFrames=0,this._paused=!1,tv&&tv.setEnabled(!0),this.registerSystem(Pw.ID,this._scheduler,200),this.emit(Rw.EVENT_INIT)}_init(){return this._root=new Iw(_w._gfxDevice),this._root.initialize({}).catch((t=>(T(1217),Promise.reject(t))))}}t("Director",Rw),Rw.EVENT_INIT="director_init",Rw.EVENT_RESET="director_reset",Rw.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",Rw.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",Rw.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",Rw.EVENT_BEFORE_UPDATE="director_before_update",Rw.EVENT_AFTER_UPDATE="director_after_update",Rw.EVENT_BEFORE_DRAW="director_before_draw",Rw.EVENT_AFTER_DRAW="director_after_draw",Rw.EVENT_BEFORE_COMMIT="director_before_commit",Rw.EVENT_BEFORE_PHYSICS="director_before_physics",Rw.EVENT_AFTER_PHYSICS="director_after_physics",Rw.EVENT_BEGIN_FRAME="director_begin_frame",Rw.EVENT_END_FRAME="director_end_frame",Rw.instance=void 0,n.Director=Rw;const Mw=t("director",Rw.instance=n.director=new Rw),Ow={};Ze(Ow,"vmath",[{name:"vec2",newName:"Vec2",target:un,targetName:"math"},{name:"vec3",newName:"Vec3",target:un,targetName:"math"},{name:"vec4",newName:"Vec4",target:un,targetName:"math"},{name:"quat",newName:"Quat",target:un,targetName:"math"},{name:"mat3",newName:"Mat3",target:un,targetName:"math"},{name:"mat4",newName:"Mat4",target:un,targetName:"math"},{name:"color4",newName:"Color",target:un,targetName:"math"},{name:"rect",newName:"Rect",target:un,targetName:"math"},{name:"approx",newName:"approx",target:un,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:un,targetName:"math"},{name:"equals",newName:"equals",target:un,targetName:"math"},{name:"clamp",newName:"clamp",target:un,targetName:"math"},{name:"clamp01",newName:"clamp01",target:un,targetName:"math"},{name:"lerp",newName:"lerp",target:un,targetName:"math"},{name:"toRadian",newName:"toRadian",target:un,targetName:"math"},{name:"toDegree",newName:"toDegree",target:un,targetName:"math"},{name:"random",newName:"random",target:un,targetName:"math"},{name:"randomRange",newName:"randomRange",target:un,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:un,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:un,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:un,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:un,targetName:"math"},{name:"repeat",newName:"repeat",target:un,targetName:"math"},{name:"pingPong",newName:"pingPong",target:un,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:un,targetName:"math"}]),n.vmath=Ow,Ze(Pw.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:Pw,targetName:"Scheduler"}]),Ze(Pw,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:()=>Sw.Priority.SCHEDULER}]),Qe(Pw,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),Ze(YT.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:YT,targetName:"EventTouch"}]),Ze(mg.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),Qe(mg.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),Ze(Iw.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),ti(_w,"game",[{name:"collisionMatrix"},{name:"groupList"}]),ti(Rw.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),Qe(Rw.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"}]);class Bw{constructor(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new Mc,this.scenes=new Mc,this.paths=new Mc}init(t){(t=>{let e=t.uuids;const i=t.paths,n=t.types,s=t.deps,r=t.paths=Object.create(null);if(!1===t.debug){for(let t=0,i=e.length;t<i;t++)e[t]=Kc(e[t]);for(const t in i){const e=i[t],s=e[1];e[1]=n[s]}}else{const t=Object.create(null);for(let i=0,n=e.length;i<n;i++){const n=e[i];e[i]=t[n]=Kc(n)}e=t}for(const t in i){const n=i[t];r[e[t]]=n}const o=t.scenes;for(const t in o){const i=o[t];o[t]=e[i]}const a=t.packs;for(const t in a){const i=a[t];for(let t=0;t<i.length;++t)i[t]=e[i[t]]}const l=t.versions;if(l)for(const t in l){const i=l[t];for(let t=0;t<i.length;t+=2){const n=i[t];i[t]=e[n]||n}}const c=t.redirect;if(c)for(let t=0;t<c.length;t+=2)c[t]=e[c[t]],c[t+1]=s[c[t+1]];if(t.extensionMap)for(const i in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,i)&&t.extensionMap[i].forEach(((n,s)=>{t.extensionMap[i][s]=e[n]||n}))})(t),this.importBase=t.importBase||"",this.nativeBase=t.nativeBase||"",this.base=t.base||"",this.name=t.name||"",this.deps=t.deps||[],this._initUuid(t.uuids),this._initPath(t.paths),this._initScene(t.scenes),this._initPackage(t.packs),this._initVersion(t.versions),this._initRedirect(t.redirect);for(const e in t.extensionMap)Object.prototype.hasOwnProperty.call(t.extensionMap,e)&&t.extensionMap[e].forEach((t=>{const i=this.assetInfos.get(t);i&&(i.extension=e)}))}getInfoWithPath(t,e){if(!t)return null;t=th(t);const i=this.paths.get(t);if(i){if(!e)return i[0];for(let t=0,n=i.length;t<n;t++){const n=i[t];if(Ot.isChildClassOf(n.ctor,e))return n}}return null}getDirWithPath(t,e,i){"/"===(t=th(t))[t.length-1]&&(t=t.slice(0,-1));const n=i||[];return this.paths.forEach(((i,s)=>{if(s.startsWith(t)&&((t,e)=>!(t.length>e.length)||47===t.charCodeAt(e.length))(s,t)||!t)for(let t=0,s=i.length;t<s;t++){const s=i[t];e&&!Ot.isChildClassOf(s.ctor,e)||n.push(s)}})),n}getAssetInfo(t){return this.assetInfos.get(t)||null}getSceneInfo(t){return t.endsWith(".scene")||(t+=".scene"),"/"===t[0]||t.startsWith("db://")||(t=`/${t}`),this.scenes.find(((e,i)=>i.endsWith(t)))}destroy(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()}_initUuid(t){if(t){this.assetInfos.clear();for(let e=0,i=t.length;e<i;e++){const i=t[e];this.assetInfos.add(i,{uuid:i})}}}_initPath(t){if(!t)return;const e=this.paths;e.clear();for(const i in t){const n=t[i],s=n[0],r=n[1],o=3===n.length,a=this.assetInfos.get(i);a.path=s,a.ctor=Ot._getClassById(r),e.has(s)?o?e.get(s).push(a):e.get(s).unshift(a):e.add(s,[a])}}_initScene(t){if(!t)return;const e=this.scenes;e.clear();const i=this.assetInfos;for(const n in t){const s=t[n],r=i.get(s);r.url=n,e.add(n,r)}}_initPackage(t){if(!t)return;const e=this.assetInfos;for(const i in t){const n=t[i],s={uuid:i,packedUuids:n,ext:".json"};e.add(i,s);for(let t=0,i=n.length;t<i;t++){const r=n[t],o=e.get(r),a=o.packs;a?1===i?a.unshift(s):a.push(s):o.packs=[s]}}}_initVersion(t){if(!t)return;const e=this.assetInfos;let i=t.import;if(i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).ver=i[t+1]}if(i=t.native,i)for(let t=0,n=i.length;t<n;t+=2){const n=i[t];e.get(n).nativeVer=i[t+1]}}_initRedirect(t){if(!t)return;const e=this.assetInfos;for(let i=0,n=t.length;i<n;i+=2){const n=t[i];e.get(n).redirect=t[i+1]}}}function Nw(t,e){t._uuid&&e.push(t._uuid)}function Lw(t,e){const i=Object.getOwnPropertyNames(t);for(let n=0;n<i.length;n++){const s=i[n];if("node"===s||"__eventTargets"===s)continue;const r=t[s];if("object"==typeof r&&r)if(Array.isArray(r))for(let t=0;t<r.length;t++){const i=r[t];i instanceof _h&&Nw(i,e)}else if(r.constructor&&r.constructor!==Object)r instanceof _h&&Nw(r,e);else{const t=Object.getOwnPropertyNames(r);for(let i=0;i<t.length;i++){const n=r[t[i]];n instanceof _h&&Nw(n,e)}}}}function Fw(t,e){for(let i=0;i<t._components.length;i++)Lw(t._components[i],e);for(let i=0;i<t._children.length;i++)Fw(t._children[i],e)}function zw(t,e,i,n){i.push(t._uuid);const s=pf.getDeps(t._uuid);for(let t=0,r=s.length;t<r;t++){const r=Bc.get(s[t]);if(!r)continue;const o=r._uuid;o in e?e[o]+=n:e[o]=r.refCount+n,i.includes(o)||zw(r,e,i,n)}}const Vw=[];var Uw=new class{constructor(){this._persistNodeDeps=new Mc,this._toDelete=new Mc,this._eventListener=!1}init(){this._persistNodeDeps.clear(),this._toDelete.clear()}_addPersistNodeRef(t){const e=[];Fw(t,e);for(let t=0,i=e.length;t<i;t++){const i=Bc.get(e[t]);i&&i.addRef()}this._persistNodeDeps.add(t.uuid,e)}_removePersistNodeRef(t){if(!this._persistNodeDeps.has(t.uuid))return;const e=this._persistNodeDeps.get(t.uuid);for(let t=0,i=e.length;t<i;t++){const i=Bc.get(e[t]);i&&i.decRef()}this._persistNodeDeps.remove(t.uuid)}_autoRelease(t,e,i){if(t){const i=pf.getDeps(t.uuid);for(let e=0,n=i.length;e<n;e++){const n=Bc.get(i[e]);n&&n.decRef(t.autoReleaseAssets)}const n=pf._depends.get(t.uuid);if(n&&n.persistDeps){const e=n.persistDeps;for(let i=0,n=e.length;i<n;i++){const n=Bc.get(e[i]);n&&n.decRef(t.autoReleaseAssets)}}t.uuid!==e.uuid&&pf.remove(t.uuid)}const n=pf._depends.get(e.uuid);n&&(n.persistDeps=[]);for(const t in i){const e=i[t],s=this._persistNodeDeps.get(e.uuid);for(const t of s){const e=Bc.get(t);e&&e.addRef()}n&&n.persistDeps.push(...s)}}tryRelease(t,e=!1){t instanceof _h&&(e?this._free(t,e):(this._toDelete.add(t._uuid,t),this._eventListener||(this._eventListener=!0,Yt(this._freeAssets.bind(this)))))}_freeAssets(){this._eventListener=!1,this._toDelete.forEach((t=>{this._free(t)})),this._toDelete.clear()}_free(t,e=!1){const i=t._uuid;if(this._toDelete.remove(i),!Be(t,!0))return;if(!e&&t.refCount>0&&function(t){const e=Object.create(null);if(e[t._uuid]=t.refCount,zw(t,e,Vw,-1),Vw.length=0,0!==e[t._uuid])return e[t._uuid];for(const t in e)0!==e[t]&&zw(Bc.get(t),e,Vw,1);return Vw.length=0,e[t._uuid]}(t)>0)return;Bc.remove(i);const n=pf.getDeps(i);for(let t=0,e=n.length;t<e;t++){const e=Bc.get(n[t]);e&&(e.decRef(!1),this._free(e,!1))}t.destroy(),pf.remove(i)}};let Gw=null;function kw(t,e){for(let i=0,n=t.input.length;i<n;i++){const n=t.input[i];e&&!n.isNative&&n.content instanceof _h&&n.content.decRef(!1),n.recycle()}t.input=null}function Hw(t,e){return e?/\?/.test(t)?`${t}&_t=${Date.now()}`:`${t}?_t=${Date.now()}`:t}function jw(t,e,i,n,s=0){t(s,((r,o)=>{s++,!r||s>e?n&&n(r,o):setTimeout((()=>{jw(t,e,i,n,s)}),i)}))}function Ww(t,e,i,n,s){try{const r=pf.parse(t,e);for(let t=0,e=r.deps.length;t<e;t++){const e=r.deps[t];e in i||(i[e]=!0,n.push({uuid:e,bundle:s&&s.name}))}r.nativeDep&&(s&&(r.nativeDep.bundle=s.name),n.push({...r.nativeDep}))}catch(t){p(t.message,t.stack)}}function qw(t,e,i){e&&(i=void 0!==i?i:n.assetManager.cacheAsset,Qc(e)||!i||e.isDefault||Bc.add(t,e))}function Xw(t,e,i){let n=0;const s=[],r=t.length;0===r&&i&&i(s);const o=t=>{t&&s.push(t),n++,n===r&&i&&i(s)};for(let i=0;i<r;i++)e(t[i],o)}function Yw(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i="function"==typeof t;e?(r=e,i||(s=null)):void 0===e&&i&&(r=t,n=null,s=null),void 0!==e&&i&&(s=t,n=null)}return{options:n||Object.create(null),onProgress:s,onComplete:r}}function Kw(t,e,i){let n=t,s=e,r=i;if(void 0===i){const i=Ot.isChildClassOf(t,_h);e?(r=e,i&&(s=null)):void 0!==e||i||(r=t,s=null,n=null),void 0===e||i||(s=t,n=null)}return{type:n,onProgress:s||Gw,onComplete:r}}function $w(t,e,i,n={}){if(!i[e]||n[e])return!1;n[e]=!0;let s=!1;const r=pf.getDeps(e);if(r)for(let e=0,o=r.length;e<o;e++){const o=r[e];if(o===t||$w(t,o,i,n)){s=!0;break}}return s}function Jw(t){return(e,i)=>{if(!t)return;const n=[];Array.isArray(i)?i.forEach((t=>t instanceof _h&&n.push(t.addRef()))):i instanceof _h&&n.push(i.addRef()),Yt((()=>{n.forEach((t=>t.decRef(!1))),t(e,i)}))}}class Zw{constructor(){this._config=new Bw}get config(){return this._config}get name(){return this._config.name}get deps(){return this._config.deps}get base(){return this._config.base}getInfoWithPath(t,e){return this._config.getInfoWithPath(t,e)}getDirWithPath(t,e,i){return this._config.getDirWithPath(t,e,i)}getAssetInfo(t){return this._config.getAssetInfo(t)}getSceneInfo(t){return this._config.getSceneInfo(t)}init(t){this._config.init(t),Fc.add(t.name,this)}load(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=Kw(e,i,s),l={__requestType__:Gc.PATH,type:r,bundle:this.name,__outputAsArray__:Array.isArray(t)};n.assetManager.loadAny(t,l,o,a)}preload(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=Kw(e,i,s);n.assetManager.preloadAny(t,{__requestType__:Gc.PATH,type:r,bundle:this.name},o,a)}loadDir(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=Kw(e,i,s);n.assetManager.loadAny(t,{__requestType__:Gc.DIR,type:r,bundle:this.name,__outputAsArray__:!0},o,a)}preloadDir(t,e,i,s){const{type:r,onProgress:o,onComplete:a}=Kw(e,i,s);n.assetManager.preloadAny(t,{__requestType__:Gc.DIR,type:r,bundle:this.name},o,a)}loadScene(t,e,i,s){const{options:r,onProgress:o,onComplete:a}=Yw(e,i,s);r.preset=r.preset||"scene",r.bundle=this.name,n.assetManager.loadAny({scene:t},r,o,((t,e)=>{if(t)p(t.message,t.stack);else if(e instanceof cT&&e.scene){const t=e.scene;t._id=e._uuid,t.name=e.name}else t=new Error(`The asset ${e._uuid} is not a scene`);a&&a(t,e)}))}preloadScene(t,e,i,s){const{options:r,onProgress:o,onComplete:a}=Yw(e,i,s);r.bundle=this.name,n.assetManager.preloadAny({scene:t},r,o,(e=>{e&&T(1210,t,e.message),a&&a(e)}))}get(t,e){const i=this.getInfoWithPath(t,e);return i&&Bc.get(i.uuid)||null}release(t,e){const i=this.get(t,e);i&&Uw.tryRelease(i,!0)}releaseUnusedAssets(){Bc.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Uw.tryRelease(t)}))}releaseAll(){Bc.forEach((t=>{const e=this.getAssetInfo(t._uuid);e&&!e.redirect&&Uw.tryRelease(t,!0)}))}_destroy(){this._config.destroy()}}const Qw=t("resources",new Zw);function tE(t,e,i){const n=new Image;function s(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(null,n)}function r(){n.removeEventListener("load",s),n.removeEventListener("error",r),i&&i(new Error(D(4930,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.addEventListener("load",s),n.addEventListener("error",r),n.src=t,n}function eE(t,e,i,n){const s=new XMLHttpRequest,r=`download failed: ${t}, status: `;if(s.open("GET",t,!0),void 0!==e.xhrResponseType&&(s.responseType=e.xhrResponseType),void 0!==e.xhrWithCredentials&&(s.withCredentials=e.xhrWithCredentials),void 0!==e.xhrMimeType&&s.overrideMimeType&&s.overrideMimeType(e.xhrMimeType),void 0!==e.xhrTimeout&&(s.timeout=e.xhrTimeout),e.xhrHeader)for(const t in e.xhrHeader)s.setRequestHeader(t,e.xhrHeader[t]);return s.onload=()=>{200===s.status||0===s.status?n&&n(null,s.response):n&&n(new Error(`${r}${s.status}(no response)`))},i&&(s.onprogress=t=>{t.lengthComputable&&i(t.loaded,t.total)}),s.onerror=()=>{n&&n(new Error(`${r}${s.status}(error)`))},s.ontimeout=()=>{n&&n(new Error(`${r}${s.status}(time out)`))},s.onabort=()=>{n&&n(new Error(`${r}${s.status}(abort)`))},s.send(null),s}n.resources=Qw;const iE={};function nE(t,e,i){if(iE[t])return i&&i(null),null;const n=document.createElement("script");function s(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),iE[t]=!0,i&&i(null)}function r(){n.parentNode.removeChild(n),n.removeEventListener("load",s,!1),n.removeEventListener("error",r,!1),i&&i(new Error(D(4928,t)))}return"file:"!==window.location.protocol&&(n.crossOrigin="anonymous"),n.async=e.scriptAsyncLoading||!1,n.src=t,n.addEventListener("load",s,!1),n.addEventListener("error",r,!1),document.body.appendChild(n),n}const sE=/^(?:\w+:\/\/|\.+\/).+/,rE=(t,e,i)=>{(yn.capabilities.imageBitmap&&n.assetManager.allowImageBitmap?oE:tE)(t,e,i)},oE=(t,e,i)=>{e.xhrResponseType="blob",eE(t,e,e.onFileProgress,i)},aE=(t,e,i)=>{e.xhrResponseType="json",eE(t,e,e.onFileProgress,i)},lE=(t,e,i)=>{e.xhrResponseType="arraybuffer",eE(t,e,e.onFileProgress,i)},cE=(t,e,i)=>{aE(t,e,((e,n)=>{if(e)return void i(e);const s=Uh(n);Promise.all(s.chunks.map((i=>new Promise(((n,s)=>{lE(`${Cn(t)}${i}`,{},((t,i)=>{e?s(e):n(new Uint8Array(i))}))}))))).then((t=>{const e=new Vh(s.document,t);i(null,e)})).catch((t=>{i(t)}))}))},hE=(t,e,i)=>{lE(t,e,((t,e)=>{if(t)i(t);else try{const t=Gh(new Uint8Array(e));i(null,t)}catch(t){i(t)}}))},_E=(t,e,i)=>{e.xhrResponseType="text",eE(t,e,e.onFileProgress,i)},uE=(t,e,i)=>{const n=Tn(t);let s=t;sE.test(s)||(s=-1!==mE.remoteBundles.indexOf(n)?`${mE.remoteServerAddress}remote/${n}`:`assets/${n}`);const r=e.version||mE.bundleVers[n];let o=0,a=null,l=null;aE(`${s}/config.${r?`${r}.`:""}json`,e,((t,e)=>{l=t,a=e,a&&(a.base=`${s}/`),2==++o&&i(l,a)})),nE(`${s}/index.${r?`${r}.`:""}js`,e,(t=>{l=t,2==++o&&i(t,a)}))},mE=new class{constructor(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=tE,this.downloadDomAudio=null,this.downloadFile=eE,this.downloadScript=nE,this._downloaders={".png":rE,".jpg":rE,".bmp":rE,".jpeg":rE,".gif":rE,".ico":rE,".tiff":rE,".webp":rE,".image":rE,".pvr":lE,".pkm":lE,".astc":lE,".txt":_E,".xml":_E,".vsh":_E,".fsh":_E,".atlas":_E,".tmx":_E,".tsx":_E,".json":aE,".ExportJson":aE,".plist":_E,".ccon":cE,".cconb":hE,".fnt":_E,".binary":lE,".bin":lE,".dbbin":lE,".skel":lE,".js":nE,bundle:uE,default:_E},this._downloading=new Mc,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}get remoteServerAddress(){return this._remoteServerAddress}init(t="",e={},i=[]){this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=t,this.bundleVers=e,this.remoteBundles=i}register(t,e){"object"==typeof t?dt(this._downloaders,t):this._downloaders[t]=e}download(t,e,i,n,s){const r=Nc.get(t);if(r)return void s(null,r);const o=this._downloading.get(t);if(o){o.push(s);const e=this._queue.find((e=>e.id===t));if(!e)return;const i=n.priority||0;return void(e.priority<i&&(e.priority=i,this._queueDirty=!0))}const a=void 0!==n.maxRetryCount?n.maxRetryCount:this.maxRetryCount,l=void 0!==n.maxConcurrency?n.maxConcurrency:this.maxConcurrency,c=void 0!==n.maxRequestsPerFrame?n.maxRequestsPerFrame:this.maxRequestsPerFrame,h=this._downloaders[i]||this._downloaders.default;jw(((i,r)=>{if(0===i&&this._downloading.add(t,[s]),!this.limited)return void h(Hw(e,this.appendTimeStamp),n,r);this._updateTime();const o=(t,e)=>{this._totalNum--,this._handleQueueInNextFrame(l,c),r(t,e)};this._totalNum<l&&this._totalNumThisPeriod<c?(h(Hw(e,this.appendTimeStamp),n,o),this._totalNum++,this._totalNumThisPeriod++):(this._queue.push({id:t,priority:n.priority||0,url:e,options:n,done:o,handler:h}),this._queueDirty=!0,this._totalNum<l&&this._handleQueueInNextFrame(l,c))}),a,this.retryInterval,((e,i)=>{e||Nc.add(t,i);const n=this._downloading.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))}loadSubpackage(t,e){n.assetManager.loadBundle(t,null,e)}_updateTime(){const t=performance.now(),e=n.game.deltaTime,i=e>this._maxInterval?this._maxInterval:e;t-this._lastDate>1e3*i&&(this._totalNumThisPeriod=0,this._lastDate=t)}_handleQueue(t,e){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<t&&this._totalNumThisPeriod<e;){this._queueDirty&&(this._queue.sort(((t,e)=>t.priority-e.priority)),this._queueDirty=!1);const t=this._queue.pop();if(!t)break;this._totalNum++,this._totalNumThisPeriod++,t.handler(Hw(t.url,this.appendTimeStamp),t.options,t.done)}this._handleQueueInNextFrame(t,e)}_handleQueueInNextFrame(t,e){!this._checkNextPeriod&&this._queue.length>0&&(Yt(this._handleQueue.bind(this),t,e),this._checkNextPeriod=!0)}};function pE(t,e,i,n){let s=null,r=null;try{s=new Gd,s._nativeUrl=t,s._nativeAsset=e}catch(t){r=t}n(r,s)}function dE(t,e,i,n){const s=new gT;s.json=e,n(null,s)}function fE(t,e,i,n){const s=new mT;s.text=e,n(null,s)}function gE(t,e,i,n){const s=new Yb;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function yE(t,e,i,n){const s=new _h;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}function vE(t,i,n,s){let r=Fc.get(i.name);r||(r=i.name===Hc.RESOURCES?Qw:new Zw,i.base=i.base||`${t}/`,r.init(i)),e.import(`virtual:///prerequisite-imports/${r.name}`).then((()=>{s(null,r)})).catch(s)}var xE=new class{constructor(){this._creating=new Mc,this._producers={".png":pE,".jpg":pE,".bmp":pE,".jpeg":pE,".gif":pE,".ico":pE,".tiff":pE,".webp":pE,".image":pE,".pvr":pE,".pkm":pE,".txt":fE,".xml":fE,".vsh":fE,".fsh":fE,".atlas":fE,".tmx":fE,".tsx":fE,".fnt":fE,".json":dE,".ExportJson":dE,".binary":gE,".bin":gE,".dbbin":gE,".skel":gE,bundle:vE,default:yE}}register(t,e){"object"==typeof t?Ot.mixin(this._producers,t):this._producers[t]=e}create(t,e,i,n,s){const r=this._producers[i]||this._producers.default,o=Bc.get(t);if(!n.reloadAsset&&o)return void s(null,o);const a=this._creating.get(t);a?a.push(s):(this._creating.add(t,[s]),r(t,e,n,((e,i)=>{!e&&i instanceof _h&&(i._uuid=t,qw(t,i,n.cacheAsset));const s=this._creating.remove(t);for(let t=0,n=s.length;t<n;t++)s[t](e,i)})))}},bE=new class{constructor(){this._loading=new Mc,this._unpackers={".json":this.unpackJson}}unpackJson(t,e,i,n){let s=Ot.createMap(!0),r=null;if(Array.isArray(e)){(e=function(t){if(t[0]<1)throw new Error(D(5304,t[0]));a_(t,!0,void 0,c_.reportMissingClass),l_(t);const e=new h_(t[0]),i=t[1],n=t[2],s=t[3],r=t[4],o=t[5];for(let t=0;t<o.length;++t)o[t].unshift(e,i,n,s,r);return o}(e)).length!==t.length&&T(4915);for(let i=0;i<t.length;i++)s[`${t[i]}@import`]=e[i]}else{const i=Ot._getClassId(Af),n=Ot._getClassId(Gd);if(e.type===i&&e.data){const n=e.data;n.length!==t.length&&T(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=__(i,{base:n[e][0],mipmaps:n[e][1]})}else if(e.type===n&&e.data){const i=e.data;i.length!==t.length&&T(4915);for(let e=0;e<t.length;e++)s[`${t[e]}@import`]=i[e]}else r=new Error("unmatched type pack!"),s=null}n(r,s)}init(){this._loading.clear()}register(t,e){"object"==typeof t?Ot.mixin(this._unpackers,t):this._unpackers[t]=e}unpack(t,e,i,n,s){e?(0,this._unpackers[i])(t,e,n,s):s(new Error("package data is wrong!"))}load(t,e,i){if(t.isNative||!t.info||!t.info.packs)return void mE.download(t.id,t.url,t.ext,t.options,i);if(Nc.has(t.id))return void i(null,Nc.get(t.id));const n=t.info.packs;let s=n.find((t=>this._loading.has(t.uuid)));if(s)return void this._loading.get(s.uuid).push({onComplete:i,id:t.id});s=n[0],this._loading.add(s.uuid,[{onComplete:i,id:t.id}]);const r=eh(s.uuid,{ext:s.ext,bundle:t.config.name});mE.download(s.uuid,r,s.ext,t.options,((e,i)=>{Nc.remove(s.uuid),e&&p(e.message,e.stack),this.unpack(s.packedUuids,i,s.ext,t.options,((t,i)=>{if(!t)for(const t in i)Nc.add(t,i[t]);const n=this._loading.remove(s.uuid);for(let s=0,r=n.length;s<r;s++){const r=n[s];if(e||t){r.onComplete(e||t);continue}const o=i[r.id];o?r.onComplete(null,o):r.onComplete(new Error("can not retrieve data from package"))}}))}))}};function SE(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t,o=[],a=r.total,l=s.__exclude__=s.__exclude__||Object.create(null);t.output=[],Xw(t.input,((s,c)=>{if(!s.isNative&&Bc.has(s.uuid)){const e=Bc.get(s.uuid);return s.content=e.addRef(),t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s),void c()}bE.load(s,t.options,((h,_)=>{h?t.isFinish||(!n.assetManager.force||i?(p(h.message,h.stack),r.canInvoke=!1,e(h)):(t.output.push(s),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s))):t.isFinish||(s.file=_,t.output.push(s),s.isNative||(l[s.uuid]=!0,Ww(s.uuid,_,l,o,s.config),r.total=a+o.length),r.canInvoke&&t.dispatch("progress",++r.finish,r.total,s)),c()}))}),(()=>{if(t.isFinish)return kw(t,!0),void t.dispatch("error");if(o.length>0){const n=jc.create({input:o,progress:r,options:s,onProgress:t.onProgress,onError:jc.prototype.recycle,onComplete:s=>{s||(t.output.push(...n.output),n.recycle()),i&&AE(t),e(s)}});Vc.async(n)}else i&&AE(t),e()}))}function AE(t){const e=t.output;for(let t=0,i=e.length;t<i;t++)e[t].content&&e[t].content.decRef(!1)}class CE{constructor(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}parse(t){return this._parseXML(t)}_parseXML(t){if(this._parser)return this._parser.parseFromString(t,"text/xml");throw new Error("Dom parser is not supported in this platform!")}}const TE=new class extends CE{parse(t){const e=this._parseXML(t).documentElement;if("plist"!==e.tagName)return A(5100),{};let i=null;for(let t=0,n=e.childNodes.length;t<n&&(i=e.childNodes[t],1!==i.nodeType);t++);return this._parseNode(i)}_parseNode(t){let e=null;const i=t.tagName;if("dict"===i)e=this._parseDict(t);else if("array"===i)e=this._parseArray(t);else if("string"===i)if(1===t.childNodes.length)e=t.firstChild.nodeValue;else{e="";for(let i=0;i<t.childNodes.length;i++)e+=t.childNodes[i].nodeValue}else"false"===i?e=!1:"true"===i?e=!0:"real"===i?e=parseFloat(t.firstChild.nodeValue):"integer"===i&&(e=parseInt(t.firstChild.nodeValue,10));return e}_parseArray(t){const e=[];for(let i=0,n=t.childNodes.length;i<n;i++){const n=t.childNodes[i];1===n.nodeType&&e.push(this._parseNode(n))}return e}_parseDict(t){const e={};let i="";for(let n=0,s=t.childNodes.length;n<s;n++){const s=t.childNodes[n];1===s.nodeType&&("key"===s.tagName?i=s.firstChild.nodeValue:e[i]=this._parseNode(s))}return e}};function wE(t,e){return t[e]<<8|t[e+1]}var EE=new class{constructor(){this._parsing=new Mc,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}parseImage(t,e,i){t instanceof HTMLImageElement?i(null,t):createImageBitmap(t,{premultiplyAlpha:"none"}).then((t=>{i(null,t)}),(t=>{i(t,null)}))}parsePVRTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Int32Array(e,0,13);if(55727696===i[0]){const t=i[7],n=i[6],r=i[12]+52;s={_data:new Uint8Array(e,r),_compressed:!0,width:t,height:n,format:0}}else{if(559044176!==i[11])throw new Error("Invalid magic number in PVR header");{const t=i[0],n=i[1],r=i[2];s={_data:new Uint8Array(e,t),_compressed:!0,width:r,height:n,format:0}}}}catch(t){n=t}i(n,s)}parsePKMTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e),n=wE(i,6);if(0!==n&&1!==n&&3!==n)throw new Error("Invalid magic number in ETC header");const r=wE(i,12),o=wE(i,14);wE(i,8),wE(i,10),s={_data:new Uint8Array(e,16),_compressed:!0,width:r,height:o,format:0}}catch(t){n=t}i(n,s)}parseASTCTex(t,e,i){let n=null,s=null;try{const e=t instanceof ArrayBuffer?t:t.buffer,i=new Uint8Array(e);if(1554098963!==i[0]+(i[1]<<8)+(i[2]<<16)+(i[3]<<24))throw new Error("Invalid magic number in ASTC header");const n=i[4],r=i[5],o=i[6];if((n<3||n>6||r<3||r>6||o<3||o>6)&&(n<4||7===n||9===n||11===n||n>12||r<4||7===r||9===r||11===r||r>12||1!==o))throw new Error("Invalid block number in ASTC header");const a=function(t,e){return 4===t?Rd.RGBA_ASTC_4x4:5===t?4===e?Rd.RGBA_ASTC_5x4:Rd.RGBA_ASTC_5x5:6===t?5===e?Rd.RGBA_ASTC_6x5:Rd.RGBA_ASTC_6x6:8===t?5===e?Rd.RGBA_ASTC_8x5:6===e?Rd.RGBA_ASTC_8x6:Rd.RGBA_ASTC_8x8:10===t?5===e?Rd.RGBA_ASTC_10x5:6===e?Rd.RGBA_ASTC_10x6:8===e?Rd.RGBA_ASTC_10x8:Rd.RGBA_ASTC_10x10:10===e?Rd.RGBA_ASTC_12x10:Rd.RGBA_ASTC_12x12}(n,r),l=i[7]+(i[8]<<8)+(i[9]<<16),c=i[10]+(i[11]<<8)+(i[12]<<16);i[13],i[14],i[15],s={_data:new Uint8Array(e,16),_compressed:!0,width:l,height:c,format:a}}catch(t){n=t}i(n,s)}parsePlist(t,e,i){let n=null;const s=TE.parse(t);s||(n=new Error("parse failed")),i(n,s)}parseImport(t,e,i){if(!t)return void i(new Error(`The json file of asset ${e.__uuid__} is empty or missing`));let n=null,s=null;try{n=uf(t,e)}catch(t){s=t}i(s,n)}init(){this._parsing.clear()}register(t,e){"object"==typeof t?dt(this._parsers,t):this._parsers[t]=e}parse(t,e,i,n,s){const r=Lc.get(t);if(r)return void s(null,r);const o=this._parsing.get(t);if(o)return void o.push(s);const a=this._parsers[i];a?(this._parsing.add(t,[s]),a(e,n,((e,i)=>{e?Nc.remove(t):Qc(i)||Lc.add(t,i);const n=this._parsing.remove(t);for(let t=0,s=n.length;t<s;t++)n[t](e,i)}))):s(null,e)}};function PE(t,e){let i=!1;t.progress||(t.progress={finish:0,total:t.input.length,canInvoke:!0},i=!0);const{options:s,progress:r}=t;s.__exclude__=s.__exclude__||Object.create(null),t.output=[],Xw(t.input,((o,a)=>{const l=jc.create({input:o,onProgress:t.onProgress,options:s,progress:r,onComplete:(s,c)=>{s&&!t.isFinish&&(!n.assetManager.force||i?(p(s.message,s.stack),r.canInvoke=!1,e(s)):r.canInvoke&&t.dispatch("progress",++r.finish,r.total,o)),t.output.push(c),l.recycle(),a(null)}});DE.async(l)}),(()=>{if(s.__exclude__=null,t.isFinish)return kw(t,!0),void t.dispatch("error");!function(t){const e=t.source;if(t.options.__outputAsArray__||1!==e.length){const i=t.output=[];for(let t=0,n=e.length;t<n;t++)i.push(e[t].content)}else t.output=e[0].content}(t),kw(t,!0),e()}))}const DE=new Oc("loadOneAsset",[function(t,e){const i=t.output=t.input,{options:n,isNative:s,uuid:r,file:o}=i,{reloadAsset:a}=n;o||!a&&!s&&Bc.has(r)?e():bE.load(i,t.options,((t,n)=>{i.file=n,e(t)}))},function(t,e){const i=t.output=t.input,n=t.progress,s=t.options.__exclude__,{id:r,file:o,options:a}=i;if(i.isNative)EE.parse(r,o,i.ext,a,((s,o)=>{s?e(s):(i.content=o,n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),Nc.remove(r),Lc.remove(r),e())}));else{const{uuid:l}=i;if(l in s){const{finish:r,content:o,err:a,callbacks:c}=s[l];n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),r||$w(l,l,s)?(o&&o.addRef(),i.content=o,e(a)):c.push({done:e,item:i})}else if(!a.reloadAsset&&Bc.has(l)){const s=Bc.get(l);i.content=s.addRef(),n.canInvoke&&t.dispatch("progress",++n.finish,n.total,i),e()}else a.__uuid__=l,EE.parse(r,o,"import",a,((i,n)=>{i?e(i):function(t,e,i){const{input:n,progress:s}=t,{uuid:r,id:o,options:a,config:l}=n,{cacheAsset:c}=a,h=[];e.addRef&&e.addRef(),Ww(r,e,Object.create(null),h,l),s.canInvoke&&t.dispatch("progress",++s.finish,s.total+=h.length,n);const _=t.options.__exclude__[r]={content:e,finish:!1,callbacks:[{done:i,item:n}]},u=jc.create({input:h,options:t.options,onProgress:t.onProgress,onError:jc.prototype.recycle,progress:s,onComplete:t=>{if(e.decRef&&e.decRef(!1),_.finish=!0,_.err=t,!t){const t=Array.isArray(u.output)?u.output:[u.output],i=Object.create(null);for(const e of t)e&&(i[e instanceof _h?`${e._uuid}@import`:`${r}@native`]=e);!function(t,e,i){let n=!1;const s=cf.get(e);if(s){for(let t=0,e=s.length;t<e;t++){const e=s[t],r=i[`${e.uuid}@import`];if(r)e.owner[e.prop]=r.addRef();else{if(p(`The asset ${e.uuid} is missing!`),e.type&&e.type!==_h){const t=new e.type;t.initDefault(e.uuid),e.owner[e.prop]=t}n=!0}}cf.delete(e)}hf.has(e)&&(i[`${t}@native`]?e._nativeAsset=i[`${t}@native`]:(n=!0,console.error(`the native asset of ${t} is missing!`)),hf.delete(e))}(r,e,i);try{"function"!=typeof e.onLoaded||_f.has(e)||hf.has(e)||(e.onLoaded(),_f.add(e))}catch(t){p(`The asset ${r} is invalid for some reason, detail message: ${t.message}, stack: ${t.stack}`)}Nc.remove(o),Lc.remove(o),qw(r,e,c),u.recycle()}const i=_.callbacks;for(let n=0,s=i.length;n<s;n++){const s=i[n];e.addRef&&e.addRef(),s.item.content=e,s.done(t)}i.length=0}});zc.async(u)}(t,n,e)}))}}]);function IE(t,e){const i=t.options,n=Object.create(null),s=Object.create(null);for(const t in i)switch(t){case Gc.PATH:case Gc.UUID:case Gc.DIR:case Gc.SCENE:case Gc.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":n[t]=i[t];break;case"__exclude__":case"__outputAsArray__":s[t]=i[t];break;default:n[t]=i[t],s[t]=i[t]}t.options=s;const r=jc.create({input:t.input,options:n});let o=null;try{t.output=t.source=Uc.sync(r)}catch(t){o=t;for(let t=0,e=r.output.length;t<e;t++)r.output[t].recycle()}r.recycle(),e(o)}class RE{constructor(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}get id(){return this._id||(this._id=`${this.uuid}@${this.isNative?"native":"import"}`),this._id}static create(){let t;return t=0!==RE._deadPool.length?RE._deadPool.pop():new RE,t}recycle(){RE._deadPool.length!==RE.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),RE._deadPool.push(this))}}RE.MAX_DEAD_NUM=500,RE._deadPool=[];const ME=[];function OE(t){var e;const i=t.options,n=Array.isArray(t.input)?t.input:[t.input];t.output=[];for(let r=0;r<n.length;r++){let o=n[r],a=RE.create(),l=null,c=null;if("string"==typeof o&&(o=Object.create(null),o[i.__requestType__||Gc.UUID]=n[r]),"object"==typeof o){pt(o,i),o.preset&&pt(o,kc[o.preset]);for(const t in o){switch(t){case Gc.UUID:{var s;const t=a.uuid=Kc(o.uuid);if(!o.bundle){const e=Fc.find((e=>!!e.getAssetInfo(t)));o.bundle=e&&e.name}if(Fc.has(o.bundle)){if(l=Fc.get(o.bundle).config,c=l.getAssetInfo(t),c&&c.redirect){if(!Fc.has(c.redirect))throw new Error(`Please load bundle ${c.redirect} first`);l=Fc.get(c.redirect).config,c=l.getAssetInfo(t)}a.config=l,a.info=c}a.ext=o.ext||(null===(s=c)||void 0===s?void 0:s.extension)||".json";break}case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Gc.DIR:if(Fc.has(o.bundle)){Fc.get(o.bundle).config.getDirWithPath(o.dir,o.type,ME);for(const t of ME)n.push({uuid:t.uuid,__isNative__:!1,ext:t.extension||".json",bundle:o.bundle});ME.length=0}a.recycle(),a=null;break;case Gc.PATH:if(Fc.has(o.bundle)){if(l=Fc.get(o.bundle).config,c=l.getInfoWithPath(o.path,o.type),c&&c.redirect){if(!Fc.has(c.redirect))throw new Error(`you need to load bundle ${c.redirect} first`);l=Fc.get(c.redirect).config,c=l.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error(`Bundle ${o.bundle} doesn't contain ${o.path}`);a.config=l,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json";break;case Gc.SCENE:if(!o.bundle){const t=Fc.find((t=>!!t.getSceneInfo(o.scene)));o.bundle=t&&t.name}if(Fc.has(o.bundle)){if(l=Fc.get(o.bundle).config,c=l.getSceneInfo(o.scene),c&&c.redirect){if(!Fc.has(c.redirect))throw new Error(`you need to load bundle ${c.redirect} first`);l=Fc.get(c.redirect).config,c=l.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error(`Bundle ${l.name} doesn't contain scene ${o.scene}`);a.config=l,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case Gc.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||An(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[t]=o[t]}if(!a)break}}if(a&&(t.output.push(a),!a.uuid&&!a.url))throw new Error(`Can not parse this input:${JSON.stringify(o)}`)}return null}function BE(t){const e=t.output=t.input;for(let t=0;t<e.length;t++){const i=e[t];if(i.url)continue;let s="",r="";const o=i.config;r=i.isNative?o&&o.nativeBase?o.base+o.nativeBase:n.assetManager.generalNativeBase:o&&o.importBase?o.base+o.importBase:n.assetManager.generalImportBase;const a=i.uuid;let l="";i.info&&(l=i.isNative?i.info.nativeVer?`.${i.info.nativeVer}`:"":i.info.ver?`.${i.info.ver}`:""),s=".ttf"===i.ext?`${r}/${a.slice(0,2)}/${a}${l}/${i.options.__nativeName__}`:`${r}/${a.slice(0,2)}/${a}${l}${i.ext}`,i.url=s}return null}class NE{constructor(){this.pipeline=zc.append(IE).append(PE),this.fetchPipeline=Vc.append(IE).append(SE),this.transformPipeline=Uc.append(OE).append(BE),this.bundles=Fc,this.assets=Bc,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=pf,this.force=!1,this.allowImageBitmap=!yn.isMobile,this.utils=ih,this.downloader=mE,this.parser=EE,this.packManager=bE,this.cacheAsset=!0,this.cacheManager=null,this.presets=kc,this.factory=xE,this.preprocessPipe=IE,this.fetchPipe=SE,this.loadPipe=PE,this.references=null,this._releaseManager=Uw,this._files=Nc,this._parsed=Lc,this._parsePipeline=null}get main(){return Fc.get(Hc.MAIN)||null}get resources(){return Fc.get(Hc.RESOURCES)||null}init(t={}){this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(t.server,t.bundleVers,t.remoteBundles),this.parser.init(),this.dependUtil.init();let e=t.importBase||"";e&&e.endsWith("/")&&(e=e.substr(0,e.length-1));let i=t.nativeBase||"";i&&i.endsWith("/")&&(i=i.substr(0,i.length-1)),this.generalImportBase=e,this.generalNativeBase=i}getBundle(t){return Fc.get(t)||null}removeBundle(t){t._destroy(),Fc.remove(t.name)}loadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=Yw(e,i,n);s.preset=s.preset||"default",t=Array.isArray(t)?t.slice():t;const a=jc.create({input:t,onProgress:r,onComplete:Jw(o),options:s});zc.async(a)}preloadAny(t,e,i,n){const{options:s,onProgress:r,onComplete:o}=Yw(e,i,n);s.preset=s.preset||"preload",t=Array.isArray(t)?t.slice():t;const a=jc.create({input:t,onProgress:r,onComplete:Jw(o),options:s});Vc.async(a)}loadRemote(t,e,i){const{options:n,onComplete:s}=Yw(e,void 0,i);n.reloadAsset||!this.assets.has(t)?(n.__isNative__=!0,n.preset=n.preset||"remote",this.loadAny({url:t},n,null,((e,i)=>{e?(p(e.message,e.stack),s&&s(e,i)):xE.create(t,i,n.ext||An(t),n,((t,e)=>{s&&s(t,e)}))}))):Jw(s)(null,this.assets.get(t))}loadBundle(t,e,i){const{options:n,onComplete:s}=Yw(e,void 0,i),r=Tn(t);this.bundles.has(r)?Jw(s)(null,this.getBundle(r)):(n.preset=n.preset||"bundle",n.ext="bundle",n.__isNative__=!0,this.loadAny({url:t},n,null,((e,i)=>{e?(p(e.message,e.stack),s&&s(e,i)):xE.create(t,i,"bundle",n,((t,e)=>{s&&s(t,e)}))})))}releaseAsset(t){Uw.tryRelease(t,!0)}releaseUnusedAssets(){Bc.forEach((t=>{Uw.tryRelease(t)}))}releaseAll(){Bc.forEach((t=>{Uw.tryRelease(t,!0)}))}loadWithJson(t,e,i,n){throw new Error("Only valid in Editor")}}t("AssetManager",NE),NE.Pipeline=Oc,NE.Task=jc,NE.Cache=Mc,NE.RequestItem=RE,NE.Bundle=Zw,NE.BuiltinBundleName=Hc;var LE=t("assetManager",n.assetManager=new NE);n.AssetManager=NE;const FE=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],zE=[".mp3",".ogg",".wav",".m4a"];function VE(){return!0}const UE={transformURL(t){const e=Jc(t);if(!e)return t;const i=Fc.find((t=>!!t.getAssetInfo(e)));if(!i)return t;let n="";const s=i.getAssetInfo(e);if(n=t.startsWith(i.base+i.config.nativeBase)?s.nativeVer||"":s.ver||"",!n||-1!==t.indexOf(n))return t;let r=!1;if(".ttf"===An(t)&&(r=!0),r){const e=wn(t),i=Tn(t);t=`${e}.${n}/${i}`}else t=t.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/,(t=>`${t}.${n}`));return t}};class GE{constructor(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=Kw}set onProgress(t){Gw=t}get _cache(){return Bc._map}load(t,e,i){void 0===i&&void 0!==e&&(i=e,e=null);const n=Array.isArray(t)?t:[t];for(let t=0;t<n.length;t++){const e=n[t];"string"==typeof e?n[t]={url:e,__isNative__:!0}:(e.type&&(e.ext=`.${e.type}`,e.type=void 0),e.url&&(e.__isNative__=!0))}const s=[],r=[];LE.loadAny(n,null,((t,i,n)=>{n.content&&(FE.includes(n.ext)?s.push(n.content):zE.includes(n.ext)&&r.push(n.content)),e&&e(t,i,n)}),((t,e)=>{let o=null;if(!t){e=Array.isArray(e)?e:[e];for(let t=0;t<e.length;t++){const i=e[t];if(!(i instanceof _h)){let o=i;const a=n[t].url;s.includes(o)?xE.create(a,i,".png",{},((i,n)=>{o=e[t]=n})):r.includes(o)&&xE.create(a,i,".mp3",{},((i,n)=>{o=e[t]=n})),Bc.add(a,o)}}if(e.length>1){const t=Object.create(null);e.forEach((e=>{t[e._uuid]=e})),o={isCompleted:VE,_map:t}}else o=e[0]}i&&i(t,o)}))}getXMLHttpRequest(){return new XMLHttpRequest}getItem(t){return LE.assets.has(t)?{content:LE.assets.get(t)}:null}loadRes(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n),a=An(t);a&&!Qw.getInfoWithPath(t,s)&&(t=t.slice(0,-a.length)),Qw.load(t,s,r,o)}loadResArray(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);t.forEach(((e,i)=>{const n=An(e);n&&!Qw.getInfoWithPath(e,s)&&(t[i]=e.slice(0,-n.length))})),Qw.load(t,s,r,o)}loadResDir(t,e,i,n){const{type:s,onProgress:r,onComplete:o}=this._parseLoadResArgs(e,i,n);Qw.loadDir(t,s,r,((e,i)=>{let n=[];e||(n=Qw.getDirWithPath(t,s).map((t=>t.path))),o&&o(e,i,n)}))}getRes(t,e){return Bc.has(t)?Bc.get(t):Qw.get(t,e)}getResCount(){return Bc.count}getDependsRecursively(t){if(!t)return[];const e="string"==typeof t?t:t._uuid;return pf.getDepsRecursively(e).concat([e])}get md5Pipe(){return UE}get downloader(){return mE}get loader(){return LE.parser}addDownloadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({url:t},i)}}mE.register(e)}addLoadHandlers(t){const e=Object.create(null);for(const i in t){const n=t[i];e[`.${i}`]=(t,e,i)=>{n({content:t},i)}}EE.register(e)}release(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){let i=t[e];"string"==typeof i&&(i=Bc.get(i)),LE.releaseAsset(i)}else t&&("string"==typeof t&&(t=Bc.get(t)),LE.releaseAsset(t))}releaseAsset(t){LE.releaseAsset(t)}releaseRes(t,e){Qw.release(t,e)}releaseAll(){LE.releaseAll(),Bc.clear()}removeItem(t){return!!Bc.remove(t)}setAutoRelease(t,e){"object"==typeof t&&(t=t._uuid),this._autoReleaseSetting[t]=!!e}setAutoReleaseRecursively(t,e){"object"==typeof t&&(t=t._uuid),e=!!e,this._autoReleaseSetting[t]=e;const i=pf.getDepsRecursively(t);for(let t=0;t<i.length;t++)this._autoReleaseSetting[i[t]]=e}isAutoRelease(t){return"object"==typeof t&&(t=t._uuid),!!this._autoReleaseSetting[t]}}t("CCLoader",GE);const kE=t("loader",new GE),HE=t("AssetLibrary",{init(t){t.importBase=t.libraryPath,t.nativeBase=t.rawAssetsBase,LE.init(t),t.rawAssets&&Qw.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Hc.RESOURCES,importBase:t.importBase,nativeBase:t.nativeBase,paths:t.rawAssets.assets,uuids:Object.keys(t.rawAssets.assets),extensionMap:{}})},loadAsset(t,e,i){LE.loadAny(t,e)}}),jE=t("url",{});Ze(jE,"url",[{name:"normalize",target:LE.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:t=>t.startsWith("resources/")?eh({path:En(t.substr(10)),bundle:Hc.RESOURCES,__isNative__:!0,ext:An(t)}):""}]),Qe(HE,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),Qe(kE,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),Ze(n,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:()=>kE},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:()=>HE},{name:"Pipeline",target:NE,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:()=>jE}]),Qe(n,"cc",[{name:"LoadingItems",suggest:D(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),Ze(Ut,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:mE,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),Ze(Mw,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:t=>{var e;return LE.main?null===(e=LE.main.getSceneInfo(t))||void 0===e?void 0:e.uuid:""}}]),Ze(_w,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:()=>{const t=[];return LE.main&&LE.main.config.scenes.forEach((e=>{t.push(e)})),t}}]);const WE=Uw._autoRelease;var qE,XE,YE,KE,$E,JE,ZE,QE,tP,eP,iP,nP,sP;Uw._autoRelease=function(t,e,i){WE.call(Uw,t,e,i);const n=kE._autoReleaseSetting,s=Object.keys(n);for(let t=0;t<s.length;t++){const e=s[t];if(!0===n[e]){const t=Bc.get(e);t&&Uw.tryRelease(t)}}};let rP=t("EventHandler",(qE=Vl("cc.ClickEvent"),XE=yc(n.Node),YE=rc(),KE=rc(),$E=rc(),JE=rc(),qE((tP=wl((QE=class t{constructor(){Tl(this,"target",tP,this),Tl(this,"component",eP,this),Tl(this,"_componentId",iP,this),Tl(this,"handler",nP,this),Tl(this,"customEventData",sP,this)}get _componentName(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)}set _componentName(t){this._componentId=this._compName2Id(t)}static emitEvents(e,...i){for(let n=0,s=e.length;n<s;n++){const s=e[n];s instanceof t&&s.emit(i)}}emit(t){const e=this.target;if(!n.isValid(e))return;this._genCompIdIfNeeded();const i=n.js._getClassById(this._componentId),s=e.getComponent(i);if(!n.isValid(s))return;const r=s[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(t=t.slice()).push(this.customEventData),r.apply(s,t))}_compName2Id(t){const e=n.js.getClassByName(t);return n.js._getClassId(e)}_compId2Name(t){const e=n.js._getClassById(t);return n.js.getClassName(e)}_genCompIdIfNeeded(){this._componentId||(this._componentName=this.component,this.component="")}}).prototype,"target",[Wl,XE,YE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eP=wl(QE.prototype,"component",[Wl,ic,KE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),iP=wl(QE.prototype,"_componentId",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),nP=wl(QE.prototype,"handler",[Wl,ic,$E],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),sP=wl(QE.prototype,"customEventData",[Wl,ic,JE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZE=QE))||ZE));var oP,aP,lP,cP,hP,_P,uP,mP,pP,dP,fP,gP,yP,vP,xP,bP,SP,AP,CP,TP,wP,EP,PP,DP,IP,RP,MP,OP,BP,NP,LP,FP,zP,VP,UP,GP,kP,HP,jP,WP,qP,XP,YP,KP,$P,JP,ZP,QP,tD,eD,iD,nD,sD,rD,oD,aD,lD,cD,hD,_D,uD,mD,pD,dD,fD,gD,yD;n.Component.EventHandler=rP;const vD=new Ni,xD=Nt(yd),bD=Nt(gd),SD=Nt(vd),AD=Nt(bd),CD=Nt(xd),TD=Nt({SKYBOX:Pd|mr.DEPTH_STENCIL,SOLID_COLOR:mr.ALL,DEPTH_ONLY:mr.DEPTH_STENCIL,DONT_CLEAR:mr.NONE});let wD=(oP=Vl("cc.Camera"),aP=ec(),lP=Jl(),cP=_c(),hP=rc(),_P=yc(Qm.BitMask),uP=_c(),mP=rc(),pP=yc(TD),dP=_c(),fP=rc(),gP=_c(),yP=rc(),vP=_c(),xP=rc(),bP=_c(),SP=rc(),AP=yc(xD),CP=_c(),TP=rc(),wP=yc(bD),EP=_c(),PP=rc(),DP=_c(),IP=rc(),RP=_c(),MP=rc(),OP=_c(),BP=rc(),NP=_c(),LP=rc(),FP=yc(SD),zP=_c(),VP=rc(),UP=yc(AD),GP=_c(),kP=rc(),HP=yc(CD),jP=_c(),WP=rc(),qP=_c(),XP=rc(),YP=yc(Wb),KP=_c(),$P=rc(),ED=oP(JP=aP(JP=lP(JP=$l((yD=gD=class t extends Rh{constructor(...t){super(...t),Tl(this,"_projection",QP,this),Tl(this,"_priority",tD,this),Tl(this,"_fov",eD,this),Tl(this,"_fovAxis",iD,this),Tl(this,"_orthoHeight",nD,this),Tl(this,"_near",sD,this),Tl(this,"_far",rD,this),Tl(this,"_color",oD,this),Tl(this,"_depth",aD,this),Tl(this,"_stencil",lD,this),Tl(this,"_clearFlags",cD,this),Tl(this,"_rect",hD,this),Tl(this,"_aperture",_D,this),Tl(this,"_shutter",uD,this),Tl(this,"_iso",mD,this),Tl(this,"_screenScale",pD,this),Tl(this,"_visibility",dD,this),Tl(this,"_targetTexture",fD,this),this._camera=null,this._inEditorMode=!1,this._flows=void 0}get camera(){return this._camera}get priority(){return this._priority}set priority(t){this._priority=t,this._camera&&(this._camera.priority=t)}get visibility(){return this._visibility}set visibility(t){this._visibility=t,this._camera&&(this._camera.visibility=t)}get clearFlags(){return this._clearFlags}set clearFlags(t){this._clearFlags=t,this._camera&&(this._camera.clearFlag=t)}get clearColor(){return this._color}set clearColor(t){this._color.set(t),this._camera&&(this._camera.clearColor=this._color)}get clearDepth(){return this._depth}set clearDepth(t){this._depth=t,this._camera&&(this._camera.clearDepth=t)}get clearStencil(){return this._stencil}set clearStencil(t){this._stencil=t,this._camera&&(this._camera.clearStencil=t)}get projection(){return this._projection}set projection(t){this._projection=t,this._camera&&(this._camera.projectionType=t)}get fovAxis(){return this._fovAxis}set fovAxis(t){t!==this._fovAxis&&(this._fovAxis=t,this._camera&&(this._camera.fovAxis=t,t===gd.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}get fov(){return this._fov}set fov(t){this._fov=t,this._camera&&(this._camera.fov=di(t))}get orthoHeight(){return this._orthoHeight}set orthoHeight(t){this._orthoHeight=t,this._camera&&(this._camera.orthoHeight=t)}get near(){return this._near}set near(t){this._near=t,this._camera&&(this._camera.nearClip=t)}get far(){return this._far}set far(t){this._far=t,this._camera&&(this._camera.farClip=t)}get aperture(){return this._aperture}set aperture(t){this._aperture=t,this._camera&&(this._camera.aperture=t)}get shutter(){return this._shutter}set shutter(t){this._shutter=t,this._camera&&(this._camera.shutter=t)}get iso(){return this._iso}set iso(t){this._iso=t,this._camera&&(this._camera.iso=t)}get rect(){return this._rect}set rect(t){this._rect=t,this._camera&&(this._camera.viewport=t)}get targetTexture(){return this._targetTexture}set targetTexture(e){if(this._targetTexture===e)return;const i=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(i),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}get screenScale(){return this._screenScale}set screenScale(t){this._screenScale=t,this._camera&&(this._camera.screenScale=t)}get inEditorMode(){return this._inEditorMode}set inEditorMode(t){this._inEditorMode=t,this._camera&&this._camera.changeTargetWindow(t?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow)}onLoad(){this._createCamera()}onEnable(){this.node.hasChangedFlags|=Sg.POSITION,this._camera&&this._attachToScene()}onDisable(){this._camera&&this._detachFromScene()}onDestroy(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")}screenPointToRay(t,e,i){return i||(i=vs.create()),this._camera&&this._camera.screenPointToRay(i,t,e),i}worldToScreen(t,e){return e||(e=new Ni),this._camera&&this._camera.worldToScreen(e,t),e}screenToWorld(t,e){return e||(e=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(e,t),e}convertToUINode(t,e,i){if(i||(i=new Ni),!this._camera)return i;this.worldToScreen(t,vD);const s=e.getComponent("cc.UITransform"),r=vw.getVisibleSize(),o=vD.x-.5*this._camera.width,a=vD.y-.5*this._camera.height;return vD.x=o/n.view.getScaleX()+.5*r.width,vD.y=a/n.view.getScaleY()+.5*r.height,s&&s.convertToNodeSpaceAR(vD,i),i}_createCamera(){this._camera||(this._camera=n.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?n.director.root&&n.director.root.mainWindow:n.director.root&&n.director.root.tempWindow,priority:this._priority}),this._camera.viewport=this._rect,this._camera.fovAxis=this._fovAxis,this._camera.fov=di(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()}_attachToScene(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))}_detachFromScene(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)}_checkTargetTextureEvent(t){t&&t.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(t=>{this._camera&&this._camera.setFixedSize(t.width,t.height)}),this)}_updateTargetTexture(){if(this._camera&&this._targetTexture){const t=this._targetTexture.window;this._camera.changeTargetWindow(t),this._camera.setFixedSize(t.width,t.height)}}},gD.ProjectionType=xD,gD.FOVAxis=bD,gD.ClearFlag=TD,gD.Aperture=SD,gD.Shutter=AD,gD.ISO=CD,gD.TARGET_TEXTURE_CHANGE="tex-change",QP=wl((ZP=yD).prototype,"_projection",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xD.PERSPECTIVE}}),tD=wl(ZP.prototype,"_priority",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),eD=wl(ZP.prototype,"_fov",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),iD=wl(ZP.prototype,"_fovAxis",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return bD.VERTICAL}}),nD=wl(ZP.prototype,"_orthoHeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),sD=wl(ZP.prototype,"_near",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rD=wl(ZP.prototype,"_far",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),oD=wl(ZP.prototype,"_color",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri("#333333")}}),aD=wl(ZP.prototype,"_depth",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lD=wl(ZP.prototype,"_stencil",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),cD=wl(ZP.prototype,"_clearFlags",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TD.SOLID_COLOR}}),hD=wl(ZP.prototype,"_rect",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hn(0,0,1,1)}}),_D=wl(ZP.prototype,"_aperture",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SD.F16_0}}),uD=wl(ZP.prototype,"_shutter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AD.D125}}),mD=wl(ZP.prototype,"_iso",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CD.ISO100}}),pD=wl(ZP.prototype,"_screenScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),dD=wl(ZP.prototype,"_visibility",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fd}}),fD=wl(ZP.prototype,"_targetTexture",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wl(ZP.prototype,"priority",[cP,hP],Object.getOwnPropertyDescriptor(ZP.prototype,"priority"),ZP.prototype),wl(ZP.prototype,"visibility",[_P,uP,mP],Object.getOwnPropertyDescriptor(ZP.prototype,"visibility"),ZP.prototype),wl(ZP.prototype,"clearFlags",[pP,dP,fP],Object.getOwnPropertyDescriptor(ZP.prototype,"clearFlags"),ZP.prototype),wl(ZP.prototype,"clearColor",[gP,yP],Object.getOwnPropertyDescriptor(ZP.prototype,"clearColor"),ZP.prototype),wl(ZP.prototype,"clearDepth",[vP,xP],Object.getOwnPropertyDescriptor(ZP.prototype,"clearDepth"),ZP.prototype),wl(ZP.prototype,"clearStencil",[bP,SP],Object.getOwnPropertyDescriptor(ZP.prototype,"clearStencil"),ZP.prototype),wl(ZP.prototype,"projection",[AP,CP,TP],Object.getOwnPropertyDescriptor(ZP.prototype,"projection"),ZP.prototype),wl(ZP.prototype,"fovAxis",[wP,EP,PP],Object.getOwnPropertyDescriptor(ZP.prototype,"fovAxis"),ZP.prototype),wl(ZP.prototype,"fov",[DP,IP],Object.getOwnPropertyDescriptor(ZP.prototype,"fov"),ZP.prototype),wl(ZP.prototype,"orthoHeight",[RP,MP],Object.getOwnPropertyDescriptor(ZP.prototype,"orthoHeight"),ZP.prototype),wl(ZP.prototype,"near",[OP,BP],Object.getOwnPropertyDescriptor(ZP.prototype,"near"),ZP.prototype),wl(ZP.prototype,"far",[NP,LP],Object.getOwnPropertyDescriptor(ZP.prototype,"far"),ZP.prototype),wl(ZP.prototype,"aperture",[FP,zP,VP],Object.getOwnPropertyDescriptor(ZP.prototype,"aperture"),ZP.prototype),wl(ZP.prototype,"shutter",[UP,GP,kP],Object.getOwnPropertyDescriptor(ZP.prototype,"shutter"),ZP.prototype),wl(ZP.prototype,"iso",[HP,jP,WP],Object.getOwnPropertyDescriptor(ZP.prototype,"iso"),ZP.prototype),wl(ZP.prototype,"rect",[qP,XP],Object.getOwnPropertyDescriptor(ZP.prototype,"rect"),ZP.prototype),wl(ZP.prototype,"targetTexture",[YP,KP,$P],Object.getOwnPropertyDescriptor(ZP.prototype,"targetTexture"),ZP.prototype),JP=ZP))||JP)||JP)||JP)||JP,t({Camera:ED,CameraComponent:ED}),ED);var ED,PD,DD,ID,RD,MD,OD,BD,ND,LD;n.Camera=wD;const FD={parent:null,owner:null,subModelIdx:0};let zD=t("RenderableComponent",(PD=Vl("cc.RenderableComponent"),DD=yc([$g]),ID=yc($g),RD=_c(),MD=sc(),PD((ND=wl((BD=class extends Rh{constructor(...t){super(...t),Tl(this,"_materials",ND,this),Tl(this,"_visFlags",LD,this),this._materialInstances=[],this._models=[]}get visibility(){return this._visFlags}set visibility(t){this._visFlags=t,this._onVisibilityChange(t)}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get materials(){for(let t=0;t<this._materials.length;t++)this._materialInstances[t]=this.getMaterialInstance(t);return this._materialInstances}set materials(t){const e=t.length-this._materials.length;if(e>0)this._materials.length=t.length,this._materialInstances.length=t.length;else if(e<0)for(let t=this._materials.length-e;t<this._materials.length;++t)this.setMaterialInstance(null,t);for(let e=0;e<this._materialInstances.length;e++)this._materialInstances[e]!=t[e]&&this.setMaterialInstance(t[e],e)}get sharedMaterial(){return this.getMaterial(0)}getMaterial(t){return t<0||t>=this._materials.length?null:this._materials[t]}setMaterial(t,e){t&&t instanceof ny&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[e]=t;const i=this._materialInstances[e];i&&(i.destroy(),this._materialInstances[e]=null),this._onMaterialModified(e,this._materials[e])}get material(){return this.getMaterialInstance(0)}set material(t){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==t)&&this.setMaterialInstance(t,0)}getMaterialInstance(t){if(!this._materials[t])return null;if(!this._materialInstances[t]){FD.parent=this._materials[t],FD.owner=this,FD.subModelIdx=t;const e=new ny(FD);FD.parent=null,FD.owner=null,FD.subModelIdx=0,this.setMaterialInstance(e,t)}return this._materialInstances[t]}setMaterialInstance(t,e){if("number"==typeof t){A(12007);const i=t;t=e,e=i}const i=this._materialInstances[e];t&&t.parent?t!==i&&(this._materialInstances[e]=t,this._onMaterialModified(e,t)):(t!==this._materials[e]||i)&&this.setMaterial(t,e)}getRenderMaterial(t){return this._materialInstances[t]||this._materials[t]}_collectModels(){return this._models}_attachToScene(){}_detachFromScene(){}_onMaterialModified(t,e){}_onRebuildPSO(t,e){}_clearMaterials(){}_onVisibilityChange(t){}}).prototype,"_materials",[DD],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LD=wl(BD.prototype,"_visFlags",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Qm.Enum.NONE}}),wl(BD.prototype,"sharedMaterials",[ID,RD,MD],Object.getOwnPropertyDescriptor(BD.prototype,"sharedMaterials"),BD.prototype),OD=BD))||OD));var VD,UD,GD,kD,HD,jD;function WD(t){return"string"==typeof t||"number"==typeof t}n.RenderableComponent=zD,Ze(wD,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),Ze(wD.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),n.CameraComponent=wD,Ot.setClassAlias(wD,"cc.CameraComponent");let qD=Vl("cc.animation.HierarchyPath")((GD=wl((UD=class{constructor(t){Tl(this,"path",GD,this),this.path=t||""}get(t){if(!(t instanceof Yv))return A(3925),null;return t.getChildByPath(this.path)||(A(3926,t.name,this.path),null)}}).prototype,"path",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),VD=UD))||VD,XD=Vl("cc.animation.ComponentPath")((jD=wl((HD=class{constructor(t){Tl(this,"component",jD,this),this.component=t||""}get(t){if(!(t instanceof Yv))return A(3927),null;return t.getComponent(this.component)||(A(3928,t.name,this.component),null)}}).prototype,"component",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),kD=HD))||kD;var YD,KD,$D,JD,ZD;let QD=Vl("cc.animation.UniformProxyFactory")(($D=wl((KD=class{constructor(t,e){Tl(this,"passIndex",$D,this),Tl(this,"uniformName",JD,this),Tl(this,"channelIndex",ZD,this),this.passIndex=e||0,this.uniformName=t||""}forTarget(t){const e=t.passes[this.passIndex],i=e.getHandle(this.uniformName);if(!i)throw new Error(`Material "${t.name}" has no uniform "${this.uniformName}"`);const s=_g.getPropertyTypeFromHandle(i);if(s===zf.BUFFER){const n=void 0===this.channelIndex?i:e.getHandle(this.uniformName,this.channelIndex,Ns.FLOAT);if(!n)throw new Error(`Uniform "${this.uniformName} (in material ${t.name}) has no channel ${this.channelIndex}"`);return function(t,e){for(const i of t.shaderInfo.blocks)for(const t of i.members)if(t.name===e)return t.count>1;return!1}(e,this.uniformName)?{set:t=>{e.setUniformArray(n,t)}}:{set:t=>{e.setUniform(n,t)}}}if(s===zf.TEXTURE){const t=_g.getBindingFromHandle(i),s=e.properties[this.uniformName],r=s&&s.value?`${s.value}-texture`:Yf(s.type);let o=rg.get(r);return o||(m(`Illegal texture default value: ${r}.`),o=rg.get("default-texture")),{set:i=>{i||(i=o);const s=i.getGFXTexture();s&&s.width&&s.height&&(e.bindTexture(t,s),i instanceof lf&&e.bindSampler(t,Xd.getSampler(n.game._gfxDevice,i.getSamplerHash())))}}}throw new Error(`Animations are not available for uniforms with property type ${s}.`)}}).prototype,"passIndex",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),JD=wl(KD.prototype,"uniformName",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),ZD=wl(KD.prototype,"channelIndex",[dc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),YD=KD))||YD;var tI,eI,iI,nI,sI,rI,oI,aI;let lI=Vl("cc.animation.MorphWeightValueProxy")((iI=wl((eI=class{constructor(){Tl(this,"subMeshIndex",iI,this),Tl(this,"shapeIndex",nI,this)}forTarget(t){return{set:e=>{t.setWeight(e,this.subMeshIndex,this.shapeIndex)}}}}).prototype,"subMeshIndex",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nI=wl(eI.prototype,"shapeIndex",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),tI=eI))||tI,cI=Vl("cc.animation.MorphWeightsValueProxy")((oI=wl((rI=class{constructor(){Tl(this,"subMeshIndex",oI,this)}forTarget(t){return{set:e=>{t.setWeights(e,this.subMeshIndex)}}}}).prototype,"subMeshIndex",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sI=rI))||sI,hI=Vl("cc.animation.MorphWeightsAllValueProxy")(aI=class{forTarget(t){return{set:e=>{var i,n;const s=null!==(i=null===(n=t.mesh)||void 0===n?void 0:n.struct.primitives.length)&&void 0!==i?i:0;for(let i=0;i<s;++i)t.setWeights(e,i)}}}})||aI;var _I,uI,mI,pI,dI;function fI(t,e,i,n){var s,r,o,a,l;let c=new e,h=new e,_=new e,u=Vl(t)((o=wl((r=class{constructor(t,i,n){Tl(this,"dataPoint",o,this),Tl(this,"inTangent",a,this),Tl(this,"outTangent",l,this),this.dataPoint=t||new e,this.inTangent=i||new e,this.outTangent=n||new e}lerp(t,e,s){const r=this.dataPoint,o=t.dataPoint;h=i(h,this.inTangent,s),_=i(_,t.outTangent,s);const a=e*e*e,l=e*e,u=a-2*l+e,m=-2*a+3*l,p=a-l;return c=i(c,r,2*a-3*l+1),c=n(c,c,h,u),c=n(c,c,o,m),c=n(c,c,_,p),c}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),a=wl(r.prototype,"inTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),l=wl(r.prototype,"outTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new e}}),s=r))||s;if(e===ki){const t=u.prototype.lerp;u.prototype.lerp=function(e,i,n){const s=t.call(this,e,i,n);return ki.normalize(s,s),s}}return u}const gI=t("CubicSplineVec2Value",fI("cc.CubicSplineVec2Value",tn,tn.multiplyScalar,tn.scaleAndAdd));n.CubicSplineVec2Value=gI;const yI=t("CubicSplineVec3Value",fI("cc.CubicSplineVec3Value",Ni,Ni.multiplyScalar,Ni.scaleAndAdd));n.CubicSplineVec3Value=yI;const vI=t("CubicSplineVec4Value",fI("cc.CubicSplineVec4Value",rn,rn.multiplyScalar,rn.scaleAndAdd));n.CubicSplineVec4Value=vI;const xI=t("CubicSplineQuatValue",fI("cc.CubicSplineQuatValue",ki,ki.multiplyScalar,ki.scaleAndAdd));n.CubicSplineQuatValue=xI;let bI=t("CubicSplineNumberValue",Vl("cc.CubicSplineNumberValue")((mI=wl((uI=class{constructor(t,e,i){Tl(this,"dataPoint",mI,this),Tl(this,"inTangent",pI,this),Tl(this,"outTangent",dI,this),this.dataPoint=t,this.inTangent=e,this.outTangent=i}lerp(t,e,i){const n=this.dataPoint,s=t.dataPoint,r=e*e*e,o=e*e;return n*(2*r-3*o+1)+this.outTangent*i*(r-2*o+e)+s*(-2*r+3*o)+t.inTangent*i*(r-o)}getNoLerp(){return this.dataPoint}}).prototype,"dataPoint",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pI=wl(uI.prototype,"inTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dI=wl(uI.prototype,"outTangent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_I=uI))||_I);n.CubicSplineNumberValue=bI;const SI=Symbol("CreateEval");var AI,CI,TI,wI,EI,PI,DI,II,RI,MI,OI,BI,NI,LI,FI,zI;const VI=Symbol("NormalizedFollow"),UI=Symbol("ConvertAsTrsPath"),GI=Symbol("TrackBinding");let kI=Vl("cc.animation.TrackPath")((TI=wl((CI=class t{constructor(){Tl(this,"_paths",TI,this)}get length(){return this._paths.length}toProperty(t){return this._paths.push(t),this}toElement(t){return this._paths.push(t),this}toHierarchy(t){return this._paths.push(new qD(t)),this}toComponent(t){const e=new XD("string"==typeof t?t:Ot.getClassName(t));return this._paths.push(e),this}toCustomized(t){return this._paths.push(t),this}append(...t){const e=this._paths.concat(...t.map((t=>t._paths)));return this._paths=e,this}isPropertyAt(t){return"string"==typeof this._paths[t]}parsePropertyAt(t){return this._paths[t]}isElementAt(t){return"number"==typeof this._paths[t]}parseElementAt(t){return this._paths[t]}isHierarchyAt(t){return this._paths[t]instanceof qD}parseHierarchyAt(t){return this.isHierarchyAt(t),this._paths[t].path}isComponentAt(t){return this._paths[t]instanceof XD}parseComponentAt(t){return this.isComponentAt(t),this._paths[t].component}slice(e,i){const n=new t;return n._paths=this._paths.slice(e,i),n}trace(t,e,i){var n,s;return null!==(n=e)&&void 0!==n||(e=0),null!==(s=i)&&void 0!==s||(i=this._paths.length),this[VI](t,e,i)}[UI](){const{_paths:t}=this,e=t.length;let i,n=0,s="";for(;n<e;++n){const e=t[n];if(!(e instanceof qD))break;e.path&&(s?s+=`/${e.path}`:s=e.path)}if(n===e)return null;if(n!==e-1)return null;switch(t[n]){case"position":case"scale":case"rotation":case"eulerAngles":i=t[n];break;default:return null}return{node:s,property:i}}[VI](t,e,i){const{_paths:n}=this;let s=t;for(let t=e;t<i;++t){const e=n[t];if(WD(e)){if(!(e in s))return A(3929,e),null;s=s[e]}else s=e.get(s);if(null===s)break}return s}}).prototype,"_paths",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),AI=CI))||AI,HI=Vl("cc.animation.TrackBinding")(wI=Kl((PI=wl((EI=class{constructor(){Tl(this,"path",PI,this),Tl(this,"proxy",DI,this)}parseTrsPath(){return this.proxy?null:this.path[UI]()}createRuntimeBinding(t,e,i){const{path:n,proxy:s}=this,r=n.length,o=r-1;if(0===r||!n.isPropertyAt(o)&&!n.isElementAt(o)||s){if(s){const e=n[VI](t,0,r);if(null===e)return null;const i=s.forTarget(e),o={setValue:t=>{i.set(t)}},a=i.get;return a&&(o.getValue=()=>a.call(i)),o}return T(3921),null}{const s=n.isPropertyAt(o)?n.parsePropertyAt(o):n.parseElementAt(o),a=n[VI](t,0,r-1);return null===a?null:e&&a instanceof Yv&&function(t){return"position"===t||"rotation"===t||"scale"===t||"eulerAngles"===t}(s)?e.createPoseWriter(a,s,i):{setValue:t=>{a[s]=t},getValue:()=>a[s]}}}}).prototype,"path",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kI}}),DI=wl(EI.prototype,"proxy",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wI=EI))||wI)||wI,jI=Vl("cc.animation.Track")((MI=wl((RI=class{constructor(){Tl(this,"_binding",MI,this)}get path(){return this._binding.path}set path(t){this._binding.path=t}get proxy(){return this._binding.proxy}set proxy(t){this._binding.proxy=t}get[GI](){return this._binding}channels(){return[]}range(){const t={min:1/0,max:-1/0};for(const e of this.channels())t.min=Math.min(t.min,e.curve.rangeMin),t.max=Math.max(t.max,e.curve.rangeMax);return t}[SI](t){throw new Error("No Impl")}}).prototype,"_binding",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HI}}),II=RI))||II,WI=Vl("cc.animation.Channel")((NI=wl((BI=class{constructor(t){this.name="",Tl(this,"_curve",NI,this),this._curve=t}get curve(){return this._curve}}).prototype,"_curve",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),OI=BI))||OI,qI=Vl("cc.animation.SingleChannelTrack")((zI=wl((FI=class extends jI{constructor(){super(),Tl(this,"_channel",zI,this),this._channel=new WI(this.createCurve())}get channel(){return this._channel}channels(){return[this._channel]}createCurve(){throw new Error("Not impl")}[SI](t){const{curve:e}=this._channel;return new XI(e)}}).prototype,"_channel",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),LI=FI))||LI;class XI{constructor(t){this._curve=t}evaluate(t){return this._curve.evaluate(t)}}var YI;let KI=Vl("cc.animation.RealTrack")(YI=class extends qI{createCurve(){return new ju}})||YI;function $I(t){return 0===t.keyFramesCount?void 0:t}var JI,ZI,QI,tR;const eR=["X","Y","Z","W"];let iR=Vl("cc.animation.VectorTrack")((QI=wl((ZI=class extends jI{constructor(){super(),Tl(this,"_channels",QI,this),Tl(this,"_nComponents",tR,this),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new WI(new ju);e.name=eR[t],this._channels[t]=e}}get componentsCount(){return this._nComponents}set componentsCount(t){this._nComponents=t}channels(){return this._channels}[SI](){switch(this._nComponents){default:case 2:return new nR($I(this._channels[0].curve),$I(this._channels[1].curve));case 3:return new sR($I(this._channels[0].curve),$I(this._channels[1].curve),$I(this._channels[2].curve));case 4:return new rR($I(this._channels[0].curve),$I(this._channels[1].curve),$I(this._channels[2].curve),$I(this._channels[3].curve))}}}).prototype,"_channels",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tR=wl(ZI.prototype,"_nComponents",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),JI=ZI))||JI;class nR{constructor(t,e){this._result=new tn,this._x=t,this._y=e}evaluate(t,e){return this._x&&this._y||!e.getValue||tn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._result}}class sR{constructor(t,e,i){this._result=new Ni,this._x=t,this._y=e,this._z=i}evaluate(t,e){return this._x&&this._y&&this._z||!e.getValue||Ni.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._result}}class rR{constructor(t,e,i,n){this._result=new rn,this._x=t,this._y=e,this._z=i,this._w=n}evaluate(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||rn.copy(this._result,e.getValue()),this._x&&(this._result.x=this._x.evaluate(t)),this._y&&(this._result.y=this._y.evaluate(t)),this._z&&(this._result.z=this._z.evaluate(t)),this._w&&(this._result.w=this._w.evaluate(t)),this._result}}var oR;let aR=Vl("cc.animation.QuatTrack")(oR=class extends qI{createCurve(){return new Pm}[SI](){return new lR(this.channels()[0].curve)}})||oR;class lR{constructor(t){this._result=new ki,this._curve=t}evaluate(t){return this._curve.evaluate(t,this._result),this._result}}var cR,hR,_R;const uR=["Red","Green","Blue","Alpha"];let mR=Vl("cc.animation.ColorTrack")((_R=wl((hR=class extends jI{constructor(){super(),Tl(this,"_channels",_R,this),this._channels=new Array(4);for(let t=0;t<this._channels.length;++t){const e=new WI(new ju);e.name=uR[t],this._channels[t]=e}}channels(){return this._channels}[SI](){return new pR($I(this._channels[0].curve),$I(this._channels[1].curve),$I(this._channels[2].curve),$I(this._channels[3].curve))}}).prototype,"_channels",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cR=hR))||cR;class pR{constructor(t,e,i,n){this._result=new Ri,this._x=t,this._y=e,this._z=i,this._w=n}evaluate(t,e){return this._x&&this._y&&this._z&&this._w||!e.getValue||Ri.copy(this._result,e.getValue()),this._x&&(this._result.r=this._x.evaluate(t)),this._y&&(this._result.g=this._y.evaluate(t)),this._z&&(this._result.b=this._z.evaluate(t)),this._w&&(this._result.a=this._w.evaluate(t)),this._result}}var dR,fR,gR;const yR=["Width","Height"];let vR=Vl("cc.animation.SizeTrack")((gR=wl((fR=class extends jI{constructor(){super(),Tl(this,"_channels",gR,this),this._channels=new Array(2);for(let t=0;t<this._channels.length;++t){const e=new WI(new ju);e.name=yR[t],this._channels[t]=e}}channels(){return this._channels}[SI](){return new xR($I(this._channels[0].curve),$I(this._channels[1].curve))}}).prototype,"_channels",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dR=fR))||dR;class xR{constructor(t,e){this._result=new ln,this._width=t,this._height=e}evaluate(t,e){if((!this._width||!this._height)&&e.getValue){const t=e.getValue();this._result.x=t.x,this._result.y=t.y}return this._width&&(this._result.width=this._width.evaluate(t)),this._height&&(this._result.height=this._height.evaluate(t)),this._result}}var bR;let SR=Vl("cc.animation.ObjectTrack")(bR=class extends qI{createCurve(){return new Vm}})||bR;t("animation",Object.freeze({__proto__:null,UniformProxyFactory:QD,MorphWeightValueProxy:lI,MorphWeightsValueProxy:cI,MorphWeightsAllValueProxy:hI,Track:jI,TrackPath:kI,RealTrack:KI,VectorTrack:iR,QuatTrack:aR,ColorTrack:mR,SizeTrack:vR,ObjectTrack:SR,isPropertyPath:WD,isCustomPath:function(t,e){return t instanceof e},HierarchyPath:qD,ComponentPath:XD,CubicSplineVec2Value:gI,CubicSplineVec3Value:yI,CubicSplineVec4Value:vI,CubicSplineQuatValue:xI,CubicSplineNumberValue:bI}));const AR=Symbol("BakeNodeCurves");class CR{static getOrExtract(t){let e=CR.pool.get(t);if(!e||e.samples!==t.sample){e&&n.director.root.dataPoolManager.releaseAnimationClip(t);const i=Math.ceil(t.sample*t.duration)+1,s=t.sample;e=t[AR](0,s,i),CR.pool.set(t,e)}return e}static destroy(t){CR.pool.delete(t)}}CR.pool=new Map;class TR{constructor(t){let e,i;this.ratios=void 0,this._findRatio=void 0,this.ratios=t;let n=!0;for(let s=1,r=t.length;s<r;s++)if(e=t[s]-t[s-1],1===s)i=e;else if(Math.abs(e-i)>1e-6){n=!1;break}this._findRatio=n?DR:Il}sample(t){return this._findRatio(this.ratios,t)}}t("RatioSampler",TR),n.RatioSampler=TR;class wR{static Bezier(t){return t}constructor(t,e){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=e,this._values=t.values;const i=t=>"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?wR.Linear:wR.Bezier(t):wR.Linear;if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(const e of Object.keys(t.easingMethods))this.types[e]=i(t.easingMethods[e])}else this.type=null;const n=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=IR(n)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}hasLerp(){return!!this._lerp}valueAt(t){if(void 0===this._array){const e=this._values[t];return e&&e.getNoLerp?e.getNoLerp():e}for(let e=0;e<this._array.length;++e)this._array[e]=this._values[this._array.length*t+e];return this._array}valueBetween(t,e,i,n,s){if(this._lerp){const r=this.types?this.types[e]:this.type,o=s-i;let a=(t-i)/o;if(r&&(a=PR(a,r)),void 0===this._array){const t=this._values[e],i=this._values[n];return this._lerp(t,i,a,o*this._duration)}for(let t=0;t<this._array.length;++t){const i=this._values[this._array.length*e+t],s=this._values[this._array.length*n+t];this._array[t]=this._lerp(i,s,a,o*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(e);for(let t=0;t<this._array.length;++t)this._array[t]=this._values[this._array.length*e+t];return this._array}empty(){return 0===this._values.length}constant(){return 1===this._values.length}}function ER(t,e,i){let n=e.sample(i);if(n<0)if(n=~n,n<=0)n=0;else{if(!(n>=e.ratios.length))return t.valueBetween(i,n-1,e.ratios[n-1],n,e.ratios[n]);n=e.ratios.length-1}return t.valueAt(n)}function PR(t,e){if("string"==typeof e){const i=Cu[e];i?t=i(t):T(3906,e)}else Array.isArray(e)&&(t=dm(e,t));return t}function DR(t,e){const i=t.length-1;if(0===i)return 0;const n=t[0];if(e<n)return 0;const s=t[i];if(e>s)return i;const r=(e=(e-n)/(s-n))/(1/i),o=0|r,a=1e-6;return r-o<a?o:o+1-r<a?o+1:~(o+1)}t("AnimCurve",wR),wR.Linear=null,n.AnimCurve=wR,t("EventInfo",class{constructor(){this.events=[]}add(t,e){this.events.push({func:t||"",params:e||[]})}}),n.sampleAnimationCurve=ER;const IR=(()=>{function t(t,e,i,n){return t.lerp(e,i,n)}return e=>{if(null!==e){if("number"==typeof e)return pi;if("object"==typeof e&&e.constructor){if(e instanceof ki)return function(){const t=new ki;return(e,i,n)=>ki.slerp(t,e,i,n)}();if(e instanceof Vt)return function(t){const e=new t;return(i,n,s)=>(t.lerp(e,i,n,s),e)}(e.constructor);if(e.constructor===Number)return pi;if("function"==typeof e.lerp)return t}}}})();var RR,MR,OR,BR,NR,LR;let FR=Vl("cc.animation.UntypedTrackChannel")((OR=wl((MR=class extends WI{constructor(){super(new ju),Tl(this,"property",OR,this)}}).prototype,"property",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),RR=MR))||RR,zR=Vl("cc.animation.UntypedTrack")((LR=wl((NR=class extends jI{constructor(...t){super(...t),Tl(this,"_channels",LR,this)}channels(){return this._channels}[SI](t){if(!t.getValue)throw new Error(D(3930));const e=t=>{var e;return null===(e=this._channels.find((e=>e.property===t)))||void 0===e?void 0:e.curve},i=t.getValue();switch(!0){default:throw new Error(D(3931));case i instanceof tn:return new nR(e("x"),e("y"));case i instanceof Ni:return new sR(e("x"),e("y"),e("z"));case i instanceof rn:return new rR(e("x"),e("y"),e("z"),e("w"));case i instanceof Ri:return new pR(e("r"),e("g"),e("b"),e("a"));case i instanceof ln:return new xR(e("width"),e("height"))}}addChannel(t){const e=new FR;return e.property=t,this._channels.push(e),e}upgrade(t){const e=(t,e)=>{const i=this.channels().find((e=>e.property===t));i&&(e.name=i.name,e.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=t(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":{const t=new iR;t.path=this.path,t.proxy=this.proxy,t.componentsCount="vec2"===i?2:"vec3"===i?3:4;const[n,s,r,o]=t.channels();switch(i){case"vec4":e("w",o);case"vec3":e("z",r);default:case"vec2":e("x",n),e("y",s)}return t}case"color":{const t=new mR,[i,n,s,r]=t.channels();return e("r",i),e("g",n),e("b",s),e("a",r),e("x",i),e("y",n),e("z",s),e("w",r),t}case"size":}return null}}).prototype,"_channels",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BR=NR))||BR;class VR{constructor(t){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=t}get keys(){return this._keys}set keys(t){this._keys=t}get curves(){return this._curves}set curves(t){this._curves=t,delete this._runtimeCurves}get commonTargets(){return this._commonTargets}set commonTargets(t){this._commonTargets=t}get data(){return this._data}getPropertyCurves(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves}toTracks(){const t=[],{keys:e,curves:i,commonTargets:n}=this,s=(t,e,i)=>{const n=new kI;for(const t of e)"string"==typeof t?n.toProperty(t):"number"==typeof t?n.toElement(t):t instanceof qD?n.toHierarchy(t.path):t instanceof XD?n.toComponent(t.component):n.toCustomized(t);t.path=n,t.proxy=i},r=n.map((e=>{const i=new zR;return s(i,e.modifiers,e.valueAdapter),t.push(i),i}));for(const n of i){var o;const i=n.data,a=i.values;if(0===a.length)continue;const l=i.keys<0?[0]:e[i.keys],c=a[0],h=null===(o=i.interpolate)||void 0===o||o;i._arrayLength;const _=new GR(i,l.length),u=t=>{s(t,n.modifiers,n.valueAdapter)};let m;if("number"==typeof n.commonTarget){if(!a.every((t=>"number"==typeof t))){A(3932);continue}if(n.valueAdapter||1!==n.modifiers.length||"string"!=typeof n.modifiers[0]){A(3933);continue}const t=n.modifiers[0],e=r[n.commonTarget],{curve:i}=e.addChannel(t);m=i}(()=>{if("number"==typeof c){if(!a.every((t=>"number"==typeof t)))return void A(3934);let e;if(m)e=m;else{const i=new KI;u(i),t.push(i),e=i.channel.curve}const i=h?Tc.LINEAR:Tc.CONSTANT;return e.assignSorted(l,a.map((t=>({value:t,interpolationMode:i})))),void _.convert(e)}if("object"==typeof c)switch(!0){default:break;case UR(a,tn):case UR(a,Ni):case UR(a,rn):{const e=c instanceof tn?2:c instanceof Ni?3:4,i=new iR;u(i),i.componentsCount=e;const[{curve:n},{curve:s},{curve:r},{curve:o}]=i.channels(),m=h?Tc.LINEAR:Tc.CONSTANT,p=t=>({value:t,interpolationMode:m});switch(e){case 4:o.assignSorted(l,a.map((t=>p(t.w)))),_.convert(o);case 3:r.assignSorted(l,a.map((t=>p(t.z)))),_.convert(r);default:n.assignSorted(l,a.map((t=>p(t.x)))),_.convert(n),s.assignSorted(l,a.map((t=>p(t.y)))),_.convert(s)}return void t.push(i)}case UR(a,ki):{const e=new aR;u(e);const i=h?Tm.SLERP:Tm.CONSTANT;return e.channel.curve.assignSorted(l,a.map((t=>({value:ki.clone(t),interpolationMode:i})))),_.convertQuatCurve(e.channel.curve),void t.push(e)}case UR(a,Ri):{const e=new mR;u(e);const[{curve:i},{curve:n},{curve:s},{curve:r}]=e.channels(),o=h?Tc.LINEAR:Tc.CONSTANT,c=t=>({value:t,interpolationMode:o});return i.assignSorted(l,a.map((t=>c(t.r)))),_.convert(i),n.assignSorted(l,a.map((t=>c(t.g)))),_.convert(n),s.assignSorted(l,a.map((t=>c(t.b)))),_.convert(s),r.assignSorted(l,a.map((t=>c(t.a)))),_.convert(r),void t.push(e)}case UR(a,ln):{const e=new vR;u(e);const[{curve:i},{curve:n}]=e.channels(),s=h?Tc.LINEAR:Tc.CONSTANT,r=t=>({value:t,interpolationMode:s});return i.assignSorted(l,a.map((t=>r(t.width)))),_.convert(i),n.assignSorted(l,a.map((t=>r(t.height)))),_.convert(n),void t.push(e)}case UR(a,bI):{const e=new KI;u(e);const i=h?Tc.CUBIC:Tc.CONSTANT;return e.channel.curve.assignSorted(l,a.map((t=>({value:t.dataPoint,leftTangent:t.inTangent,rightTangent:t.outTangent,interpolationMode:i})))),void t.push(e)}case UR(a,gI):case UR(a,yI):case UR(a,vI):{const e=c instanceof gI?2:c instanceof yI?3:4,i=new iR;u(i),i.componentsCount=e;const[n,s,r,o]=i.channels(),_=h?Tc.LINEAR:Tc.CONSTANT,m=(t,e,i)=>({value:t,leftTangent:e,rightTangent:i,interpolationMode:_});switch(e){case 4:o.curve.assignSorted(l,a.map((t=>m(t.dataPoint.w,t.inTangent.w,t.outTangent.w))));case 3:r.curve.assignSorted(l,a.map((t=>m(t.dataPoint.z,t.inTangent.z,t.outTangent.z))));default:n.curve.assignSorted(l,a.map((t=>m(t.dataPoint.y,t.inTangent.y,t.outTangent.y)))),s.curve.assignSorted(l,a.map((t=>m(t.dataPoint.x,t.inTangent.x,t.outTangent.x))))}return void t.push(i)}case a.every((t=>t instanceof xI)):A(3935)}const e=new SR;u(e),e.channel.curve.assignSorted(l,a),t.push(e)})()}return t}_createPropertyCurves(){this._ratioSamplers=this._keys.map((t=>new TR(t.map((t=>t/this._duration))))),this._runtimeCurves=this._curves.map((t=>({curve:new wR(t.data,this._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:this._ratioSamplers[t.data.keys],commonTarget:t.commonTarget})))}}function UR(t,e){return t.every((t=>t instanceof e))}class GR{constructor(t,e){this._easingMethods=void 0;const{easingMethods:i}=t;Array.isArray(i)?0===i.length&&0!==e?this._easingMethods=new Array(e).fill(null):this._easingMethods=i:this._easingMethods=void 0===i?new Array(e).fill(t.easingMethod):Array.from({length:e},((t,e)=>{var n;return null!==(n=i[e])&&void 0!==n?n:null}))}get nil(){return!this._easingMethods||this._easingMethods.every((t=>null==t))}convert(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const n=i-1;for(let i=0;i<n;++i){const n=e[i];n&&(Array.isArray(n)?WR(n,t.getKeyframeTime(i),t.getKeyframeValue(i),t.getKeyframeTime(i+1),t.getKeyframeValue(i+1)):kR(n,t,i))}}convertQuatCurve(t){const{_easingMethods:e}=this;if(!e)return;const i=t.keyFramesCount;if(t.keyFramesCount<2)return;Array.isArray(e)&&e.length;const n=i-1;for(let i=0;i<n;++i){const n=e[i];n&&(Array.isArray(n)?t.getKeyframeValue(i).easingMethod=n.slice():HR(n,t,i))}}}function kR(t,e,i){e.keyFramesCount;const n=e.getKeyframeValue(i),s=jR[t];s===Tu.CONSTANT?n.interpolationMode=Tc.CONSTANT:(n.interpolationMode=Tc.LINEAR,n.easingMethod=s)}function HR(t,e,i){e.keyFramesCount;const n=e.getKeyframeValue(i),s=jR[t];n.easingMethod=s}const jR={constant:Tu.CONSTANT,linear:Tu.LINEAR,quadIn:Tu.QUAD_IN,quadOut:Tu.QUAD_OUT,quadInOut:Tu.QUAD_IN_OUT,quadOutIn:Tu.QUAD_OUT_IN,cubicIn:Tu.CUBIC_IN,cubicOut:Tu.CUBIC_OUT,cubicInOut:Tu.CUBIC_IN_OUT,cubicOutIn:Tu.CUBIC_OUT_IN,quartIn:Tu.QUART_IN,quartOut:Tu.QUART_OUT,quartInOut:Tu.QUART_IN_OUT,quartOutIn:Tu.QUART_OUT_IN,quintIn:Tu.QUINT_IN,quintOut:Tu.QUINT_OUT,quintInOut:Tu.QUINT_IN_OUT,quintOutIn:Tu.QUINT_OUT_IN,sineIn:Tu.SINE_IN,sineOut:Tu.SINE_OUT,sineInOut:Tu.SINE_IN_OUT,sineOutIn:Tu.SINE_OUT_IN,expoIn:Tu.EXPO_IN,expoOut:Tu.EXPO_OUT,expoInOut:Tu.EXPO_IN_OUT,expoOutIn:Tu.EXPO_OUT_IN,circIn:Tu.CIRC_IN,circOut:Tu.CIRC_OUT,circInOut:Tu.CIRC_IN_OUT,circOutIn:Tu.CIRC_OUT_IN,elasticIn:Tu.ELASTIC_IN,elasticOut:Tu.ELASTIC_OUT,elasticInOut:Tu.ELASTIC_IN_OUT,elasticOutIn:Tu.ELASTIC_OUT_IN,backIn:Tu.BACK_IN,backOut:Tu.BACK_OUT,backInOut:Tu.BACK_IN_OUT,backOutIn:Tu.BACK_OUT_IN,bounceIn:Tu.BOUNCE_IN,bounceOut:Tu.BOUNCE_OUT,bounceInOut:Tu.BOUNCE_IN_OUT,bounceOutIn:Tu.BOUNCE_OUT_IN,smooth:Tu.SMOOTH,fade:Tu.FADE};function WR(t,e,i,n,s){const[r,o,a,l]=t,{value:c}=i,{value:h}=s,_=3*(n-e),u=3*(h-c),m=r*_,p=o*u,d=(1-a)*_,f=(1-l)*u,g=1/3,y=p/m,v=Math.sqrt(m*m+p*p)*g,x=f/d,b=Math.sqrt(d*d+f*f)*g;var S;i.interpolationMode=Tc.CUBIC,i.tangentWeightMode=(S=i.tangentWeightMode)===Ec.NONE?Ec.RIGHT:S===Ec.LEFT?Ec.BOTH:S,i.rightTangent=y,i.rightTangentWeight=v,s.tangentWeightMode=function(t){return t===Ec.NONE?Ec.LEFT:t===Ec.RIGHT?Ec.BOTH:t}(s.tangentWeightMode),s.leftTangent=x,s.leftTangentWeight=b}var qR,XR,YR,KR,$R,JR,ZR,QR,tM,eM,iM,nM,sM,rM,oM,aM,lM,cM,hM,_M,uM,mM,pM,dM;function fM(){throw new Error("split() only valid in Editor.")}Vl("cc.animation.ExoticAnimation")((XR=wl((qR=class{constructor(){Tl(this,"_nodeAnimations",XR,this)}createEvaluator(t){return new CM(this._nodeAnimations,t)}addNodeAnimation(t){const e=new gM(t);return this._nodeAnimations.push(e),e}collectAnimatedJoints(){return Array.from(new Set(this._nodeAnimations.map((({path:t})=>t))))}split(t,e){return fM()}toHashString(){return this._nodeAnimations.map((t=>t.toHashString())).join("\n")}}).prototype,"_nodeAnimations",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qR));let gM=Vl("cc.animation.ExoticNodeAnimation")(($R=wl((KR=class{constructor(t){Tl(this,"_path",$R,this),Tl(this,"_position",JR,this),Tl(this,"_rotation",ZR,this),Tl(this,"_scale",QR,this),this._path=t}createPosition(t,e){this._position=new AM(t,new bM(e))}createRotation(t,e){this._rotation=new AM(t,new SM(e))}createScale(t,e){this._scale=new AM(t,new bM(e))}createEvaluator(t){return new TM(this._path,this._position,this._rotation,this._scale,t)}split(t,e,i){return fM()}get path(){return this._path}toHashString(){var t,e,i,n,s,r;return`${this._path}\n${null!==(t=null===(e=this._position)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}${null!==(i=null===(n=this._scale)||void 0===n?void 0:n.toHashString())&&void 0!==i?i:""}${null!==(s=null===(r=this._rotation)||void 0===r?void 0:r.toHashString())&&void 0!==s?s:""}`}}).prototype,"_path",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),JR=wl(KR.prototype,"_position",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZR=wl(KR.prototype,"_rotation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QR=wl(KR.prototype,"_scale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YR=KR))||YR;function yM(t){return t.toPrecision(2)}function vM(t){return t.map(yM).join(" ")}let xM=Vl("cc.animation.ExoticVectorLikeTrackValues")((iM=wl((eM=class{constructor(t){Tl(this,"_values",iM,this),Tl(this,"_isQuantized",nM,this),this._values=t,this._isQuantized=!1}get precision(){return this._isQuantized?this._values.originalPrecision:DM(this._values)}quantize(t){this._isQuantized,this._values=function(t,e){const i=EM[e],n=1<<i.BYTES_PER_ELEMENT;let s=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;t.forEach((t=>{s=Math.min(t,s),r=Math.max(t,r)}));const o=r-s,a=i.from(t,(t=>(t-s)/o*n));return new IM(DM(t),a,o,s)}(this._values,t),this._isQuantized=!0}toHashString(){const{_isQuantized:t,_values:e}=this;return`${t} ${t?e.toHashString():vM(e)}`}}).prototype,"_values",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),nM=wl(eM.prototype,"_isQuantized",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tM=eM))||tM,bM=Vl("cc.animation.ExoticVec3TrackValues")(sM=class t extends xM{static imitate(e,i){const n=new t(e);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(t,e){const{_values:i,_isQuantized:n}=this;n?OM(i,t,e):Ni.fromArray(e,i,3*t)}lerp(t,e,i,n,s,r){const{_values:o,_isQuantized:a}=this;a?(OM(o,t,n),OM(o,e,s)):(Ni.fromArray(n,o,3*t),Ni.fromArray(s,o,3*e)),Ni.lerp(r,n,s,i)}})||sM,SM=Vl("cc.animation.ExoticQuatTrackValues")(rM=class t extends xM{static imitate(e,i){const n=new t(e);return i._isQuantized&&n.quantize(i._values.quantizationType),n}get(t,e){const{_values:i,_isQuantized:n}=this;n?BM(i,t,e):ki.fromArray(e,i,4*t)}lerp(t,e,i,n,s,r){const{_values:o,_isQuantized:a}=this;a?(BM(o,t,n),BM(o,e,s)):(ki.fromArray(n,o,4*t),ki.fromArray(s,o,4*e)),ki.slerp(r,n,s,i)}})||rM,AM=Vl("cc.animation.ExoticTrack")((lM=wl((aM=class{constructor(t,e){Tl(this,"times",lM,this),Tl(this,"values",cM,this),this.times=t,this.values=e}toHashString(){const{times:t,values:e}=this;return`times: ${vM(t)}; values: ${e.toHashString()}`}}).prototype,"times",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),cM=wl(aM.prototype,"values",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),oM=aM))||oM;class CM{constructor(t,e){this._nodeEvaluations=void 0,this._nodeEvaluations=t.map((t=>t.createEvaluator(e)))}evaluate(t){this._nodeEvaluations.forEach((e=>{e.evaluate(t)}))}}class TM{constructor(t,e,i,n,s){this._position=null,this._rotation=null,this._scale=null,e&&(this._position=MM(e.times,e.values,Ni,t,"position",s)),i&&(this._rotation=MM(i.times,i.values,ki,t,"rotation",s)),n&&(this._scale=MM(n.times,n.values,Ni,t,"scale",s))}evaluate(t){if(this._position){const e=this._position.evaluator.evaluate(t);this._position.runtimeBinding.setValue(e)}if(this._rotation){const e=this._rotation.evaluator.evaluate(t);this._rotation.runtimeBinding.setValue(e)}if(this._scale){const e=this._scale.evaluator.evaluate(t);this._scale.runtimeBinding.setValue(e)}}}class wM{constructor(t,e,i){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=t,this._values=e,this._prevValue=new i,this._nextValue=new i,this._resultValue=new i}evaluate(t){const{_times:e,_values:i,_resultValue:n}=this;if(0===e.length)return n;const s=function(t,e,i){const n=t.length,s=t[0],r=t[n-1];if(e<s)i.just=!0,i.index=0;else if(e>r)i.just=!0,i.index=n-1;else{const n=Il(t,e);if(n>=0)i.just=!0,i.index=n;else{const s=~n,r=s-1,o=t[r],a=t[s],l=(e-t[r])/(a-o);i.just=!1,i.index=r,i.nextIndex=s,i.ratio=l}}return i}(e,t,this._inputSampleResultCache);return s.just?i.get(s.index,n):i.lerp(s.index,s.nextIndex,s.ratio,this._prevValue,this._nextValue,n),n}}const EM={uint8:Uint8Array,uint16:Uint16Array};var PM;function DM(t){switch(t.BYTES_PER_ELEMENT){default:case 4:return PM.FLOAT_32;case 8:return PM.FLOAT_64}}!function(t){t[t.FLOAT_32=0]="FLOAT_32",t[t.FLOAT_64=1]="FLOAT_64"}(PM||(PM={}));let IM=Vl("cc.animation.QuantizedFloatArray")((uM=wl((_M=class{get quantizationType(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}constructor(t,e,i,n=0){Tl(this,"originalPrecision",uM,this),Tl(this,"min",mM,this),Tl(this,"extent",pM,this),Tl(this,"values",dM,this),this.originalPrecision=t,this.values=e,this.extent=i,this.min=n}toHashString(){const{originalPrecision:t,min:e,extent:i,values:n}=this;return`${t} ${yM(e)} ${yM(i)} ${n.join(" ")}`}}).prototype,"originalPrecision",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),mM=wl(_M.prototype,"min",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pM=wl(_M.prototype,"extent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),dM=wl(_M.prototype,"values",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),hM=_M))||hM;function RM(t,e){return t.values[e]/(1<<t.values.BYTES_PER_ELEMENT)*t.extent+t.min}function MM(t,e,i,n,s,r){const o=new HI;o.path=(new kI).toHierarchy(n).toProperty(s);const a=r(o);return a?{runtimeBinding:a,evaluator:new wM(t,e,i)}:null}function OM(t,e,i){Ni.set(i,RM(t,3*e+0),RM(t,3*e+1),RM(t,3*e+2))}function BM(t,e,i){ki.set(i,RM(t,4*e+0),RM(t,4*e+1),RM(t,4*e+2),RM(t,4*e+3))}var NM,LM,FM,zM,VM,UM,GM,kM,HM,jM,WM,qM,XM;const YM=Symbol("SearchForRootBonePath"),KM=Symbol("ExoticAnimation");let $M=t("AnimationClip",Vl("cc.AnimationClip")((XM=qM=class t extends _h{constructor(...t){super(...t),Tl(this,"sample",FM,this),Tl(this,"speed",zM,this),Tl(this,"wrapMode",VM,this),Tl(this,"enableTrsBlending",UM,this),Tl(this,"_duration",GM,this),Tl(this,"_hash",kM,this),this.frameRate=0,Tl(this,"_tracks",HM,this),Tl(this,"_exoticAnimation",jM,this),this._legacyData=void 0,this._legacyDataDirty=!1,Tl(this,"_events",WM,this),this._runtimeEvents={ratios:[],eventGroups:[]}}static createWithSpriteFrames(e,i){const n=new t;n.sample=i||n.sample,n.duration=e.length/n.sample;const s=1/n.sample,r=new SR;return r.path=(new kI).toComponent("cc.Sprite").toProperty("spriteFrame"),r.channels()[0].curve.assignSorted(e.map(((t,e)=>[s*e,t]))),n}get duration(){return this._duration}set duration(t){this._duration=t}get tracksCount(){return this._tracks.length}get tracks(){return this._tracks}get hash(){var t,e;if(this._hash)return this._hash;const i=`Exotic:${null!==(t=null===(e=this._exoticAnimation)||void 0===e?void 0:e.toHashString())&&void 0!==t?t:""}`;return this._hash=Uo(i,666)}get events(){return this._events}set events(t){this._events=t;const e=[],i=[],n=this.events.sort(((t,e)=>t.frame-e.frame)),s=n.length;for(let t=0;t<s;++t){const s=n[t],r=s.frame/this._duration;let o=e.findIndex((t=>t===r));o<0&&(o=e.length,e.push(r),i.push({events:[]})),i[o].events.push({functionName:s.func,parameters:s.params})}this._runtimeEvents={ratios:e,eventGroups:i}}get[KM](){return this._exoticAnimation}set[KM](t){this._exoticAnimation=t}onLoaded(){this.frameRate=this.sample,this.events=this._events}range(){const t={min:1/0,max:-1/0},{_tracks:e}=this,i=e.length;for(let n=0;n<i;++n){const i=e[n].range();t.min=Math.min(t.min,i.min),t.max=Math.max(t.max,i.max)}return t}getTrack(t){return this._tracks[t]}addTrack(t){const e=this._tracks.length;return this._tracks.push(t),e}removeTrack(t){this._tracks.splice(t,1)}clearTracks(){this._tracks.length=0}createEventEvaluator(t){return new sO(t,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)}createEvaluator(t){const{target:e}=t;return this._createEvalWithBinder(e,(i=>{const n=i.createRuntimeBinding(e,this.enableTrsBlending?t.pose:void 0,!1);return null!=n?n:void 0}),t.rootMotion)}destroy(){var t;return(null===(t=n.director.root)||void 0===t?void 0:t.dataPoolManager)&&n.director.root.dataPoolManager.releaseAnimationClip(this),CR.destroy(this),super.destroy()}[AR](t,e,i){const n=1/e,s=this._collectAnimatedJoints(),r=s.length,o={};for(let t=0;t<r;++t)o[s[t]]={transforms:Array.from({length:i},(()=>new $i))};const a=s.reduce(((t,e)=>(t[e]=new QM,t)),{});for(const t in a){const e=a[t],i=t.lastIndexOf("/");if(i>=0){const n=t.substring(0,i),s=a[n];s&&(e.parent=s)}}const l=this._createEvalWithBinder(void 0,(t=>{const e=t.parseTrsPath();if(!e)return;const i=a[e.node];return i?nO(i,e.property):void 0}),void 0);for(let e=0;e<i;++e){const i=t+n*e;l.evaluate(i);for(let t=0;t<r;++t){const i=s[t];$i.copy(o[i].transforms[e],a[i].globalTransform)}for(let t=0;t<r;++t){const e=s[t];a[e].invalidate()}}return{samples:e,frames:i,joints:o}}upgradeUntypedTracks(t){const e=[],i=[],{_tracks:n}=this,s=n.length;for(let r=0;r<s;++r){const s=n[r];if(!(s instanceof zR))continue;const o=s.upgrade(t);o&&(e.push(o),i.push(s))}const r=i.length;for(let t=0;t<r;++t)Mt.remove(n,i[t]);n.push(...e)}[YM](){return this._searchForRootBonePath()}get keys(){return this._getLegacyData().keys}set keys(t){this._legacyDataDirty=!0,this._getLegacyData().keys=t}get curves(){return this._legacyDataDirty=!0,this._getLegacyData().curves}set curves(t){this._getLegacyData().curves=t}get commonTargets(){return this._getLegacyData().commonTargets}set commonTargets(t){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=t}get data(){return this._getLegacyData().data}getPropertyCurves(){return this._getLegacyData().getPropertyCurves()}get eventGroups(){return this._runtimeEvents.eventGroups}updateEventDatas(){}hasEvents(){return 0!==this.events.length}syncLegacyData(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)}_createEvalWithBinder(t,e,i){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());const n=[];let s;i&&(s=this._createRootMotionEvaluation(t,i,n));const r=[];let o;const{_tracks:a}=this,l=a.length;for(let t=0;t<l;++t){const i=a[t];if(n.includes(i))continue;const s=e(i[GI]);if(!s)continue;const o=i[SI](s);r.push({binding:s,trackEval:o})}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(e)),new JM(r,o,s)}_createRootMotionEvaluation(t,e,i){if(!(t instanceof Yv))return void T(3920);const n=this._searchForRootBonePath();if(!n)return void A(3923);const s=t.getChildByPath(n);if(!s)return void A(3924);const r=new ZM,o=[],{_tracks:a}=this,l=a.length;for(let t=0;t<l;++t){const e=a[t],{[GI]:s}=e,l=s.parseTrsPath();if(!l)continue;if(l.node!==n)continue;i.push(e);const c=nO(r,l.property);if(!c)continue;const h=e[SI](c);o.push({binding:c,trackEval:h})}return new eO(s,this._duration,r,o)}_searchForRootBonePath(){const t=this._tracks.map((t=>{const e=t[GI].parseTrsPath();if(e){const t=e.node;return{path:t,rank:t.split("/").length}}return{path:"",rank:0}}));t.sort(((t,e)=>t.rank-e.rank));const e=t.findIndex((t=>0!==t.rank));if(e<0)return"";const i=t.length,n=t[e];let s=!0;for(let r=e+1;r<i;++r){const e=t[r];if(e.rank!==n.rank)break;if(e.path!==n.path){s=!1;break}}return s?n.path:""}_getLegacyData(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData}_toLegacy(){const t=new VR(this._duration);return t.keys=[],t.curves=[],t.commonTargets=[],t}_fromLegacy(t){const e=t.toTracks(),i=e.length;for(let t=0;t<i;++t)this.addTrack(e[t])}_collectAnimatedJoints(){const t=new Set,{_tracks:e}=this,i=e.length;for(let n=0;n<i;++n){const i=e[n][GI].parseTrsPath();i&&t.add(i.node)}if(this._exoticAnimation){const e=this._exoticAnimation.collectAnimatedJoints(),i=e.length;for(let n=0;n<i;++n)t.add(e[n])}return Array.from(t)}},qM.WrapMode=Pl,FM=wl((LM=XM).prototype,"sample",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),zM=wl(LM.prototype,"speed",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),VM=wl(LM.prototype,"wrapMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pl.Normal}}),UM=wl(LM.prototype,"enableTrsBlending",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),GM=wl(LM.prototype,"_duration",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kM=wl(LM.prototype,"_hash",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HM=wl(LM.prototype,"_tracks",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jM=wl(LM.prototype,"_exoticAnimation",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),WM=wl(LM.prototype,"_events",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NM=LM))||NM);n.AnimationClip=$M;class JM{constructor(t,e,i){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=t,this._exoticAnimationEvaluator=e,this._rootMotionEvaluation=i}evaluate(t){const{_trackEvalStatues:e,_exoticAnimationEvaluator:i}=this,n=e.length;for(let i=0;i<n;++i){const{trackEval:n,binding:s}=e[i],r=n.evaluate(t,s);s.setValue(r)}i&&i.evaluate(t)}evaluateRootMotion(t,e){const{_rootMotionEvaluation:i}=this;i&&i.evaluate(t,e)}}class ZM{constructor(){this.position=new Ni,this.scale=new Ni(1,1,1),this.rotation=new ki,this.eulerAngles=new Ni}getTransform(t){$i.fromRTS(t,this.rotation,this.position,this.scale)}}class QM extends ZM{constructor(...t){super(...t),this.parent=null,this._dirty=!0,this._transform=new $i}get globalTransform(){const t=this._transform;return this._dirty&&(this._dirty=!1,$i.fromRTS(t,this.rotation,this.position,this.scale),this.parent&&$i.multiply(t,this.parent.globalTransform,t)),this._transform}invalidate(){this._dirty=!0}}const tO=new $i;class eO{constructor(t,e,i,n){this._initialTransformCache=new $i,this._clipEndTransformCache=new $i,this._startTransformCache=new $i,this._endTransformCache=new $i,this._motionTransformCache=new $i,this._translationMotionCache=new Ni,this._rotationMotionCache=new ki,this._scaleMotionCache=new Ni,this._rootBone=t,this._duration=e,this._boneTransform=i,this._trackEvalStatuses=n}evaluate(t,e){const i=this._calcMotionTransform(t,e,this._motionTransformCache),{_translationMotionCache:n,_rotationMotionCache:s,_scaleMotionCache:r,_rootBone:o}=this;$i.toRTS(i,s,n,r),Ni.add(n,n,o.position),o.setPosition(n),ki.multiply(s,s,o.rotation),o.setRotation(s),Ni.multiply(r,r,o.scale),o.setScale(r)}_calcMotionTransform(t,e,i){const{_duration:n}=this,s=n-t,r=this._evaluateAt(t,this._startTransformCache);if(e<s){const n=this._evaluateAt(t+e,this._endTransformCache);iO(i,r,n)}else{$i.identity(i);const t=(t,e)=>{iO(tO,t,e),$i.multiply(i,i,tO)},o=e-s,a=Math.floor(o/n),l=o-a*n,c=this._evaluateAt(0,this._initialTransformCache),h=this._evaluateAt(n,this._clipEndTransformCache),_=this._evaluateAt(l,this._endTransformCache);t(r,h),iO(tO,c,h);for(let t=0;t<a;++t)$i.multiply(i,i,tO);t(c,_)}return i}_evaluateAt(t,e){const{_trackEvalStatuses:i}=this,n=i.length;for(let e=0;e<n;++e){const{trackEval:n,binding:s}=i[e],r=n.evaluate(t,s);s.setValue(r)}return this._boneTransform.getTransform(e),e}}function iO(t,e,i){$i.invert(t,e),$i.multiply(t,i,t)}function nO(t,e){switch(e){default:return;case"position":return{setValue(e){Ni.copy(t.position,e)}};case"rotation":return{setValue(e){ki.copy(t.rotation,e)}};case"scale":return{setValue(e){Ni.copy(t.scale,e)}};case"eulerAngles":return{setValue(e){Ni.copy(t.eulerAngles,e)}}}}class sO{constructor(t,e,i,n){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=t,this._ratios=e,this._eventGroups=i,this._wrapMode=n}setWrapMode(t){this._wrapMode=t}ignore(t,e){this._ignoreIndex=-1,this._sampled=!1;let i=oO(t,this._ratios);i<0&&(i=~i-1,e<0&&(i+=1),this._ignoreIndex=i)}sample(t,e,i){const n=this._eventGroups.length;let s=oO(t,this._ratios);if(s<0&&(s=~s-1,e<0&&(s+=1)),this._ignoreIndex!==s&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(s,!1),this._lastFrameIndex=s,this._lastIterations=i,void(this._lastDirection=e);const r=this._wrapMode,o=rO(i);let a=rO(this._lastIterations),l=this._lastFrameIndex;const c=this._lastDirection,h=-1!==a&&o!==a;if(l===s&&h&&1===n)this._doFire(0,!1);else if(l!==s||h){e=c;do{if(l!==s){if(-1===e&&0===l&&s>0?((r&El.PingPong)===El.PingPong?e*=-1:l=n,a++):1===e&&l===n-1&&s<n-1&&((r&El.PingPong)===El.PingPong?e*=-1:l=-1,a++),l===s)break;if(a>o)break}l+=e,this._doFire(l,!0)}while(l!==s&&l>-1&&l<n)}this._lastFrameIndex=s,this._lastIterations=i,this._lastDirection=e}_doFire(t,e){e?n.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[t]):this._checkAndFire(t)}_checkAndFire(t){if(!this._targetNode||!this._targetNode.isValid)return;const{_eventGroups:e}=this;if(t<0||t>=e.length||this._ignoreIndex===t)return;const i=e[t],n=this._targetNode.components,s=i.events.length;for(let t=0;t<s;++t){const e=i.events[t],{functionName:s}=e,r=n.length;for(let t=0;t<r;++t){const i=n[t],r=i[s];"function"==typeof r&&r.apply(i,e.parameters)}}}}function rO(t){return t-(0|t)==0&&(t-=1),0|t}function oO(t,e){return Il(e,t)}class aO{constructor(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}get isPlaying(){return this._isPlaying}get isPaused(){return this._isPaused}get isMotionless(){return!this.isPlaying||this.isPaused}play(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(D(3912)):(this._isPlaying=!0,this.onPlay())}stop(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)}pause(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())}resume(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())}step(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()}update(t){}onPlay(){}onPause(){}onResume(){}onStop(){}onError(t){}}class lO{constructor(t){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=t}destroy(){for(let t=0;t<this._blendStateWriters.length;++t)this._pose.destroyWriter(this._blendStateWriters[t]);this._blendStateWriters.length=0}createPoseWriter(t,e,i){const n=this._pose.createWriter(t,e,this,i);return this._blendStateWriters.push(n),n}}let cO;!function(t){t.PLAY="play",t.STOP="stop",t.PAUSE="pause",t.RESUME="resume",t.LASTFRAME="lastframe",t.FINISHED="finished"}(cO||(cO={})),zt(cO);class hO extends aO{get clip(){return this._clip}get name(){return this._name}get length(){return this.duration}get wrapMode(){return this._wrapMode}set wrapMode(t){var e;this._wrapMode=t,this.time=0,t&El.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(e=this._clipEventEval)||void 0===e||e.setWrapMode(t)}get repeatCount(){return this._repeatCount}set repeatCount(t){this._repeatCount=t;const e=this._wrapMode&El.ShouldWrap,i=(this.wrapMode&El.Reverse)===El.Reverse;this._useSimpleProcess=t===1/0&&!e&&!i}get delay(){return this._delay}set delay(t){this._delayTime=this._delay=t}get playbackRange(){return this._playbackRange}set playbackRange(t){t.max,t.min,this._playbackRange.min=Math.max(t.min,0),this._playbackRange.max=Math.min(t.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}get current(){return this.getWrappedInfo(this.time).time}get ratio(){return this.current/this.duration}get weight(){return this._weight}set weight(t){this._weight=t,this._poseOutput&&(this._poseOutput.weight=t)}constructor(t,e=""){super(),this.duration=1,this.speed=1,this.time=0,this.frameRate=0,this._targetNode=null,this._curveLoaded=!1,this._clip=void 0,this._useSimpleProcess=!1,this._target=null,this._wrapMode=Pl.Normal,this._repeatCount=1,this._delay=0,this._delayTime=0,this._currentFramePlayed=!1,this._name=void 0,this._lastIterations=NaN,this._lastWrapInfo=null,this._wrappedInfo=new Dl,this._allowLastFrame=!1,this._blendStateWriterHost={weight:0},this._playbackDuration=0,this._invDuration=1,this._poseOutput=null,this._weight=0,this._clipEval=void 0,this._clipEventEval=void 0,this._doNotCreateEval=!1,this._clip=t,this._name=e||t&&t.name,this._playbackRange={min:0,max:t.duration},this._playbackDuration=t.duration,t.duration||f(`Clip ${t.name} has zero duration.`)}get curveLoaded(){return this._curveLoaded}initialize(t){if(this._curveLoaded)return;this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=t;const e=this._clip;if(this.duration=e.duration,this._invDuration=1/this.duration,this.speed=e.speed,this.wrapMode=e.wrapMode,this.frameRate=e.sample,this._playbackRange.min=0,this._playbackRange.max=e.duration,this._playbackDuration=e.duration,(this.wrapMode&El.Loop)===El.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,s,r;const o=null!==(i=null===(s=n.director.getAnimationManager())||void 0===s?void 0:s.blendState)&&void 0!==i?i:null;o&&(this._poseOutput=new lO(o)),this._clipEval=e.createEvaluator({target:t,pose:null!==(r=this._poseOutput)&&void 0!==r?r:void 0})}this._clipEventEval=e.createEventEvaluator(this._targetNode)}destroy(){this.isMotionless||n.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0}emit(...t){n.director.getAnimationManager().pushDelayEvent(this._emit,this,t)}on(t,e,i){return this._target&&this._target.isValid?this._target.on(t,e,i):null}once(t,e,i){return this._target&&this._target.isValid?this._target.once(t,e,i):null}off(t,e,i){this._target&&this._target.isValid&&this._target.off(t,e,i)}allowLastFrameEvent(t){this._allowLastFrame=t}_setEventTarget(t){this._target=t}setTime(t){this._currentFramePlayed=!1,this.time=t||0;{var e;const i=this.getWrappedInfo(t,this._wrappedInfo);null===(e=this._clipEventEval)||void 0===e||e.ignore(i.ratio,i.direction)}}update(t){this._delayTime>0&&(this._delayTime-=t,this._delayTime>0)||(this._currentFramePlayed?this.time+=t*this.speed:this._currentFramePlayed=!0,this._process())}sample(){const t=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(t.time),this._sampleEvents(t),t}onPlay(){this.setTime(0),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(cO.PLAY,this)}onStop(){this.isPaused||this._onPauseOrStop(),this.emit(cO.STOP,this)}onResume(){this._onReplayOrResume(),this.emit(cO.RESUME,this)}onPause(){this._onPauseOrStop(),this.emit(cO.PAUSE,this)}_sampleCurves(t){const{_poseOutput:e,_clipEval:i}=this;e&&(e.weight=this.weight),i&&i.evaluate(t)}_process(){this._useSimpleProcess?this.simpleProcess():this.process()}process(){const t=this.sample();if(this._allowLastFrame){let e;e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new Dl(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(cO.LASTFRAME,this),e.set(t)}t.stopped&&(this.stop(),this.emit(cO.FINISHED,this))}simpleProcess(){const t=this._playbackRange.min,e=this._playbackDuration;let i=this.time%e;i<0&&(i+=e);const n=(t+i)*this._invDuration;this._sampleCurves(t+i),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=n),(this.time>0&&this._lastIterations>n||this.time<0&&this._lastIterations<n)&&this.emit(cO.LASTFRAME,this),this._lastIterations=n)}_needReverse(t){const e=this.wrapMode;let i=!1;return(e&El.PingPong)===El.PingPong&&(t-(0|t)==0&&t>0&&(t-=1),1&t&&(i=!i)),(e&El.Reverse)===El.Reverse&&(i=!i),i}getWrappedInfo(t,e){e=e||new Dl;const i=this._getPlaybackStart(),n=this._getPlaybackEnd()-i;let s=!1;const r=this.repeatCount;let o=t>0?t/n:-t/n;if(o>=r){o=r,s=!0;let e=r-(0|r);0===e&&(e=1),t=e*n*(t>0?1:-1)}if(t>n){const e=t%n;t=0===e?n:e}else t<0&&0!=(t%=n)&&(t+=n);let a=!1;const l=this._wrapMode&El.ShouldWrap;l&&(a=this._needReverse(o));let c=a?-1:1;return this.speed<0&&(c*=-1),l&&a&&(t=n-t),e.time=i+t,e.ratio=e.time/this.duration,e.direction=c,e.stopped=s,e.iterations=o,e}_getPlaybackStart(){return this._playbackRange.min}_getPlaybackEnd(){return this._playbackRange.max}_sampleEvents(t){var e;null===(e=this._clipEventEval)||void 0===e||e.sample(t.ratio,t.direction,t.iterations)}_emit(t,e){this._target&&this._target.isValid&&this._target.emit(t,t,e)}_onReplayOrResume(){n.director.getAnimationManager().addAnimation(this)}_onPauseOrStop(){n.director.getAnimationManager().removeAnimation(this)}}t("AnimationState",hO),n.AnimationState=hO;class _O extends aO{constructor(t){super(),this._managedStates=[],this._fadings=[],this._scheduled=!1,this._scheduler=null!=t?t:n.director.getAnimationManager()}update(t){if(this.isMotionless)return;const e=this._managedStates,i=this._fadings;if(1===e.length&&1===i.length){const t=e[0].state;t&&(t.weight=1)}else this._calculateWeights(t);1===e.length&&1===i.length&&this._unscheduleThis()}crossFade(t,e){var i;0===this._managedStates.length&&(e=0),0===e&&this.clear();let n=this._managedStates.find((e=>e.state===t));n?(null===(i=n.state)||void 0===i?void 0:i.isMotionless)&&n.state.play():(n={state:t,reference:0},t&&t.play(),this._managedStates.push(n)),++n.reference,this._fadings.unshift({easeDuration:e,easeTime:0,target:n}),this.isMotionless||this._scheduleThis()}clear(){for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.stop()}this._managedStates.length=0,this._fadings.length=0}onPlay(){super.onPlay(),this._scheduleThis()}onPause(){super.onPause();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.pause()}this._unscheduleThis()}onResume(){super.onResume();for(let t=0;t<this._managedStates.length;++t){const e=this._managedStates[t].state;e&&e.resume()}this._scheduleThis()}onStop(){super.onStop(),this.clear()}_calculateWeights(t){const e=this._managedStates,i=this._fadings;for(let t=0;t<e.length;++t){const i=e[t].state;i&&(i.weight=0)}let n=1,s=i.length;for(let e=0;e<i.length;++e){const r=i[e];r.easeTime+=t;const o=0===r.easeDuration?1:mi(r.easeTime/r.easeDuration),a=o*n;if(n*=1-o,r.target.state&&(r.target.state.weight+=a),r.easeTime>=r.easeDuration){s=e+1,r.easeTime=r.easeDuration;break}}if(s!==i.length){for(let t=s;t<i.length;++t){const e=i[t];--e.target.reference,e.target.reference<=0&&(e.target.state&&e.target.state.stop(),j(this._managedStates,e.target))}i.splice(s)}}_scheduleThis(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)}_unscheduleThis(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)}}var uO,mO,pO,dO,fO,gO,yO,vO,xO,bO,SO,AO,CO,TO,wO,EO,PO;let DO=function(e){return t({AnimationComponent:e,Animation:e}),e}((uO=Vl("cc.Animation"),mO=ec(),pO=Gl(99),dO=Jl(),fO=yc([$M]),gO=rc(),yO=yc($M),vO=rc(),xO=rc(),bO=yc([$M]),uO(SO=mO(SO=pO(SO=$l(SO=dO((PO=EO=class extends(ke(Rh)){constructor(...t){super(...t),Tl(this,"playOnLoad",CO,this),this._crossFade=new _O,this._nameToState=st(!0),Tl(this,"_clips",TO,this),Tl(this,"_defaultClip",wO,this),this._hasBeenPlayed=!1}get clips(){return this._clips}set clips(t){this._crossFade&&this._crossFade.clear();for(const t of this._clips)t&&this._removeStateOfAutomaticClip(t);for(const e of t)e&&this.createState(e);const e=t.find((t=>IO(t,this._defaultClip)));this._defaultClip=e||null,this._clips=t}get defaultClip(){return this._defaultClip}set defaultClip(t){this._defaultClip=t,t&&(this._clips.findIndex((e=>IO(e,t)))>=0||(this._clips.push(t),this.createState(t)))}onLoad(){this.clips=this._clips;for(const t in this._nameToState)this._nameToState[t].initialize(this.node)}start(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)}onEnable(){this._crossFade.resume()}onDisable(){this._crossFade.pause()}onDestroy(){this._crossFade.stop();for(const t in this._nameToState)this._nameToState[t].destroy();this._nameToState=st(!0)}play(t){if(this._hasBeenPlayed=!0,!t){if(!this._defaultClip)return;t=this._defaultClip.name}this.crossFade(t,0)}crossFade(t,e=.3){this._hasBeenPlayed=!0;const i=this._nameToState[t];i&&(this._crossFade.play(),this._crossFade.crossFade(i,e))}pause(){this._crossFade.pause()}resume(){this._crossFade.resume()}stop(){this._crossFade.stop()}getAnimationState(t){return this.getState(t)}getState(t){const e=this._nameToState[t];return e&&!e.curveLoaded&&e.initialize(this.node),e||null}createState(t,e){return e=e||t.name,this.removeState(e),this._doCreateState(t,e)}removeState(t){const e=this._nameToState[t];e&&(e.allowLastFrameEvent(!1),e.stop(),delete this._nameToState[t])}addClip(t,e){return W(this._clips,t)||this._clips.push(t),this.createState(t,e)}removeClip(t,e){let i;for(const e in this._nameToState){const n=this._nameToState[e];if(n.clip===t){i=n;break}}if(t===this._defaultClip){if(!e)return void A(3902);this._defaultClip=null}if(i&&i.isPlaying){if(!e)return void A(3903);i.stop()}this._clips=this._clips.filter((e=>e!==t)),i&&delete this._nameToState[i.name]}on(t,e,i,n){const s=super.on(t,e,i,n);return t===cO.LASTFRAME&&this._syncAllowLastFrameEvent(),s}once(t,e,i){const n=super.once(t,e,i);return t===cO.LASTFRAME&&this._syncAllowLastFrameEvent(),n}off(t,e,i){super.off(t,e,i),t===cO.LASTFRAME&&this._syncDisallowLastFrameEvent()}_createState(t,e){return new hO(t,e)}_doCreateState(t,e){const i=this._createState(t,e);return i._setEventTarget(this),i.allowLastFrameEvent(this.hasEventListener(cO.LASTFRAME)),this.node&&i.initialize(this.node),this._nameToState[i.name]=i,i}_getStateByNameOrDefaultClip(t){if(!t){if(!this._defaultClip)return null;t=this._defaultClip.name}return this._nameToState[t]||null}_removeStateOfAutomaticClip(t){for(const e in this._nameToState){const i=this._nameToState[e];IO(t,i.clip)&&(i.stop(),delete this._nameToState[e])}}_syncAllowLastFrameEvent(){if(this.hasEventListener(cO.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!0)}_syncDisallowLastFrameEvent(){if(!this.hasEventListener(cO.LASTFRAME))for(const t in this._nameToState)this._nameToState[t].allowLastFrameEvent(!1)}},EO.EventType=cO,wl((AO=PO).prototype,"clips",[fO,gO],Object.getOwnPropertyDescriptor(AO.prototype,"clips"),AO.prototype),wl(AO.prototype,"defaultClip",[yO,vO],Object.getOwnPropertyDescriptor(AO.prototype,"defaultClip"),AO.prototype),CO=wl(AO.prototype,"playOnLoad",[Wl,xO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),TO=wl(AO.prototype,"_clips",[bO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wO=wl(AO.prototype,"_defaultClip",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SO=AO))||SO)||SO)||SO)||SO)||SO));function IO(t,e){return t===e||!!t&&!!e&&t._uuid===e._uuid&&t._uuid}Ze(DO.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction(...t){const e=t[0];return DO.prototype.removeState.call(this,e.name)}}]),n.AnimationComponent=DO,Ot.setClassAlias(DO,"cc.AnimationComponent");class RO{constructor(){this._nodeBlendStates=new Map}createWriter(t,e,i,n){const s=this.ref(t,e);return new MO(t,e,s,i,n)}destroyWriter(t){const e=t;this.deRef(e.node,e.property)}ref(t,e){let i=this._nodeBlendStates.get(t);return i||(i=new LO,this._nodeBlendStates.set(t,i)),i.refProperty(e)}deRef(t,e){const i=this._nodeBlendStates.get(t);i&&(i.deRefProperty(e),i.empty&&this._nodeBlendStates.delete(t))}apply(){this._nodeBlendStates.forEach(((t,e)=>{t.apply(e)}))}}class MO{constructor(t,e,i,n,s){this._node=t,this._property=e,this._propertyBlendState=i,this._host=n,this._constants=s}get node(){return this._node}get property(){return this._property}getValue(){return this._node[this._property]}setValue(t){const{_propertyBlendState:e,_host:i}=this,n=i.weight;e.blend(t,n)}}class OO{constructor(t){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=t}}class BO extends OO{constructor(){super(new Ni)}blend(t,e){const{blendedValue:i}=this;1===e?Ni.copy(i,t):Ni.scaleAndAdd(i,i,t,e),this.blendedWeight+=e}reset(){this.blendedWeight=0,Ni.zero(this.blendedValue)}}class NO extends OO{constructor(){super(new ki)}blend(t,e){if(0===e)return;const{blendedValue:i,blendedWeight:n}=this;if(1===e)ki.copy(i,t);else{const s=e/(n+e);ki.slerp(i,i,t,s)}this.blendedWeight+=e}reset(){this.blendedWeight=0,ki.identity(this.blendedValue)}}class LO{constructor(){this._properties={}}get empty(){const{_properties:t}=this;return!(t.position||t.rotation||t.eulerAngles||t.scale)}refProperty(t){var e,i;const{_properties:n}=this;let s;switch(t){default:case"position":case"scale":case"eulerAngles":s=null!==(e=n[t])&&void 0!==e?e:n[t]=new BO;break;case"rotation":s=null!==(i=n[t])&&void 0!==i?i:n[t]=new NO}return++s.refCount,s}deRefProperty(t){const{_properties:e}=this,i=e[t];i&&(--i.refCount,i.refCount>0||delete e[t])}apply(t){const{_properties:{position:e,scale:i,rotation:n,eulerAngles:s}}=this;let r,o,a,l=!1,c=!1,h=!1,_=!1;e&&e.blendedWeight&&(l=!0,e.blendedWeight<1&&e.blend(t.position,1-e.blendedWeight),r=e.blendedValue),i&&i.blendedWeight&&(c=!0,i.blendedWeight<1&&i.blend(t.scale,1-i.blendedWeight),o=i.blendedValue),s&&s.blendedWeight&&(_=!0,s.blendedWeight<1&&s.blend(t.eulerAngles,1-s.blendedWeight),a=s.blendedValue),n&&n.blendedWeight&&(h=!0,n.blendedWeight<1&&n.blend(t.rotation,1-n.blendedWeight),a=n.blendedValue),(a||r||o)&&t.setRTS(a,r,o),l&&e.reset(),c&&i.reset(),h&&n.reset(),_&&s.reset()}}const FO=[],zO=new Map;function VO(t,e){let i=0,n=$i.IDENTITY;for(;t;){if(t.stamp===e||t.stamp+1===e&&!t.node.hasChangedFlags){n=t.world,t.stamp=e;break}t.stamp=e,FO[i++]=t,t=t.parent}for(;i>0;){t=FO[--i],FO[i]=null;const e=t.node;$i.fromRTS(t.local,e.rotation,e.position,e.scale),n=$i.multiply(t.world,n,t.local)}return n}function UO(t,e){let i,n=null,s=0;for(;t!==e;){const e=t.uuid;if(zO.has(e)){n=zO.get(e);break}n={node:t,local:new $i,world:new $i,stamp:-1,parent:null},zO.set(e,n),FO[s++]=n,t=t.parent,n=null}for(;s>0;)i=FO[--s],FO[s]=null,i.parent=n,n=i;return n}function GO(t){let e=zO.get(t.uuid)||null;for(;e;)zO.delete(e.node.uuid),e=e.parent}var kO,HO,jO;let WO=t("AnimationManager",Vl((jO=HO=class extends Sw{constructor(...t){super(...t),this._anims=new G([]),this._crossFades=new G([]),this._delayEvents=[],this._blendStateBuffer=new RO,this._sockets=[]}get blendState(){return this._blendStateBuffer}addCrossFade(t){-1===this._crossFades.array.indexOf(t)&&this._crossFades.push(t)}removeCrossFade(t){const e=this._crossFades.array.indexOf(t);e>=0?this._crossFades.fastRemoveAt(e):T(3907)}update(t){const{_delayEvents:e,_crossFades:i,_sockets:s}=this;{const e=i.array;for(i.i=0;i.i<e.length;++i.i)e[i.i].update(t)}const r=this._anims,o=r.array;for(r.i=0;r.i<o.length;++r.i){const e=o[r.i];e.isMotionless||e.update(t)}this._blendStateBuffer.apply();const a=n.director.getTotalFrames();for(let t=0,e=s.length;t<e;t++){const{target:e,transform:i}=s[t];e.matrix=VO(i,a)}for(let t=0,i=e.length;t<i;t++){const i=e[t];i.fn.apply(i.thisArg,i.args)}e.length=0}destruct(){}addAnimation(t){-1===this._anims.array.indexOf(t)&&this._anims.push(t)}removeAnimation(t){const e=this._anims.array.indexOf(t);e>=0?this._anims.fastRemoveAt(e):T(3907)}pushDelayEvent(t,e,i){this._delayEvents.push({fn:t,thisArg:e,args:i})}addSockets(t,e){for(let i=0;i<e.length;++i){const n=e[i];if(this._sockets.find((t=>t.target===n.target)))continue;const s=t.getChildByPath(n.path),r=n.target&&s&&UO(s,t);r&&this._sockets.push({target:n.target,transform:r})}}removeSockets(t,e){for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<this._sockets.length;++t){const e=this._sockets[t];if(e.target===i.target){GO(e.transform.node),this._sockets[t]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}}}},HO.ID="animation",kO=jO))||kO);Mw.on(Rw.EVENT_INIT,(()=>{const t=new WO;Mw.registerSystem(WO.ID,t,Sw.Priority.HIGH)})),n.AnimationManager=WO;const qO=new $i;var XO,YO,KO,$O;n.easing=Cu;let JO=t("HierachyModifier",Vl("cc.HierachyModifier")(XO=class extends qD{})||XO);n.HierachyModifier=JO;let ZO=t("ComponentModifier",Vl("cc.ComponentModifier")(YO=class extends XD{})||YO);n.ComponentModifier=ZO;let QO=t("CurveValueAdapter",Vl("cc.CurveValueAdapter")(KO=class{forTarget(t){return{set:()=>{}}}})||KO);n.CurveValueAdapter=QO;let tB,eB=t("UniformCurveValueAdapter",Vl("cc.UniformCurveValueAdapter")($O=class extends QD{})||$O);function iB(t){return"string"==typeof t}function nB(t){return"number"==typeof t}function sB(t,e){return t instanceof e}n.UniformCurveValueAdapter=eB,n.isPropertyModifier=iB,n.isElementModifier=nB,n.isCustomTargetModifier=sB,n.math=un,n.geometry=Jm;class rB{constructor(t){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=t,this._pool=[]}size(){return this._pool.length}clear(){const t=this._pool.length;for(let e=0;e<t;++e)this._pool[e].destroy();this._pool.length=0}put(t){if(t&&-1===this._pool.indexOf(t)){t.removeFromParent();const e=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;e&&e.unuse&&e.unuse(),this._pool.push(t)}}get(...t){const e=this._pool.length-1;if(e<0)return null;{const t=this._pool[e];this._pool.length=e;const i=this.poolHandlerComp?t.getComponent(this.poolHandlerComp):null;return i&&i.reuse&&i.reuse(arguments),t}}}t("NodePool",rB),n.NodePool=rB,n.renderer=vy;class oB extends Oo{constructor(...t){super(...t),this._gpuDescriptorSet=null}get gpuDescriptorSet(){return this._gpuDescriptorSet}initialize(t){this._layout=t.layout;const{bindings:e,descriptorIndices:i,descriptorCount:n}=t.layout.gpuDescriptorSetLayout;this._buffers=Array(n).fill(null),this._textures=Array(n).fill(null),this._samplers=Array(n).fill(null);const s=[];this._gpuDescriptorSet={gpuDescriptors:s,descriptorIndices:i};for(let t=0;t<e.length;++t){const i=e[t];for(let t=0;t<i.count;t++)s.push({type:i.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})}return!0}destroy(){this._layout=null,this._gpuDescriptorSet=null}update(){if(this._isDirty&&this._gpuDescriptorSet){const t=this._gpuDescriptorSet.gpuDescriptors;for(let e=0;e<t.length;++e)if(t[e].type&go){const i=this._buffers[e];i&&(t[e].gpuBuffer=i.gpuBuffer||i.gpuBufferView)}else t[e].type&yo&&(this._textures[e]&&(t[e].gpuTexture=this._textures[e].gpuTexture),this._samplers[e]&&(t[e].gpuSampler=this._samplers[e].gpuSampler));this._isDirty=!1}}}function aB(t,e){switch(t){case Os.R8:return e.UNSIGNED_BYTE;case Os.R8SN:return e.BYTE;case Os.R8UI:return e.UNSIGNED_BYTE;case Os.R8I:return e.BYTE;case Os.R16F:return tB.HALF_FLOAT_OES;case Os.R16UI:return e.UNSIGNED_SHORT;case Os.R16I:return e.SHORT;case Os.R32F:return e.FLOAT;case Os.R32UI:return e.UNSIGNED_INT;case Os.R32I:return e.INT;case Os.RG8:return e.UNSIGNED_BYTE;case Os.RG8SN:return e.BYTE;case Os.RG8UI:return e.UNSIGNED_BYTE;case Os.RG8I:return e.BYTE;case Os.RG16F:return tB.HALF_FLOAT_OES;case Os.RG16UI:return e.UNSIGNED_SHORT;case Os.RG16I:return e.SHORT;case Os.RG32F:return e.FLOAT;case Os.RG32UI:return e.UNSIGNED_INT;case Os.RG32I:return e.INT;case Os.RGB8:case Os.SRGB8:return e.UNSIGNED_BYTE;case Os.RGB8SN:return e.BYTE;case Os.RGB8UI:return e.UNSIGNED_BYTE;case Os.RGB8I:return e.BYTE;case Os.RGB16F:return tB.HALF_FLOAT_OES;case Os.RGB16UI:return e.UNSIGNED_SHORT;case Os.RGB16I:return e.SHORT;case Os.RGB32F:return e.FLOAT;case Os.RGB32UI:return e.UNSIGNED_INT;case Os.RGB32I:return e.INT;case Os.BGRA8:case Os.RGBA8:case Os.SRGB8_A8:return e.UNSIGNED_BYTE;case Os.RGBA8SN:return e.BYTE;case Os.RGBA8UI:return e.UNSIGNED_BYTE;case Os.RGBA8I:return e.BYTE;case Os.RGBA16F:return tB.HALF_FLOAT_OES;case Os.RGBA16UI:return e.UNSIGNED_SHORT;case Os.RGBA16I:return e.SHORT;case Os.RGBA32F:return e.FLOAT;case Os.RGBA32UI:return e.UNSIGNED_INT;case Os.RGBA32I:return e.INT;case Os.R5G6B5:return e.UNSIGNED_SHORT_5_6_5;case Os.R11G11B10F:return e.FLOAT;case Os.RGB5A1:return e.UNSIGNED_SHORT_5_5_5_1;case Os.RGBA4:return e.UNSIGNED_SHORT_4_4_4_4;case Os.RGB10A2:return e.UNSIGNED_BYTE;case Os.RGB10A2UI:return e.UNSIGNED_INT;case Os.RGB9E5:return e.UNSIGNED_BYTE;case Os.D16:return e.UNSIGNED_SHORT;case Os.D16S8:return tB.UNSIGNED_INT_24_8_WEBGL;case Os.D24:return e.UNSIGNED_INT;case Os.D24S8:return tB.UNSIGNED_INT_24_8_WEBGL;case Os.D32F:return e.UNSIGNED_INT;case Os.D32F_S8:return tB.UNSIGNED_INT_24_8_WEBGL;case Os.BC1:case Os.BC1_SRGB:case Os.BC2:case Os.BC2_SRGB:case Os.BC3:case Os.BC3_SRGB:case Os.BC4:return e.UNSIGNED_BYTE;case Os.BC4_SNORM:return e.BYTE;case Os.BC5:return e.UNSIGNED_BYTE;case Os.BC5_SNORM:return e.BYTE;case Os.BC6H_SF16:case Os.BC6H_UF16:return e.FLOAT;case Os.BC7:case Os.BC7_SRGB:case Os.ETC_RGB8:case Os.ETC2_RGB8:case Os.ETC2_SRGB8:case Os.ETC2_RGB8_A1:case Os.ETC2_SRGB8_A1:case Os.EAC_R11:return e.UNSIGNED_BYTE;case Os.EAC_R11SN:return e.BYTE;case Os.EAC_RG11:return e.UNSIGNED_BYTE;case Os.EAC_RG11SN:return e.BYTE;case Os.PVRTC_RGB2:case Os.PVRTC_RGBA2:case Os.PVRTC_RGB4:case Os.PVRTC_RGBA4:case Os.PVRTC2_2BPP:case Os.PVRTC2_4BPP:return e.UNSIGNED_BYTE;case Os.ASTC_RGBA_4X4:case Os.ASTC_RGBA_5X4:case Os.ASTC_RGBA_5X5:case Os.ASTC_RGBA_6X5:case Os.ASTC_RGBA_6X6:case Os.ASTC_RGBA_8X5:case Os.ASTC_RGBA_8X6:case Os.ASTC_RGBA_8X8:case Os.ASTC_RGBA_10X5:case Os.ASTC_RGBA_10X6:case Os.ASTC_RGBA_10X8:case Os.ASTC_RGBA_10X10:case Os.ASTC_RGBA_12X10:case Os.ASTC_RGBA_12X12:case Os.ASTC_SRGBA_4X4:case Os.ASTC_SRGBA_5X4:case Os.ASTC_SRGBA_5X5:case Os.ASTC_SRGBA_6X5:case Os.ASTC_SRGBA_6X6:case Os.ASTC_SRGBA_8X5:case Os.ASTC_SRGBA_8X6:case Os.ASTC_SRGBA_8X8:case Os.ASTC_SRGBA_10X5:case Os.ASTC_SRGBA_10X6:case Os.ASTC_SRGBA_10X8:case Os.ASTC_SRGBA_10X10:case Os.ASTC_SRGBA_12X10:case Os.ASTC_SRGBA_12X12:default:return e.UNSIGNED_BYTE}}function lB(t,e){switch(t){case Os.A8:return e.ALPHA;case Os.L8:return e.LUMINANCE;case Os.LA8:return e.LUMINANCE_ALPHA;case Os.RGB8:case Os.RGB16F:case Os.RGB32F:return e.RGB;case Os.BGRA8:case Os.RGBA8:case Os.SRGB8_A8:case Os.RGBA16F:case Os.RGBA32F:return e.RGBA;case Os.R5G6B5:return e.RGB;case Os.RGB5A1:case Os.RGBA4:return e.RGBA;case Os.D16:return e.DEPTH_COMPONENT;case Os.D16S8:return e.DEPTH_STENCIL;case Os.D24:return e.DEPTH_COMPONENT;case Os.D24S8:return e.DEPTH_STENCIL;case Os.D32F:return e.DEPTH_COMPONENT;case Os.D32F_S8:return e.DEPTH_STENCIL;case Os.BC1:return tB.COMPRESSED_RGB_S3TC_DXT1_EXT;case Os.BC1_ALPHA:return tB.COMPRESSED_RGBA_S3TC_DXT1_EXT;case Os.BC1_SRGB:return tB.COMPRESSED_SRGB_S3TC_DXT1_EXT;case Os.BC1_SRGB_ALPHA:return tB.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case Os.BC2:return tB.COMPRESSED_RGBA_S3TC_DXT3_EXT;case Os.BC2_SRGB:return tB.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case Os.BC3:return tB.COMPRESSED_RGBA_S3TC_DXT5_EXT;case Os.BC3_SRGB:return tB.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case Os.ETC_RGB8:return tB.COMPRESSED_RGB_ETC1_WEBGL;case Os.ETC2_RGB8:return tB.COMPRESSED_RGB8_ETC2;case Os.ETC2_SRGB8:return tB.COMPRESSED_SRGB8_ETC2;case Os.ETC2_RGB8_A1:return tB.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Os.ETC2_SRGB8_A1:return tB.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case Os.ETC2_RGBA8:return tB.COMPRESSED_RGBA8_ETC2_EAC;case Os.ETC2_SRGB8_A8:return tB.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case Os.EAC_R11:return tB.COMPRESSED_R11_EAC;case Os.EAC_R11SN:return tB.COMPRESSED_SIGNED_R11_EAC;case Os.EAC_RG11:return tB.COMPRESSED_RG11_EAC;case Os.EAC_RG11SN:return tB.COMPRESSED_SIGNED_RG11_EAC;case Os.PVRTC_RGB2:return tB.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case Os.PVRTC_RGBA2:return tB.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case Os.PVRTC_RGB4:return tB.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case Os.PVRTC_RGBA4:return tB.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case Os.ASTC_RGBA_4X4:return tB.COMPRESSED_RGBA_ASTC_4x4_KHR;case Os.ASTC_RGBA_5X4:return tB.COMPRESSED_RGBA_ASTC_5x4_KHR;case Os.ASTC_RGBA_5X5:return tB.COMPRESSED_RGBA_ASTC_5x5_KHR;case Os.ASTC_RGBA_6X5:return tB.COMPRESSED_RGBA_ASTC_6x5_KHR;case Os.ASTC_RGBA_6X6:return tB.COMPRESSED_RGBA_ASTC_6x6_KHR;case Os.ASTC_RGBA_8X5:return tB.COMPRESSED_RGBA_ASTC_8x5_KHR;case Os.ASTC_RGBA_8X6:return tB.COMPRESSED_RGBA_ASTC_8x6_KHR;case Os.ASTC_RGBA_8X8:return tB.COMPRESSED_RGBA_ASTC_8x8_KHR;case Os.ASTC_RGBA_10X5:return tB.COMPRESSED_RGBA_ASTC_10x5_KHR;case Os.ASTC_RGBA_10X6:return tB.COMPRESSED_RGBA_ASTC_10x6_KHR;case Os.ASTC_RGBA_10X8:return tB.COMPRESSED_RGBA_ASTC_10x8_KHR;case Os.ASTC_RGBA_10X10:return tB.COMPRESSED_RGBA_ASTC_10x10_KHR;case Os.ASTC_RGBA_12X10:return tB.COMPRESSED_RGBA_ASTC_12x10_KHR;case Os.ASTC_RGBA_12X12:return tB.COMPRESSED_RGBA_ASTC_12x12_KHR;case Os.ASTC_SRGBA_4X4:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case Os.ASTC_SRGBA_5X4:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case Os.ASTC_SRGBA_5X5:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case Os.ASTC_SRGBA_6X5:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case Os.ASTC_SRGBA_6X6:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case Os.ASTC_SRGBA_8X5:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case Os.ASTC_SRGBA_8X6:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case Os.ASTC_SRGBA_8X8:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case Os.ASTC_SRGBA_10X5:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case Os.ASTC_SRGBA_10X6:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case Os.ASTC_SRGBA_10X8:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case Os.ASTC_SRGBA_10X10:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case Os.ASTC_SRGBA_12X10:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case Os.ASTC_SRGBA_12X12:return tB.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),e.RGBA}}function cB(t,e){switch(t){case Ns.BOOL:return e.BOOL;case Ns.BOOL2:return e.BOOL_VEC2;case Ns.BOOL3:return e.BOOL_VEC3;case Ns.BOOL4:return e.BOOL_VEC4;case Ns.INT:return e.INT;case Ns.INT2:return e.INT_VEC2;case Ns.INT3:return e.INT_VEC3;case Ns.INT4:return e.INT_VEC4;case Ns.UINT:return e.UNSIGNED_INT;case Ns.FLOAT:return e.FLOAT;case Ns.FLOAT2:return e.FLOAT_VEC2;case Ns.FLOAT3:return e.FLOAT_VEC3;case Ns.FLOAT4:return e.FLOAT_VEC4;case Ns.MAT2:return e.FLOAT_MAT2;case Ns.MAT3:return e.FLOAT_MAT3;case Ns.MAT4:return e.FLOAT_MAT4;case Ns.SAMPLER2D:return e.SAMPLER_2D;case Ns.SAMPLER_CUBE:return e.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),Ns.UNKNOWN}}function hB(t){switch(t){case Ns.BOOL:case Ns.BOOL2:case Ns.BOOL3:case Ns.BOOL4:case Ns.INT:case Ns.INT2:case Ns.INT3:case Ns.INT4:case Ns.UINT:return Int32Array;case Ns.FLOAT:case Ns.FLOAT2:case Ns.FLOAT3:case Ns.FLOAT4:case Ns.MAT2:case Ns.MAT3:case Ns.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function _B(t,e){switch(t){case e.BOOL:return Ns.BOOL;case e.BOOL_VEC2:return Ns.BOOL2;case e.BOOL_VEC3:return Ns.BOOL3;case e.BOOL_VEC4:return Ns.BOOL4;case e.INT:return Ns.INT;case e.INT_VEC2:return Ns.INT2;case e.INT_VEC3:return Ns.INT3;case e.INT_VEC4:return Ns.INT4;case e.UNSIGNED_INT:return Ns.UINT;case e.FLOAT:return Ns.FLOAT;case e.FLOAT_VEC2:return Ns.FLOAT2;case e.FLOAT_VEC3:return Ns.FLOAT3;case e.FLOAT_VEC4:return Ns.FLOAT4;case e.FLOAT_MAT2:return Ns.MAT2;case e.FLOAT_MAT3:return Ns.MAT3;case e.FLOAT_MAT4:return Ns.MAT4;case e.SAMPLER_2D:return Ns.SAMPLER2D;case e.SAMPLER_CUBE:return Ns.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),Ns.UNKNOWN}}function uB(t,e){switch(t){case e.BOOL:return 4;case e.BOOL_VEC2:return 8;case e.BOOL_VEC3:return 12;case e.BOOL_VEC4:return 16;case e.INT:return 4;case e.INT_VEC2:return 8;case e.INT_VEC3:return 12;case e.INT_VEC4:return 16;case e.UNSIGNED_INT:case e.FLOAT:return 4;case e.FLOAT_VEC2:return 8;case e.FLOAT_VEC3:return 12;case e.FLOAT_VEC4:case e.FLOAT_MAT2:return 16;case e.FLOAT_MAT3:return 36;case e.FLOAT_MAT4:return 64;case e.SAMPLER_2D:case e.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function mB(t,e){switch(t){case e.FLOAT_MAT2:return 2;case e.FLOAT_MAT3:return 3;case e.FLOAT_MAT4:return 4;default:return 1}}!function(t){t[t.RGBA16F_EXT=34842]="RGBA16F_EXT",t[t.RGB16F_EXT=34843]="RGB16F_EXT",t[t.RGBA32F_EXT=34836]="RGBA32F_EXT",t[t.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",t[t.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",t[t.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",t[t.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",t[t.SRGB_EXT=35904]="SRGB_EXT",t[t.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",t[t.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",t[t.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",t[t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",t[t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",t[t.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",t[t.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",t[t.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",t[t.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",t[t.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",t[t.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",t[t.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",t[t.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",t[t.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",t[t.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",t[t.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(tB||(tB={}));const pB=[512,513,514,515,516,517,518,519],dB=[0,7680,7681,7682,7683,5386,34055,34056],fB=[32774,32778,32779,32775,32776],gB=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];let yB;!function(t){t[t.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",t[t.END_RENDER_PASS=1]="END_RENDER_PASS",t[t.BIND_STATES=2]="BIND_STATES",t[t.DRAW=3]="DRAW",t[t.UPDATE_BUFFER=4]="UPDATE_BUFFER",t[t.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",t[t.COUNT=6]="COUNT"}(yB||(yB={}));class vB{constructor(t){this.cmdType=void 0,this.refCount=0,this.cmdType=t}}class xB extends vB{constructor(){super(yB.BEGIN_RENDER_PASS),this.gpuRenderPass=null,this.gpuFramebuffer=null,this.renderArea=new yr,this.clearFlag=mr.NONE,this.clearColors=[],this.clearDepth=1,this.clearStencil=0}clear(){this.gpuFramebuffer=null,this.clearColors.length=0}}class bB extends vB{constructor(){super(yB.BIND_STATES),this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets=[],this.dynamicOffsets=[],this.dynamicStates=new uo}clear(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0}}class SB extends vB{constructor(){super(yB.DRAW),this.drawInfo=new Ir}clear(){}}class AB extends vB{constructor(){super(yB.UPDATE_BUFFER),this.gpuBuffer=null,this.buffer=null,this.offset=0,this.size=0}clear(){this.gpuBuffer=null,this.buffer=null}}class CB extends vB{constructor(){super(yB.COPY_BUFFER_TO_TEXTURE),this.gpuTexture=null,this.buffers=[],this.regions=[]}clear(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0}}class TB{constructor(){this.cmds=new U(1),this.beginRenderPassCmds=new U(1),this.bindStatesCmds=new U(1),this.drawCmds=new U(1),this.updateBufferCmds=new U(1),this.copyBufferToTextureCmds=new U(1)}clearCmds(t){this.beginRenderPassCmds.length&&(t.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(t.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(t.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(t.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(t.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()}}function wB(t,e,i,n,s){if(e.usage&Ls.UNIFORM)ArrayBuffer.isView(i)?e.vf32.set(i,n/Float32Array.BYTES_PER_ELEMENT):e.vf32.set(new Float32Array(i),n/Float32Array.BYTES_PER_ELEMENT);else if(e.usage&Ls.INDIRECT)e.indirects.length=n,Array.prototype.push.apply(e.indirects,i.drawInfos);else{const r=i,{gl:o}=t,a=t.stateCache;switch(e.glTarget){case o.ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=EB.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer);break;case o.ELEMENT_ARRAY_BUFFER:t.useVAO&&a.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),a.glVAO=EB.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}s===r.byteLength?o.bufferSubData(e.glTarget,n,r):o.bufferSubData(e.glTarget,n,r.slice(0,s))}}const EB={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function PB(t,e,i,n,s,r,o){const{gl:a}=t,l=t.stateCache;let c=0;if(i&&e){l.glFramebuffer!==i.glFramebuffer&&(a.bindFramebuffer(a.FRAMEBUFFER,i.glFramebuffer),l.glFramebuffer=i.glFramebuffer),l.viewport.left===n.x&&l.viewport.top===n.y&&l.viewport.width===n.width&&l.viewport.height===n.height||(a.viewport(n.x,n.y,n.width,n.height),l.viewport.left=n.x,l.viewport.top=n.y,l.viewport.width=n.width,l.viewport.height=n.height),l.scissorRect.x===n.x&&l.scissorRect.y===n.y&&l.scissorRect.width===n.width&&l.scissorRect.height===n.height||(a.scissor(n.x,n.y,n.width,n.height),l.scissorRect.x=n.x,l.scissorRect.y=n.y,l.scissorRect.width=n.width,l.scissorRect.height=n.height);let h=s.length;t.WEBGL_draw_buffers||(h=1);for(let t=0;t<h;++t){const i=e.colorAttachments[t];if(i.format!==Os.UNKNOWN)switch(i.loadOp){case Zs.LOAD:break;case Zs.CLEAR:{l.bs.targets[0].blendColorMask!==$s.ALL&&a.colorMask(!0,!0,!0,!0);const t=s[0];a.clearColor(t.x,t.y,t.z,t.w),c|=a.COLOR_BUFFER_BIT;break}case Zs.DISCARD:}}if(e.depthStencilAttachment&&e.depthStencilAttachment.format!==Os.UNKNOWN){switch(e.depthStencilAttachment.depthLoadOp){case Zs.LOAD:break;case Zs.CLEAR:l.dss.depthWrite||a.depthMask(!0),a.clearDepth(r),c|=a.DEPTH_BUFFER_BIT;break;case Zs.DISCARD:}if(fo[e.depthStencilAttachment.format].hasStencil)switch(e.depthStencilAttachment.stencilLoadOp){case Zs.LOAD:break;case Zs.CLEAR:l.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,65535),l.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,65535),a.clearStencil(o),c|=a.STENCIL_BUFFER_BIT;break;case Zs.DISCARD:}}if(c&&a.clear(c),c&a.COLOR_BUFFER_BIT){const t=l.bs.targets[0].blendColorMask;if(t!==$s.ALL){const e=(t&$s.R)!==$s.NONE,i=(t&$s.G)!==$s.NONE,n=(t&$s.B)!==$s.NONE,s=(t&$s.A)!==$s.NONE;a.colorMask(e,i,n,s)}}c&a.DEPTH_BUFFER_BIT&&!l.dss.depthWrite&&a.depthMask(!1),c&a.STENCIL_BUFFER_BIT&&(l.dss.stencilWriteMaskFront||a.stencilMaskSeparate(a.FRONT,0),l.dss.stencilWriteMaskBack||a.stencilMaskSeparate(a.BACK,0))}}function DB(t,e,i,n,s,r){const{gl:o}=t,a=t.stateCache,l=e&&e.gpuShader;let c,h,_,u=!1;if(e&&EB.gpuPipelineState!==e){if(EB.gpuPipelineState=e,EB.glPrimitive=e.glPrimitive,e.gpuShader){const{glProgram:t}=e.gpuShader;a.glProgram!==t&&(o.useProgram(t),a.glProgram=t,u=!0)}const{rs:t}=e;if(t){if(a.rs.cullMode!==t.cullMode){switch(t.cullMode){case ar.NONE:o.disable(o.CULL_FACE);break;case ar.FRONT:o.enable(o.CULL_FACE),o.cullFace(o.FRONT);break;case ar.BACK:o.enable(o.CULL_FACE),o.cullFace(o.BACK)}a.rs.cullMode=t.cullMode}const e=t.isFrontFaceCCW;a.rs.isFrontFaceCCW!==e&&(o.frontFace(e?o.CCW:o.CW),a.rs.isFrontFaceCCW=e),a.rs.depthBias===t.depthBias&&a.rs.depthBiasSlop===t.depthBiasSlop||(o.polygonOffset(t.depthBias,t.depthBiasSlop),a.rs.depthBias=t.depthBias,a.rs.depthBiasSlop=t.depthBiasSlop),a.rs.lineWidth!==t.lineWidth&&(o.lineWidth(t.lineWidth),a.rs.lineWidth=t.lineWidth)}const{dss:i}=e;i&&(a.dss.depthTest!==i.depthTest&&(i.depthTest?o.enable(o.DEPTH_TEST):o.disable(o.DEPTH_TEST),a.dss.depthTest=i.depthTest),a.dss.depthWrite!==i.depthWrite&&(o.depthMask(i.depthWrite),a.dss.depthWrite=i.depthWrite),a.dss.depthFunc!==i.depthFunc&&(o.depthFunc(pB[i.depthFunc]),a.dss.depthFunc=i.depthFunc),a.dss.stencilTestFront===i.stencilTestFront&&a.dss.stencilTestBack===i.stencilTestBack||(i.stencilTestFront||i.stencilTestBack?o.enable(o.STENCIL_TEST):o.disable(o.STENCIL_TEST),a.dss.stencilTestFront=i.stencilTestFront,a.dss.stencilTestBack=i.stencilTestBack),a.dss.stencilFuncFront===i.stencilFuncFront&&a.dss.stencilRefFront===i.stencilRefFront&&a.dss.stencilReadMaskFront===i.stencilReadMaskFront||(o.stencilFuncSeparate(o.FRONT,pB[i.stencilFuncFront],i.stencilRefFront,i.stencilReadMaskFront),a.dss.stencilFuncFront=i.stencilFuncFront,a.dss.stencilRefFront=i.stencilRefFront,a.dss.stencilReadMaskFront=i.stencilReadMaskFront),a.dss.stencilFailOpFront===i.stencilFailOpFront&&a.dss.stencilZFailOpFront===i.stencilZFailOpFront&&a.dss.stencilPassOpFront===i.stencilPassOpFront||(o.stencilOpSeparate(o.FRONT,dB[i.stencilFailOpFront],dB[i.stencilZFailOpFront],dB[i.stencilPassOpFront]),a.dss.stencilFailOpFront=i.stencilFailOpFront,a.dss.stencilZFailOpFront=i.stencilZFailOpFront,a.dss.stencilPassOpFront=i.stencilPassOpFront),a.dss.stencilWriteMaskFront!==i.stencilWriteMaskFront&&(o.stencilMaskSeparate(o.FRONT,i.stencilWriteMaskFront),a.dss.stencilWriteMaskFront=i.stencilWriteMaskFront),a.dss.stencilFuncBack===i.stencilFuncBack&&a.dss.stencilRefBack===i.stencilRefBack&&a.dss.stencilReadMaskBack===i.stencilReadMaskBack||(o.stencilFuncSeparate(o.BACK,pB[i.stencilFuncBack],i.stencilRefBack,i.stencilReadMaskBack),a.dss.stencilFuncBack=i.stencilFuncBack,a.dss.stencilRefBack=i.stencilRefBack,a.dss.stencilReadMaskBack=i.stencilReadMaskBack),a.dss.stencilFailOpBack===i.stencilFailOpBack&&a.dss.stencilZFailOpBack===i.stencilZFailOpBack&&a.dss.stencilPassOpBack===i.stencilPassOpBack||(o.stencilOpSeparate(o.BACK,dB[i.stencilFailOpBack],dB[i.stencilZFailOpBack],dB[i.stencilPassOpBack]),a.dss.stencilFailOpBack=i.stencilFailOpBack,a.dss.stencilZFailOpBack=i.stencilZFailOpBack,a.dss.stencilPassOpBack=i.stencilPassOpBack),a.dss.stencilWriteMaskBack!==i.stencilWriteMaskBack&&(o.stencilMaskSeparate(o.BACK,i.stencilWriteMaskBack),a.dss.stencilWriteMaskBack=i.stencilWriteMaskBack));const{bs:n}=e;if(n){a.bs.isA2C!==n.isA2C&&(n.isA2C?o.enable(o.SAMPLE_ALPHA_TO_COVERAGE):o.disable(o.SAMPLE_ALPHA_TO_COVERAGE),a.bs.isA2C=n.isA2C),a.bs.blendColor.x===n.blendColor.x&&a.bs.blendColor.y===n.blendColor.y&&a.bs.blendColor.z===n.blendColor.z&&a.bs.blendColor.w===n.blendColor.w||(o.blendColor(n.blendColor.x,n.blendColor.y,n.blendColor.z,n.blendColor.w),a.bs.blendColor.x=n.blendColor.x,a.bs.blendColor.y=n.blendColor.y,a.bs.blendColor.z=n.blendColor.z,a.bs.blendColor.w=n.blendColor.w);const t=n.targets[0],e=a.bs.targets[0];e.blend!==t.blend&&(t.blend?o.enable(o.BLEND):o.disable(o.BLEND),e.blend=t.blend),e.blendEq===t.blendEq&&e.blendAlphaEq===t.blendAlphaEq||(o.blendEquationSeparate(fB[t.blendEq],fB[t.blendAlphaEq]),e.blendEq=t.blendEq,e.blendAlphaEq=t.blendAlphaEq),e.blendSrc===t.blendSrc&&e.blendDst===t.blendDst&&e.blendSrcAlpha===t.blendSrcAlpha&&e.blendDstAlpha===t.blendDstAlpha||(o.blendFuncSeparate(gB[t.blendSrc],gB[t.blendDst],gB[t.blendSrcAlpha],gB[t.blendDstAlpha]),e.blendSrc=t.blendSrc,e.blendDst=t.blendDst,e.blendSrcAlpha=t.blendSrcAlpha,e.blendDstAlpha=t.blendDstAlpha),e.blendColorMask!==t.blendColorMask&&(o.colorMask((t.blendColorMask&$s.R)!==$s.NONE,(t.blendColorMask&$s.G)!==$s.NONE,(t.blendColorMask&$s.B)!==$s.NONE,(t.blendColorMask&$s.A)!==$s.NONE),e.blendColorMask=t.blendColorMask)}}if(e&&e.gpuPipelineLayout&&l){const i=l.glBlocks.length,{dynamicOffsetIndices:r}=e.gpuPipelineLayout;for(let t=0;t<i;t++){const e=l.glBlocks[t],i=n[e.set],a=i&&i.descriptorIndices[e.binding],c=a>=0&&i.gpuDescriptors[a];let h=null,_=0;if(c&&c.gpuBuffer){const{gpuBuffer:t}=c,i=r[e.set],n=i&&i[e.binding];n>=0&&(_=s[n]),"vf32"in t?h=t.vf32:(_+=t.offset,h=t.gpuBuffer.vf32),_>>=2}if(!h){p(`Buffer binding '${e.name}' at set ${e.set} binding ${e.binding} is not bounded`);continue}const u=e.glActiveUniforms.length;for(let t=0;t<u;t++){const i=e.glActiveUniforms[t];switch(i.glType){case o.BOOL:case o.INT:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform1iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC2:case o.INT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform2iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC3:case o.INT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform3iv(i.glLoc,i.array);break}}break;case o.BOOL_VEC4:case o.INT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform4iv(i.glLoc,i.array);break}}break;case o.FLOAT:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform1fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform2fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform3fv(i.glLoc,i.array);break}}break;case o.FLOAT_VEC4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniform4fv(i.glLoc,i.array);break}}break;case o.FLOAT_MAT2:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix2fv(i.glLoc,!1,i.array);break}}break;case o.FLOAT_MAT3:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix3fv(i.glLoc,!1,i.array);break}}break;case o.FLOAT_MAT4:for(let t=0;t<i.array.length;++t){const e=i.offset+_+t;if(h[e]!==i.array[t]){for(let n=t,s=e;n<i.array.length;++n,++s)i.array[n]=h[s];o.uniformMatrix4fv(i.glLoc,!1,i.array);break}}}}}const u=l.glSamplerTextures.length;for(let e=0;e<u;e++){const i=l.glSamplerTextures[e],s=n[i.set];let r=s&&s.descriptorIndices[i.binding],u=r>=0&&s.gpuDescriptors[r];const m=i.units.length;for(let e=0;e<m;e++){const n=i.units[e];if(u&&u.gpuSampler){if(u.gpuTexture&&u.gpuTexture.size>0){const{gpuTexture:e}=u,i=a.glTexUnits[n];i.glTexture!==e.glTexture&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),e.glTexture?o.bindTexture(e.glTarget,e.glTexture):o.bindTexture(e.glTarget,t.nullTex2D.gpuTexture.glTexture),i.glTexture=e.glTexture);const{gpuSampler:s}=u;e.isPowerOf2?(c=s.glWrapS,h=s.glWrapT):(c=o.CLAMP_TO_EDGE,h=o.CLAMP_TO_EDGE),_=e.isPowerOf2?e.mipLevel<=1&&(s.glMinFilter===o.LINEAR_MIPMAP_NEAREST||s.glMinFilter===o.LINEAR_MIPMAP_LINEAR)?o.LINEAR:s.glMinFilter:s.glMinFilter===o.LINEAR||s.glMinFilter===o.LINEAR_MIPMAP_NEAREST||s.glMinFilter===o.LINEAR_MIPMAP_LINEAR?o.LINEAR:o.NEAREST,e.glWrapS!==c&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_WRAP_S,c),e.glWrapS=c),e.glWrapT!==h&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_WRAP_T,h),e.glWrapT=h),e.glMinFilter!==_&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_MIN_FILTER,_),e.glMinFilter=_),e.glMagFilter!==s.glMagFilter&&(a.texUnit!==n&&(o.activeTexture(o.TEXTURE0+n),a.texUnit=n),o.texParameteri(e.glTarget,o.TEXTURE_MAG_FILTER,s.glMagFilter),e.glMagFilter=s.glMagFilter)}u=s.gpuDescriptors[++r]}else p(`Sampler binding '${i.name}' at set ${i.set} binding ${i.binding} index ${e} is not bounded`)}}}if(i&&l&&(u||EB.gpuInputAssembler!==i)){EB.gpuInputAssembler=i;const e=t.ANGLE_instanced_arrays;if(t.useVAO){const n=t.OES_vertex_array_object;let s=i.glVAOs.get(l.glProgram);if(!s){let t;s=n.createVertexArrayOES(),i.glVAOs.set(l.glProgram,s),n.bindVertexArrayOES(s),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null;const r=l.glInputs.length;for(let n=0;n<r;n++){const s=l.glInputs[n];t=null;const r=i.glAttribs.length;for(let e=0;e<r;e++){const n=i.glAttribs[e];if(n.name===s.name){t=n;break}}if(t){a.glArrayBuffer!==t.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,t.glBuffer),a.glArrayBuffer=t.glBuffer);for(let i=0;i<t.componentCount;++i){const n=s.glLoc+i,r=t.offset+t.size*i;o.enableVertexAttribArray(n),a.glCurrentAttribLocs[n]=!0,o.vertexAttribPointer(n,t.count,t.glType,t.isNormalized,t.stride,r),e&&e.vertexAttribDivisorANGLE(n,t.isInstanced?1:0)}}}const c=i.gpuIndexBuffer;c&&o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,c.glBuffer),n.bindVertexArrayOES(null),o.bindBuffer(o.ARRAY_BUFFER,null),o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,null),a.glArrayBuffer=null,a.glElementArrayBuffer=null}a.glVAO!==s&&(n.bindVertexArrayOES(s),a.glVAO=s)}else{for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glCurrentAttribLocs[e]=!1;const n=l.glInputs.length;for(let t=0;t<n;t++){const n=l.glInputs[t];let s=null;const r=i.glAttribs.length;for(let t=0;t<r;t++){const e=i.glAttribs[t];if(e.name===n.name){s=e;break}}if(s){a.glArrayBuffer!==s.glBuffer&&(o.bindBuffer(o.ARRAY_BUFFER,s.glBuffer),a.glArrayBuffer=s.glBuffer);for(let t=0;t<s.componentCount;++t){const i=n.glLoc+t,r=s.offset+s.size*t;!a.glEnabledAttribLocs[i]&&i>=0&&(o.enableVertexAttribArray(i),a.glEnabledAttribLocs[i]=!0),a.glCurrentAttribLocs[i]=!0,o.vertexAttribPointer(i,s.count,s.glType,s.isNormalized,s.stride,r),e&&e.vertexAttribDivisorANGLE(i,s.isInstanced?1:0)}}}const s=i.gpuIndexBuffer;s&&a.glElementArrayBuffer!==s.glBuffer&&(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,s.glBuffer),a.glElementArrayBuffer=s.glBuffer);for(let e=0;e<t.capabilities.maxVertexAttributes;++e)a.glEnabledAttribLocs[e]!==a.glCurrentAttribLocs[e]&&(o.disableVertexAttribArray(e),a.glEnabledAttribLocs[e]=!1)}}if(e&&e.dynamicStates.length){const t=e.dynamicStates.length;for(let i=0;i<t;i++)switch(e.dynamicStates[i]){case lr.VIEWPORT:{const t=r.viewport;a.viewport.left===t.left&&a.viewport.top===t.top&&a.viewport.width===t.width&&a.viewport.height===t.height||(o.viewport(t.left,t.top,t.width,t.height),a.viewport.left=t.left,a.viewport.top=t.top,a.viewport.width=t.width,a.viewport.height=t.height);break}case lr.SCISSOR:{const t=r.scissor;a.scissorRect.x===t.x&&a.scissorRect.y===t.y&&a.scissorRect.width===t.width&&a.scissorRect.height===t.height||(o.scissor(t.x,t.y,t.width,t.height),a.scissorRect.x=t.x,a.scissorRect.y=t.y,a.scissorRect.width=t.width,a.scissorRect.height=t.height);break}case lr.LINE_WIDTH:a.rs.lineWidth!==r.lineWidth&&(o.lineWidth(r.lineWidth),a.rs.lineWidth=r.lineWidth);break;case lr.DEPTH_BIAS:a.rs.depthBias===r.depthBiasConstant&&a.rs.depthBiasSlop===r.depthBiasSlope||(o.polygonOffset(r.depthBiasConstant,r.depthBiasSlope),a.rs.depthBias=r.depthBiasConstant,a.rs.depthBiasSlop=r.depthBiasSlope);break;case lr.BLEND_CONSTANTS:{const t=r.blendConstant;a.bs.blendColor.x===t.x&&a.bs.blendColor.y===t.y&&a.bs.blendColor.z===t.z&&a.bs.blendColor.w===t.w||(o.blendColor(t.x,t.y,t.z,t.w),a.bs.blendColor.copy(t));break}case lr.STENCIL_WRITE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilWriteMaskFront!==t.writeMask&&(o.stencilMaskSeparate(o.FRONT,t.writeMask),a.dss.stencilWriteMaskFront=t.writeMask),a.dss.stencilWriteMaskBack!==e.writeMask&&(o.stencilMaskSeparate(o.BACK,e.writeMask),a.dss.stencilWriteMaskBack=e.writeMask);break}case lr.STENCIL_COMPARE_MASK:{const t=r.stencilStatesFront,e=r.stencilStatesBack;a.dss.stencilRefFront===t.reference&&a.dss.stencilReadMaskFront===t.compareMask||(o.stencilFuncSeparate(o.FRONT,pB[a.dss.stencilFuncFront],t.reference,t.compareMask),a.dss.stencilRefFront=t.reference,a.dss.stencilReadMaskFront=t.compareMask),a.dss.stencilRefBack===e.reference&&a.dss.stencilReadMaskBack===e.compareMask||(o.stencilFuncSeparate(o.BACK,pB[a.dss.stencilFuncBack],e.reference,e.compareMask),a.dss.stencilRefBack=e.reference,a.dss.stencilReadMaskBack=e.compareMask);break}}}}function IB(t,e){const{gl:i}=t,n=t.ANGLE_instanced_arrays,{gpuInputAssembler:s,glPrimitive:r}=EB;if(s)if(s.gpuIndirectBuffer){const t=s.gpuIndirectBuffer.indirects.length;for(let e=0;e<t;e++){const t=s.gpuIndirectBuffer.indirects[e],o=s.gpuIndexBuffer;if(t.instanceCount&&n)if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;n.drawElementsInstancedANGLE(r,t.indexCount,s.glIndexType,e,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstancedANGLE(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(o){if(t.indexCount>0){const e=t.firstIndex*o.stride;i.drawElements(r,t.indexCount,s.glIndexType,e)}}else t.vertexCount>0&&i.drawArrays(r,t.firstVertex,t.vertexCount)}}else{const t=s.gpuIndexBuffer;if(e.instanceCount&&n)if(t){if(e.indexCount>0){const i=e.firstIndex*t.stride;n.drawElementsInstancedANGLE(r,e.indexCount,s.glIndexType,i,e.instanceCount)}}else e.vertexCount>0&&n.drawArraysInstancedANGLE(r,e.firstVertex,e.vertexCount,e.instanceCount);else if(t){if(e.indexCount>0){const n=e.firstIndex*t.stride;i.drawElements(r,e.indexCount,s.glIndexType,n)}}else e.vertexCount>0&&i.drawArrays(r,e.firstVertex,e.vertexCount)}}const RB=new Array(yB.COUNT);function MB(t,e){RB.fill(0);for(let i=0;i<e.cmds.length;++i){const n=e.cmds.array[i],s=RB[n]++;switch(n){case yB.BEGIN_RENDER_PASS:{const i=e.beginRenderPassCmds.array[s];PB(t,i.gpuRenderPass,i.gpuFramebuffer,i.renderArea,i.clearColors,i.clearDepth,i.clearStencil);break}case yB.BIND_STATES:{const i=e.bindStatesCmds.array[s];DB(t,i.gpuPipelineState,i.gpuInputAssembler,i.gpuDescriptorSets,i.dynamicOffsets,i.dynamicStates);break}case yB.DRAW:IB(t,e.drawCmds.array[s].drawInfo);break;case yB.UPDATE_BUFFER:{const i=e.updateBufferCmds.array[s];wB(t,i.gpuBuffer,i.buffer,i.offset,i.size);break}case yB.COPY_BUFFER_TO_TEXTURE:{const i=e.copyBufferToTextureCmds.array[s];OB(t,i.buffers,i.gpuTexture,i.regions);break}}}}function OB(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=1,l=1,c=0;const h=fo[i.format],{isCompressed:_}=h;switch(i.glTarget){case s.TEXTURE_2D:for(let r=0;r<n.length;r++){const c=n[r];a=c.texExtent.width,l=c.texExtent.height;const h=e[o++];_?i.glInternalFmt===tB.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,i.glInternalFmt,a,l,0,h):s.compressedTexSubImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,a,l,i.glFormat,h):s.texSubImage2D(s.TEXTURE_2D,c.texSubres.mipLevel,c.texOffset.x,c.texOffset.y,a,l,i.glFormat,i.glType,h)}break;case s.TEXTURE_CUBE_MAP:for(let r=0;r<n.length;r++){const h=n[r],u=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(c=h.texSubres.baseArrayLayer;c<u;++c){a=h.texExtent.width,l=h.texExtent.height;const n=e[o++];_?i.glInternalFmt===tB.COMPRESSED_RGB_ETC1_WEBGL||t.noCompressedTexSubImage2D?s.compressedTexImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,i.glInternalFmt,a,l,0,n):s.compressedTexSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,l,i.glFormat,n):s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+c,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,a,l,i.glFormat,i.glType,n)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&ks.GEN_MIPMAP&&s.generateMipmap(i.glTarget)}class BB extends Bo{constructor(...t){super(...t),this._gpuBuffer=null,this._gpuBufferView=null,this._uniformBuffer=null}get gpuBuffer(){return this._gpuBuffer}get gpuBufferView(){return this._gpuBufferView}initialize(t){if("buffer"in t){this._isBufferView=!0;const e=t.buffer;this._usage=e.usage,this._memUsage=e.memUsage,this._size=this._stride=t.range,this._count=1,this._flags=e.flags,this._gpuBufferView={gpuBuffer:e.gpuBuffer,offset:t.offset,range:t.range}}else this._usage=t.usage,this._memUsage=t.memUsage,this._size=t.size,this._stride=Math.max(t.stride||this._size,1),this._count=this._size/this._stride,this._flags=t.flags,this._usage&Ls.INDIRECT&&(this._indirectBuffer=new Mr),this._usage&Ls.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:[],glTarget:0,glBuffer:null},t.usage&Ls.INDIRECT&&(this._gpuBuffer.indirects=this._indirectBuffer.drawInfos),this._usage&Ls.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&Vs.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;if(e.usage&Ls.VERTEX){e.glTarget=i.ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=EB.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),t.stateCache.glArrayBuffer=e.glBuffer),i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null))}else if(e.usage&Ls.INDEX){e.glTarget=i.ELEMENT_ARRAY_BUFFER;const r=i.createBuffer();r&&(e.glBuffer=r,e.size>0&&(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=EB.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&(i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),t.stateCache.glElementArrayBuffer=e.glBuffer),i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null))}else e.usage&Ls.UNIFORM?(e.glTarget=i.NONE,e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer))):(e.usage&Ls.INDIRECT||e.usage&Ls.TRANSFER_DST||e.usage&Ls.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize+=this._size;return!0}destroy(){var t,e;this._gpuBuffer&&(t=this._device,(e=this._gpuBuffer).glBuffer&&(t.gl.deleteBuffer(e.glBuffer),e.glBuffer=null),this._device.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)}resize(t){if(this._isBufferView)return void console.warn("cannot resize buffer views!");const e=this._size;e!==t&&(this._size=t,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(t)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=t,t>0&&(function(t,e){const{gl:i}=t,n=t.stateCache,s=e.memUsage&Vs.HOST?i.DYNAMIC_DRAW:i.STATIC_DRAW;e.usage&Ls.VERTEX?(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=EB.gpuInputAssembler=null),t.stateCache.glArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ARRAY_BUFFER,null),t.stateCache.glArrayBuffer=null):e.usage&Ls.INDEX?(t.useVAO&&n.glVAO&&(t.OES_vertex_array_object.bindVertexArrayOES(null),n.glVAO=EB.gpuInputAssembler=null),t.stateCache.glElementArrayBuffer!==e.glBuffer&&i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,e.glBuffer),e.buffer?i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.buffer,s):i.bufferData(i.ELEMENT_ARRAY_BUFFER,e.size,s),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,null),t.stateCache.glElementArrayBuffer=null):e.usage&Ls.UNIFORM?e.buffer&&(e.vf32=new Float32Array(e.buffer.buffer)):(e.usage&Ls.INDIRECT||e.usage&Ls.TRANSFER_DST||e.usage&Ls.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),e.glTarget=i.NONE)}(this._device,this._gpuBuffer),this._device.memoryStatus.bufferSize-=e,this._device.memoryStatus.bufferSize+=t)))}update(t,e){if(this._isBufferView)return void console.warn("cannot update through buffer views!");let i;i=void 0!==e?e:this._usage&Ls.INDIRECT?0:t.byteLength,wB(this._device,this._gpuBuffer,t,0,i)}}class NB{constructor(t,e){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(e),this._freeCmds=new U(e);for(let i=0;i<e;++i)this._frees[i]=new t;this._freeIdx=e-1}alloc(t){if(this._freeIdx<0){const e=2*this._frees.length,i=this._frees;this._frees=new Array(e);const n=e-i.length;for(let e=0;e<n;++e)this._frees[e]=new t;for(let t=n,s=0;t<e;++t,++s)this._frees[t]=i[s];this._freeIdx+=n}const e=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++e.refCount,e}free(t){0==--t.refCount&&this._freeCmds.push(t)}freeCmds(t){for(let e=0;e<t.length;++e)0==--t.array[e].refCount&&this._freeCmds.push(t.array[e])}release(){for(let t=0;t<this._freeCmds.length;++t){const e=this._freeCmds.array[t];e.clear(),this._frees[++this._freeIdx]=e}this._freeCmds.clear()}}class LB{constructor(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new NB(xB,1),this.bindStatesCmdPool=new NB(bB,1),this.drawCmdPool=new NB(SB,1),this.updateBufferCmdPool=new NB(AB,1),this.copyBufferToTextureCmdPool=new NB(CB,1)}clearCmds(t){t.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(t.beginRenderPassCmds),t.beginRenderPassCmds.clear()),t.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(t.bindStatesCmds),t.bindStatesCmds.clear()),t.drawCmds.length&&(this.drawCmdPool.freeCmds(t.drawCmds),t.drawCmds.clear()),t.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(t.updateBufferCmds),t.updateBufferCmds.clear()),t.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(t.copyBufferToTextureCmds),t.copyBufferToTextureCmds.clear()),t.cmds.clear()}releaseCmds(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()}}class FB extends No{constructor(...t){super(...t),this.cmdPackage=new TB,this._webGLAllocator=null,this._isInRenderPass=!1,this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets=[],this._curDynamicOffsets=Array(8).fill(0),this._curDynamicStates=new uo,this._isStateInvalied=!1}initialize(t){this._type=t.type,this._queue=t.queue,this._webGLAllocator=this._device.cmdAllocator;const e=this._device.bindingMappingInfo.bufferOffsets.length;for(let t=0;t<e;t++)this._curGPUDescriptorSets.push(null);return!0}destroy(){this._webGLAllocator&&(this._webGLAllocator.clearCmds(this.cmdPackage),this._webGLAllocator=null)}begin(t,e=0,i){this._webGLAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0}end(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1}beginRenderPass(t,e,i,n,s,r){const o=this._webGLAllocator.beginRenderPassCmdPool.alloc(xB);o.gpuRenderPass=t.gpuRenderPass,o.gpuFramebuffer=e.gpuFramebuffer,o.renderArea=i,o.clearColors.length=n.length;for(let t=0;t<n.length;++t)o.clearColors[t]=n[t];o.clearDepth=s,o.clearStencil=r,this.cmdPackage.beginRenderPassCmds.push(o),this.cmdPackage.cmds.push(yB.BEGIN_RENDER_PASS),this._isInRenderPass=!0}endRenderPass(){this._isInRenderPass=!1}bindPipelineState(t){const e=t.gpuPipelineState;e!==this._curGPUPipelineState&&(this._curGPUPipelineState=e,this._isStateInvalied=!0)}bindDescriptorSet(t,e,i){const n=e.gpuDescriptorSet;if(n!==this._curGPUDescriptorSets[t]&&(this._curGPUDescriptorSets[t]=n,this._isStateInvalied=!0),i){var s;const e=null===(s=this._curGPUPipelineState)||void 0===s?void 0:s.gpuPipelineLayout;if(e){const n=this._curDynamicOffsets,s=e.dynamicOffsetOffsets[t];for(let t=0;t<i.length;t++)n[s+t]=i[t];this._isStateInvalied=!0}}}bindInputAssembler(t){const e=t.gpuInputAssembler;this._curGPUInputAssembler=e,this._isStateInvalied=!0}setViewport(t){const e=this._curDynamicStates.viewport;e.left===t.left&&e.top===t.top&&e.width===t.width&&e.height===t.height&&e.minDepth===t.minDepth&&e.maxDepth===t.maxDepth||(e.left=t.left,e.top=t.top,e.width=t.width,e.height=t.height,e.minDepth=t.minDepth,e.maxDepth=t.maxDepth,this._isStateInvalied=!0)}setScissor(t){const e=this._curDynamicStates.scissor;e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height||(e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height,this._isStateInvalied=!0)}setLineWidth(t){this._curDynamicStates.lineWidth!==t&&(this._curDynamicStates.lineWidth=t,this._isStateInvalied=!0)}setDepthBias(t,e,i){const n=this._curDynamicStates;n.depthBiasConstant===t&&n.depthBiasClamp===e&&n.depthBiasSlope===i||(n.depthBiasConstant=t,n.depthBiasClamp=e,n.depthBiasSlope=i,this._isStateInvalied=!0)}setBlendConstants(t){const e=this._curDynamicStates.blendConstant;e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w||(e.copy(t),this._isStateInvalied=!0)}setDepthBound(t,e){const i=this._curDynamicStates;i.depthMinBounds===t&&i.depthMaxBounds===e||(i.depthMinBounds=t,i.depthMaxBounds=e,this._isStateInvalied=!0)}setStencilWriteMask(t,e){const i=this._curDynamicStates.stencilStatesFront,n=this._curDynamicStates.stencilStatesBack;t&cr.FRONT&&i.writeMask!==e&&(i.writeMask=e,this._isStateInvalied=!0),t&cr.BACK&&n.writeMask!==e&&(n.writeMask=e,this._isStateInvalied=!0)}setStencilCompareMask(t,e,i){const n=this._curDynamicStates.stencilStatesFront,s=this._curDynamicStates.stencilStatesBack;t&cr.FRONT&&(n.compareMask===i&&n.reference===e||(n.reference=e,n.compareMask=i,this._isStateInvalied=!0)),t&cr.BACK&&(s.compareMask===i&&s.reference===e||(s.reference=e,s.compareMask=i,this._isStateInvalied=!0))}draw(t){if(this._type===ur.PRIMARY&&this._isInRenderPass||this._type===ur.SECONDARY){this._isStateInvalied&&this.bindStates();const e=this._webGLAllocator.drawCmdPool.alloc(SB);e.drawInfo.vertexCount=t.vertexCount,e.drawInfo.firstVertex=t.firstVertex,e.drawInfo.indexCount=t.indexCount,e.drawInfo.firstIndex=t.firstIndex,e.drawInfo.vertexOffset=t.vertexOffset,e.drawInfo.instanceCount=t.instanceCount,e.drawInfo.firstInstance=t.firstInstance,this.cmdPackage.drawCmds.push(e),this.cmdPackage.cmds.push(yB.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;const i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._type===ur.PRIMARY&&!this._isInRenderPass||this._type===ur.SECONDARY){const n=t.gpuBuffer;if(n){const s=this._webGLAllocator.updateBufferCmdPool.alloc(AB);let r=0,o=null;t.usage&Ls.INDIRECT||(r=void 0!==i?i:e.byteLength),o=e,s.gpuBuffer=n,s.buffer=o,s.offset=0,s.size=r,this.cmdPackage.updateBufferCmds.push(s),this.cmdPackage.cmds.push(yB.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")}copyBuffersToTexture(t,e,i){if(this._type===ur.PRIMARY&&!this._isInRenderPass||this._type===ur.SECONDARY){const n=e.gpuTexture;if(n){const e=this._webGLAllocator.copyBufferToTextureCmdPool.alloc(CB);e&&(e.gpuTexture=n,e.regions=i,e.buffers=t,this.cmdPackage.copyBufferToTextureCmds.push(e),this.cmdPackage.cmds.push(yB.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")}execute(t,e){for(let i=0;i<e;++i){const e=t[i];for(let t=0;t<e.cmdPackage.beginRenderPassCmds.length;++t){const i=e.cmdPackage.beginRenderPassCmds.array[t];++i.refCount,this.cmdPackage.beginRenderPassCmds.push(i)}for(let t=0;t<e.cmdPackage.bindStatesCmds.length;++t){const i=e.cmdPackage.bindStatesCmds.array[t];++i.refCount,this.cmdPackage.bindStatesCmds.push(i)}for(let t=0;t<e.cmdPackage.drawCmds.length;++t){const i=e.cmdPackage.drawCmds.array[t];++i.refCount,this.cmdPackage.drawCmds.push(i)}for(let t=0;t<e.cmdPackage.updateBufferCmds.length;++t){const i=e.cmdPackage.updateBufferCmds.array[t];++i.refCount,this.cmdPackage.updateBufferCmds.push(i)}for(let t=0;t<e.cmdPackage.copyBufferToTextureCmds.length;++t){const i=e.cmdPackage.copyBufferToTextureCmds.array[t];++i.refCount,this.cmdPackage.copyBufferToTextureCmds.push(i)}this.cmdPackage.cmds.concat(e.cmdPackage.cmds.array),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}pipelineBarrier(t,e){}get webGLDevice(){return this._device}bindStates(){const t=this._webGLAllocator.bindStatesCmdPool.alloc(bB);t&&(t.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(t.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(t.dynamicOffsets,this._curDynamicOffsets),t.gpuInputAssembler=this._curGPUInputAssembler,t.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(t),this.cmdPackage.cmds.push(yB.BIND_STATES),this._isStateInvalied=!1)}}class zB extends Fo{constructor(...t){super(...t),this._gpuFramebuffer=null}get gpuFramebuffer(){return this._gpuFramebuffer}initialize(t){this._renderPass=t.renderPass,this._colorTextures=t.colorTextures||[],this._depthStencilTexture=t.depthStencilTexture||null;const e=[];for(let i=0;i<t.colorTextures.length;++i){const n=t.colorTextures[i];n&&e.push(n.gpuTexture)}let i=null;return t.depthStencilTexture&&(i=t.depthStencilTexture.gpuTexture),this._gpuFramebuffer={gpuRenderPass:t.renderPass.gpuRenderPass,gpuColorTextures:e,gpuDepthStencilTexture:i,glFramebuffer:null},function(t,e){if(!e.gpuColorTextures.length&&!e.gpuDepthStencilTexture)return;const{gl:i}=t,n=[],s=i.createFramebuffer();if(s){e.glFramebuffer=s,t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.glFramebuffer);for(let t=0;t<e.gpuColorTextures.length;++t){const s=e.gpuColorTextures[t];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+t,i.RENDERBUFFER,s.glRenderbuffer),n.push(i.COLOR_ATTACHMENT0+t))}const r=e.gpuDepthStencilTexture;if(r){const t=fo[r.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;r.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,t,r.glTarget,r.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,t,i.RENDERBUFFER,r.glRenderbuffer)}t.WEBGL_draw_buffers&&t.WEBGL_draw_buffers.drawBuffersWEBGL(n);const o=i.checkFramebufferStatus(i.FRAMEBUFFER);if(o!==i.FRAMEBUFFER_COMPLETE)switch(o){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}t.stateCache.glFramebuffer!==e.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.stateCache.glFramebuffer)}}(this._device,this._gpuFramebuffer),!0}destroy(){var t,e;this._gpuFramebuffer&&(t=this._device,(e=this._gpuFramebuffer).glFramebuffer&&(t.gl.deleteFramebuffer(e.glFramebuffer),e.glFramebuffer=null),this._gpuFramebuffer=null)}}class VB extends Go{constructor(...t){super(...t),this._gpuInputAssembler=null}get gpuInputAssembler(){return this._gpuInputAssembler}initialize(t){if(0===t.vertexBuffers.length)return console.error("InputAssemblerInfo.vertexBuffers is null."),!1;if(this._attributes=t.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=t.vertexBuffers,t.indexBuffer)this._indexBuffer=t.indexBuffer,this._indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._firstIndex=0;else{const t=this._vertexBuffers[0];this._vertexCount=t.size/t.stride,this._firstVertex=0,this._vertexOffset=0}this._instanceCount=0,this._firstInstance=0,this._indirectBuffer=t.indirectBuffer||null;const e=new Array(t.vertexBuffers.length);for(let i=0;i<t.vertexBuffers.length;++i){const n=t.vertexBuffers[i];n.gpuBuffer&&(e[i]=n.gpuBuffer)}let i=null,n=0;if(t.indexBuffer&&(i=t.indexBuffer.gpuBuffer,i))switch(i.stride){case 1:n=5121;break;case 2:n=5123;break;case 4:n=5125;break;default:console.error("Error index buffer stride.")}let s=null;return t.indirectBuffer&&(s=t.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:t.attributes,gpuVertexBuffers:e,gpuIndexBuffer:i,gpuIndirectBuffer:s,glAttribs:[],glIndexType:n,glVAOs:new Map},function(t,e){const{gl:i}=t;e.glAttribs=new Array(e.attributes.length);const n=[0,0,0,0,0,0,0,0];for(let t=0;t<e.attributes.length;++t){const s=e.attributes[t],r=void 0!==s.stream?s.stream:0,o=e.gpuVertexBuffers[r],a=aB(s.format,i),{size:l}=fo[s.format];e.glAttribs[t]={name:s.name,glBuffer:o.glBuffer,glType:a,size:l,count:fo[s.format].count,stride:o.stride,componentCount:mB(a,i),isNormalized:void 0!==s.isNormalized&&s.isNormalized,isInstanced:void 0!==s.isInstanced&&s.isInstanced,offset:n[r]},n[r]+=l}}(this._device,this._gpuInputAssembler),!0}destroy(){const t=this._device;this._gpuInputAssembler&&t.useVAO&&function(t,e){const i=e.glVAOs.values();let n=i.next();for(;!n.done;)t.OES_vertex_array_object.deleteVertexArrayOES(n.value),n=i.next();e.glVAOs.clear()}(t,this._gpuInputAssembler),this._gpuInputAssembler=null}}class UB extends ko{constructor(...t){super(...t),this._gpuDescriptorSetLayout=null}get gpuDescriptorSetLayout(){return this._gpuDescriptorSetLayout}initialize(t){Array.prototype.push.apply(this._bindings,t.bindings);let e=0,i=-1;const n=[];for(let t=0;t<this._bindings.length;t++){const s=this._bindings[t];n.push(e),e+=s.count,s.binding>i&&(i=s.binding)}this._bindingIndices=Array(i+1).fill(-1);const s=this._descriptorIndices=Array(i+1).fill(-1);for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];this._bindingIndices[e.binding]=t,s[e.binding]=n[t]}const r=[];for(let t=0;t<this._bindings.length;t++){const e=this._bindings[t];if(e.descriptorType&vo)for(let t=0;t<e.count;t++)r.push(e.binding)}return this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:r,descriptorIndices:s,descriptorCount:e},!0}destroy(){this._bindings.length=0}}class GB extends Ho{constructor(...t){super(...t),this._gpuPipelineLayout=null}get gpuPipelineLayout(){return this._gpuPipelineLayout}initialize(t){Array.prototype.push.apply(this._setLayouts,t.setLayouts);const e=[],i=[];let n=0;const s=[];for(let t=0;t<this._setLayouts.length;t++){const r=this._setLayouts[t],o=r.gpuDescriptorSetLayout.dynamicBindings,a=Array(r.bindingIndices.length).fill(-1);for(let t=0;t<o.length;t++){const e=o[t];a[e]<0&&(a[e]=n+t)}i.push(r.gpuDescriptorSetLayout),e.push(a),s.push(n),n+=o.length}return this._gpuPipelineLayout={gpuSetLayouts:i,dynamicOffsetIndices:e,dynamicOffsetCount:n,dynamicOffsetOffsets:s},!0}destroy(){this._setLayouts.length=0}}class kB{get native(){return this}constructor(t=!1,e=rr.FILL,i=or.GOURAND,n=ar.BACK,s=!0,r=!1,o=0,a=0,l=0,c=!0,h=!1,_=1){this.isDiscard=t,this.polygonMode=e,this.shadeModel=i,this.cullMode=n,this.isFrontFaceCCW=s,this.depthBiasEnabled=r,this.depthBias=o,this.depthBiasClamp=a,this.depthBiasSlop=l,this.isDepthClip=c,this.isMultisample=h,this.lineWidth=_}reset(){this.isDiscard=!1,this.polygonMode=rr.FILL,this.shadeModel=or.GOURAND,this.cullMode=ar.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1}assign(t){Object.assign(this,t)}destroy(){}}class HB{get native(){return this}constructor(t=!0,e=!0,i=qs.LESS,n=!1,s=qs.ALWAYS,r=65535,o=65535,a=Xs.KEEP,l=Xs.KEEP,c=Xs.KEEP,h=1,_=!1,u=qs.ALWAYS,m=65535,p=65535,d=Xs.KEEP,f=Xs.KEEP,g=Xs.KEEP,y=1){this.depthTest=t,this.depthWrite=e,this.depthFunc=i,this.stencilTestFront=n,this.stencilFuncFront=s,this.stencilReadMaskFront=r,this.stencilWriteMaskFront=o,this.stencilFailOpFront=a,this.stencilZFailOpFront=l,this.stencilPassOpFront=c,this.stencilRefFront=h,this.stencilTestBack=_,this.stencilFuncBack=u,this.stencilReadMaskBack=m,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=f,this.stencilPassOpBack=g,this.stencilRefBack=y}reset(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=qs.LESS,this.stencilTestFront=!1,this.stencilFuncFront=qs.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Xs.KEEP,this.stencilZFailOpFront=Xs.KEEP,this.stencilPassOpFront=Xs.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=qs.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Xs.KEEP,this.stencilZFailOpBack=Xs.KEEP,this.stencilPassOpBack=Xs.KEEP,this.stencilRefBack=1}assign(t){Object.assign(this,t)}destroy(){}}class jB{constructor(t=!1,e=Ys.ONE,i=Ys.ZERO,n=Ks.ADD,s=Ys.ONE,r=Ys.ZERO,o=Ks.ADD,a=$s.ALL){this.blend=t,this.blendSrc=e,this.blendDst=i,this.blendEq=n,this.blendSrcAlpha=s,this.blendDstAlpha=r,this.blendAlphaEq=o,this.blendColorMask=a}reset(){this.blend=!1,this.blendSrc=Ys.ONE,this.blendDst=Ys.ZERO,this.blendEq=Ks.ADD,this.blendSrcAlpha=Ys.ONE,this.blendDstAlpha=Ys.ZERO,this.blendAlphaEq=Ks.ADD,this.blendColorMask=$s.ALL}assign(t){Object.assign(this,t)}destroy(){}}class WB{get native(){return this}constructor(t=!1,e=!1,i=new wr,n=[new jB]){this.isA2C=t,this.isIndepend=e,this.blendColor=i,this.targets=n}setTarget(t,e){let i=this.targets[t];i||(i=this.targets[t]=new jB),Object.assign(i,e)}reset(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()}destroy(){}}class qB extends mo{get shader(){return this._shader}get pipelineLayout(){return this._pipelineLayout}get primitive(){return this._primitive}get rasterizerState(){return this._rs}get depthStencilState(){return this._dss}get blendState(){return this._bs}get inputState(){return this._is}get dynamicStates(){return this._dynamicStates}get renderPass(){return this._renderPass}constructor(t){super(Ps.PIPELINE_STATE),this._device=void 0,this._shader=null,this._pipelineLayout=null,this._primitive=sr.TRIANGLE_LIST,this._is=null,this._rs=new kB,this._dss=new HB,this._bs=new WB,this._dynamicStates=lr.NONE,this._renderPass=null,this._device=t}}const XB=[0,1,3,2,0,0,0,4,5,6,0,0,0,0];class YB extends qB{constructor(...t){super(...t),this._gpuPipelineState=null}get gpuPipelineState(){return this._gpuPipelineState}initialize(t){this._primitive=t.primitive,this._shader=t.shader,this._pipelineLayout=t.pipelineLayout;const e=this._bs;if(t.blendState){const i=t.blendState,{targets:n}=i;n&&n.forEach(((t,i)=>{e.setTarget(i,t)})),void 0!==i.isA2C&&(e.isA2C=i.isA2C),void 0!==i.isIndepend&&(e.isIndepend=i.isIndepend),void 0!==i.blendColor&&(e.blendColor=i.blendColor)}Object.assign(this._rs,t.rasterizerState),Object.assign(this._dss,t.depthStencilState),this._is=t.inputState,this._renderPass=t.renderPass,this._dynamicStates=t.dynamicStates;const i=[];for(let t=0;t<31;t++)this._dynamicStates&1<<t&&i.push(1<<t);return this._gpuPipelineState={glPrimitive:XB[t.primitive],gpuShader:t.shader.gpuShader,gpuPipelineLayout:t.pipelineLayout.gpuPipelineLayout,rs:t.rasterizerState,dss:t.depthStencilState,bs:t.blendState,gpuRenderPass:t.renderPass.gpuRenderPass,dynamicStates:i},!0}destroy(){this._gpuPipelineState=null}}class KB extends FB{beginRenderPass(t,e,i,n,s,r){PB(this._device,t.gpuRenderPass,e.gpuFramebuffer,i,n,s,r),this._isInRenderPass=!0}draw(t){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates(),IB(this._device,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;const e=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=e/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(e-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")}updateBuffer(t,e,i){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{const n=t.gpuBuffer;if(n){let s;s=void 0!==i?i:t.usage&Ls.INDIRECT?0:e.byteLength,wB(this._device,n,e,0,s)}}}copyBuffersToTexture(t,e,i){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{const n=e.gpuTexture;n&&OB(this._device,t,n,i)}}execute(t,e){for(let i=0;i<e;++i){const e=t[i];MB(this._device,e.cmdPackage),this._numDrawCalls+=e._numDrawCalls,this._numInstances+=e._numInstances,this._numTris+=e._numTris}}bindStates(){DB(this._device,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1}}class $B extends jo{constructor(...t){super(...t),this.numDrawCalls=0,this.numInstances=0,this.numTris=0}initialize(t){return this._type=t.type,!0}destroy(){}submit(t){if(!this._isAsync){const e=t.length;for(let i=0;i<e;i++){const e=t[i];this.numDrawCalls+=e.numDrawCalls,this.numInstances+=e.numInstances,this.numTris+=e.numTris}}}clear(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0}}class JB extends Wo{constructor(...t){super(...t),this._gpuRenderPass=null}get gpuRenderPass(){return this._gpuRenderPass}initialize(t){return this._colorInfos=t.colorAttachments,this._depthStencilInfo=t.depthStencilAttachment,t.subpasses&&(this._subpasses=t.subpasses),this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash(),!0}destroy(){this._gpuRenderPass=null}}const ZB=[10497,33648,33071,33071];class QB extends qo{constructor(...t){super(...t),this._gpuSampler=null}get gpuSampler(){return this._gpuSampler}initialize(t){this._minFilter=t.minFilter,this._magFilter=t.magFilter,this._mipFilter=t.mipFilter,this._addressU=t.addressU,this._addressV=t.addressV,this._addressW=t.addressW,this._maxAnisotropy=t.maxAnisotropy,this._cmpFunc=t.cmpFunc,this._borderColor=t.borderColor,this._mipLODBias=t.mipLODBias;let e=0,i=0;const n=this._minFilter,s=this._magFilter,r=this._mipFilter;e=n===js.LINEAR||n===js.ANISOTROPIC?r===js.LINEAR||r===js.ANISOTROPIC?9987:r===js.POINT?9985:9729:r===js.LINEAR||r===js.ANISOTROPIC?9986:r===js.POINT?9984:9728,i=s===js.LINEAR||s===js.ANISOTROPIC?9729:9728;const o=ZB[this._addressU],a=ZB[this._addressV],l=ZB[this._addressW];return this._gpuSampler={glMinFilter:e,glMagFilter:i,glWrapS:o,glWrapT:a,glWrapR:l},!0}destroy(){this._gpuSampler=null}}class tN extends Xo{constructor(...t){super(...t),this._gpuShader=null}get gpuShader(){return this._gpuShader}initialize(t){this._name=t.name,this._stages=t.stages,this._attributes=t.attributes,this._blocks=t.blocks,this._samplers=t.samplers,this._gpuShader={name:t.name,blocks:t.blocks,samplerTextures:t.samplerTextures,gpuStages:new Array(t.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(let e=0;e<t.stages.length;++e){const i=t.stages[e];this._gpuShader.gpuStages[e]={type:i.stage,source:i.source,glShader:null}}return function(t,e){const{gl:i}=t;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];let s=0,r="",o=1;switch(n.type){case Js.VERTEX:r="VertexShader",s=i.VERTEX_SHADER;break;case Js.FRAGMENT:r="FragmentShader",s=i.FRAGMENT_SHADER;break;default:return void console.error("Unsupported ShaderType.")}const a=i.createShader(s);if(a&&(n.glShader=a,i.shaderSource(n.glShader,n.source),i.compileShader(n.glShader),!i.getShaderParameter(n.glShader,i.COMPILE_STATUS))){console.error(`${r} in '${e.name}' compilation failed.`),console.error("Shader source dump:",n.source.replace(/^|\n/g,(()=>`\n${o++} `))),console.error(i.getShaderInfoLog(n.glShader));for(let n=0;n<e.gpuStages.length;n++){const n=e.gpuStages[t];n.glShader&&(i.deleteShader(n.glShader),n.glShader=null)}return}}const n=i.createProgram();if(!n)return;e.glProgram=n;for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];i.attachShader(e.glProgram,n.glShader)}if(i.linkProgram(e.glProgram),t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}if(!i.getProgramParameter(e.glProgram,i.LINK_STATUS))return console.error(`Failed to link shader '${e.name}'.`),void console.error(i.getProgramInfoLog(e.glProgram));f(`Shader '${e.name}' compilation succeeded.`);const s=i.getProgramParameter(e.glProgram,i.ACTIVE_ATTRIBUTES);e.glInputs=new Array(s);for(let t=0;t<s;++t){const n=i.getActiveAttrib(e.glProgram,t);if(n){let s;const r=n.name.indexOf("[");s=-1!==r?n.name.substr(0,r):n.name;const o=i.getAttribLocation(e.glProgram,s),a=_B(n.type,i),l=uB(n.type,i);e.glInputs[t]={binding:o,name:s,type:a,stride:l,count:n.size,size:l*n.size,glType:n.type,glLoc:o}}}if(e.blocks.length>0){e.glBlocks=new Array(e.blocks.length);for(let t=0;t<e.blocks.length;++t){const n=e.blocks[t],s={set:n.set,binding:n.binding,name:n.name,size:0,glUniforms:new Array(n.members.length),glActiveUniforms:[]};e.glBlocks[t]=s;for(let t=0;t<n.members.length;++t){const e=n.members[t],r=cB(e.type,i),o=uB(r,i),a=o*e.count;s.glUniforms[t]={binding:-1,name:e.name,type:e.type,stride:o,count:e.count,size:a,offset:0,glType:r,glLoc:-1,array:null}}}}if(e.samplerTextures.length>0){e.glSamplerTextures=new Array(e.samplerTextures.length);for(let t=0;t<e.samplerTextures.length;++t){const n=e.samplerTextures[t];e.glSamplerTextures[t]={set:n.set,binding:n.binding,name:n.name,type:n.type,count:n.count,units:[],glUnits:null,glType:cB(n.type,i),glLoc:null}}}const r=i.getProgramParameter(e.glProgram,i.ACTIVE_UNIFORMS);for(let t=0;t<r;++t){const n=i.getActiveUniform(e.glProgram,t);if(n&&n.type!==i.SAMPLER_2D&&n.type!==i.SAMPLER_CUBE){const t=i.getUniformLocation(e.glProgram,n.name);if(null!==t&&("number"==typeof t||-1!==t.id)){let i;const s=n.name.indexOf("[");i=-1!==s?n.name.substr(0,s):n.name;for(let s=0;s<e.glBlocks.length;s++){const r=e.glBlocks[s];for(let e=0;e<r.glUniforms.length;e++){const s=r.glUniforms[e];if(s.name===i){s.glLoc=t,s.count=n.size,s.size=s.stride*s.count,s.array=new(hB(s.type))(s.size/4),r.glActiveUniforms.push(s);break}}}}}}for(let t=0;t<e.glBlocks.length;t++){const i=e.glBlocks[t];for(let t=0;t<i.glUniforms.length;t++){const e=i.glUniforms[t];e.offset=i.size/4,i.size+=e.size}}const o=[],a=[],{bindingMappingInfo:l}=t,{texUnitCacheMap:c}=t.stateCache;let h=0;for(let t=0;t<e.blocks.length;++t)e.blocks[t].set===l.flexibleSet&&h++;let _=0;for(let n=0;n<e.samplerTextures.length;++n){const s=e.samplerTextures[n],r=i.getUniformLocation(e.glProgram,s.name);if(null===r||"number"!=typeof r&&-1===r.id||(o.push(e.glSamplerTextures[n]),a.push(r)),void 0===c[s.name]){let e=s.binding+l.samplerOffsets[s.set]+_;s.set===l.flexibleSet&&(e-=h),c[s.name]=e%t.capabilities.maxTextureUnits,_+=s.count-1}}if(o.length){const n=[];for(let e=0;e<o.length;++e){const i=o[e];let s=c[i.name];if(void 0!==s){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;i.units.push(s),n[s]=!0}}}let s=0;for(let e=0;e<o.length;++e){const i=o[e];if(!i.glLoc){i.glLoc=a[e];for(let e=0;e<i.count;++e){for(;n[s];)s=(s+1)%t.capabilities.maxTextureUnits;void 0===c[i.name]&&(c[i.name]=s),i.units.push(s),n[s]=!0}}}t.stateCache.glProgram!==e.glProgram&&i.useProgram(e.glProgram);for(let t=0;t<o.length;t++){const e=o[t];e.glUnits=new Int32Array(e.units),i.uniform1iv(e.glLoc,e.glUnits)}t.stateCache.glProgram!==e.glProgram&&i.useProgram(t.stateCache.glProgram)}for(let t=0;t<e.glBlocks.length;)e.glBlocks[t].glActiveUniforms.length?t++:(e.glBlocks[t]=e.glBlocks[e.glBlocks.length-1],e.glBlocks.length--);e.glSamplerTextures=o}(this._device,this._gpuShader),!0}destroy(){this._gpuShader&&(function(t,e){if(e.glProgram){const{gl:i}=t;if(!t.destroyShadersImmediately)for(let t=0;t<e.gpuStages.length;t++){const n=e.gpuStages[t];n.glShader&&(i.detachShader(e.glProgram,n.glShader),i.deleteShader(n.glShader),n.glShader=null)}i.deleteProgram(e.glProgram),e.glProgram=null}}(this._device,this._gpuShader),this._gpuShader=null)}}class eN{constructor(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new Tr,this.scissorRect=new yr(0,0,0,0),this.rs=new kB,this.dss=new HB,this.bs=new WB,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}initialize(t,e){for(let e=0;e<t;++e)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=e,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=e,this.glCurrentAttribLocs.fill(!1)}}class iN extends Yo{constructor(...t){super(...t),this._gpuTexture=null}get gpuTexture(){return this._gpuTexture}initialize(t){return"texture"in t?(console.log("WebGL does not support texture view."),!1):(this._type=t.type,this._usage=t.usage,this._format=t.format,this._width=t.width,this._height=t.height,this._depth=t.depth,this._layerCount=t.layerCount,this._levelCount=t.levelCount,this._samples=t.samples,this._flags=t.flags,this._isPowerOf2=xo(this._width)&&xo(this._height),this._size=So(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0},function(t,e){const{gl:i}=t;e.glFormat=e.glInternalFmt=lB(e.format,i),e.glType=aB(e.format,i);let n=e.width,s=e.height;switch(e.type){case Us.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&T(9100,r,t.capabilities.maxTextureSize),!t.WEBGL_depth_texture&&fo[e.format].hasDepth){e.glInternalFmt=function(t,e){switch(t){case Os.R5G6B5:return e.RGB565;case Os.RGB5A1:return e.RGB5_A1;case Os.RGBA4:return e.RGBA4;case Os.RGBA16F:return tB.RGBA16F_EXT;case Os.RGBA32F:return tB.RGBA32F_EXT;case Os.SRGB8_A8:return tB.SRGB8_ALPHA8_EXT;case Os.D16:return e.DEPTH_COMPONENT16;case Os.D16S8:return e.DEPTH_STENCIL;case Os.D24:return e.DEPTH_COMPONENT16;case Os.D24S8:return e.DEPTH_STENCIL;case Os.D32F:return e.DEPTH_COMPONENT16;case Os.D32F_S8:return e.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),e.RGBA}}(e.format,i);const r=i.createRenderbuffer();r&&e.size>0&&(e.glRenderbuffer=r,t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s))}else{const r=i.createTexture();if(r&&e.size>0){e.glTexture=r;const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),o.glTexture=e.glTexture),fo[e.format].isCompressed)if(e.glInternalFmt!==tB.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=bo(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}else{const t=bo(e.format,2,2,1),n=new Uint8Array(t);i.compressedTexImage2D(i.TEXTURE_2D,0,e.glInternalFmt,2,2,0,n)}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1);e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}else i.deleteTexture(r)}break}case Us.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&T(9100,r,t.capabilities.maxTextureSize);const o=i.createTexture();if(o&&e.size>0){e.glTexture=o;const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),r.glTexture=e.glTexture),fo[e.format].isCompressed)if(e.glInternalFmt!==tB.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=bo(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<6;++t){const n=bo(e.format,2,2,1),s=new Uint8Array(n);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,e.glInternalFmt,2,2,0,s)}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}e.isPowerOf2?(e.glWrapS=i.REPEAT,e.glWrapT=i.REPEAT):(e.glWrapS=i.CLAMP_TO_EDGE,e.glWrapT=i.CLAMP_TO_EDGE),e.glMinFilter=i.LINEAR,e.glMagFilter=i.LINEAR,i.texParameteri(e.glTarget,i.TEXTURE_WRAP_S,e.glWrapS),i.texParameteri(e.glTarget,i.TEXTURE_WRAP_T,e.glWrapT),i.texParameteri(e.glTarget,i.TEXTURE_MIN_FILTER,e.glMinFilter),i.texParameteri(e.glTarget,i.TEXTURE_MAG_FILTER,e.glMagFilter)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=Us.TEX2D,e.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize+=this._size,!0)}destroy(){var t,e;this._gpuTexture&&(t=this._device,(e=this._gpuTexture).glTexture&&(t.gl.deleteTexture(e.glTexture),e.glTexture=null),e.glRenderbuffer&&(t.gl.deleteRenderbuffer(e.glRenderbuffer),e.glRenderbuffer=null),this._device.memoryStatus.textureSize-=this._size,this._gpuTexture=null)}resize(t,e){const i=this._size;this._width=t,this._height=e,this._size=So(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=t,this._gpuTexture.height=e,this._gpuTexture.size=this._size,function(t,e){const{gl:i}=t;let n=e.width,s=e.height;switch(e.type){case Us.TEX2D:{e.glTarget=i.TEXTURE_2D;const r=Math.max(n,s);if(r>t.capabilities.maxTextureSize&&T(9100,r,t.capabilities.maxTextureSize),e.glRenderbuffer)t.stateCache.glRenderbuffer!==e.glRenderbuffer&&(i.bindRenderbuffer(i.RENDERBUFFER,e.glRenderbuffer),t.stateCache.glRenderbuffer=e.glRenderbuffer),i.renderbufferStorage(i.RENDERBUFFER,e.glInternalFmt,n,s);else if(e.glTexture){const r=t.stateCache.glTexUnits[t.stateCache.texUnit];if(r.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_2D,e.glTexture),r.glTexture=e.glTexture),fo[e.format].isCompressed){if(e.glInternalFmt!==tB.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<e.mipLevel;++t){const r=bo(e.format,n,s,1),o=new Uint8Array(r);i.compressedTexImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,o),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}else for(let t=0;t<e.mipLevel;++t)i.texImage2D(i.TEXTURE_2D,t,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}case Us.CUBE:{e.glTarget=i.TEXTURE_CUBE_MAP;const r=Math.max(n,s);r>t.capabilities.maxCubeMapTextureSize&&T(9100,r,t.capabilities.maxTextureSize);const o=t.stateCache.glTexUnits[t.stateCache.texUnit];if(o.glTexture!==e.glTexture&&(i.bindTexture(i.TEXTURE_CUBE_MAP,e.glTexture),o.glTexture=e.glTexture),fo[e.format].isCompressed){if(e.glInternalFmt!==tB.COMPRESSED_RGB_ETC1_WEBGL)for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r){const o=bo(e.format,n,s,1),a=new Uint8Array(o);i.compressedTexImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,a),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}}}else for(let t=0;t<6;++t){n=e.width,s=e.height;for(let r=0;r<e.mipLevel;++r)i.texImage2D(i.TEXTURE_CUBE_MAP_POSITIVE_X+t,r,e.glInternalFmt,n,s,0,e.glFormat,e.glType,null),n=Math.max(1,n>>1),s=Math.max(1,s>>1)}break}default:console.error("Unsupported TextureType, create texture failed."),e.type=Us.TEX2D,e.glTarget=i.TEXTURE_2D}}(this._device,this._gpuTexture),this._device.memoryStatus.textureSize-=i,this._device.memoryStatus.textureSize+=this._size)}}const nN="webglcontextlost";class sN extends Lo{constructor(...t){super(...t),this.stateCache=new eN,this.cmdAllocator=new LB,this.nullTex2D=null,this.nullTexCube=null,this._webGLRC=null,this._isAntialias=!0,this._isPremultipliedAlpha=!0,this._useVAO=!1,this._destroyShadersImmediately=!0,this._noCompressedTexSubImage2D=!1,this._bindingMappingInfo=new Er,this._webGLContextLostHandler=null,this._extensions=null,this._EXT_texture_filter_anisotropic=null,this._EXT_blend_minmax=null,this._EXT_frag_depth=null,this._EXT_shader_texture_lod=null,this._EXT_sRGB=null,this._OES_vertex_array_object=null,this._EXT_color_buffer_half_float=null,this._WEBGL_color_buffer_float=null,this._WEBGL_compressed_texture_etc1=null,this._WEBGL_compressed_texture_etc=null,this._WEBGL_compressed_texture_pvrtc=null,this._WEBGL_compressed_texture_astc=null,this._WEBGL_compressed_texture_s3tc=null,this._WEBGL_compressed_texture_s3tc_srgb=null,this._WEBGL_debug_shaders=null,this._WEBGL_draw_buffers=null,this._WEBGL_lose_context=null,this._WEBGL_depth_texture=null,this._WEBGL_debug_renderer_info=null,this._OES_texture_half_float=null,this._OES_texture_half_float_linear=null,this._OES_texture_float=null,this._OES_texture_float_linear=null,this._OES_standard_derivatives=null,this._OES_element_index_uint=null,this._ANGLE_instanced_arrays=null}get gl(){return this._webGLRC}get webGLQueue(){return this._queue}get isAntialias(){return this._isAntialias}get isPremultipliedAlpha(){return this._isPremultipliedAlpha}get useVAO(){return this._useVAO}get destroyShadersImmediately(){return this._destroyShadersImmediately}get noCompressedTexSubImage2D(){return this._noCompressedTexSubImage2D}get bindingMappingInfo(){return this._bindingMappingInfo}get EXT_texture_filter_anisotropic(){return this._EXT_texture_filter_anisotropic}get EXT_blend_minmax(){return this._EXT_blend_minmax}get EXT_frag_depth(){return this._EXT_frag_depth}get EXT_shader_texture_lod(){return this._EXT_shader_texture_lod}get EXT_sRGB(){return this._EXT_sRGB}get OES_vertex_array_object(){return this._OES_vertex_array_object}get WEBGL_color_buffer_float(){return this._WEBGL_color_buffer_float}get WEBGL_compressed_texture_etc1(){return this._WEBGL_compressed_texture_etc1}get WEBGL_compressed_texture_pvrtc(){return this._WEBGL_compressed_texture_pvrtc}get WEBGL_compressed_texture_astc(){return this._WEBGL_compressed_texture_astc}get WEBGL_compressed_texture_s3tc(){return this._WEBGL_compressed_texture_s3tc}get WEBGL_compressed_texture_s3tc_srgb(){return this._WEBGL_compressed_texture_s3tc_srgb}get WEBGL_debug_shaders(){return this._WEBGL_debug_shaders}get WEBGL_draw_buffers(){return this._WEBGL_draw_buffers}get WEBGL_lose_context(){return this._WEBGL_lose_context}get WEBGL_depth_texture(){return this._WEBGL_depth_texture}get WEBGL_debug_renderer_info(){return this._WEBGL_debug_renderer_info}get OES_texture_half_float(){return this._OES_texture_half_float}get OES_texture_half_float_linear(){return this._OES_texture_half_float_linear}get OES_texture_float(){return this._OES_texture_float}get OES_standard_derivatives(){return this._OES_standard_derivatives}get OES_element_index_uint(){return this._OES_element_index_uint}get ANGLE_instanced_arrays(){return this._ANGLE_instanced_arrays}initialize(t){this._canvas=t.canvasElm,this._isAntialias=t.isAntialias,this._isPremultipliedAlpha=t.isPremultipliedAlpha,this._bindingMappingInfo=t.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);try{const t={alpha:Ut.ENABLE_TRANSPARENT_CANVAS,antialias:this._isAntialias,depth:!0,stencil:!0,premultipliedAlpha:this._isPremultipliedAlpha,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};this._webGLRC=this._canvas.getContext("webgl",t)}catch(t){return console.error(t),!1}if(!this._webGLRC)return console.error("This device does not support WebGL."),!1;this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(nN,this._onWebGLContextLost),this._canvas2D=document.createElement("canvas"),console.info("WebGL device initialized."),this._gfxAPI=Is.WEBGL,this._deviceName="WebGL";const e=this._webGLRC;this._WEBGL_debug_renderer_info=this.getExtension("WEBGL_debug_renderer_info"),this._WEBGL_debug_renderer_info?(this._renderer=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=e.getParameter(this._WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=e.getParameter(e.RENDERER),this._vendor=e.getParameter(e.VENDOR)),this._version=e.getParameter(e.VERSION),this._caps.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.depthBits=e.getParameter(e.DEPTH_BITS),this._caps.stencilBits=e.getParameter(e.STENCIL_BITS),this.stateCache.initialize(this._caps.maxTextureUnits,this._caps.maxVertexAttributes),this._devicePixelRatio=t.devicePixelRatio||1,this._width=t.width,this._height=t.height,this._colorFmt=Os.RGBA8,24===this._caps.depthBits?8===this._caps.stencilBits?this._depthStencilFmt=Os.D24S8:this._depthStencilFmt=Os.D24:8===this._caps.stencilBits?this._depthStencilFmt=Os.D16S8:this._depthStencilFmt=Os.D16,this._extensions=e.getSupportedExtensions();let i="";if(this._extensions){for(const t of this._extensions)i+=`${t} `;f(`EXTENSIONS: ${i}`)}this._EXT_texture_filter_anisotropic=this.getExtension("EXT_texture_filter_anisotropic"),this._EXT_blend_minmax=this.getExtension("EXT_blend_minmax"),this._EXT_frag_depth=this.getExtension("EXT_frag_depth"),this._EXT_shader_texture_lod=this.getExtension("EXT_shader_texture_lod"),this._EXT_sRGB=this.getExtension("EXT_sRGB"),this._OES_vertex_array_object=this.getExtension("OES_vertex_array_object"),this._EXT_color_buffer_half_float=this.getExtension("EXT_color_buffer_half_float"),this._WEBGL_color_buffer_float=this.getExtension("WEBGL_color_buffer_float"),this._WEBGL_compressed_texture_etc1=this.getExtension("WEBGL_compressed_texture_etc1"),this._WEBGL_compressed_texture_etc=this.getExtension("WEBGL_compressed_texture_etc"),this._WEBGL_compressed_texture_pvrtc=this.getExtension("WEBGL_compressed_texture_pvrtc"),this._WEBGL_compressed_texture_s3tc=this.getExtension("WEBGL_compressed_texture_s3tc"),this._WEBGL_compressed_texture_s3tc_srgb=this.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this._WEBGL_debug_shaders=this.getExtension("WEBGL_debug_shaders"),this._WEBGL_draw_buffers=this.getExtension("WEBGL_draw_buffers"),this._WEBGL_lose_context=this.getExtension("WEBGL_lose_context"),this._WEBGL_depth_texture=this.getExtension("WEBGL_depth_texture"),this._OES_texture_half_float=this.getExtension("OES_texture_half_float"),this._OES_texture_half_float_linear=this.getExtension("OES_texture_half_float_linear"),this._OES_texture_float=this.getExtension("OES_texture_float"),this._OES_texture_float_linear=this.getExtension("OES_texture_float_linear"),this._OES_standard_derivatives=this.getExtension("OES_standard_derivatives"),this._OES_element_index_uint=this.getExtension("OES_element_index_uint"),this._ANGLE_instanced_arrays=this.getExtension("ANGLE_instanced_arrays"),yn.os===L.IOS&&14===yn.osMainVersion&&yn.isBrowser||(this._WEBGL_compressed_texture_astc=this.getExtension("WEBGL_compressed_texture_astc")),yn.browserType===O.UC&&(this._ANGLE_instanced_arrays=null),yn.os===L.IOS&&yn.osMainVersion<=10&&(this._destroyShadersImmediately=!1),this._features.fill(!1),this._EXT_sRGB&&(this._features[Ms.FORMAT_SRGB]=!0),this._EXT_blend_minmax&&(this._features[Ms.BLEND_MINMAX]=!0),this._WEBGL_color_buffer_float&&(this._features[Ms.COLOR_FLOAT]=!0),this._EXT_color_buffer_half_float&&(this._features[Ms.COLOR_HALF_FLOAT]=!0),this._OES_texture_float&&(this._features[Ms.TEXTURE_FLOAT]=!0),this._OES_texture_half_float&&(this._features[Ms.TEXTURE_HALF_FLOAT]=!0),this._OES_texture_float_linear&&(this._features[Ms.TEXTURE_FLOAT_LINEAR]=!0),this._OES_texture_half_float_linear&&(this._features[Ms.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[Ms.FORMAT_RGB8]=!0,this._OES_element_index_uint&&(this._features[Ms.ELEMENT_INDEX_UINT]=!0),this._ANGLE_instanced_arrays&&(this._features[Ms.INSTANCED_ARRAYS]=!0),this._WEBGL_draw_buffers&&(this._features[Ms.MULTIPLE_RENDER_TARGETS]=!0);let n="";this._WEBGL_compressed_texture_etc1&&(this._features[Ms.FORMAT_ETC1]=!0,n+="etc1 "),this._WEBGL_compressed_texture_etc&&(this._features[Ms.FORMAT_ETC2]=!0,n+="etc2 "),this._WEBGL_compressed_texture_s3tc&&(this._features[Ms.FORMAT_DXT]=!0,n+="dxt "),this._WEBGL_compressed_texture_pvrtc&&(this._features[Ms.FORMAT_PVRTC]=!0,n+="pvrtc "),this._WEBGL_compressed_texture_astc&&(this._features[Ms.FORMAT_ASTC]=!0,n+="astc "),this._OES_vertex_array_object&&(this._useVAO=!0),f(`RENDERER: ${this._renderer}`),f(`VENDOR: ${this._vendor}`),f(`VERSION: ${this._version}`),f(`DPR: ${this._devicePixelRatio}`),f(`SCREEN_SIZE: ${this._width} x ${this._height}`),f(`MAX_VERTEX_UNIFORM_VECTORS: ${this._caps.maxVertexUniformVectors}`),f(`DEPTH_BITS: ${this._caps.depthBits}`),f(`STENCIL_BITS: ${this._caps.stencilBits}`),this._EXT_texture_filter_anisotropic&&f(`MAX_TEXTURE_MAX_ANISOTROPY_EXT: ${this._EXT_texture_filter_anisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT}`),f(`USE_VAO: ${this._useVAO}`),f(`COMPRESSED_FORMAT: ${n}`),this.initStates(e),this._queue=this.createQueue(new lo(_r.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new ao(this._queue)),this.nullTex2D=this.createTexture(new Or(Us.TEX2D,Gs.SAMPLED,Os.RGBA8,2,2,ks.GEN_MIPMAP)),this.nullTexCube=this.createTexture(new Or(Us.CUBE,Gs.SAMPLED,Os.RGBA8,2,2,ks.GEN_MIPMAP,6));const s=new Cr;s.texExtent.width=2,s.texExtent.height=2;const r=new Uint8Array(this.nullTex2D.size);return r.fill(0),this.copyBuffersToTexture([r],this.nullTex2D,[s]),s.texSubres.layerCount=6,this.copyBuffersToTexture([r,r,r,r,r,r],this.nullTexCube,[s]),!0}destroy(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(nN,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null),this._extensions=null,this._webGLRC=null}resize(t,e){this._width===t&&this._height===e||(f(`Resizing device: ${t}x${e}`),this._canvas.width=t,this._canvas.height=e,this._width=t,this._height=e)}flushCommands(t){}acquire(){this.cmdAllocator.releaseCmds()}present(){const t=this._queue;this._numDrawCalls=t.numDrawCalls,this._numInstances=t.numInstances,this._numTris=t.numTris,t.clear()}createCommandBuffer(t){const e=new(t.type===ur.PRIMARY?KB:FB)(this);return e.initialize(t)?e:null}createBuffer(t){const e=new BB(this);return e.initialize(t)?e:null}createTexture(t){const e=new iN(this);return e.initialize(t)?e:null}createSampler(t){const e=new QB(this);return e.initialize(t)?e:null}createDescriptorSet(t){const e=new oB(this);return e.initialize(t)?e:null}createShader(t){const e=new tN(this);return e.initialize(t)?e:null}createInputAssembler(t){const e=new VB(this);return e.initialize(t)?e:null}createRenderPass(t){const e=new JB(this);return e.initialize(t)?e:null}createFramebuffer(t){const e=new zB(this);return e.initialize(t)?e:null}createDescriptorSetLayout(t){const e=new UB(this);return e.initialize(t)?e:null}createPipelineLayout(t){const e=new GB(this);return e.initialize(t)?e:null}createPipelineState(t){const e=new YB(this);return e.initialize(t)?e:null}createQueue(t){const e=new $B(this);return e.initialize(t)?e:null}createGlobalBarrier(t){const e=new Ko(this);return e.initialize(t)?e:null}createTextureBarrier(t){const e=new $o(this);return e.initialize(t)?e:null}copyBuffersToTexture(t,e,i){OB(this,t,e.gpuTexture,i)}copyTextureToBuffers(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache,o=s.createFramebuffer();s.bindFramebuffer(s.FRAMEBUFFER,o);let a=0,l=0,c=1,h=1;switch(e.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,e.glTarget,e.glTexture,r.texSubres.mipLevel),a=r.texOffset.x,l=r.texOffset.y,c=r.texExtent.width,h=r.texExtent.height,s.readPixels(a,l,c,h,e.glFormat,e.glType,i[t])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}s.bindFramebuffer(s.FRAMEBUFFER,null),r.glFramebuffer=null,s.deleteFramebuffer(o)}(this,t.gpuTexture,e,i)}copyTexImagesToTexture(t,e,i){!function(t,e,i,n){const{gl:s}=t,r=t.stateCache.glTexUnits[t.stateCache.texUnit];r.glTexture!==i.glTexture&&(s.bindTexture(i.glTarget,i.glTexture),r.glTexture=i.glTexture);let o=0,a=0;switch(i.glTarget){case s.TEXTURE_2D:for(let t=0;t<n.length;t++){const r=n[t];s.texSubImage2D(s.TEXTURE_2D,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;case s.TEXTURE_CUBE_MAP:for(let t=0;t<n.length;t++){const r=n[t],l=r.texSubres.baseArrayLayer+r.texSubres.layerCount;for(a=r.texSubres.baseArrayLayer;a<l;++a)s.texSubImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+a,r.texSubres.mipLevel,r.texOffset.x,r.texOffset.y,i.glFormat,i.glType,e[o++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}i.flags&ks.GEN_MIPMAP&&i.isPowerOf2&&s.generateMipmap(i.glTarget)}(this,t,e.gpuTexture,i)}copyFramebufferToBuffer(t,e,i){const n=this._webGLRC,s=t.gpuFramebuffer,r=s.gpuColorTextures[0].format,o=lB(r,n),a=aB(r,n),l=To(fo[r]),c=this.stateCache.glFramebuffer;this.stateCache.glFramebuffer!==s.glFramebuffer&&(n.bindFramebuffer(n.FRAMEBUFFER,s.glFramebuffer),this.stateCache.glFramebuffer=s.glFramebuffer);const h=new l(e);for(const t of i){const e=t.texExtent.width,i=t.texExtent.height;n.readPixels(t.texOffset.x,t.texOffset.y,e,i,o,a,h)}this.stateCache.glFramebuffer!==c&&(n.bindFramebuffer(n.FRAMEBUFFER,c),this.stateCache.glFramebuffer=c)}blitFramebuffer(t,e,i,n,s){}getExtension(t){const e=["","WEBKIT_","MOZ_"];for(let i=0;i<e.length;++i){const n=this.gl.getExtension(e[i]+t);if(n)return n}return null}initStates(t){t.activeTexture(t.TEXTURE0),t.pixelStorei(t.PACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_ALIGNMENT,1),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),t.bindFramebuffer(t.FRAMEBUFFER,null),t.enable(t.SCISSOR_TEST),t.enable(t.CULL_FACE),t.cullFace(t.BACK),t.frontFace(t.CCW),t.disable(t.POLYGON_OFFSET_FILL),t.polygonOffset(0,0),t.enable(t.DEPTH_TEST),t.depthMask(!0),t.depthFunc(t.LESS),t.depthRange(0,1),t.stencilFuncSeparate(t.FRONT,t.ALWAYS,1,65535),t.stencilOpSeparate(t.FRONT,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.FRONT,65535),t.stencilFuncSeparate(t.BACK,t.ALWAYS,1,65535),t.stencilOpSeparate(t.BACK,t.KEEP,t.KEEP,t.KEEP),t.stencilMaskSeparate(t.BACK,65535),t.disable(t.STENCIL_TEST),t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.BLEND),t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ZERO,t.ONE,t.ZERO),t.colorMask(!0,!0,!0,!0),t.blendColor(0,0,0,0)}_onWebGLContextLost(t){A(11e3),m(t)}}t("WebGLDevice",sN),n.WebGLDevice=sN;const rN=new Ni,oN=new $i;function aN(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2;const a=i.vertexCount;let l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,o=0,l=0,c=0);const h=r.vData,_=r.iData;t.getWorldMatrix(oN);for(let t=0;t<a;t++){const e=s[t];Ni.set(rN,e.x,e.y,0),Ni.transformMat4(rN,rN,oN),h[o++]=rN.x,h[o++]=rN.y,h[o++]=rN.z,h[o++]=e.u,h[o++]=e.v,Ri.toArray(h,n,o),o+=4}for(let t=0,e=a/4;t<e;t++){const e=c+4*t;_[l++]=e,_[l++]=e+1,_[l++]=e+2,_[l++]=e+1,_[l++]=e+3,_[l++]=e+2}}class lN{constructor(t,e){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;const i=new cN;i.initWithSize(t,e),this._texture=i,this._width=t,this._height=e,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}insertSpriteFrame(t){const e=t.rect,i=t.texture,s=this._innerTextureInfos[i.getId()];let r=e.x,o=e.y;if(s)r+=s.x,o+=s.y;else{const t=i.width,e=i.height;if(this._x+t+2>this._width&&(this._x=2,this._y=this._nexty),this._y+e+2>this._nexty&&(this._nexty=this._y+e+2),this._nexty>this._height)return null;n.internal.dynamicAtlasManager.textureBleeding&&((t<=8||e<=8)&&(this._texture.drawTextureAt(i.image,this._x-1,this._y-1),this._texture.drawTextureAt(i.image,this._x-1,this._y+1),this._texture.drawTextureAt(i.image,this._x+1,this._y-1),this._texture.drawTextureAt(i.image,this._x+1,this._y+1)),this._texture.drawTextureAt(i.image,this._x-1,this._y),this._texture.drawTextureAt(i.image,this._x+1,this._y),this._texture.drawTextureAt(i.image,this._x,this._y-1),this._texture.drawTextureAt(i.image,this._x,this._y+1)),this._texture.drawTextureAt(i.image,this._x,this._y),this._innerTextureInfos[i.getId()]={x:this._x,y:this._y,texture:i},this._count++,r+=this._x,o+=this._y,this._x+=t+2}const a={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(t),a}deleteInnerTexture(t){t&&this._innerTextureInfos[t.getId()]&&(delete this._innerTextureInfos[t.getId()],this._count--)}isEmpty(){return this._count<=0}reset(){this._x=2,this._y=2,this._nexty=2;const t=this._innerSpriteFrames;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}}destroy(){this.reset(),this._texture.destroy()}}class cN extends Af{initWithSize(t,e,i=Rd.RGBA8888){this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Cr;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class hN{constructor(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}get enabled(){return this._enabled}set enabled(t){this._enabled!==t&&(t?(this.reset(),n.director.on(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),n.director.off(n.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=t)}get maxAtlasCount(){return this._maxAtlasCount}set maxAtlasCount(t){this._maxAtlasCount=t}get atlasCount(){return this._atlases.length}get textureBleeding(){return this._textureBleeding}set textureBleeding(t){this._textureBleeding=t}get textureSize(){return this._textureSize}set textureSize(t){this._textureSize=t}get maxFrameSize(){return this._maxFrameSize}set maxFrameSize(t){this._maxFrameSize=t}newAtlas(){let t=this._atlases[++this._atlasIndex];return t||(t=new lN(this._textureSize,this._textureSize),this._atlases.push(t)),t}beforeSceneLoad(){this.reset()}insertSpriteFrame(t){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!t||t._original)return null;if(!t.packable)return null;let e=this._atlases[this._atlasIndex];e||(e=this.newAtlas());const i=e.insertSpriteFrame(t);return i||this._atlasIndex===this._maxAtlasCount?i:(e=this.newAtlas(),e.insertSpriteFrame(t))}reset(){for(let t=0,e=this._atlases.length;t<e;t++)this._atlases[t].destroy();this._atlases.length=0,this._atlasIndex=-1}deleteAtlasSpriteFrame(t){if(!t._original)return;const e=t._original._texture;this.deleteAtlasTexture(e)}deleteAtlasTexture(t){if(t)for(let e=this._atlases.length-1;e>=0;e--)this._atlases[e].deleteInnerTexture(t),this._atlases[e].isEmpty()&&(this._atlases[e].destroy(),this._atlases.splice(e,1),this._atlasIndex--)}packToDynamicAtlas(t,e){if(!e._original&&e.packable){const t=this.insertSpriteFrame(e);t&&e._setDynamicAtlasFrame(t)}}}hN.instance=void 0;const _N=t("dynamicAtlasManager",hN.instance=new hN);var uN;n.internal.dynamicAtlasManager=_N;const mN=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}];let pN=t("SpriteFrame",Vl("cc.SpriteFrame")(uN=class t extends _h{static createWithImage(e){const i=e instanceof Gd?e:new Gd(e),n=new Af;n.image=i;const s=new t;return s.texture=n,s}get insetTop(){return this._capInsets[1]}set insetTop(t){this._capInsets[1]!==t&&(this._capInsets[1]=t,this._texture&&this._calculateSlicedUV())}get insetBottom(){return this._capInsets[3]}set insetBottom(t){this._capInsets[3]!==t&&(this._capInsets[3]=t,this._texture&&this._calculateSlicedUV())}get insetLeft(){return this._capInsets[0]}set insetLeft(t){this._capInsets[0]!==t&&(this._capInsets[0]=t,this._texture&&this._calculateSlicedUV())}get insetRight(){return this._capInsets[2]}set insetRight(t){this._capInsets[2]!==t&&(this._capInsets[2]=t,this._texture&&this._calculateSlicedUV())}get rect(){return this._rect}set rect(t){this._rect.equals(t)||(this._rect.set(t),this._texture&&this._calculateUV())}get originalSize(){return this._originalSize}set originalSize(t){this._originalSize.equals(t)||(this._originalSize.set(t),this._texture&&this._calculateUV())}get offset(){return this._offset}set offset(t){this._offset.set(t)}get rotated(){return this._rotated}set rotated(t){this._rotated!==t&&(this._rotated=t,this._texture&&this._calculateUV())}get texture(){return this._texture}set texture(t){t?this.reset({texture:t},!0):console.warn(`Error Texture in ${this.name}`)}get atlasUuid(){return this._atlasUuid}set atlasUuid(t){this._atlasUuid=t}get width(){return this._texture.width}get height(){return this._texture.height}set _textureSource(t){window.Build?this._texture=t:t&&(this._refreshTexture(t),this._calculateUV())}get flipUVX(){return this._isFlipUVX}set flipUVX(t){this._isFlipUVX=t,this._calculateUV()}get flipUVY(){return this._isFlipUVY}set flipUVY(t){this._isFlipUVY=t,this._calculateUV()}get packable(){return this._packable}set packable(t){this._packable=t}get original(){return this._original}constructor(){super(),this.vertices=null,this.uv=[],this.uvHash=0,this.unbiasUV=[],this.uvSliced=[],this._rect=new hn,this._offset=new tn,this._originalSize=new ln,this._rotated=!1,this._capInsets=[0,0,0,0],this._atlasUuid="",this._texture=void 0,this._isFlipUVY=!1,this._isFlipUVX=!1,this._original=null,this._packable=!0}textureLoaded(){return!!this.texture}isRotated(){return this._rotated}setRotated(t){this.rotated=t}getRect(t){return t?(t.set(this._rect),t):this._rect.clone()}setRect(t){this.rect=t}getOriginalSize(t){return t?(t.set(this._originalSize),t):this._originalSize.clone()}setOriginalSize(t){this.originalSize=t}getOffset(t){return t?(t.set(this._offset),t):this._offset.clone()}setOffset(t){this.offset=t}getGFXTexture(){return this._texture.getGFXTexture()}getGFXSampler(){return this._texture.getGFXSampler()}getHash(){return this._texture.getHash()}getSamplerHash(){return this._texture.getSamplerHash()}reset(t,e=!1){let i=!1;e&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,i=!0),t&&(t.texture&&(this._rect.x=this._rect.y=0,this._rect.width=t.texture.width,this._rect.height=t.texture.height,this._refreshTexture(t.texture),this.checkRect(this._texture)),t.originalSize&&this._originalSize.set(t.originalSize),t.rect&&this._rect.set(t.rect),t.offset&&this._offset.set(t.offset),void 0!==t.borderTop&&(this._capInsets[1]=t.borderTop),void 0!==t.borderBottom&&(this._capInsets[3]=t.borderBottom),void 0!==t.borderLeft&&(this._capInsets[0]=t.borderLeft),void 0!==t.borderRight&&(this._capInsets[2]=t.borderRight),void 0!==t.isRotate&&(this._rotated=!!t.isRotate),void 0!==t.isFlipUv&&(this._isFlipUVY=!!t.isFlipUv),i=!0),i&&this.texture&&this._calculateUV()}checkRect(t){const e=this._rect;let i=e.x,n=e.y;return this._rotated?(i+=e.height,n+=e.width):(i+=e.width,n+=e.height),i>t.width?(T(3300,`${this.name}/${t.name}`,i,t.width),!1):!(n>t.height&&(T(3301,`${this.name}/${t.name}`,n,t.height),1))}destroy(){return this._packable&&_N&&_N.deleteAtlasSpriteFrame(this),super.destroy()}_calculateSlicedUV(){const t=this._rect,e=this.texture,i=e.width,n=e.height,s=this._capInsets[0],r=this._capInsets[2],o=t.width-s-r,a=this._capInsets[1],l=this._capInsets[3],c=t.height-a-l,h=this.uvSliced;if(h.length=0,this._rotated){mN[0].u=t.x/i,mN[1].u=(t.x+l)/i,mN[2].u=(t.x+l+c)/i,mN[3].u=(t.x+t.height)/i,mN[3].v=t.y/n,mN[2].v=(t.y+s)/n,mN[1].v=(t.y+s+o)/n,mN[0].v=(t.y+t.width)/n;for(let t=0;t<4;++t){const e=mN[t];for(let t=0;t<4;++t){const i=mN[3-t];h.push({u:e.u,v:i.v})}}}else{mN[0].u=t.x/i,mN[1].u=(t.x+s)/i,mN[2].u=(t.x+s+o)/i,mN[3].u=(t.x+t.width)/i,mN[3].v=t.y/n,mN[2].v=(t.y+a)/n,mN[1].v=(t.y+a+c)/n,mN[0].v=(t.y+t.height)/n;for(let t=0;t<4;++t){const e=mN[t];for(let t=0;t<4;++t){const i=mN[t];h.push({u:i.u,v:e.v})}}}}_calculateUV(){const t=this._rect,e=this.uv,i=this.unbiasUV,n=this.texture,s=n.width,r=n.height;if(this._rotated){const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.height)/s,a=0===r?0:t.y/r,l=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=l,e[2]=o,e[3]=a,e[4]=n,e[5]=l,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=o,e[3]=l,e[4]=n,e[5]=a,e[6]=n,e[7]=l):this._isFlipUVY?(e[0]=n,e[1]=l,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=n,e[3]=l,e[4]=o,e[5]=a,e[6]=o,e[7]=l);const c=0===s?0:t.x/s,h=0===s?1:(t.x+t.height)/s,_=0===r?0:t.y/r,u=0===r?1:(t.y+t.width)/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=h,i[3]=_,i[4]=c,i[5]=u,i[6]=c,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=h,i[3]=u,i[4]=c,i[5]=_,i[6]=c,i[7]=u):this._isFlipUVY?(i[0]=c,i[1]=u,i[2]=c,i[3]=_,i[4]=h,i[5]=u,i[6]=h,i[7]=_):(i[0]=c,i[1]=_,i[2]=c,i[3]=u,i[4]=h,i[5]=_,i[6]=h,i[7]=u)}else{const n=0===s?0:t.x/s,o=0===s?1:(t.x+t.width)/s,a=0===r?1:(t.y+t.height)/r,l=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(e[0]=o,e[1]=l,e[2]=n,e[3]=l,e[4]=o,e[5]=a,e[6]=n,e[7]=a):this._isFlipUVX?(e[0]=o,e[1]=a,e[2]=n,e[3]=a,e[4]=o,e[5]=l,e[6]=n,e[7]=l):this._isFlipUVY?(e[0]=n,e[1]=l,e[2]=o,e[3]=l,e[4]=n,e[5]=a,e[6]=o,e[7]=a):(e[0]=n,e[1]=a,e[2]=o,e[3]=a,e[4]=n,e[5]=l,e[6]=o,e[7]=l);const c=0===s?0:t.x/s,h=0===s?1:(t.x+t.width)/s,_=0===r?1:(t.y+t.height)/r,u=0===r?0:t.y/r;this._isFlipUVX&&this._isFlipUVY?(i[0]=h,i[1]=u,i[2]=c,i[3]=u,i[4]=h,i[5]=_,i[6]=c,i[7]=_):this._isFlipUVX?(i[0]=h,i[1]=_,i[2]=c,i[3]=_,i[4]=h,i[5]=u,i[6]=c,i[7]=u):this._isFlipUVY?(i[0]=c,i[1]=u,i[2]=h,i[3]=u,i[4]=c,i[5]=_,i[6]=h,i[7]=_):(i[0]=c,i[1]=_,i[2]=h,i[3]=_,i[4]=c,i[5]=u,i[6]=h,i[7]=u)}let o="";for(let t=0;t<e.length;t++)o+=e[t];this.uvHash=Uo(o,666);const a=this.vertices;if(a){a.nu.length=0,a.nv.length=0;for(let t=0;t<a.u.length;t++)a.nu[t]=a.u[t]/s,a.nv[t]=a.v[t]/r}this._calculateSlicedUV()}_setDynamicAtlasFrame(t){t&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=t.texture,this._rect.x=t.x,this._rect.y=t.y,this._calculateUV())}_resetDynamicAtlasFrame(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())}_checkPackable(){const t=_N;if(!t)return;const e=this._texture;if(!(e instanceof Af)||e.isCompressed)return void(this._packable=!1);const i=this.width,n=this.height;!e.image||i>t.maxFrameSize||n>t.maxFrameSize?this._packable=!1:e.image&&e.image instanceof HTMLCanvasElement&&(this._packable=!0)}_serialize(t){return null}_deserialize(t,e){const i=t,n=i.rect;n&&(this._rect=new hn(n.x,n.y,n.width,n.height));const s=i.offset;i.offset&&(this._offset=new tn(s.x,s.y));const r=i.originalSize;i.originalSize&&(this._originalSize=new ln(r.width,r.height)),this._rotated=!!i.rotated,this._name=i.name,this._packable=!!i.packable;const o=i.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=i.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])}clone(){var e,i,n,s;const r=new t,o=this.vertices;return r.vertices=o?{x:o.x,y:o.y,triangles:o.triangles,nu:null===(e=o.nu)||void 0===e?void 0:e.slice(0),u:null===(i=o.u)||void 0===i?void 0:i.slice(0),nv:null===(n=o.nv)||void 0===n?void 0:n.slice(0),v:null===(s=o.v)||void 0===s?void 0:s.slice(0)}:null,r.uv.splice(0,r.uv.length,...this.uv),r.uvHash=this.uvHash,r.unbiasUV.splice(0,r.unbiasUV.length,...this.unbiasUV),r.uvSliced.splice(0,r.uvSliced.length,...this.uvSliced),r._rect.set(this._rect),r._offset.set(this._offset),r._originalSize.set(this._originalSize),r._rotated=this._rotated,r._capInsets.splice(0,r._capInsets.length,...this._capInsets),r._atlasUuid=this._atlasUuid,r._texture=this._texture,r._isFlipUVX=this._isFlipUVX,r._isFlipUVY=this._isFlipUVY,r}_refreshTexture(t){this._texture=t;const e=this._texture,i={};let n=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(e)||(i.rect=new hn(0,0,e.width,e.height),n=!0),(0===this._originalSize.width||0===this._originalSize.height||n)&&(i.originalSize=new ln(e.width,e.height),n=!0),n&&(this.reset(i),this.onLoaded()),this._checkPackable()}initDefault(t){super.initDefault(t);const e=new Af;e.initDefault(),this._refreshTexture(e),this._calculateUV()}validate(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height}})||uN);var dN,fN,gN;n.SpriteFrame=pN;let yN=t("SpriteAtlas",Vl("cc.SpriteAtlas")((gN=wl((fN=class extends _h{constructor(...t){super(...t),Tl(this,"spriteFrames",gN,this)}getTexture(){const t=Object.keys(this.spriteFrames);if(t.length>0){const e=this.spriteFrames[t[0]];return e&&e.texture}return null}getSpriteFrame(t){const e=this.spriteFrames[t];return e?(e.name||(e.name=t),e):null}getSpriteFrames(){const t=[],e=this.spriteFrames;for(const i of Object.keys(e))t.push(e[i]);return t}_serialize(t){}_deserialize(t,e){const i=t;this._name=i.name;const n=i.spriteFrames;this.spriteFrames=st();for(let t=0;t<n.length;t+=2)e.result.push(this.spriteFrames,n[t],n[t+1],It(pN))}}).prototype,"spriteFrames",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return st()}}),dN=fN))||dN);var vN;n.SpriteAtlas=yN;let xN=t("Font",Vl("cc.Font")(vN=class extends _h{})||vN);var bN,SN,AN;n.Font=xN;let CN=t("TTFFont",Vl("cc.TTFFont")((AN=wl((SN=class extends xN{constructor(...t){super(...t),Tl(this,"_fontFamily",AN,this)}get _nativeAsset(){return this._fontFamily}set _nativeAsset(t){this._fontFamily=t||"Arial"}get _nativeDep(){return{uuid:this._uuid,__nativeName__:this._native,ext:An(this._native),__isNative__:!0}}initDefault(t){this._fontFamily="Arial",super.initDefault(t)}}).prototype,"_fontFamily",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wl(SN.prototype,"_nativeAsset",[vc,gc],Object.getOwnPropertyDescriptor(SN.prototype,"_nativeAsset"),SN.prototype),wl(SN.prototype,"_nativeDep",[vc],Object.getOwnPropertyDescriptor(SN.prototype,"_nativeDep"),SN.prototype),bN=SN))||bN);var TN,wN,EN,PN,DN,IN,RN,MN;n.TTFFont=CN;class ON{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0}}class BN{constructor(t){this.letterDefinitions={},this.texture=t}addLetterDefinitions(t,e){this.letterDefinitions[t]=e}cloneLetterDefinition(){const t={};for(const e of Object.keys(this.letterDefinitions)){const i=new ON;dt(i,this.letterDefinitions[e]),t[e]=i}return t}getTexture(){return this.texture}getLetter(t){return this.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0);let n;return n=this.letterDefinitions.hasOwnProperty(i)?this.letterDefinitions[i]:null,n}clear(){this.letterDefinitions={}}}let NN=t("BitmapFont",(TN=Vl("cc.BitmapFont"),wN=yc(pN),TN((DN=wl((PN=class extends xN{constructor(...t){super(...t),Tl(this,"fntDataStr",DN,this),Tl(this,"spriteFrame",IN,this),Tl(this,"fontSize",RN,this),Tl(this,"fntConfig",MN,this)}onLoaded(){const t=this.spriteFrame;!this.fontDefDictionary&&t&&(this.fontDefDictionary=new BN(t.texture));const e=this.fntConfig;if(!e)return void m("The fnt config is not exists!");const i=e.fontDefDictionary;for(const t in i){const e=new ON,n=i[t].rect;e.offsetX=i[t].xOffset,e.offsetY=i[t].yOffset,e.w=n.width,e.h=n.height,e.u=n.x,e.v=n.y,e.textureID=0,e.valid=!0,e.xAdvance=i[t].xAdvance,this.fontDefDictionary.addLetterDefinitions(t,e)}}}).prototype,"fntDataStr",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),IN=wl(PN.prototype,"spriteFrame",[wN],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),RN=wl(PN.prototype,"fontSize",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),MN=wl(PN.prototype,"fntConfig",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),EN=PN))||EN));var LN;n.BitmapFont=NN;let FN=t("LabelAtlas",Vl("cc.LabelAtlas")(LN=class extends NN{})||LN);n.LabelAtlas=FN;const zN=t("BASELINE_RATIO",.26),VN=t("MIDDLE_RATIO",(zN+1)/2-zN);const UN=new Rt(2);UN.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};const GN=new class{constructor(t){this.count=0,this.limit=0,this.datas={},this.limit=t}moveToHead(t){t.next=this.head,t.prev=null,this.head&&(this.head.prev=t),this.head=t,this.tail||(this.tail=t),this.count++,this.datas[t.key]=t}put(t,e){const i=UN.get();if(i.key=t,i.value=e,this.count>=this.limit){const t=this.tail;delete this.datas[t.key],this.count--,this.tail=t.prev,this.tail.next=null,t.prev=null,t.next=null,UN.put(t)}this.moveToHead(i)}remove(t){t.prev?t.prev.next=t.next:this.head=t.next,t.next?t.next.prev=t.prev:this.tail=t.prev,delete this.datas[t.key],this.count--}get(t){const e=this.datas[t];return e?(this.remove(e),this.moveToHead(e),e.value):null}clear(){this.count=0,this.datas={},this.head=null,this.tail=null}has(t){return!!this.datas[t]}delete(t){const e=this.datas[t];this.remove(e)}}(100),kN=/([a-zA-Z0-9--]+|\S)/,HN=/^[!,.:;'}\]%\?>]/,jN=/([a-zA-Z0-9--]+|\S)$/,WN=/[a-zA-Z0-9--]+$/,qN=/^[a-zA-Z0-9--]/;function XN(t){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(t)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(t)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(t)}function YN(t){const e=t.charCodeAt(0);return e>=9&&e<=13||32===e||133===e||160===e||5760===e||e>=8192&&e<=8202||8232===e||8233===e||8239===e||8287===e||12288===e}function KN(t,e,i){const n=`${i||t.font}${e}`,s=GN.get(n);if(null!==s)return s;const r=t.measureText(e),o=r&&r.width||0;return GN.put(n,o),o}function $N(t,e,i){let n=e,s=i;const r=t[e];if(r>="\udc00"&&r<="\udfff"&&n--,void 0!==i)if(i-1!==e){const e=t[i-1];e>="\ud800"&&e<="\udbff"&&s--}else r>="\ud800"&&r<="\udbff"&&s++;return t.substring(n,s)}function JN(t,e,i,n){const s=[];if(0===t.length||i<0)return s.push(""),s;let r=t;for(;e>i&&r.length>1;){let t=r.length*(i/e)|0,o=$N(r,t),a=e-n(o),l=o,c=0,h=0;const _=10;for(;a>i&&h++<_;)t*=i/a,t|=0,o=$N(r,t),a=e-n(o);for(h=0;a<=i&&h++<_;){if(o){const t=kN.exec(o);c=t?t[0].length:1,l=o}t+=c,o=$N(r,t),a=e-n(o)}t-=c,0===t?(t=1,l=$N(r,1)):1===t&&r[0]>="\ud800"&&r[0]<="\udbff"&&(t=2,l=$N(r,2));let u,m=$N(r,0,t);HN.test(l||o)&&(u=jN.exec(m),t-=u?u[0].length:0,0===t&&(t=1),l=$N(r,t),m=$N(r,0,t)),qN.test(l)&&(u=WN.exec(m),u&&m!==u[0]&&(t-=u[0].length,l=$N(r,t),m=$N(r,0,t))),0===s.length?s.push(m):(m=m.trim(),m.length>0&&s.push(m)),r=l||o,e=n(r)}return 0===s.length?s.push(r):(r=r.trim(),r.length>0&&s.push(r)),s}let ZN;class QN{constructor(){this.pool=[]}static getInstance(){return ZN||(ZN=new QN),ZN}get(){let t=this.pool.pop();if(!t){const e=document.createElement("canvas"),i=e.getContext("2d");t={canvas:e,context:i}}return t}put(t){this.pool.length>=Ut.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(t)}}t("CanvasPool",QN);const tL=Ri.WHITE.clone();class eL{constructor(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0}}const iL=`rgba(255, 255, 255, ${(1/255).toFixed(3)})`;class nL{constructor(t,e){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=t,this.labelInfo=e,this.hash=t.charCodeAt(0)+e.hash}updateRenderData(){this._updateProperties(),this._updateTexture()}destroy(){this.image=null}_updateProperties(){if(this.data=QN.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;const t=KN(this.context,this.char,this.labelInfo.fontDesc),e=2*this.labelInfo.margin+2;this.width=parseFloat(t.toFixed(2))+e,this.height=(1+zN)*this.labelInfo.fontSize+e,this.offsetY=-this.labelInfo.fontSize*zN/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new Gd),this.image.reset(this.canvas)}_updateTexture(){if(!this.context||!this.canvas)return;const t=this.context,e=this.labelInfo,i=this.canvas.width,n=this.canvas.height;t.textAlign="center",t.textBaseline="alphabetic",t.clearRect(0,0,i,n),t.fillStyle=iL,t.fillRect(0,0,i,n),t.font=e.fontDesc;const s=e.fontSize,r=i/2,o=n/2+s*VN+0*s,a=e.color;if(t.lineJoin="round",t.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, 1)`,e.isOutlined){const i=e.out||tL;t.strokeStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${i.a/255})`,t.lineWidth=2*e.margin,t.strokeText(this.char,r,o)}t.fillText(this.char,r,o)}}class sL extends Af{initWithSize(t,e,i=Rd.RGBA8888){this.reset({width:t,height:e,format:i})}drawTextureAt(t,e,i){const n=this.getGFXTexture();if(!t||!n)return;const s=this._getGFXDevice();if(!s)return void console.warn("Unable to get device");const r=new Cr;r.texOffset.x=e,r.texOffset.y=i,r.texExtent.width=t.width,r.texExtent.height=t.height,s.copyTexImagesToTexture([t.data],n,[r])}}class rL{get width(){return this._width}get height(){return this._height}constructor(t,e){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;const i=new sL;i.initWithSize(t,e),this.fontDefDictionary=new BN(i),this._halfBleed=1,this._width=t,this._height=e,Mw.on(Rw.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}insertLetterTexture(t){const e=t.image,i=Mw.root.device;if(!e||!this.fontDefDictionary||!i)return null;const n=e.width,s=e.height;if(this._x+n+0>this._width&&(this._x=0,this._y=this._nextY),this._y+s>this._nextY&&(this._nextY=this._y+s+0),this._nextY>this._height)return A(12100),null;this.fontDefDictionary.texture.drawTextureAt(e,this._x,this._y),this._dirty=!0;const r=new eL;return r.u=this._x+this._halfBleed,r.v=this._y+this._halfBleed,r.texture=this.fontDefDictionary.texture,r.valid=!0,r.w=t.width-2,r.h=t.height-2,r.xAdvance=r.w,r.offsetY=t.offsetY,this._x+=n+0,this.fontDefDictionary.addLetterDefinitions(t.hash,r),r}update(){this._dirty&&(this._dirty=!1)}reset(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()}destroy(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)}getTexture(){return this.fontDefDictionary.getTexture()}beforeSceneLoad(){this.clearAllCache()}clearAllCache(){this.destroy();const t=new sL;t.initWithSize(this._width,this._height),this.fontDefDictionary.texture=t}getLetter(t){return this.fontDefDictionary.letterDefinitions[t]}getLetterDefinitionForChar(t,e){const i=t.charCodeAt(0)+e.hash;let n=this.fontDefDictionary.letterDefinitions[i];if(!n){const i=new nL(t,e);i.updateRenderData(),n=this.insertLetterTexture(i),i.destroy()}return n}}const oL={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Ri.WHITE.clone(),isOutlined:!1,out:Ri.WHITE.clone(),margin:0};class aL{constructor(){this.material=null,this.vertexCount=0,this.indicesCount=0}}class lL extends aL{constructor(...t){super(...t),this.vData=null,this.uvDirty=!0,this.vertDirty=!0,this._data=[],this._indices=[],this._pivotX=0,this._pivotY=0,this._width=0,this._height=0}get dataLength(){return this._data.length}set dataLength(t){const e=this._data;if(e.length!==t){const i=e.length;let n=0;for(n=t;n<i;n++)hL.free(e[n]);for(n=i;n<t;n++)e[n]=hL.alloc();e.length=t}}get data(){return this._data}static add(){return _L.add()}static remove(t){const e=_L.data.indexOf(t);-1!==e&&(_L.data[e].clear(),_L.removeAt(e))}updateSizeNPivot(t,e,i,n){t===this._width&&e===this._height&&i===this._pivotX&&n===this._pivotY||(this._width=t,this._height=e,this._pivotX=i,this._pivotY=n,this.vertDirty=!0)}clear(){this._data.length=0,this._indices.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.uvDirty=!0,this.vertDirty=!0,this.material=null,this.vertexCount=0,this.indicesCount=0}}class cL extends aL{constructor(t=9){super(),this.vData=void 0,this.iData=void 0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.byteCount=0,this.lastFilledIndices=0,this.lastFilledVertex=0,this._formatByte=void 0,this._formatByte=t*Float32Array.BYTES_PER_ELEMENT,this.vData=new Float32Array(256*t*Float32Array.BYTES_PER_ELEMENT),this.iData=new Uint16Array(1536)}set formatByte(t){this._formatByte=t}get formatByte(){return this._formatByte}get floatStride(){return this._formatByte>>2}get vDataOffset(){return this.byteCount>>>2}static add(){return uL.add()}static remove(t){const e=uL.data.indexOf(t);-1!==e&&(uL.data[e].reset(),uL.removeAt(e))}request(t,e){const i=this.byteCount+t*this._formatByte;return this.reserve(t,e),this.vertexCount+=t,this.indicesCount+=e,this.byteCount=i,!0}reserve(t,e){const i=this.byteCount+t*this._formatByte,n=this.indicesCount+e;if(t+this.vertexCount>65535)return!1;let s=this.vData.byteLength,r=this.iData.length,o=this.vData.length,a=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)o*=2,a*=2,s=4*o,r=a;this._reallocBuffer(o,a)}return!0}advance(t,e){this.vertexCount+=t,this.indicesCount+=e,this.byteCount+=t*this._formatByte}reset(){this.vertexCount=0,this.indicesCount=0,this.byteCount=0,this.vertexStart=0,this.indicesStart=0,this.byteStart=0,this.lastFilledIndices=0,this.lastFilledVertex=0}_reallocBuffer(t,e){const i=this.vData;this.vData=new Float32Array(t),this.vData.set(i,0);const n=this.iData;this.iData=new Uint16Array(e),this.iData.set(n,0)}}const hL=new z((()=>({x:0,y:0,z:0,u:0,v:0,color:Ri.WHITE.clone()})),128),_L=new V((()=>new lL),32),uL=new V((()=>new cL),32);var mL,pL,dL,fL,gL,yL,vL,xL,bL,SL,AL,CL,TL,wL;const EL=new tn,PL=new tn,DL=new $i,IL=new $i,RL=new $i,ML=new $i(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),OL=new hn;let BL,NL=function(e){return t({UITransform:e,UITransformComponent:e}),e}((mL=Vl("cc.UITransform"),pL=ec(),dL=Gl(110),fL=Jl(),gL=_c(),yL=rc(),vL=_c(),xL=rc(),mL(bL=pL(bL=dL(bL=fL(bL=kl(bL=$l((wL=TL=class t extends Rh{constructor(...t){super(...t),this._priority=0,Tl(this,"_contentSize",AL,this),Tl(this,"_anchorPoint",CL,this)}get contentSize(){return this._contentSize}set contentSize(t){this._contentSize.equals(t)||(this._contentSize.set(t),this.node.emit(ev.SIZE_CHANGED),this._markRenderDataDirty())}get width(){return this._contentSize.width}set width(t){this._contentSize.width!==t&&(this._contentSize.width=t,this.node.emit(ev.SIZE_CHANGED),this._markRenderDataDirty())}get height(){return this._contentSize.height}set height(t){this.contentSize.height!==t&&(this._contentSize.height=t,this.node.emit(ev.SIZE_CHANGED),this._markRenderDataDirty())}get anchorPoint(){return this._anchorPoint}set anchorPoint(t){this._anchorPoint.equals(t)||(this._anchorPoint.set(t),this.node.emit(ev.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorX(){return this._anchorPoint.x}set anchorX(t){this._anchorPoint.x!==t&&(this._anchorPoint.x=t,this.node.emit(ev.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get anchorY(){return this._anchorPoint.y}set anchorY(t){this._anchorPoint.y!==t&&(this._anchorPoint.y=t,this.node.emit(ev.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}get priority(){return this._priority}set priority(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?A(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}get visibility(){const t=Mw.root.batcher2D.getFirstRenderCamera(this.node);return t?t.visibility:0}get cameraPriority(){const t=Mw.root.batcher2D.getFirstRenderCamera(this.node);return t?t.priority:0}__preload(){this.node._uiProps.uiTransformComp=this}onLoad(){this.node.parent&&t.insertChangeMap(this.node.parent)}onEnable(){this.node.on(ev.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()}onDisable(){this.node.off(ev.PARENT_CHANGED,this._parentChanged,this)}onDestroy(){this.node._uiProps.uiTransformComp=null}setContentSize(t,e){const i=this._contentSize;if(void 0===e){if((t=t).width===i.width&&t.height===i.height)return;i.width=t.width,i.height=t.height}else{if(t===i.width&&e===i.height)return;i.width=t,i.height=e}this.node.emit(ev.SIZE_CHANGED),this._markRenderDataDirty()}setAnchorPoint(t,e){const i=this._anchorPoint;if(void 0===e){if((t=t).x===i.x&&t.y===i.y)return;i.x=t.x,i.y=t.y}else{if(t===i.x&&e===i.y)return;i.x=t,i.y=e}this.node.emit(ev.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()}isHit(t,e){const i=this._contentSize.width,n=this._contentSize.height,s=EL,r=PL,o=this._getRenderScene().cameras;for(let a=0;a<o.length;a++){const l=o[a];if(!(l.visibility&this.node.layer))continue;l.node.getWorldRT(DL);const c=DL.m12,h=DL.m13,_=uw.center;if(DL.m12=_.x-(DL.m00*c+DL.m04*h),DL.m13=_.y-(DL.m01*c+DL.m05*h),$i.invert(DL,DL),tn.transformMat4(s,t,DL),this.node.getWorldMatrix(RL),$i.invert(DL,RL),$i.strictEquals(DL,ML))continue;tn.transformMat4(r,s,DL),r.x+=this._anchorPoint.x*i,r.y+=this._anchorPoint.y*n;let u=!1;if(r.x>=0&&r.y>=0&&r.x<=i&&r.y<=n&&(u=!0,e&&e.mask)){const t=e.mask;let i=this.node;const n=t?t.length:0;for(let e=0,r=0;i&&r<n;++e,i=i.parent){const n=t[r];if(e===n.index){if(i!==n.comp.node){t.length=r;break}{const t=n.comp;if(t&&t._enabled&&!t.isHit(s)){u=!1;break}r++}}else if(e>n.index){t.length=r;break}}}if(u)return!0}return!1}convertToNodeSpaceAR(t,e){return this.node.getWorldMatrix(RL),$i.invert(DL,RL),e||(e=new Ni),Ni.transformMat4(e,t,DL)}convertToWorldSpaceAR(t,e){return this.node.getWorldMatrix(RL),e||(e=new Ni),Ni.transformMat4(e,t,RL)}getBoundingBox(){$i.fromRTS(IL,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const t=this._contentSize.width,e=this._contentSize.height,i=new hn(-this._anchorPoint.x*t,-this._anchorPoint.y*e,t,e);return i.transformMat4(IL),i}getBoundingBoxToWorld(){return this.node.parent?(this.node.parent.getWorldMatrix(RL),this.getBoundingBoxTo(RL)):this.getBoundingBox()}getBoundingBoxTo(e){$i.fromRTS(IL,this.node.getRotation(),this.node.getPosition(),this.node.getScale());const i=this._contentSize.width,n=this._contentSize.height,s=new hn(-this._anchorPoint.x*i,-this._anchorPoint.y*n,i,n);if($i.multiply(RL,e,IL),s.transformMat4(RL),!this.node.children)return s;const r=this.node.children;for(const i of r)if(i&&i.active){const n=i.getComponent(t);if(n){const t=n.getBoundingBoxTo(e);t&&hn.union(s,s,t)}}return s}getComputeAABB(t){const e=this._contentSize.width,i=this._contentSize.height;OL.set(-this._anchorPoint.x*e,-this._anchorPoint.y*i,e,i),OL.transformMat4(this.node.worldMatrix);const n=OL.x+.5*OL.width,s=OL.y+.5*OL.height,r=this.node.worldPosition.z,o=OL.width/2,a=OL.height/2;return null!=t?(gl.set(t,n,s,r,o,a,.001),t):new gl(n,s,r,o,a,.001)}_parentChanged(e){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)}_markRenderDataDirty(){const t=this.node._uiProps.uiComp;t&&t.markForUpdateRenderData()}static insertChangeMap(e){const i=e.uuid;t.priorityChangeNodeMap.has(i)||t.priorityChangeNodeMap.set(i,e)}static _sortChildrenSibling(t){const e=t.children;e&&e.sort(((t,e)=>{const i=t._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp,s=(i?i._priority:0)-(n?n._priority:0);return 0===s?t.getSiblingIndex()-e.getSiblingIndex():s}))}static _sortSiblings(){t.priorityChangeNodeMap.forEach((e=>{t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()}static _cleanChangeMap(){t.priorityChangeNodeMap.clear()}},TL.EventType=ev,TL.priorityChangeNodeMap=new Map,wl((SL=wL).prototype,"contentSize",[gL,yL],Object.getOwnPropertyDescriptor(SL.prototype,"contentSize"),SL.prototype),wl(SL.prototype,"anchorPoint",[vL,xL],Object.getOwnPropertyDescriptor(SL.prototype,"anchorPoint"),SL.prototype),AL=wl(SL.prototype,"_contentSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(100,100)}}),CL=wl(SL.prototype,"_anchorPoint",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn(.5,.5)}}),bL=SL))||bL)||bL)||bL)||bL)||bL)||bL));Mw.on(Rw.EVENT_AFTER_UPDATE,NL._sortSiblings),Mw.on(Rw.EVENT_BEFORE_SCENE_LAUNCH,NL._cleanChangeMap),function(t){t[t.DISABLED=0]="DISABLED",t[t.CLEAR=1]="CLEAR",t[t.ENTER_LEVEL=2]="ENTER_LEVEL",t[t.ENABLED=3]="ENABLED",t[t.EXIT_LEVEL=4]="EXIT_LEVEL",t[t.CLEAR_INVERTED=5]="CLEAR_INVERTED",t[t.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(BL||(BL={}));class LL{constructor(){this.stage=BL.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:qs.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Xs.KEEP,zFailOp:Xs.KEEP,passOp:Xs.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}get pattern(){return this._stencilPattern}pushMask(t){this._maskStack.push(t)}clear(t){t.stencilStage=t.inverted?BL.CLEAR_INVERTED:BL.CLEAR}enterLevel(t){t.graphics.stencilStage=t.inverted?BL.ENTER_LEVEL_INVERTED:BL.ENTER_LEVEL}enableMask(){this.stage=BL.ENABLED}exitMask(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=BL.DISABLED:this.stage=BL.ENABLED)}getWriteMask(){return 1<<this._maskStack.length-1}getExitWriteMask(){return 1<<this._maskStack.length}getStencilRef(){let t=0;for(let e=0;e<this._maskStack.length;++e)t+=1<<e;return t}reset(){this._maskStack.length=0,this.stage=BL.DISABLED}destroy(){this.stencilStateMap.forEach((t=>{t.destroy()})),this.stencilStateMap.clear()}getStencilStage(t,e){let i=0,n=!1,s=!1,r=qs.LESS,o=this.stencilStateMap;if(e&&e.passes[0]){const a=e.passes[0].depthStencilState;let l=0,c=0;a.depthTest&&(l=1),a.depthWrite&&(c=1),i=l|c<<1|a.depthFunc<<2|t<<6|this._maskStack.length<<9,n=a.depthTest,s=a.depthWrite,r=a.depthFunc,o=this.stencilStateMapWithDepth}else i=t<<16|this._maskStack.length;if(o&&o.has(i))return o.get(i);this.setStateFromStage(t);const a=new ia(n,s,r,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return o.set(i,a),a}getStencilHash(t){return t<<8|this._maskStack.length}setStateFromStage(t){const e=this._stencilPattern;t===BL.DISABLED?(e.stencilTest=!1,e.func=qs.ALWAYS,e.failOp=Xs.KEEP,e.stencilMask=e.writeMask=65535,e.ref=1):(e.stencilTest=!0,t===BL.ENABLED?(e.func=qs.EQUAL,e.failOp=Xs.KEEP,e.stencilMask=e.ref=this.getStencilRef(),e.writeMask=this.getWriteMask()):t===BL.CLEAR?(e.func=qs.NEVER,e.failOp=Xs.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===BL.CLEAR_INVERTED||t===BL.ENTER_LEVEL?(e.func=qs.NEVER,e.failOp=Xs.REPLACE,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()):t===BL.ENTER_LEVEL_INVERTED&&(e.func=qs.NEVER,e.failOp=Xs.ZERO,e.writeMask=e.stencilMask=e.ref=this.getWriteMask()))}}var FL,zL,VL,UL,GL,kL,HL,jL,WL,qL,XL,YL,KL,$L,JL,ZL,QL,tF;let eF;t("StencilManager",LL),LL.sharedManager=null,LL.sharedManager=new LL,zt(Ys),function(t){t[t.ADD_COLOR=0]="ADD_COLOR",t[t.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",t[t.GRAYSCALE=2]="GRAYSCALE",t[t.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",t[t.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(eF||(eF=t("InstanceMaterialType",{})));let iF=function(e){return t({Renderable2D:e,RenderComponent:e,UIRenderable:e}),e}((FL=Vl("cc.Renderable2D"),zL=Ul(NL),VL=nc(),UL=yc($g),GL=yc($g),kL=_c(),HL=sc(),jL=_c(),WL=rc(),FL(qL=zL(qL=kl(qL=$l((tF=QL=class t extends zD{constructor(...t){super(...t),Tl(this,"_materials",YL,this),Tl(this,"_customMaterial",KL,this),this.stencilStage=BL.DISABLED,Tl(this,"_srcBlendFactor",$L,this),Tl(this,"_dstBlendFactor",JL,this),Tl(this,"_color",ZL,this),this._assembler=null,this._postAssembler=null,this._renderData=null,this._renderDataFlag=!0,this._renderFlag=!0,this._delegateSrc=null,this._instanceMaterialType=eF.ADD_COLOR_AND_TEXTURE,this._blendState=new ta,this._blendHash=0,this._colorDirty=!0,this._cacheAlpha=1,this._lastParent=null}get sharedMaterials(){return this._materials}set sharedMaterials(t){for(let e=0;e<t.length;e++)t[e]!==this._materials[e]&&this.setMaterial(t[e],e);if(t.length<this._materials.length){for(let e=t.length;e<this._materials.length;e++)this.setMaterial(null,e);this._materials.splice(t.length)}}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this.updateMaterial()}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc()}get srcBlendFactor(){return this._customMaterial&&A(12001),this._srcBlendFactor}set srcBlendFactor(t){this._customMaterial?A(12001):this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get dstBlendFactor(){return this._customMaterial&&A(12001),this._dstBlendFactor}set dstBlendFactor(t){this._customMaterial?A(12001):this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color.equals(t)||(this._color.set(t),this._colorDirty=!0)}get renderData(){return this._renderData}set delegateSrc(t){this._delegateSrc=t}get blendHash(){return this._blendHash}updateBlendHash(){const t=this._blendState.targets[0].blendDst<<4;this._blendHash=t|this._blendState.targets[0].blendSrc}__preload(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()}onEnable(){this.node.on(ev.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(ev.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()}onRestore(){this.updateMaterial(),this._renderFlag=this._canRender()}onDisable(){this.node.off(ev.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(ev.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1}onDestroy(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(let t=0;t<this._materialInstances.length;t++)this._materialInstances[t]&&this._materialInstances[t].destroy();this._renderData=null,this._blendState&&this._blendState.destroy()}markForUpdateRenderData(t=!0){if(this._renderFlag=this._canRender(),t&&this._renderFlag){const e=this._renderData;e&&(e.vertDirty=!0),this._renderDataFlag=t}else t||(this._renderDataFlag=t)}requestRenderData(){const t=lL.add();return this._renderData=t,t}destroyRenderData(){this._renderData&&(lL.remove(this._renderData),this._renderData=null)}updateAssembler(t){this._updateColor(),this._renderFlag&&(this._checkAndUpdateRenderData(),this._render(t))}postUpdateAssembler(t){this._renderFlag&&this._postRender(t)}_render(t){}_postRender(t){}_checkAndUpdateRenderData(){this._renderDataFlag&&(this._assembler.updateRenderData(this),this._renderDataFlag=!1)}_canRender(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this.node._uiProps.opacity>0}_postCanRender(){}_updateColor(){const t=this._cacheAlpha<=0;this._updateWorldAlpha(),this._colorDirty&&this._assembler&&this._assembler.updateColor&&(this._assembler.updateColor(this),t&&(this._renderFlag=this._canRender()),this._colorDirty=!1)}_updateWorldAlpha(){let t=this.color.a/255;1===t&&(t=this.node._uiProps.localOpacity);const e=this.node._uiProps.opacity*t;this.node._uiProps.opacity=e,this._colorDirty=this._colorDirty||e!==this._cacheAlpha,this._cacheAlpha=e}_updateBlendFunc(){let t=this._blendState.targets[0];t||(t=new Qo,this._blendState.setTarget(0,t)),t.blendDst===this._dstBlendFactor&&t.blendSrc===this._srcBlendFactor||(t.blend=!0,t.blendDstAlpha=Ys.ONE_MINUS_SRC_ALPHA,t.blendDst=this._dstBlendFactor,t.blendSrc=this._srcBlendFactor),this.updateBlendHash()}getBlendState(){return this._blendState}_nodeStateChange(e){this._renderData&&this.markForUpdateRenderData();for(let e=0;e<this.node.children.length;++e){const i=this.node.children[e].getComponent(t);i&&i.markForUpdateRenderData()}}_updateBuiltinMaterial(){let t;switch(this._instanceMaterialType){case eF.ADD_COLOR:t=rg.get("ui-base-material");break;case eF.GRAYSCALE:t=rg.get("ui-sprite-gray-material");break;case eF.USE_ALPHA_SEPARATED:t=rg.get("ui-sprite-alpha-sep-material");break;case eF.USE_ALPHA_SEPARATED_AND_GRAY:t=rg.get("ui-sprite-gray-alpha-sep-material");break;default:t=rg.get("ui-sprite-material")}return t}_setCacheAlpha(t){this._cacheAlpha=t}},QL.BlendState=Ys,QL.Assembler=null,QL.PostAssembler=null,YL=wl((XL=tF).prototype,"_materials",[vc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wl(XL.prototype,"sharedMaterials",[vc,VL],Object.getOwnPropertyDescriptor(XL.prototype,"sharedMaterials"),XL.prototype),KL=wl(XL.prototype,"_customMaterial",[UL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wl(XL.prototype,"customMaterial",[GL,kL,HL],Object.getOwnPropertyDescriptor(XL.prototype,"customMaterial"),XL.prototype),wl(XL.prototype,"color",[jL,WL],Object.getOwnPropertyDescriptor(XL.prototype,"color"),XL.prototype),$L=wl(XL.prototype,"_srcBlendFactor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ys.SRC_ALPHA}}),JL=wl(XL.prototype,"_dstBlendFactor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ys.ONE_MINUS_SRC_ALPHA}}),ZL=wl(XL.prototype,"_color",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.WHITE.clone()}}),qL=XL))||qL)||qL)||qL)||qL));var nF,sF,rF,oF,aF,lF,cF,hF,_F,uF,mF,pF,dF,fF,gF,yF,vF,xF,bF,SF,AF,CF,TF,wF,EF,PF,DF,IF,RF,MF,OF,BF,NF,LF,FF,zF,VF,UF,GF,kF,HF,jF,WF,qF,XF,YF,KF,$F,JF,ZF,QF,tz,ez,iz,nz,sz,rz,oz,az,lz;let cz,hz,_z,uz;n.internal.Renderable2D=iF,function(t){t[t.LEFT=0]="LEFT",t[t.CENTER=1]="CENTER",t[t.RIGHT=2]="RIGHT"}(cz||(cz=t("HorizontalTextAlignment",{}))),zt(cz),function(t){t[t.TOP=0]="TOP",t[t.CENTER=1]="CENTER",t[t.BOTTOM=2]="BOTTOM"}(hz||(hz=t("VerticalTextAlignment",{}))),zt(hz),function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.SHRINK=2]="SHRINK",t[t.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(_z||(_z=t("Overflow",{}))),zt(_z),function(t){t[t.NONE=0]="NONE",t[t.BITMAP=1]="BITMAP",t[t.CHAR=2]="CHAR"}(uz||(uz=t("CacheMode",{}))),zt(uz);let mz,pz,dz,fz=function(e){return t({Label:e,LabelComponent:e}),e}((nF=Vl("cc.Label"),sF=ec(),rF=Gl(110),oF=Jl(),aF=_c(),lF=rc(),cF=yc(cz),hF=_c(),_F=rc(),uF=yc(hz),mF=_c(),pF=rc(),dF=_c(),fF=rc(),gF=_c(),yF=nc(),vF=rc(),xF=_c(),bF=rc(),SF=yc(_z),AF=_c(),CF=rc(),TF=_c(),wF=rc(),EF=yc(xN),PF=_c(),DF=nc(),IF=rc(),RF=_c(),MF=rc(),OF=yc(uz),BF=_c(),NF=rc(),LF=_c(),FF=rc(),zF=_c(),VF=rc(),UF=_c(),GF=rc(),kF=nc(),nF(HF=sF(HF=rF(HF=oF((lz=az=class t extends iF{get string(){return this._string}set string(t){t?t+="":t="",this._string!==t&&(this._string=t,this.updateRenderData())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this._horizontalAlign!==t&&(this._horizontalAlign=t,this.updateRenderData())}get verticalAlign(){return this._verticalAlign}set verticalAlign(t){this._verticalAlign!==t&&(this._verticalAlign=t,this.updateRenderData())}get actualFontSize(){return this._actualFontSize}set actualFontSize(t){this._actualFontSize=t}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this.updateRenderData())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this.updateRenderData())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this.updateRenderData())}get overflow(){return this._overflow}set overflow(t){this._overflow!==t&&(this._overflow=t,this.updateRenderData())}get enableWrapText(){return this._enableWrapText}set enableWrapText(t){this._enableWrapText!==t&&(this._enableWrapText=t,this.updateRenderData())}get font(){return this._font}set font(t){this._font!==t&&(this._isSystemFontUsed=!t,this._font=t,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!t,t&&(this.font=null),this._flushAssembler(),this.updateRenderData())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode!==uz.BITMAP||this._font instanceof NN||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===uz.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=t,this.updateRenderData(!0))}get spriteFrame(){return this._texture}get ttfSpriteFrame(){return this._ttfSpriteFrame}get isBold(){return this._isBold}set isBold(t){this._isBold!==t&&(this._isBold=t,this.updateRenderData())}get isItalic(){return this._isItalic}set isItalic(t){this._isItalic!==t&&(this._isItalic=t,this.updateRenderData())}get isUnderline(){return this._isUnderline}set isUnderline(t){this._isUnderline!==t&&(this._isUnderline=t,this.updateRenderData())}get underlineHeight(){return this._underlineHeight}set underlineHeight(t){this._underlineHeight!==t&&(this._underlineHeight=t,this.updateRenderData())}get assemblerData(){return this._assemblerData}get fontAtlas(){return this._fontAtlas}set fontAtlas(t){this._fontAtlas=t}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this.updateRenderData())}get _bmFontOriginalSize(){return this._font instanceof NN?this._font.fontSize:-1}constructor(){super(),Tl(this,"_string",WF,this),Tl(this,"_horizontalAlign",qF,this),Tl(this,"_verticalAlign",XF,this),Tl(this,"_actualFontSize",YF,this),Tl(this,"_fontSize",KF,this),Tl(this,"_fontFamily",$F,this),Tl(this,"_lineHeight",JF,this),Tl(this,"_overflow",ZF,this),Tl(this,"_enableWrapText",QF,this),Tl(this,"_font",tz,this),Tl(this,"_isSystemFontUsed",ez,this),this._spacingX=0,Tl(this,"_isItalic",iz,this),Tl(this,"_isBold",nz,this),Tl(this,"_isUnderline",sz,this),Tl(this,"_underlineHeight",rz,this),Tl(this,"_cacheMode",oz,this),this._N$file=null,this._texture=null,this._ttfSpriteFrame=null,this._userDefinedFont=null,this._assemblerData=null,this._fontAtlas=null,this._letterTexture=null,this._ttfSpriteFrame=null}onEnable(){super.onEnable(),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()}onDisable(){super.onDisable()}onDestroy(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){const t=this._ttfSpriteFrame.texture;if(t&&null===this._ttfSpriteFrame.original){const e=t;e.image&&e.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,super.onDestroy()}updateRenderData(t=!1){this.markForUpdateRenderData(),t&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))}_render(t){t.commitComp(this,this._texture,this._assembler,null)}_updateColor(){this._updateWorldAlpha(),this._colorDirty&&(this.updateRenderData(!1),this._colorDirty=!1)}_canRender(){if(!super._canRender()||!this._string)return!1;const t=this._font;if(t&&t instanceof NN){const e=t.spriteFrame;if(!e||!e.texture)return!1}return!0}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}_applyFontTexture(){this.markForUpdateRenderData();const t=this._font;if(t instanceof NN){const e=t.spriteFrame;e&&e.texture&&(this._texture=e,this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===uz.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new pN,this._assemblerData=this._assembler.getAssemblerData();const t=new Gd(this._assemblerData.canvas),e=new Af;e.image=t,this._ttfSpriteFrame.texture=e}this.cacheMode!==uz.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}}changeMaterialForDefine(){if(!this._texture)return;let t=!1;if(this.cacheMode!==uz.CHAR){const e=this._texture.texture;if(e instanceof lf){const i=e.getPixelFormat();t=i===Rd.RGBA_ETC1||i===Rd.RGB_A_PVRTC_4BPPV1||i===Rd.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=t?eF.USE_ALPHA_SEPARATED:eF.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},az.HorizontalAlign=cz,az.VerticalAlign=hz,az.Overflow=_z,az.CacheMode=uz,az._canvasPool=QN.getInstance(),wl((jF=lz).prototype,"string",[aF,lF,uc],Object.getOwnPropertyDescriptor(jF.prototype,"string"),jF.prototype),wl(jF.prototype,"horizontalAlign",[cF,hF,_F],Object.getOwnPropertyDescriptor(jF.prototype,"horizontalAlign"),jF.prototype),wl(jF.prototype,"verticalAlign",[uF,mF,pF],Object.getOwnPropertyDescriptor(jF.prototype,"verticalAlign"),jF.prototype),wl(jF.prototype,"fontSize",[dF,fF],Object.getOwnPropertyDescriptor(jF.prototype,"fontSize"),jF.prototype),wl(jF.prototype,"fontFamily",[gF,yF,vF],Object.getOwnPropertyDescriptor(jF.prototype,"fontFamily"),jF.prototype),wl(jF.prototype,"lineHeight",[xF,bF],Object.getOwnPropertyDescriptor(jF.prototype,"lineHeight"),jF.prototype),wl(jF.prototype,"overflow",[SF,AF,CF],Object.getOwnPropertyDescriptor(jF.prototype,"overflow"),jF.prototype),wl(jF.prototype,"enableWrapText",[TF,wF],Object.getOwnPropertyDescriptor(jF.prototype,"enableWrapText"),jF.prototype),wl(jF.prototype,"font",[EF,PF,DF,IF],Object.getOwnPropertyDescriptor(jF.prototype,"font"),jF.prototype),wl(jF.prototype,"useSystemFont",[RF,MF],Object.getOwnPropertyDescriptor(jF.prototype,"useSystemFont"),jF.prototype),wl(jF.prototype,"cacheMode",[OF,BF,NF],Object.getOwnPropertyDescriptor(jF.prototype,"cacheMode"),jF.prototype),wl(jF.prototype,"isBold",[LF,FF],Object.getOwnPropertyDescriptor(jF.prototype,"isBold"),jF.prototype),wl(jF.prototype,"isItalic",[zF,VF],Object.getOwnPropertyDescriptor(jF.prototype,"isItalic"),jF.prototype),wl(jF.prototype,"isUnderline",[UF,GF],Object.getOwnPropertyDescriptor(jF.prototype,"isUnderline"),jF.prototype),wl(jF.prototype,"underlineHeight",[kF,ic],Object.getOwnPropertyDescriptor(jF.prototype,"underlineHeight"),jF.prototype),WF=wl(jF.prototype,"_string",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),qF=wl(jF.prototype,"_horizontalAlign",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cz.CENTER}}),XF=wl(jF.prototype,"_verticalAlign",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hz.CENTER}}),YF=wl(jF.prototype,"_actualFontSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),KF=wl(jF.prototype,"_fontSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),$F=wl(jF.prototype,"_fontFamily",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),JF=wl(jF.prototype,"_lineHeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ZF=wl(jF.prototype,"_overflow",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _z.NONE}}),QF=wl(jF.prototype,"_enableWrapText",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tz=wl(jF.prototype,"_font",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ez=wl(jF.prototype,"_isSystemFontUsed",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),iz=wl(jF.prototype,"_isItalic",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nz=wl(jF.prototype,"_isBold",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sz=wl(jF.prototype,"_isUnderline",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rz=wl(jF.prototype,"_underlineHeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),oz=wl(jF.prototype,"_cacheMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uz.NONE}}),HF=jF))||HF)||HF)||HF)||HF));!function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE"}(mz||(mz={})),zt(mz),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER"}(pz||(pz={})),zt(pz),function(t){t[t.PT_CORNER=1]="PT_CORNER",t[t.PT_LEFT=2]="PT_LEFT",t[t.PT_BEVEL=4]="PT_BEVEL",t[t.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(dz||(dz={})),zt(dz);const gz=Math.PI,yz=Math.min,vz=Math.max,xz=Math.cos,bz=Math.sin,Sz=Math.abs,Az=Math.sign,Cz=.5522847493;function Tz(t,e,i,n,s){t.moveTo(e-n,i),t.bezierCurveTo(e-n,i+s*Cz,e-n*Cz,i+s,e,i+s),t.bezierCurveTo(e+n*Cz,i+s,e+n,i+s*Cz,e+n,i),t.bezierCurveTo(e+n,i-s*Cz,e+n*Cz,i-s,e,i-s),t.bezierCurveTo(e-n*Cz,i-s,e-n,i-s*Cz,e-n,i),t.close()}function wz(t,e,i,n,s,r,o,a,l,c,h){let _=0,u=0,m=0,p=0,d=0,f=0,g=0,y=0,v=0,x=0,b=0,S=0,A=0,C=0,T=0,w=0;c>10||(_=.5*(e+n),u=.5*(i+s),m=.5*(n+r),p=.5*(s+o),d=.5*(r+a),f=.5*(o+l),g=.5*(_+m),y=.5*(u+p),A=a-e,C=l-i,T=Sz((n-a)*C-(s-l)*A),w=Sz((r-a)*C-(o-l)*A),(T+w)*(T+w)<t.tessTol*(A*A+C*C)?t.addPoint(a,l,0===h?h|dz.PT_BEVEL:h):(v=.5*(m+d),x=.5*(p+f),b=.5*(g+v),S=.5*(y+x),wz(t,e,i,_,u,g,y,b,S,c+1,0),wz(t,b,S,v,x,d,f,a,l,c+1,h)))}class Ez extends tn{constructor(t,e){super(t,e),this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0,this.reset()}reset(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0}}class Pz{constructor(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}reset(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]}}class Dz{constructor(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Ri.WHITE.clone(),this.lineCap=mz.BUTT,this.strokeColor=Ri.BLACK.clone(),this.lineJoin=pz.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}moveTo(t,e){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(t,e,dz.PT_CORNER),this._commandX=t,this._commandY=e}lineTo(t,e){this.addPoint(t,e,dz.PT_CORNER),this._commandX=t,this._commandY=e}bezierCurveTo(t,e,i,n,s,r){const o=this._curPath,a=o.points[o.points.length-1];a&&(a.x!==t||a.y!==e||i!==s||n!==r?(wz(this,a.x,a.y,t,e,i,n,s,r,0,dz.PT_CORNER),this._commandX=s,this._commandY=r):this.lineTo(s,r))}quadraticCurveTo(t,e,i,n){const s=this._commandX,r=this._commandY;this.bezierCurveTo(s+2/3*(t-s),r+2/3*(e-r),i+2/3*(t-i),n+2/3*(e-n),i,n)}arc(t,e,i,n,s,r){!function(t,e,i,n,s,r,o){let a=0,l=0,c=0,h=0,_=0,u=0,m=0,p=0,d=0,f=0,g=0,y=0,v=0,x=0,b=0,S=0;if(l=r-s,o=o||!1)if(Sz(l)>=2*gz)l=2*gz;else for(;l<0;)l+=2*gz;else if(Sz(l)>=2*gz)l=2*-gz;else for(;l>0;)l-=2*gz;for(S=0|vz(1,yz(Sz(l)/(.5*gz)+.5,5)),c=l/S/2,h=Sz(4/3*(1-xz(c))/bz(c)),o||(h=-h),b=0;b<=S;b++)a=s+l*(b/S),_=xz(a),u=bz(a),m=e+_*n,p=i+u*n,d=-u*n*h,f=_*n*h,0===b?t.moveTo(m,p):t.bezierCurveTo(g+v,y+x,m-d,p-f,m,p),g=m,y=p,v=d,x=f}(this,t,e,i,n,s,r)}ellipse(t,e,i,n){Tz(this,t,e,i,n),this._curPath.complex=!1}circle(t,e,i){Tz(this,t,e,i,i),this._curPath.complex=!1}rect(t,e,i,n){this.moveTo(t,e),this.lineTo(t+i,e),this.lineTo(t+i,e+n),this.lineTo(t,e+n),this.close(),this._curPath.complex=!1}roundRect(t,e,i,n,s){!function(t,e,i,n,s,r){if(r<.1)t.rect(e,i,n,s);else{const o=yz(r,.5*Sz(n))*Az(n),a=yz(r,.5*Sz(s))*Az(s);t.moveTo(e,i+a),t.lineTo(e,i+s-a),t.bezierCurveTo(e,i+s-a*(1-Cz),e+o*(1-Cz),i+s,e+o,i+s),t.lineTo(e+n-o,i+s),t.bezierCurveTo(e+n-o*(1-Cz),i+s,e+n,i+s-a*(1-Cz),e+n,i+s-a),t.lineTo(e+n,i+a),t.bezierCurveTo(e+n,i+a*(1-Cz),e+n-o*(1-Cz),i,e+n-o,i),t.lineTo(e+o,i),t.bezierCurveTo(e+o*(1-Cz),i,e,i+a*(1-Cz),e,i+a),t.close()}}(this,t,e,i,n,s),this._curPath.complex=!1}clear(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;const t=this._renderDataList;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&cL.remove(i)}this._renderDataList.length=0}close(){this._curPath.closed=!0}requestRenderData(){const t=cL.add();return this._renderDataList.push(t),t}getRenderDataList(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList}addPoint(t,e,i){const n=this._curPath;if(!n)return;const s=this._points,r=n.points;let o=s[this.pointsOffset++];o?(o.x=t,o.y=e):(o=new Ez(t,e),s.push(o)),o.flags=i,r.push(o)}_addPath(){const t=this.pathLength;let e=this.paths[t];return e?e.reset():(e=new Pz,this.paths.push(e)),this.pathLength++,this._curPath=e,e}}const Iz=[new Wr(pr.ATTR_POSITION,Os.RGB32F)],Rz=[new Wr(pr.ATTR_POSITION,Os.RGB32F),new Wr(pr.ATTR_COLOR,Os.RGBA32F)],Mz=[new Wr(pr.ATTR_POSITION,Os.RGB32F),new Wr(pr.ATTR_TEX_COORD,Os.RG32F),new Wr(pr.ATTR_COLOR,Os.RGBA32F)],Oz=[new Wr(pr.ATTR_POSITION,Os.RGB32F),new Wr(pr.ATTR_TEX_COORD,Os.RG32F),new Wr(pr.ATTR_COLOR,Os.RGBA32F),new Wr(pr.ATTR_COLOR2,Os.RGBA32F)];function Bz(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=fo[n.format].count}return e}function Nz(t){let e=0;for(let i=0;i<t.length;i++){const n=t[i];e+=fo[n.format].size}return e}var Lz,Fz,zz,Vz,Uz,Gz,kz,Hz,jz,Wz,qz,Xz,Yz,Kz,$z,Jz,Zz,Qz,tV,eV,iV,nV;n.internal.vfmtPosUvColor=Mz,n.internal.vfmtPosUvTwoColor=Oz,t("UIVertexFormat",Object.freeze({__proto__:null,vfmt:Iz,vfmtPosColor:Rz,vfmtPosUvColor:Mz,vfmtPosUvTwoColor:Oz,getComponentPerVertex:Bz,getAttributeStride:Nz}));const sV=Rz.concat([new Wr("a_dist",Os.R32F)]),rV=Bz(sV),oV=Nz(sV);let aV=function(e){return t({Graphics:e,GraphicsComponent:e}),e}((Lz=Vl("cc.Graphics"),Fz=ec(),zz=Gl(110),Vz=Jl(),Uz=yc(pz),Gz=rc(),kz=yc(mz),Hz=rc(),jz=rc(),Wz=rc(),qz=rc(),Xz=nc(),Lz(Yz=Fz(Yz=zz(Yz=Vz((nV=iV=class t extends iF{get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t,this.impl&&(this.impl.lineWidth=t)}get lineJoin(){return this._lineJoin}set lineJoin(t){this._lineJoin=t,this.impl&&(this.impl.lineJoin=t)}get lineCap(){return this._lineCap}set lineCap(t){this._lineCap=t,this.impl&&(this.impl.lineCap=t)}get strokeColor(){return this._strokeColor}set strokeColor(t){this.impl&&(this._strokeColor.set(t),this.impl.strokeColor=this._strokeColor)}get fillColor(){return this._fillColor}set fillColor(t){this.impl&&(this._fillColor.set(t),this.impl.fillColor=this._fillColor)}get miterLimit(){return this._miterLimit}set miterLimit(t){this._miterLimit=t}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){}constructor(){super(),this.impl=null,this.model=null,Tl(this,"_lineWidth",$z,this),Tl(this,"_strokeColor",Jz,this),Tl(this,"_lineJoin",Zz,this),Tl(this,"_lineCap",Qz,this),Tl(this,"_fillColor",tV,this),Tl(this,"_miterLimit",eV,this),this._isDrawing=!1,this._isNeedUploadData=!0,this._graphicsUseSubMeshes=[],this._instanceMaterialType=eF.ADD_COLOR,this.impl=new Dz}onRestore(){this.impl||this._flushAssembler()}onLoad(){this.model=Mw.root.createModel(xg),this.model.node=this.model.transform=this.node,this._flushAssembler()}onEnable(){super.onEnable(),this._updateMtlForGraphics()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._sceneGetter=null,this.model&&(Mw.root.destroyModel(this.model),this.model=null);const t=this._graphicsUseSubMeshes.length;if(t>0){for(let e=0;e<t;++e)this._graphicsUseSubMeshes[e].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null)}moveTo(t,e){this.impl&&this.impl.moveTo(t,e)}lineTo(t,e){this.impl&&this.impl.lineTo(t,e)}bezierCurveTo(t,e,i,n,s,r){this.impl&&this.impl.bezierCurveTo(t,e,i,n,s,r)}quadraticCurveTo(t,e,i,n){this.impl&&this.impl.quadraticCurveTo(t,e,i,n)}arc(t,e,i,n,s,r){this.impl&&this.impl.arc(t,e,i,n,s,r)}ellipse(t,e,i,n){this.impl&&this.impl.ellipse(t,e,i,n)}circle(t,e,i){this.impl&&this.impl.circle(t,e,i)}rect(t,e,i,n){this.impl&&this.impl.rect(t,e,i,n)}roundRect(t,e,i,n,s){this.impl&&this.impl.roundRect(t,e,i,n,s)}fillRect(t,e,i,n){this.rect(t,e,i,n),this.fill()}clear(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(let t=0;t<this.model.subModels.length;t++)this.model.subModels[t].inputAssembler.indexCount=0;this.markForUpdateRenderData()}}close(){this.impl&&this.impl.close()}stroke(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)}fill(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)}_updateMtlForGraphics(){let t;this._customMaterial?t=this.getMaterialInstance(0):(t=rg.get("ui-graphics-material"),this.setMaterial(t,0),t=this.getMaterialInstance(0),t.recompileShaders({USE_LOCAL:!0}))}activeSubModel(t){if(this.model){if(this.model.subModels.length<=t){const e=n.director.root.device,i=e.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.DEVICE,65535*oV,oV)),s=e.createBuffer(new Pr(Ls.INDEX|Ls.TRANSFER_DST,Vs.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new Qb([i],sV,sr.TRIANGLE_LIST,s);r.subMeshIdx=0,this.model.initSubModel(t,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else A(4500,this.node.name)}_uploadData(t){const e=this.impl;if(!e)return;const i=e&&e.getRenderDataList();if(i.length<=0||!this.model)return;const n=this.model.subModels;for(let t=0;t<i.length;t++){const e=i[t],s=n[t].inputAssembler;if(e.lastFilledVertex===e.vertexStart)continue;const r=new Float32Array(e.vData.buffer,0,e.vertexStart*rV);s.vertexBuffers[0].update(r),s.vertexCount=e.vertexStart;const o=new Uint16Array(e.iData.buffer,0,e.indicesStart);s.indexBuffer.update(o),s.indexCount=e.indicesStart,e.lastFilledVertex=e.vertexStart,e.lastFilledIndices=e.indicesStart}t.removeUploadBuffersFunc(this),this._isNeedUploadData=!1}_render(t){if(this._isNeedUploadData){if(this.impl){const t=this.impl.getRenderDataList(),e=this.model.subModels.length;if(t.length>e)for(let i=e;i<t.length;i++)this.activeSubModel(i)}t.addUploadBuffersFunc(this,this._uploadData)}t.commitModel(this,this.model,this.getMaterialInstance(0))}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)}_canRender(){return!!super._canRender()&&!!this.model&&this._isDrawing}},iV.LineJoin=pz,iV.LineCap=mz,wl((Kz=nV).prototype,"lineWidth",[ic],Object.getOwnPropertyDescriptor(Kz.prototype,"lineWidth"),Kz.prototype),wl(Kz.prototype,"lineJoin",[Uz,Gz],Object.getOwnPropertyDescriptor(Kz.prototype,"lineJoin"),Kz.prototype),wl(Kz.prototype,"lineCap",[kz,Hz],Object.getOwnPropertyDescriptor(Kz.prototype,"lineCap"),Kz.prototype),wl(Kz.prototype,"strokeColor",[jz],Object.getOwnPropertyDescriptor(Kz.prototype,"strokeColor"),Kz.prototype),wl(Kz.prototype,"fillColor",[Wz],Object.getOwnPropertyDescriptor(Kz.prototype,"fillColor"),Kz.prototype),wl(Kz.prototype,"miterLimit",[qz],Object.getOwnPropertyDescriptor(Kz.prototype,"miterLimit"),Kz.prototype),wl(Kz.prototype,"color",[vc,Xz],Object.getOwnPropertyDescriptor(Kz.prototype,"color"),Kz.prototype),$z=wl(Kz.prototype,"_lineWidth",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Jz=wl(Kz.prototype,"_strokeColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.BLACK.clone()}}),Zz=wl(Kz.prototype,"_lineJoin",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pz.MITER}}),Qz=wl(Kz.prototype,"_lineCap",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mz.BUTT}}),tV=wl(Kz.prototype,"_fillColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.WHITE.clone()}}),eV=wl(Kz.prototype,"_miterLimit",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),Yz=Kz))||Yz)||Yz)||Yz)||Yz));var lV,cV,hV,_V,uV,mV,pV,dV,fV,gV,yV,vV,xV,bV,SV,AV,CV,TV,wV,EV,PV,DV,IV,RV,MV;const OV=new $i,BV=new tn,NV=new $i,LV=[];let FV;!function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",t[t.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(FV||(FV={})),zt(FV);let zV=function(e){return t({Mask:e,MaskComponent:e}),e}((lV=Vl("cc.Mask"),cV=ec(),hV=Gl(110),_V=Jl(),uV=yc(FV),mV=_c(),pV=rc(),dV=_c(),fV=rc(),gV=nc(),yV=yc(pN),vV=nc(),xV=nc(),bV=oc(),SV=nc(),AV=nc(),lV(CV=cV(CV=hV(CV=_V((MV=RV=class t extends iF{get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==FV.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}get inverted(){return this._inverted}set inverted(t){this._inverted=t,this.stencilStage=BL.DISABLED,this._graphics&&(this._graphics.stencilStage=BL.DISABLED)}get segments(){return this._segments}set segments(t){this._segments!==t&&(this._segments=ui(t,3,1e4),this._updateGraphics())}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this._type===FV.IMAGE_STENCIL&&!e&&t&&this.markForUpdateRenderData()}get alphaThreshold(){return this._alphaThreshold}set alphaThreshold(t){this._alphaThreshold!==t&&(this._alphaThreshold=t,this.type===FV.IMAGE_STENCIL&&this._graphics)&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold)}get graphics(){return this._graphics}get dstBlendFactor(){return this._dstBlendFactor}set dstBlendFactor(t){this._dstBlendFactor!==t&&(this._dstBlendFactor=t,this._updateBlendFunc())}get srcBlendFactor(){return this._srcBlendFactor}set srcBlendFactor(t){this._srcBlendFactor!==t&&(this._srcBlendFactor=t,this._updateBlendFunc())}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this.markForUpdateRenderData())}get customMaterial(){return this._customMaterial}set customMaterial(t){}constructor(){super(),this._clearStencilMtl=null,this._clearModel=null,Tl(this,"_type",wV,this),Tl(this,"_inverted",EV,this),Tl(this,"_segments",PV,this),Tl(this,"_spriteFrame",DV,this),Tl(this,"_alphaThreshold",IV,this),this._graphics=null,this._clearModelMesh=null,this._instanceMaterialType=eF.ADD_COLOR}onLoad(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()}onEnable(){super.onEnable(),this._updateGraphics()}onRestore(){this._createGraphics(),super.updateMaterial(),this._updateGraphics(),this._renderFlag=this._canRender()}onDisable(){super.onDisable(),this._disableGraphics()}onDestroy(){super.onDestroy(),this._clearModel&&this._clearModelMesh&&(Mw.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics()}isHit(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=i.width,s=i.height,r=BV;this.node.getWorldMatrix(OV),$i.invert(NV,OV),tn.transformMat4(r,t,NV);const o=e.anchorPoint;r.x+=o.x*n,r.y+=o.y*s;let a=!1;if(this.type===FV.RECT||this.type===FV.GRAPHICS_STENCIL)a=r.x>=0&&r.y>=0&&r.x<=n&&r.y<=s;else if(this.type===FV.ELLIPSE){const t=n/2,e=s/2,i=r.x-.5*n,o=r.y-.5*s;a=i*i/(t*t)+o*o/(e*e)<1}return this._inverted&&(a=!a),a}_render(t){t.commitComp(this,null,this._assembler,null)}_postRender(t){this._postAssembler&&t.commitComp(this,null,this._postAssembler,null)}_nodeStateChange(t){super._nodeStateChange(t),this._updateGraphics()}_canRender(){return!!super._canRender()&&null!==this._graphics&&(this._type!==FV.IMAGE_STENCIL||null!==this._spriteFrame)}_flushAssembler(){const e=t.Assembler.getAssembler(this),i=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==i&&(this._postAssembler=i),this._useRenderData()}_createGraphics(){if(!this._graphics){const t=this._graphics=new aV;t._objFlags|=Me.Flags.IsOnLoadCalled,t.node=this.node,t.node.getWorldMatrix(),t.lineWidth=0;const e=Ri.WHITE.clone();e.a=0,t.fillColor=e}this._updateMaterial()}_updateGraphics(){if(!this._graphics||this._type!==FV.RECT&&this._type!==FV.ELLIPSE)return;const t=this.node._uiProps.uiTransformComp,e=this._graphics;e.clear();const i=t.contentSize,n=i.width,s=i.height,r=t.anchorPoint,o=-n*r.x,a=-s*r.y;if(this._type===FV.RECT)e.rect(o,a,n,s);else if(this._type===FV.ELLIPSE){const t=function(t,e,i){LV.length=0;const n=2*Math.PI/i;for(let s=0;s<i;++s)LV.push(new Ni(e.x*Math.cos(n*s)+t.x,e.y*Math.sin(n*s)+t.y,0));return LV}(new Ni(o+n/2,a+s/2,0),new Ni(n/2,s/2,0),this._segments);for(let i=0;i<t.length;++i){const n=t[i];0===i?e.moveTo(n.x,n.y):e.lineTo(n.x,n.y)}e.close()}e.fill()}_createClearModel(){if(!this._clearModel){const t=rg.get("default-clear-stencil");this._clearStencilMtl=new ny({parent:t,owner:this,subModelIdx:0}),this._clearModel=Mw.root.createModel(xg),this._clearModel.node=this._clearModel.transform=this.node;const e=Nz(Iz),i=n.director.root.device,s=i.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.DEVICE,4*e,e)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);s.update(r);const o=i.createBuffer(new Pr(Ls.INDEX|Ls.TRANSFER_DST,Vs.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new Qb([s],Iz,sr.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}}_updateMaterial(){if(this._graphics){const t=this._graphics;let e;t.stencilStage=BL.DISABLED,this._type===FV.IMAGE_STENCIL?(e=rg.get("ui-alpha-test-material"),t.setMaterial(e,0),e=t.getMaterialInstance(0),e.setProperty("alphaThreshold",this._alphaThreshold)):(e=rg.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}}_disableGraphics(){this._graphics&&this._graphics.onDisable()}_removeGraphics(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)}_useRenderData(){this._type!==FV.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())}},RV.Type=FV,wl((TV=MV).prototype,"type",[uV,mV,pV],Object.getOwnPropertyDescriptor(TV.prototype,"type"),TV.prototype),wl(TV.prototype,"inverted",[dV,fV],Object.getOwnPropertyDescriptor(TV.prototype,"inverted"),TV.prototype),wl(TV.prototype,"segments",[gV],Object.getOwnPropertyDescriptor(TV.prototype,"segments"),TV.prototype),wl(TV.prototype,"spriteFrame",[yV,vV],Object.getOwnPropertyDescriptor(TV.prototype,"spriteFrame"),TV.prototype),wl(TV.prototype,"alphaThreshold",[xV,bV,hc],Object.getOwnPropertyDescriptor(TV.prototype,"alphaThreshold"),TV.prototype),wl(TV.prototype,"color",[vc,SV],Object.getOwnPropertyDescriptor(TV.prototype,"color"),TV.prototype),wl(TV.prototype,"customMaterial",[vc,AV],Object.getOwnPropertyDescriptor(TV.prototype,"customMaterial"),TV.prototype),wV=wl(TV.prototype,"_type",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FV.RECT}}),EV=wl(TV.prototype,"_inverted",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),PV=wl(TV.prototype,"_segments",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),DV=wl(TV.prototype,"_spriteFrame",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IV=wl(TV.prototype,"_alphaThreshold",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),CV=TV))||CV)||CV)||CV)||CV));dS._comp=zV,n.Mask=zV;const VV=/^(click)(\s)*=|(param)(\s)*=/,UV=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;class GV{constructor(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}parse(t){this._resultObjectArray.length=0,this._stack.length=0;let e=0;const i=t.length;for(;e<i;){let n=t.indexOf(">",e),s=-1;if(n>=0&&(s=t.lastIndexOf("<",n),s<e-1&&(s=t.indexOf("<",n+1),n=t.indexOf(">",s+1))),s<0)this._stack.pop(),this._processResult(t.substring(e)),e=i;else{let i=t.substring(e,s);const r=t.substring(s+1,n);""===r&&(i=t.substring(e,n+1)),this._processResult(i),-1===n?n=s:"/"===t.charAt(s+1)?this._stack.pop():this._addToStack(r),e=n+1}}return this._resultObjectArray}_attributeToObject(t){t=t.trim();const e={};let i=/^(color|size)(\s)*=/.exec(t),n="",s=0,r="";if(i){if(n=i[0],""===(t=t.substring(n.length).trim()))return e;switch(s=t.indexOf(" "),n[0]){case"c":e.color=s>-1?t.substring(0,s).trim():t;break;case"s":e.size=parseInt(t)}return s>-1&&(r=t.substring(s+1).trim(),e.event=this._processEventHandler(r)),e}if(i=/^(br(\s)*\/)/.exec(t),i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("br")&&"/"===n[n.length-1]))return e.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),e;i=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(t);let o="";if(i&&i[0].length>0&&(n=i[0].trim(),n.startsWith("img")&&"/"===n[n.length-1])){let r;i=UV.exec(t);let a=!1;for(;i;){if(n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(n.length).trim(),s=o.indexOf(" "),r=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),t=o.substring(s).trim(),r.endsWith("/")&&(r=r.slice(0,-1)),"src"===n){switch(r.charCodeAt(0)){case 34:case 39:a=!0,r=r.slice(1,-1)}e.isImage=!0,e.src=r}else if("height"===n)e.imageHeight=parseInt(r);else if("width"===n)e.imageWidth=parseInt(r);else if("align"===n){switch(r.charCodeAt(0)){case 34:case 39:r=r.slice(1,-1)}e.imageAlign=r.toLowerCase()}else"offset"===n?e.imageOffset=r:"click"===n&&(e.event=this._processEventHandler(`${n}=${r}`));e.event&&"param"===n&&(e.event[n]=r.replace(/^"|"$/g,"")),i=UV.exec(t)}return a&&e.isImage&&this._resultObjectArray.push({text:"",style:e}),{}}if(i=/^(outline(\s)*[^>]*)/.exec(t),i){const r={color:"#ffffff",width:1};if(t=i[0].substring("outline".length).trim()){const a=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;let l;for(i=a.exec(t);i;)n=(t=t.substring(t.indexOf(i[0]))).substr(0,i[0].length),o=t.substring(n.length).trim(),s=o.indexOf(" "),l=s>-1?o.substr(0,s):o,n=n.replace(/[^a-zA-Z]/g,"").trim(),n=n.toLowerCase(),t=o.substring(s).trim(),"click"===n?e.event=this._processEventHandler(`${n}=${l}`):"color"===n?r.color=l:"width"===n&&(r.width=parseInt(l)),e.event&&"param"===n&&(e.event[n]=l.replace(/^"|"$/g,"")),i=a.exec(t)}e.outline=r}if(i=/^(on|u|b|i)(\s)*/.exec(t),i&&i[0].length>0){switch(n=i[0],t=t.substring(n.length).trim(),n[0]){case"u":e.underline=!0;break;case"i":e.italic=!0;break;case"b":e.bold=!0}if(""===t)return e;e.event=this._processEventHandler(t)}return e}_processEventHandler(t){const e={};let i=0,n=!1,s=VV.exec(t);for(;s;){let r=s[0],o="";if(n=!1,'"'===(t=t.substring(r.length).trim()).charAt(0))i=t.indexOf('"',1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else if("'"===t.charAt(0))i=t.indexOf("'",1),i>-1&&(o=t.substring(1,i).trim(),n=!0),i++;else{const e=/(\S)+/.exec(t);o=e?e[0]:"",i=o.length}n&&(r=r.substring(0,r.length-1).trim(),e[r]=o),t=t.substring(i).trim(),s=VV.exec(t)}return e}_addToStack(t){const e=this._attributeToObject(t);if(0===this._stack.length)this._stack.push(e);else{if(e.isNewLine||e.isImage)return;const t=this._stack[this._stack.length-1];for(const i in t)e[i]||(e[i]=t[i]);this._stack.push(e)}}_processResult(t){0!==t.length&&(t=this._escapeSpecialSymbol(t),this._stack.length>0?this._resultObjectArray.push({text:t,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:t}))}_escapeSpecialSymbol(t){for(const e of this._specialSymbolArray){const i=e[0],n=e[1];t=t.replace(i,n)}return t}}var kV,HV,jV,WV,qV,XV,YV,KV,$V,JV,ZV;t("HtmlTextParser",GV);let QV=function(e){return t({LabelOutline:e,LabelOutlineComponent:e}),e}((kV=Vl("cc.LabelOutline"),HV=ec(),jV=Gl(110),WV=Jl(),qV=Ul(fz),XV=rc(),YV=rc(),kV(KV=HV(KV=jV(KV=WV(KV=qV(KV=$l((JV=wl(($V=class extends Rh{constructor(...t){super(...t),Tl(this,"_color",JV,this),Tl(this,"_width",ZV,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get width(){return this._width}set width(t){this._width!==t&&(this._width=t,this._updateRenderData())}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(fz);t&&t.updateRenderData(!0)}}).prototype,"_color",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(0,0,0,255)}}),ZV=wl($V.prototype,"_width",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),wl($V.prototype,"color",[XV],Object.getOwnPropertyDescriptor($V.prototype,"color"),$V.prototype),wl($V.prototype,"width",[YV],Object.getOwnPropertyDescriptor($V.prototype,"width"),$V.prototype),KV=$V))||KV)||KV)||KV)||KV)||KV)||KV));var tU,eU,iU,nU,sU,rU,oU,aU,lU,cU,hU,_U,uU,mU,pU,dU,fU,gU,yU,vU,xU,bU,SU,AU,CU,TU,wU,EU,PU,DU,IU,RU,MU,OU,BU,NU,LU,FU,zU,VU,UU,GU,kU;!function(t){t[t.SIMPLE=0]="SIMPLE",t[t.SLICED=1]="SLICED",t[t.TILED=2]="TILED",t[t.FILLED=3]="FILLED"}(VU||(VU={})),zt(VU),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.RADIAL=2]="RADIAL"}(UU||(UU={})),zt(UU),function(t){t[t.CUSTOM=0]="CUSTOM",t[t.TRIMMED=1]="TRIMMED",t[t.RAW=2]="RAW"}(GU||(GU={})),zt(GU),function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(kU||(kU={}));let HU=function(e){return t({Sprite:e,SpriteComponent:e}),e}((tU=Vl("cc.Sprite"),eU=ec(),iU=Gl(110),nU=Jl(),sU=yc(yN),rU=_c(),oU=rc(),aU=yc(pN),lU=_c(),cU=rc(),hU=yc(VU),_U=_c(),uU=rc(),mU=yc(UU),pU=rc(),dU=rc(),fU=oc(),gU=rc(),yU=oc(),vU=rc(),xU=_c(),bU=rc(),SU=yc(GU),AU=_c(),CU=rc(),tU(TU=eU(TU=iU(TU=nU((zU=FU=class t extends iF{constructor(...t){super(...t),Tl(this,"_spriteFrame",EU,this),Tl(this,"_type",PU,this),Tl(this,"_fillType",DU,this),Tl(this,"_sizeMode",IU,this),Tl(this,"_fillCenter",RU,this),Tl(this,"_fillStart",MU,this),Tl(this,"_fillRange",OU,this),Tl(this,"_isTrimmedMode",BU,this),Tl(this,"_useGrayscale",NU,this),Tl(this,"_atlas",LU,this)}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(!1),this._applySpriteFrame(e)}get type(){return this._type}set type(t){this._type!==t&&(this._type=t,this._flushAssembler())}get fillType(){return this._fillType}set fillType(t){this._fillType!==t&&(t===UU.RADIAL||this._fillType===UU.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=t,this._flushAssembler()}get fillCenter(){return this._fillCenter}set fillCenter(t){this._fillCenter.x=t.x,this._fillCenter.y=t.y,this._type===VU.FILLED&&this._renderData&&this.markForUpdateRenderData()}get fillStart(){return this._fillStart}set fillStart(t){this._fillStart=ui(t,-1,1),this._type===VU.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get fillRange(){return this._fillRange}set fillRange(t){this._fillRange=ui(t,-1,1),this._type===VU.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._renderData.uvDirty=!0)}get trim(){return this._isTrimmedMode}set trim(t){this._isTrimmedMode!==t&&(this._isTrimmedMode=t,this._type===VU.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}get grayscale(){return this._useGrayscale}set grayscale(t){this._useGrayscale!==t&&(this._useGrayscale=t,this._instanceMaterialType=!0===t?eF.GRAYSCALE:eF.ADD_COLOR_AND_TEXTURE,this.updateMaterial())}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==GU.CUSTOM&&this._applySpriteSize())}__preload(){this.changeMaterialForDefine(),super.__preload()}onEnable(){super.onEnable(),this._activateMaterial(),this._markForUpdateUvDirty()}onDestroy(){this.destroyRenderData(),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let i=!1;if(t instanceof lf){const e=t.getPixelFormat();i=e===Rd.RGBA_ETC1||e===Rd.RGB_A_PVRTC_4BPPV1||e===Rd.RGB_A_PVRTC_2BPPV1}i&&this.grayscale?this._instanceMaterialType=eF.USE_ALPHA_SEPARATED_AND_GRAY:i?this._instanceMaterialType=eF.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=eF.GRAYSCALE:this._instanceMaterialType=eF.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof Wb){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},i=new $g;i.initialize({effectAsset:t.effectAsset,defines:e}),t=i}return t}_render(t){t.commitComp(this,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.texture)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(GU.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(GU.TRIMMED===this._sizeMode){const t=this._spriteFrame.getRect();this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}}_resized(){}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=e)}_applySpriteFrame(t){const e=this._spriteFrame;this._renderData&&(this._renderData.uvDirty||(this._renderData.uvDirty=!t||!e||t.uvHash!==e.uvHash),this._renderDataFlag=this._renderData.uvDirty);let i=!1;e&&(t&&t.texture===e.texture||(i=!0),i&&this.changeMaterialForDefine(),this._applySpriteSize())}_markForUpdateUvDirty(){this._renderData&&(this._renderData.uvDirty=!0,this._renderDataFlag=!0)}},FU.FillType=UU,FU.Type=VU,FU.SizeMode=GU,FU.EventType=kU,wl((wU=zU).prototype,"spriteAtlas",[sU,rU,oU],Object.getOwnPropertyDescriptor(wU.prototype,"spriteAtlas"),wU.prototype),wl(wU.prototype,"spriteFrame",[aU,lU,cU],Object.getOwnPropertyDescriptor(wU.prototype,"spriteFrame"),wU.prototype),wl(wU.prototype,"type",[hU,_U,uU],Object.getOwnPropertyDescriptor(wU.prototype,"type"),wU.prototype),wl(wU.prototype,"fillType",[mU,pU],Object.getOwnPropertyDescriptor(wU.prototype,"fillType"),wU.prototype),wl(wU.prototype,"fillCenter",[dU],Object.getOwnPropertyDescriptor(wU.prototype,"fillCenter"),wU.prototype),wl(wU.prototype,"fillStart",[fU,gU],Object.getOwnPropertyDescriptor(wU.prototype,"fillStart"),wU.prototype),wl(wU.prototype,"fillRange",[yU,vU],Object.getOwnPropertyDescriptor(wU.prototype,"fillRange"),wU.prototype),wl(wU.prototype,"trim",[xU,bU],Object.getOwnPropertyDescriptor(wU.prototype,"trim"),wU.prototype),wl(wU.prototype,"grayscale",[ic],Object.getOwnPropertyDescriptor(wU.prototype,"grayscale"),wU.prototype),wl(wU.prototype,"sizeMode",[SU,AU,CU],Object.getOwnPropertyDescriptor(wU.prototype,"sizeMode"),wU.prototype),EU=wl(wU.prototype,"_spriteFrame",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PU=wl(wU.prototype,"_type",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return VU.SIMPLE}}),DU=wl(wU.prototype,"_fillType",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return UU.HORIZONTAL}}),IU=wl(wU.prototype,"_sizeMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GU.TRIMMED}}),RU=wl(wU.prototype,"_fillCenter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn(0,0)}}),MU=wl(wU.prototype,"_fillStart",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OU=wl(wU.prototype,"_fillRange",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BU=wl(wU.prototype,"_isTrimmedMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),NU=wl(wU.prototype,"_useGrayscale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),LU=wl(wU.prototype,"_atlas",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TU=wU))||TU)||TU)||TU)||TU));var jU;let WU=t("RenderRoot2D",Vl("cc.RenderRoot2D")(jU=Gl(100)(jU=Jl()(jU=Ul(NL)(jU=kl(jU=$l(jU=class extends Rh{onEnable(){n.director.root.batcher2D.addScreen(this)}onDisable(){n.director.root.batcher2D.removeScreen(this)}onDestroy(){n.director.root.batcher2D.removeScreen(this)}})||jU)||jU)||jU)||jU)||jU)||jU);var qU,XU,YU,KU,$U,JU,ZU,QU,tG,eG,iG,nG;const sG=new Ni,rG=Nt({OVERLAY:0,INTERSPERSE:1});let oG=function(e){return t({Canvas:e,CanvasComponent:e}),e}((qU=Vl("cc.Canvas"),XU=ec(),YU=Gl(100),KU=Jl(),$U=yc(wD),JU=rc(),ZU=rc(),QU=yc(wD),qU(tG=XU(tG=YU(tG=KU(tG=$l(tG=kl((wl((eG=class extends WU{get renderMode(){return this._renderMode}set renderMode(t){this._renderMode=t,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}get cameraComponent(){return this._cameraComponent}set cameraComponent(t){this._cameraComponent!==t&&(this._cameraComponent=t,this._onResizeCamera())}get alignCanvasWithScreen(){return this._alignCanvasWithScreen}set alignCanvasWithScreen(t){this._alignCanvasWithScreen=t,this._onResizeCamera()}constructor(){super(),Tl(this,"_cameraComponent",iG,this),Tl(this,"_alignCanvasWithScreen",nG,this),this._thisOnCameraResized=void 0,this._fitDesignResolution=void 0,this._pos=new Ni,this._renderMode=rG.OVERLAY,this._thisOnCameraResized=this._onResizeCamera.bind(this)}__preload(){const t=this.getComponent("cc.Widget");t&&t.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(wD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(ev.TRANSFORM_CHANGED,this._thisOnCameraResized)}onEnable(){super.onEnable(),this._cameraComponent&&this._cameraComponent.node.on(wD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDisable(){super.onDisable(),this._cameraComponent&&this._cameraComponent.node.off(wD.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)}onDestroy(){super.onDestroy(),this.node.off(ev.TRANSFORM_CHANGED,this._thisOnCameraResized)}_onResizeCamera(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture){const t=this._cameraComponent.targetTexture.window;this._cameraComponent.camera&&this._cameraComponent.camera.setFixedSize(t.width,t.height),this._cameraComponent.orthoHeight=uw.height/2}else if(_w.canvas){const t=_w.canvas;this._cameraComponent.camera&&this._cameraComponent.camera.resize(t.width,t.height),this._cameraComponent.orthoHeight=_w.canvas.height/vw.getScaleY()/2}this.node.getWorldPosition(sG),this._cameraComponent.node.setWorldPosition(sG.x,sG.y,1e3)}}_getViewPriority(){if(this._cameraComponent){var t;let e=null===(t=this.cameraComponent)||void 0===t?void 0:t.priority;return e=this._renderMode===rG.OVERLAY?e|1<<30:e&~(1<<30),e}return 0}}).prototype,"cameraComponent",[$U,JU],Object.getOwnPropertyDescriptor(eG.prototype,"cameraComponent"),eG.prototype),wl(eG.prototype,"alignCanvasWithScreen",[ZU],Object.getOwnPropertyDescriptor(eG.prototype,"alignCanvasWithScreen"),eG.prototype),iG=wl(eG.prototype,"_cameraComponent",[QU],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),nG=wl(eG.prototype,"_alignCanvasWithScreen",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tG=eG))||tG)||tG)||tG)||tG)||tG)||tG));var aG;n.Canvas=oG;let lG=t("UIComponent",Vl("cc.UIComponent")(aG=Ul(NL)(aG=Gl(110)(aG=kl(aG=$l(aG=class extends Rh{constructor(...t){super(...t),this._lastParent=null,this.stencilStage=BL.DISABLED}__preload(){this.node._uiProps.uiComp=this}onEnable(){}onDisable(){}onDestroy(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)}updateAssembler(t){}postUpdateAssembler(t){}markForUpdateRenderData(t=!0){}})||aG)||aG)||aG)||aG)||aG);var cG,hG,_G,uG,mG,pG,dG,fG,gG,yG,vG,xG,bG,SG,AG,CG,TG,wG,EG,PG,DG,IG,RG,MG,OG,BG,NG,LG,FG,zG,VG,UG,GG,kG,HG;Qe(lG.prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),Ze(oG.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearFlags=t)}},{name:"color",newName:"cameraComponent.clearColor",customGetter(){return this._cameraComponent?this._cameraComponent.clearColor:Ri.BLACK},customSetter(t){this._cameraComponent&&(this._cameraComponent.clearColor=t)}},{name:"priority",newName:"cameraComponent.priority",customGetter(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter(t){this._cameraComponent&&(this._cameraComponent.priority=t)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter(t){this._cameraComponent&&(this._cameraComponent.targetTexture=t)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),ti(iF.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),ti(NL.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),n.UITransformComponent=NL,Ot.setClassAlias(NL,"cc.UITransformComponent"),Ot.setClassAlias(iF,"cc.RenderComponent"),n.CanvasComponent=oG,Ot.setClassAlias(oG,"cc.CanvasComponent");const jG=new GV,WG="RICHTEXT_CHILD",qG="RICHTEXT_Image_CHILD",XG=new Rt((t=>{if(!n.isValid(t.node))return!1;{const e=t.node.getComponent(QV);e&&(e.width=0)}return!0}),20),YG=new Rt((t=>n.isValid(t.node)),10);function KG(t){return{node:new Yv(t),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:t}}function $G(t,e){let i;t===WG?i=XG._get():t===qG&&(i=YG._get()),i=i||KG(t);let n=i.node;return n||(n=new Yv(t)),n.hideFlags|=Me.Flags.DontSave|Me.Flags.HideInHierarchy,t===qG?(i.comp=n.getComponent(HU)||n.addComponent(HU),i.comp.spriteFrame=e,i.comp.type=HU.Type.SLICED,i.comp.sizeMode=HU.SizeMode.CUSTOM):(i.comp=n.getComponent(fz)||n.addComponent(fz),i.comp.string=e,i.comp.horizontalAlign=cz.LEFT,i.comp.verticalAlign=hz.TOP),n.setPosition(0,0,0),n._uiProps.uiTransformComp.setAnchorPoint(.5,.5),i.node=n,i.lineCount=0,i.styleIndex=0,i.imageOffset="",i.clickParam="",i.clickHandler="",i}let JG=function(e){return t({RichText:e,RichTextComponent:e}),e}((cG=Vl("cc.RichText"),hG=ec(),_G=Gl(110),uG=Jl(),mG=rc(),pG=yc(cz),dG=rc(),fG=rc(),gG=rc(),yG=yc(xN),vG=rc(),xG=rc(),bG=yc(uz),SG=rc(),AG=rc(),CG=rc(),TG=yc(yN),wG=rc(),EG=rc(),cG(PG=hG(PG=_G(PG=uG(PG=$l((HG=kG=class extends lG{get string(){return this._string}set string(t){this._string!==t&&(this._string=t,this._updateRichTextStatus())}get horizontalAlign(){return this._horizontalAlign}set horizontalAlign(t){this.horizontalAlign!==t&&(this._horizontalAlign=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontSize(){return this._fontSize}set fontSize(t){this._fontSize!==t&&(this._fontSize=t,this._layoutDirty=!0,this._updateRichTextStatus())}get fontFamily(){return this._fontFamily}set fontFamily(t){this._fontFamily!==t&&(this._fontFamily=t,this._layoutDirty=!0,this._updateRichTextStatus())}get font(){return this._font}set font(t){this._font!==t&&(this._font=t,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}get useSystemFont(){return this._isSystemFontUsed}set useSystemFont(t){this._isSystemFontUsed!==t&&(this._isSystemFontUsed=t,this._layoutDirty=!0,this._updateRichTextStatus())}get cacheMode(){return this._cacheMode}set cacheMode(t){this._cacheMode!==t&&(this._cacheMode=t,this._updateRichTextStatus())}get maxWidth(){return this._maxWidth}set maxWidth(t){this._maxWidth!==t&&(this._maxWidth=t,this._layoutDirty=!0,this._updateRichTextStatus())}get lineHeight(){return this._lineHeight}set lineHeight(t){this._lineHeight!==t&&(this._lineHeight=t,this._layoutDirty=!0,this._updateRichTextStatus())}get imageAtlas(){return this._imageAtlas}set imageAtlas(t){this._imageAtlas!==t&&(this._imageAtlas=t,this._layoutDirty=!0,this._updateRichTextStatus())}get handleTouchEvent(){return this._handleTouchEvent}set handleTouchEvent(t){this._handleTouchEvent!==t&&(this._handleTouchEvent=t,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}constructor(){super(),Tl(this,"_lineHeight",IG,this),Tl(this,"_string",RG,this),Tl(this,"_horizontalAlign",MG,this),Tl(this,"_fontSize",OG,this),Tl(this,"_maxWidth",BG,this),Tl(this,"_fontFamily",NG,this),Tl(this,"_font",LG,this),Tl(this,"_isSystemFontUsed",FG,this),Tl(this,"_userDefinedFont",zG,this),Tl(this,"_cacheMode",VG,this),Tl(this,"_imageAtlas",UG,this),Tl(this,"_handleTouchEvent",GG,this),this._textArray=[],this._segments=[],this._labelSegmentsCache=[],this._linesWidth=[],this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0,this._lineOffsetX=0,this._updateRichTextStatus=void 0,this._updateRichTextStatus=this._updateRichText}onLoad(){this.node.on(ev.LAYER_CHANGED,this._applyLayer,this)}onEnable(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)}onDisable(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)}start(){this._onTTFLoaded(),this.node.on(ev.ANCHOR_CHANGED,this._updateRichTextPosition,this)}onRestore(){}onDestroy(){for(const t of this._segments)t.node.removeFromParent(),t.type===WG?XG.put(t):t.type===qG&&YG.put(t);this.node.off(ev.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(ev.LAYER_CHANGED,this._applyLayer,this)}_addEventListeners(){this.node.on(ev.TOUCH_END,this._onTouchEnded,this)}_removeEventListeners(){this.node.off(ev.TOUCH_END,this._onTouchEnded,this)}_updateLabelSegmentTextAttributes(){this._segments.forEach((t=>{this._applyTextAttribute(t)}))}_createFontLabel(t){return $G(WG,t)}_createImage(t){return $G(qG,t)}_onTTFLoaded(){this._font,this._layoutDirty=!0,this._updateRichText()}_measureText(t,e){const i=e=>{let i;return 0===this._labelSegmentsCache.length?(i=this._createFontLabel(e),this._labelSegmentsCache.push(i)):(i=this._labelSegmentsCache[0],i.node.getComponent(fz).string=e),i.styleIndex=t,this._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return e?i(e):i}_onTouchEnded(t){const e=this.node.getComponents(Rh);for(const i of this._segments){const n=i.clickHandler,s=i.clickParam;n&&this._containsTouchLocation(i,t.touch.getUILocation())&&(e.forEach((e=>{const i=e[n];e.enabledInHierarchy&&i&&i.call(e,t,s)})),t.propagationStopped=!0)}}_containsTouchLocation(t,e){const i=t.node.getComponent(NL);return!!i&&i.getBoundingBoxToWorld().contains(e)}_resetState(){const t=this.node.children;for(let e=t.length-1;e>=0;e--){const i=t[e];if(i.name===WG||i.name===qG){i.parent===this.node?i.parent=null:t.splice(e,1);const n=KG(i.name);n.node=i,i.name===WG?(n.comp=i.getComponent(fz),XG.put(n)):(n.comp=i.getComponent(HU),YG.put(n))}}t.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0}_activateChildren(t){for(let e=this.node.children.length-1;e>=0;e--){const i=this.node.children[e];i.name!==WG&&i.name!==qG||(i.active=t)}}_addLabelSegment(t,e){let i;if(0===this._labelSegmentsCache.length)i=this._createFontLabel(t);else{i=this._labelSegmentsCache.pop();const e=i.node.getComponent(fz);e&&(e.string=t)}return i.styleIndex=e,i.lineCount=this._lineCount,i.node._uiProps.uiTransformComp.setAnchorPoint(0,0),i.node.layer=this.node.layer,this._applyTextAttribute(i),this.node.addChild(i.node),this._segments.push(i),i}_updateRichTextWithMaxWidth(t,e,i){let n,s=e;if(this._lineOffsetX>0&&s+this._lineOffsetX>this._maxWidth){let e=0;for(;this._lineOffsetX<=this._maxWidth;){const n=this._getFirstWordLen(t,e,t.length),r=t.substr(e,n),o=this._measureText(i,r);if(!(this._lineOffsetX+o<=this._maxWidth)){if(e>0){const n=t.substr(0,e);this._addLabelSegment(n,i),t=t.substr(e,t.length),s=this._measureText(i,t)}this._updateLineInfo();break}this._lineOffsetX+=o,e+=n}}if(s>this._maxWidth){const e=JN(t,s,this._maxWidth,this._measureText(i));for(let t=0;t<e.length;++t){const s=e[t];n=this._addLabelSegment(s,i);const r=n.node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=r.width,e.length>1&&t<e.length-1&&this._updateLineInfo()}}else this._lineOffsetX+=s,this._addLabelSegment(t,i)}_isLastComponentCR(t){return t.length-1===t.lastIndexOf("\n")}_updateLineInfo(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++}_needsUpdateTextLayout(t){if(this._layoutDirty||!this._textArray||!t)return!0;if(this._textArray.length!==t.length)return!0;for(let e=0;e<this._textArray.length;e++){const i=this._textArray[e],n=t[e];if(i.text!==n.text)return!0;{const t=i.style,e=n.style;if(t){if(e){if(!!e.outline!=!!t.outline)return!0;if(t.size!==e.size||t.italic!==e.italic||t.isImage!==e.isImage)return!0;if(t.src!==e.src||t.imageAlign!==e.imageAlign||t.imageHeight!==e.imageHeight||t.imageWidth!==e.imageWidth||t.imageOffset!==e.imageOffset)return!0}else if(t.size||t.italic||t.isImage||t.outline)return!0}else if(e&&(e.size||e.italic||e.isImage||e.outline))return!0}}return!1}_addRichTextImageElement(t){if(!t.style)return;const e=t.style,i=e.src,n=this._imageAtlas&&i&&this._imageAtlas.getSpriteFrame(i);if(n){const t=this._createImage(n);switch(t.comp,e.imageAlign){case"top":t.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":t.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:t.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.node.layer=this.node.layer,this.node.addChild(t.node),this._segments.push(t);const i=n.rect.clone();let s=1,r=i.width,o=i.height;const a=e.imageWidth||0,l=e.imageHeight||0;l>0?(s=l/o,r*=s,o*=s):(s=this._lineHeight/o,r*=s,o*=s),a>0&&(r=a),this._maxWidth>0?(this._lineOffsetX+r>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=r):(this._lineOffsetX+=r,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),t.node._uiProps.uiTransformComp.setContentSize(r,o),t.lineCount=this._lineCount,t.clickHandler="",t.clickParam="";const c=e.event;c&&(t.clickHandler=c.click,t.clickParam=c.param)}else A(4400)}_updateRichText(){if(!this.enabledInHierarchy)return;const t=jG.parse(this._string);if(!this._needsUpdateTextLayout(t))return this._textArray=t.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=t.slice(),this._resetState();let e,i=!1;for(let t=0;t<this._textArray.length;++t){const n=this._textArray[t],s=n.text;if(void 0===s)continue;if(""===s){if(n.style&&n.style.isNewLine){this._updateLineInfo();continue}if(n.style&&n.style.isImage&&this._imageAtlas){this._addRichTextImageElement(n);continue}}const r=s.split("\n");for(let n=0;n<r.length;++n){const o=r[n];if(""!==o)if(i=!1,this._maxWidth>0){const e=this._measureText(t,o);this._updateRichTextWithMaxWidth(o,e,t),r.length>1&&n<r.length-1&&this._updateLineInfo()}else e=this._addLabelSegment(o,t),this._lineOffsetX+=e.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),r.length>1&&n<r.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(s)&&n===r.length-1)continue;this._updateLineInfo(),i=!0}}}i||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+zN)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}_getFirstWordLen(t,e,i){let n=t.charAt(e);if(XN(n)||YN(n))return 1;let s=1;for(let r=e+1;r<i&&(n=t.charAt(r),!YN(n)&&!XN(n));++r)s++;return s}_updateRichTextPosition(){let t=0,e=1;const i=this._lineCount,n=this.node._uiProps.uiTransformComp,s=n.anchorX,r=n.anchorY;for(let n=0;n<this._segments.length;++n){const o=this._segments[n],a=o.lineCount;a>e&&(t=0,e=a);let l=this._labelWidth*(.5*this._horizontalAlign-s);switch(this._horizontalAlign){case cz.LEFT:break;case cz.CENTER:l-=this._linesWidth[a-1]/2;break;case cz.RIGHT:l-=this._linesWidth[a-1]}const c=o.node.position;if(o.node.setPosition(t+l,this._lineHeight*(i-a)-this._labelHeight*r,c.z),a===e&&(t+=o.node._uiProps.uiTransformComp.width),o.node.getComponent(HU)){const t=o.node.position.clone(),e=this._lineHeight,i=this._lineHeight*(1+zN);switch(o.node._uiProps.uiTransformComp.anchorY){case 1:t.y+=e+(i-e)/2;break;case.5:t.y+=i/2;break;default:t.y+=(i-e)/2}if(o.imageOffset){const e=o.imageOffset.split(",");if(1===e.length&&e[0]){const i=parseFloat(e[0]);Number.isInteger(i)&&(t.y+=i)}else if(2===e.length){const i=parseFloat(e[0]),n=parseFloat(e[1]);Number.isInteger(i)&&(t.x+=i),Number.isInteger(n)&&(t.y+=n)}}o.node.position=t}const h=o.node.getComponent(QV);if(h){const t=o.node.position.clone();t.y-=h.width,o.node.position=t}}}_convertLiteralColorValue(t){const e=t.toUpperCase();return Ri[e]?Ri[e]:(new Ri).fromHEX(t)}_applyTextAttribute(t){const e=t.node.getComponent(fz);if(!e)return;const i=t.styleIndex;let n;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(e.color=this._convertLiteralColorValue(n.color||"white"),e.isBold=!!n.bold,e.isItalic=!!n.italic,e.isUnderline=!!n.underline,n.outline){let e=t.node.getComponent(QV);e||(e=t.node.addComponent(QV)),e.color=this._convertLiteralColorValue(n.outline.color),e.width=n.outline.width}e.fontSize=n.size||this._fontSize,t.clickHandler="",t.clickParam="";const i=n.event;i&&(t.clickHandler=i.click||"",t.clickParam=i.param||"")}else e.fontSize=this._fontSize;e.cacheMode=this._cacheMode,this._font instanceof xN&&!this._isSystemFontUsed?e.font=this._font:e.fontFamily=this._fontFamily,e.useSystemFont=this._isSystemFontUsed,e.lineHeight=this._lineHeight,e.updateRenderData(!0);const s=e._assembler;s&&s.updateRenderData(e)}_applyLayer(){for(const t of this._segments)t.node.layer=this.node.layer}},kG.HorizontalAlign=cz,kG.VerticalAlign=hz,wl((DG=HG).prototype,"string",[uc,mG],Object.getOwnPropertyDescriptor(DG.prototype,"string"),DG.prototype),wl(DG.prototype,"horizontalAlign",[pG,dG],Object.getOwnPropertyDescriptor(DG.prototype,"horizontalAlign"),DG.prototype),wl(DG.prototype,"fontSize",[fG],Object.getOwnPropertyDescriptor(DG.prototype,"fontSize"),DG.prototype),wl(DG.prototype,"fontFamily",[gG],Object.getOwnPropertyDescriptor(DG.prototype,"fontFamily"),DG.prototype),wl(DG.prototype,"font",[yG,vG],Object.getOwnPropertyDescriptor(DG.prototype,"font"),DG.prototype),wl(DG.prototype,"useSystemFont",[xG],Object.getOwnPropertyDescriptor(DG.prototype,"useSystemFont"),DG.prototype),wl(DG.prototype,"cacheMode",[bG,SG],Object.getOwnPropertyDescriptor(DG.prototype,"cacheMode"),DG.prototype),wl(DG.prototype,"maxWidth",[AG],Object.getOwnPropertyDescriptor(DG.prototype,"maxWidth"),DG.prototype),wl(DG.prototype,"lineHeight",[CG],Object.getOwnPropertyDescriptor(DG.prototype,"lineHeight"),DG.prototype),wl(DG.prototype,"imageAtlas",[TG,wG],Object.getOwnPropertyDescriptor(DG.prototype,"imageAtlas"),DG.prototype),wl(DG.prototype,"handleTouchEvent",[EG],Object.getOwnPropertyDescriptor(DG.prototype,"handleTouchEvent"),DG.prototype),IG=wl(DG.prototype,"_lineHeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),RG=wl(DG.prototype,"_string",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),MG=wl(DG.prototype,"_horizontalAlign",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cz.LEFT}}),OG=wl(DG.prototype,"_fontSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),BG=wl(DG.prototype,"_maxWidth",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NG=wl(DG.prototype,"_fontFamily",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),LG=wl(DG.prototype,"_font",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FG=wl(DG.prototype,"_isSystemFontUsed",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zG=wl(DG.prototype,"_userDefinedFont",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VG=wl(DG.prototype,"_cacheMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uz.NONE}}),UG=wl(DG.prototype,"_imageAtlas",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GG=wl(DG.prototype,"_handleTouchEvent",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),PG=DG))||PG)||PG)||PG)||PG)||PG));var ZG;let QG=function(e){return t({UIMeshRenderer:e,UIModelComponent:e}),e}(Vl("cc.UIMeshRenderer")(ZG=ec()(ZG=Gl(110)(ZG=Jl()(ZG=class extends lG{constructor(...t){super(...t),this._models=null,this._modelComponent=null}get modelComponent(){return this._modelComponent}onLoad(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn(`node '${this.node&&this.node.name}' doesn't have any renderable component`)}onEnable(){super.onEnable()}onDisable(){super.onDisable()}onDestroy(){super.onDestroy(),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)}updateAssembler(t){if(this._models){this._modelComponent._detachFromScene();for(const e of this._models)t.commitModel.call(t,this,e,this._modelComponent.material);return!0}return!1}update(){this._fitUIRenderQueue()}_fitUIRenderQueue(){if(!this._modelComponent)return;const t=this._modelComponent.sharedMaterials.length;for(let e=0;e<t;e++){const t=this._modelComponent.getMaterialInstance(e);if(null==t)continue;const i=t.passes,n=i.length;for(let e=0;e<n;e++){const n=i[e];n._priority=ep.MAX-11,n.blendState.targets[0].blend||t.overridePipelineStates({blendState:{targets:[{blend:!0}]}},e)}}}})||ZG)||ZG)||ZG)||ZG);class tk{get attributes(){return this._attributes}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}constructor(t){this.vData=null,this.iData=null,this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=1,this._attributes=null,this._vertexBuffers=[],this._indexBuffer=null,this._iaInfo=null,this._batcher=void 0,this._dirty=!1,this._vertexFormatBytes=0,this._initVDataCount=0,this._initIDataCount=1536,this._outOfCallback=null,this._hInputAssemblers=[],this._nextFreeIAHandle=0,this._batcher=t}get vertexFormatBytes(){return this._vertexFormatBytes}initialize(t,e){this._outOfCallback=e;const i=Bz(t);this._vertexFormatBytes=i*Float32Array.BYTES_PER_ELEMENT,this._initVDataCount=256*this._vertexFormatBytes;const n=Float32Array.BYTES_PER_ELEMENT*i;this.vertexBuffers.length||this.vertexBuffers.push(this._batcher.device.createBuffer(new Pr(Ls.VERTEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,n,n)));const s=Uint16Array.BYTES_PER_ELEMENT;this.indexBuffer||(this._indexBuffer=this._batcher.device.createBuffer(new Pr(Ls.INDEX|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,s,s))),this._attributes=t,this._iaInfo=new Xr(this.attributes,this.vertexBuffers,this.indexBuffer),this.vData&&this.iData||this._reallocBuffer()}request(t=4,e=6){this.lastByteOffset=this.byteOffset;const i=this.byteOffset+t*this._vertexFormatBytes,n=this.indicesOffset+e;if(t+this.vertexOffset>65535)return this._outOfCallback&&this._outOfCallback.call(this._batcher,t,e),!1;let s=this.vData.byteLength,r=this.iData.length;if(i>s||n>r){for(;s<i||r<n;)this._initVDataCount*=2,this._initIDataCount*=2,s=4*this._initVDataCount,r=this._initIDataCount;this._reallocBuffer()}return this.vertexOffset+=t,this.indicesOffset+=e,this.byteOffset=i,this._dirty=!0,!0}reset(){this.byteStart=0,this.byteOffset=0,this.indicesStart=0,this.indicesOffset=0,this.vertexStart=0,this.vertexOffset=0,this.lastByteOffset=0,this._nextFreeIAHandle=0,this._dirty=!1}destroy(){this._attributes=null,this.vertexBuffers[0].destroy(),this.vertexBuffers.length=0,this.indexBuffer.destroy(),this._indexBuffer=null;for(let t=0;t<this._hInputAssemblers.length;t++)this._hInputAssemblers[t].destroy();this._hInputAssemblers.length=0}recordBatch(){const t=this.indicesOffset-this.indicesStart;if(!t)return null;this._hInputAssemblers.length<=this._nextFreeIAHandle&&this._hInputAssemblers.push(this._batcher.device.createInputAssembler(this._iaInfo));const e=this._hInputAssemblers[this._nextFreeIAHandle++];return e.firstIndex=this.indicesStart,e.indexCount=t,e}uploadBuffers(){if(0===this.byteOffset||!this._dirty)return;const t=new Float32Array(this.vData.buffer,0,this.byteOffset>>2),e=new Uint16Array(this.iData.buffer,0,this.indicesOffset);this.byteOffset>this.vertexBuffers[0].size&&this.vertexBuffers[0].resize(this.byteOffset),this.vertexBuffers[0].update(t),2*this.indicesOffset>this.indexBuffer.size&&this.indexBuffer.resize(2*this.indicesOffset),this.indexBuffer.update(e),this._dirty=!1}_reallocBuffer(){this._reallocVData(!0),this._reallocIData(!0)}_reallocVData(t){let e;if(this.vData&&(e=new Uint8Array(this.vData.buffer)),this.vData=new Float32Array(this._initVDataCount),e&&t){const t=new Uint8Array(this.vData.buffer);for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}}_reallocIData(t){const e=this.iData;if(this.iData=new Uint16Array(this._initIDataCount),e&&t){const t=this.iData;for(let i=0,n=e.length;i<n;i++)t[i]=e[i]}}}t("MeshBuffer",tk),tk.OPACITY_OFFSET=8;const ek=Qm.Enum.NONE|Qm.Enum.UI_3D;class ik{get native(){return this._nativeObj}get inputAssembler(){return this._inputAssember}set inputAssembler(t){this._inputAssember=t,this._nativeObj.inputAssembler=t}get descriptorSet(){return this._descriptorSet}set descriptorSet(t){this._descriptorSet=t,this._nativeObj.descriptorSet=t}get visFlags(){return this._visFlags}set visFlags(t){this._visFlags=t,this._nativeObj.visFlags=t}get passes(){return this._passes}get shaders(){return this._shaders}constructor(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=ek,this._inputAssember=null,this._descriptorSet=null,this._nativeObj=new Jn,this._nativeObj.visFlags=this._visFlags}destroy(t){this._passes=[],this._nativeObj=null}clear(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=ek,this.renderScene=null}fillPasses(t,e,i,s,r,o){if(t){const a=t.passes;if(!a)return;let l=0,c=!1;this._shaders.length=a.length;for(let t=0;t<a.length;t++){this._passes[t]||(this._passes[t]=new _g(n.director.root));const h=a[t],_=this._passes[t];h.update(),e||(e=h.depthStencilState,i=0),s||(s=h.blendState,r=0),-1===r&&(r=0),l=i<<16|r,_._initPassFromTarget(h,e,s,l),this._shaders[t]=_.getShaderVariant(o),c=!0}if(c){const t=[],e=this._passes;for(let i=0;i<e.length;i++)t.push(e[i].native);this._nativeObj.passes=t,this._nativeObj.shaders=this._shaders}}}}var nk,sk,rk,ok,ak,lk,ck;t("UIDrawBatch",ik);let hk=function(e){return t({UIStaticBatch:e,UIStaticBatchComponent:e}),e}((nk=Vl("cc.UIStaticBatch"),sk=ec(),rk=Jl(),ok=Gl(110),ak=nc(),nk(lk=sk(lk=rk(lk=ok((wl((ck=class extends iF{constructor(...t){super(...t),this._init=!1,this._meshBuffer=null,this._dirty=!0,this._lastMeshBuffer=null,this._uiDrawBatchList=[]}get color(){return this._color}set color(t){this._color!==t&&this._color.set(t)}get drawBatchList(){return this._uiDrawBatchList}onLoad(){const t=this._getBatcher();if(!t)return;const e=Mz,i=new tk(t);i.initialize(e,this._arrivalMaxBuffer.bind(this)),this._meshBuffer=i}onDestroy(){super.onDestroy(),this._clearData(),this._meshBuffer&&(this._meshBuffer.destroy(),this._meshBuffer=null)}updateAssembler(t){t.currIsStatic=!0,this._dirty&&(t.finishMergeBatches(),this._lastMeshBuffer=t.currBufferBatch,t.currBufferBatch=this._meshBuffer,t.currStaticRoot=this),this._init&&(t.finishMergeBatches(),t.commitStaticBatch(this))}postUpdateAssembler(t){this._dirty&&(t.finishMergeBatches(),t.currBufferBatch=this._lastMeshBuffer,t.currStaticRoot=null,this._dirty=!1,this._init=!0,this.node._static=!0,this._meshBuffer.uploadBuffers()),t.currIsStatic=!1}markAsDirty(){this._getBatcher()&&(this.node._static=!1,this._dirty=!0,this._init=!1,this._clearData())}_requireDrawBatch(){const t=new ik;return t.isStatic=!0,this._uiDrawBatchList.push(t),t}_clearData(){if(this._meshBuffer){this._meshBuffer.reset();const t=this._getBatcher();for(let e=0;e<this._uiDrawBatchList.length;e++)this._uiDrawBatchList[e].destroy(t)}this._uiDrawBatchList.length=0,this._init=!1}_getBatcher(){return Mw.root&&Mw.root.batcher2D?Mw.root.batcher2D:(A(9301),null)}_arrivalMaxBuffer(){const t=this._getBatcher();t&&t.autoMergeBatches(),A(9300)}}).prototype,"color",[vc,ak],Object.getOwnPropertyDescriptor(ck.prototype,"color"),ck.prototype),lk=ck))||lk)||lk)||lk)||lk));var _k,uk,mk,pk,dk,fk,gk,yk,vk,xk,bk,Sk,Ak;let Ck=t("LabelShadow",(_k=Vl("cc.LabelShadow"),uk=ec(),mk=Gl(110),pk=Jl(),dk=Ul(fz),fk=rc(),gk=rc(),yk=rc(),_k(vk=uk(vk=mk(vk=pk(vk=dk(vk=$l((bk=wl((xk=class extends Rh{constructor(...t){super(...t),Tl(this,"_color",bk,this),Tl(this,"_offset",Sk,this),Tl(this,"_blur",Ak,this)}get color(){return this._color}set color(t){this._color!==t&&(this._color.set(t),this._updateRenderData())}get offset(){return this._offset}set offset(t){this._offset=t,this._updateRenderData()}get blur(){return this._blur}set blur(t){this._blur=t,this._updateRenderData()}onEnable(){this._updateRenderData()}onDisable(){this._updateRenderData()}_updateRenderData(){const t=this.node.getComponent(fz);t&&t.updateRenderData(!0)}}).prototype,"_color",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(0,0,0,255)}}),Sk=wl(xk.prototype,"_offset",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn(2,2)}}),Ak=wl(xk.prototype,"_blur",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),wl(xk.prototype,"color",[fk],Object.getOwnPropertyDescriptor(xk.prototype,"color"),xk.prototype),wl(xk.prototype,"offset",[gk],Object.getOwnPropertyDescriptor(xk.prototype,"offset"),xk.prototype),wl(xk.prototype,"blur",[yk],Object.getOwnPropertyDescriptor(xk.prototype,"blur"),xk.prototype),vk=xk))||vk)||vk)||vk)||vk)||vk)||vk));var Tk,wk,Ek;let Pk=function(e){return t({UIOpacity:e,UIOpacityComponent:e}),e}(Vl("cc.UIOpacity")(Tk=ec()(Tk=Gl(110)(Tk=Jl()(Tk=$l((wl((wk=class extends Rh{constructor(...t){super(...t),Tl(this,"_opacity",Ek,this)}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(t=$t(t,0,255),this._opacity=t,this.node._uiProps.localOpacity=t/255)}onEnable(){this.node._uiProps.localOpacity=this._opacity/255}onDisable(){this.node._uiProps.localOpacity=1}}).prototype,"opacity",[ic],Object.getOwnPropertyDescriptor(wk.prototype,"opacity"),wk.prototype),Ek=wl(wk.prototype,"_opacity",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),Tk=wk))||Tk)||Tk)||Tk)||Tk)||Tk);n.MaskComponent=zV,Ot.setClassAlias(zV,"cc.MaskComponent"),n.LabelComponent=fz,Ot.setClassAlias(fz,"cc.LabelComponent"),n.LabelOutlineComponent=QV,Ot.setClassAlias(QV,"cc.LabelOutlineComponent"),n.RichTextComponent=JG,Ot.setClassAlias(JG,"cc.RichTextComponent"),n.SpriteComponent=HU,Ot.setClassAlias(HU,"cc.SpriteComponent"),n.UIModelComponent=QG,Ot.setClassAlias(QG,"cc.UIModelComponent"),n.GraphicsComponent=aV,Ot.setClassAlias(aV,"cc.GraphicsComponent"),Ot.setClassAlias(hk,"cc.UIStaticBatchComponent"),Ot.setClassAlias(Pk,"cc.UIOpacityComponent");class Dk{constructor(t,e,i){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=t,this.x=e,this.y=i}}function Ik(t,e,i,n,s){let r=0,o=null;if(s===function(t,e,i,n){let s=0;for(let r=e,o=i-n;r<i;r+=n)s+=(t[o]-t[r])*(t[r+1]+t[o+1]),o=r;return s}(t,e,i,n)>0)for(r=e;r<i;r+=n)o=Yk(r,t[r],t[r+1],o);else for(r=i-n;r>=e;r-=n)o=Yk(r,t[r],t[r+1],o);return o&&jk(o,o.next)&&(Kk(o),o=o.next),o}function Rk(t,e=null){if(!t)return t;e||(e=t);let i=t,n=!1;do{if(n=!1,i.steiner||!jk(i,i.next)&&0!==Hk(i.prev,i,i.next))i=i.next;else{if(Kk(i),i=e=i.prev,i===i.next)return null;n=!0}}while(n||i!==e);return e}function Mk(t,e,i,n,s,r,o=0){if(!t)return;!o&&r&&function(t,e,i,n){let s=t;do{null===s.z&&(s.z=Vk(s.x,s.y,e,i,n)),s.prevZ=s.prev,s.nextZ=s.next,s=s.next}while(s!==t);s.prevZ.nextZ=null,s.prevZ=null,function(t){let e=0,i=null,n=null,s=null,r=null,o=0,a=0,l=0,c=1;do{for(i=t,t=null,r=null,o=0;i;){for(o++,n=i,a=0,e=0;e<c&&(a++,n=n.nextZ,n);e++);for(l=c;a>0||l>0&&n;)0===a?(s=n,n=n.nextZ,l--):0!==l&&n?i.z<=n.z?(s=i,i=i.nextZ,a--):(s=n,n=n.nextZ,l--):(s=i,i=i.nextZ,a--),r?r.nextZ=s:t=s,s.prevZ=r,r=s;i=n}r.nextZ=null,c*=2}while(o>1)}(s)}(t,n,s,r);let a=t,l=null,c=null;for(;t.prev!==t.next;)if(l=t.prev,c=t.next,r?Bk(t,n,s,r):Ok(t))e.push(l.i/i),e.push(t.i/i),e.push(c.i/i),Kk(t),t=c.next,a=c.next;else if((t=c)===a){o?1===o?Mk(t=Nk(t,e,i),e,i,n,s,r,2):2===o&&Lk(t,e,i,n,s,r):Mk(Rk(t),e,i,n,s,r,1);break}}function Ok(t){const e=t.prev,i=t,n=t.next;if(Hk(e,i,n)>=0)return!1;let s=t.next.next;for(;s!==t.prev;){if(Gk(e.x,e.y,i.x,i.y,n.x,n.y,s.x,s.y)&&Hk(s.prev,s,s.next)>=0)return!1;s=s.next}return!0}function Bk(t,e,i,n){const s=t.prev,r=t,o=t.next;if(Hk(s,r,o)>=0)return!1;const a=s.x<r.x?s.x<o.x?s.x:o.x:r.x<o.x?r.x:o.x,l=s.y<r.y?s.y<o.y?s.y:o.y:r.y<o.y?r.y:o.y,c=s.x>r.x?s.x>o.x?s.x:o.x:r.x>o.x?r.x:o.x,h=s.y>r.y?s.y>o.y?s.y:o.y:r.y>o.y?r.y:o.y,_=Vk(a,l,e,i,n),u=Vk(c,h,e,i,n);let m=t.nextZ;for(;m&&m.z<=u;){if(m!==t.prev&&m!==t.next&&Gk(s.x,s.y,r.x,r.y,o.x,o.y,m.x,m.y)&&Hk(m.prev,m,m.next)>=0)return!1;m=m.nextZ}for(m=t.prevZ;m&&m.z>=_;){if(m!==t.prev&&m!==t.next&&Gk(s.x,s.y,r.x,r.y,o.x,o.y,m.x,m.y)&&Hk(m.prev,m,m.next)>=0)return!1;m=m.prevZ}return!0}function Nk(t,e,i){let n=t;do{const s=n.prev,r=n.next.next;!jk(s,r)&&Wk(s,n,n.next,r)&&qk(s,r)&&qk(r,s)&&(e.push(s.i/i),e.push(n.i/i),e.push(r.i/i),Kk(n),Kk(n.next),n=t=r),n=n.next}while(n!==t);return n}function Lk(t,e,i,n,s,r){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&kk(o,t)){let a=Xk(o,t);return o=Rk(o,o.next),a=Rk(a,a.next),Mk(o,e,i,n,s,r),void Mk(a,e,i,n,s,r)}t=t.next}o=o.next}while(o!==t)}function Fk(t,e){return t.x-e.x}function zk(t,e){if(e=function(t,e){let i=e;const n=t.x,s=t.y;let r=-1/0,o=null;do{if(s<=i.y&&s>=i.next.y){const t=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=n&&t>r){if(r=t,t===n){if(s===i.y)return i;if(s===i.next.y)return i.next}o=i.x<i.next.x?i:i.next}}i=i.next}while(i!==e);if(!o)return null;if(n===r)return o.prev;const a=o,l=o.x,c=o.y;let h,_=1/0;for(i=o.next;i!==a;)n>=i.x&&i.x>=l&&Gk(s<c?n:r,s,l,c,s<c?r:n,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(n-i.x),(h<_||h===_&&i.x>o.x)&&qk(i,t)&&(o=i,_=h)),i=i.next;return o}(t,e)){const i=Xk(e,t);Rk(i,i.next)}}function Vk(t,e,i,n,s){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/s)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/s)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Uk(t){let e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function Gk(t,e,i,n,s,r,o,a){return(s-o)*(e-a)-(t-o)*(r-a)>=0&&(t-o)*(n-a)-(i-o)*(e-a)>=0&&(i-o)*(r-a)-(s-o)*(n-a)>=0}function kk(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Wk(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&qk(t,e)&&qk(e,t)&&function(t,e){let i=t,n=!1;const s=(t.x+e.x)/2,r=(t.y+e.y)/2;do{i.y>r!=i.next.y>r&&s<(i.next.x-i.x)*(r-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n}(t,e)}function Hk(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function jk(t,e){return t.x===e.x&&t.y===e.y}function Wk(t,e,i,n){return!!(jk(t,e)&&jk(i,n)||jk(t,n)&&jk(i,e))||Hk(t,e,i)>0!=Hk(t,e,n)>0&&Hk(i,n,t)>0!=Hk(i,n,e)>0}function qk(t,e){return Hk(t.prev,t,t.next)<0?Hk(t,e,t.next)>=0&&Hk(t,t.prev,e)>=0:Hk(t,e,t.prev)<0||Hk(t,t.next,e)<0}function Xk(t,e){const i=new Dk(t.i,t.x,t.y),n=new Dk(e.i,e.x,e.y),s=t.next,r=e.prev;return t.next=e,e.prev=t,i.next=s,s.prev=i,n.next=i,i.prev=n,r.next=n,n.prev=r,n}function Yk(t,e,i,n){const s=new Dk(t,e,i);return n?(s.next=n.next,s.prev=n,n.next.prev=s,n.next=s):(s.prev=s,s.next=s),s}function Kk(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function $k(t,e,i){i=i||3;const n=e?e.length:0,s=n?e[0]*i:t.length;let r=Ik(t,0,s,i,!0);const o=[];if(!r)return o;let a=0,l=0,c=0,h=0,_=0,u=0,m=0;if(n&&(r=function(t,e,i,n){const s=[];let r=0,o=0,a=0,l=0,c=null;for(r=0,o=e.length;r<o;r++)a=e[r]*n,l=r<o-1?e[r+1]*n:t.length,c=Ik(t,a,l,n,!1),c&&(c===c.next&&(c.steiner=!0),s.push(Uk(c)));if(s.sort(Fk),!i)return i;for(r=0;r<s.length;r++)zk(s[r],i),i=Rk(i,i.next);return i}(t,e,r,i)),t.length>80*i){a=c=t[0],l=h=t[1];for(let e=i;e<s;e+=i)_=t[e],u=t[e+1],_<a&&(a=_),u<l&&(l=u),_>c&&(c=_),u>h&&(h=u);m=Math.max(c-a,h-l)}return Mk(r,o,i,a,l,m),o}const Jk=Math.PI,Zk=Math.min,Qk=Math.max,tH=Math.ceil,eH=Math.acos,iH=Math.cos,nH=Math.sin,sH=Math.atan2;let rH=null,oH=null;const aH=new Ri,lH=[];for(let t=0;t<4;t++)lH.push(new Ni);function cH(t,e,i){return t<e?e:t>i?i:t}const hH={useModel:!0,updateRenderData(t){},fillBuffers(t,e){},renderIA(t,e){},getRenderData(t,e){if(!oH)return null;const i=oH.getRenderDataList();let n=i[oH.dataOffset];if(!n)return null;let s=n;const r=s?s.vertexStart+e:0;return(r>65535||3*r>131070)&&(++oH.dataOffset,oH.dataOffset<i.length?n=i[oH.dataOffset]:(n=oH.requestRenderData(),i[oH.dataOffset]=n),s=n),s&&s.vertexCount<r&&s.request(e,3*e),n},stroke(t){Ri.copy(aH,t.strokeColor),t.impl&&(this._flattenPaths(t.impl),this._expandStroke(t),t.impl.updatePathOffset=!0,this.end(t))},fill(t){Ri.copy(aH,t.fillColor),this._expandFill(t),t.impl&&(t.impl.updatePathOffset=!0),this.end(t)},end(t){t.markForUpdateRenderData()},_expandStroke(t){const e=.5*t.lineWidth,i=t.lineCap,n=t.lineJoin,s=t.miterLimit;if(oH=t.impl,!oH)return;const r=function(t,e,i){const n=2*eH(t/(t+i));return Qk(2,tH(e/n))}(e,Jk,oH.tessTol);this._calculateJoins(oH,e,n,s);const o=oH.paths;let a=0;for(let t=oH.pathOffset,e=oH.pathLength;t<e;t++){const e=o[t],s=e.points.length;n===pz.ROUND?a+=2*(s+e.bevel*(r+2)+1):a+=2*(s+5*e.bevel+1),e.closed||(i===mz.ROUND?a+=2*(2*r+2):a+=12)}const l=rH=this.getRenderData(t,a);if(!l)return;const c=l.vData,h=l.iData;for(let t=oH.pathOffset,s=oH.pathLength;t<s;t++){const s=o[t],a=s.points,_=a.length,u=l.vertexStart;let m,p,d=0,f=0;const g=s.closed;if(g?(m=a[_-1],p=a[0],d=0,f=_):(m=a[0],p=a[1],d=1,f=_-1),p=p||m,!g){const t=new Ez(p.x,p.y);t.subtract(m),t.normalize();const n=t.x,s=t.y;i===mz.BUTT?this._buttCapStart(m,n,s,e,0):i===mz.SQUARE?this._buttCapStart(m,n,s,e,e):i===mz.ROUND&&this._roundCapStart(m,n,s,e,r)}for(let t=d;t<f;++t)n===pz.ROUND?this._roundJoin(m,p,e,e,r):0!=(p.flags&(dz.PT_BEVEL|dz.PT_INNERBEVEL))?this._bevelJoin(m,p,e,e):(this._vSet(p.x+p.dmx*e,p.y+p.dmy*e,1),this._vSet(p.x-p.dmx*e,p.y-p.dmy*e,-1)),m=p,p=a[t+1];if(g){const t=8*u;this._vSet(c[t],c[t+1],1),this._vSet(c[t+8],c[t+8+1],-1)}else{const t=new Ez(p.x,p.y);t.subtract(m),t.normalize();const n=t.x,s=t.y;i===mz.BUTT?this._buttCapEnd(p,n,s,e,0):i===mz.SQUARE?this._buttCapEnd(p,n,s,e,e):i===mz.ROUND&&this._roundCapEnd(p,n,s,e,r)}let y=l.indicesStart;for(let t=u+2,e=l.vertexStart;t<e;t++)h[y++]=t-2,h[y++]=t-1,h[y++]=t;l.indicesStart=y}rH=null,oH=null},_expandFill(t){if(oH=t.impl,!oH)return;const e=oH.paths;let i=0;for(let t=oH.pathOffset,n=oH.pathLength;t<n;t++)i+=e[t].points.length;const n=rH=this.getRenderData(t,i);if(!n)return;const s=n,r=s.vData,o=s.iData;for(let t=oH.pathOffset,i=oH.pathLength;t<i;t++){const i=e[t],a=i.points,l=a.length;if(0===l)continue;const c=n.vertexStart;for(let t=0;t<l;++t)this._vSet(a[t].x,a[t].y);let h=n.indicesStart;if(i.complex){const t=[];for(let e=c,i=n.vertexStart;e<i;e++){let i=8*e;t.push(r[i++]),t.push(r[i++]),t.push(r[i++])}const e=$k(t,null,3);if(!e||0===e.length)continue;for(let t=0,i=e.length;t<i;t++)o[h++]=e[t]+c}else{const t=c;for(let e=c+2,i=s.vertexStart;e<i;e++)o[h++]=t,o[h++]=e-1,o[h++]=e}s.indicesStart=h}rH=null,oH=null},_calculateJoins(t,e,i,n){let s=0;e>0&&(s=1/e);const r=t.paths;for(let e=t.pathOffset,o=t.pathLength;e<o;e++){const t=r[e],o=t.points,a=o.length;let l=o[a-1],c=o[0];t.bevel=0;for(let e=0;e<a;e++){let r=0,a=0,h=0;const _=l.dy,u=-l.dx,m=c.dy,p=-c.dx;if(c.dmx=.5*(_+m),c.dmy=.5*(u+p),r=c.dmx*c.dmx+c.dmy*c.dmy,r>1e-6){let t=1/r;t>600&&(t=600),c.dmx*=t,c.dmy*=t}a=c.dx*l.dy-l.dx*c.dy,a>0&&(c.flags|=dz.PT_LEFT),h=Qk(11,Zk(l.len,c.len)*s),r*h*h<1&&(c.flags|=dz.PT_INNERBEVEL),c.flags&dz.PT_CORNER&&(r*n*n<1||i===pz.BEVEL||i===pz.ROUND)&&(c.flags|=dz.PT_BEVEL),0!=(c.flags&(dz.PT_BEVEL|dz.PT_INNERBEVEL))&&t.bevel++,l=c,c=o[e+1]}}},_flattenPaths(t){const e=t.paths;for(let i=t.pathOffset,n=t.pathLength;i<n;i++){const t=e[i],n=t.points;let s=n[n.length-1],r=n[0];n.length>2&&s.equals(r)&&(t.closed=!0,n.pop(),s=n[n.length-1]);for(let t=0,e=n.length;t<e;t++){const e=new Ez(r.x,r.y);e.subtract(s),s.len=e.length(),(e.x||e.y)&&e.normalize(),s.dx=e.x,s.dy=e.y,s=r,r=n[t+1]}}},_chooseBevel(t,e,i,n){const s=i.x,r=i.y;let o=0,a=0,l=0,c=0;return 0!==t?(o=s+e.dy*n,a=r-e.dx*n,l=s+i.dy*n,c=r-i.dx*n):(o=l=s+i.dmx*n,a=c=r+i.dmy*n),[o,a,l,c]},_buttCapStart(t,e,i,n,s){const r=t.x-e*s,o=t.y-i*s,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_buttCapEnd(t,e,i,n,s){const r=t.x+e*s,o=t.y+i*s,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_roundCapStart(t,e,i,n,s){const r=t.x,o=t.y,a=i,l=-e;for(let t=0;t<s;t++){const c=t/(s-1)*Jk,h=iH(c)*n,_=nH(c)*n;this._vSet(r-a*h-e*_,o-l*h-i*_,1),this._vSet(r,o,0)}this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1)},_roundCapEnd(t,e,i,n,s){const r=t.x,o=t.y,a=i,l=-e;this._vSet(r+a*n,o+l*n,1),this._vSet(r-a*n,o-l*n,-1);for(let t=0;t<s;t++){const c=t/(s-1)*Jk,h=iH(c)*n,_=nH(c)*n;this._vSet(r,o,0),this._vSet(r-a*h+e*_,o-l*h+i*_,1)}},_roundJoin(t,e,i,n,s){const r=t.dy,o=-t.dx,a=e.dy,l=-e.dx,c=e.x,h=e.y;if(0!=(e.flags&dz.PT_LEFT)){const _=this._chooseBevel(e.flags&dz.PT_INNERBEVEL,t,e,i),u=_[0],m=_[1],p=_[2],d=_[3],f=sH(-o,-r);let g=sH(-l,-a);g>f&&(g-=2*Jk),this._vSet(u,m,1),this._vSet(c-r*n,e.y-o*n,-1);const y=cH(tH((f-g)/Jk)*s,2,s);for(let t=0;t<y;t++){const e=f+t/(y-1)*(g-f),i=c+iH(e)*n,s=h+nH(e)*n;this._vSet(c,h,0),this._vSet(i,s,-1)}this._vSet(p,d,1),this._vSet(c-a*n,h-l*n,-1)}else{const _=this._chooseBevel(e.flags&dz.PT_INNERBEVEL,t,e,-n),u=_[0],m=_[1],p=_[2],d=_[3],f=sH(o,r);let g=sH(l,a);g<f&&(g+=2*Jk),this._vSet(c+r*n,h+o*n,1),this._vSet(u,m,-1);const y=cH(tH((g-f)/Jk)*s,2,s);for(let t=0;t<y;t++){const e=f+t/(y-1)*(g-f),n=c+iH(e)*i,s=h+nH(e)*i;this._vSet(n,s,1),this._vSet(c,h,0)}this._vSet(c+a*n,h+l*n,1),this._vSet(p,d,-1)}},_bevelJoin(t,e,i,n){let s=0,r=0,o=0,a=0,l=0,c=0,h=0,_=0;const u=t.dy,m=-t.dx,p=e.dy,d=-e.dx;if(e.flags&dz.PT_LEFT){const s=this._chooseBevel(e.flags&dz.PT_INNERBEVEL,t,e,i);l=s[0],c=s[1],h=s[2],_=s[3],this._vSet(l,c,1),this._vSet(e.x-u*n,e.y-m*n,-1),this._vSet(h,_,1),this._vSet(e.x-p*n,e.y-d*n,-1)}else{const l=this._chooseBevel(e.flags&dz.PT_INNERBEVEL,t,e,-n);s=l[0],r=l[1],o=l[2],a=l[3],this._vSet(e.x+u*i,e.y+m*i,1),this._vSet(s,r,-1),this._vSet(e.x+p*i,e.y+d*i,1),this._vSet(o,a,-1)}},_vSet(t,e,i=0){if(!rH)return;const n=rH;let s=8*n.vertexStart;const r=n.vData;r[s++]=t,r[s++]=e,r[s++]=0,Ri.toArray(r,aH,s),s+=4,r[s++]=i,n.vertexStart++}},_H=t("graphicsAssembler",{getAssembler:()=>hH});aV.Assembler=_H;class uH{constructor(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""}}const mH=new hn;let pH=null,dH=null;const fH=[],gH=[],yH=[],vH=[],xH=new ln,bH=new ln,SH=new tn;let AH=null,CH=0,TH=0,wH=0,EH=0,PH=0,DH=1,IH=null,RH="",MH=0,OH=0,BH=0,NH=0,LH=0,FH=0,zH=0,VH=!1,UH=0,GH=0,kH=0;const HH={updateRenderData(t){t.renderData&&t.renderData.vertDirty&&pH!==t&&(pH=t,dH=pH.node._uiProps.uiTransformComp,this._updateFontFamily(t),this._updateProperties(t),this._updateLabelInfo(t),this._updateContent(),pH.actualFontSize=MH,dH.setContentSize(bH),pH.renderData.vertDirty=pH.renderData.uvDirty=!1,pH.markForUpdateRenderData(!1),pH=null,this._resetProperties())},_updateFontScale(){DH=MH/OH},_updateFontFamily(t){const e=t.font;IH=e.spriteFrame,AH=e.fntConfig,oL.fontAtlas=e.fontDefDictionary,_N.packToDynamicAtlas(t,IH)},_updateLabelInfo(t){oL.hash="",oL.margin=0},_updateProperties(t){RH=t.string.toString(),MH=t.fontSize,OH=AH?AH.fontSize:t.fontSize,BH=t.horizontalAlign,NH=t.verticalAlign,LH=t.spacingX,zH=t.overflow,FH=t._lineHeight;const e=dH.contentSize;bH.width=e.width,bH.height=e.height,zH===_z.NONE?(VH=!1,bH.width+=2*oL.margin,bH.height+=2*oL.margin):zH===_z.RESIZE_HEIGHT?(VH=!0,bH.height+=2*oL.margin):VH=t.enableWrapText,oL.lineHeight=FH,oL.fontSize=MH,this._setupBMFontOverflowMetrics()},_resetProperties(){AH=null,IH=null,oL.hash="",oL.margin=0},_updateContent(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText(){const t=RH,e=t.length,i=AH.kerningDict,n=fH;let s=-1;for(let r=0;r<e;++r){const o=t.charCodeAt(r),a=i[s<<16|65535&o]||0;n[r]=r<e-1?a:0,s=o}},_multilineTextWrap(t){const e=RH.length;let i=0,n=0,s=0,r=0,o=0,a=0,l=0,c=null;for(let h=0;h<e;){let _=RH.charAt(h);if("\n"===_){yH.push(o),o=0,i++,n=0,s-=FH*this._getFontScale()+0,this._recordPlaceholderInfo(h,_),h++;continue}const u=t(RH,h,e);let m=a,p=l,d=o,f=n,g=!1;for(let t=0;t<u;++t){const r=h+t;if(_=RH.charAt(r),"\r"===_){this._recordPlaceholderInfo(r,_);continue}if(c=oL.fontAtlas.getLetterDefinitionForChar(_,oL),!c){this._recordPlaceholderInfo(r,_),console.log(`Can't find letter definition in texture atlas ${AH.atlasName} for letter:${_}`);continue}const a=f+c.offsetX*DH-oL.margin;if(VH&&kH>0&&n>0&&a+c.w*DH>kH&&!YN(_)){yH.push(o),o=0,i++,n=0,s-=FH*this._getFontScale()+0,g=!0;break}SH.x=a,SH.y=s-c.offsetY*DH,this._recordLetterInfo(SH,_,r,i),r+1<fH.length&&r<e-1&&(f+=fH[r+1]),f+=c.xAdvance*DH+LH,d=SH.x+c.w*DH,m<SH.y&&(m=SH.y),p>SH.y-c.h*DH&&(p=SH.y-c.h*DH)}g||(n=f,o=d,a<m&&(a=m),l>p&&(l=p),r<o&&(r=o),h+=u)}return yH.push(o),CH=i+1,TH=CH*FH*this._getFontScale(),CH>1&&(TH+=0*(CH-1)),bH.width=UH,bH.height=GH,UH<=0&&(bH.width=parseFloat(r.toFixed(2))+2*oL.margin),GH<=0&&(bH.height=parseFloat(TH.toFixed(2))+2*oL.margin),EH=bH.height,PH=0,a>0&&(EH=bH.height+a),l<-TH&&(PH=TH+l),!0},_getFirstCharLen:()=>1,_getFontScale:()=>zH===_z.SHRINK?DH:1,_getFirstWordLen(t,e,i){let n=t.charAt(e);if(XN(n)||"\n"===n||YN(n))return 1;let s=1,r=oL.fontAtlas.getLetterDefinitionForChar(n,oL);if(!r)return s;let o=r.xAdvance*DH+LH,a=0;for(let l=e+1;l<i&&(n=t.charAt(l),r=oL.fontAtlas.getLetterDefinitionForChar(n,oL),r);++l){if(a=o+r.offsetX*DH,a+r.w*DH>kH&&!YN(n)&&kH>0)return s;if(o+=r.xAdvance*DH+LH,"\n"===n||YN(n)||XN(n))break;s++}return s},_multilineTextWrapByWord(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo(t,e){if(t>=gH.length){const t=new uH;gH.push(t)}gH[t].char=e,gH[t].hash=e.charCodeAt(0)+oL.hash,gH[t].valid=!1},_recordLetterInfo(t,e,i,n){if(i>=gH.length){const t=new uH;gH.push(t)}const s=e.charCodeAt(0)+oL.hash;gH[i].line=n,gH[i].char=e,gH[i].hash=s,gH[i].valid=oL.fontAtlas.getLetter(s).valid,gH[i].x=t.x,gH[i].y=t.y},_alignText(){TH=0,yH.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),zH===_z.SHRINK&&MH>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||zH===_z.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown(t){let e=!0;t||(t=.1,e=!1),MH=t,e&&this._updateContent()},_shrinkLabelToContentSize(t){let e=0,i=0|MH,n=0;for(;e<i;){n=e+i+1>>1;const s=n;if(s<=0)break;DH=s/OH,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),t()?i=n-1:e=n}e>=0&&this._scaleFontSizeDown(e)},_isVerticalClamp:()=>TH>bH.height,_isHorizontalClamp(){let t=!1;for(let e=0,i=RH.length;e<i;++e){const i=gH[e];if(i.valid){const e=oL.fontAtlas.getLetterDefinitionForChar(i.char,oL);if(!e)continue;const n=i.x+e.w/2*DH,s=i.line;if(UH>0)if(VH){if(yH[s]>bH.width&&(n>bH.width||n<0)){t=!0;break}}else if(n>bH.width){t=!0;break}}}return t},_isHorizontalClamped(t,e){const i=yH[e],n=t>bH.width||t<0;return VH?i>bH.width&&n:n},_updateQuads(){if(!pH)return!1;const t=IH?IH.texture:oL.fontAtlas.getTexture(),e=pH.renderData;e.dataLength=e.vertexCount=e.indicesCount=0;const i=dH.anchorPoint,n=bH,s=i.x*n.width,r=i.y*n.height;let o=!0;for(let e=0,i=RH.length;e<i;++e){const i=gH[e];if(!i.valid)continue;const n=oL.fontAtlas.getLetter(i.hash);if(!n){console.warn("Can't find letter in this bitmap-font");continue}mH.height=n.h,mH.width=n.w,mH.x=n.u,mH.y=n.v;let a=i.y+wH;if(GH>0){if(a>EH){const t=a-EH;mH.y+=t,mH.height-=t,a-=t}a-n.h*DH<PH&&zH===_z.CLAMP&&(mH.height=a<PH?0:(a-PH)/DH)}const l=i.line,c=i.x+n.w/2*DH+vH[l];if(UH>0&&this._isHorizontalClamped(c,l))if(zH===_z.CLAMP)mH.width=0;else if(zH===_z.SHRINK){if(bH.width>n.w){o=!1;break}mH.width=0}if(mH.height>0&&mH.width>0){const e=this._determineRect(),n=i.x+vH[i.line];this.appendQuad(pH,t,mH,e,n-s,a-r,DH)}}return o},appendQuad(t,e,i,n,s,r,o){},_determineRect(){const t=IH.isRotated(),e=IH.getOriginalSize(),i=IH.getRect(),n=IH.getOffset(),s=n.x+(e.width-i.width)/2,r=n.y-(e.height-i.height)/2;if(t){const t=mH.x;mH.x=i.x+i.height-mH.y-mH.height-r,mH.y=t+i.y-s,mH.y<0&&(mH.height+=r)}else mH.x+=i.x-s,mH.y+=i.y+r;return t},_computeAlignmentOffset(){switch(vH.length=0,BH){case cz.LEFT:for(let t=0;t<CH;++t)vH.push(0);break;case cz.CENTER:for(let t=0,e=yH.length;t<e;t++)vH.push((bH.width-yH[t])/2);break;case cz.RIGHT:for(let t=0,e=yH.length;t<e;t++)vH.push(bH.width-yH[t])}if(wH=bH.height,NH!==hz.TOP){const t=bH.height-TH+FH*this._getFontScale()-OH*DH;NH===hz.BOTTOM?wH-=t:wH-=t/2}},_setupBMFontOverflowMetrics(){let t=bH.width,e=bH.height;zH===_z.RESIZE_HEIGHT&&(e=0),zH===_z.NONE&&(t=0,e=0),UH=t,GH=e,xH.width=t,xH.height=e,kH=t}},jH=new Ri(255,255,255,255),WH={createData:t=>t.requestRenderData(),fillBuffers(t,e){const i=t.node;t._setCacheAlpha(i._uiProps.opacity),jH.set(t.color),jH.a=255*i._uiProps.opacity,aN(i,e,t.renderData,jH)},appendQuad(t,e,i,n,s,r,o){const a=t.renderData;if(!a)return;const l=a.dataLength;a.dataLength+=4,a.vertexCount=a.dataLength,a.indicesCount=a.dataLength/2*3;const c=a.data,h=e.width,_=e.height,u=i.width,m=i.height;let p=0,d=0,f=0,g=0;n?(p=i.x/h,g=(i.x+m)/h,d=(i.y+u)/_,f=i.y/_,c[l].u=p,c[l].v=f,c[l+1].u=p,c[l+1].v=d,c[l+2].u=g,c[l+2].v=f,c[l+3].u=g,c[l+3].v=d):(p=i.x/h,g=(i.x+u)/h,d=(i.y+m)/_,f=i.y/_,c[l].u=p,c[l].v=d,c[l+1].u=g,c[l+1].v=d,c[l+2].u=p,c[l+2].v=f,c[l+3].u=g,c[l+3].v=f),c[l].x=s,c[l].y=r-m*o,c[l+1].x=s+u*o,c[l+1].y=r-m*o,c[l+2].x=s,c[l+2].y=r,c[l+3].x=s+u*o,c[l+3].y=r}};pt(WH,HH);let qH=null;const XH=dt(HH,{getAssemblerData:()=>(qH||(qH=new rL(1024,1024)),qH.getTexture()),_updateFontFamily(t){oL.fontAtlas=qH,oL.fontFamily=this._getFontFamily(t);const e=t.getComponent(QV);e&&e.enabled?(oL.isOutlined=!0,oL.margin=e.width,oL.out=e.color.clone(),oL.out.a=e.color.a*t.color.a/255):(oL.isOutlined=!1,oL.margin=0)},_getFontFamily(t){let e="Arial";return t.useSystemFont?e=t.fontFamily||"Arial":t.font&&(e=t.font._nativeAsset||"Arial"),e},_updateLabelInfo(t){oL.fontDesc=this._getFontDesc(),oL.color=t.color,oL.hash=function(t){const e=t.color.toHEX();let i="";return t.isOutlined&&t.margin>0&&(i=i+t.margin+t.out.toHEX()),""+t.fontSize+t.fontFamily+e+i}(oL)},_getFontDesc(){let t=`${oL.fontSize.toString()}px `;return t+=oL.fontFamily,t},_computeHorizontalKerningForText(){},_determineRect:()=>!1}),YH=new Ri(255,255,255,255),KH={createData:t=>t.requestRenderData(),fillBuffers(t,e){if(!t.renderData)return;const i=t.node;t._setCacheAlpha(i._uiProps.opacity),YH.a=255*i._uiProps.opacity,aN(i,e,t.renderData,YH)},appendQuad:WH.appendQuad};pt(KH,XH);const $H=fz.Overflow,JH=(1/255).toFixed(3);let ZH=null,QH=null,tj=null,ej="",ij="",nj=0,sj=0,rj=[];const oj=new ln;let aj=0,lj=0,cj=0,hj=new Ri,_j=1,uj="",mj=$H.NONE,pj=!1,dj=null;const fj=Ri.BLACK.clone();let gj=null;const yj=Ri.BLACK.clone(),vj=new hn,xj=ln.ZERO.clone(),bj=ln.ZERO.clone(),Sj=tn.ZERO.clone(),Aj=tn.ZERO.clone();let Cj=0,Tj=0,wj=!1,Ej=!1,Pj=!1;const Dj=["left","center","right"],Ij={getAssemblerData:()=>fz._canvasPool.get(),resetAssemblerData(t){t&&fz._canvasPool.put(t)},updateRenderData(t){if(!t.renderData||!t.renderData.vertDirty)return;const e=t.node._uiProps.uiTransformComp;this._updateFontFamily(t),this._updateProperties(t,e),this._calculateLabelFont(),this._updateLabelDimensions(),this._resetDynamicAtlas(t),this._updateTexture(t),this.updateOpacity(t),t._setCacheAlpha(_j),this._calDynamicAtlas(t),t.actualFontSize=nj,e.setContentSize(oj),this.updateVertexData(t),this.updateUvs(t),t.markForUpdateRenderData(!1),ZH=null,QH=null,tj=null},updateVertexData(t){},updateUvs(t){},updateOpacity(t){const e=t.renderData.vData;let i=5;const n=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[i+3]=n,i+=9},_updateFontFamily(t){uj=t.useSystemFont?t.fontFamily||"Arial":t.font&&t.font._nativeAsset||"Arial"},_updateProperties(t,e){const i=t.assemblerData;i&&(ZH=i.context,QH=i.canvas,tj=t.spriteFrame,ij=t.string.toString(),nj=t.fontSize,sj=nj,mj=t.overflow,bj.width=oj.width=e.width,bj.height=oj.height=e.height,Tj=t.underlineHeight,aj=t.lineHeight,lj=t.horizontalAlign,cj=t.verticalAlign,hj=t.color,_j=t.node._uiProps.opacity,wj=t.isBold,Ej=t.isItalic,Pj=t.isUnderline,pj=mj!==$H.NONE&&(mj===$H.RESIZE_HEIGHT||t.enableWrapText),dj=QV&&t.getComponent(QV),dj=dj&&dj.enabled&&dj.width>0?dj:null,dj&&fj.set(dj.color),gj=Ck&&t.getComponent(Ck),gj=gj&&gj.enabled?gj:null,gj&&yj.set(gj.color),this._updatePaddingRect())},_updatePaddingRect(){let t=0,e=0,i=0,n=0,s=0;if(xj.width=xj.height=0,dj&&(s=dj.width,t=e=i=n=s,xj.width=xj.height=2*s),gj){const r=gj.blur+s,o=gj.offset.x,a=gj.offset.y;i=Math.max(i,-o+r),n=Math.max(n,o+r),t=Math.max(t,a+r),e=Math.max(e,-a+r)}if(Ej){const t=sj*Math.tan(.20943951);n+=t,xj.width+=t}vj.x=i,vj.y=t,vj.width=i+n,vj.height=t+e},_calculateFillTextStartPosition(){let t=0;lj===cz.RIGHT?t=oj.width-vj.width:lj===cz.CENTER&&(t=(oj.width-vj.width)/2);const e=this._getLineHeight()*(rj.length-1);let i=nj*(1-zN/2);if(cj!==hz.TOP){let t=e+vj.height+nj-oj.height;cj===hz.BOTTOM?(t+=zN/2*nj,i-=t):i-=t/2}i+=0*nj,Sj.set(t+vj.x,i+vj.y)},_updateTexture(t){if(!ZH||!QH)return;ZH.clearRect(0,0,QH.width,QH.height),ZH.font=ej,this._calculateFillTextStartPosition();const e=this._getLineHeight();ZH.lineJoin="round",t._srcBlendFactor===Ys.SRC_ALPHA&&(ZH.fillStyle=`rgba(${hj.r}, ${hj.g}, ${hj.b}, ${JH})`,ZH.fillRect(0,0,QH.width,QH.height)),ZH.fillStyle=`rgb(${hj.r}, ${hj.g}, ${hj.b})`;const i=Sj.x;let s=0;this._drawTextEffect(Sj,e);for(let t=0;t<rj.length;++t)s=Sj.y+t*e,dj&&ZH.strokeText(rj[t],i,s),ZH.fillText(rj[t],i,s);if(gj&&(ZH.shadowColor="transparent"),tj){let t;t=tj instanceof pN?tj.texture:tj,0!==QH.width&&0!==QH.height&&(t.reset({width:QH.width,height:QH.height,mipmapLevel:1}),t.uploadData(QH),tj instanceof pN&&(tj.rect=new hn(0,0,QH.width,QH.height),tj._calculateUV()),n.director.root&&n.director.root.batcher2D&&n.director.root.batcher2D._releaseDescriptorSetCache(t.getHash()))}},_resetDynamicAtlas(t){if(t.cacheMode!==fz.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;_N.deleteAtlasSpriteFrame(e),e._resetDynamicAtlasFrame()},_calDynamicAtlas(t){if(t.cacheMode!==fz.CacheMode.BITMAP)return;const e=t.ttfSpriteFrame;_N.packToDynamicAtlas(t,e),t.renderData.uvDirty=!0},_setupOutline(){ZH.strokeStyle=`rgba(${fj.r}, ${fj.g}, ${fj.b}, ${fj.a/255})`,ZH.lineWidth=2*dj.width},_setupShadow(){ZH.shadowColor=`rgba(${yj.r}, ${yj.g}, ${yj.b}, ${yj.a/255})`,ZH.shadowBlur=gj.blur,ZH.shadowOffsetX=gj.offset.x,ZH.shadowOffsetY=-gj.offset.y},_drawTextEffect(t,e){if(!gj&&!dj&&!Pj)return;const i=rj.length>1&&gj,n=this._measureText(ZH,ej);let s=0,r=0;gj&&this._setupShadow(),dj&&this._setupOutline();for(let o=0;o<rj.length;++o)s=t.x,r=t.y+o*e,i&&(dj&&ZH.strokeText(rj[o],s,r),ZH.fillText(rj[o],s,r)),Pj&&(Cj=n(rj[o]),lj===cz.RIGHT?Aj.x=t.x-Cj:lj===cz.CENTER?Aj.x=t.x-Cj/2:Aj.x=t.x,Aj.y=r+sj/8,ZH.fillRect(Aj.x,Aj.y,Cj,Tj));i&&(ZH.shadowColor="transparent")},_updateLabelDimensions(){oj.width=Math.min(oj.width,2048),oj.height=Math.min(oj.height,2048);let t=!1;QH.width!==oj.width&&(QH.width=oj.width,t=!0),QH.height!==oj.height&&(QH.height=oj.height,t=!0),t&&(ZH.font=ej),ZH.textAlign=Dj[lj],ZH.textBaseline="alphabetic"},_getFontDesc(){let t=`${nj.toString()}px `;return t+=uj,wj&&(t=`bold ${t}`),Ej&&(t=`italic ${t}`),t},_getLineHeight(){let t=aj;return t=0===t?nj:t*nj/sj,0|t},_calculateParagraphLength(t,e){const i=[];for(const n of t){const t=KN(e,n,ej);i.push(t)}return i},_measureText:(t,e)=>i=>KN(t,i,e),_calculateShrinkFont(t){if(!ZH)return;const e=this._calculateParagraphLength(t,ZH);let i=0,n=0,s=0;if(pj){const e=bj.width,s=bj.height;if(e<0||s<0)return;n=s+1;let r=[],o=0,a=0|nj+1,l=0;for(;o<a;){if(l=o+a+1>>1,l<=0){b(4003);break}nj=l,ej=this._getFontDesc(),ZH.font=ej;const c=this._getLineHeight();for(n=0,i=0;i<t.length;++i){const s=KN(ZH,t[i],ej);r=JN(t[i],s,e,this._measureText(ZH,ej)),n+=r.length*c}n>s?a=l-1:o=l}0===o?b(4003):(nj=o,ej=this._getFontDesc(),ZH.font=ej)}else{for(n=t.length*this._getLineHeight(),i=0;i<t.length;++i)s<e[i]&&(s=e[i]);const r=(oj.width-vj.width)/s,o=oj.height/n;nj=sj*Math.min(1,r,o)|0,ej=this._getFontDesc(),ZH.font=ej}},_calculateWrapText(t){if(!pj||!ZH)return;rj=[];const e=bj.width;for(let i=0;i<t.length;++i){const n=KN(ZH,t[i],ej),s=JN(t[i],n,e,this._measureText(ZH,ej));rj=rj.concat(s)}},_calculateLabelFont(){if(!ZH)return;const t=ij.split("\n");switch(rj=t,ej=this._getFontDesc(),ZH.font=ej,mj){case $H.NONE:{let e=0,i=0;for(let i=0;i<t.length;++i){const n=KN(ZH,t[i],ej);e=e>n?e:n}i=(rj.length+zN)*this._getLineHeight();const n=parseFloat(e.toFixed(2)),s=parseFloat(i.toFixed(2));oj.width=n+vj.width,oj.height=s+vj.height,bj.width=n+xj.width,bj.height=s+xj.height;break}case $H.SHRINK:this._calculateShrinkFont(t),this._calculateWrapText(t);break;case $H.CLAMP:this._calculateWrapText(t);break;case $H.RESIZE_HEIGHT:{this._calculateWrapText(t);const e=(rj.length+zN)*this._getLineHeight();oj.height=e+vj.height,bj.height=e+xj.height;break}}}},Rj=Ri.WHITE.clone(),Mj={createData(t){const e=t.requestRenderData();e.dataLength=4,e.vertexCount=4,e.indicesCount=6;const i=e.vData=new Float32Array(36);i[3]=i[21]=i[22]=i[31]=0,i[4]=i[12]=i[13]=i[30]=1;let n=5;for(let t=0;t<4;t++)Ri.toArray(i,Rj,n),n+=9;return e},fillBuffers(t,e){const i=t.renderData,n=i.data,s=t.node;let r=e.acquireBufferBatch(),o=r.byteOffset>>2,a=r.indicesOffset,l=r.vertexOffset;r.request()||(r=e.currBufferBatch,a=0,l=0,o=0);const c=r.vData,h=r.iData,_=i.vData,u=n[0],m=n[3];s.updateWorldTransform();const p=s._pos,d=s._rot,f=s._scale,g=u.x*f.x,y=m.x*f.x,v=u.y*f.y,x=m.y*f.y,b=d.x,S=d.y,A=d.z,C=d.w,T=b*S,w=A*C,E=b*b-S*S,P=C*C-A*A,D=P+E,I=2*(T-w),R=P-E,M=2*(T+w),O=p.x,B=p.y;_[0]=D*g+I*v+O,_[1]=R*v+M*g+B,_[9]=D*y+I*v+O,_[10]=R*v+M*y+B,_[18]=D*g+I*x+O,_[19]=R*x+M*g+B,_[27]=D*y+I*x+O,_[28]=R*x+M*y+B,c.set(_,o),h[a++]=l,h[a++]=l+1,h[a++]=l+2,h[a++]=l+2,h[a++]=l+1,h[a++]=l+3},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=i.width,s=i.height,r=i.anchorX*n,o=i.anchorY*s,a=e.data;a[0].x=-r,a[0].y=-o,a[3].x=n-r,a[3].y=s-o},updateUvs(t){const e=t.renderData;if(!e)return;const i=e.vData;if(!i||!e.uvDirty)return;const n=t.ttfSpriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],e.uvDirty=!1}};pt(Mj,Ij);const Oj=t("labelAssembler",{getAssembler(t){let e=Mj;return t.font instanceof NN?e=WH:t.cacheMode===fz.CacheMode.CHAR&&(e=KH),e}});fz.Assembler=Oj;const Bj=HU.FillType,Nj=new $i,Lj=new Ri(255,255,255,255),Fj={useModel:!1,updateRenderData(t){const e=t.spriteFrame;_N.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e){const e=i.uvDirty,n=i.vertDirty;if(!e&&!n)return;let s=t.fillStart,r=t.fillRange;r<0&&(s+=r,r=-r),r=s+r,s=s>1?1:s,s=s<0?0:s,r=r>1?1:r,r=r<0?0:r,r-=s,r=r<0?0:r;let o=s+r;o=o>1?1:o,e&&this.updateUVs(t,s,o),n&&(this.updateVertexData&&this.updateVertexData(t,s,o),this.updateWorldVertexData(t))}},updateUVs(t,e,i){const n=t.spriteFrame,s=t.renderData,r=s.data,o=n.width,a=n.height,l=n.getRect();let c=0,h=0,_=0,u=0,m=0,p=0,d=0,f=0,g=0,y=0,v=0,x=0;switch(n.isRotated()?(c=l.x/o,h=(l.y+l.width)/a,_=(l.x+l.height)/o,u=l.y/a,m=d=c,g=v=_,f=x=h,p=y=u):(c=l.x/o,h=(l.y+l.height)/a,_=(l.x+l.width)/o,u=l.y/a,m=g=c,d=v=_,p=f=h,y=x=u),t.fillType){case Bj.HORIZONTAL:r[0].u=m+(d-m)*e,r[0].v=p+(f-p)*e,r[1].u=m+(d-m)*i,r[1].v=p+(f-p)*i,r[2].u=g+(v-g)*e,r[2].v=y+(x-y)*e,r[3].u=g+(v-g)*i,r[3].v=y+(x-y)*i;break;case Bj.VERTICAL:r[0].u=m+(g-m)*e,r[0].v=p+(y-p)*e,r[1].u=d+(v-d)*e,r[1].v=f+(x-f)*e,r[2].u=m+(g-m)*i,r[2].v=p+(y-p)*i,r[3].u=d+(v-d)*i,r[3].v=f+(x-f)*i;break;default:T(2626)}s.uvDirty=!1},updateVertexData(t,e,i){const n=t.renderData,s=n.data,r=t.node._uiProps.uiTransformComp,o=r.width,a=r.height,l=r.anchorX*o,c=r.anchorY*a;let h=-l,_=-c,u=o-l,m=a-c,p=0,d=0;switch(t.fillType){case Bj.HORIZONTAL:p=h+(u-h)*e,d=h+(u-h)*i,h=p,u=d;break;case Bj.VERTICAL:p=_+(m-_)*e,d=_+(m-_)*i,_=p,m=d;break;default:T(2626)}s[4].x=h,s[4].y=_,s[5].x=u,s[5].y=_,s[6].x=h,s[6].y=m,s[7].x=u,s[7].y=m,n.vertDirty=!1},createData(t){const e=t.requestRenderData();e.dataLength=8,e.vertexCount=4,e.indicesCount=6;const i=e.data;for(const t of i)t.z=0;return e},updateWorldVertexData(t){const e=t.node,i=t.renderData.data;e.getWorldMatrix(Nj);for(let t=0;t<4;t++){const e=i[t+4],n=i[t];Ni.transformMat4(n,e,Nj)}},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);const i=t.node;Lj.set(t.color),Lj.a=255*i._uiProps.opacity,function(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2;const a=i.vertexCount;let l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,o=0,l=0,c=0);const h=r.vData;for(let t=0;t<a;t++){const e=s[t];h[o++]=e.x,h[o++]=e.y,h[o++]=e.z,h[o++]=e.u,h[o++]=e.v,Ri.toArray(h,n,o),o+=4}const _=r.iData;_[l++]=c,_[l++]=c+1,_[l++]=c+2,_[l++]=c+1,_[l++]=c+3,_[l++]=c+2}(0,e,t.renderData,Lj)},updateColor(t){}},zj=2*Math.PI,Vj=1e-6,Uj=new Ri(255,255,255,255),Gj=[new tn,new tn,new tn,new tn],kj=new Array(4),Hj=new Array(8),jj=[new tn,new tn,new tn,new tn],Wj=[new tn,new tn,new tn,new tn],qj=new tn,Xj=[new tn,new tn,new tn,new tn];function Yj(t,e,i,n,s,r,o){let a=Math.sin(r);a=Math.abs(a)>Vj?a:0;let l=Math.cos(r);l=Math.abs(l)>Vj?l:0;let c=0,h=0;if(0!==l){if(c=a/l,(t-s.x)*l>0){const e=s.y+c*(t-s.x);o[0].x=t,o[0].y=e}if((e-s.x)*l>0){const t=s.y+c*(e-s.x);o[2].x=e,o[2].y=t}}if(0!==a){if(h=l/a,(n-s.y)*a>0){const t=s.x+h*(n-s.y);o[3].x=t,o[3].y=n}if((i-s.y)*a>0){const t=s.x+h*(i-s.y);o[1].x=t,o[1].y=i}}}function Kj(t,e){const i=e.x-t.x,n=e.y-t.y;if(0===i&&0===n)return 0;if(0===i)return n>0?.5*Math.PI:1.5*Math.PI;{let t=Math.atan(n/i);return i<0&&(t+=Math.PI),t}}function $j(t,e,i,n,s){const r=kj,o=r[0],a=r[1],l=r[2],c=r[3];t[e].x=i.x,t[e].y=i.y,t[e+1].x=n.x,t[e+1].y=n.y,t[e+2].x=s.x,t[e+2].y=s.y;let h=0,_=0;h=(i.x-o)/(l-o),_=(i.y-a)/(c-a),Jj(h,_,t,e),h=(n.x-o)/(l-o),_=(n.y-a)/(c-a),Jj(h,_,t,e+1),h=(s.x-o)/(l-o),_=(s.y-a)/(c-a),Jj(h,_,t,e+2)}function Jj(t,e,i,n){const s=Hj,r=s[0]+(s[2]-s[0])*t,o=s[4]+(s[6]-s[4])*t,a=s[1]+(s[3]-s[1])*t,l=s[5]+(s[7]-s[5])*t,c=i[n];c.u=r+(o-r)*e,c.v=a+(l-a)*e}const Zj={useModel:!1,createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.spriteFrame;_N.packToDynamicAtlas(t,e);const i=t.renderData;if(i&&e&&(i.vertDirty||i.uvDirty)){const n=i.data;let s=t.fillStart,r=t.fillRange;for(r<0&&(s+=r,r=-r);s>=1;)s-=1;for(;s<0;)s+=1;s*=zj,r*=zj;const o=s+r;!function(t){const e=t.node._uiProps.uiTransformComp,i=e.width,n=e.height,s=e.anchorX*i,r=e.anchorY*n,o=-s,a=-r,l=i-s,c=n-r,h=kj;h[0]=o,h[1]=a,h[2]=l,h[3]=c;const _=t.fillCenter,u=qj.x=Math.min(Math.max(0,_.x),1)*(l-o)+o,m=qj.y=Math.min(Math.max(0,_.y),1)*(c-a)+a;Gj[0].x=Gj[3].x=o,Gj[1].x=Gj[2].x=l,Gj[0].y=Gj[1].y=a,Gj[2].y=Gj[3].y=c;for(const t of Xj)tn.set(t,0,0);u!==h[0]&&tn.set(Xj[0],3,0),u!==h[2]&&tn.set(Xj[2],1,2),m!==h[1]&&tn.set(Xj[1],0,1),m!==h[3]&&tn.set(Xj[3],2,3)}(t),function(t){const e=t.width,i=t.height,n=t.getRect();let s=0,r=0,o=0,a=0;const l=Hj;t.isRotated()?(s=n.x/e,r=(n.x+n.height)/e,o=n.y/i,a=(n.y+n.width)/i,l[0]=l[2]=s,l[4]=l[6]=r,l[3]=l[7]=a,l[1]=l[5]=o):(s=n.x/e,r=(n.x+n.width)/e,o=n.y/i,a=(n.y+n.height)/i,l[0]=l[4]=s,l[2]=l[6]=r,l[1]=l[3]=a,l[5]=l[7]=o)}(e),Yj(kj[0],kj[2],kj[1],kj[3],qj,s,jj),Yj(kj[0],kj[2],kj[1],kj[3],qj,s+r,Wj);let a=0;for(let t=0;t<4;++t){const e=Xj[t];if(!e)continue;if(r>=zj){i.dataLength=a+3,$j(n,a,qj,Gj[e.x],Gj[e.y]),a+=3;continue}let l=Kj(qj,Gj[e.x]),c=Kj(qj,Gj[e.y]);c<l&&(c+=zj),l-=zj,c-=zj;for(let r=0;r<3;++r)l>=o||(l>=s?(i.dataLength=a+3,$j(n,a,qj,Gj[e.x],c>=o?Wj[t]:Gj[e.y]),a+=3):c>s&&(c<=o?(i.dataLength=a+3,$j(n,a,qj,jj[t],Gj[e.y]),a+=3):(i.dataLength=a+3,$j(n,a,qj,jj[t],Wj[t]),a+=3))),l+=zj,c+=zj}i.indicesCount=i.vertexCount=a,i.vertDirty=i.uvDirty=!1}},fillBuffers(t,e){const i=t.node,n=t.renderData;Uj.set(t.color),Uj.a=255*i._uiProps.opacity,function(t,e,i,n){const s=i.data;let r=e.acquireBufferBatch(),o=r.byteOffset>>2;const a=i.vertexCount;let l=r.indicesOffset,c=r.vertexOffset;r.request(a,i.indicesCount)||(r=e.currBufferBatch,o=0,l=0,c=0);const h=r.vData;t.getWorldMatrix(oN);for(let t=0;t<a;t++){const e=s[t];Ni.set(rN,e.x,e.y,0),Ni.transformMat4(rN,rN,oN),h[o++]=rN.x,h[o++]=rN.y,h[o++]=rN.z,h[o++]=e.u,h[o++]=e.v,Ri.toArray(h,n,o),o+=4}const _=r.iData;for(let t=0;t<i.dataLength;t++)_[l+t]=c+t}(i,e,n,Uj)},updateColor(t){}},Qj=[];for(let t=0;t<4;t++)Qj.push(new Ni);const tW={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){const e=t.spriteFrame;_N.packToDynamicAtlas(t,e);const i=t.renderData;i&&e&&(i.vertDirty&&this.updateVertexData(t),i.uvDirty&&this.updateUvs(t))},updateWorldVerts(t,e){const i=t.renderData.data,n=t.node,s=i[0],r=i[3],o=n.worldMatrix,a=o.m00,l=o.m01,c=o.m04,h=o.m05,_=1===a&&0===l&&0===c&&1===h,u=o.m12,m=o.m13,p=s.x,d=r.x,f=s.y,g=r.y;if(_){const t=p+u,i=d+u,n=f+m,s=g+m;e[0]=t,e[1]=n,e[9]=i,e[10]=n,e[18]=t,e[19]=s,e[27]=i,e[28]=s}else{const t=a*p,i=a*d,n=l*p,s=l*d,r=c*f+u,o=c*g+u,_=h*f+m,y=h*g+m;e[0]=t+r,e[1]=n+_,e[9]=i+r,e[10]=s+_,e[18]=t+o,e[19]=n+y,e[27]=i+o,e[28]=s+y}n._uiProps.uiTransformDirty=!1},fillBuffers(t,e){if(null===t)return;const i=t.renderData.vData;t.node._uiProps.uiTransformDirty&&this.updateWorldVerts(t,i);let n=e.acquireBufferBatch(),s=n.byteOffset>>2,r=n.indicesOffset,o=n.vertexOffset;n.request()||(n=e.currBufferBatch,s=0,r=0,o=0);const a=n.vData,l=n.iData;a.set(i,s);const c=o,h=o+1,_=o+2,u=o+3;l[r++]=c,l[r++]=h,l[r++]=_,l[r++]=_,l[r++]=h,l[r++]=u},updateVertexData(t){const e=t.renderData;if(!e)return;const i=t.node._uiProps.uiTransformComp,n=e.data,s=i.width,r=i.height,o=i.anchorX*s,a=i.anchorY*r;let l=0,c=0,h=0,_=0;if(t.trim)l=-o,c=-a,h=s-o,_=r-a;else{const e=t.spriteFrame,i=e.getOriginalSize(),n=e.getRect(),u=i.width,m=i.height,p=n.width,d=n.height,f=e.getOffset(),g=s/u,y=r/m,v=f.x+(u-p)/2,x=f.x-(u-p)/2;l=v*g-o,c=(f.y+(m-d)/2)*y-a,h=s+x*g-o,_=r+(f.y-(m-d)/2)*y-a}n[0].x=l,n[0].y=c,n[3].x=h,n[3].y=_,e.vertDirty=!1,this.updateWorldVerts(t,e.vData)},updateUvs(t){const e=t.renderData,i=e.vData,n=t.spriteFrame.uv;i[3]=n[0],i[4]=n[1],i[12]=n[2],i[13]=n[3],i[21]=n[4],i[22]=n[5],i[30]=n[6],i[31]=n[7],e.uvDirty=!1},updateColor(t){const e=t.renderData.vData;let i=5;const n=t.color,s=n.r/255,r=n.g/255,o=n.b/255,a=t.node._uiProps.opacity;for(let t=0;t<4;t++)e[i]=s,e[i+1]=r,e[i+2]=o,e[i+3]=a,i+=9}},eW=new Ni,iW=new $i,nW={useModel:!1,createData(t){const e=t.requestRenderData();return e.dataLength=20,e.vertexCount=16,e.indicesCount=54,e},updateRenderData(t){const e=t.spriteFrame;_N.packToDynamicAtlas(t,e);const i=t.renderData;i&&e&&i.vertDirty&&(this.updateVertexData(t),this.updateWorldVertexData(t))},updateVertexData(t){const e=t.renderData,i=e.data,n=t.node._uiProps.uiTransformComp,s=n.width,r=n.height,o=n.anchorX*s,a=n.anchorY*r,l=t.spriteFrame,c=l.insetLeft,h=l.insetRight,_=l.insetTop,u=l.insetBottom;let m=s-c-h,p=r-_-u,d=s/(c+h),f=r/(_+u);d=Number.isNaN(d)||d>1?1:d,f=Number.isNaN(f)||f>1?1:f,m=m<0?0:m,p=p<0?0:p,i[0].x=-o,i[0].y=-a,i[1].x=c*d-o,i[1].y=u*f-a,i[2].x=i[1].x+m,i[2].y=i[1].y+p,i[3].x=s-o,i[3].y=r-a,e.vertDirty=!1},fillBuffers(t,e){t.node.hasChangedFlags&&this.updateWorldVertexData(t);let i=e.acquireBufferBatch();const n=t.renderData,s=n.data;let r=i.byteOffset>>2;const o=n.vertexCount;let a=i.indicesOffset,l=i.vertexOffset;const c=t.spriteFrame.uvSliced;i.request(o,n.indicesCount)||(i=e.currBufferBatch,r=0,a=0,l=0);const h=i.vData,_=i.iData;for(let t=4;t<20;++t){const e=s[t],i=c[t-4];h[r++]=e.x,h[r++]=e.y,h[r++]=e.z,h[r++]=i.u,h[r++]=i.v,Ri.toArray(h,s[t].color,r),r+=4}for(let t=0;t<3;++t)for(let e=0;e<3;++e){const i=l+4*t+e;_[a++]=i,_[a++]=i+1,_[a++]=i+4,_[a++]=i+1,_[a++]=i+5,_[a++]=i+4}},updateWorldVertexData(t){const e=t.node,i=t.renderData.data;e.getWorldMatrix(iW);for(let t=0;t<4;++t){const e=i[t];for(let n=0;n<4;++n){const s=i[n],r=i[4+4*t+n];Ni.set(eW,s.x,e.y,0),Ni.transformMat4(r,eW,iW)}}},updateColor(t){const e=t.renderData.data,i=t.color,n=i.r,s=i.g,r=i.b,o=255*t.node._uiProps.opacity;for(let t=4;t<20;t++)e[t].color.r=n,e[t].color.g=s,e[t].color.b=r,e[t].color.a=o}},sW=[];for(let t=0;t<4;t++)sW.push(new Ni);const rW={createData:t=>t.requestRenderData(),updateRenderData(t){const e=t.renderData,i=t.spriteFrame;if(!i||!e||!e.uvDirty&&!e.vertDirty)return;const n=t.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=i.getRect(),a=i.insetLeft,l=i.insetRight,c=o.width-a-l,h=i.insetTop,_=i.insetBottom,u=o.height-h-_;let m=s-a-l,p=r-h-_;m=m>0?m:0,p=p>0?p:0;const d=0===c?m:m/c,f=0===u?p:p/u,g=Math.ceil(f+2),y=Math.ceil(d+2);e.dataLength=Math.max(8,g+1,y+1),this.updateVerts(t,m,p,g,y),e.vertexCount=g*y*4,e.indicesCount=g*y*6,e.uvDirty=!1,e.vertDirty=!1,this.updateColor(t)},fillBuffers(t,e){const i=t.node,n=t.node._uiProps.uiTransformComp,s=Math.abs(n.width),r=Math.abs(n.height),o=t.renderData;let a=e.acquireBufferBatch(),l=a.indicesOffset,c=a.byteOffset>>2,h=a.vertexOffset;const _=o.vertexCount,u=o.indicesCount,m=a.vData,p=a.iData;a.request(_,u)||(a=e.currBufferBatch,c=0,l=0,h=0);const d=t.spriteFrame,f=d.isRotated(),g=d.uv,y=t.spriteFrame.uvSliced,v=d.getRect(),x=d.insetLeft,b=d.insetRight,S=v.width-x-b,A=d.insetTop,C=d.insetBottom,T=v.height-A-C;let w=s-x-b,E=r-A-C;w=w>0?w:0,E=E>0?E:0;const P=0===S?w:w/S,D=0===T?E:E/T,I=Math.ceil(D+2),R=Math.ceil(P+2),M=i.worldMatrix,O=o.data;this.fillVertices(m,c,M,I,R,O);let B=0,N=0;const L=[],F=[];for(let t=0,e=I;t<e;++t){N=E>T?E>=t*T?1:D%1:D;for(let e=0,i=R;e<i;++e){B=w>S?w>=e*S?1:P%1:P;const i=c+3,n=i+1;f?(0===t?(L[0]=y[0].u,L[1]=y[0].u,L[2]=y[4].u+(y[8].u-y[4].u)*N):t<I-1?(L[0]=y[4].u,L[1]=y[4].u,L[2]=y[4].u+(y[8].u-y[4].u)*N):t===I-1&&(L[0]=y[8].u,L[1]=y[8].u,L[2]=y[12].u),0===e?(F[0]=y[0].v,F[1]=y[1].v+(y[2].v-y[1].v)*B,F[2]=y[0].v):e<R-1?(F[0]=y[1].v,F[1]=y[1].v+(y[2].v-y[1].v)*B,F[2]=y[1].v):e===R-1&&(F[0]=y[2].v,F[1]=y[3].v,F[2]=y[2].v),L[3]=L[2],F[3]=F[1]):(0===e?(L[0]=y[0].u,L[1]=y[1].u+(y[2].u-y[1].u)*B,L[2]=g[0]):e<R-1?(L[0]=y[1].u,L[1]=y[1].u+(y[2].u-y[1].u)*B,L[2]=y[1].u):e===R-1&&(L[0]=y[2].u,L[1]=y[3].u,L[2]=y[2].u),0===t?(F[0]=y[0].v,F[1]=y[0].v,F[2]=y[4].v+(y[8].v-y[4].v)*N):t<I-1?(F[0]=y[4].v,F[1]=y[4].v,F[2]=y[4].v+(y[8].v-y[4].v)*N):t===I-1&&(F[0]=y[8].v,F[1]=y[8].v,F[2]=y[12].v),L[3]=L[1],F[3]=F[2]),m[i]=L[0],m[n]=F[0],m[i+9]=L[1],m[n+9]=F[1],m[i+18]=L[2],m[n+18]=F[2],m[i+27]=L[3],m[n+27]=F[3],Ri.toArray(m,O[0].color,n+1),Ri.toArray(m,O[0].color,n+9+1),Ri.toArray(m,O[0].color,n+18+1),Ri.toArray(m,O[0].color,n+27+1),c+=36}}for(let t=0;t<u;t+=6)p[l++]=h,p[l++]=h+1,p[l++]=h+2,p[l++]=h+1,p[l++]=h+3,p[l++]=h+2,h+=4},fillVertices(t,e,i,n,s,r){let o=0,a=0,l=0,c=0;for(let h=0,_=n;h<_;++h){l=r[h].y,c=r[h+1].y;for(let n=0,h=s;n<h;++n){o=r[n].x,a=r[n+1].x,Ni.set(sW[0],o,l,0),Ni.set(sW[1],a,l,0),Ni.set(sW[2],o,c,0),Ni.set(sW[3],a,c,0);for(let n=0;n<4;n++){const s=sW[n];Ni.transformMat4(s,s,i);const r=9*n;t[e+r]=s.x,t[e+r+1]=s.y,t[e+r+2]=s.z}e+=36}}},updateVerts(t,e,i,n,s){const r=t.node._uiProps.uiTransformComp,o=t.renderData.data,a=t.spriteFrame,l=a.getRect(),c=Math.abs(r.width),h=Math.abs(r.height),_=r.anchorX*c,u=r.anchorY*h,m=a.insetLeft,p=a.insetRight,d=l.width-m-p,f=a.insetTop,g=a.insetBottom,y=l.height-f-g,v=r.width/(m+p)>1?1:r.width/(m+p),x=r.height/(f+g)>1?1:r.height/(f+g);let b=0,S=0;b=d>0?Math.floor(1e3*e)/1e3%d==0?d:e%d:e,S=y>0?Math.floor(1e3*i)/1e3%y==0?y:i%y:i;for(let t=0;t<=s;t++)0===t?o[t].x=-_:t>0&&t<s?o[t].x=1===t?m*v+Math.min(d,e)-_:d>0?t===s-1?m+b+d*(t-2)-_:m+Math.min(d,e)+d*(t-2)-_:m+e-_:t===s&&(o[t].x=Math.min(m+e+p,c)-_);for(let t=0;t<=n;t++)0===t?o[t].y=-u:t>0&&t<n?o[t].y=1===t?g*x+Math.min(y,i)-u:y>0?t===n-1?g+S+(t-2)*y-u:g+Math.min(y,i)+(t-2)*y-u:g+i-u:t===n&&(o[t].y=Math.min(g+i+f,h)-u)},updateColor(t){const e=t.renderData.data,i=e.length;if(0===i)return;const n=t.color,s=n.r,r=n.g,o=n.b,a=255*t.node._uiProps.opacity;for(let t=0;t<i;t++)e[t].color.r=s,e[t].color.g=r,e[t].color.b=o,e[t].color.a=a}},oW=HU.Type,aW=HU.FillType,lW=t("spriteAssembler",{getAssembler(t){let e=tW;const i=t;switch(i.type){case oW.SLICED:e=nW;break;case oW.TILED:e=rW;break;case oW.FILLED:e=i.fillType===aW.RADIAL?Zj:Fj}return e}});HU.Assembler=lW;const cW=LL.sharedManager,hW={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=4,e.indicesCount=6,e.vData=new Float32Array(36),e},updateRenderData(t){t.type===FV.IMAGE_STENCIL&&(tW.updateRenderData(t),tW.updateColor(t))},fillBuffers(t,e){(t.type!==FV.IMAGE_STENCIL||t.spriteFrame)&&(cW.pushMask(t),e.finishMergeBatches(),function(t,e){cW.clear(t),e.commitModel(t,t._clearModel,t._clearStencilMtl)}(t,e),function(t,e){if(cW.enterLevel(t),t.type===FV.IMAGE_STENCIL){tW.fillBuffers(t,e);const i=t.graphics.getMaterialInstance(0);e.forceMergeBatches(i,t.spriteFrame,t.graphics)}else t.graphics.updateAssembler(e)}(t,e),cW.enableMask())}},_W={fillBuffers(t,e){cW.exitMask()}},uW={getAssembler:()=>hW},mW={getAssembler:()=>_W};zV.Assembler=uW,zV.PostAssembler=mW;const pW=new so(null),dW=new $i;class fW{get currBufferBatch(){return this._currMeshBuffer||(this._currMeshBuffer=this.acquireBufferBatch()),this._currMeshBuffer}set currBufferBatch(t){t&&(this._currMeshBuffer=t)}get batches(){return this._batches}acquireBufferBatch(t=Mz){const e=t===Mz?36:Nz(t);return this._currMeshBuffer&&this._currMeshBuffer.vertexFormatBytes===e||this._requireBufferBatch(t),this._currMeshBuffer}registerCustomBuffer(t,e){let i;t instanceof tk?i=t:(i=this._bufferBatchPool.add(),i.initialize(t,e||this._recreateMeshBuffer.bind(this,t)));const n=i.vertexFormatBytes;let s=this._customMeshBuffers.get(n);return s||(s=[],this._customMeshBuffers.set(n,s)),s.push(i),i}unRegisterCustomBuffer(t){const e=this._customMeshBuffers.get(t.vertexFormatBytes);if(e)for(let i=0;i<e.length;i++)if(e[i]===t){e.splice(i,1);break}const i=this._bufferBatchPool.data.indexOf(t);-1!==i&&(t.reset(),this._bufferBatchPool.removeAt(i))}set currStaticRoot(t){this._currStaticRoot=t}set currIsStatic(t){this._currIsStatic=t}constructor(t){this.device=void 0,this._screens=[],this._bufferBatchPool=new V((()=>new tk(this)),128),this._drawBatchPool=void 0,this._meshBuffers=new Map,this._customMeshBuffers=new Map,this._meshBufferUseCount=new Map,this._batches=void 0,this._doUploadBuffersCall=new Map,this._emptyMaterial=new $g,this._currScene=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currMeshBuffer=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currBlendTargetHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currOpacity=1,this._descriptorSetCache=new yW,this._root=t,this.device=t.device,this._batches=new U(64),this._drawBatchPool=new z((()=>new ik),128)}initialize(){return!0}destroy(){for(let t=0;t<this._batches.length;t++)this._batches.array[t]&&this._batches.array[t].destroy(this);this._batches.destroy();for(const t of this._meshBuffers.keys()){const e=this._meshBuffers.get(t);e&&e.forEach((t=>t.destroy()))}this._drawBatchPool&&this._drawBatchPool.destroy((t=>{t.destroy(this)})),this._descriptorSetCache.destroy(),this._meshBuffers.clear(),LL.sharedManager.destroy()}addScreen(t){this._screens.push(t),this._screens.sort(this._screenSort)}getFirstRenderCamera(t){if(t.scene&&t.scene.renderScene){const e=t.scene.renderScene.cameras;for(let i=0;i<e.length;i++){const n=e[i];if(n.visibility&t.layer)return n}}return null}removeScreen(t){const e=this._screens.indexOf(t);-1!==e&&this._screens.splice(e,1)}sortScreens(){this._screens.sort(this._screenSort)}addUploadBuffersFunc(t,e){this._doUploadBuffersCall.set(t,e)}removeUploadBuffersFunc(t){this._doUploadBuffersCall.delete(t)}update(){const t=this._screens;for(let e=0;e<t.length;++e){const i=t[e];i.enabledInHierarchy&&(this._currOpacity=1,this._recursiveScreenNode(i.node))}let e=0;if(this._batches.length)for(let t=0;t<this._batches.length;++t){const i=this._batches.array[t];if(i.renderScene){if(i.model){const t=i.model.subModels;for(let i=0;i<t.length;i++)t[i].priority=e++}else i.descriptorSet=this._descriptorSetCache.getDescriptorSet(i);i.renderScene.addBatch(i)}}}uploadBuffers(){this._batches.length>0&&(this._doUploadBuffersCall.forEach(((t,e)=>{t.call(e,this)})),this._meshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._customMeshBuffers.forEach((t=>{t.forEach((t=>{t.uploadBuffers(),t.reset()}))})),this._descriptorSetCache.update())}reset(){for(let t=0;t<this._batches.length;++t){const e=this._batches.array[t];e.isStatic||(e.clear(),this._drawBatchPool.free(e))}this._currLayer=0,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._currScene=null,this._currMeshBuffer=null,this._currOpacity=1,this._meshBufferUseCount.clear(),this._batches.clear(),LL.sharedManager.reset(),this._descriptorSetCache.reset()}commitComp(t,e,i,n){const s=t;let r,o,a=0,l=0;e?(r=e.getGFXTexture(),o=e.getGFXSampler(),a=e.getHash(),l=e.getSamplerHash()):(r=null,o=null);const c=s._getRenderScene(),h=s.getRenderMaterial(0);s.stencilStage=LL.sharedManager.stage;const _=s.blendHash,u=s.stencilStage;this._currScene===c&&this._currLayer===t.node.layer&&this._currMaterial===h&&this._currBlendTargetHash===_&&this._currDepthStencilStateStage===u&&this._currTextureHash===a&&this._currSamplerHash===l&&this._currTransform===n||(this.autoMergeBatches(this._currComponent),this._currScene=c,this._currComponent=s,this._currTransform=n,this._currMaterial=h,this._currTexture=r,this._currSampler=o,this._currTextureHash=a,this._currSamplerHash=l,this._currBlendTargetHash=_,this._currDepthStencilStateStage=u,this._currLayer=t.node.layer),i&&i.fillBuffers(s,this)}commitModel(t,e,i){let s;this._currMaterial!==this._emptyMaterial&&this.autoMergeBatches(this._currComponent);let r=0;i&&(t.stencilStage!==BL.ENABLED&&t.stencilStage!==BL.DISABLED||(t.stencilStage=LL.sharedManager.stage),s=LL.sharedManager.getStencilStage(t.stencilStage,i),r=LL.sharedManager.getStencilHash(t.stencilStage));const o=n.director.getTotalFrames();e&&(e.updateTransform(o),e.updateUBOs(o));for(let n=0;n<e.subModels.length;n++){const o=this._drawBatchPool.alloc(),a=e.subModels[n];o.renderScene=t._getRenderScene(),o.visFlags=t.node.layer,o.model=e,o.bufferBatch=null,o.texture=null,o.sampler=null,o.useLocalData=null,s||(s=null),o.fillPasses(i,s,r,null,0,a.patches),o.descriptorSet=a.descriptorSet,o.inputAssembler=a.inputAssembler,o.model.visFlags=o.visFlags,this._batches.push(o)}this._currMaterial=this._emptyMaterial,this._currScene=null,this._currComponent=null,this._currTransform=null,this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}commitStaticBatch(t){this._batches.concat(t.drawBatchList),this.finishMergeBatches()}autoMergeBatches(t){const e=this.currBufferBatch,i=null==e?void 0:e.recordBatch(),n=this._currMaterial;if(!i||!n||!e)return;let s,r,o=0,a=0;t&&(s=-1===t.blendHash?null:t.getBlendState(),a=t.blendHash,r=null!==t.customMaterial?LL.sharedManager.getStencilStage(t.stencilStage,n):LL.sharedManager.getStencilStage(t.stencilStage),o=LL.sharedManager.getStencilHash(t.stencilStage));const l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.renderScene=this._currScene,l.visFlags=this._currLayer,l.bufferBatch=e,l.texture=this._currTexture,l.sampler=this._currSampler,l.inputAssembler=i,l.useLocalData=this._currTransform,l.textureHash=this._currTextureHash,l.samplerHash=this._currSamplerHash,l.fillPasses(n,r,o,s,a,null),this._batches.push(l),e.vertexStart=e.vertexOffset,e.indicesStart=e.indicesOffset,e.byteStart=e.byteOffset,yn.__isWebIOS14OrIPadOS14Env&&!this._currIsStatic&&(this._currMeshBuffer=null)}forceMergeBatches(t,e,i){this._currMaterial=t,e?(this._currTexture=e.getGFXTexture(),this._currSampler=e.getGFXSampler(),this._currTextureHash=e.getHash(),this._currSamplerHash=e.getSamplerHash()):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=i.node.layer,this._currScene=i._getRenderScene(),this.autoMergeBatches(i)}finishMergeBatches(){this.autoMergeBatches(),this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0}flushMaterial(t){this._currMaterial=t}walk(t,e=0){const i=t.children.length;if(this._preProcess(t),i>0&&!t._static){const i=t.children;for(let n=0;n<i.length;++n){this._currOpacity=t._uiProps.opacity;const s=i[n];this.walk(s,e)}}this._postProcess(t),e+=1}_preProcess(t){const e=t._uiProps.uiComp,i=t._uiProps.localOpacity;t._uiProps.opacity=this._currOpacity*i,t._uiProps.uiTransformComp&&e&&e.enabledInHierarchy&&e.updateAssembler(this)}_postProcess(t){const e=t._uiProps.uiComp;e&&e.enabledInHierarchy&&e.postUpdateAssembler(this)}_recursiveScreenNode(t){this.walk(t),this.autoMergeBatches(this._currComponent)}_createMeshBuffer(t){const e=this._bufferBatchPool.add();e.initialize(t,this._recreateMeshBuffer.bind(this,t));const i=Nz(t);let n=this._meshBuffers.get(i);return n||(n=[],this._meshBuffers.set(i,n)),n.push(e),e}_recreateMeshBuffer(t,e,i){this.autoMergeBatches(),this._requireBufferBatch(t,e,i)}_requireBufferBatch(t,e,i){const n=Nz(t);let s=this._meshBuffers.get(n);s||(s=[],this._meshBuffers.set(n,s));let r=this._meshBufferUseCount.get(n)||0;e&&i&&r++,this._currMeshBuffer=s[r],this._currMeshBuffer||(this._currMeshBuffer=this._createMeshBuffer(t)),this._meshBufferUseCount.set(n,r),e&&i&&this._currMeshBuffer.request(e,i)}_screenSort(t,e){return t.node.getSiblingIndex()-e.node.getSiblingIndex()}_releaseDescriptorSetCache(t){this._descriptorSetCache.releaseDescriptorSetCache(t)}}t("UI",fW);class gW{get descriptorSet(){return this._descriptorSet}constructor(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;const t=n.director.root.device;this._localData=new Float32Array(Vp.COUNT),this._localBuffer=t.createBuffer(new Pr(Ls.UNIFORM|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,Vp.SIZE,Vp.SIZE))}initialize(t){const e=n.director.root.device;this._transform=t.useLocalData,this._textureHash=t.textureHash,this._samplerHash=t.samplerHash,pW.layout=t.passes[0].localSetLayout,this._descriptorSet=e.createDescriptorSet(pW),this._descriptorSet.bindBuffer(Vp.BINDING,this._localBuffer);const i=ap.SAMPLER_SPRITE;this._descriptorSet.bindTexture(i,t.texture),this._descriptorSet.bindSampler(i,t.sampler),this._descriptorSet.update(),this._transformUpdate=!0}updateTransform(t){t!==this._transform&&(this._transform=t,this._transformUpdate=!0,this.uploadLocalData())}updateLocal(){this._transform&&this.uploadLocalData()}equals(t,e,i){return this._transform===t&&this._textureHash===e&&this._samplerHash===i}reset(){this._transform=null,this._textureHash=0,this._samplerHash=0}destroy(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null}uploadLocalData(){const t=this._transform;if((t.hasChangedFlags||t._dirtyFlags)&&t.updateWorldTransform(),this._transformUpdate){const e=t._mat;$i.toArray(this._localData,e,Vp.MAT_WORLD_OFFSET),$i.inverseTranspose(dW,e),$i.toArray(this._localData,dW,Vp.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}}}class yW{constructor(){this._descriptorSetCache=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new z((()=>new gW),16)}getDescriptorSet(t){const e=n.director.root;if(t.useLocalData){const e=this._localDescriptorSetCache;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n.equals(t.useLocalData,t.textureHash,t.samplerHash))return n.descriptorSet}const i=this._localCachePool.alloc();return i.initialize(t),this._localDescriptorSetCache.push(i),i.descriptorSet}{const i=this._descriptorSetCache.get(t.textureHash);if(i&&i.has(t.samplerHash))return i.get(t.samplerHash);{n.director.root.device,pW.layout=t.passes[0].localSetLayout;const s=e.device.createDescriptorSet(pW),r=ap.SAMPLER_SPRITE;return s.bindTexture(r,t.texture),s.bindSampler(r,t.sampler),s.update(),i?this._descriptorSetCache.get(t.textureHash).set(t.samplerHash,s):this._descriptorSetCache.set(t.textureHash,new Map([[t.samplerHash,s]])),s}}}update(){this._localDescriptorSetCache.forEach((t=>{t.updateLocal()}))}reset(){this._localDescriptorSetCache.forEach((t=>{this._localCachePool.free(t)})),this._localDescriptorSetCache.length=0}releaseDescriptorSetCache(t){this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).forEach((t=>{t.destroy()})),this._descriptorSetCache.delete(t))}destroy(){this._descriptorSetCache.forEach((t=>{t.forEach((t=>{t.destroy()}))})),this._descriptorSetCache.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy((t=>{t.destroy()}))}}n.internal.Batcher2D=fW;let vW=null,xW=-1;const bW="BES bswy:->@123",SW=Object.create(null),AW=[],CW=3e3,TW=(()=>{let t;return()=>{if(void 0===t)if("FontFace"in window){const e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),i=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);t=e?parseInt(e[1],10)>42:!i}else t=!1;return t}})();function wW(){let t=!0;const e=Date.now();for(let i=AW.length-1;i>=0;i--){const n=AW[i],s=n.fontFamilyName;if(e-n.startTime>CW){A(4933,s),n.onComplete(null,s),AW.splice(i,1);continue}const r=n.refWidth,o=`40px ${s}`;vW.font=o,r!==KN(vW,bW,o)?(AW.splice(i,1),n.onComplete(null,s)):t=!1}t&&(clearInterval(xW),xW=-1)}function EW(t,e,i){const n=function(t){const e=t.lastIndexOf(".ttf");if(-1===e)return t;const i=t.lastIndexOf("/");let n;return n=-1===i?`${t.substring(0,e)}_LABEL`:`${t.substring(i+1,e)}_LABEL`,-1!==n.indexOf(" ")&&(n=`"${n}"`),n}(t);if(SW[n])return void i(null,n);if(!vW){const t=document.createElement("canvas");t.width=100,t.height=100,vW=t.getContext("2d")}const s=KN(vW,bW,`40px ${n}`),r=document.createElement("style");r.type="text/css";let o="";Number.isNaN(n)?o+=`@font-face { font-family:${n}; src:`:o+=`@font-face { font-family:"${n}"; src:`,o+=`url("${t}");`,r.textContent=`${o}}`,document.body.appendChild(r);const a=document.createElement("div"),l=a.style;if(l.fontFamily=n,a.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(a),TW())!function(t,e,i){const n=new Promise(((i,n)=>{const s=()=>{Date.now()-t>=CW?n():document.fonts.load(`40px ${e}`).then((t=>{t.length>=1?i():setTimeout(s,100)}),(()=>{n()}))};s()}));let s=null;const r=new Promise(((t,e)=>{s=setTimeout(e,CW)}));Promise.race([r,n]).then((()=>{s&&(clearTimeout(s),s=null),i(null,e)}),(()=>{A(4933,e),i(null,e)}))}(Date.now(),n,i);else{const t={fontFamilyName:n,refWidth:s,onComplete:i,startTime:Date.now()};AW.push(t),-1===xW&&(xW=setInterval(wW,100))}SW[n]=r}function PW(t,e,i,n){const s=new CN;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}var DW,IW,RW,MW,OW,BW,NW,LW,FW,zW,VW,UW,GW,kW,HW,jW,WW,qW,XW,YW,KW,$W,JW,ZW,QW,tq,eq,iq,nq,sq,rq,oq,aq,lq,cq,hq,_q,uq,mq,pq,dq,fq,gq,yq,vq,xq,bq,Sq,Aq,Cq;mE.register({".font":EW,".eot":EW,".ttf":EW,".woff":EW,".svg":EW,".ttc":EW}),xE.register({".font":PW,".eot":PW,".ttf":PW,".woff":PW,".svg":PW,".ttc":PW}),n.UI={MeshBuffer:tk,spriteAssembler:lW,graphicsAssembler:_H,labelAssembler:Oj};const Tq=new Ri;var wq,Eq;let Pq;!function(t){t[t.NONE=0]="NONE",t[t.COLOR=1]="COLOR",t[t.SPRITE=2]="SPRITE",t[t.SCALE=3]="SCALE"}(wq||(wq={})),zt(wq),function(t){t.NORMAL="normal",t.HOVER="hover",t.PRESSED="pressed",t.DISABLED="disabled"}(Eq||(Eq={})),function(t){t.CLICK="click"}(Pq||(Pq={}));let Dq,Iq,Rq,Mq=function(e){return t({Button:e,ButtonComponent:e}),e}((DW=Vl("cc.Button"),IW=ec(),RW=Gl(110),MW=Jl(),OW=Ul(NL),BW=yc(Yv),NW=_c(),LW=rc(),FW=_c(),zW=rc(),VW=yc(wq),UW=_c(),GW=rc(),kW=rc(),HW=rc(),jW=rc(),WW=rc(),qW=ac(),XW=lc(),YW=rc(),KW=rc(),$W=yc(pN),JW=rc(),ZW=yc(pN),QW=rc(),tq=yc(pN),eq=rc(),iq=yc(pN),nq=rc(),sq=yc([rP]),rq=_c(),oq=rc(),DW(aq=IW(aq=RW(aq=MW(aq=OW(aq=$l((Cq=Aq=class extends Rh{constructor(...t){super(...t),Tl(this,"clickEvents",cq,this),Tl(this,"_interactable",hq,this),Tl(this,"_transition",_q,this),Tl(this,"_normalColor",uq,this),Tl(this,"_hoverColor",mq,this),Tl(this,"_pressedColor",pq,this),Tl(this,"_disabledColor",dq,this),Tl(this,"_normalSprite",fq,this),Tl(this,"_hoverSprite",gq,this),Tl(this,"_pressedSprite",yq,this),Tl(this,"_disabledSprite",vq,this),Tl(this,"_duration",xq,this),Tl(this,"_zoomScale",bq,this),Tl(this,"_target",Sq,this),this._pressed=!1,this._hovered=!1,this._fromColor=new Ri,this._toColor=new Ri,this._time=0,this._transitionFinished=!0,this._fromScale=new Ni,this._toScale=new Ni,this._originalScale=null,this._sprite=null,this._targetScale=new Ni}get target(){return this._target||this.node}set target(t){this._target!==t&&(this._target&&this._unregisterTargetEvent(this._target),this._target=t,this._applyTarget())}get interactable(){return this._interactable}set interactable(t){this._interactable=t,this._updateState(),this._interactable||this._resetState()}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get transition(){return this._transition}set transition(t){this._transition!==t&&(this._transition===wq.COLOR?this._updateColorTransition(Eq.NORMAL):this._transition===wq.SPRITE&&this._updateSpriteTransition(Eq.NORMAL),this._transition=t,this._updateState())}get normalColor(){return this._normalColor}set normalColor(t){this._normalColor!==t&&(this._normalColor.set(t),this._updateState())}get pressedColor(){return this._pressedColor}set pressedColor(t){this._pressedColor!==t&&this._pressedColor.set(t)}get hoverColor(){return this._hoverColor}set hoverColor(t){this._hoverColor!==t&&this._hoverColor.set(t)}get disabledColor(){return this._disabledColor}set disabledColor(t){this._disabledColor!==t&&(this._disabledColor.set(t),this._updateState())}get duration(){return this._duration}set duration(t){this._duration!==t&&(this._duration=t)}get zoomScale(){return this._zoomScale}set zoomScale(t){this._zoomScale!==t&&(this._zoomScale=t)}get normalSprite(){return this._normalSprite}set normalSprite(t){if(this._normalSprite===t)return;this._normalSprite=t;const e=this.node.getComponent(HU);e&&(e.spriteFrame=t),this._updateState()}get pressedSprite(){return this._pressedSprite}set pressedSprite(t){this._pressedSprite!==t&&(this._pressedSprite=t,this._updateState())}get hoverSprite(){return this._hoverSprite}set hoverSprite(t){this._hoverSprite!==t&&(this._hoverSprite=t,this._updateState())}get disabledSprite(){return this._disabledSprite}set disabledSprite(t){this._disabledSprite!==t&&(this._disabledSprite=t,this._updateState())}__preload(){this.target||(this.target=this.node);const t=this.node.getComponent(HU);t&&(this._normalSprite=t.spriteFrame),this._applyTarget(),this._resetState()}onEnable(){this._registerNodeEvent()}onDisable(){this._resetState(),this._unregisterNodeEvent()}update(t){const e=this.target;if(this._transitionFinished||!e)return;if(this._transition!==wq.COLOR&&this._transition!==wq.SCALE)return;this._time+=t;let i=1;if(this._duration>0&&(i=this._time/this._duration),i>=1&&(i=1),this._transition===wq.COLOR){const t=e._uiProps.uiComp;Ri.lerp(Tq,this._fromColor,this._toColor,i),t&&(t.color=Tq)}else this.transition===wq.SCALE&&(e.getScale(this._targetScale),this._targetScale.x=pi(this._fromScale.x,this._toScale.x,i),this._targetScale.y=pi(this._fromScale.y,this._toScale.y,i),e.setScale(this._targetScale));1===i&&(this._transitionFinished=!0)}_resizeNodeToTargetNode(){this.target&&this.target._uiProps.uiTransformComp}_resetState(){this._pressed=!1,this._hovered=!1;const t=this.target;if(!t)return;const e=this._transition;if(e===wq.COLOR&&this._interactable){const e=t.getComponent(iF);e&&(e.color=this._normalColor)}else e===wq.SCALE&&this._originalScale&&t.setScale(this._originalScale);this._transitionFinished=!0}_registerNodeEvent(){this.node.on(ev.TOUCH_START,this._onTouchBegan,this),this.node.on(ev.TOUCH_MOVE,this._onTouchMove,this),this.node.on(ev.TOUCH_END,this._onTouchEnded,this),this.node.on(ev.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(ev.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(ev.MOUSE_LEAVE,this._onMouseMoveOut,this)}_registerTargetEvent(t){t.on(ev.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)}_unregisterNodeEvent(){this.node.off(ev.TOUCH_START,this._onTouchBegan,this),this.node.off(ev.TOUCH_MOVE,this._onTouchMove,this),this.node.off(ev.TOUCH_END,this._onTouchEnded,this),this.node.off(ev.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(ev.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(ev.MOUSE_LEAVE,this._onMouseMoveOut,this)}_unregisterTargetEvent(t){t.off(ev.TRANSFORM_CHANGED)}_getTargetSprite(t){let e=null;return t&&(e=t.getComponent(HU)),e}_applyTarget(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new Ni),Ni.copy(this._originalScale,this.target.getScale()))}_onTargetSpriteFrameChanged(t){this._transition===wq.SPRITE&&this._setCurrentStateSpriteFrame(t.spriteFrame)}_setCurrentStateSpriteFrame(t){if(t)switch(this._getButtonState()){case Eq.NORMAL:this._normalSprite=t;break;case Eq.HOVER:this._hoverSprite=t;break;case Eq.PRESSED:this._pressedSprite=t;break;case Eq.DISABLED:this._disabledSprite=t}}_onTargetColorChanged(t){this._transition===wq.COLOR&&this._setCurrentStateColor(t)}_setCurrentStateColor(t){switch(this._getButtonState()){case Eq.NORMAL:this._normalColor=t;break;case Eq.HOVER:this._hoverColor=t;break;case Eq.PRESSED:this._pressedColor=t;break;case Eq.DISABLED:this._disabledColor=t}}_onTargetTransformChanged(t){t|Sg.SCALE&&this._originalScale&&this._transition===wq.SCALE&&this._transitionFinished&&Ni.copy(this._originalScale,this.target.getScale())}_onTouchBegan(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchMove(t){if(!this._interactable||!this.enabledInHierarchy||!this._pressed)return;if(!t)return;const e=t.touch;if(!e)return;const i=this.node._uiProps.uiTransformComp.isHit(e.getUILocation());if(this._transition===wq.SCALE&&this.target&&this._originalScale)i?(Ni.copy(this._fromScale,this._originalScale),Ni.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale));else{let t;t=i?Eq.PRESSED:Eq.NORMAL,this._applyTransition(t)}t&&(t.propagationStopped=!0)}_onTouchEnded(t){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(rP.emitEvents(this.clickEvents,t),this.node.emit(Pq.CLICK,this)),this._pressed=!1,this._updateState(),t&&(t.propagationStopped=!0))}_onTouchCancel(t){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())}_onMouseMoveIn(t){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==wq.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))}_onMouseMoveOut(t){this._hovered&&(this._hovered=!1,this._updateState())}_updateState(){const t=this._getButtonState();this._applyTransition(t)}_getButtonState(){let t=Eq.NORMAL;return this._interactable?this._pressed?t=Eq.PRESSED:this._hovered&&(t=Eq.HOVER):t=Eq.DISABLED,t.toString()}_updateColorTransition(t){var e;const i=this[`${t}Color`],n=null===(e=this.target)||void 0===e?void 0:e.getComponent(iF);n&&(t===Eq.DISABLED?n.color=i:(this._fromColor=n.color.clone(),this._toColor=i,this._time=0,this._transitionFinished=!1))}_updateSpriteTransition(t){const e=this[`${t}Sprite`];this._sprite&&e&&(this._sprite.spriteFrame=e)}_updateScaleTransition(t){this._interactable&&(t===Eq.PRESSED?this._zoomUp():this._zoomBack())}_zoomUp(){this._originalScale&&(Ni.copy(this._fromScale,this._originalScale),Ni.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)}_zoomBack(){this.target&&this._originalScale&&(Ni.copy(this._fromScale,this.target.getScale()),Ni.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)}_applyTransition(t){const e=this._transition;e===wq.COLOR?this._updateColorTransition(t):e===wq.SPRITE?this._updateSpriteTransition(t):e===wq.SCALE&&this._updateScaleTransition(t)}},Aq.Transition=wq,Aq.EventType=Pq,wl((lq=Cq).prototype,"target",[BW,NW,LW],Object.getOwnPropertyDescriptor(lq.prototype,"target"),lq.prototype),wl(lq.prototype,"interactable",[FW,zW],Object.getOwnPropertyDescriptor(lq.prototype,"interactable"),lq.prototype),wl(lq.prototype,"transition",[VW,UW,GW],Object.getOwnPropertyDescriptor(lq.prototype,"transition"),lq.prototype),wl(lq.prototype,"normalColor",[kW],Object.getOwnPropertyDescriptor(lq.prototype,"normalColor"),lq.prototype),wl(lq.prototype,"pressedColor",[HW],Object.getOwnPropertyDescriptor(lq.prototype,"pressedColor"),lq.prototype),wl(lq.prototype,"hoverColor",[jW],Object.getOwnPropertyDescriptor(lq.prototype,"hoverColor"),lq.prototype),wl(lq.prototype,"disabledColor",[WW],Object.getOwnPropertyDescriptor(lq.prototype,"disabledColor"),lq.prototype),wl(lq.prototype,"duration",[qW,XW,YW],Object.getOwnPropertyDescriptor(lq.prototype,"duration"),lq.prototype),wl(lq.prototype,"zoomScale",[KW],Object.getOwnPropertyDescriptor(lq.prototype,"zoomScale"),lq.prototype),wl(lq.prototype,"normalSprite",[$W,JW],Object.getOwnPropertyDescriptor(lq.prototype,"normalSprite"),lq.prototype),wl(lq.prototype,"pressedSprite",[ZW,QW],Object.getOwnPropertyDescriptor(lq.prototype,"pressedSprite"),lq.prototype),wl(lq.prototype,"hoverSprite",[tq,eq],Object.getOwnPropertyDescriptor(lq.prototype,"hoverSprite"),lq.prototype),wl(lq.prototype,"disabledSprite",[iq,nq],Object.getOwnPropertyDescriptor(lq.prototype,"disabledSprite"),lq.prototype),cq=wl(lq.prototype,"clickEvents",[sq,Wl,rq,oq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),hq=wl(lq.prototype,"_interactable",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_q=wl(lq.prototype,"_transition",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return wq.NONE}}),uq=wl(lq.prototype,"_normalColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.WHITE.clone()}}),mq=wl(lq.prototype,"_hoverColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(211,211,211,255)}}),pq=wl(lq.prototype,"_pressedColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ri.WHITE.clone()}}),dq=wl(lq.prototype,"_disabledColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(124,124,124,255)}}),fq=wl(lq.prototype,"_normalSprite",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),gq=wl(lq.prototype,"_hoverSprite",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),yq=wl(lq.prototype,"_pressedSprite",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vq=wl(lq.prototype,"_disabledSprite",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xq=wl(lq.prototype,"_duration",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),bq=wl(lq.prototype,"_zoomScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),Sq=wl(lq.prototype,"_target",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aq=lq))||aq)||aq)||aq)||aq)||aq)||aq));(function(t){t[t.DEFAULT=0]="DEFAULT",t[t.DONE=1]="DONE",t[t.SEND=2]="SEND",t[t.SEARCH=3]="SEARCH",t[t.GO=4]="GO",t[t.NEXT=5]="NEXT"})(Dq||(Dq={})),Nt(Dq),function(t){t[t.ANY=0]="ANY",t[t.EMAIL_ADDR=1]="EMAIL_ADDR",t[t.NUMERIC=2]="NUMERIC",t[t.PHONE_NUMBER=3]="PHONE_NUMBER",t[t.URL=4]="URL",t[t.DECIMAL=5]="DECIMAL",t[t.SINGLE_LINE=6]="SINGLE_LINE"}(Iq||(Iq={})),Nt(Iq),function(t){t[t.PASSWORD=0]="PASSWORD",t[t.SENSITIVE=1]="SENSITIVE",t[t.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",t[t.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",t[t.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",t[t.DEFAULT=5]="DEFAULT"}(Rq||(Rq={})),Nt(Rq);var Oq,Bq,Nq,Lq,Fq,zq,Vq,Uq,Gq,kq,Hq,jq,Wq,qq,Xq,Yq,Kq,$q,Jq,Zq,Qq,tX,eX,iX,nX,sX,rX,oX,aX,lX,cX,hX,_X,uX,mX,pX,dX,fX,gX,yX,vX,xX,bX,SX,AX,CX,TX,wX,EX,PX,DX,IX,RX,MX,OX,BX,NX,LX,FX,zX,VX;new $i,new $i,new Ni,function(t){t.EDITING_DID_BEGAN="editing-did-began",t.EDITING_DID_ENDED="editing-did-ended",t.TEXT_CHANGED="text-changed",t.EDITING_RETURN="editing-return"}(VX||(VX={}));let UX=function(e){return t({EditBox:e,EditBoxComponent:e}),e}((Oq=Vl("cc.EditBox"),Bq=ec(),Nq=Gl(110),Lq=Jl(),Fq=Ul(NL),zq=_c(),Vq=rc(),Uq=_c(),Gq=rc(),kq=yc(fz),Hq=_c(),jq=rc(),Wq=yc(fz),qq=_c(),Xq=rc(),Yq=yc(pN),Kq=_c(),$q=rc(),Jq=yc(Rq),Zq=_c(),Qq=rc(),tX=yc(Iq),eX=_c(),iX=rc(),nX=yc(Dq),sX=_c(),rX=rc(),oX=_c(),aX=rc(),lX=_c(),cX=rc(),hX=yc([rP]),_X=_c(),uX=rc(),mX=yc([rP]),pX=_c(),dX=rc(),fX=yc([rP]),gX=_c(),yX=rc(),vX=yc([rP]),xX=_c(),bX=rc(),Oq(SX=Bq(SX=Nq(SX=Lq(SX=Fq(SX=$l((zX=FX=class t extends Rh{constructor(...t){super(...t),Tl(this,"editingDidBegan",CX,this),Tl(this,"textChanged",TX,this),Tl(this,"editingDidEnded",wX,this),Tl(this,"editingReturn",EX,this),this._impl=null,this._background=null,Tl(this,"_textLabel",PX,this),Tl(this,"_placeholderLabel",DX,this),Tl(this,"_returnType",IX,this),Tl(this,"_string",RX,this),Tl(this,"_tabIndex",MX,this),Tl(this,"_backgroundImage",OX,this),Tl(this,"_inputFlag",BX,this),Tl(this,"_inputMode",NX,this),Tl(this,"_maxLength",LX,this),this._isLabelVisible=!1}get string(){return this._string}set string(t){this._maxLength>=0&&t.length>=this._maxLength&&(t=t.slice(0,this._maxLength)),this._string=t,this._updateString(t)}get placeholder(){return this._placeholderLabel?this._placeholderLabel.string:""}set placeholder(t){this._placeholderLabel&&(this._placeholderLabel.string=t)}get textLabel(){return this._textLabel}set textLabel(t){this._textLabel!==t&&(this._textLabel=t,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}get placeholderLabel(){return this._placeholderLabel}set placeholderLabel(t){this._placeholderLabel!==t&&(this._placeholderLabel=t,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}get backgroundImage(){return this._backgroundImage}set backgroundImage(t){this._backgroundImage!==t&&(this._backgroundImage=t,this._createBackgroundSprite())}get inputFlag(){return this._inputFlag}set inputFlag(t){this._inputFlag=t,this._updateString(this._string)}get inputMode(){return this._inputMode}set inputMode(t){this._inputMode!==t&&(this._inputMode=t,this._updateTextLabel(),this._updatePlaceholderLabel())}get returnType(){return this._returnType}set returnType(t){this._returnType=t}get maxLength(){return this._maxLength}set maxLength(t){this._maxLength=t}get tabIndex(){return this._tabIndex}set tabIndex(t){this._tabIndex!==t&&(this._tabIndex=t,this._impl&&this._impl.setTabIndex(t))}__preload(){this._init()}onEnable(){this._registerEvent(),this._impl&&this._impl.onEnable()}update(){this._impl&&this._impl.update()}onDisable(){this._unregisterEvent(),this._impl&&this._impl.onDisable()}onDestroy(){this._impl&&this._impl.clear()}setFocus(){this._impl&&this._impl.setFocus(!0)}focus(){this._impl&&this._impl.setFocus(!0)}blur(){this._impl&&this._impl.setFocus(!1)}isFocused(){return!!this._impl&&this._impl.isFocused()}_editBoxEditingDidBegan(){rP.emitEvents(this.editingDidBegan,this),this.node.emit(VX.EDITING_DID_BEGAN,this)}_editBoxEditingDidEnded(){rP.emitEvents(this.editingDidEnded,this),this.node.emit(VX.EDITING_DID_ENDED,this)}_editBoxTextChanged(t){t=this._updateLabelStringStyle(t,!0),this.string=t,rP.emitEvents(this.textChanged,t,this),this.node.emit(VX.TEXT_CHANGED,this)}_editBoxEditingReturn(){rP.emitEvents(this.editingReturn,this),this.node.emit(VX.EDITING_RETURN,this)}_showLabels(){this._isLabelVisible=!0,this._updateLabels()}_hideLabels(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)}_onTouchBegan(t){t.propagationStopped=!0}_onTouchCancel(t){t.propagationStopped=!0}_onTouchEnded(t){this._impl&&this._impl.beginEditing(),t.propagationStopped=!0}_init(){this._createBackgroundSprite(),this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(ev.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()}_createBackgroundSprite(){this._background||(this._background=this.node.getComponent(HU),this._background||(this._background=this.node.addComponent(HU))),this._background.type=HU.Type.SLICED,this._background.spriteFrame=this._backgroundImage}_updateTextLabel(){let t=this._textLabel;if(!t){let e=this.node.getChildByName("TEXT_LABEL");e||(e=new Yv("TEXT_LABEL")),t=e.getComponent(fz),t||(t=e.addComponent(fz)),e.parent=this.node,this._textLabel=t}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=fz.Overflow.CLAMP,this._inputMode===Iq.ANY?(t.verticalAlign=hz.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this._updateLabelStringStyle(this._string)}_updatePlaceholderLabel(){let t=this._placeholderLabel;if(!t){let e=this.node.getChildByName("PLACEHOLDER_LABEL");e||(e=new Yv("PLACEHOLDER_LABEL")),t=e.getComponent(fz),t||(t=e.addComponent(fz)),e.parent=this.node,this._placeholderLabel=t}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),t.overflow=fz.Overflow.CLAMP,this._inputMode===Iq.ANY?(t.verticalAlign=hz.TOP,t.enableWrapText=!0):t.enableWrapText=!1,t.string=this.placeholder}_syncSize(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(this._background){const i=this._background.node._uiProps.uiTransformComp;i.anchorPoint=t.anchorPoint,i.setContentSize(e)}this._updateLabelPosition(e),this._impl&&this._impl.setSize(e.width,e.height)}_updateLabels(){if(this._isLabelVisible){const t=this._string;this._textLabel&&(this._textLabel.node.active=""!==t),this._placeholderLabel&&(this._placeholderLabel.node.active=""===t)}}_updateString(t){const e=this._textLabel;if(!e)return;let i=t;i&&(i=this._updateLabelStringStyle(i)),e.string=i,this._updateLabels()}_updateLabelStringStyle(t,e=!1){const i=this._inputFlag;if(e||i!==Rq.PASSWORD)i===Rq.INITIAL_CAPS_ALL_CHARACTERS?t=t.toUpperCase():i===Rq.INITIAL_CAPS_WORD?t=t.replace(/(?:^|\s)\S/g,(t=>t.toUpperCase())):i===Rq.INITIAL_CAPS_SENTENCE&&(t=(n=t).charAt(0).toUpperCase()+n.slice(1));else{let e="";const i=t.length;for(let t=0;t<i;++t)e+="";t=e}var n;return t}_registerEvent(){this.node.on(ev.TOUCH_START,this._onTouchBegan,this),this.node.on(ev.TOUCH_END,this._onTouchEnded,this)}_unregisterEvent(){this.node.off(ev.TOUCH_START,this._onTouchBegan,this),this.node.off(ev.TOUCH_END,this._onTouchEnded,this)}_updateLabelPosition(t){const e=this.node._uiProps.uiTransformComp,i=-e.anchorX*e.width,n=-e.anchorY*e.height,s=this._placeholderLabel,r=this._textLabel;r&&(r.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),r.node.setPosition(i+2,n+t.height,r.node.position.z),this._inputMode===Iq.ANY&&(r.verticalAlign=hz.TOP),r.enableWrapText=this._inputMode===Iq.ANY),s&&(s.node._uiProps.uiTransformComp.setContentSize(t.width-2,t.height),s.lineHeight=t.height,s.node.setPosition(i+2,n+t.height,s.node.position.z),this._inputMode===Iq.ANY&&(s.verticalAlign=hz.TOP),s.enableWrapText=this._inputMode===Iq.ANY)}_resizeChildNodes(){const t=this.node._uiProps.uiTransformComp,e=this._textLabel&&this._textLabel.node;e&&(e.setPosition(-t.width/2,t.height/2,e.position.z),e._uiProps.uiTransformComp.setContentSize(t.contentSize));const i=this._placeholderLabel&&this._placeholderLabel.node;i&&(i.setPosition(-t.width/2,t.height/2,i.position.z),i._uiProps.uiTransformComp.setContentSize(t.contentSize));const n=this._background&&this._background.node;n&&n._uiProps.uiTransformComp.setContentSize(t.contentSize)}},FX._EditBoxImpl=class{constructor(){this._editing=!1,this._delegate=null}init(t){}onEnable(){}update(){}onDisable(){this._editing&&this.endEditing()}clear(){this._delegate=null}setTabIndex(t){}setSize(t,e){}setFocus(t){t?this.beginEditing():this.endEditing()}isFocused(){return this._editing}beginEditing(){}endEditing(){}},FX.KeyboardReturnType=Dq,FX.InputFlag=Rq,FX.InputMode=Iq,FX.EventType=VX,wl((AX=zX).prototype,"string",[zq,Vq],Object.getOwnPropertyDescriptor(AX.prototype,"string"),AX.prototype),wl(AX.prototype,"placeholder",[Uq,Gq],Object.getOwnPropertyDescriptor(AX.prototype,"placeholder"),AX.prototype),wl(AX.prototype,"textLabel",[kq,Hq,jq],Object.getOwnPropertyDescriptor(AX.prototype,"textLabel"),AX.prototype),wl(AX.prototype,"placeholderLabel",[Wq,qq,Xq],Object.getOwnPropertyDescriptor(AX.prototype,"placeholderLabel"),AX.prototype),wl(AX.prototype,"backgroundImage",[Yq,Kq,$q],Object.getOwnPropertyDescriptor(AX.prototype,"backgroundImage"),AX.prototype),wl(AX.prototype,"inputFlag",[Jq,Zq,Qq],Object.getOwnPropertyDescriptor(AX.prototype,"inputFlag"),AX.prototype),wl(AX.prototype,"inputMode",[tX,eX,iX],Object.getOwnPropertyDescriptor(AX.prototype,"inputMode"),AX.prototype),wl(AX.prototype,"returnType",[nX,sX,rX],Object.getOwnPropertyDescriptor(AX.prototype,"returnType"),AX.prototype),wl(AX.prototype,"maxLength",[oX,aX],Object.getOwnPropertyDescriptor(AX.prototype,"maxLength"),AX.prototype),wl(AX.prototype,"tabIndex",[lX,cX],Object.getOwnPropertyDescriptor(AX.prototype,"tabIndex"),AX.prototype),CX=wl(AX.prototype,"editingDidBegan",[hX,Wl,_X,uX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TX=wl(AX.prototype,"textChanged",[mX,Wl,pX,dX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wX=wl(AX.prototype,"editingDidEnded",[fX,Wl,gX,yX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),EX=wl(AX.prototype,"editingReturn",[vX,Wl,xX,bX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PX=wl(AX.prototype,"_textLabel",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DX=wl(AX.prototype,"_placeholderLabel",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),IX=wl(AX.prototype,"_returnType",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Dq.DEFAULT}}),RX=wl(AX.prototype,"_string",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),MX=wl(AX.prototype,"_tabIndex",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OX=wl(AX.prototype,"_backgroundImage",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BX=wl(AX.prototype,"_inputFlag",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rq.DEFAULT}}),NX=wl(AX.prototype,"_inputMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Iq.ANY}}),LX=wl(AX.prototype,"_maxLength",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),SX=AX))||SX)||SX)||SX)||SX)||SX)||SX));var GX,kX,HX,jX,WX,qX,XX,YX,KX,$X,JX,ZX,QX,tY,eY,iY,nY,sY,rY,oY,aY,lY,cY,hY,_Y,uY,mY,pY,dY,fY,gY,yY,vY,xY,bY,SY,AY,CY,TY,wY,EY,PY,DY,IY,RY,MY,OY,BY,NY,LY,FY,zY,VY,UY,GY,kY,HY,jY,WY,qY;(function(t){t[t.NONE=0]="NONE",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.GRID=3]="GRID"})(GY||(GY={})),zt(GY),function(t){t[t.NONE=0]="NONE",t[t.CONTAINER=1]="CONTAINER",t[t.CHILDREN=2]="CHILDREN"}(kY||(kY={})),zt(kY),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(HY||(HY={})),zt(HY),function(t){t[t.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",t[t.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(jY||(jY={})),zt(jY),function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(WY||(WY={})),zt(WY),function(t){t[t.NONE=0]="NONE",t[t.FIXED_ROW=1]="FIXED_ROW",t[t.FIXED_COL=2]="FIXED_COL"}(qY||(qY={})),zt(qY);const XY=new Ni;let YY=function(e){return t({Layout:e,LayoutComponent:e}),e}((GX=Vl("cc.Layout"),kX=ec(),HX=Gl(110),jX=Jl(),WX=Ul(NL),qX=nc(),XX=rc(),YX=nc(),KX=rc(),$X=yc(GY),JX=rc(),ZX=yc(kY),QX=nc(),tY=rc(),eY=nc(),iY=rc(),nY=yc(HY),sY=rc(),rY=rc(),oY=rc(),aY=rc(),lY=rc(),cY=rc(),hY=rc(),_Y=yc(jY),uY=rc(),mY=yc(WY),pY=rc(),dY=yc(qY),fY=nc(),gY=rc(),yY=nc(),vY=rc(),xY=rc(),GX(bY=kX(bY=HX(bY=jX(bY=WX(bY=$l((UY=VY=class extends Rh{constructor(...t){super(...t),Tl(this,"_resizeMode",AY,this),Tl(this,"_layoutType",CY,this),Tl(this,"_cellSize",TY,this),Tl(this,"_startAxis",wY,this),Tl(this,"_paddingLeft",EY,this),Tl(this,"_paddingRight",PY,this),Tl(this,"_paddingTop",DY,this),Tl(this,"_paddingBottom",IY,this),Tl(this,"_spacingX",RY,this),Tl(this,"_spacingY",MY,this),Tl(this,"_verticalDirection",OY,this),Tl(this,"_horizontalDirection",BY,this),Tl(this,"_constraint",NY,this),Tl(this,"_constraintNum",LY,this),Tl(this,"_affectedByScale",FY,this),Tl(this,"_isAlign",zY,this),this._layoutSize=new ln(300,200),this._layoutDirty=!0,this._childrenDirty=!1,this._usefulLayoutObj=[],this._init=!1}get alignHorizontal(){return this._isAlign}set alignHorizontal(t){this._layoutType===GY.HORIZONTAL&&(this._isAlign=t,this._doLayoutDirty())}get alignVertical(){return this._isAlign}set alignVertical(t){this._layoutType===GY.VERTICAL&&(this._isAlign=t,this._doLayoutDirty())}get type(){return this._layoutType}set type(t){this._layoutType=t,this._doLayoutDirty()}get resizeMode(){return this._resizeMode}set resizeMode(t){this._layoutType!==GY.NONE&&(this._resizeMode=t,this._doLayoutDirty())}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize.set(t),this._doLayoutDirty())}get startAxis(){return this._startAxis}set startAxis(t){this._startAxis!==t&&(this._startAxis=t,this._doLayoutDirty())}get paddingLeft(){return this._paddingLeft}set paddingLeft(t){this._paddingLeft!==t&&(this._paddingLeft=t,this._doLayoutDirty())}get paddingRight(){return this._paddingRight}set paddingRight(t){this._paddingRight!==t&&(this._paddingRight=t,this._doLayoutDirty())}get paddingTop(){return this._paddingTop}set paddingTop(t){this._paddingTop!==t&&(this._paddingTop=t,this._doLayoutDirty())}get paddingBottom(){return this._paddingBottom}set paddingBottom(t){this._paddingBottom!==t&&(this._paddingBottom=t,this._doLayoutDirty())}get spacingX(){return this._spacingX}set spacingX(t){this._spacingX!==t&&(this._spacingX=t,this._doLayoutDirty())}get spacingY(){return this._spacingY}set spacingY(t){this._spacingY!==t&&(this._spacingY=t,this._doLayoutDirty())}get verticalDirection(){return this._verticalDirection}set verticalDirection(t){this._verticalDirection!==t&&(this._verticalDirection=t,this._doLayoutDirty())}get horizontalDirection(){return this._horizontalDirection}set horizontalDirection(t){this._horizontalDirection!==t&&(this._horizontalDirection=t,this._doLayoutDirty())}get padding(){return this._paddingLeft}set padding(t){this.paddingLeft===t&&this._paddingRight===t&&this._paddingTop===t&&this._paddingBottom===t||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=t,this._doLayoutDirty())}get constraint(){return this._constraint}set constraint(t){this._layoutType!==GY.NONE&&this._constraint!==t&&(this._constraint=t,this._doLayoutDirty())}get constraintNum(){return this._constraintNum}set constraintNum(t){this._constraint!==qY.NONE&&this._constraintNum!==t&&(t<=0&&m("Limit values to be greater than 0"),this._constraintNum=t,this._doLayoutDirty())}get affectedByScale(){return this._affectedByScale}set affectedByScale(t){this._affectedByScale=t,this._doLayoutDirty()}updateLayout(t=!1){(this._layoutDirty||t)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)}onEnable(){this._addEventListeners();const t=this.node._uiProps.uiTransformComp;t.contentSize.equals(ln.ZERO)&&t.setContentSize(this._layoutSize),this._childrenChanged()}onDisable(){this._usefulLayoutObj.length=0,this._removeEventListeners()}_checkUsefulObj(){this._usefulLayoutObj.length=0;const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e],n=i._uiProps.uiTransformComp;i.activeInHierarchy&&n&&this._usefulLayoutObj.push(n)}}_addEventListeners(){Mw.on(Rw.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(ev.SIZE_CHANGED,this._resized,this),this.node.on(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(ev.CHILD_ADDED,this._childAdded,this),this.node.on(ev.CHILD_REMOVED,this._childRemoved,this),this.node.on(ev.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()}_removeEventListeners(){Mw.off(Rw.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(ev.SIZE_CHANGED,this._resized,this),this.node.off(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(ev.CHILD_ADDED,this._childAdded,this),this.node.off(ev.CHILD_REMOVED,this._childRemoved,this),this.node.off(ev.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()}_addChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.on(ev.SIZE_CHANGED,this._doLayoutDirty,this),i.on(ev.TRANSFORM_CHANGED,this._transformDirty,this),i.on(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),i.on("active-in-hierarchy-changed",this._childrenChanged,this)}}_removeChildrenEventListeners(){const t=this.node.children;for(let e=0;e<t.length;++e){const i=t[e];i.off(ev.SIZE_CHANGED,this._doLayoutDirty,this),i.off(ev.TRANSFORM_CHANGED,this._transformDirty,this),i.off(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),i.off("active-in-hierarchy-changed",this._childrenChanged,this)}}_childAdded(t){t.on(ev.SIZE_CHANGED,this._doLayoutDirty,this),t.on(ev.TRANSFORM_CHANGED,this._transformDirty,this),t.on(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),t.on("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_childRemoved(t){t.off(ev.SIZE_CHANGED,this._doLayoutDirty,this),t.off(ev.TRANSFORM_CHANGED,this._transformDirty,this),t.off(ev.ANCHOR_CHANGED,this._doLayoutDirty,this),t.off("active-in-hierarchy-changed",this._childrenChanged,this),this._childrenChanged()}_resized(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()}_doLayoutHorizontally(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingLeft;this._horizontalDirection===WY.RIGHT_TO_LEFT&&(o=-1,a=this._paddingRight);const l=(this._horizontalDirection-s.x)*t+o*a;let c=l-o*this._spacingX,h=0,_=0,u=0,m=0,p=!1;const d=this._usefulLayoutObj.length;let f=this._cellSize.width;const g=this._getPaddingH();this._layoutType!==GY.GRID&&this._resizeMode===kY.CHILDREN&&(f=(t-g-(d-1)*this._spacingX)/d);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const d=y[a],v=d.node,x=v.scale,b=this._getUsedScaleValue(x.x),S=this._getUsedScaleValue(x.y);this._resizeMode===kY.CHILDREN&&(d.width=f/b,this._layoutType===GY.GRID&&(d.height=this._cellSize.height/S));const A=Math.abs(this._horizontalDirection-d.anchorX),C=d.width*b,T=d.height*S;T>u&&(m=Math.max(u,m),_=u||T,u=T),c+=o*(A*C+this._spacingX);const w=o*(1-A)*C;if(e){if(r>0)p=a/r>0&&a%r==0,p&&(_=u>T?u:_);else if(C>t-g)c>l+o*A*C&&(p=!0);else{const e=(1-this._horizontalDirection-s.x)*t,i=c+w+o*(o>0?this._paddingRight:this._paddingLeft);p=Math.abs(i)>Math.abs(e)}p&&(c=l+o*A*C,T!==u&&(_=u),h+=_+this._spacingY,_=u=T)}const E=i(v,d,h);n&&v.setPosition(c,E),c+=w}return _=Math.max(_,u),Math.max(m,h+_)+this._getPaddingV()}_doLayoutVertically(t,e,i,n){const s=this.node._uiProps.uiTransformComp.anchorPoint,r=this._getFixedBreakingNum();let o=1,a=this._paddingBottom;this._verticalDirection===jY.TOP_TO_BOTTOM&&(o=-1,a=this._paddingTop);const l=(this._verticalDirection-s.y)*t+o*a;let c=l-o*this._spacingY,h=0,_=0,u=0,m=0,p=!1;const d=this._usefulLayoutObj.length;let f=this._cellSize.height;const g=this._getPaddingV();this._layoutType!==GY.GRID&&this._resizeMode===kY.CHILDREN&&(f=(t-g-(d-1)*this._spacingY)/d);const y=this._usefulLayoutObj;for(let a=0;a<y.length;++a){const d=y[a],v=d.node,x=v.scale,b=this._getUsedScaleValue(x.x),S=this._getUsedScaleValue(x.y);this._resizeMode===kY.CHILDREN&&(d.height=f/S,this._layoutType===GY.GRID&&(d.width=this._cellSize.width/b));const A=Math.abs(this._verticalDirection-d.anchorY),C=d.width*b,T=d.height*S;C>h&&(_=Math.max(h,_),u=h||C,h=C),c+=o*(A*T+this._spacingY);const w=o*(1-A)*T;if(e){if(r>0)p=a/r>0&&a%r==0,p&&(u=h>T?h:u);else if(T>t-g)c>l+o*A*T&&(p=!0);else{const e=(1-this._verticalDirection-s.y)*t,i=c+w+o*(o>0?this._paddingTop:this._paddingBottom);p=Math.abs(i)>Math.abs(e)}p&&(c=l+o*A*T,C!==h&&(u=h),m+=u+this._spacingX,u=h=C)}const E=i(v,d,m);n&&(v.getPosition(XY),v.setPosition(E,c,XY.z)),c+=w}return u=Math.max(u,h),Math.max(_,m+u)+this._getPaddingH()}_doLayoutGridAxisHorizontal(t,e){const i=e.width;let n=1,s=-t.y*e.height,r=this._paddingBottom;this._verticalDirection===jY.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*e.height,r=this._paddingTop);const o=(t,e,i)=>s+n*(i+(1-e.anchorY)*e.height*this._getUsedScaleValue(t.scale.y)+r);let a=0;this._resizeMode===kY.CONTAINER&&(a=this._doLayoutHorizontally(i,!0,o,!1),s=-t.y*a,this._verticalDirection===jY.TOP_TO_BOTTOM&&(n=-1,s=(1-t.y)*a)),this._doLayoutHorizontally(i,!0,o,!0),this._resizeMode===kY.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,a)}_doLayoutGridAxisVertical(t,e){const i=e.height;let n=1,s=-t.x*e.width,r=this._paddingLeft;this._horizontalDirection===WY.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*e.width,r=this._paddingRight);const o=(t,e,i)=>s+n*(i+(1-e.anchorX)*e.width*this._getUsedScaleValue(t.scale.x)+r);let a=0;this._resizeMode===kY.CONTAINER&&(a=this._doLayoutVertically(i,!0,o,!1),s=-t.x*a,this._horizontalDirection===WY.RIGHT_TO_LEFT&&(n=-1,s=(1-t.x)*a)),this._doLayoutVertically(i,!0,o,!0),this._resizeMode===kY.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(a,i)}_doLayoutGrid(){const t=this.node._uiProps.uiTransformComp,e=t.anchorPoint,i=t.contentSize;this.startAxis===HY.HORIZONTAL?this._doLayoutGridAxisHorizontal(e,i):this.startAxis===HY.VERTICAL&&this._doLayoutGridAxisVertical(e,i)}_getHorizontalBaseWidth(t=!0){const e=this._usefulLayoutObj;let i=0;const n=e.length;if(this._resizeMode===kY.CONTAINER){for(let t=0;t<e.length;++t){const n=e[t],s=n.node.scale;i+=n.width*this._getUsedScaleValue(s.x)}i+=(n-1)*this._spacingX+this._getPaddingH()}else i=this.node._uiProps.uiTransformComp.width;return i}_getVerticalBaseHeight(){const t=this._usefulLayoutObj;let e=0;const i=t.length;if(this._resizeMode===kY.CONTAINER){for(let i=0;i<t.length;++i){const n=t[i],s=n.node.scale;e+=n.height*this._getUsedScaleValue(s.y)}e+=(i-1)*this._spacingY+this._getPaddingV()}else e=this.node._uiProps.uiTransformComp.height;return e}_doLayout(){if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===GY.HORIZONTAL){const t=this._getHorizontalBaseWidth(),e=t=>(this._isAlign?Ni.ZERO:t.position).y;this._doLayoutHorizontally(t,!1,e,!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===GY.VERTICAL){const t=this._getVerticalBaseHeight(),e=t=>(this._isAlign?Ni.ZERO:t.position).x;this._doLayoutVertically(t,!1,e,!0),this.node._uiProps.uiTransformComp.height=t}else this._layoutType===GY.GRID&&this._doLayoutGrid()}_getUsedScaleValue(t){return this._affectedByScale?Math.abs(t):1}_transformDirty(t){t&Sg.SCALE&&t&Sg.POSITION&&this._affectedByScale&&this._doLayoutDirty()}_doLayoutDirty(){this._layoutDirty=!0}_childrenChanged(){this._childrenDirty=!0,this._doLayoutDirty()}_getPaddingH(){return this._paddingLeft+this._paddingRight}_getPaddingV(){return this._paddingTop+this._paddingBottom}_getFixedBreakingNum(){if(this._layoutType!==GY.GRID||this._constraint===qY.NONE||this._constraintNum<=0)return 0;let t=this._constraint===qY.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===HY.VERTICAL&&(t=this._constraint===qY.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),t}},VY.Type=GY,VY.VerticalDirection=jY,VY.HorizontalDirection=WY,VY.ResizeMode=kY,VY.AxisDirection=HY,VY.Constraint=qY,wl((SY=UY).prototype,"alignHorizontal",[qX,XX],Object.getOwnPropertyDescriptor(SY.prototype,"alignHorizontal"),SY.prototype),wl(SY.prototype,"alignVertical",[YX,KX],Object.getOwnPropertyDescriptor(SY.prototype,"alignVertical"),SY.prototype),wl(SY.prototype,"type",[$X,JX],Object.getOwnPropertyDescriptor(SY.prototype,"type"),SY.prototype),wl(SY.prototype,"resizeMode",[ZX,QX,tY],Object.getOwnPropertyDescriptor(SY.prototype,"resizeMode"),SY.prototype),wl(SY.prototype,"cellSize",[eY,iY],Object.getOwnPropertyDescriptor(SY.prototype,"cellSize"),SY.prototype),wl(SY.prototype,"startAxis",[nY,sY],Object.getOwnPropertyDescriptor(SY.prototype,"startAxis"),SY.prototype),wl(SY.prototype,"paddingLeft",[rY],Object.getOwnPropertyDescriptor(SY.prototype,"paddingLeft"),SY.prototype),wl(SY.prototype,"paddingRight",[oY],Object.getOwnPropertyDescriptor(SY.prototype,"paddingRight"),SY.prototype),wl(SY.prototype,"paddingTop",[aY],Object.getOwnPropertyDescriptor(SY.prototype,"paddingTop"),SY.prototype),wl(SY.prototype,"paddingBottom",[lY],Object.getOwnPropertyDescriptor(SY.prototype,"paddingBottom"),SY.prototype),wl(SY.prototype,"spacingX",[cY],Object.getOwnPropertyDescriptor(SY.prototype,"spacingX"),SY.prototype),wl(SY.prototype,"spacingY",[hY],Object.getOwnPropertyDescriptor(SY.prototype,"spacingY"),SY.prototype),wl(SY.prototype,"verticalDirection",[_Y,uY],Object.getOwnPropertyDescriptor(SY.prototype,"verticalDirection"),SY.prototype),wl(SY.prototype,"horizontalDirection",[mY,pY],Object.getOwnPropertyDescriptor(SY.prototype,"horizontalDirection"),SY.prototype),wl(SY.prototype,"constraint",[dY,fY,gY],Object.getOwnPropertyDescriptor(SY.prototype,"constraint"),SY.prototype),wl(SY.prototype,"constraintNum",[yY,vY],Object.getOwnPropertyDescriptor(SY.prototype,"constraintNum"),SY.prototype),wl(SY.prototype,"affectedByScale",[xY],Object.getOwnPropertyDescriptor(SY.prototype,"affectedByScale"),SY.prototype),AY=wl(SY.prototype,"_resizeMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kY.NONE}}),CY=wl(SY.prototype,"_layoutType",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return GY.NONE}}),TY=wl(SY.prototype,"_cellSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(40,40)}}),wY=wl(SY.prototype,"_startAxis",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HY.HORIZONTAL}}),EY=wl(SY.prototype,"_paddingLeft",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PY=wl(SY.prototype,"_paddingRight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DY=wl(SY.prototype,"_paddingTop",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IY=wl(SY.prototype,"_paddingBottom",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RY=wl(SY.prototype,"_spacingX",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MY=wl(SY.prototype,"_spacingY",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),OY=wl(SY.prototype,"_verticalDirection",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return jY.TOP_TO_BOTTOM}}),BY=wl(SY.prototype,"_horizontalDirection",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return WY.LEFT_TO_RIGHT}}),NY=wl(SY.prototype,"_constraint",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return qY.NONE}}),LY=wl(SY.prototype,"_constraintNum",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),FY=wl(SY.prototype,"_affectedByScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zY=wl(SY.prototype,"_isAlign",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bY=SY))||bY)||bY)||bY)||bY)||bY)||bY));var KY,$Y,JY,ZY,QY,tK,eK,iK,nK,sK,rK,oK,aK,lK,cK,hK,_K,uK,mK,pK,dK,fK,gK;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL",t[t.FILLED=2]="FILLED"}(gK||(gK={})),Nt(gK);let yK=function(e){return t({ProgressBar:e,ProgressBarComponent:e}),e}((KY=Vl("cc.ProgressBar"),$Y=ec(),JY=Gl(110),ZY=Jl(),QY=Ul(NL),tK=yc(HU),eK=rc(),iK=yc(gK),nK=rc(),sK=rc(),rK=oc(),oK=rc(),aK=rc(),KY(lK=$Y(lK=JY(lK=ZY(lK=QY((fK=dK=class extends Rh{constructor(...t){super(...t),Tl(this,"_barSprite",hK,this),Tl(this,"_mode",_K,this),Tl(this,"_totalLength",uK,this),Tl(this,"_progress",mK,this),Tl(this,"_reverse",pK,this)}get barSprite(){return this._barSprite}set barSprite(t){this._barSprite!==t&&(this._barSprite=t,this._initBarSprite())}get mode(){return this._mode}set mode(t){if(this._mode!==t&&(this._mode=t,this._barSprite)){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp.contentSize;this._mode===gK.HORIZONTAL?this.totalLength=e.width:this._mode===gK.VERTICAL?this.totalLength=e.height:this._mode===gK.FILLED&&(this.totalLength=this._barSprite.fillRange)}}get totalLength(){return this._totalLength}set totalLength(t){this._mode===gK.FILLED&&(t=mi(t)),this._totalLength=t,this._updateBarStatus()}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateBarStatus())}get reverse(){return this._reverse}set reverse(t){this._reverse!==t&&(this._reverse=t,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}_initBarSprite(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=t._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===HU.FillType.RADIAL&&(this._mode=gK.FILLED),this._mode===gK.HORIZONTAL?this.totalLength=s.width:this._mode===gK.VERTICAL?this.totalLength=s.height:this.totalLength=this._barSprite.fillRange,t.parent===this.node){const e=-i.width*n.x;t.setPosition(e,0,0)}}}_updateBarStatus(){if(this._barSprite){const t=this._barSprite.node;if(!t)return;const e=t._uiProps.uiTransformComp,i=e.anchorPoint,n=e.contentSize,s=t.getPosition();let r=new tn(0,.5);const o=mi(this._progress);let a=this._totalLength*o,l=n,c=0,h=0;switch(this._mode){case gK.HORIZONTAL:this._reverse&&(r=new tn(1,.5)),l=new ln(a,n.height),c=this._totalLength,h=n.height;break;case gK.VERTICAL:r=this._reverse?new tn(.5,1):new tn(.5,0),l=new ln(n.width,a),c=n.width,h=this._totalLength}if(this._mode===gK.FILLED)this._barSprite.type!==HU.Type.FILLED?m("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(a*=-1),this._barSprite.fillRange=a);else if(this._barSprite.type!==HU.Type.FILLED){const n=r.x-i.x,o=r.y-i.y,a=new Ni(c*n,h*o,0);t.setPosition(s.x+a.x,s.y+a.y,s.z),e.setAnchorPoint(r),e.setContentSize(l)}else m("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}}},dK.Mode=gK,wl((cK=fK).prototype,"barSprite",[tK,eK],Object.getOwnPropertyDescriptor(cK.prototype,"barSprite"),cK.prototype),wl(cK.prototype,"mode",[iK,nK],Object.getOwnPropertyDescriptor(cK.prototype,"mode"),cK.prototype),wl(cK.prototype,"totalLength",[sK],Object.getOwnPropertyDescriptor(cK.prototype,"totalLength"),cK.prototype),wl(cK.prototype,"progress",[rK,hc,oK],Object.getOwnPropertyDescriptor(cK.prototype,"progress"),cK.prototype),wl(cK.prototype,"reverse",[aK],Object.getOwnPropertyDescriptor(cK.prototype,"reverse"),cK.prototype),hK=wl(cK.prototype,"_barSprite",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_K=wl(cK.prototype,"_mode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gK.HORIZONTAL}}),uK=wl(cK.prototype,"_totalLength",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),mK=wl(cK.prototype,"_progress",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),pK=wl(cK.prototype,"_reverse",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lK=cK))||lK)||lK)||lK)||lK)||lK));var vK,xK,bK,SK,AK,CK,TK,wK,EK,PK,DK,IK,RK,MK,OK,BK,NK,LK,FK,zK,VK,UK,GK,kK;const HK=new Ni,jK=new Ni,WK=new Ni,qK=new tn,XK=new Ri,YK=new tn;var KK;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(KK||(KK={})),zt(KK);let $K=function(e){return t({ScrollBar:e,ScrollBarComponent:e}),e}((vK=Vl("cc.ScrollBar"),xK=ec(),bK=Gl(110),SK=Jl(),AK=Ul(NL),CK=yc(HU),TK=_c(),wK=rc(),EK=yc(KK),PK=_c(),DK=rc(),IK=_c(),RK=rc(),MK=_c(),OK=rc(),vK(BK=xK(BK=bK(BK=SK(BK=AK((kK=GK=class extends Rh{constructor(...t){super(...t),Tl(this,"_scrollView",LK,this),Tl(this,"_handle",FK,this),Tl(this,"_direction",zK,this),Tl(this,"_enableAutoHide",VK,this),Tl(this,"_autoHideTime",UK,this),this._touching=!1,this._opacity=255,this._autoHideRemainingTime=0}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t,this.onScroll(tn.ZERO))}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this.onScroll(tn.ZERO))}get enableAutoHide(){return this._enableAutoHide}set enableAutoHide(t){this._enableAutoHide!==t&&(this._enableAutoHide=t,this._enableAutoHide&&this._setOpacity(0))}get autoHideTime(){return this._autoHideTime}set autoHideTime(t){this._autoHideTime!==t&&(this._autoHideTime=t)}hide(){this._autoHideRemainingTime=0,this._setOpacity(0)}show(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)}onScroll(t){if(!this._scrollView)return;const e=this._scrollView.content;if(!e)return;const i=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize,s=this.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(i,n))return;this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));let r=0,o=0,a=0,l=0,c=0;const h=YK;h.set(0,0),this._direction===KK.HORIZONTAL?(r=i.width,o=n.width,c=s.width,a=t.x,this._convertToScrollViewSpace(h,e),l=-h.x):this._direction===KK.VERTICAL&&(r=i.height,o=n.height,c=s.height,a=t.y,this._convertToScrollViewSpace(h,e),l=-h.y);const _=this._calculateLength(r,o,c,a),u=YK;this._calculatePosition(u,r,o,c,l,a,_),this._updateLength(_),this._updateHandlerPosition(u)}setScrollView(t){this._scrollView=t}onTouchBegan(){this._enableAutoHide&&(this._touching=!0)}onTouchEnded(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){const t=this._scrollView.content;if(t){const e=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(e,i))return}}this._autoHideRemainingTime=this._autoHideTime}}onEnable(){const t=this.node.getComponent(HU);t&&(this._opacity=t.color.a)}start(){this._enableAutoHide&&this._setOpacity(0)}update(t){this._processAutoHide(t)}_convertToScrollViewSpace(t,e){const i=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,n=e._uiProps.uiTransformComp;if(i&&n){HK.set(-n.anchorX*n.width,-n.anchorY*n.height,0),n.convertToWorldSpaceAR(HK,jK);const e=i.convertToNodeSpaceAR(jK);e.x+=i.anchorX*i.width,e.y+=i.anchorY*i.height,t.set(e.x,e.y)}else t.set(tn.ZERO)}_setOpacity(t){if(this._handle){let e=this.node.getComponent(HU);e&&(XK.set(e.color),XK.a=t,e.color=XK),e=this._handle.getComponent(HU),e&&(XK.set(e.color),XK.a=t,e.color=XK)}}_updateHandlerPosition(t){if(this._handle){const e=WK;this._fixupHandlerPosition(e),this._handle.node.setPosition(t.x+e.x,t.y+e.y,e.z)}}_fixupHandlerPosition(t){const e=this.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint,s=this.handle.node._uiProps.uiTransformComp.contentSize,r=this.handle.node.parent;Ni.set(HK,-i.width*n.x,-i.height*n.y,0);const o=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(HK,jK),a=t;a.set(0,0,0),r._uiProps.uiTransformComp.convertToNodeSpaceAR(o,a),this.direction===KK.HORIZONTAL?a.set(a.x,a.y+(i.height-s.height)/2,a.z):this.direction===KK.VERTICAL&&a.set(a.x+(i.width-s.width)/2,a.y,a.z),this.handle.node.setPosition(a)}_conditionalDisableScrollBar(t,e){return t.width<=e.width&&this._direction===KK.HORIZONTAL||t.height<=e.height&&this._direction===KK.VERTICAL}_calculateLength(t,e,i,n){let s=t;return n&&(s+=20*(n>0?n:-n)),i*(e/s)}_calculatePosition(t,e,i,n,s,r,o){let a=e-i;r&&(a+=Math.abs(r));let l=0;a&&(l=s/a,l=mi(l));const c=(n-o)*l;this._direction===KK.VERTICAL?t.set(0,c):t.set(c,0)}_updateLength(t){if(this._handle){const e=this._handle.node._uiProps.uiTransformComp,i=e.contentSize,n=e.anchorPoint;n.x===qK.x&&n.y===qK.y||e.setAnchorPoint(qK),this._direction===KK.HORIZONTAL?e.setContentSize(t,i.height):e.setContentSize(i.width,t)}}_processAutoHide(t){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=t,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);const t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}}},GK.Direction=KK,wl((NK=kK).prototype,"handle",[CK,TK,wK],Object.getOwnPropertyDescriptor(NK.prototype,"handle"),NK.prototype),wl(NK.prototype,"direction",[EK,PK,DK],Object.getOwnPropertyDescriptor(NK.prototype,"direction"),NK.prototype),wl(NK.prototype,"enableAutoHide",[IK,RK],Object.getOwnPropertyDescriptor(NK.prototype,"enableAutoHide"),NK.prototype),wl(NK.prototype,"autoHideTime",[MK,OK],Object.getOwnPropertyDescriptor(NK.prototype,"autoHideTime"),NK.prototype),LK=wl(NK.prototype,"_scrollView",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FK=wl(NK.prototype,"_handle",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zK=wl(NK.prototype,"_direction",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KK.HORIZONTAL}}),VK=wl(NK.prototype,"_enableAutoHide",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UK=wl(NK.prototype,"_autoHideTime",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BK=NK))||BK)||BK)||BK)||BK)||BK));var JK;let ZK=t("ViewGroup",Vl("cc.ViewGroup")(JK=Gl(110)(JK=class extends Rh{})||JK)||JK);var QK,t$,e$,i$,n$,s$,r$,o$,a$,l$,c$,h$,_$,u$,m$,p$,d$,f$,g$,y$,v$,x$,b$,S$,A$,C$,T$,w$,E$,P$,D$,I$,R$,M$,O$,B$,N$,L$,F$,z$,V$,U$,G$,k$,H$,j$,W$,q$;n.ViewGroup=ZK;const X$=1e-4,Y$=new Ni,K$=new Ni,$$=new tn,J$=new tn,Z$=()=>(new Date).getMilliseconds(),Q$={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};let tJ;!function(t){t.SCROLL_TO_TOP="scroll-to-top",t.SCROLL_TO_BOTTOM="scroll-to-bottom",t.SCROLL_TO_LEFT="scroll-to-left",t.SCROLL_TO_RIGHT="scroll-to-right",t.SCROLL_BEGAN="scroll-began",t.SCROLL_ENDED="scroll-ended",t.BOUNCE_TOP="bounce-top",t.BOUNCE_BOTTOM="bounce-bottom",t.BOUNCE_LEFT="bounce-left",t.BOUNCE_RIGHT="bounce-right",t.SCROLLING="scrolling",t.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",t.TOUCH_UP="touch-up"}(tJ||(tJ={}));let eJ=function(e){return t({ScrollView:e,ScrollViewComponent:e}),e}((QK=Vl("cc.ScrollView"),t$=ec(),e$=Gl(110),i$=Jl(),n$=Ul(NL),s$=oc(),r$=_c(),o$=rc(),a$=oc(),l$=_c(),c$=rc(),h$=_c(),_$=rc(),u$=_c(),m$=rc(),p$=yc(Yv),d$=_c(),f$=rc(),g$=_c(),y$=rc(),v$=yc($K),x$=_c(),b$=rc(),S$=_c(),A$=rc(),C$=yc($K),T$=_c(),w$=rc(),E$=_c(),P$=rc(),D$=yc([rP]),I$=_c(),R$=rc(),QK(M$=t$(M$=e$(M$=i$(M$=n$((q$=W$=class extends ZK{constructor(...t){super(...t),Tl(this,"bounceDuration",B$,this),Tl(this,"brake",N$,this),Tl(this,"elastic",L$,this),Tl(this,"inertia",F$,this),Tl(this,"horizontal",z$,this),Tl(this,"vertical",V$,this),Tl(this,"cancelInnerEvents",U$,this),Tl(this,"scrollEvents",G$,this),this._autoScrolling=!1,this._scrolling=!1,Tl(this,"_content",k$,this),Tl(this,"_horizontalScrollBar",H$,this),Tl(this,"_verticalScrollBar",j$,this),this._topBoundary=0,this._bottomBoundary=0,this._leftBoundary=0,this._rightBoundary=0,this._touchMoveDisplacements=[],this._touchMoveTimeDeltas=[],this._touchMovePreviousTimestamp=0,this._touchMoved=!1,this._autoScrollAttenuate=!1,this._autoScrollStartPosition=new Ni,this._autoScrollTargetDelta=new Ni,this._autoScrollTotalTime=0,this._autoScrollAccumulatedTime=0,this._autoScrollCurrentlyOutOfBoundary=!1,this._autoScrollBraking=!1,this._autoScrollBrakingStartPosition=new Ni,this._outOfBoundaryAmount=new Ni,this._outOfBoundaryAmountDirty=!0,this._stopMouseWheel=!1,this._mouseWheelEventElapsedTime=0,this._isScrollEndedWithThresholdEventFired=!1,this._scrollEventEmitMask=0,this._isBouncing=!1,this._contentPos=new Ni,this._deltaPos=new Ni}get content(){return this._content}set content(t){if(this._content===t)return;const e=t&&t.parent&&t.parent._uiProps.uiTransformComp;!t||t&&e?(this._content=t,this._calculateBoundary()):b(4302)}get horizontalScrollBar(){return this._horizontalScrollBar}set horizontalScrollBar(t){this._horizontalScrollBar!==t&&(this._horizontalScrollBar=t,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(tn.ZERO)))}get verticalScrollBar(){return this._verticalScrollBar}set verticalScrollBar(t){this._verticalScrollBar!==t&&(this._verticalScrollBar=t,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(tn.ZERO)))}get view(){const t=this._content&&this._content.parent;return t?t._uiProps.uiTransformComp:null}scrollToBottom(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(0,0),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i,!0)}scrollToTop(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(0,1),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(0,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(1,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(0,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToTopRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(1,1),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomLeft(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(0,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToBottomRight(t,e=!0){const i=this._calculateMovePercentDelta({anchor:new tn(1,0),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,!1!==e):this._moveContent(i)}scrollToOffset(t,e,i=!0){const n=this.getMaxScrollOffset(),s=new tn(0,0);0===n.x?s.x=0:s.x=t.x/n.x,0===n.y?s.y=1:s.y=(n.y-t.y)/n.y,this.scrollTo(s,e,i)}getScrollOffset(){const t=this._getContentTopBoundary()-this._topBoundary,e=this._getContentLeftBoundary()-this._leftBoundary;return new tn(e,t)}getMaxScrollOffset(){if(!this._content||!this.view)return tn.ZERO;const t=this._content._uiProps.uiTransformComp.contentSize;let e=t.width-this.view.width,i=t.height-this.view.height;return e=e>=0?e:0,i=i>=0?i:0,new tn(e,i)}scrollToPercentHorizontal(t,e,i){const n=this._calculateMovePercentDelta({anchor:new tn(t,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==i):this._moveContent(n)}scrollTo(t,e,i){const n=this._calculateMovePercentDelta({anchor:new tn(t),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}scrollToPercentVertical(t,e,i){const n=this._calculateMovePercentDelta({anchor:new tn(0,t),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,i):this._moveContent(n)}stopAutoScroll(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime}setContentPosition(t){this._setContentPosition(t)}_setContentPosition(t){if(!this._content)return;const e=this._getContentPosition();Math.abs(t.x-e.x)<X$&&Math.abs(t.y-e.y)<X$||(this._content.setPosition(t),this._outOfBoundaryAmountDirty=!0)}getContentPosition(){return this._getContentPosition()}_getContentPosition(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):Ni.ZERO.clone()}isScrolling(){return this._scrolling}isAutoScrolling(){return this._autoScrolling}getScrollEndedEventTiming(){return X$}start(){this._calculateBoundary(),this._content&&Mw.once(Rw.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)}onEnable(){this._registerEvent(),this._content&&(this._content.on(ev.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(ev.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(ev.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(ev.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()}update(t){this._autoScrolling&&this._processAutoScrolling(t)}onDisable(){this._unregisterEvent(),this._content&&(this._content.off(ev.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(ev.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(ev.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(ev.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()}_registerEvent(){this.node.on(ev.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(ev.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(ev.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(ev.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(ev.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_unregisterEvent(){this.node.off(ev.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(ev.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(ev.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(ev.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(ev.MOUSE_WHEEL,this._onMouseWheel,this,!0)}_onMouseWheel(t,e){if(!this.enabledInHierarchy)return;if(this._hasNestedViewGroup(t,e))return;const i=new Ni,n=t.getScrollY();this.vertical?i.set(0,-.1*n,0):this.horizontal&&i.set(-.1*n,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(i),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(t)}_onTouchBegan(t,e){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(t,e)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(t)))}_onTouchMoved(t,e){if(!this.enabledInHierarchy||!this._content)return;if(this._hasNestedViewGroup(t,e))return;const i=t.touch;if(this._handleMoveLogic(i),!this.cancelInnerEvents)return;const n=i.getUILocation($$);if(n.subtract(i.getUIStartLocation(J$)),n.length()>7&&!this._touchMoved&&t.target!==this.node){const e=new YT(t.getTouches(),t.bubbles,Gy.TOUCH_CANCEL);e.touch=t.touch,e.simulate=!0,t.target.dispatchEvent(e),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(t)}_onTouchEnded(t,e){if(!this.enabledInHierarchy||!this._content||!t)return;if(this._hasNestedViewGroup(t,e))return;this._dispatchEvent(tJ.TOUCH_UP);const i=t.touch;this._handleReleaseLogic(i),this._touchMoved?t.propagationStopped=!0:this._stopPropagationIfTargetIsMe(t)}_onTouchCancelled(t,e){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(t,e)){if(t&&!t.simulate){const e=t.touch;this._handleReleaseLogic(e)}this._stopPropagationIfTargetIsMe(t)}}_calculateBoundary(){if(this._content&&this.view){const t=this._content.getComponent(YY);t&&t.enabledInHierarchy&&t.updateLayout();const e=this.view,i=e.width*e.anchorX,n=e.height*e.anchorY;this._leftBoundary=-i,this._bottomBoundary=-n,this._rightBoundary=this._leftBoundary+e.width,this._topBoundary=this._bottomBoundary+e.height,this._moveContentToTopLeft(e.contentSize)}}_hasNestedViewGroup(t,e){if(!t||t.eventPhase!==nh.CAPTURING_PHASE)return!1;if(e)for(const i of e){const e=i;if(this.node===e)return!(!t.target||!t.target.getComponent(ZK));if(e.getComponent(ZK))return!0}return!1}_startInertiaScroll(t){const e=new Ni(t);e.multiplyScalar(.7),this._startAttenuatingAutoScroll(e,t)}_calculateAttenuatedFactor(t){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*t+t*t*8e-9))}_startAttenuatingAutoScroll(t,e){const i=t.clone();if(i.normalize(),this._content&&this.view){const t=this._content._uiProps.uiTransformComp.contentSize,e=this.view.contentSize,n=t.width-e.width,s=t.height-e.height,r=this._calculateAttenuatedFactor(n),o=this._calculateAttenuatedFactor(s);i.x=i.x*n*(1-this.brake)*r,i.y=i.y*s*o*(1-this.brake),i.z=0}const n=t.length();let s=i.length()/n;if(i.add(t),this.brake>0&&s>7){s=Math.sqrt(s);const e=t.clone();e.multiplyScalar(s),i.set(e),i.add(t)}let r=this._calculateAutoScrollTimeByInitialSpeed(e.length());this.brake>0&&s>3&&(s=3,r*=s),0===this.brake&&s>1&&(r*=s),this._startAutoScroll(i,r,!0)}_calculateAutoScrollTimeByInitialSpeed(t){return Math.sqrt(Math.sqrt(t/5))}_startAutoScroll(t,e,i=!1){const n=this._flattenVectorByDirection(t);this._autoScrolling=!0,this._autoScrollTargetDelta=n,this._autoScrollAttenuate=i,Ni.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=e,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(Ni.ZERO,X$)||(this._autoScrollCurrentlyOutOfBoundary=!0)}_calculateTouchMoveVelocity(){const t=new Ni;let e=0;if(e=this._touchMoveTimeDeltas.reduce(((t,e)=>t+e),e),e<=0||e>=.5)t.set(Ni.ZERO);else{let i=new Ni;i=this._touchMoveDisplacements.reduce(((t,e)=>(t.add(e),t)),i),t.set(i.x*(1-this.brake)/e,i.y*(1-this.brake)/e,i.z)}return t}_flattenVectorByDirection(t){const e=t;return e.x=this.horizontal?e.x:0,e.y=this.vertical?e.y:0,e}_moveContent(t,e){const i=this._flattenVectorByDirection(t);Y$.set(this._getContentPosition()),Y$.add(i),Y$.set(Math.floor(1e4*Y$.x)*X$,Math.floor(1e4*Y$.y)*X$,Y$.z),this._setContentPosition(Y$);const n=this._getHowMuchOutOfBoundary();$$.set(n.x,n.y),this._updateScrollBar($$),this.elastic&&e&&this._startBounceBackIfNeeded()}_getContentLeftBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.x-e.anchorX*e.width}_getContentRightBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+t.width}_getContentTopBoundary(){if(!this._content)return-1;const t=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+t.height}_getContentBottomBoundary(){if(!this._content)return-1;const t=this._getContentPosition(),e=this._content._uiProps.uiTransformComp;return t.y-e.anchorY*e.height}_getHowMuchOutOfBoundary(t){if((t=t||new Ni).equals(Ni.ZERO,X$)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;const e=new Ni;return this._getContentLeftBoundary()+t.x>this._leftBoundary?e.x=this._leftBoundary-(this._getContentLeftBoundary()+t.x):this._getContentRightBoundary()+t.x<this._rightBoundary&&(e.x=this._rightBoundary-(this._getContentRightBoundary()+t.x)),this._getContentTopBoundary()+t.y<this._topBoundary?e.y=this._topBoundary-(this._getContentTopBoundary()+t.y):this._getContentBottomBoundary()+t.y>this._bottomBoundary&&(e.y=this._bottomBoundary-(this._getContentBottomBoundary()+t.y)),t.equals(Ni.ZERO,X$)&&(this._outOfBoundaryAmount=e,this._outOfBoundaryAmountDirty=!1),this._clampDelta(e),e}_updateScrollBar(t){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(t),this.verticalScrollBar&&this.verticalScrollBar.onScroll(t)}_onScrollBarTouchBegan(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()}_onScrollBarTouchEnded(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()}_dispatchEvent(t){if(t===tJ.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(t===tJ.SCROLL_TO_TOP||t===tJ.SCROLL_TO_BOTTOM||t===tJ.SCROLL_TO_LEFT||t===tJ.SCROLL_TO_RIGHT){const e=1<<Q$[t];if(this._scrollEventEmitMask&e)return;this._scrollEventEmitMask|=e}rP.emitEvents(this.scrollEvents,this,Q$[t]),this.node.emit(t,this)}_adjustContentOutOfBoundary(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){const t=this._getHowMuchOutOfBoundary();Y$.set(this._getContentPosition()),Y$.add(t),this._content.setPosition(Y$),this._updateScrollBar(tn.ZERO)}}_hideScrollBar(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()}_updateScrollBarState(){if(!this._content||!this.view)return;const t=this.view,e=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(e.height<t.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(e.width<t.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}_stopPropagationIfTargetIsMe(t){t.eventPhase===nh.AT_TARGET&&t.target===this.node&&(t.propagationStopped=!0)}_processDeltaMove(t){this._scrollChildren(t),this._gatherTouchMove(t)}_handleMoveLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._processDeltaMove(this._deltaPos)}_handleReleaseLogic(t){this._getLocalAxisAlignDelta(this._deltaPos,t),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(tJ.SCROLL_ENDED))}_getLocalAxisAlignDelta(t,e){const i=this.node._uiProps.uiTransformComp,n=new Ni;i&&(e.getUILocation($$),e.getUIPreviousLocation(J$),Y$.set($$.x,$$.y,0),K$.set(J$.x,J$.y,0),i.convertToNodeSpaceAR(Y$,Y$),i.convertToNodeSpaceAR(K$,K$),Ni.subtract(n,Y$,K$)),t.set(n)}_scrollChildren(t){this._clampDelta(t);const e=t;let i,n;if(this.elastic&&(i=this._getHowMuchOutOfBoundary(),e.x*=0===i.x?1:.5,e.y*=0===i.y?1:.5),this.elastic||(i=this._getHowMuchOutOfBoundary(e),e.add(i)),this._content){const{anchorX:t,anchorY:i,width:s,height:r}=this._content._uiProps.uiTransformComp,o=this._content.position||Ni.ZERO;e.y>0?o.y-i*r+e.y>=this._bottomBoundary&&(n=tJ.SCROLL_TO_BOTTOM):e.y<0&&o.y-i*r+r+e.y<=this._topBoundary&&(n=tJ.SCROLL_TO_TOP),e.x<0?o.x-t*s+s+e.x<=this._rightBoundary&&(n=tJ.SCROLL_TO_RIGHT):e.x>0&&o.x-t*s+e.x>=this._leftBoundary&&(n=tJ.SCROLL_TO_LEFT)}this._moveContent(e,!1),0===e.x&&0===e.y||(this._scrolling||(this._scrolling=!0,this._dispatchEvent(tJ.SCROLL_BEGAN)),this._dispatchEvent(tJ.SCROLLING)),n&&n.length>0&&this._dispatchEvent(n)}_handlePressLogic(){this._autoScrolling&&this._dispatchEvent(tJ.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=Z$(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()}_clampDelta(t){if(this._content&&this.view){const e=this.view.contentSize,i=this._content._uiProps.uiTransformComp;i.width<e.width&&(t.x=0),i.height<e.height&&(t.y=0)}}_gatherTouchMove(t){const e=t.clone();for(this._clampDelta(e);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(e);const i=Z$();this._touchMoveTimeDeltas.push((i-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=i}_startBounceBackIfNeeded(){if(!this.elastic)return!1;const t=this._getHowMuchOutOfBoundary();if(this._clampDelta(t),t.equals(Ni.ZERO,X$))return!1;const e=Math.max(this.bounceDuration,0);return this._startAutoScroll(t,e,!0),this._isBouncing||(t.y>0&&this._dispatchEvent(tJ.BOUNCE_TOP),t.y<0&&this._dispatchEvent(tJ.BOUNCE_BOTTOM),t.x>0&&this._dispatchEvent(tJ.BOUNCE_RIGHT),t.x<0&&this._dispatchEvent(tJ.BOUNCE_LEFT),this._isBouncing=!0),!0}_processInertiaScroll(){if(!this._startBounceBackIfNeeded()&&this.inertia){const t=this._calculateTouchMoveVelocity();!t.equals(Y$,X$)&&this.brake<1&&this._startInertiaScroll(t)}this._onScrollBarTouchEnded()}_isOutOfBoundary(){return!this._getHowMuchOutOfBoundary().equals(Ni.ZERO,X$)}_isNecessaryAutoScrollBrake(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1}_processAutoScrolling(t){const e=this._isNecessaryAutoScrollBrake(),i=e?.05:1;this._autoScrollAccumulatedTime+=t*(1/i);let n=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);var s;this._autoScrollAttenuate&&(s=n,n=(s-=1)*s*s*s*s+1);const r=this._autoScrollTargetDelta.clone();r.multiplyScalar(n);const o=this._autoScrollStartPosition.clone();o.add(r);let a=Math.abs(n-1)<=X$;if(Math.abs(n-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(tJ.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){const t=o.clone();t.subtract(this._autoScrollBrakingStartPosition),e&&t.multiplyScalar(i),o.set(this._autoScrollBrakingStartPosition),o.add(t)}else{const t=o.clone();t.subtract(this.getContentPosition());const e=this._getHowMuchOutOfBoundary(t);e.equals(Ni.ZERO,X$)||(o.add(e),a=!0)}a&&(this._autoScrolling=!1);const l=o.clone();l.subtract(this._getContentPosition()),this._clampDelta(l),this._moveContent(l,a),this._dispatchEvent(tJ.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(tJ.SCROLL_ENDED))}_checkMouseWheel(t){if(!this._getHowMuchOutOfBoundary().equals(Ni.ZERO,X$))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(tJ.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=t,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(tJ.SCROLL_ENDED),this._stopMouseWheel=!1)}_calculateMovePercentDelta(t){const e=t.anchor,i=t.applyToHorizontal,n=t.applyToVertical;this._calculateBoundary(),e.clampf(tn.ZERO,tn.ONE);let s=this._getContentBottomBoundary()-this._bottomBoundary;s=-s;let r=this._getContentLeftBoundary()-this._leftBoundary;r=-r;const o=new Ni;if(this._content&&this.view){let t=0;const a=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;i&&(t=a.width-l.width,o.x=r-t*e.x),n&&(t=a.height-l.height,o.y=s-t*e.y)}return o}_moveContentToTopLeft(t){let e=this._getContentBottomBoundary()-this._bottomBoundary;e=-e;const i=new Ni;let n=0,s=this._getContentLeftBoundary()-this._leftBoundary;if(s=-s,this._content){const r=this._content._uiProps.uiTransformComp.contentSize;r.height<t.height&&(n=r.height-t.height,i.y=e-n),r.width<t.width&&(n=r.width-t.width,i.x=s)}this._updateScrollBarState(),this._moveContent(i),this._adjustContentOutOfBoundary()}_scaleChanged(t){t===Sg.SCALE&&this._calculateBoundary()}},W$.EventType=tJ,B$=wl((O$=q$).prototype,"bounceDuration",[Wl,s$,r$,o$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),N$=wl(O$.prototype,"brake",[Wl,a$,l$,c$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),L$=wl(O$.prototype,"elastic",[Wl,h$,_$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),F$=wl(O$.prototype,"inertia",[Wl,u$,m$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(O$.prototype,"content",[p$,d$,f$],Object.getOwnPropertyDescriptor(O$.prototype,"content"),O$.prototype),z$=wl(O$.prototype,"horizontal",[Wl,g$,y$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(O$.prototype,"horizontalScrollBar",[v$,x$,b$],Object.getOwnPropertyDescriptor(O$.prototype,"horizontalScrollBar"),O$.prototype),V$=wl(O$.prototype,"vertical",[Wl,S$,A$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(O$.prototype,"verticalScrollBar",[C$,T$,w$],Object.getOwnPropertyDescriptor(O$.prototype,"verticalScrollBar"),O$.prototype),U$=wl(O$.prototype,"cancelInnerEvents",[Wl,E$,P$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G$=wl(O$.prototype,"scrollEvents",[D$,Wl,I$,R$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),k$=wl(O$.prototype,"_content",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),H$=wl(O$.prototype,"_horizontalScrollBar",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),j$=wl(O$.prototype,"_verticalScrollBar",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),M$=O$))||M$)||M$)||M$)||M$)||M$));var iJ,nJ,sJ,rJ,oJ,aJ,lJ,cJ,hJ,_J,uJ,mJ,pJ,dJ,fJ,gJ,yJ,vJ,xJ,bJ,SJ;const AJ=new Ni;var CJ;!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(CJ||(CJ={})),zt(CJ);let TJ=function(e){return t({Slider:e,SliderComponent:e}),e}((iJ=Vl("cc.Slider"),nJ=ec(),sJ=Gl(110),rJ=Jl(),oJ=Ul(NL),aJ=yc(HU),lJ=rc(),cJ=yc(CJ),hJ=rc(),_J=oc(),uJ=rc(),mJ=yc([rP]),pJ=rc(),iJ(dJ=nJ(dJ=sJ(dJ=rJ(dJ=oJ((SJ=bJ=class extends Rh{constructor(...t){super(...t),Tl(this,"slideEvents",gJ,this),Tl(this,"_handle",yJ,this),Tl(this,"_direction",vJ,this),Tl(this,"_progress",xJ,this),this._offset=new Ni,this._dragging=!1,this._touchHandle=!1,this._handleLocalPos=new Ni,this._touchPos=new Ni}get handle(){return this._handle}set handle(t){this._handle!==t&&(this._handle=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._changeLayout())}get progress(){return this._progress}set progress(t){this._progress!==t&&(this._progress=t,this._updateHandlePosition())}__preload(){this._updateHandlePosition()}onEnable(){this._updateHandlePosition(),this.node.on(ev.TOUCH_START,this._onTouchBegan,this),this.node.on(ev.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(ev.TOUCH_END,this._onTouchEnded,this),this.node.on(ev.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(ev.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(ev.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(ev.TOUCH_END,this._onTouchEnded,this))}onDisable(){this.node.off(ev.TOUCH_START,this._onTouchBegan,this),this.node.off(ev.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(ev.TOUCH_END,this._onTouchEnded,this),this.node.off(ev.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(ev.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(ev.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(ev.TOUCH_END,this._onTouchEnded,this))}_onHandleDragStart(t){if(!t||!this._handle||!this._handle.node._uiProps.uiTransformComp)return;this._dragging=!0,this._touchHandle=!0;const e=t.touch.getUILocation();Ni.set(this._touchPos,e.x,e.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),t.propagationStopped=!0}_onTouchBegan(t){this._handle&&t&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchMoved(t){this._dragging&&t&&(this._handleSliderLogic(t.touch),t.propagationStopped=!0)}_onTouchEnded(t){this._dragging=!1,this._touchHandle=!1,this._offset=new Ni,t&&(t.propagationStopped=!0)}_onTouchCancelled(t){this._dragging=!1,t&&(t.propagationStopped=!0)}_handleSliderLogic(t){this._updateProgress(t),this._emitSlideEvent()}_emitSlideEvent(){rP.emitEvents(this.slideEvents,this),this.node.emit("slide",this)}_updateProgress(t){if(!this._handle||!t)return;const e=t.getUILocation();Ni.set(this._touchPos,e.x,e.y,0);const i=this.node._uiProps.uiTransformComp,n=i.convertToNodeSpaceAR(this._touchPos,AJ);this.direction===CJ.Horizontal?this.progress=mi(.5+(n.x-this._offset.x)/i.width):this.progress=mi(.5+(n.y-this._offset.y)/i.height)}_updateHandlePosition(){if(!this._handle)return;this._handleLocalPos.set(this._handle.node.getPosition());const t=this.node._uiProps.uiTransformComp;this._direction===CJ.Horizontal?this._handleLocalPos.x=-t.width*t.anchorX+this.progress*t.width:this._handleLocalPos.y=-t.height*t.anchorY+this.progress*t.height,this._handle.node.setPosition(this._handleLocalPos)}_changeLayout(){const t=this.node._uiProps.uiTransformComp,e=t.contentSize;if(t.setContentSize(e.height,e.width),this._handle){const t=this._handle.node.position;this._direction===CJ.Horizontal?this._handle.node.setPosition(t.x,0,t.z):this._handle.node.setPosition(0,t.y,t.z),this._updateHandlePosition()}}},bJ.Direction=CJ,wl((fJ=SJ).prototype,"handle",[aJ,lJ],Object.getOwnPropertyDescriptor(fJ.prototype,"handle"),fJ.prototype),wl(fJ.prototype,"direction",[cJ,hJ],Object.getOwnPropertyDescriptor(fJ.prototype,"direction"),fJ.prototype),wl(fJ.prototype,"progress",[hc,_J,uJ],Object.getOwnPropertyDescriptor(fJ.prototype,"progress"),fJ.prototype),gJ=wl(fJ.prototype,"slideEvents",[mJ,Wl,pJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),yJ=wl(fJ.prototype,"_handle",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vJ=wl(fJ.prototype,"_direction",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return CJ.Horizontal}}),xJ=wl(fJ.prototype,"_progress",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),dJ=fJ))||dJ)||dJ)||dJ)||dJ)||dJ));function wJ(...t){return Object.assign({},...t)}var EJ,PJ,DJ,IJ,RJ,MJ,OJ,BJ,NJ,LJ,FJ,zJ,VJ,UJ,GJ,kJ,HJ,jJ,WJ,qJ;!function(t){t.TOGGLE="toggle"}(qJ||(qJ={}));let XJ=function(e){return t({Toggle:e,ToggleComponent:e}),e}((EJ=Vl("cc.Toggle"),PJ=ec(),DJ=Gl(110),IJ=Jl(),RJ=Ul(NL),MJ=_c(),OJ=rc(),BJ=yc(HU),NJ=_c(),LJ=rc(),FJ=yc([rP]),zJ=rc(),EJ(VJ=PJ(VJ=DJ(VJ=IJ(VJ=RJ((WJ=jJ=class t extends Mq{constructor(...t){super(...t),Tl(this,"checkEvents",GJ,this),Tl(this,"_isChecked",kJ,this),Tl(this,"_checkMark",HJ,this)}get isChecked(){return this._isChecked}set isChecked(t){this._set(t)}get checkMark(){return this._checkMark}set checkMark(t){this._checkMark!==t&&(this._checkMark=t)}set _resizeToTarget(t){t&&this._resizeNodeToTargetNode()}get _toggleContainer(){const t=this.node.parent;return n.Node.isNode(t)?t.getComponent("cc.ToggleContainer"):null}_internalToggle(){this.isChecked=!this.isChecked}_set(t,e=!0){if(this._isChecked==t)return;this._isChecked=t;const i=this._toggleContainer;i&&i.enabled&&this.enabled&&(t||!i.anyTogglesChecked()&&!i.allowSwitchOff)&&(this._isChecked=!0,i.notifyToggleCheck(this,e)),this.playEffect(),e&&this._emitToggleEvents()}playEffect(){this._checkMark&&(this._checkMark.node.active=this._isChecked)}setIsCheckedWithoutNotify(t){this._set(t,!1)}onEnable(){super.onEnable(),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)}onDisable(){super.onDisable(),this.node.off(t.EventType.CLICK,this._internalToggle,this)}OnDestroy(){const t=this._toggleContainer;t&&t.ensureValidState()}_emitToggleEvents(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&rP.emitEvents(this.checkEvents,this)}},jJ.EventType=wJ(qJ,Pq),wl((UJ=WJ).prototype,"isChecked",[MJ,OJ],Object.getOwnPropertyDescriptor(UJ.prototype,"isChecked"),UJ.prototype),wl(UJ.prototype,"checkMark",[BJ,NJ,LJ],Object.getOwnPropertyDescriptor(UJ.prototype,"checkMark"),UJ.prototype),GJ=wl(UJ.prototype,"checkEvents",[FJ,Wl,zJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),kJ=wl(UJ.prototype,"_isChecked",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HJ=wl(UJ.prototype,"_checkMark",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VJ=UJ))||VJ)||VJ)||VJ)||VJ)||VJ));var YJ,KJ,$J,JJ,ZJ,QJ,tZ,eZ,iZ,nZ,sZ;let rZ=function(e){return t({ToggleContainer:e,ToggleContainerComponent:e}),e}((YJ=Vl("cc.ToggleContainer"),KJ=ec(),$J=Gl(110),JJ=Jl(),ZJ=rc(),QJ=yc([rP]),tZ=rc(),YJ(eZ=KJ(eZ=$J(eZ=JJ(eZ=$l((nZ=wl((iZ=class extends Rh{constructor(...t){super(...t),Tl(this,"_allowSwitchOff",nZ,this),Tl(this,"checkEvents",sZ,this)}get allowSwitchOff(){return this._allowSwitchOff}set allowSwitchOff(t){this._allowSwitchOff=t}get toggleItems(){return this.node.children.map((t=>{const e=t.getComponent("cc.Toggle");return e&&e.enabled?e:null})).filter(Boolean)}onEnable(){this.ensureValidState(),this.node.on(ev.CHILD_ADDED,this.ensureValidState,this),this.node.on(ev.CHILD_REMOVED,this.ensureValidState,this)}onDisable(){this.node.off(ev.CHILD_ADDED,this.ensureValidState,this),this.node.off(ev.CHILD_REMOVED,this.ensureValidState,this)}activeToggles(){return this.toggleItems.filter((t=>t.isChecked))}anyTogglesChecked(){return!!this.toggleItems.find((t=>t.isChecked))}notifyToggleCheck(t,e=!0){if(this.enabledInHierarchy){for(let i=0;i<this.toggleItems.length;i++){const n=this.toggleItems[i];n!==t&&(e?n.isChecked=!1:n.setIsCheckedWithoutNotify(!1))}this.checkEvents&&n.Component.EventHandler.emitEvents(this.checkEvents,t)}}ensureValidState(){const t=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==t.length){const e=t[0];e.isChecked=!0,this.notifyToggleCheck(e)}const e=this.activeToggles();if(e.length>1){const t=e[0];for(let i=0;i<e.length;++i){const n=e[i];n!==t&&(n.isChecked=!1)}}}}).prototype,"_allowSwitchOff",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wl(iZ.prototype,"allowSwitchOff",[ZJ],Object.getOwnPropertyDescriptor(iZ.prototype,"allowSwitchOff"),iZ.prototype),sZ=wl(iZ.prototype,"checkEvents",[QJ,Wl,tZ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eZ=iZ))||eZ)||eZ)||eZ)||eZ)||eZ));var oZ,aZ,lZ,cZ,hZ,_Z,uZ,mZ,pZ,dZ,fZ,gZ,yZ,vZ,xZ,bZ,SZ,AZ,CZ,TZ,wZ,EZ,PZ,DZ,IZ,RZ,MZ,OZ,BZ,NZ,LZ,FZ,zZ,VZ,UZ,GZ,kZ,HZ,jZ,WZ,qZ,XZ,YZ,KZ,$Z;const JZ=new tn;function ZZ(t){return t instanceof OC?uw:t._uiProps.uiTransformComp?t._uiProps.uiTransformComp.contentSize:ln.ZERO}function QZ(t,e,i,n){t.parent?JZ.set(t.parent.getScale().x,t.parent.getScale().y):JZ.set(0,0);let s=JZ.x,r=JZ.y,o=0,a=0;for(let l=t.parent;;){if(!l)return i.x=i.y=0,void(n.x=n.y=1);const t=l.getPosition();if(o+=t.x,a+=t.y,l=l.parent,l===e)break;{l?JZ.set(l.getScale().x,l.getScale().y):JZ.set(0,0);const t=JZ.x,e=JZ.y;o*=t,a*=e,s*=t,r*=e}}n.x=0!==s?1/s:1,n.y=0!==r?1/r:1,i.x=-o,i.y=-a}let tQ,eQ;!function(t){t[t.ONCE=0]="ONCE",t[t.ALWAYS=1]="ALWAYS",t[t.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(tQ||(tQ={})),zt(tQ),function(t){t[t.TOP=1]="TOP",t[t.MID=2]="MID",t[t.BOT=4]="BOT",t[t.LEFT=8]="LEFT",t[t.CENTER=16]="CENTER",t[t.RIGHT=32]="RIGHT",t[t.HORIZONTAL=56]="HORIZONTAL",t[t.VERTICAL=7]="VERTICAL"}(eQ||(eQ={}));const iQ=eQ.TOP|eQ.BOT,nQ=eQ.LEFT|eQ.RIGHT;let sQ=function(e){return t({Widget:e,WidgetComponent:e}),e}((oZ=Vl("cc.Widget"),aZ=ec(),lZ=Gl(110),cZ=Jl(),hZ=Ul(NL),_Z=yc(Yv),uZ=rc(),mZ=rc(),pZ=rc(),dZ=rc(),fZ=rc(),gZ=rc(),yZ=rc(),vZ=nc(),xZ=nc(),bZ=rc(),SZ=rc(),AZ=rc(),CZ=rc(),TZ=rc(),wZ=rc(),EZ=yc(tQ),PZ=rc(),oZ(DZ=aZ(DZ=lZ(DZ=cZ(DZ=hZ(DZ=$l(($Z=KZ=class extends Rh{constructor(...t){super(...t),this._lastPos=new Ni,this._lastSize=new ln,this._dirty=!0,this._hadAlignOnce=!1,Tl(this,"_alignFlags",RZ,this),Tl(this,"_target",MZ,this),Tl(this,"_left",OZ,this),Tl(this,"_right",BZ,this),Tl(this,"_top",NZ,this),Tl(this,"_bottom",LZ,this),Tl(this,"_horizontalCenter",FZ,this),Tl(this,"_verticalCenter",zZ,this),Tl(this,"_isAbsLeft",VZ,this),Tl(this,"_isAbsRight",UZ,this),Tl(this,"_isAbsTop",GZ,this),Tl(this,"_isAbsBottom",kZ,this),Tl(this,"_isAbsHorizontalCenter",HZ,this),Tl(this,"_isAbsVerticalCenter",jZ,this),Tl(this,"_originalWidth",WZ,this),Tl(this,"_originalHeight",qZ,this),Tl(this,"_alignMode",XZ,this),Tl(this,"_lockFlags",YZ,this)}get target(){return this._target}set target(t){this._target!==t&&(this._unregisterTargetEvents(),this._target=t,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}get isAlignTop(){return(this._alignFlags&eQ.TOP)>0}set isAlignTop(t){this._setAlign(eQ.TOP,t),this._recursiveDirty()}get isAlignBottom(){return(this._alignFlags&eQ.BOT)>0}set isAlignBottom(t){this._setAlign(eQ.BOT,t),this._recursiveDirty()}get isAlignLeft(){return(this._alignFlags&eQ.LEFT)>0}set isAlignLeft(t){this._setAlign(eQ.LEFT,t),this._recursiveDirty()}get isAlignRight(){return(this._alignFlags&eQ.RIGHT)>0}set isAlignRight(t){this._setAlign(eQ.RIGHT,t),this._recursiveDirty()}get isAlignVerticalCenter(){return(this._alignFlags&eQ.MID)>0}set isAlignVerticalCenter(t){t?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=eQ.MID):this._alignFlags&=~eQ.MID,this._recursiveDirty()}get isAlignHorizontalCenter(){return(this._alignFlags&eQ.CENTER)>0}set isAlignHorizontalCenter(t){t?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=eQ.CENTER):this._alignFlags&=~eQ.CENTER,this._recursiveDirty()}get isStretchWidth(){return(this._alignFlags&nQ)===nQ}get isStretchHeight(){return(this._alignFlags&iQ)===iQ}get top(){return this._top}set top(t){this._top=t,this._recursiveDirty()}get editorTop(){return this._isAbsTop?this._top:100*this._top}set editorTop(t){this._top=this._isAbsTop?t:t/100,this._recursiveDirty()}get bottom(){return this._bottom}set bottom(t){this._bottom=t,this._recursiveDirty()}get editorBottom(){return this._isAbsBottom?this._bottom:100*this._bottom}set editorBottom(t){this._bottom=this._isAbsBottom?t:t/100,this._recursiveDirty()}get left(){return this._left}set left(t){this._left=t,this._recursiveDirty()}get editorLeft(){return this._isAbsLeft?this._left:100*this._left}set editorLeft(t){this._left=this._isAbsLeft?t:t/100,this._recursiveDirty()}get right(){return this._right}set right(t){this._right=t,this._recursiveDirty()}get editorRight(){return this._isAbsRight?this._right:100*this._right}set editorRight(t){this._right=this._isAbsRight?t:t/100,this._recursiveDirty()}get horizontalCenter(){return this._horizontalCenter}set horizontalCenter(t){this._horizontalCenter=t,this._recursiveDirty()}get editorHorizontalCenter(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter}set editorHorizontalCenter(t){this._horizontalCenter=this._isAbsHorizontalCenter?t:t/100,this._recursiveDirty()}get verticalCenter(){return this._verticalCenter}set verticalCenter(t){this._verticalCenter=t,this._recursiveDirty()}get editorVerticalCenter(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter}set editorVerticalCenter(t){this._verticalCenter=this._isAbsVerticalCenter?t:t/100,this._recursiveDirty()}get isAbsoluteTop(){return this._isAbsTop}set isAbsoluteTop(t){this._isAbsTop!==t&&(this._isAbsTop=t,this._autoChangedValue(eQ.TOP,this._isAbsTop))}get isAbsoluteBottom(){return this._isAbsBottom}set isAbsoluteBottom(t){this._isAbsBottom!==t&&(this._isAbsBottom=t,this._autoChangedValue(eQ.BOT,this._isAbsBottom))}get isAbsoluteLeft(){return this._isAbsLeft}set isAbsoluteLeft(t){this._isAbsLeft!==t&&(this._isAbsLeft=t,this._autoChangedValue(eQ.LEFT,this._isAbsLeft))}get isAbsoluteRight(){return this._isAbsRight}set isAbsoluteRight(t){this._isAbsRight!==t&&(this._isAbsRight=t,this._autoChangedValue(eQ.RIGHT,this._isAbsRight))}get isAbsoluteHorizontalCenter(){return this._isAbsHorizontalCenter}set isAbsoluteHorizontalCenter(t){this._isAbsHorizontalCenter!==t&&(this._isAbsHorizontalCenter=t,this._autoChangedValue(eQ.CENTER,this._isAbsHorizontalCenter))}get isAbsoluteVerticalCenter(){return this._isAbsVerticalCenter}set isAbsoluteVerticalCenter(t){this._isAbsVerticalCenter!==t&&(this._isAbsVerticalCenter=t,this._autoChangedValue(eQ.MID,this._isAbsVerticalCenter))}get alignMode(){return this._alignMode}set alignMode(t){this._alignMode=t,this._recursiveDirty()}get alignFlags(){return this._alignFlags}set alignFlags(t){this._alignFlags!==t&&(this._alignFlags=t,this._recursiveDirty())}updateAlignment(){n._widgetManager.updateAlignment(this.node)}_validateTargetInDEV(){}setDirty(){this._recursiveDirty()}onEnable(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),n._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()}onDisable(){n._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()}onDestroy(){this._removeParentEvent()}_adjustWidgetToAllowMovingInEditor(t){}_adjustWidgetToAllowResizingInEditor(){}_adjustWidgetToAnchorChanged(){this.setDirty()}_adjustTargetToParentChanged(t){t&&this._unregisterOldParentEvents(t),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()}_registerEvent(){this.node.on(ev.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(ev.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(ev.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(ev.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_unregisterEvent(){this.node.off(ev.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(ev.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(ev.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)}_removeParentEvent(){this.node.off(ev.PARENT_CHANGED,this._adjustTargetToParentChanged,this)}_autoChangedValue(t,e){if(!((this._alignFlags&t)>0))return;const i=this.node.parent&&this.node.parent._uiProps,n=i&&i.uiTransformComp,s=n?n.contentSize:uw;this.isAlignLeft&&t===eQ.LEFT?this._left=e?this._left*s.width:this._left/s.width:this.isAlignRight&&t===eQ.RIGHT?this._right=e?this._right*s.width:this._right/s.width:this.isAlignHorizontalCenter&&t===eQ.CENTER?this._horizontalCenter=e?this._horizontalCenter*s.width:this._horizontalCenter/s.width:this.isAlignTop&&t===eQ.TOP?this._top=e?this._top*s.height:this._top/s.height:this.isAlignBottom&&t===eQ.BOT?this._bottom=e?this._bottom*s.height:this._bottom/s.height:this.isAbsoluteVerticalCenter&&t===eQ.MID&&(this._verticalCenter=this._verticalCenter/s.height),this._recursiveDirty()}_registerTargetEvents(){const t=this._target||this.node.parent;t&&t.getComponent(NL)&&(t.on(ev.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.on(ev.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterTargetEvents(){const t=this._target||this.node.parent;t&&(t.off(ev.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(ev.SIZE_CHANGED,this._setDirtyByMode,this))}_unregisterOldParentEvents(t){const e=this._target||t;e&&(e.off(ev.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(ev.SIZE_CHANGED,this._setDirtyByMode,this))}_setDirtyByMode(){this.alignMode===tQ.ALWAYS&&this._recursiveDirty()}_setAlign(t,e){if(e===(this._alignFlags&t)>0)return;const i=(t&nQ)>0,n=this.node._uiProps.uiTransformComp;e?(this._alignFlags|=t,i?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=n.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=n.height))):(i?this.isStretchWidth&&(n.width=this._originalWidth):this.isStretchHeight&&(n.height=this._originalHeight),this._alignFlags&=~t)}_recursiveDirty(){this._dirty||(this._dirty=!0)}},KZ.AlignMode=tQ,wl((IZ=$Z).prototype,"target",[_Z,uZ],Object.getOwnPropertyDescriptor(IZ.prototype,"target"),IZ.prototype),wl(IZ.prototype,"isAlignTop",[mZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignTop"),IZ.prototype),wl(IZ.prototype,"isAlignBottom",[pZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignBottom"),IZ.prototype),wl(IZ.prototype,"isAlignLeft",[dZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignLeft"),IZ.prototype),wl(IZ.prototype,"isAlignRight",[fZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignRight"),IZ.prototype),wl(IZ.prototype,"isAlignVerticalCenter",[gZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignVerticalCenter"),IZ.prototype),wl(IZ.prototype,"isAlignHorizontalCenter",[yZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isAlignHorizontalCenter"),IZ.prototype),wl(IZ.prototype,"isStretchWidth",[vZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isStretchWidth"),IZ.prototype),wl(IZ.prototype,"isStretchHeight",[xZ],Object.getOwnPropertyDescriptor(IZ.prototype,"isStretchHeight"),IZ.prototype),wl(IZ.prototype,"top",[bZ],Object.getOwnPropertyDescriptor(IZ.prototype,"top"),IZ.prototype),wl(IZ.prototype,"editorTop",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorTop"),IZ.prototype),wl(IZ.prototype,"bottom",[SZ],Object.getOwnPropertyDescriptor(IZ.prototype,"bottom"),IZ.prototype),wl(IZ.prototype,"editorBottom",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorBottom"),IZ.prototype),wl(IZ.prototype,"left",[AZ],Object.getOwnPropertyDescriptor(IZ.prototype,"left"),IZ.prototype),wl(IZ.prototype,"editorLeft",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorLeft"),IZ.prototype),wl(IZ.prototype,"right",[CZ],Object.getOwnPropertyDescriptor(IZ.prototype,"right"),IZ.prototype),wl(IZ.prototype,"editorRight",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorRight"),IZ.prototype),wl(IZ.prototype,"horizontalCenter",[TZ],Object.getOwnPropertyDescriptor(IZ.prototype,"horizontalCenter"),IZ.prototype),wl(IZ.prototype,"editorHorizontalCenter",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorHorizontalCenter"),IZ.prototype),wl(IZ.prototype,"verticalCenter",[wZ],Object.getOwnPropertyDescriptor(IZ.prototype,"verticalCenter"),IZ.prototype),wl(IZ.prototype,"editorVerticalCenter",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"editorVerticalCenter"),IZ.prototype),wl(IZ.prototype,"isAbsoluteTop",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteTop"),IZ.prototype),wl(IZ.prototype,"isAbsoluteBottom",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteBottom"),IZ.prototype),wl(IZ.prototype,"isAbsoluteLeft",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteLeft"),IZ.prototype),wl(IZ.prototype,"isAbsoluteRight",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteRight"),IZ.prototype),wl(IZ.prototype,"isAbsoluteHorizontalCenter",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteHorizontalCenter"),IZ.prototype),wl(IZ.prototype,"isAbsoluteVerticalCenter",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"isAbsoluteVerticalCenter"),IZ.prototype),wl(IZ.prototype,"alignMode",[EZ,PZ],Object.getOwnPropertyDescriptor(IZ.prototype,"alignMode"),IZ.prototype),wl(IZ.prototype,"alignFlags",[ic],Object.getOwnPropertyDescriptor(IZ.prototype,"alignFlags"),IZ.prototype),RZ=wl(IZ.prototype,"_alignFlags",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MZ=wl(IZ.prototype,"_target",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OZ=wl(IZ.prototype,"_left",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BZ=wl(IZ.prototype,"_right",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NZ=wl(IZ.prototype,"_top",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),LZ=wl(IZ.prototype,"_bottom",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FZ=wl(IZ.prototype,"_horizontalCenter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),zZ=wl(IZ.prototype,"_verticalCenter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VZ=wl(IZ.prototype,"_isAbsLeft",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UZ=wl(IZ.prototype,"_isAbsRight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),GZ=wl(IZ.prototype,"_isAbsTop",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kZ=wl(IZ.prototype,"_isAbsBottom",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),HZ=wl(IZ.prototype,"_isAbsHorizontalCenter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jZ=wl(IZ.prototype,"_isAbsVerticalCenter",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),WZ=wl(IZ.prototype,"_originalWidth",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qZ=wl(IZ.prototype,"_originalHeight",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XZ=wl(IZ.prototype,"_alignMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tQ.ON_WINDOW_RESIZE}}),YZ=wl(IZ.prototype,"_lockFlags",[Wl,Xl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DZ=IZ))||DZ)||DZ)||DZ)||DZ)||DZ)||DZ));var rQ,oQ,aQ,lQ,cQ,hQ,_Q,uQ,mQ,pQ,dQ,fQ,gQ,yQ,vQ,xQ,bQ,SQ,AQ;n.internal.computeInverseTransForTarget=QZ,n.internal.getReadonlyNodeSize=ZZ;const CQ=new Ri;var TQ;!function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(TQ||(TQ={})),zt(TQ);let wQ=function(e){return t({PageViewIndicator:e,PageViewIndicatorComponent:e}),e}((rQ=Vl("cc.PageViewIndicator"),oQ=ec(),aQ=Gl(110),lQ=Jl(),cQ=yc(pN),hQ=rc(),_Q=yc(TQ),uQ=rc(),mQ=yc(ln),pQ=rc(),dQ=rc(),rQ(fQ=oQ(fQ=aQ(fQ=lQ((AQ=SQ=class extends Rh{constructor(...t){super(...t),Tl(this,"spacing",yQ,this),Tl(this,"_spriteFrame",vQ,this),Tl(this,"_direction",xQ,this),Tl(this,"_cellSize",bQ,this),this._layout=null,this._pageView=null,this._indicators=[]}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._spriteFrame!==t&&(this._spriteFrame=t)}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t)}get cellSize(){return this._cellSize}set cellSize(t){this._cellSize!==t&&(this._cellSize=t)}onLoad(){this._updateLayout()}setPageView(t){this._pageView=t,this._refresh()}_updateLayout(){this._layout=this.getComponent(YY),this._layout||(this._layout=this.addComponent(YY));const t=this._layout;this.direction===TQ.HORIZONTAL?(t.type=YY.Type.HORIZONTAL,t.spacingX=this.spacing):this.direction===TQ.VERTICAL&&(t.type=YY.Type.VERTICAL,t.spacingY=this.spacing),t.resizeMode=YY.ResizeMode.CONTAINER}_createIndicator(){const t=new Yv;t.layer=this.node.layer;const e=t.addComponent(HU);return e.spriteFrame=this.spriteFrame,e.sizeMode=HU.SizeMode.CUSTOM,t.parent=this.node,t._uiProps.uiTransformComp.setContentSize(this._cellSize),t}_changedState(){const t=this._indicators;if(0===t.length||!this._pageView)return;const e=this._pageView.curPageIdx;if(!(e>=t.length)){for(let e=0;e<t.length;++e){const i=t[e];if(!i._uiProps.uiComp)continue;const n=i._uiProps.uiComp;CQ.set(n.color),CQ.a=127.5,n.color=CQ}if(t[e]._uiProps.uiComp){const i=t[e]._uiProps.uiComp;CQ.set(i.color),CQ.a=255,i.color=CQ}}}_refresh(){if(!this._pageView)return;const t=this._indicators,e=this._pageView.getPages();if(e.length===t.length)return;let i=0;if(e.length>t.length)for(i=0;i<e.length;++i)t[i]||(t[i]=this._createIndicator());else for(i=t.length-e.length;i>0;--i){const e=t[i-1];this.node.removeChild(e),t.splice(i-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}},SQ.Direction=TQ,wl((gQ=AQ).prototype,"spriteFrame",[cQ,hQ],Object.getOwnPropertyDescriptor(gQ.prototype,"spriteFrame"),gQ.prototype),wl(gQ.prototype,"direction",[_Q,uQ],Object.getOwnPropertyDescriptor(gQ.prototype,"direction"),gQ.prototype),wl(gQ.prototype,"cellSize",[mQ,pQ],Object.getOwnPropertyDescriptor(gQ.prototype,"cellSize"),gQ.prototype),yQ=wl(gQ.prototype,"spacing",[Wl,dQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),vQ=wl(gQ.prototype,"_spriteFrame",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xQ=wl(gQ.prototype,"_direction",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TQ.HORIZONTAL}}),bQ=wl(gQ.prototype,"_cellSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(20,20)}}),fQ=gQ))||fQ)||fQ)||fQ)||fQ));var EQ,PQ,DQ,IQ,RQ,MQ,OQ,BQ,NQ,LQ,FQ,zQ,VQ,UQ,GQ,kQ,HQ,jQ,WQ,qQ,XQ,YQ,KQ,$Q,JQ,ZQ,QQ,t0,e0,i0,n0,s0,r0,o0,a0,l0,c0,h0,_0,u0,m0,p0;const d0=new tn;var f0,g0,y0;!function(t){t[t.Unified=0]="Unified",t[t.Free=1]="Free"}(f0||(f0={})),zt(f0),function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical"}(g0||(g0={})),zt(g0),function(t){t.PAGE_TURNING="page-turning"}(y0||(y0={}));let v0=function(e){return t({PageView:e,PageViewComponent:e}),e}((EQ=Vl("cc.PageView"),PQ=ec(),DQ=Gl(110),IQ=Jl(),RQ=yc(f0),MQ=rc(),OQ=yc(g0),BQ=rc(),NQ=oc(),LQ=rc(),FQ=oc(),zQ=rc(),VQ=yc(wQ),UQ=rc(),GQ=rc(),kQ=yc($K),HQ=nc(),jQ=yc($K),WQ=nc(),qQ=nc(),XQ=nc(),YQ=nc(),KQ=yc([rP]),$Q=nc(),JQ=yc([rP]),ZQ=rc(),EQ(QQ=PQ(QQ=DQ(QQ=IQ((p0=m0=class t extends eJ{constructor(...t){super(...t),Tl(this,"autoPageTurningThreshold",e0,this),Tl(this,"horizontal",i0,this),Tl(this,"vertical",n0,this),Tl(this,"cancelInnerEvents",s0,this),Tl(this,"scrollEvents",r0,this),Tl(this,"pageTurningSpeed",o0,this),Tl(this,"pageEvents",a0,this),Tl(this,"_sizeMode",l0,this),Tl(this,"_direction",c0,this),Tl(this,"_scrollThreshold",h0,this),Tl(this,"_pageTurningEventTiming",_0,this),Tl(this,"_indicator",u0,this),this._curPageIdx=0,this._lastPageIdx=0,this._pages=[],this._initContentPos=new Ni,this._scrollCenterOffsetX=[],this._scrollCenterOffsetY=[],this._touchBeganPosition=new tn,this._touchEndPosition=new tn}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,this._syncSizeMode())}get direction(){return this._direction}set direction(t){this._direction!==t&&(this._direction=t,this._syncScrollDirection())}get scrollThreshold(){return this._scrollThreshold}set scrollThreshold(t){this._scrollThreshold!==t&&(this._scrollThreshold=t)}get pageTurningEventTiming(){return this._pageTurningEventTiming}set pageTurningEventTiming(t){this._pageTurningEventTiming!==t&&(this._pageTurningEventTiming=t)}get indicator(){return this._indicator}set indicator(t){this._indicator!==t&&(this._indicator=t,this.indicator&&this.indicator.setPageView(this))}get curPageIdx(){return this._curPageIdx}get verticalScrollBar(){return super.verticalScrollBar}set verticalScrollBar(t){super.verticalScrollBar=t}get horizontalScrollBar(){return super.horizontalScrollBar}set horizontalScrollBar(t){super.horizontalScrollBar=t}onEnable(){super.onEnable(),this.node.on(ev.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onDisable(){super.onDisable(),this.node.off(ev.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)}onLoad(){this._initPages(),this.indicator&&this.indicator.setPageView(this)}getCurrentPageIndex(){return this._curPageIdx}setCurrentPageIndex(t){this.scrollToPage(t,1)}getPages(){return this._pages}addPage(t){t&&-1===this._pages.indexOf(t)&&this.content&&(t._uiProps.uiTransformComp?(this.content.addChild(t),this._pages.push(t),this._updatePageView()):b(4301))}insertPage(t,e){if(!(e<0)&&t&&-1===this._pages.indexOf(t)&&this.content)if(e>=this._pages.length)this.addPage(t);else{if(!t._uiProps.uiTransformComp)return void b(4301);this._pages.splice(e,0,t),this.content.insertChild(t,e),this._updatePageView()}}removePage(t){if(!t||!this.content)return;const e=this._pages.indexOf(t);-1!==e?this.removePageAtIndex(e):A(4300,t.name)}removePageAtIndex(t){const e=this._pages;if(t<0||t>=e.length)return;const i=e[t];i&&this.content&&(this.content.removeChild(i),e.splice(t,1),this._updatePageView())}removeAllPages(){if(!this.content)return;const t=this._pages;for(let e=0,i=t.length;e<i;e++)this.content.removeChild(t[e]);this._pages.length=0,this._updatePageView()}scrollToPage(t,e=.3){t<0||t>=this._pages.length||(this._curPageIdx=t,this.scrollToOffset(this._moveOffsetValue(t),e,!0),this.indicator&&this.indicator._changedState())}getScrollEndedEventTiming(){return this.pageTurningEventTiming}_updatePageView(){if(!this.content)return;const t=this.content.getComponent(YY);t&&t.enabled&&t.updateLayout();const e=this._pages.length;this._curPageIdx>=e&&(this._curPageIdx=0===e?0:e-1,this._lastPageIdx=this._curPageIdx);const i=this._initContentPos;for(let t=0;t<e;++t){const e=this._pages[t].position;this.direction===g0.Horizontal?this._scrollCenterOffsetX[t]=Math.abs(i.x+e.x):this._scrollCenterOffsetY[t]=Math.abs(i.y+e.y)}this.indicator&&this.indicator._refresh()}_updateAllPagesSize(){const t=this.view;if(!this.content||!t)return;if(this._sizeMode!==f0.Unified)return;const e=this._pages,i=t.contentSize;for(let t=0,n=e.length;t<n;t++)e[t]._uiProps.uiTransformComp.setContentSize(i)}_handleReleaseLogic(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))}_onTouchBegan(t,e){t.touch.getUILocation(d0),tn.set(this._touchBeganPosition,d0.x,d0.y),super._onTouchBegan(t,e)}_onTouchMoved(t,e){super._onTouchMoved(t,e)}_onTouchEnded(t,e){t.touch.getUILocation(d0),tn.set(this._touchEndPosition,d0.x,d0.y),super._onTouchEnded(t,e)}_onTouchCancelled(t,e){t.touch.getUILocation(d0),tn.set(this._touchEndPosition,d0.x,d0.y),super._onTouchCancelled(t,e)}_onMouseWheel(){}_syncScrollDirection(){this.horizontal=this.direction===g0.Horizontal,this.vertical=this.direction===g0.Vertical}_syncSizeMode(){const t=this.view;if(!this.content||!t)return;const e=this.content.getComponent(YY);if(e){if(this._sizeMode===f0.Free&&this._pages.length>0){const i=this._pages[0]._uiProps.uiTransformComp,n=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===g0.Horizontal?(e.paddingLeft=(t.width-i.width)/2,e.paddingRight=(t.width-n.width)/2):this.direction===g0.Vertical&&(e.paddingTop=(t.height-i.height)/2,e.paddingBottom=(t.height-n.height)/2)}e.updateLayout()}}_initPages(){if(!this.content)return;this._initContentPos=this.content.position;const t=this.content.children;for(let e=0;e<t.length;++e){const i=t[e];this._pages.indexOf(i)>=0||this._pages.push(i)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}_dispatchPageTurningEvent(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,rP.emitEvents(this.pageEvents,this,y0.PAGE_TURNING),this.node.emit(y0.PAGE_TURNING,this))}_isQuicklyScrollable(t){if(this.direction===g0.Horizontal){if(Math.abs(t.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===g0.Vertical&&Math.abs(t.y)>this.autoPageTurningThreshold)return!0;return!1}_moveOffsetValue(t){const e=new tn;if(this._sizeMode===f0.Free)this.direction===g0.Horizontal?e.x=this._scrollCenterOffsetX[t]:this.direction===g0.Vertical&&(e.y=this._scrollCenterOffsetY[t]);else{const i=this.view;if(!i)return e;this.direction===g0.Horizontal?e.x=t*i.width:this.direction===g0.Vertical&&(e.y=t*i.height)}return e}_getDragDirection(t){return this._direction===g0.Horizontal?0===t.x?0:t.x>0?1:-1:0===t.y?0:t.y<0?1:-1}_isScrollable(t,e,i){if(this._sizeMode===f0.Free){let n=0,s=0;if(this.direction===g0.Horizontal)return n=this._scrollCenterOffsetX[e],s=this._scrollCenterOffsetX[i],Math.abs(t.x)>=Math.abs(n-s)*this.scrollThreshold;if(this.direction===g0.Vertical)return n=this._scrollCenterOffsetY[e],s=this._scrollCenterOffsetY[i],Math.abs(t.y)>=Math.abs(n-s)*this.scrollThreshold}else{const e=this.view;if(!e)return!1;if(this.direction===g0.Horizontal)return Math.abs(t.x)>=e.width*this.scrollThreshold;if(this.direction===g0.Vertical)return Math.abs(t.y)>=e.height*this.scrollThreshold}return!1}_autoScrollToPage(){if(this._startBounceBackIfNeeded()){const t=this._getHowMuchOutOfBoundary();this._clampDelta(t),(t.x>0||t.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(t.x<0||t.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{const t=new tn;tn.subtract(t,this._touchBeganPosition,this._touchEndPosition);const e=this._curPageIdx,i=e+this._getDragDirection(t),n=this.pageTurningSpeed*Math.abs(e-i);if(i<this._pages.length){if(this._isScrollable(t,e,i))return void this.scrollToPage(i,n);{const t=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(t))return void this.scrollToPage(i,n)}}this.scrollToPage(e,n)}}},m0.SizeMode=f0,m0.Direction=g0,m0.EventType=wJ(y0,tJ),wl((t0=p0).prototype,"sizeMode",[RQ,MQ],Object.getOwnPropertyDescriptor(t0.prototype,"sizeMode"),t0.prototype),wl(t0.prototype,"direction",[OQ,BQ],Object.getOwnPropertyDescriptor(t0.prototype,"direction"),t0.prototype),wl(t0.prototype,"scrollThreshold",[hc,NQ,LQ],Object.getOwnPropertyDescriptor(t0.prototype,"scrollThreshold"),t0.prototype),wl(t0.prototype,"pageTurningEventTiming",[hc,FQ,zQ],Object.getOwnPropertyDescriptor(t0.prototype,"pageTurningEventTiming"),t0.prototype),wl(t0.prototype,"indicator",[VQ,UQ],Object.getOwnPropertyDescriptor(t0.prototype,"indicator"),t0.prototype),e0=wl(t0.prototype,"autoPageTurningThreshold",[Wl,GQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),wl(t0.prototype,"verticalScrollBar",[kQ,vc,HQ],Object.getOwnPropertyDescriptor(t0.prototype,"verticalScrollBar"),t0.prototype),wl(t0.prototype,"horizontalScrollBar",[jQ,vc,WQ],Object.getOwnPropertyDescriptor(t0.prototype,"horizontalScrollBar"),t0.prototype),i0=wl(t0.prototype,"horizontal",[vc,Wl,qQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),n0=wl(t0.prototype,"vertical",[vc,Wl,XQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),s0=wl(t0.prototype,"cancelInnerEvents",[vc,Wl,YQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),r0=wl(t0.prototype,"scrollEvents",[KQ,Wl,vc,$Q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o0=wl(t0.prototype,"pageTurningSpeed",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),a0=wl(t0.prototype,"pageEvents",[JQ,Wl,ZQ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),l0=wl(t0.prototype,"_sizeMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return f0.Unified}}),c0=wl(t0.prototype,"_direction",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g0.Horizontal}}),h0=wl(t0.prototype,"_scrollThreshold",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),_0=wl(t0.prototype,"_pageTurningEventTiming",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),u0=wl(t0.prototype,"_indicator",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),QQ=t0))||QQ)||QQ)||QQ)||QQ));const x0=new Ni,b0=new tn,S0=new tn,A0=new tn(1,1),C0=new tn,T0=new tn;function w0(t,e){if(e._hadAlignOnce)return;e.alignMode===tQ.ONCE&&(e._hadAlignOnce=!0);const i=e.target;let n;const s=S0,r=A0;i?(n=i,QZ(t,n,s,r)):n=t.parent;const o=ZZ(n),a=n instanceof OC||!n.getComponent(NL),l=a?b0:n.getComponent(NL).anchorPoint,c=a;t.getPosition(x0);const h=t._uiProps.uiTransformComp;let _=x0.x,u=x0.y;const m=h.anchorPoint,p=t.getScale();if(e.alignFlags&eQ.HORIZONTAL){let t=0,n=0;const a=o.width;c?(t=uw.left.x,n=uw.right.x):(t=-l.x*a,n=t+a),t+=e.isAbsoluteLeft?e.left:e.left*a,n-=e.isAbsoluteRight?e.right:e.right*a,i&&(t+=s.x,t*=r.x,n+=s.x,n*=r.x);let u=0,d=m.x,f=p.x;if(f<0&&(d=1-d,f=-f),e.isStretchWidth)u=n-t,0!==f&&(h.width=u/f),_=t+d*u;else if(u=h.width*f,e.isAlignHorizontalCenter){let t=e.isAbsoluteHorizontalCenter?e.horizontalCenter:e.horizontalCenter*a,n=(.5-l.x)*o.width;i&&(t*=r.x,n+=s.x,n*=r.x),_=n+(d-.5)*u+t}else _=e.isAlignLeft?t+d*u:n+(d-1)*u;e._lastSize.width=u}if(e.alignFlags&eQ.VERTICAL){let t=0,n=0;const a=o.height;c?(n=uw.bottom.y,t=uw.top.y):(n=-l.y*a,t=n+a),n+=e.isAbsoluteBottom?e.bottom:e.bottom*a,t-=e.isAbsoluteTop?e.top:e.top*a,i&&(n+=s.y,n*=r.y,t+=s.y,t*=r.y);let _=0,d=m.y,f=p.y;if(f<0&&(d=1-d,f=-f),e.isStretchHeight)_=t-n,0!==f&&(h.height=_/f),u=n+d*_;else if(_=h.height*f,e.isAlignVerticalCenter){let t=e.isAbsoluteVerticalCenter?e.verticalCenter:e.verticalCenter*a,n=(.5-l.y)*o.height;i&&(t*=r.y,n+=s.y,n*=r.y),u=n+(d-.5)*_+t}else u=e.isAlignBottom?n+d*_:t+(d-1)*_;e._lastSize.height=_}t.setPosition(_,u,x0.z),Ni.set(e._lastPos,_,u,x0.z)}function E0(t){const e=t.getComponent(sQ);if(e&&e.enabled){if(!n.isValid(t,!0))return;D0.push(e)}const i=t.children;for(const t of i)t.active&&E0(t)}function P0(){const t=Mw.getScene();if(t){I0.isAligning=!0,I0._nodesOrderDirty&&(D0.length=0,E0(t),I0._nodesOrderDirty=!1);let e=null;const i=I0._activeWidgetsIterator;for(i.i=0;i.i<D0.length;++i.i)e=D0[i.i],e._dirty&&(w0(e.node,e),e._dirty=!1);I0.isAligning=!1}}const D0=[],I0=t("widgetManager",n._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new Mt.MutableForwardIterator(D0),animationState:null,init(){Mw.on(Rw.EVENT_AFTER_SCENE_LAUNCH,P0),Mw.on(Rw.EVENT_AFTER_UPDATE,P0),dw.instance.on("design-resolution-changed",this.onResized,this);{const t=this.onResized.bind(this);dw.instance.on("canvas-resize",t),dn.on("orientation-change",t)}},add(t){this._nodesOrderDirty=!0},remove(t){this._activeWidgetsIterator.remove(t)},onResized(){const t=Mw.getScene();t&&this.refreshWidgetOnResized(t)},refreshWidgetOnResized(t){const e=Yv.isNode(t)&&t.getComponent(sQ);e&&e.enabled&&(e.alignMode===tQ.ON_WINDOW_RESIZE||e.alignMode===tQ.ALWAYS)&&e.setDirty();const i=t.children;for(const t of i)this.refreshWidgetOnResized(t)},updateOffsetsToStayPut(t,e){function i(t,e){return Math.abs(t-e)>1e-10?e:t}const n=t.node;let s=n.parent;if(s){const r=C0;r.set(0,0);const o=T0;if(o.set(1,1),t.target&&(s=t.target,QZ(n,s,r,o)),!e)return;const a=s._uiProps&&s._uiProps.uiTransformComp,l=a?a.anchorPoint:b0,c=n._uiProps.uiTransformComp,h=ZZ(s),_=c.anchorPoint,u=n.getPosition(),m=eQ,p=n.getScale();let d=0;if(e&m.LEFT){let e=-l.x*h.width;e+=r.x,e*=o.x,d=u.x-_.x*c.width*p.x-e,t.isAbsoluteLeft||(d/=h.width),d/=o.x,t.left=i(t.left,d)}if(e&m.RIGHT){let e=(1-l.x)*h.width;e+=r.x,d=(e*=o.x)-(u.x+(1-_.x)*c.width*p.x),t.isAbsoluteRight||(d/=h.width),d/=o.x,t.right=i(t.right,d)}if(e&m.TOP){let e=(1-l.y)*h.height;e+=r.y,d=(e*=o.y)-(u.y+(1-_.y)*c.height*p.y),t.isAbsoluteTop||(d/=h.height),d/=o.y,t.top=i(t.top,d)}if(e&m.BOT){let e=-l.y*h.height;e+=r.y,e*=o.y,d=u.y-_.y*c.height*p.y-e,t.isAbsoluteBottom||(d/=h.height),d/=o.y,t.bottom=i(t.bottom,d)}}},updateAlignment:function t(e){const i=e.parent;i&&Yv.isNode(i)&&t(i);const n=e.getComponent(sQ);n&&i&&w0(e,n)},AlignMode:tQ,AlignFlags:eQ});var R0;Mw.on(Rw.EVENT_INIT,(()=>{I0.init()}));let M0=function(e){return t({SafeArea:e,SafeAreaComponent:e}),e}(Vl("cc.SafeArea")(R0=ec()(R0=Gl(110)(R0=$l(R0=Jl()(R0=Ul(sQ)(R0=class extends Rh{onEnable(){this.updateArea(),dn.on("window-resize",this.updateArea,this),dn.on("orientation-change",this.updateArea,this)}onDisable(){dn.off("window-resize",this.updateArea,this),dn.off("orientation-change",this.updateArea,this)}updateArea(){const t=this.node.getComponent(sQ),e=this.node.getComponent(NL);if(!t||!e)return;t.updateAlignment();const i=this.node.position.clone(),n=e.anchorPoint.clone();t.isAlignTop=t.isAlignBottom=t.isAlignLeft=t.isAlignRight=!0;const s=vw.getVisibleSize(),r=s.width,o=s.height,a=yn.getSafeAreaRect();t.top=o-a.y-a.height,t.bottom=a.y,t.left=a.x,t.right=r-a.x-a.width,t.updateAlignment();const l=this.node.position.clone(),c=n.x-(l.x-i.x)/e.width,h=n.y-(l.y-i.y)/e.height;e.setAnchorPoint(c,h),I0.add(t)}})||R0)||R0)||R0)||R0)||R0)||R0);var O0,B0,N0,L0,F0,z0,V0,U0,G0,k0,H0,j0,W0,q0,X0,Y0,K0,$0,J0;let Z0=function(e){return t({UICoordinateTracker:e,UICoordinateTrackerComponent:e}),e}((O0=Vl("cc.UICoordinateTracker"),B0=ec(),N0=Jl(),L0=Gl(110),F0=yc(Yv),z0=rc(),V0=yc(wD),U0=rc(),G0=rc(),k0=rc(),H0=yc([rP]),j0=rc(),O0(W0=B0(W0=N0(W0=L0((wl((q0=class extends Rh{constructor(...t){super(...t),Tl(this,"syncEvents",X0,this),Tl(this,"_target",Y0,this),Tl(this,"_camera",K0,this),Tl(this,"_useScale",$0,this),Tl(this,"_distance",J0,this),this._transformPos=new Ni,this._viewPos=new Ni,this._canMove=!0,this._lastWPos=new Ni,this._lastCameraPos=new Ni}get target(){return this._target}set target(t){this._target!==t&&(this._target=t,this._checkCanMove())}get camera(){return this._camera}set camera(t){this._camera!==t&&(this._camera=t,this._checkCanMove())}get useScale(){return this._useScale}set useScale(t){this._useScale!==t&&(this._useScale=t)}get distance(){return this._distance}set distance(t){this._distance!==t&&(this._distance=t)}onEnable(){this._checkCanMove()}update(){const t=this.node.worldPosition,e=this._camera;if(this._canMove&&e&&e.camera&&(!this._lastWPos.equals(t)||!this._lastCameraPos.equals(e.node.worldPosition))&&(this._lastWPos.set(t),this._lastCameraPos.set(e.node.worldPosition),e.camera.update(),e.convertToUINode(t,this._target,this._transformPos),this._useScale&&Ni.transformMat4(this._viewPos,this.node.worldPosition,e.camera.matView),this.syncEvents.length>0)){const t=this._distance/Math.abs(this._viewPos.z);rP.emitEvents(this.syncEvents,this._transformPos,t)}}_checkCanMove(){this._canMove=!(!this._camera||!this._target)}}).prototype,"target",[F0,z0],Object.getOwnPropertyDescriptor(q0.prototype,"target"),q0.prototype),wl(q0.prototype,"camera",[V0,U0],Object.getOwnPropertyDescriptor(q0.prototype,"camera"),q0.prototype),wl(q0.prototype,"useScale",[G0],Object.getOwnPropertyDescriptor(q0.prototype,"useScale"),q0.prototype),wl(q0.prototype,"distance",[k0],Object.getOwnPropertyDescriptor(q0.prototype,"distance"),q0.prototype),X0=wl(q0.prototype,"syncEvents",[H0,Wl,j0],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Y0=wl(q0.prototype,"_target",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),K0=wl(q0.prototype,"_camera",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$0=wl(q0.prototype,"_useScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),J0=wl(q0.prototype,"_distance",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),W0=q0))||W0)||W0)||W0)||W0));var Q0;const t1=[ev.TOUCH_START,ev.TOUCH_END,ev.TOUCH_MOVE,ev.MOUSE_DOWN,ev.MOUSE_MOVE,ev.MOUSE_UP,ev.MOUSE_ENTER,ev.MOUSE_LEAVE,ev.MOUSE_WHEEL];function e1(t){t.propagationStopped=!0}let i1=function(e){return t({BlockInputEvents:e,BlockInputEventsComponent:e}),e}(Vl("cc.BlockInputEvents")(Q0=ec()(Q0=Jl()(Q0=class extends Rh{onEnable(){for(let t=0;t<t1.length;t++)this.node.on(t1[t],e1,this)}onDisable(){for(let t=0;t<t1.length;t++)this.node.off(t1[t],e1,this)}})||Q0)||Q0)||Q0);const n1={};var s1,r1,o1,a1,l1,c1,h1,_1,u1,m1,p1;let d1=t("SubContextView",(s1=Vl("cc.SubContextView"),r1=ec(),o1=Gl(110),a1=Ul(NL),l1=Jl(),c1=rc(),h1=rc(),s1(_1=r1(_1=o1(_1=a1(_1=l1((wl((u1=class extends Rh{get designResolutionSize(){return this._designResolutionSize}set designResolutionSize(t){}get fps(){return this._fps}set fps(t){this._fps!==t&&(this._fps=t,this._updateInterval=1e3/t)}constructor(){super(),Tl(this,"_fps",m1,this),this._sprite=void 0,this._imageAsset=void 0,this._texture=void 0,this._updatedTime=0,this._updateInterval=0,this._openDataContext=void 0,this._content=void 0,Tl(this,"_designResolutionSize",p1,this),this._content=new Yv("content"),this._content.hideFlags|=Me.Flags.DontSave|Me.Flags.HideInHierarchy,this._sprite=null,this._imageAsset=new Gd,this._openDataContext=null,this._updatedTime=performance.now(),this._texture=new Af}onLoad(){n1.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=n1.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1}onEnable(){this._registerNodeEvent()}onDisable(){this._unregisterNodeEvent()}_initSharedCanvas(){if(this._openDataContext){const t=this._openDataContext.canvas;t.width=this._designResolutionSize.width,t.height=this._designResolutionSize.height}}_initContentNode(){if(this._openDataContext){const t=this._openDataContext.canvas,e=this._imageAsset;if(e.reset(t),this._texture.image=e,this._texture.create(t.width,t.height),this._sprite=this._content.getComponent(HU),this._sprite||(this._sprite=this._content.addComponent(HU)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{const t=new pN;t.texture=this._texture,this._sprite.spriteFrame=t}this._content.parent=this.node}}_updateSubContextView(){if(!this._openDataContext)return;const t=this.node.getComponent(NL),e=this._content.getComponent(NL),i=t.width/e.width,n=t.height/e.height,s=i>n?n:i;e.width*=s,e.height*=s;const r=vw.getViewportRect(),o=e.getBoundingBoxToWorld(),a=vw.getVisibleSize(),l=vw.getDevicePixelRatio(),c=(r.width*(o.x/a.width)+r.x)/l,h=(r.height*(o.y/a.height)+r.y)/l,_=r.width*(o.width/a.width)/l,u=r.height*(o.height/a.height)/l;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:c,y:h,width:_,height:u})}_updateSubContextTexture(){const t=this._imageAsset;if(!t||!this._openDataContext)return;if(t.width<=0||t.height<=0)return;const e=this._openDataContext.canvas;t.reset(e),(e.width>t.width||e.height>t.height)&&this._texture.create(e.width,e.height),this._texture.uploadData(e)}_registerNodeEvent(){this.node.on(ev.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(ev.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(ev.LAYER_CHANGED,this._updateContentLayer,this)}_unregisterNodeEvent(){this.node.off(ev.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(ev.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(ev.LAYER_CHANGED,this._updateContentLayer,this)}_updateContentLayer(){this._content.layer=this.node.layer}update(t){void 0!==t?performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture()):this._updateSubContextTexture()}onDestroy(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null}}).prototype,"designResolutionSize",[c1],Object.getOwnPropertyDescriptor(u1.prototype,"designResolutionSize"),u1.prototype),wl(u1.prototype,"fps",[h1],Object.getOwnPropertyDescriptor(u1.prototype,"fps"),u1.prototype),m1=wl(u1.prototype,"_fps",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),p1=wl(u1.prototype,"_designResolutionSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(640,960)}}),_1=u1))||_1)||_1)||_1)||_1)||_1));var f1;n.SubContextView=d1;let g1,y1,v1=t("UIReorderComponent",Vl("cc.UIReorderComponent")(f1=class{constructor(){A(1408,"UIReorderComponent")}})||f1);n.UIReorderComponent=v1,n.ButtonComponent=Mq,Ot.setClassAlias(Mq,"cc.ButtonComponent"),n.EditBoxComponent=UX,Ot.setClassAlias(UX,"cc.EditBoxComponent"),n.LayoutComponent=YY,Ot.setClassAlias(YY,"cc.LayoutComponent"),n.ProgressBarComponent=yK,Ot.setClassAlias(yK,"cc.ProgressBarComponent"),n.ScrollViewComponent=eJ,Ot.setClassAlias(eJ,"cc.ScrollViewComponent"),n.ScrollBarComponent=$K,Ot.setClassAlias($K,"cc.ScrollBarComponent"),n.SliderComponent=TJ,Ot.setClassAlias(TJ,"cc.SliderComponent"),n.ToggleComponent=XJ,Ot.setClassAlias(XJ,"cc.ToggleComponent"),n.ToggleContainerComponent=rZ,Ot.setClassAlias(rZ,"cc.ToggleContainerComponent"),n.WidgetComponent=sQ,Ot.setClassAlias(sQ,"cc.WidgetComponent"),n.PageViewComponent=v0,Ot.setClassAlias(v0,"cc.PageViewComponent"),n.PageViewIndicatorComponent=wQ,Ot.setClassAlias(wQ,"cc.PageViewIndicatorComponent"),n.SafeAreaComponent=M0,Ot.setClassAlias(M0,"cc.SafeAreaComponent"),Ot.setClassAlias(Z0,"cc.UICoordinateTrackerComponent"),n.BlockInputEventsComponent=i1,Ot.setClassAlias(i1,"cc.BlockInputEventsComponent"),"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var x1,b1=function(t,e){return function(t,e){!function(t){function e(t,...e){if(!t)throw new Error(...e)}function i(t,e){return void 0!==t?t:e}const n=1e37,s=1e-5,r=s*s,o=3.14159265359,a=2,l=8,c=.1,h=2,_=.008,u=2/180*o,m=2*_,p=8,d=32,f=1,g=.2,y=8/180*o,v=2,x=v*v,b=.5*o,S=b*b,A=.2,C=.75,T=-1,w=2147483647,E=.75,P=1,D=.25,I=.5,R=2,M=R*R,O=256,B=2.5,N=.5,L=.01,F=2/180*o;function z(){return null}function V(){}function U(){}class G{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}const k=new G(2,3,2),H="master",j="fbf51801d80fc389d43dc46524520e89043b6faf";function W(t){return parseInt(t,10)}function q(t){return Math.abs(parseInt(t,10))}function X(t,e){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e(n);return i}function Y(t){const e=new Array(t);for(let i=0;i<t;++i)e[i]=null;return e}function K(t,e=0){const i=new Array(t);for(let n=0;n<t;++n)i[n]=e;return i}const $=o/180,J=180/o,Z=2*o,Q=Math.abs;function tt(t,e){return t<e?t:e}function et(t,e){return t>e?t:e}function it(t,e,i){return t<e?e:t>i?i:t}function nt(t,e){const i=t[0];t[0]=e[0],e[0]=i}const st=isFinite;function rt(t){return t*t}function ot(t){return 1/Math.sqrt(t)}const at=Math.sqrt,lt=Math.pow;function ct(t){return t*$}function ht(t){return t*J}const _t=Math.cos,ut=Math.sin,mt=Math.acos,pt=Math.asin,dt=Math.atan2;function ft(t){return t|=t>>1&2147483647,t|=t>>2&1073741823,t|=t>>4&268435455,1+((t|=t>>8&16777215)|t>>16&65535)}function gt(t){return t>0&&0==(t&t-1)}function yt(){return 2*Math.random()-1}function vt(t,e){return(e-t)*Math.random()+t}class xt{constructor(...t){if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new xt(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=s){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),n=this.x;return this.x=e*n-i*this.y,this.y=i*n+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=tt(this.x,t.x),this.y=tt(this.y,t.y),this}SelfMaxV(t){return this.x=et(this.x,t.x),this.y=et(this.y,t.y),this}SelfAbs(){return this.x=Q(this.x),this.y=Q(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return X(t,(()=>new xt))}static AbsV(t,e){return e.x=Q(t.x),e.y=Q(t.y),e}static MinV(t,e,i){return i.x=tt(t.x,e.x),i.y=tt(t.y,e.y),i}static MaxV(t,e,i){return i.x=et(t.x,e.x),i.y=et(t.y,e.y),i}static ClampV(t,e,i,n){return n.x=it(t.x,e.x,i.x),n.y=it(t.y,e.y,i.y),n}static RotateV(t,e,i){const n=t.x,s=t.y,r=Math.cos(e),o=Math.sin(e);return i.x=r*n-o*s,i.y=o*n+r*s,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const n=t.x;return i.x=e*t.y,i.y=-e*n,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const n=e.x;return i.x=-t*e.y,i.y=t*n,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,n){return n.x=t.x+e*i.x,n.y=t.y+e*i.y,n}static SubVMulSV(t,e,i,n){return n.x=t.x-e*i.x,n.y=t.y-e*i.y,n}static AddVCrossSV(t,e,i,n){const s=i.x;return n.x=t.x-e*i.y,n.y=t.y+e*s,n}static MidVV(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static ExtVV(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,n=t.y-e.y;return Math.sqrt(i*i+n*n)}static DistanceSquaredVV(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}xt.ZERO=new xt(0,0),xt.UNITX=new xt(1,0),xt.UNITY=new xt(0,1),xt.s_t0=new xt,xt.s_t1=new xt,xt.s_t2=new xt,xt.s_t3=new xt;const bt=new xt(0,0);class St{constructor(...t){if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0,n="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([e,i,n])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new St(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const n=t.x,s=t.y,r=t.z,o=e.x,a=e.y,l=e.z;return i.x=s*l-r*a,i.y=r*o-n*l,i.z=n*a-s*o,i}}St.ZERO=new St(0,0,0),St.s_t0=new St;class At{constructor(){this.data=new Float32Array([1,0,0,1]),this.ex=new xt(this.data.subarray(0,2)),this.ey=new xt(this.data.subarray(2,4))}Clone(){return(new At).Copy(this)}static FromVV(t,e){return(new At).SetVV(t,e)}static FromSSSS(t,e,i,n){return(new At).SetSSSS(t,e,i,n)}static FromAngle(t){return(new At).SetAngle(t)}SetSSSS(t,e,i,n){return this.ex.Set(t,i),this.ey.Set(e,n),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;return 0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.y=-r*n,t.ey.y=r*e,t}Solve(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,n=t.ey;return e.ex.x=Q(i.x),e.ex.y=Q(i.y),e.ey.x=Q(n.x),e.ey.y=Q(n.y),e}static MulMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+s.x*o,i.y=n.y*r+s.y*o,i}static MulTMV(t,e,i){const n=t.ex,s=t.ey,r=e.x,o=e.y;return i.x=n.x*r+n.y*o,i.y=s.x*r+s.y*o,i}static AddMM(t,e,i){const n=t.ex,s=t.ey,r=e.ex,o=e.ey;return i.ex.x=n.x+r.x,i.ex.y=n.y+r.y,i.ey.x=s.x+o.x,i.ey.y=s.y+o.y,i}static MulMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=n*a+r*l,i.ex.y=s*a+o*l,i.ey.x=n*c+r*h,i.ey.y=s*c+o*h,i}static MulTMM(t,e,i){const n=t.ex.x,s=t.ex.y,r=t.ey.x,o=t.ey.y,a=e.ex.x,l=e.ex.y,c=e.ey.x,h=e.ey.y;return i.ex.x=n*a+s*l,i.ex.y=r*a+o*l,i.ey.x=n*c+s*h,i.ey.y=r*c+o*h,i}}At.IDENTITY=new At;class Ct{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new St(this.data.subarray(0,3)),this.ey=new St(this.data.subarray(3,6)),this.ez=new St(this.data.subarray(6,9))}Clone(){return(new Ct).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,n){const s=this.ex.x,r=this.ex.y,o=this.ex.z,a=this.ey.x,l=this.ey.y,c=this.ey.z,h=this.ez.x,_=this.ez.y,u=this.ez.z;let m=s*(l*u-c*_)+r*(c*h-a*u)+o*(a*_-l*h);return 0!==m&&(m=1/m),n.x=m*(t*(l*u-c*_)+e*(c*h-a*u)+i*(a*_-l*h)),n.y=m*(s*(e*u-i*_)+r*(i*h-t*u)+o*(t*_-e*h)),n.z=m*(s*(l*i-c*e)+r*(c*t-a*i)+o*(a*e-l*t)),n}Solve22(t,e,i){const n=this.ex.x,s=this.ey.x,r=this.ex.y,o=this.ey.y;let a=n*o-s*r;return 0!==a&&(a=1/a),i.x=a*(o*t-s*e),i.y=a*(n*e-r*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,n=this.ex.y,s=this.ey.y;let r=e*s-i*n;0!==r&&(r=1/r),t.ex.x=r*s,t.ey.x=-r*i,t.ex.z=0,t.ex.y=-r*n,t.ey.y=r*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=St.DotV3V3(this.ex,St.CrossV3V3(this.ey,this.ez,St.s_t0));0!==e&&(e=1/e);const i=this.ex.x,n=this.ey.x,s=this.ez.x,r=this.ey.y,o=this.ez.y,a=this.ez.z;t.ex.x=e*(r*a-o*o),t.ex.y=e*(s*o-n*a),t.ex.z=e*(n*o-s*r),t.ey.x=t.ex.y,t.ey.y=e*(i*a-s*s),t.ey.z=e*(s*n-i*o),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*r-n*n)}static MulM33V3(t,e,i){const n=e.x,s=e.y,r=e.z;return i.x=t.ex.x*n+t.ey.x*s+t.ez.x*r,i.y=t.ex.y*n+t.ey.y*s+t.ez.y*r,i.z=t.ex.z*n+t.ey.z*s+t.ez.z*r,i}static MulM33XYZ(t,e,i,n,s){return s.x=t.ex.x*e+t.ey.x*i+t.ez.x*n,s.y=t.ex.y*e+t.ey.y*i+t.ez.y*n,s.z=t.ex.z*e+t.ey.z*i+t.ez.z*n,s}static MulM33V2(t,e,i){const n=e.x,s=e.y;return i.x=t.ex.x*n+t.ey.x*s,i.y=t.ex.y*n+t.ey.y*s,i}static MulM33XY(t,e,i,n){return n.x=t.ex.x*e+t.ey.x*i,n.y=t.ex.y*e+t.ey.y*i,n}}Ct.IDENTITY=new Ct;class Tt{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new Tt).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=s*r+n*o,i.c=n*r-s*o,i}static MulTRR(t,e,i){const n=t.c,s=t.s,r=e.c,o=e.s;return i.s=n*o-s*r,i.c=n*r+s*o,i}static MulRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r-s*o,i.y=s*r+n*o,i}static MulTRV(t,e,i){const n=t.c,s=t.s,r=e.x,o=e.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}}Tt.IDENTITY=new Tt;class wt{constructor(){this.p=new xt,this.q=new Tt}Clone(){return(new wt).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x,o=e.y;return i.x=n*r-s*o+t.p.x,i.y=s*r+n*o+t.p.y,i}static MulTXV(t,e,i){const n=t.q.c,s=t.q.s,r=e.x-t.p.x,o=e.y-t.p.y;return i.x=n*r+s*o,i.y=-s*r+n*o,i}static MulXX(t,e,i){return Tt.MulRR(t.q,e.q,i.q),xt.AddVV(Tt.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return Tt.MulTRR(t.q,e.q,i.q),Tt.MulTRV(t.q,xt.SubVV(e.p,t.p,i.p),i.p),i}}wt.IDENTITY=new wt;class Et{constructor(){this.localCenter=new xt,this.c0=new xt,this.c=new xt,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new Et).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){const i=1-e;t.p.x=i*this.c0.x+e*this.c.x,t.p.y=i*this.c0.y+e*this.c.y;const n=i*this.a0+e*this.a;return t.q.SetAngle(n),t.p.SelfSub(Tt.MulRV(t.q,this.localCenter,xt.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=Z*Math.floor(this.a0/Z);this.a0-=t,this.a-=t}}class Pt{constructor(...t){if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:.5,i="number"==typeof t[1]?t[1]:.5,n="number"==typeof t[2]?t[2]:.5,s="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([e,i,n,s])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return(new Pt).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,n=this.a){this.SetRGBA(t,e,i,n)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,n){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=n/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){Pt.MixColors(this,t,e)}static MixColors(t,e,i){const n=i*(e.r-t.r),s=i*(e.g-t.g),r=i*(e.b-t.b),o=i*(e.a-t.a);t.r+=n,t.g+=s,t.b+=r,t.a+=o,e.r-=n,e.g-=s,e.b-=r,e.a-=o}MakeStyleString(t=this.a){return Pt.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,n=1){return t*=255,e*=255,i*=255,n<1?`rgba(${t},${e},${i},${n})`:`rgb(${t},${e},${i})`}}var Dt;Pt.ZERO=new Pt(0,0,0,0),Pt.RED=new Pt(1,0,0),Pt.GREEN=new Pt(0,1,0),Pt.BLUE=new Pt(0,0,1),(Dt=t.b2DrawFlags||(t.b2DrawFlags={}))[Dt.e_none=0]="e_none",Dt[Dt.e_shapeBit=1]="e_shapeBit",Dt[Dt.e_jointBit=2]="e_jointBit",Dt[Dt.e_aabbBit=4]="e_aabbBit",Dt[Dt.e_pairBit=8]="e_pairBit",Dt[Dt.e_centerOfMassBit=16]="e_centerOfMassBit",Dt[Dt.e_particleBit=32]="e_particleBit",Dt[Dt.e_controllerBit=64]="e_controllerBit",Dt[Dt.e_all=63]="e_all";class It{constructor(){this.m_drawFlags=0}SetFlags(t){this.m_drawFlags=t}GetFlags(){return this.m_drawFlags}AppendFlags(t){this.m_drawFlags|=t}ClearFlags(t){this.m_drawFlags&=~t}}class Rt{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class Mt{constructor(){this.m_count=0,this.m_min_count=0,this.m_max_count=0}GetCount(){return this.m_count}GetMinCount(){return this.m_min_count}GetMaxCount(){return this.m_max_count}ResetCount(){const t=this.m_count;return this.m_count=0,t}ResetMinCount(){this.m_min_count=0}ResetMaxCount(){this.m_max_count=0}Increment(){this.m_count++,this.m_max_count<this.m_count&&(this.m_max_count=this.m_count)}Decrement(){this.m_count--,this.m_min_count>this.m_count&&(this.m_min_count=this.m_count)}}class Ot{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=X(t,(()=>null)),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];if(this.m_stack[this.m_count]=null,null===t)throw new Error;return t}GetCount(){return this.m_count}}class Bt{}class Nt{}class Lt{constructor(){this.m_buffer=xt.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return e}GetSupportVertex(t){let e=0,i=xt.DotVV(this.m_vertices[0],t);for(let n=1;n<this.m_count;++n){const s=xt.DotVV(this.m_vertices[n],t);s>i&&(e=n,i=s)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class Ft{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class zt{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new wt,this.transformB=new wt,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class Vt{constructor(){this.pointA=new xt,this.pointB=new xt,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}class Ut{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.transformA=new wt,this.transformB=new wt,this.translationB=new xt}}class Gt{constructor(){this.point=new xt,this.normal=new xt,this.lambda=0,this.iterations=0}}function kt(){t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0}t.b2_gjkCalls=0,t.b2_gjkIters=0,t.b2_gjkMaxIters=0;class Ht{constructor(){this.wA=new xt,this.wB=new xt,this.w=new xt,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class jt{constructor(){this.m_v1=new Ht,this.m_v2=new Ht,this.m_v3=new Ht,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,n,r){this.m_count=t.count;const o=this.m_vertices;for(let s=0;s<this.m_count;++s){const a=o[s];a.indexA=t.indexA[s],a.indexB=t.indexB[s];const l=e.GetVertex(a.indexA),c=n.GetVertex(a.indexB);wt.MulXV(i,l,a.wA),wt.MulXV(r,c,a.wB),xt.SubVV(a.wB,a.wA,a.w),a.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<s)&&(this.m_count=0)}if(0===this.m_count){const t=o[0];t.indexA=0,t.indexB=0;const s=e.GetVertex(0),a=n.GetVertex(0);wt.MulXV(i,s,t.wA),wt.MulXV(r,a,t.wB),xt.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return xt.NegV(this.m_v1.w,t);case 2:{const e=xt.SubVV(this.m_v2.w,this.m_v1.w,t);return xt.CrossVV(e,xt.NegV(this.m_v1.w,xt.s_t0))>0?xt.CrossOneV(e,t):xt.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);case 3:default:return t.SetZero()}}GetWitnessPoints(t,e){switch(this.m_count){case 0:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:return 0;case 2:return xt.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return xt.CrossVV(xt.SubVV(this.m_v2.w,this.m_v1.w,xt.s_t0),xt.SubVV(this.m_v3.w,this.m_v1.w,xt.s_t1));default:return 0}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=xt.SubVV(e,t,jt.s_e12),n=-xt.DotVV(t,i);if(n<=0)return this.m_v1.a=1,void(this.m_count=1);const s=xt.DotVV(e,i);if(s<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const r=1/(s+n);this.m_v1.a=s*r,this.m_v2.a=n*r,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,n=xt.SubVV(e,t,jt.s_e12),s=xt.DotVV(t,n),r=xt.DotVV(e,n),o=-s,a=xt.SubVV(i,t,jt.s_e13),l=xt.DotVV(t,a),c=xt.DotVV(i,a),h=-l,_=xt.SubVV(i,e,jt.s_e23),u=xt.DotVV(e,_),m=xt.DotVV(i,_),p=-u,d=xt.CrossVV(n,a),f=d*xt.CrossVV(e,i),g=d*xt.CrossVV(i,t),y=d*xt.CrossVV(t,e);if(o<=0&&h<=0)return this.m_v1.a=1,void(this.m_count=1);if(r>0&&o>0&&y<=0){const t=1/(r+o);return this.m_v1.a=r*t,this.m_v2.a=o*t,void(this.m_count=2)}if(c>0&&h>0&&g<=0){const t=1/(c+h);return this.m_v1.a=c*t,this.m_v3.a=h*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(r<=0&&p<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(c<=0&&m<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(m>0&&p>0&&f<=0){const t=1/(m+p);return this.m_v2.a=m*t,this.m_v3.a=p*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const v=1/(f+g+y);this.m_v1.a=f*v,this.m_v2.a=g*v,this.m_v3.a=y*v,this.m_count=3}}jt.s_e12=new xt,jt.s_e13=new xt,jt.s_e23=new xt;const Wt=new jt,qt=[0,0,0],Xt=[0,0,0],Yt=new xt,Kt=new xt,$t=new xt,Jt=new xt,Zt=new xt;function Qt(e,i,n){++t.b2_gjkCalls;const o=n.proxyA,a=n.proxyB,l=n.transformA,c=n.transformB,h=Wt;h.ReadCache(i,o,l,a,c);const _=h.m_vertices,u=20,m=qt,p=Xt;let d=0,f=0;for(;f<u;){d=h.m_count;for(let t=0;t<d;++t)m[t]=_[t].indexA,p[t]=_[t].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;const e=h.GetSearchDirection(Kt);if(e.LengthSquared()<r)break;const i=_[h.m_count];i.indexA=o.GetSupport(Tt.MulTRV(l.q,xt.NegV(e,xt.s_t0),Jt)),wt.MulXV(l,o.GetVertex(i.indexA),i.wA),i.indexB=a.GetSupport(Tt.MulTRV(c.q,e,Zt)),wt.MulXV(c,a.GetVertex(i.indexB),i.wB),xt.SubVV(i.wB,i.wA,i.w),++f,++t.b2_gjkIters;let n=!1;for(let t=0;t<d;++t)if(i.indexA===m[t]&&i.indexB===p[t]){n=!0;break}if(n)break;++h.m_count}if(t.b2_gjkMaxIters=et(t.b2_gjkMaxIters,f),h.GetWitnessPoints(e.pointA,e.pointB),e.distance=xt.DistanceVV(e.pointA,e.pointB),e.iterations=f,h.WriteCache(i),n.useRadii){const t=o.m_radius,i=a.m_radius;if(e.distance>t+i&&e.distance>s){e.distance-=t+i;const n=xt.SubVV(e.pointB,e.pointA,$t);n.Normalize(),e.pointA.SelfMulAdd(t,n),e.pointB.SelfMulSub(i,n)}else{const t=xt.MidVV(e.pointA,e.pointB,Yt);e.pointA.Copy(t),e.pointB.Copy(t),e.distance=0}}}const te=new xt,ee=new jt,ie=new xt,ne=new xt,se=new xt,re=new xt,oe=new xt,ae=new xt;function le(t,e){t.iterations=0,t.lambda=1,t.normal.SetZero(),t.point.SetZero();const i=e.proxyA,n=e.proxyB,s=et(i.m_radius,m)+et(n.m_radius,m),r=e.transformA,o=e.transformB,a=e.translationB,l=te.Set(0,0);let c=0;const h=ee;h.m_count=0;const u=h.m_vertices;let p=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(a,xt.s_t1),xt.s_t0)),d=wt.MulXV(r,i.GetVertex(p),ie),f=n.GetSupport(Tt.MulTRV(o.q,a,xt.s_t0)),g=wt.MulXV(o,n.GetVertex(f),ne);const y=xt.SubVV(d,g,se),v=et(m,s-m),x=.5*_,b=20;let S=0;for(;S<b&&Q(y.Length()-v)>x;){t.iterations+=1,p=i.GetSupport(Tt.MulTRV(r.q,xt.NegV(y,xt.s_t1),xt.s_t0)),d=wt.MulXV(r,i.GetVertex(p),ie),f=n.GetSupport(Tt.MulTRV(o.q,y,xt.s_t0)),g=wt.MulXV(o,n.GetVertex(f),ne);const e=xt.SubVV(d,g,re);y.Normalize();const s=xt.DotVV(y,e),_=xt.DotVV(y,a);if(s-v>c*_){if(_<=0)return!1;if(c=(s-v)/_,c>1)return!1;l.Copy(y).SelfNeg(),h.m_count=0}const m=u[h.m_count];switch(m.indexA=f,m.wA.Copy(g).SelfMulAdd(c,a),m.indexB=p,m.wB.Copy(d),m.w.Copy(m.wB).SelfSub(m.wA),m.a=1,h.m_count+=1,h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)return!1;h.GetClosestPoint(y),++S}const A=oe,C=ae;return h.GetWitnessPoints(A,C),y.LengthSquared()>0&&(l.Copy(y).SelfNeg(),l.Normalize()),t.normal.Copy(l),t.lambda=c,t.iterations=S,!0}var ce,he,_e;(ce=t.b2ContactFeatureType||(t.b2ContactFeatureType={}))[ce.e_vertex=0]="e_vertex",ce[ce.e_face=1]="e_face";class ue{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class me{constructor(){this.cf=new ue}Copy(t){return this.key=t.key,this}Clone(){return(new me).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class pe{constructor(){this.localPoint=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.id=new me}static MakeArray(t){return X(t,(()=>new pe))}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}(he=t.b2ManifoldType||(t.b2ManifoldType={}))[he.e_unknown=-1]="e_unknown",he[he.e_circles=0]="e_circles",he[he.e_faceA=1]="e_faceA",he[he.e_faceB=2]="e_faceB";class de{constructor(){this.points=pe.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<a;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=t.b2ManifoldType.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<a;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new de).Copy(this)}}class fe{constructor(){this.normal=new xt,this.points=xt.MakeArray(a),this.separations=K(a)}Initialize(e,i,n,s,o){if(0!==e.pointCount)switch(e.type){case t.b2ManifoldType.e_circles:{this.normal.Set(1,0);const t=wt.MulXV(i,e.localPoint,fe.Initialize_s_pointA),a=wt.MulXV(s,e.points[0].localPoint,fe.Initialize_s_pointB);xt.DistanceSquaredVV(t,a)>r&&xt.SubVV(a,t,this.normal).SelfNormalize();const l=xt.AddVMulSV(t,n,this.normal,fe.Initialize_s_cA),c=xt.SubVMulSV(a,o,this.normal,fe.Initialize_s_cB);xt.MidVV(l,c,this.points[0]),this.separations[0]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal);break}case t.b2ManifoldType.e_faceA:{Tt.MulRV(i.q,e.localNormal,this.normal);const t=wt.MulXV(i,e.localPoint,fe.Initialize_s_planePoint);for(let i=0;i<e.pointCount;++i){const r=wt.MulXV(s,e.points[i].localPoint,fe.Initialize_s_clipPoint),a=n-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),l=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cA),c=xt.SubVMulSV(r,o,this.normal,fe.Initialize_s_cB);xt.MidVV(l,c,this.points[i]),this.separations[i]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal)}break}case t.b2ManifoldType.e_faceB:{Tt.MulRV(s.q,e.localNormal,this.normal);const t=wt.MulXV(s,e.localPoint,fe.Initialize_s_planePoint);for(let s=0;s<e.pointCount;++s){const r=wt.MulXV(i,e.points[s].localPoint,fe.Initialize_s_clipPoint),a=o-xt.DotVV(xt.SubVV(r,t,xt.s_t0),this.normal),l=xt.AddVMulSV(r,a,this.normal,fe.Initialize_s_cB),c=xt.SubVMulSV(r,n,this.normal,fe.Initialize_s_cA);xt.MidVV(c,l,this.points[s]),this.separations[s]=xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.normal)}this.normal.SelfNeg();break}}}}function ge(e,i,n,s){let r;for(r=0;r<n.pointCount;++r){const i=n.points[r].id.key;e[r]=t.b2PointState.b2_removeState;for(let n=0,o=s.pointCount;n<o;++n)if(s.points[n].id.key===i){e[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)e[r]=t.b2PointState.b2_nullState;for(r=0;r<s.pointCount;++r){const e=s.points[r].id.key;i[r]=t.b2PointState.b2_addState;for(let s=0,o=n.pointCount;s<o;++s)if(n.points[s].id.key===e){i[r]=t.b2PointState.b2_persistState;break}}for(;r<a;++r)i[r]=t.b2PointState.b2_nullState}fe.Initialize_s_pointA=new xt,fe.Initialize_s_pointB=new xt,fe.Initialize_s_cA=new xt,fe.Initialize_s_cB=new xt,fe.Initialize_s_planePoint=new xt,fe.Initialize_s_clipPoint=new xt,(_e=t.b2PointState||(t.b2PointState={}))[_e.b2_nullState=0]="b2_nullState",_e[_e.b2_addState=1]="b2_addState",_e[_e.b2_persistState=2]="b2_persistState",_e[_e.b2_removeState=3]="b2_removeState";class ye{constructor(){this.v=new xt,this.id=new me}static MakeArray(t){return X(t,(()=>new ye))}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class ve{constructor(){this.p1=new xt,this.p2=new xt,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class xe{constructor(){this.normal=new xt,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class be{constructor(){this.lowerBound=new xt,this.upperBound=new xt,this.m_cache_center=new xt,this.m_cache_extent=new xt}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return xt.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return xt.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=tt(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=tt(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=et(this.upperBound.x,t.upperBound.x),this.upperBound.y=et(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=tt(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=tt(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=et(t.upperBound.x,e.upperBound.x),this.upperBound.y=et(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){return!(this.lowerBound.x<=t.lowerBound.x||this.lowerBound.y<=t.lowerBound.y||t.upperBound.x<=this.upperBound.x||t.upperBound.y<=this.upperBound.y)}RayCast(t,e){let i=-n,r=n;const o=e.p1.x,a=e.p1.y,l=e.p2.x-e.p1.x,c=e.p2.y-e.p1.y,h=Q(l),_=Q(c),u=t.normal;if(h<s){if(o<this.lowerBound.x||this.upperBound.x<o)return!1}else{const t=1/l;let e=(this.lowerBound.x-o)*t,n=(this.upperBound.x-o)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=s,u.y=0,i=e),r=tt(r,n),i>r)return!1}if(_<s){if(a<this.lowerBound.y||this.upperBound.y<a)return!1}else{const t=1/c;let e=(this.lowerBound.y-a)*t,n=(this.upperBound.y-a)*t,s=-1;if(e>n){const t=e;e=n,n=t,s=1}if(e>i&&(u.x=0,u.y=s,i=e),r=tt(r,n),i>r)return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function Se(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function Ae(e,i,n,s,r){let o=0;const a=i[0],l=i[1],c=xt.DotVV(n,a.v)-s,h=xt.DotVV(n,l.v)-s;if(c<=0&&e[o++].Copy(a),h<=0&&e[o++].Copy(l),c*h<0){const i=c/(c-h),n=e[o].v;n.x=a.v.x+i*(l.v.x-a.v.x),n.y=a.v.y+i*(l.v.y-a.v.y);const s=e[o].id;s.cf.indexA=r,s.cf.indexB=a.id.cf.indexB,s.cf.typeA=t.b2ContactFeatureType.e_vertex,s.cf.typeB=t.b2ContactFeatureType.e_face,++o}return o}const Ce=new zt,Te=new Ft,we=new Vt;function Ee(t,e,i,n,r,o){const a=Ce.Reset();a.proxyA.SetShape(t,e),a.proxyB.SetShape(i,n),a.transformA.Copy(r),a.transformB.Copy(o),a.useRadii=!0;const l=Te.Reset();l.count=0;const c=we.Reset();return Qt(c,l,a),c.distance<10*s}function Pe(t){if(null===t)throw new Error;return t}class De{constructor(t=0){this.m_id=0,this.aabb=new be,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.m_id=t}get userData(){if(null===this._userData)throw new Error;return this._userData}set userData(t){if(null!==this._userData)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return null===this.child1}}class Ie{constructor(){this.m_root=null,this.m_freeList=null,this.m_path=0,this.m_insertionCount=0,this.m_stack=new Ot(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestOverlap(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const n=i.Pop();if(null!==n&&n.aabb.TestContain(t))if(n.IsLeaf()){if(!e(n))return}else i.Push(n.child1),i.Push(n.child2)}}RayCast(t,e){const i=t.p1,n=t.p2,s=xt.SubVV(n,i,Ie.s_r);s.Normalize();const r=xt.CrossOneV(s,Ie.s_v),o=xt.AbsV(r,Ie.s_abs_v);let a=t.maxFraction;const l=Ie.s_segmentAABB;let c=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y);l.lowerBound.x=tt(i.x,c),l.lowerBound.y=tt(i.y,h),l.upperBound.x=et(i.x,c),l.upperBound.y=et(i.y,h);const _=this.m_stack.Reset();for(_.Push(this.m_root);_.GetCount()>0;){const s=_.Pop();if(null===s)continue;if(!Se(s.aabb,l))continue;const u=s.aabb.GetCenter(),m=s.aabb.GetExtents();if(!(Q(xt.DotVV(r,xt.SubVV(i,u,xt.s_t0)))-xt.DotVV(o,m)>0))if(s.IsLeaf()){const r=Ie.s_subInput;r.p1.Copy(t.p1),r.p2.Copy(t.p2),r.maxFraction=a;const o=e(r,s);if(0===o)return;o>0&&(a=o,c=i.x+a*(n.x-i.x),h=i.y+a*(n.y-i.y),l.lowerBound.x=tt(i.x,c),l.lowerBound.y=tt(i.y,h),l.upperBound.x=et(i.x,c),l.upperBound.y=et(i.y,h))}else _.Push(s.child1),_.Push(s.child2)}}AllocateNode(){if(null!==this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t}return new De(Ie.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode(),n=c,s=c;return i.aabb.lowerBound.x=t.lowerBound.x-n,i.aabb.lowerBound.y=t.lowerBound.y-s,i.aabb.upperBound.x=t.upperBound.x+n,i.aabb.upperBound.y=t.upperBound.y+s,i.userData=e,i.height=0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){if(t.aabb.Contains(e))return!1;this.RemoveLeaf(t);const n=c,s=c;t.aabb.lowerBound.x=e.lowerBound.x-n,t.aabb.lowerBound.y=e.lowerBound.y-s,t.aabb.upperBound.x=e.upperBound.x+n,t.aabb.upperBound.y=e.upperBound.y+s;const r=h*i.x,o=h*i.y;return r<0?t.aabb.lowerBound.x+=r:t.aabb.upperBound.x+=r,o<0?t.aabb.lowerBound.y+=o:t.aabb.upperBound.y+=o,this.InsertLeaf(t),!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const t=Pe(i.child1),n=Pe(i.child2),s=i.aabb.GetPerimeter(),r=Ie.s_combinedAABB;r.Combine2(i.aabb,e);const o=r.GetPerimeter(),a=2*o,l=2*(o-s);let c;const h=Ie.s_aabb;let _,u,m;if(t.IsLeaf()?(h.Combine2(e,t.aabb),c=h.GetPerimeter()+l):(h.Combine2(e,t.aabb),_=t.aabb.GetPerimeter(),u=h.GetPerimeter(),c=u-_+l),n.IsLeaf()?(h.Combine2(e,n.aabb),m=h.GetPerimeter()+l):(h.Combine2(e,n.aabb),_=n.aabb.GetPerimeter(),u=h.GetPerimeter(),m=u-_+l),a<c&&a<m)break;i=c<m?t:n}const n=i.parent,s=this.AllocateNode();s.parent=n,s.aabb.Combine2(e,i.aabb),s.height=i.height+1,null!==n?(n.child1===i?n.child1=s:n.child2=s,s.child1=i,s.child2=t,i.parent=s,t.parent=s):(s.child1=i,s.child2=t,i.parent=s,t.parent=s,this.m_root=s);let r=t.parent;for(;null!==r;){r=this.Balance(r);const t=Pe(r.child1),e=Pe(r.child2);r.height=1+et(t.height,e.height),r.aabb.Combine2(t.aabb,e.aabb),r=r.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=Pe(t.parent),i=e&&e.parent,n=Pe(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=n:i.child2=n,n.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=Pe(t.child1),i=Pe(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+et(e.height,i.height),t=t.parent}}else this.m_root=n,n.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=Pe(t.child1),i=Pe(t.child2),n=i.height-e.height;if(n>1){const n=Pe(i.child1),s=Pe(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,n.height>s.height?(i.child2=n,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(e.height,s.height),i.height=1+et(t.height,n.height)):(i.child2=s,t.child2=n,n.parent=t,t.aabb.Combine2(e.aabb,n.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(e.height,n.height),i.height=1+et(t.height,s.height)),i}if(n<-1){const n=Pe(e.child1),s=Pe(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,n.height>s.height?(e.child2=n,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,n.aabb),t.height=1+et(i.height,s.height),e.height=1+et(t.height,n.height)):(e.child2=s,t.child1=n,n.parent=t,t.aabb.Combine2(i.aabb,n.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+et(i.height,n.height),e.height=1+et(t.height,s.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=Ie.GetAreaNode(t.child1),e+=Ie.GetAreaNode(t.child2),e}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return Ie.GetAreaNode(this.m_root)/t}static ComputeHeightNode(t){return null===t||t.IsLeaf()?0:1+et(Ie.ComputeHeightNode(t.child1),Ie.ComputeHeightNode(t.child2))}ComputeHeight(){return Ie.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;if(this.m_root,t.IsLeaf())return;const e=Pe(t.child1),i=Pe(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(null===t)return;if(t.IsLeaf())return;const e=Pe(t.child1),i=Pe(t.child2);Ie.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=Pe(t.child1),n=Pe(t.child2);return et(e,Q(n.height-i.height))}GetMaxBalance(){return Ie.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,n=t.child2;Ie.ShiftOriginNode(i,e),Ie.ShiftOriginNode(n,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){Ie.ShiftOriginNode(this.m_root,t)}}function Re(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Me(t,e){return t<e}function Oe(t,e=0,i=t.length-e,n=Me){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;Re(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}Ie.s_r=new xt,Ie.s_v=new xt,Ie.s_abs_v=new xt,Ie.s_segmentAABB=new be,Ie.s_subInput=new ve,Ie.s_combinedAABB=new be,Ie.s_aabb=new be,Ie.s_node_id=0;class Be{constructor(t,e){this.proxyA=t,this.proxyB=e}}class Ne{constructor(){this.m_tree=new Ie,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=e.aabb;this.m_tree.Query(i,(t=>{if(t.m_id===e.m_id)return!0;let i,n;if(t.m_id<e.m_id?(i=t,n=e):(i=e,n=t),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new Be(i,n);else{const t=this.m_pairBuffer[this.m_pairCount];t.proxyA=i,t.proxyB=n}return++this.m_pairCount,!0}))}this.m_moveCount=0,Oe(this.m_pairBuffer,0,this.m_pairCount,Le);let e=0;for(;e<this.m_pairCount;){const i=this.m_pairBuffer[e];for(t(i.proxyA.userData,i.proxyB.userData),++e;e<this.m_pairCount;){const t=this.m_pairBuffer[e];if(t.proxyA.m_id!==i.proxyA.m_id||t.proxyB.m_id!==i.proxyB.m_id)break;++e}}}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){const e=this.m_moveBuffer.indexOf(t);this.m_moveBuffer[e]=null}}function Le(t,e){return t.proxyA.m_id<e.proxyA.m_id||t.proxyA.m_id===e.proxyA.m_id&&t.proxyB.m_id<e.proxyB.m_id}function Fe(){t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0}t.b2_toiTime=0,t.b2_toiMaxTime=0,t.b2_toiCalls=0,t.b2_toiIters=0,t.b2_toiMaxIters=0,t.b2_toiRootIters=0,t.b2_toiMaxRootIters=0;const ze=new wt,Ve=new wt,Ue=new xt,Ge=new xt,ke=new xt,He=new xt,je=new xt;class We{constructor(){this.proxyA=new Lt,this.proxyB=new Lt,this.sweepA=new Et,this.sweepB=new Et,this.tMax=0}}var qe,Xe;(qe=t.b2TOIOutputState||(t.b2TOIOutputState={}))[qe.e_unknown=0]="e_unknown",qe[qe.e_failed=1]="e_failed",qe[qe.e_overlapped=2]="e_overlapped",qe[qe.e_touching=3]="e_touching",qe[qe.e_separated=4]="e_separated";class Ye{constructor(){this.state=t.b2TOIOutputState.e_unknown,this.t=0}}(Xe=t.b2SeparationFunctionType||(t.b2SeparationFunctionType={}))[Xe.e_unknown=-1]="e_unknown",Xe[Xe.e_points=0]="e_points",Xe[Xe.e_faceA=1]="e_faceA",Xe[Xe.e_faceB=2]="e_faceB";class Ke{constructor(){this.m_sweepA=new Et,this.m_sweepB=new Et,this.m_type=t.b2SeparationFunctionType.e_unknown,this.m_localPoint=new xt,this.m_axis=new xt}Initialize(e,i,n,s,r,o){this.m_proxyA=i,this.m_proxyB=s;const a=e.count;this.m_sweepA.Copy(n),this.m_sweepB.Copy(r);const l=ze,c=Ve;if(this.m_sweepA.GetTransform(l,o),this.m_sweepB.GetTransform(c,o),1===a){this.m_type=t.b2SeparationFunctionType.e_points;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyB.GetVertex(e.indexB[0]),s=wt.MulXV(l,i,Ue),r=wt.MulXV(c,n,Ge);xt.SubVV(r,s,this.m_axis);const o=this.m_axis.Normalize();return this.m_localPoint.SetZero(),o}if(e.indexA[0]===e.indexA[1]){this.m_type=t.b2SeparationFunctionType.e_faceB;const i=this.m_proxyB.GetVertex(e.indexB[0]),n=this.m_proxyB.GetVertex(e.indexB[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(c.q,this.m_axis,ke);xt.MidVV(i,n,this.m_localPoint);const r=wt.MulXV(c,this.m_localPoint,Ge),o=this.m_proxyA.GetVertex(e.indexA[0]),a=wt.MulXV(l,o,Ue);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}{this.m_type=t.b2SeparationFunctionType.e_faceA;const i=this.m_proxyA.GetVertex(e.indexA[0]),n=this.m_proxyA.GetVertex(e.indexA[1]);xt.CrossVOne(xt.SubVV(n,i,xt.s_t0),this.m_axis).SelfNormalize();const s=Tt.MulRV(l.q,this.m_axis,ke);xt.MidVV(i,n,this.m_localPoint);const r=wt.MulXV(l,this.m_localPoint,Ue),o=this.m_proxyB.GetVertex(e.indexB[0]),a=wt.MulXV(c,o,Ge);let h=xt.DotVV(xt.SubVV(a,r,xt.s_t0),s);return h<0&&(this.m_axis.SelfNeg(),h=-h),h}}FindMinSeparation(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=Tt.MulTRV(s.q,this.m_axis,He),n=Tt.MulTRV(r.q,xt.NegV(this.m_axis,xt.s_t0),je);e[0]=this.m_proxyA.GetSupport(t),i[0]=this.m_proxyB.GetSupport(n);const o=this.m_proxyA.GetVertex(e[0]),a=this.m_proxyB.GetVertex(i[0]),l=wt.MulXV(s,o,Ue),c=wt.MulXV(r,a,Ge);return xt.DotVV(xt.SubVV(c,l,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,ke),n=wt.MulXV(s,this.m_localPoint,Ue),o=Tt.MulTRV(r.q,xt.NegV(t,xt.s_t0),je);e[0]=-1,i[0]=this.m_proxyB.GetSupport(o);const a=this.m_proxyB.GetVertex(i[0]),l=wt.MulXV(r,a,Ge);return xt.DotVV(xt.SubVV(l,n,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,ke),n=wt.MulXV(r,this.m_localPoint,Ge),o=Tt.MulTRV(s.q,xt.NegV(t,xt.s_t0),He);i[0]=-1,e[0]=this.m_proxyA.GetSupport(o);const a=this.m_proxyA.GetVertex(e[0]),l=wt.MulXV(s,a,Ue);return xt.DotVV(xt.SubVV(l,n,xt.s_t0),t)}default:return e[0]=-1,i[0]=-1,0}}Evaluate(e,i,n){const s=ze,r=Ve;switch(this.m_sweepA.GetTransform(s,n),this.m_sweepB.GetTransform(r,n),this.m_type){case t.b2SeparationFunctionType.e_points:{const t=this.m_proxyA.GetVertex(e),n=this.m_proxyB.GetVertex(i),o=wt.MulXV(s,t,Ue),a=wt.MulXV(r,n,Ge);return xt.DotVV(xt.SubVV(a,o,xt.s_t0),this.m_axis)}case t.b2SeparationFunctionType.e_faceA:{const t=Tt.MulRV(s.q,this.m_axis,ke),e=wt.MulXV(s,this.m_localPoint,Ue),n=this.m_proxyB.GetVertex(i),o=wt.MulXV(r,n,Ge);return xt.DotVV(xt.SubVV(o,e,xt.s_t0),t)}case t.b2SeparationFunctionType.e_faceB:{const t=Tt.MulRV(r.q,this.m_axis,ke),i=wt.MulXV(r,this.m_localPoint,Ge),n=this.m_proxyA.GetVertex(e),o=wt.MulXV(s,n,Ue);return xt.DotVV(xt.SubVV(o,i,xt.s_t0),t)}default:return 0}}}const $e=new Rt,Je=new Ft,Ze=new zt,Qe=new Vt,ti=new Ke,ei=[0],ii=[0],ni=new Et,si=new Et;function ri(e,i){const n=$e.Reset();++t.b2_toiCalls,e.state=t.b2TOIOutputState.e_unknown,e.t=i.tMax;const s=i.proxyA,r=i.proxyB,o=et(l,et(s.m_count,r.m_count)),a=ni.Copy(i.sweepA),c=si.Copy(i.sweepB);a.Normalize(),c.Normalize();const h=i.tMax,u=s.m_radius+r.m_radius,m=et(_,u-3*_),p=.25*_;let d=0;const f=20;let g=0;const y=Je;y.count=0;const v=Ze;for(v.proxyA.Copy(i.proxyA),v.proxyB.Copy(i.proxyB),v.useRadii=!1;;){const i=ze,n=Ve;a.GetTransform(i,d),c.GetTransform(n,d),v.transformA.Copy(i),v.transformB.Copy(n);const l=Qe;if(Qt(l,y,v),l.distance<=0){e.state=t.b2TOIOutputState.e_overlapped,e.t=0;break}if(l.distance<m+p){e.state=t.b2TOIOutputState.e_touching,e.t=d;break}const _=ti;_.Initialize(y,s,a,r,c,d);let u=!1,x=h,b=0;for(;;){const i=ei,n=ii;let s=_.FindMinSeparation(i,n,x);if(s>m+p){e.state=t.b2TOIOutputState.e_separated,e.t=h,u=!0;break}if(s>m-p){d=x;break}let r=_.Evaluate(i[0],n[0],d);if(r<m-p){e.state=t.b2TOIOutputState.e_failed,e.t=d,u=!0;break}if(r<=m+p){e.state=t.b2TOIOutputState.e_touching,e.t=d,u=!0;break}let a=0,l=d,c=x;for(;;){let e=0;e=1&a?l+(m-r)*(c-l)/(s-r):.5*(l+c),++a,++t.b2_toiRootIters;const o=_.Evaluate(i[0],n[0],e);if(Q(o-m)<p){x=e;break}if(o>m?(l=e,r=o):(c=e,s=o),50===a)break}if(t.b2_toiMaxRootIters=et(t.b2_toiMaxRootIters,a),++b,b===o)break}if(++g,++t.b2_toiIters,u)break;if(g===f){e.state=t.b2TOIOutputState.e_failed,e.t=d;break}}t.b2_toiMaxIters=et(t.b2_toiMaxIters,g);const x=n.GetMilliseconds();t.b2_toiMaxTime=et(t.b2_toiMaxTime,x),t.b2_toiTime+=x}const oi=new xt,ai=new xt;function li(e,i,n,s,r){e.pointCount=0;const o=wt.MulXV(n,i.m_p,oi),a=wt.MulXV(r,s.m_p,ai),l=xt.DistanceSquaredVV(o,a),c=i.m_radius+s.m_radius;l>c*c||(e.type=t.b2ManifoldType.e_circles,e.localPoint.Copy(i.m_p),e.localNormal.SetZero(),e.pointCount=1,e.points[0].localPoint.Copy(s.m_p),e.points[0].id.key=0)}const ci=new xt,hi=new xt,_i=new xt;function ui(e,i,r,o,a){e.pointCount=0;const l=wt.MulXV(a,o.m_p,ci),c=wt.MulTXV(r,l,hi);let h=0,_=-n;const u=i.m_radius+o.m_radius,m=i.m_count,p=i.m_vertices,d=i.m_normals;for(let t=0;t<m;++t){const e=xt.DotVV(d[t],xt.SubVV(c,p[t],xt.s_t0));if(e>u)return;e>_&&(_=e,h=t)}const f=h,g=(f+1)%m,y=p[f],v=p[g];if(_<s)return e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[h]),xt.MidVV(y,v,e.localPoint),e.points[0].localPoint.Copy(o.m_p),void(e.points[0].id.key=0);const x=xt.DotVV(xt.SubVV(c,y,xt.s_t0),xt.SubVV(v,y,xt.s_t1)),b=xt.DotVV(xt.SubVV(c,v,xt.s_t0),xt.SubVV(y,v,xt.s_t1));if(x<=0){if(xt.DistanceSquaredVV(c,y)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(c,y,e.localNormal).SelfNormalize(),e.localPoint.Copy(y),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else if(b<=0){if(xt.DistanceSquaredVV(c,v)>u*u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,xt.SubVV(c,v,e.localNormal).SelfNormalize(),e.localPoint.Copy(v),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}else{const i=xt.MidVV(y,v,_i);if(xt.DotVV(xt.SubVV(c,i,xt.s_t1),d[f])>u)return;e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(d[f]).SelfNormalize(),e.localPoint.Copy(i),e.points[0].localPoint.Copy(o.m_p),e.points[0].id.key=0}}const mi=new xt,pi=new xt,di=new xt,fi=new xt;function gi(t,e,i,s,r){const o=t.m_vertices,a=t.m_normals,l=s.m_count,c=s.m_vertices,h=Tt.MulRV(e.q,a[i],mi),_=Tt.MulTRV(r.q,h,pi);let u=0,m=n;for(let t=0;t<l;++t){const e=xt.DotVV(c[t],_);e<m&&(m=e,u=t)}const p=wt.MulXV(e,o[i],di),d=wt.MulXV(r,c[u],fi);return xt.DotVV(xt.SubVV(d,p,xt.s_t0),h)}const yi=new xt,vi=new xt;function xi(t,e,i,s,r){const o=e.m_count,a=e.m_normals,l=xt.SubVV(wt.MulXV(r,s.m_centroid,xt.s_t0),wt.MulXV(i,e.m_centroid,xt.s_t1),yi),c=Tt.MulTRV(i.q,l,vi);let h=0,_=-n;for(let t=0;t<o;++t){const e=xt.DotVV(a[t],c);e>_&&(_=e,h=t)}let u=gi(e,i,h,s,r);const m=(h+o-1)%o,p=gi(e,i,m,s,r),d=(h+1)%o,f=gi(e,i,d,s,r);let g=0,y=0,v=0;if(p>u&&p>f)v=-1,g=m,y=p;else{if(!(f>u))return t[0]=h,u;v=1,g=d,y=f}for(;h=-1===v?(g+o-1)%o:(g+1)%o,u=gi(e,i,h,s,r),u>y;)g=h,y=u;return t[0]=g,y}const bi=new xt;function Si(e,i,s,r,o,a){const l=i.m_normals,c=o.m_count,h=o.m_vertices,_=o.m_normals,u=Tt.MulTRV(a.q,Tt.MulRV(s.q,l[r],xt.s_t0),bi);let m=0,p=n;for(let t=0;t<c;++t){const e=xt.DotVV(u,_[t]);e<p&&(p=e,m=t)}const d=m,f=(d+1)%c,g=e[0];wt.MulXV(a,h[d],g.v);const y=g.id.cf;y.indexA=r,y.indexB=d,y.typeA=t.b2ContactFeatureType.e_face,y.typeB=t.b2ContactFeatureType.e_vertex;const v=e[1];wt.MulXV(a,h[f],v.v);const x=v.id.cf;x.indexA=r,x.indexB=f,x.typeA=t.b2ContactFeatureType.e_face,x.typeB=t.b2ContactFeatureType.e_vertex}const Ai=ye.MakeArray(2),Ci=ye.MakeArray(2),Ti=ye.MakeArray(2),wi=[0],Ei=[0],Pi=new xt,Di=new xt,Ii=new xt,Ri=new xt,Mi=new xt,Oi=new xt,Bi=new xt,Ni=new xt;function Li(e,i,n,s,r){e.pointCount=0;const o=i.m_radius+s.m_radius,l=wi;l[0]=0;const c=xi(l,i,n,s,r);if(c>o)return;const h=Ei;h[0]=0;const _=xi(h,s,r,i,n);if(_>o)return;let u,m,p,d,f=0,g=0;_>.98*c+.001?(u=s,m=i,p=r,d=n,f=h[0],e.type=t.b2ManifoldType.e_faceB,g=1):(u=i,m=s,p=n,d=r,f=l[0],e.type=t.b2ManifoldType.e_faceA,g=0);const y=Ai;Si(y,u,p,f,m,d);const v=u.m_count,x=u.m_vertices,b=f,S=(f+1)%v,A=x[b],C=x[S],T=xt.SubVV(C,A,Pi);T.Normalize();const w=xt.CrossVOne(T,Di),E=xt.MidVV(A,C,Ii),P=Tt.MulRV(p.q,T,Mi),D=xt.CrossVOne(P,Ri),I=wt.MulXV(p,A,Bi),R=wt.MulXV(p,C,Ni),M=xt.DotVV(D,I),O=-xt.DotVV(P,I)+o,B=xt.DotVV(P,R)+o,N=Ci,L=Ti;let F;if(F=Ae(N,y,xt.NegV(P,Oi),O,b),F<2)return;if(F=Ae(L,N,P,B,S),F<2)return;e.localNormal.Copy(w),e.localPoint.Copy(E);let z=0;for(let t=0;t<a;++t){const i=L[t];if(xt.DotVV(D,i.v)-M<=o){const t=e.points[z];if(wt.MulTXV(d,i.v,t.localPoint),t.id.Copy(i.id),g){const e=t.id.cf;t.id.cf.indexA=e.indexB,t.id.cf.indexB=e.indexA,t.id.cf.typeA=e.typeB,t.id.cf.typeB=e.typeA}++z}}e.pointCount=z}const Fi=new xt,zi=new xt,Vi=new xt,Ui=new xt,Gi=new xt,ki=new xt,Hi=new xt,ji=new me;function Wi(e,i,n,s,r){e.pointCount=0;const o=wt.MulTXV(n,wt.MulXV(r,s.m_p,xt.s_t0),Fi),a=i.m_vertex1,l=i.m_vertex2,c=xt.SubVV(l,a,zi),h=xt.DotVV(c,xt.SubVV(l,o,xt.s_t0)),_=xt.DotVV(c,xt.SubVV(o,a,xt.s_t0)),u=i.m_radius+s.m_radius,m=ji;if(m.cf.indexB=0,m.cf.typeB=t.b2ContactFeatureType.e_vertex,_<=0){const n=a,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex0){const t=i.m_vertex0,e=a,n=xt.SubVV(e,t,Ui);if(xt.DotVV(n,xt.SubVV(e,o,xt.s_t0))>0)return}return m.cf.indexA=0,m.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(m),void e.points[0].localPoint.Copy(s.m_p)}if(h<=0){const n=l,r=xt.SubVV(o,n,Vi);if(xt.DotVV(r,r)>u*u)return;if(i.m_hasVertex3){const t=i.m_vertex3,e=l,n=xt.SubVV(t,e,Gi);if(xt.DotVV(n,xt.SubVV(o,e,xt.s_t0))>0)return}return m.cf.indexA=1,m.cf.typeA=t.b2ContactFeatureType.e_vertex,e.pointCount=1,e.type=t.b2ManifoldType.e_circles,e.localNormal.SetZero(),e.localPoint.Copy(n),e.points[0].id.Copy(m),void e.points[0].localPoint.Copy(s.m_p)}const p=xt.DotVV(c,c),d=ki;d.x=1/p*(h*a.x+_*l.x),d.y=1/p*(h*a.y+_*l.y);const f=xt.SubVV(o,d,Vi);if(xt.DotVV(f,f)>u*u)return;const g=Hi.Set(-c.y,c.x);xt.DotVV(g,xt.SubVV(o,a,xt.s_t0))<0&&g.Set(-g.x,-g.y),g.Normalize(),m.cf.indexA=0,m.cf.typeA=t.b2ContactFeatureType.e_face,e.pointCount=1,e.type=t.b2ManifoldType.e_faceA,e.localNormal.Copy(g),e.localPoint.Copy(a),e.points[0].id.Copy(m),e.points[0].localPoint.Copy(s.m_p)}var qi,Xi;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(qi||(qi={}));class Yi{constructor(){this.type=qi.e_unknown,this.index=0,this.separation=0}}class Ki{constructor(){this.vertices=[],this.normals=[],this.count=0}}class $i{constructor(){this.i1=0,this.i2=0,this.v1=new xt,this.v2=new xt,this.normal=new xt,this.sideNormal1=new xt,this.sideOffset1=0,this.sideNormal2=new xt,this.sideOffset2=0}}!function(t){t[t.e_isolated=0]="e_isolated",t[t.e_concave=1]="e_concave",t[t.e_convex=2]="e_convex"}(Xi||(Xi={}));class Ji{constructor(){this.m_polygonB=new Ki,this.m_xf=new wt,this.m_centroidB=new xt,this.m_v0=new xt,this.m_v1=new xt,this.m_v2=new xt,this.m_v3=new xt,this.m_normal0=new xt,this.m_normal1=new xt,this.m_normal2=new xt,this.m_normal=new xt,this.m_type1=Xi.e_isolated,this.m_type2=Xi.e_isolated,this.m_lowerLimit=new xt,this.m_upperLimit=new xt,this.m_radius=0,this.m_front=!1}Collide(e,i,n,s,r){wt.MulTXX(n,r,this.m_xf),wt.MulXV(this.m_xf,s.m_centroid,this.m_centroidB),this.m_v0.Copy(i.m_vertex0),this.m_v1.Copy(i.m_vertex1),this.m_v2.Copy(i.m_vertex2),this.m_v3.Copy(i.m_vertex3);const o=i.m_hasVertex0,l=i.m_hasVertex3,c=xt.SubVV(this.m_v2,this.m_v1,Ji.s_edge1);c.Normalize(),this.m_normal1.Set(c.y,-c.x);const h=xt.DotVV(this.m_normal1,xt.SubVV(this.m_centroidB,this.m_v1,xt.s_t0));let _=0,u=0,m=!1,p=!1;if(o){const t=xt.SubVV(this.m_v1,this.m_v0,Ji.s_edge0);t.Normalize(),this.m_normal0.Set(t.y,-t.x),m=xt.CrossVV(t,c)>=0,_=xt.DotVV(this.m_normal0,xt.SubVV(this.m_centroidB,this.m_v0,xt.s_t0))}if(l){const t=xt.SubVV(this.m_v3,this.m_v2,Ji.s_edge2);t.Normalize(),this.m_normal2.Set(t.y,-t.x),p=xt.CrossVV(c,t)>0,u=xt.DotVV(this.m_normal2,xt.SubVV(this.m_centroidB,this.m_v2,xt.s_t0))}o&&l?m&&p?(this.m_front=_>=0||h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):m?(this.m_front=_>=0||h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):p?(this.m_front=u>=0||_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):(this.m_front=_>=0&&h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):o?m?(this.m_front=_>=0||h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal0),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg())):(this.m_front=_>=0&&h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal0).SelfNeg())):l?p?(this.m_front=h>=0||u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal2)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0&&u>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1)):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal2).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1))):(this.m_front=h>=0,this.m_front?(this.m_normal.Copy(this.m_normal1),this.m_lowerLimit.Copy(this.m_normal1).SelfNeg(),this.m_upperLimit.Copy(this.m_normal1).SelfNeg()):(this.m_normal.Copy(this.m_normal1).SelfNeg(),this.m_lowerLimit.Copy(this.m_normal1),this.m_upperLimit.Copy(this.m_normal1))),this.m_polygonB.count=s.m_count;for(let t=0;t<s.m_count;++t)this.m_polygonB.vertices.length<=t&&this.m_polygonB.vertices.push(new xt),this.m_polygonB.normals.length<=t&&this.m_polygonB.normals.push(new xt),wt.MulXV(this.m_xf,s.m_vertices[t],this.m_polygonB.vertices[t]),Tt.MulRV(this.m_xf.q,s.m_normals[t],this.m_polygonB.normals[t]);this.m_radius=s.m_radius+i.m_radius,e.pointCount=0;const d=this.ComputeEdgeSeparation(Ji.s_edgeAxis);if(d.type===qi.e_unknown)return;if(d.separation>this.m_radius)return;const f=this.ComputePolygonSeparation(Ji.s_polygonAxis);if(f.type!==qi.e_unknown&&f.separation>this.m_radius)return;const g=.98,y=.001;let v;v=f.type===qi.e_unknown?d:f.separation>g*d.separation+y?f:d;const x=Ji.s_ie,b=Ji.s_rf;if(v.type===qi.e_edgeA){e.type=t.b2ManifoldType.e_faceA;let i=0,n=xt.DotVV(this.m_normal,this.m_polygonB.normals[0]);for(let t=1;t<this.m_polygonB.count;++t){const e=xt.DotVV(this.m_normal,this.m_polygonB.normals[t]);e<n&&(n=e,i=t)}const s=i,r=(s+1)%this.m_polygonB.count,o=x[0];o.v.Copy(this.m_polygonB.vertices[s]),o.id.cf.indexA=0,o.id.cf.indexB=s,o.id.cf.typeA=t.b2ContactFeatureType.e_face,o.id.cf.typeB=t.b2ContactFeatureType.e_vertex;const a=x[1];a.v.Copy(this.m_polygonB.vertices[r]),a.id.cf.indexA=0,a.id.cf.indexB=r,a.id.cf.typeA=t.b2ContactFeatureType.e_face,a.id.cf.typeB=t.b2ContactFeatureType.e_vertex,this.m_front?(b.i1=0,b.i2=1,b.v1.Copy(this.m_v1),b.v2.Copy(this.m_v2),b.normal.Copy(this.m_normal1)):(b.i1=1,b.i2=0,b.v1.Copy(this.m_v2),b.v2.Copy(this.m_v1),b.normal.Copy(this.m_normal1).SelfNeg())}else{e.type=t.b2ManifoldType.e_faceB;const i=x[0];i.v.Copy(this.m_v1),i.id.cf.indexA=0,i.id.cf.indexB=v.index,i.id.cf.typeA=t.b2ContactFeatureType.e_vertex,i.id.cf.typeB=t.b2ContactFeatureType.e_face;const n=x[1];n.v.Copy(this.m_v2),n.id.cf.indexA=0,n.id.cf.indexB=v.index,n.id.cf.typeA=t.b2ContactFeatureType.e_vertex,n.id.cf.typeB=t.b2ContactFeatureType.e_face,b.i1=v.index,b.i2=(b.i1+1)%this.m_polygonB.count,b.v1.Copy(this.m_polygonB.vertices[b.i1]),b.v2.Copy(this.m_polygonB.vertices[b.i2]),b.normal.Copy(this.m_polygonB.normals[b.i1])}b.sideNormal1.Set(b.normal.y,-b.normal.x),b.sideNormal2.Copy(b.sideNormal1).SelfNeg(),b.sideOffset1=xt.DotVV(b.sideNormal1,b.v1),b.sideOffset2=xt.DotVV(b.sideNormal2,b.v2);const S=Ji.s_clipPoints1,A=Ji.s_clipPoints2;let C=0;if(C=Ae(S,x,b.sideNormal1,b.sideOffset1,b.i1),C<a)return;if(C=Ae(A,S,b.sideNormal2,b.sideOffset2,b.i2),C<a)return;v.type===qi.e_edgeA?(e.localNormal.Copy(b.normal),e.localPoint.Copy(b.v1)):(e.localNormal.Copy(s.m_normals[b.i1]),e.localPoint.Copy(s.m_vertices[b.i1]));let T=0;for(let t=0;t<a;++t){let i;if(i=xt.DotVV(b.normal,xt.SubVV(A[t].v,b.v1,xt.s_t0)),i<=this.m_radius){const i=e.points[T];v.type===qi.e_edgeA?(wt.MulTXV(this.m_xf,A[t].v,i.localPoint),i.id.Copy(A[t].id)):(i.localPoint.Copy(A[t].v),i.id.cf.typeA=A[t].id.cf.typeB,i.id.cf.typeB=A[t].id.cf.typeA,i.id.cf.indexA=A[t].id.cf.indexB,i.id.cf.indexB=A[t].id.cf.indexA),++T}}e.pointCount=T}ComputeEdgeSeparation(t){const e=t;e.type=qi.e_edgeA,e.index=this.m_front?0:1,e.separation=n;for(let t=0;t<this.m_polygonB.count;++t){const i=xt.DotVV(this.m_normal,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0));i<e.separation&&(e.separation=i)}return e}ComputePolygonSeparation(t){const e=t;e.type=qi.e_unknown,e.index=-1,e.separation=-n;const i=Ji.s_perp.Set(-this.m_normal.y,this.m_normal.x);for(let t=0;t<this.m_polygonB.count;++t){const n=xt.NegV(this.m_polygonB.normals[t],Ji.s_n),s=tt(xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v1,xt.s_t0)),xt.DotVV(n,xt.SubVV(this.m_polygonB.vertices[t],this.m_v2,xt.s_t0)));if(s>this.m_radius)return e.type=qi.e_edgeB,e.index=t,e.separation=s,e;if(xt.DotVV(n,i)>=0){if(xt.DotVV(xt.SubVV(n,this.m_upperLimit,xt.s_t0),this.m_normal)<-u)continue}else if(xt.DotVV(xt.SubVV(n,this.m_lowerLimit,xt.s_t0),this.m_normal)<-u)continue;s>e.separation&&(e.type=qi.e_edgeB,e.index=t,e.separation=s)}return e}}Ji.s_edge1=new xt,Ji.s_edge0=new xt,Ji.s_edge2=new xt,Ji.s_ie=ye.MakeArray(2),Ji.s_rf=new $i,Ji.s_clipPoints1=ye.MakeArray(2),Ji.s_clipPoints2=ye.MakeArray(2),Ji.s_edgeAxis=new Yi,Ji.s_polygonAxis=new Yi,Ji.s_n=new xt,Ji.s_perp=new xt;const Zi=new Ji;function Qi(t,e,i,n,s){Zi.Collide(t,e,i,n,s)}class tn{constructor(){this.mass=0,this.center=new xt(0,0),this.I=0}}var en,nn,sn,rn;(en=t.b2ShapeType||(t.b2ShapeType={}))[en.e_unknown=-1]="e_unknown",en[en.e_circleShape=0]="e_circleShape",en[en.e_edgeShape=1]="e_edgeShape",en[en.e_polygonShape=2]="e_polygonShape",en[en.e_chainShape=3]="e_chainShape",en[en.e_shapeTypeCount=4]="e_shapeTypeCount";class on{constructor(e,i){this.m_type=t.b2ShapeType.e_unknown,this.m_radius=0,this.m_type=e,this.m_radius=i}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class an extends on{constructor(e=0){super(t.b2ShapeType.e_circleShape,e),this.m_p=new xt}Set(t,e=this.m_radius){return this.m_p.Copy(t),this.m_radius=e,this}Clone(){return(new an).Copy(this)}Copy(t){return super.Copy(t),this.m_p.Copy(t.m_p),this}GetChildCount(){return 1}TestPoint(t,e){const i=wt.MulXV(t,this.m_p,an.TestPoint_s_center),n=xt.SubVV(e,i,an.TestPoint_s_d);return xt.DotVV(n,n)<=rt(this.m_radius)}ComputeDistance(t,e,i,n){const s=wt.MulXV(t,this.m_p,an.ComputeDistance_s_center);return xt.SubVV(e,s,i),i.Normalize()-this.m_radius}RayCast(t,e,i,n){const r=wt.MulXV(i,this.m_p,an.RayCast_s_position),o=xt.SubVV(e.p1,r,an.RayCast_s_s),a=xt.DotVV(o,o)-rt(this.m_radius),l=xt.SubVV(e.p2,e.p1,an.RayCast_s_r),c=xt.DotVV(o,l),h=xt.DotVV(l,l),_=c*c-h*a;if(_<0||h<s)return!1;let u=-(c+at(_));return 0<=u&&u<=e.maxFraction*h&&(u/=h,t.fraction=u,xt.AddVMulSV(o,u,l,t.normal).SelfNormalize(),!0)}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_p,an.ComputeAABB_s_p);t.lowerBound.Set(n.x-this.m_radius,n.y-this.m_radius),t.upperBound.Set(n.x+this.m_radius,n.y+this.m_radius)}ComputeMass(t,e){const i=rt(this.m_radius);t.mass=e*o*i,t.center.Copy(this.m_p),t.I=t.mass*(.5*i+xt.DotVV(this.m_p,this.m_p))}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_p),t.m_count=1,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=wt.MulXV(i,this.m_p,new xt),a=-(xt.DotVV(t,r)-e);if(a<-this.m_radius+s)return 0;if(a>this.m_radius)return n.Copy(r),o*this.m_radius*this.m_radius;const l=this.m_radius*this.m_radius,c=a*a,h=l*(pt(a/this.m_radius)+o/2)+a*at(l-c),_=-2/3*lt(l-c,1.5)/h;return n.x=r.x+t.x*_,n.y=r.y+t.y*_,h}Dump(t){t("    const shape: b2CircleShape = new b2CircleShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_p.Set(%.15f, %.15f);\n",this.m_p.x,this.m_p.y)}}an.TestPoint_s_center=new xt,an.TestPoint_s_d=new xt,an.ComputeDistance_s_center=new xt,an.RayCast_s_position=new xt,an.RayCast_s_s=new xt,an.RayCast_s_r=new xt,an.ComputeAABB_s_p=new xt;class ln extends on{constructor(){super(t.b2ShapeType.e_polygonShape,m),this.m_centroid=new xt(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new ln).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._Set((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._Set((t=>e[t]),i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const n=[];for(let e=0;e<i;++e){const i=t(e);let s=!0;for(let t=0;t<n.length;++t)if(xt.DistanceSquaredVV(i,n[t])<.25*_*_){s=!1;break}s&&n.push(i)}if(i=n.length,i<3)return this.SetAsBox(1,1);let s=0,r=n[0].x;for(let t=1;t<i;++t){const e=n[t].x;(e>r||e===r&&n[t].y<n[s].y)&&(s=t,r=e)}const o=[];let a=0,l=s;for(;;){o[a]=l;let t=0;for(let e=1;e<i;++e){if(t===l){t=e;continue}const i=xt.SubVV(n[t],n[o[a]],ln.Set_s_r),s=xt.SubVV(n[e],n[o[a]],ln.Set_s_v),r=xt.CrossVV(i,s);r<0&&(t=e),0===r&&s.LengthSquared()>i.LengthSquared()&&(t=e)}if(++a,l=t,t===s)break}this.m_count=a,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count);for(let t=0;t<a;++t)this.m_vertices[t].Copy(n[o[t]]);for(let t=0;t<a;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%a],n=xt.SubVV(i,e,xt.s_t0);xt.CrossVOne(n,this.m_normals[t]).SelfNormalize()}return ln.ComputeCentroid(this.m_vertices,a,this.m_centroid),this}SetAsBox(t,e,i,n=0){if(this.m_count=4,this.m_vertices=xt.MakeArray(this.m_count),this.m_normals=xt.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const t=new wt;t.SetPosition(i),t.SetRotationAngle(n);for(let e=0;e<this.m_count;++e)wt.MulXV(t,this.m_vertices[e],this.m_vertices[e]),Tt.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=wt.MulTXV(t,e,ln.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t)if(xt.DotVV(this.m_normals[t],xt.SubVV(i,this.m_vertices[t],xt.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,s){const r=wt.MulTXV(t,e,ln.ComputeDistance_s_pLocal);let o=-n;const a=ln.ComputeDistance_s_normalForMaxDistance.Copy(r);for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(r,this.m_vertices[t],xt.s_t0));e>o&&(o=e,a.Copy(this.m_normals[t]))}if(o>0){const e=ln.ComputeDistance_s_minDistance.Copy(a);let n=o*o;for(let t=0;t<this.m_count;++t){const i=xt.SubVV(r,this.m_vertices[t],ln.ComputeDistance_s_distance),s=i.LengthSquared();n>s&&(e.Copy(i),n=s)}return Tt.MulRV(t.q,e,i),i.Normalize(),Math.sqrt(n)}return Tt.MulRV(t.q,a,i),o}RayCast(t,e,i,n){const s=wt.MulTXV(i,e.p1,ln.RayCast_s_p1),r=wt.MulTXV(i,e.p2,ln.RayCast_s_p2),o=xt.SubVV(r,s,ln.RayCast_s_d);let a=0,l=e.maxFraction,c=-1;for(let t=0;t<this.m_count;++t){const e=xt.DotVV(this.m_normals[t],xt.SubVV(this.m_vertices[t],s,xt.s_t0)),i=xt.DotVV(this.m_normals[t],o);if(0===i){if(e<0)return!1}else i<0&&e<a*i?(a=e/i,c=t):i>0&&e<l*i&&(l=e/i);if(l<a)return!1}return c>=0&&(t.fraction=a,Tt.MulRV(i.q,this.m_normals[c],t.normal),!0)}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_vertices[0],t.lowerBound),s=t.upperBound.Copy(n);for(let t=0;t<this.m_count;++t){const i=wt.MulXV(e,this.m_vertices[t],ln.ComputeAABB_s_v);xt.MinV(i,n,n),xt.MaxV(i,s,s)}const r=this.m_radius;n.SelfSubXY(r,r),s.SelfAddXY(r,r)}ComputeMass(t,e){const i=ln.ComputeMass_s_center.SetZero();let n=0,s=0;const r=ln.ComputeMass_s_s.SetZero();for(let t=0;t<this.m_count;++t)r.SelfAdd(this.m_vertices[t]);r.SelfMul(1/this.m_count);const o=1/3;for(let t=0;t<this.m_count;++t){const e=xt.SubVV(this.m_vertices[t],r,ln.ComputeMass_s_e1),a=xt.SubVV(this.m_vertices[(t+1)%this.m_count],r,ln.ComputeMass_s_e2),l=xt.CrossVV(e,a),c=.5*l;n+=c,i.SelfAdd(xt.MulSV(c*o,xt.AddVV(e,a,xt.s_t0),xt.s_t1));const h=e.x,_=e.y,u=a.x,m=a.y;s+=.25*o*l*(h*h+u*h+u*u+_*_+m*_+m*m)}t.mass=e*n,i.SelfMul(1/n),xt.AddVV(i,r,t.center),t.I=e*s,t.I+=t.mass*(xt.DotVV(t.center,t.center)-xt.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,n=this.m_vertices[e],s=xt.SubVV(this.m_vertices[i],n,ln.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const r=xt.SubVV(this.m_vertices[t],n,ln.Validate_s_v);if(xt.CrossVV(s,r)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){const r=Tt.MulTRV(i.q,t,ln.ComputeSubmergedArea_s_normalL),o=e-xt.DotVV(t,i.p),a=[];let l=0,c=-1,h=-1,_=!1;for(let t=0;t<this.m_count;++t){a[t]=xt.DotVV(r,this.m_vertices[t])-o;const e=a[t]<-s;t>0&&(e?_||(c=t-1,l++):_&&(h=t-1,l++)),_=e}switch(l){case 0:if(_){const t=ln.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),wt.MulXV(i,t.center,n),t.mass}return 0;case 1:-1===c?c=this.m_count-1:h=this.m_count-1}const u=(c+1)%this.m_count,m=(h+1)%this.m_count,p=(0-a[c])/(a[u]-a[c]),d=(0-a[h])/(a[m]-a[h]),f=ln.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[c].x*(1-p)+this.m_vertices[u].x*p,this.m_vertices[c].y*(1-p)+this.m_vertices[u].y*p),g=ln.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[h].x*(1-d)+this.m_vertices[m].x*d,this.m_vertices[h].y*(1-d)+this.m_vertices[m].y*d);let y=0;const v=ln.ComputeSubmergedArea_s_center.SetZero();let x,b=this.m_vertices[u],S=u;for(;S!==m;){S=(S+1)%this.m_count,x=S===m?g:this.m_vertices[S];const t=.5*((b.x-f.x)*(x.y-f.y)-(b.y-f.y)*(x.x-f.x));y+=t,v.x+=t*(f.x+b.x+x.x)/3,v.y+=t*(f.y+b.y+x.y)/3,b=x}return v.SelfMul(1/y),wt.MulXV(i,v,n),y}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const n=i;n.SetZero();let s=0;const r=ln.ComputeCentroid_s_pRef.SetZero(),o=1/3;for(let i=0;i<e;++i){const a=r,l=t[i],c=t[(i+1)%e],h=xt.SubVV(l,a,ln.ComputeCentroid_s_e1),_=xt.SubVV(c,a,ln.ComputeCentroid_s_e2),u=.5*xt.CrossVV(h,_);s+=u,n.x+=u*o*(a.x+l.x+c.x),n.y+=u*o*(a.y+l.y+c.y)}return n.SelfMul(1/s),n}}ln.Set_s_r=new xt,ln.Set_s_v=new xt,ln.TestPoint_s_pLocal=new xt,ln.ComputeDistance_s_pLocal=new xt,ln.ComputeDistance_s_normalForMaxDistance=new xt,ln.ComputeDistance_s_minDistance=new xt,ln.ComputeDistance_s_distance=new xt,ln.RayCast_s_p1=new xt,ln.RayCast_s_p2=new xt,ln.RayCast_s_d=new xt,ln.ComputeAABB_s_v=new xt,ln.ComputeMass_s_center=new xt,ln.ComputeMass_s_s=new xt,ln.ComputeMass_s_e1=new xt,ln.ComputeMass_s_e2=new xt,ln.Validate_s_e=new xt,ln.Validate_s_v=new xt,ln.ComputeSubmergedArea_s_normalL=new xt,ln.ComputeSubmergedArea_s_md=new tn,ln.ComputeSubmergedArea_s_intoVec=new xt,ln.ComputeSubmergedArea_s_outoVec=new xt,ln.ComputeSubmergedArea_s_center=new xt,ln.ComputeCentroid_s_pRef=new xt,ln.ComputeCentroid_s_e1=new xt,ln.ComputeCentroid_s_e2=new xt;class cn extends on{constructor(){super(t.b2ShapeType.e_edgeShape,m),this.m_vertex1=new xt,this.m_vertex2=new xt,this.m_vertex0=new xt,this.m_vertex3=new xt,this.m_hasVertex0=!1,this.m_hasVertex3=!1}Set(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_hasVertex0=!1,this.m_hasVertex3=!1,this}Clone(){return(new cn).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_hasVertex0=t.m_hasVertex0,this.m_hasVertex3=t.m_hasVertex3,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=wt.MulXV(t,this.m_vertex1,cn.ComputeDistance_s_v1),r=wt.MulXV(t,this.m_vertex2,cn.ComputeDistance_s_v2),o=xt.SubVV(e,s,cn.ComputeDistance_s_d),a=xt.SubVV(r,s,cn.ComputeDistance_s_s),l=xt.DotVV(o,a);if(l>0){const t=xt.DotVV(a,a);l>t?xt.SubVV(e,r,o):o.SelfMulSub(l/t,a)}return i.Copy(o),i.Normalize()}RayCast(t,e,i,n){const s=wt.MulTXV(i,e.p1,cn.RayCast_s_p1),r=wt.MulTXV(i,e.p2,cn.RayCast_s_p2),o=xt.SubVV(r,s,cn.RayCast_s_d),a=this.m_vertex1,l=this.m_vertex2,c=xt.SubVV(l,a,cn.RayCast_s_e),h=t.normal.Set(c.y,-c.x).SelfNormalize(),_=xt.DotVV(h,xt.SubVV(a,s,xt.s_t0)),u=xt.DotVV(h,o);if(0===u)return!1;const m=_/u;if(m<0||e.maxFraction<m)return!1;const p=xt.AddVMulSV(s,m,o,cn.RayCast_s_q),d=xt.SubVV(l,a,cn.RayCast_s_r),f=xt.DotVV(d,d);if(0===f)return!1;const g=xt.DotVV(xt.SubVV(p,a,xt.s_t0),d)/f;return!(g<0||1<g||(t.fraction=m,Tt.MulRV(i.q,t.normal,t.normal),_>0&&t.normal.SelfNeg(),0))}ComputeAABB(t,e,i){const n=wt.MulXV(e,this.m_vertex1,cn.ComputeAABB_s_v1),s=wt.MulXV(e,this.m_vertex2,cn.ComputeAABB_s_v2);xt.MinV(n,s,t.lowerBound),xt.MaxV(n,s,t.upperBound);const r=this.m_radius;t.lowerBound.SelfSubXY(r,r),t.upperBound.SelfAddXY(r,r)}ComputeMass(t,e){t.mass=0,xt.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_hasVertex0 = %s;\n",this.m_hasVertex0),t("    shape.m_hasVertex3 = %s;\n",this.m_hasVertex3)}}cn.ComputeDistance_s_v1=new xt,cn.ComputeDistance_s_v2=new xt,cn.ComputeDistance_s_d=new xt,cn.ComputeDistance_s_s=new xt,cn.RayCast_s_p1=new xt,cn.RayCast_s_p2=new xt,cn.RayCast_s_d=new xt,cn.RayCast_s_e=new xt,cn.RayCast_s_q=new xt,cn.RayCast_s_r=new xt,cn.ComputeAABB_s_v1=new xt,cn.ComputeAABB_s_v2=new xt;class hn extends on{constructor(){super(t.b2ShapeType.e_chainShape,m),this.m_vertices=[],this.m_count=0,this.m_prevVertex=new xt,this.m_nextVertex=new xt,this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1}CreateLoop(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateLoop((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateLoop((t=>e[t]),i)}}_CreateLoop(t,e){if(e<3)return this;this.m_count=e+1,this.m_vertices=xt.MakeArray(this.m_count);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_vertices[e].Copy(this.m_vertices[0]),this.m_prevVertex.Copy(this.m_vertices[this.m_count-2]),this.m_nextVertex.Copy(this.m_vertices[1]),this.m_hasPrevVertex=!0,this.m_hasNextVertex=!0,this}CreateChain(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._CreateChain((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._CreateChain((t=>e[t]),i)}}_CreateChain(t,e){this.m_count=e,this.m_vertices=xt.MakeArray(e);for(let i=0;i<e;++i)this.m_vertices[i].Copy(t(i));return this.m_hasPrevVertex=!1,this.m_hasNextVertex=!1,this.m_prevVertex.SetZero(),this.m_nextVertex.SetZero(),this}SetPrevVertex(t){return this.m_prevVertex.Copy(t),this.m_hasPrevVertex=!0,this}SetNextVertex(t){return this.m_nextVertex.Copy(t),this.m_hasNextVertex=!0,this}Clone(){return(new hn).Copy(this)}Copy(t){return super.Copy(t),this._CreateChain((e=>t.m_vertices[e]),t.m_count),this.m_prevVertex.Copy(t.m_prevVertex),this.m_nextVertex.Copy(t.m_nextVertex),this.m_hasPrevVertex=t.m_hasPrevVertex,this.m_hasNextVertex=t.m_hasNextVertex,this}GetChildCount(){return this.m_count-1}GetChildEdge(t,e){t.m_radius=this.m_radius,t.m_vertex1.Copy(this.m_vertices[e]),t.m_vertex2.Copy(this.m_vertices[e+1]),e>0?(t.m_vertex0.Copy(this.m_vertices[e-1]),t.m_hasVertex0=!0):(t.m_vertex0.Copy(this.m_prevVertex),t.m_hasVertex0=this.m_hasPrevVertex),e<this.m_count-2?(t.m_vertex3.Copy(this.m_vertices[e+2]),t.m_hasVertex3=!0):(t.m_vertex3.Copy(this.m_nextVertex),t.m_hasVertex3=this.m_hasNextVertex)}TestPoint(t,e){return!1}ComputeDistance(t,e,i,n){const s=hn.ComputeDistance_s_edgeShape;return this.GetChildEdge(s,n),s.ComputeDistance(t,e,i,0)}RayCast(t,e,i,n){const s=hn.RayCast_s_edgeShape;return s.m_vertex1.Copy(this.m_vertices[n]),s.m_vertex2.Copy(this.m_vertices[(n+1)%this.m_count]),s.RayCast(t,e,i,0)}ComputeAABB(t,e,i){const n=this.m_vertices[i],s=this.m_vertices[(i+1)%this.m_count],r=wt.MulXV(e,n,hn.ComputeAABB_s_v1),o=wt.MulXV(e,s,hn.ComputeAABB_s_v2);xt.MinV(r,o,t.lowerBound),xt.MaxV(r,o,t.upperBound)}ComputeMass(t,e){t.mass=0,t.center.SetZero(),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertices[e]),e+1<this.m_count?t.m_vertices[1].Copy(this.m_vertices[e+1]):t.m_vertices[1].Copy(this.m_vertices[0]),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,n){return n.SetZero(),0}Dump(t){t("    const shape: b2ChainShape = new b2ChainShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new bVec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.CreateChain(vs, %d);\n",this.m_count),t("    shape.m_prevVertex.Set(%.15f, %.15f);\n",this.m_prevVertex.x,this.m_prevVertex.y),t("    shape.m_nextVertex.Set(%.15f, %.15f);\n",this.m_nextVertex.x,this.m_nextVertex.y),t("    shape.m_hasPrevVertex = %s;\n",this.m_hasPrevVertex?"true":"false"),t("    shape.m_hasNextVertex = %s;\n",this.m_hasNextVertex?"true":"false")}}hn.ComputeDistance_s_edgeShape=new cn,hn.RayCast_s_edgeShape=new cn,hn.ComputeAABB_s_v1=new xt,hn.ComputeAABB_s_v2=new xt;class _n{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new _n).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}_n.DEFAULT=new _n;class un{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.density=0,this.isSensor=!1,this.filter=new _n}}class mn{constructor(t,e){this.aabb=new be,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e,i){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i);else{const n=mn.Synchronize_s_aabb1,s=mn.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(n,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(n,s),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,i)}}}mn.Synchronize_s_aabb1=new be,mn.Synchronize_s_aabb2=new be;class pn{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_proxies=[],this.m_filter=new _n,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=i(e.userData,null),this.m_friction=i(e.friction,.2),this.m_restitution=i(e.restitution,0),this.m_filter.Copy(i(e.filter,_n.DEFAULT)),this.m_isSensor=i(e.isSensor,!1),this.m_density=i(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),n=e.GetFixtureB();i!==this&&n!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new tn){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}CreateProxies(){if(0!==this.m_proxies.length)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new mn(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e,i){for(const n of this.m_proxies)n.Synchronize(t,e,i)}}(nn=t.b2BodyType||(t.b2BodyType={}))[nn.b2_unknown=-1]="b2_unknown",nn[nn.b2_staticBody=0]="b2_staticBody",nn[nn.b2_kinematicBody=1]="b2_kinematicBody",nn[nn.b2_dynamicBody=2]="b2_dynamicBody";class dn{constructor(){this.type=t.b2BodyType.b2_staticBody,this.position=new xt(0,0),this.angle=0,this.linearVelocity=new xt(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.active=!0,this.userData=null,this.gravityScale=1}}class fn{constructor(e,n){this.m_type=t.b2BodyType.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_activeFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new wt,this.m_xf0=new wt,this.m_sweep=new Et,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_force=new xt,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=i(e.bullet,!1),this.m_fixedRotationFlag=i(e.fixedRotation,!1),this.m_autoSleepFlag=i(e.allowSleep,!0),this.m_awakeFlag=i(e.awake,!0),this.m_activeFlag=i(e.active,!0),this.m_world=n,this.m_xf.p.Copy(i(e.position,xt.ZERO)),this.m_xf.q.SetAngle(i(e.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(i(e.linearVelocity,xt.ZERO)),this.m_angularVelocity=i(e.angularVelocity,0),this.m_linearDamping=i(e.linearDamping,0),this.m_angularDamping=i(e.angularDamping,0),this.m_gravityScale=i(e.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=i(e.type,t.b2BodyType.b2_staticBody),e.type===t.b2BodyType.b2_dynamicBody?(this.m_mass=1,this.m_invMass=1):(this.m_mass=0,this.m_invMass=0),this.m_I=0,this.m_invI=0,this.m_userData=e.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof on?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new pn(this,t);return this.m_activeFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newFixture=!0,e}CreateFixtureShapeDensity(t,e=0){const i=fn.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let n=this.m_contactList;for(;n;){const e=n.contact;n=n.next;const i=e.GetFixtureA(),s=e.GetFixtureB();t!==i&&t!==s||this.m_world.m_contactManager.Destroy(e)}this.m_activeFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf,xt.ZERO);this.m_world.m_contactManager.FindNewContacts()}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(xt.DotVV(e,e)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(e))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(e){this.m_type!==t.b2BodyType.b2_staticBody&&(e*e>0&&this.SetAwake(!0),this.m_angularVelocity=e)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y,this.m_torque+=(i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x))}ApplyForceToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=e.x,this.m_force.y+=e.y))}ApplyTorque(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=e))}ApplyLinearImpulse(e,i,n=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(n&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y,this.m_angularVelocity+=this.m_invI*((i.x-this.m_sweep.c.x)*e.y-(i.y-this.m_sweep.c.y)*e.x)))}ApplyLinearImpulseToCenter(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*e.x,this.m_linearVelocity.y+=this.m_invMass*e.y))}ApplyAngularImpulse(e,i=!0){this.m_type===t.b2BodyType.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*e))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*xt.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==t.b2BodyType.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=e.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,e.I>0&&!this.m_fixedRotationFlag&&(this.m_I=e.I-this.m_mass*xt.DotVV(e.center,e.center),this.m_invI=1/this.m_I);const i=fn.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e.center),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===t.b2BodyType.b2_staticBody||this.m_type===t.b2BodyType.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const e=fn.ResetMassData_s_localCenter.SetZero();for(let t=this.m_fixtureList;t;t=t.m_next){if(0===t.m_density)continue;const i=t.GetMassData(fn.ResetMassData_s_massData);this.m_mass+=i.mass,e.x+=i.center.x*i.mass,e.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,e.x*=this.m_invMass,e.y*=this.m_invMass):(this.m_mass=1,this.m_invMass=1),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*xt.DotVV(e,e),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const i=fn.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(e),wt.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(this.m_sweep.c,i,xt.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return wt.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return Tt.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return wt.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return Tt.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_sweep.c,xt.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(e){if(this.m_world.IsLocked())throw new Error;if(this.m_type===e)return;this.m_type=e,this.ResetMassData(),this.m_type===t.b2BodyType.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let i=this.m_contactList;for(;i;){const t=i;i=i.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;for(let t=this.m_fixtureList;t;t=t.m_next)t.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)}IsAwake(){return this.m_awakeFlag}SetActive(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsActive())if(this.m_activeFlag=t,t)for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies();let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsActive(){return this.m_activeFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(e){const i=this.m_islandIndex;e("{\n"),e("  const bd: b2BodyDef = new b2BodyDef();\n");let n="";switch(this.m_type){case t.b2BodyType.b2_staticBody:n="b2BodyType.b2_staticBody";break;case t.b2BodyType.b2_kinematicBody:n="b2BodyType.b2_kinematicBody";break;case t.b2BodyType.b2_dynamicBody:n="b2BodyType.b2_dynamicBody"}e("  bd.type = %s;\n",n),e("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),e("  bd.angle = %.15f;\n",this.m_sweep.a),e("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),e("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),e("  bd.linearDamping = %.15f;\n",this.m_linearDamping),e("  bd.angularDamping = %.15f;\n",this.m_angularDamping),e("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),e("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),e("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),e("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),e("  bd.active = %s;\n",this.m_activeFlag?"true":"false"),e("  bd.gravityScale = %.15f;\n",this.m_gravityScale),e("\n"),e("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),e("\n");for(let t=this.m_fixtureList;t;t=t.m_next)e("  {\n"),t.Dump(e,i),e("  }\n");e("}\n")}SynchronizeFixtures(){const t=fn.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Tt.MulRV(t.q,this.m_sweep.localCenter,t.p),xt.SubVV(this.m_sweep.c0,t.p,t.p);const e=xt.SubVV(this.m_sweep.c,this.m_sweep.c0,fn.SynchronizeFixtures_s_displacement);for(let i=this.m_fixtureList;i;i=i.m_next)i.SynchronizeProxies(t,this.m_xf,e)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(e){return(this.m_type!==t.b2BodyType.b2_staticBody||e.m_type!==t.b2BodyType.b2_staticBody)&&this.ShouldCollideConnected(e)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Tt.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),xt.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}fn.CreateFixtureShapeDensity_s_def=new un,fn.SetMassData_s_oldCenter=new xt,fn.ResetMassData_s_localCenter=new xt,fn.ResetMassData_s_oldCenter=new xt,fn.ResetMassData_s_massData=new tn,fn.SynchronizeFixtures_s_xf1=new wt,fn.SynchronizeFixtures_s_displacement=new xt,(rn=t.b2JointType||(t.b2JointType={}))[rn.e_unknownJoint=0]="e_unknownJoint",rn[rn.e_revoluteJoint=1]="e_revoluteJoint",rn[rn.e_prismaticJoint=2]="e_prismaticJoint",rn[rn.e_distanceJoint=3]="e_distanceJoint",rn[rn.e_pulleyJoint=4]="e_pulleyJoint",rn[rn.e_mouseJoint=5]="e_mouseJoint",rn[rn.e_gearJoint=6]="e_gearJoint",rn[rn.e_wheelJoint=7]="e_wheelJoint",rn[rn.e_weldJoint=8]="e_weldJoint",rn[rn.e_frictionJoint=9]="e_frictionJoint",rn[rn.e_ropeJoint=10]="e_ropeJoint",rn[rn.e_motorJoint=11]="e_motorJoint",rn[rn.e_areaJoint=12]="e_areaJoint",(sn=t.b2LimitState||(t.b2LimitState={}))[sn.e_inactiveLimit=0]="e_inactiveLimit",sn[sn.e_atLowerLimit=1]="e_atLowerLimit",sn[sn.e_atUpperLimit=2]="e_atUpperLimit",sn[sn.e_equalLimits=3]="e_equalLimits";class gn{constructor(){this.linear=new xt,this.angularA=0,this.angularB=0}SetZero(){return this.linear.SetZero(),this.angularA=0,this.angularB=0,this}Set(t,e,i){return this.linear.Copy(t),this.angularA=e,this.angularB=i,this}}class yn{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class vn{constructor(e){this.type=t.b2JointType.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=e}}class xn{constructor(e){this.m_type=t.b2JointType.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new yn(this),this.m_edgeB=new yn(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=e.type,this.m_edgeA.other=e.bodyB,this.m_edgeB.other=e.bodyA,this.m_bodyA=e.bodyA,this.m_bodyB=e.bodyB,this.m_collideConnected=i(e.collideConnected,!1),this.m_userData=i(e.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsActive(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}}class bn extends vn{constructor(){super(t.b2JointType.e_distanceJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.length=1,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(n,this.localAnchorB),this.length=xt.DistanceVV(i,n),this.frequencyHz=0,this.dampingRatio=0}}class Sn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_gamma=0,this.m_impulse=0,this.m_length=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_length=t.length}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_u.x,e.y=t*this.m_impulse*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){this.m_length=t}Length(){return this.m_length}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,a=t.positions[this.m_indexB].a,l=t.velocities[this.m_indexB].v;let c=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(i),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.x=r.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=r.y+this.m_rB.y-e.y-this.m_rA.y;const m=this.m_u.Length();m>_?this.m_u.SelfMul(1/m):this.m_u.SetZero();const p=xt.CrossVV(this.m_rA,this.m_u),d=xt.CrossVV(this.m_rB,this.m_u);let f=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=0!==f?1/f:0,this.m_frequencyHz>0){const e=m-this.m_length,i=2*o*this.m_frequencyHz,n=2*this.m_mass*this.m_dampingRatio*i,s=this.m_mass*i*i,r=t.step.dt;this.m_gamma=r*(n+r*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*r*s*this.m_gamma,f+=this.m_gamma,this.m_mass=0!==f?1/f:0}else this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(this.m_impulse,this.m_u,Sn.InitVelocityConstraints_s_P);n.SelfMulSub(this.m_invMassA,e),s-=this.m_invIA*xt.CrossVV(this.m_rA,e),l.SelfMulAdd(this.m_invMassB,e),c+=this.m_invIB*xt.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Sn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Sn.SolveVelocityConstraints_s_vpB),a=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0)),l=-this.m_mass*(a+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=l;const c=xt.MulSV(l,this.m_u,Sn.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*xt.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,c),s+=this.m_invIB*xt.CrossVV(this.m_rB,c),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){if(this.m_frequencyHz>0)return!0;const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=Tt.MulRV(r,this.m_lalcA,this.m_rA),l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_u;c.x=n.x+l.x-e.x-a.x,c.y=n.y+l.y-e.y-a.y;let h=this.m_u.Normalize()-this.m_length;h=it(h,-g,g);const u=-this.m_mass*h,m=xt.MulSV(u,c,Sn.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,m),i-=this.m_invIA*xt.CrossVV(a,m),n.SelfMulAdd(this.m_invMassB,m),s+=this.m_invIB*xt.CrossVV(l,m),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(h)<_}}Sn.InitVelocityConstraints_s_P=new xt,Sn.SolveVelocityConstraints_s_vpA=new xt,Sn.SolveVelocityConstraints_s_vpB=new xt,Sn.SolveVelocityConstraints_s_P=new xt,Sn.SolvePositionConstraints_s_P=new xt;class An extends vn{constructor(){super(t.b2JointType.e_areaJoint),this.bodies=[],this.frequencyHz=0,this.dampingRatio=0}AddBody(t){this.bodies.push(t),1===this.bodies.length?this.bodyA=t:2===this.bodies.length&&(this.bodyB=t)}}class Cn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new xt,this.m_bodies=t.bodies,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_targetLengths=K(t.bodies.length),this.m_normals=xt.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=xt.MakeArray(t.bodies.length);const e=new bn;e.frequencyHz=this.m_frequencyHz,e.dampingRatio=this.m_dampingRatio,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const i=this.m_bodies[t],n=this.m_bodies[(t+1)%this.m_bodies.length],s=i.GetWorldCenter(),r=n.GetWorldCenter();this.m_targetLengths[t]=xt.DistanceVV(s,r),this.m_targetArea+=xt.CrossVV(s,r),e.Initialize(i,n,s,r),this.m_joints[t]=i.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetFrequency(t){this.m_frequencyHz=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetFrequency(t)}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDampingRatio(t)}GetDampingRatio(){return this.m_dampingRatio}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],n=this.m_bodies[(e+1)%this.m_bodies.length],s=t.positions[i.m_islandIndex].c,r=t.positions[n.m_islandIndex].c,o=this.m_deltas[e];xt.SubVV(r,s,o)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.velocities[i.m_islandIndex].v,s=this.m_deltas[e];n.x+=i.m_invMass*s.y*.5*this.m_impulse,n.y+=i.m_invMass*-s.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const s=this.m_bodies[n],r=t.velocities[s.m_islandIndex].v,o=this.m_deltas[n];e+=o.LengthSquared()/s.GetMass(),i+=xt.CrossVV(r,o)}const n=-2*i/e;this.m_impulse+=n;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,r=this.m_deltas[e];s.x+=i.m_invMass*r.y*.5*n,s.y+=i.m_invMass*-r.x*.5*n}}SolvePositionConstraints(t){let e=0,i=0;for(let n=0;n<this.m_bodies.length;++n){const r=this.m_bodies[n],o=this.m_bodies[(n+1)%this.m_bodies.length],a=t.positions[r.m_islandIndex].c,l=t.positions[o.m_islandIndex].c,c=xt.SubVV(l,a,this.m_delta);let h=c.Length();h<s&&(h=1),this.m_normals[n].x=c.y/h,this.m_normals[n].y=-c.x/h,e+=h,i+=xt.CrossVV(a,l)}i*=.5;const n=.5*(this.m_targetArea-i)/e;let r=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.positions[i.m_islandIndex].c,o=(e+1)%this.m_bodies.length,a=xt.AddVV(this.m_normals[e],this.m_normals[o],this.m_delta);a.SelfMul(n);const l=a.LengthSquared();l>rt(g)&&a.SelfMul(g/at(l)),l>rt(_)&&(r=!1),s.x+=a.x,s.y+=a.y}return r}}class Tn extends vn{constructor(){super(t.b2JointType.e_frictionJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.maxForce=0,this.maxTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB)}}class wn extends xn{constructor(t){super(t),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new At,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new At,this.m_localAnchorA.Copy(t.localAnchorA),this.m_localAnchorB.Copy(t.localAnchorB),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const a=this.m_qA.SetAngle(e),l=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const c=Tt.MulRV(a,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=Tt.MulRV(l,this.m_lalcB,this.m_rB),_=this.m_invMassA,u=this.m_invMassB,m=this.m_invIA,p=this.m_invIB,d=this.m_K;if(d.ex.x=_+u+m*c.y*c.y+p*h.y*h.y,d.ex.y=-m*c.x*c.y-p*h.x*h.y,d.ey.x=d.ex.y,d.ey.y=_+u+m*c.x*c.x+p*h.x*h.x,d.GetInverse(this.m_linearMass),this.m_angularMass=m+p,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(_,e),n-=m*(xt.CrossVV(this.m_rA,e)+this.m_angularImpulse),r.SelfMulAdd(u,e),o+=p*(xt.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB,c=t.step.dt;{const t=s-i;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=c*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=l*e}{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),wn.SolveVelocityConstraints_s_Cdot_v2),h=At.MulMV(this.m_linearMass,t,wn.SolveVelocityConstraints_s_impulseV).SelfNeg(),_=wn.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(h);const u=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),xt.SubVV(this.m_linearImpulse,_,h),e.SelfMulSub(r,h),i-=a*xt.CrossVV(this.m_rA,h),n.SelfMulAdd(o,h),s+=l*xt.CrossVV(this.m_rB,h)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}wn.SolveVelocityConstraints_s_Cdot_v2=new xt,wn.SolveVelocityConstraints_s_impulseV=new xt,wn.SolveVelocityConstraints_s_oldImpulseV=new xt;class En extends vn{constructor(){super(t.b2JointType.e_gearJoint),this.ratio=1}}class Pn extends xn{constructor(e){let n,s;super(e),this.m_typeA=t.b2JointType.e_unknownJoint,this.m_typeB=t.b2JointType.e_unknownJoint,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localAnchorC=new xt,this.m_localAnchorD=new xt,this.m_localAxisC=new xt,this.m_localAxisD=new xt,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new xt,this.m_lcB=new xt,this.m_lcC=new xt,this.m_lcD=new xt,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new xt,this.m_JvBD=new xt,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_qC=new Tt,this.m_qD=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_lalcC=new xt,this.m_lalcD=new xt,this.m_joint1=e.joint1,this.m_joint2=e.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const r=this.m_bodyA.m_xf,o=this.m_bodyA.m_sweep.a,a=this.m_bodyC.m_xf,l=this.m_bodyC.m_sweep.a;if(this.m_typeA===t.b2JointType.e_revoluteJoint){const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.SetZero(),n=o-l-this.m_referenceAngleA}else{const t=e.joint1;this.m_localAnchorC.Copy(t.m_localAnchorA),this.m_localAnchorA.Copy(t.m_localAnchorB),this.m_referenceAngleA=t.m_referenceAngle,this.m_localAxisC.Copy(t.m_localXAxisA);const i=this.m_localAnchorC,s=Tt.MulTRV(a.q,xt.AddVV(Tt.MulRV(r.q,this.m_localAnchorA,xt.s_t0),xt.SubVV(r.p,a.p,xt.s_t1),xt.s_t0),xt.s_t0);n=xt.DotVV(xt.SubVV(s,i,xt.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const c=this.m_bodyB.m_xf,h=this.m_bodyB.m_sweep.a,_=this.m_bodyD.m_xf,u=this.m_bodyD.m_sweep.a;if(this.m_typeB===t.b2JointType.e_revoluteJoint){const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.SetZero(),s=h-u-this.m_referenceAngleB}else{const t=e.joint2;this.m_localAnchorD.Copy(t.m_localAnchorA),this.m_localAnchorB.Copy(t.m_localAnchorB),this.m_referenceAngleB=t.m_referenceAngle,this.m_localAxisD.Copy(t.m_localXAxisA);const i=this.m_localAnchorD,n=Tt.MulTRV(_.q,xt.AddVV(Tt.MulRV(c.q,this.m_localAnchorB,xt.s_t0),xt.SubVV(c.p,_.p,xt.s_t1),xt.s_t0),xt.s_t0);s=xt.DotVV(xt.SubVV(n,i,xt.s_t0),this.m_localAxisD)}this.m_ratio=i(e.ratio,1),this.m_constant=n+this.m_ratio*s,this.m_impulse=0}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const l=e.positions[this.m_indexC].a,c=e.velocities[this.m_indexC].v;let h=e.velocities[this.m_indexC].w;const _=e.positions[this.m_indexD].a,u=e.velocities[this.m_indexD].v;let m=e.velocities[this.m_indexD].w;const p=this.m_qA.SetAngle(i),d=this.m_qB.SetAngle(r),f=this.m_qC.SetAngle(l),g=this.m_qD.SetAngle(_);if(this.m_mass=0,this.m_typeA===t.b2JointType.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=Tt.MulRV(f,this.m_localAxisC,Pn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=Tt.MulRV(f,this.m_lalcC,Pn.InitVelocityConstraints_s_rC);xt.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=Tt.MulRV(p,this.m_lalcA,Pn.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=xt.CrossVV(e,t),this.m_JwA=xt.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===t.b2JointType.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=Tt.MulRV(g,this.m_localAxisD,Pn.InitVelocityConstraints_s_u);xt.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=Tt.MulRV(g,this.m_lalcD,Pn.InitVelocityConstraints_s_rD);xt.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=Tt.MulRV(d,this.m_lalcB,Pn.InitVelocityConstraints_s_rB);xt.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*xt.CrossVV(e,t),this.m_JwB=this.m_ratio*xt.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,e.step.warmStarting?(n.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,o.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),a+=this.m_iB*this.m_impulse*this.m_JwB,c.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),h-=this.m_iC*this.m_impulse*this.m_JwC,u.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),m-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a,e.velocities[this.m_indexC].w=h,e.velocities[this.m_indexD].w=m}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=t.velocities[this.m_indexC].v;let o=t.velocities[this.m_indexC].w;const a=t.velocities[this.m_indexD].v;let l=t.velocities[this.m_indexD].w,c=xt.DotVV(this.m_JvAC,xt.SubVV(e,r,xt.s_t0))+xt.DotVV(this.m_JvBD,xt.SubVV(n,a,xt.s_t0));c+=this.m_JwA*i-this.m_JwC*o+(this.m_JwB*s-this.m_JwD*l);const h=-this.m_mass*c;this.m_impulse+=h,e.SelfMulAdd(this.m_mA*h,this.m_JvAC),i+=this.m_iA*h*this.m_JwA,n.SelfMulAdd(this.m_mB*h,this.m_JvBD),s+=this.m_iB*h*this.m_JwB,r.SelfMulSub(this.m_mC*h,this.m_JvAC),o-=this.m_iC*h*this.m_JwC,a.SelfMulSub(this.m_mD*h,this.m_JvBD),l-=this.m_iD*h*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s,t.velocities[this.m_indexC].w=o,t.velocities[this.m_indexD].w=l}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=e.positions[this.m_indexC].c;let a=e.positions[this.m_indexC].a;const l=e.positions[this.m_indexD].c;let c=e.positions[this.m_indexD].a;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(r),m=this.m_qC.SetAngle(a),p=this.m_qD.SetAngle(c),d=0;let f,g;const y=this.m_JvAC,v=this.m_JvBD;let x,b,S,A,C=0;if(this.m_typeA===t.b2JointType.e_revoluteJoint)y.SetZero(),x=1,S=1,C+=this.m_iA+this.m_iC,f=n-a-this.m_referenceAngleA;else{const t=Tt.MulRV(m,this.m_localAxisC,Pn.SolvePositionConstraints_s_u),e=Tt.MulRV(m,this.m_lalcC,Pn.SolvePositionConstraints_s_rC),n=Tt.MulRV(h,this.m_lalcA,Pn.SolvePositionConstraints_s_rA);y.Copy(t),S=xt.CrossVV(e,t),x=xt.CrossVV(n,t),C+=this.m_mC+this.m_mA+this.m_iC*S*S+this.m_iA*x*x;const s=this.m_lalcC,r=Tt.MulTRV(m,xt.AddVV(n,xt.SubVV(i,o,xt.s_t0),xt.s_t0),xt.s_t0);f=xt.DotVV(xt.SubVV(r,s,xt.s_t0),this.m_localAxisC)}if(this.m_typeB===t.b2JointType.e_revoluteJoint)v.SetZero(),b=this.m_ratio,A=this.m_ratio,C+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),g=r-c-this.m_referenceAngleB;else{const t=Tt.MulRV(p,this.m_localAxisD,Pn.SolvePositionConstraints_s_u),e=Tt.MulRV(p,this.m_lalcD,Pn.SolvePositionConstraints_s_rD),i=Tt.MulRV(u,this.m_lalcB,Pn.SolvePositionConstraints_s_rB);xt.MulSV(this.m_ratio,t,v),A=this.m_ratio*xt.CrossVV(e,t),b=this.m_ratio*xt.CrossVV(i,t),C+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*A*A+this.m_iB*b*b;const n=this.m_lalcD,r=Tt.MulTRV(p,xt.AddVV(i,xt.SubVV(s,l,xt.s_t0),xt.s_t0),xt.s_t0);g=xt.DotVV(xt.SubVV(r,n,xt.s_t0),this.m_localAxisD)}const T=f+this.m_ratio*g-this.m_constant;let w=0;return C>0&&(w=-T/C),i.SelfMulAdd(this.m_mA*w,y),n+=this.m_iA*w*x,s.SelfMulAdd(this.m_mB*w,v),r+=this.m_iB*w*b,o.SelfMulSub(this.m_mC*w,y),a-=this.m_iC*w*S,l.SelfMulSub(this.m_mD*w,v),c-=this.m_iD*w*A,e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,e.positions[this.m_indexC].a=a,e.positions[this.m_indexD].a=c,d<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,n=this.m_joint1.m_index,s=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",n),t("  jd.joint2 = joints[%d];\n",s),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Pn.InitVelocityConstraints_s_u=new xt,Pn.InitVelocityConstraints_s_rA=new xt,Pn.InitVelocityConstraints_s_rB=new xt,Pn.InitVelocityConstraints_s_rC=new xt,Pn.InitVelocityConstraints_s_rD=new xt,Pn.SolvePositionConstraints_s_u=new xt,Pn.SolvePositionConstraints_s_rA=new xt,Pn.SolvePositionConstraints_s_rB=new xt,Pn.SolvePositionConstraints_s_rC=new xt,Pn.SolvePositionConstraints_s_rD=new xt;class Dn extends vn{constructor(){super(t.b2JointType.e_motorJoint),this.linearOffset=new xt(0,0),this.angularOffset=0,this.maxForce=1,this.maxTorque=1,this.correctionFactor=.3}Initialize(t,e){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(this.bodyB.GetPosition(),this.linearOffset);const i=this.bodyA.GetAngle(),n=this.bodyB.GetAngle();this.angularOffset=n-i}}class In extends xn{constructor(t){super(t),this.m_linearOffset=new xt,this.m_angularOffset=0,this.m_linearImpulse=new xt,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_linearError=new xt,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new At,this.m_angularMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_K=new At,this.m_linearOffset.Copy(i(t.linearOffset,xt.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=i(t.maxForce,0),this.m_maxTorque=i(t.maxTorque,0),this.m_correctionFactor=i(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return xt.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){xt.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o),_=Tt.MulRV(c,xt.SubVV(this.m_linearOffset,this.m_localCenterA,xt.s_t0),this.m_rA),u=Tt.MulRV(h,xt.NegV(this.m_localCenterB,xt.s_t0),this.m_rB),m=this.m_invMassA,p=this.m_invMassB,d=this.m_invIA,f=this.m_invIB,g=this.m_K;if(g.ex.x=m+p+d*_.y*_.y+f*u.y*u.y,g.ex.y=-d*_.x*_.y-f*u.x*u.y,g.ey.x=g.ex.y,g.ey.y=m+p+d*_.x*_.x+f*u.x*u.x,g.GetInverse(this.m_linearMass),this.m_angularMass=d+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),xt.SubVV(xt.AddVV(r,u,xt.s_t0),xt.AddVV(e,_,xt.s_t1),this.m_linearError),this.m_angularError=o-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;n.SelfMulSub(m,e),s-=d*(xt.CrossVV(_,e)+this.m_angularImpulse),a.SelfMulAdd(p,e),l+=f*(xt.CrossVV(u,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB,c=t.step.dt,h=t.step.inv_dt;{const t=s-i+h*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const n=this.m_angularImpulse,r=c*this.m_maxTorque;this.m_angularImpulse=it(this.m_angularImpulse+e,-r,r),e=this.m_angularImpulse-n,i-=a*e,s+=l*e}{const t=this.m_rA,_=this.m_rB,u=xt.AddVV(xt.SubVV(xt.AddVV(n,xt.CrossSV(s,_,xt.s_t0),xt.s_t0),xt.AddVV(e,xt.CrossSV(i,t,xt.s_t1),xt.s_t1),xt.s_t2),xt.MulSV(h*this.m_correctionFactor,this.m_linearError,xt.s_t3),In.SolveVelocityConstraints_s_Cdot_v2),m=At.MulMV(this.m_linearMass,u,In.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),p=In.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);const d=c*this.m_maxForce;this.m_linearImpulse.LengthSquared()>d*d&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(d)),xt.SubVV(this.m_linearImpulse,p,m),e.SelfMulSub(r,m),i-=a*xt.CrossVV(t,m),n.SelfMulAdd(o,m),s+=l*xt.CrossVV(_,m)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}In.SolveVelocityConstraints_s_Cdot_v2=new xt,In.SolveVelocityConstraints_s_impulse_v2=new xt,In.SolveVelocityConstraints_s_oldImpulse_v2=new xt;class Rn extends vn{constructor(){super(t.b2JointType.e_mouseJoint),this.target=new xt,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7}}class Mn extends xn{constructor(t){super(t),this.m_localAnchorB=new xt,this.m_targetA=new xt,this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_beta=0,this.m_impulse=new xt,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new xt,this.m_localCenterB=new xt,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new At,this.m_C=new xt,this.m_qB=new Tt,this.m_lalcB=new xt,this.m_K=new At,this.m_targetA.Copy(i(t.target,xt.ZERO)),wt.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=i(t.maxForce,0),this.m_impulse.SetZero(),this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_qB.SetAngle(i),a=this.m_bodyB.GetMass(),l=2*o*this.m_frequencyHz,c=2*a*this.m_dampingRatio*l,h=a*l*l,_=t.step.dt;this.m_gamma=_*(c+_*h),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=_*h*this.m_gamma,xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(r,this.m_lalcB,this.m_rB);const u=this.m_K;u.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,u.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,u.ey.x=u.ex.y,u.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,u.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),s*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),n.x+=this.m_invMassB*this.m_impulse.x,n.y+=this.m_invMassB*this.m_impulse.y,s+=this.m_invIB*xt.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=s}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const n=xt.AddVCrossSV(e,i,this.m_rB,Mn.SolveVelocityConstraints_s_Cdot),s=At.MulMV(this.m_mass,xt.AddVV(n,xt.AddVV(this.m_C,xt.MulSV(this.m_gamma,this.m_impulse,xt.s_t0),xt.s_t0),xt.s_t0).SelfNeg(),Mn.SolveVelocityConstraints_s_impulse),r=Mn.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(s);const o=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>o*o&&this.m_impulse.SelfMul(o/this.m_impulse.Length()),xt.SubVV(this.m_impulse,r,s),e.SelfMulAdd(this.m_invMassB,s),i+=this.m_invIB*xt.CrossVV(this.m_rB,s),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}Mn.SolveVelocityConstraints_s_Cdot=new xt,Mn.SolveVelocityConstraints_s_impulse=new xt,Mn.SolveVelocityConstraints_s_oldImpulse=new xt;class On extends vn{constructor(){super(t.b2JointType.e_prismaticJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.localAxisA=new xt(1,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerTranslation=0,this.upperTranslation=0,this.enableMotor=!1,this.maxMotorForce=0,this.motorSpeed=0}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Bn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_referenceAngle=0,this.m_impulse=new St(0,0,0),this.m_motorImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new xt(0,0),this.m_perp=new xt(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new Ct,this.m_K3=new Ct,this.m_K2=new At,this.m_motorMass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(e.localAxisA,new xt(1,0))).SelfNormalize(),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=i(e.referenceAngle,0),this.m_lowerTranslation=i(e.lowerTranslation,0),this.m_upperTranslation=i(e.upperTranslation,0),this.m_maxMotorForce=i(e.maxMotorForce,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v;let c=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const m=Tt.MulRV(h,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const p=Tt.MulRV(u,this.m_lalcB,this.m_rB),d=xt.AddVV(xt.SubVV(o,i,xt.s_t0),xt.SubVV(p,m,xt.s_t1),Bn.InitVelocityConstraints_s_d),f=this.m_invMassA,g=this.m_invMassB,y=this.m_invIA,v=this.m_invIB;if(Tt.MulRV(h,this.m_localXAxisA,this.m_axis),this.m_a1=xt.CrossVV(xt.AddVV(d,m,xt.s_t0),this.m_axis),this.m_a2=xt.CrossVV(p,this.m_axis),this.m_motorMass=f+g+y*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),Tt.MulRV(h,this.m_localYAxisA,this.m_perp),this.m_s1=xt.CrossVV(xt.AddVV(d,m,xt.s_t0),this.m_perp),this.m_s2=xt.CrossVV(p,this.m_perp),this.m_K.ex.x=f+g+y*this.m_s1*this.m_s1+v*this.m_s2*this.m_s2,this.m_K.ex.y=y*this.m_s1+v*this.m_s2,this.m_K.ex.z=y*this.m_s1*this.m_a1+v*this.m_s2*this.m_a2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=y+v,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_K.ey.z=y*this.m_a1+v*this.m_a2,this.m_K.ez.x=this.m_K.ex.z,this.m_K.ez.y=this.m_K.ey.z,this.m_K.ez.z=f+g+y*this.m_a1*this.m_a1+v*this.m_a2*this.m_a2,this.m_enableLimit){const e=xt.DotVV(this.m_axis,d);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerTranslation?this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_limitState=t.b2LimitState.e_atLowerLimit,this.m_impulse.z=0):e>=this.m_upperTranslation?this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_limitState=t.b2LimitState.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0;if(this.m_enableMotor||(this.m_motorImpulse=0),e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=xt.AddVV(xt.MulSV(this.m_impulse.x,this.m_perp,xt.s_t0),xt.MulSV(this.m_motorImpulse+this.m_impulse.z,this.m_axis,xt.s_t1),Bn.InitVelocityConstraints_s_P),i=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,n=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2;s.SelfMulSub(f,t),r-=y*i,l.SelfMulAdd(g,t),c+=v*n}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits){const t=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n;let h=this.m_motorMass*(this.m_motorSpeed-t);const _=this.m_motorImpulse,u=e.step.dt*this.m_maxMotorForce;this.m_motorImpulse=it(this.m_motorImpulse+h,-u,u),h=this.m_motorImpulse-_;const m=xt.MulSV(h,this.m_axis,Bn.SolveVelocityConstraints_s_P),p=h*this.m_a1,d=h*this.m_a2;i.SelfMulSub(o,m),n-=l*p,s.SelfMulAdd(a,m),r+=c*d}const h=xt.DotVV(this.m_perp,xt.SubVV(s,i,xt.s_t0))+this.m_s2*r-this.m_s1*n,_=r-n;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit){const e=xt.DotVV(this.m_axis,xt.SubVV(s,i,xt.s_t0))+this.m_a2*r-this.m_a1*n,u=Bn.SolveVelocityConstraints_s_f1.Copy(this.m_impulse),m=this.m_K.Solve33(-h,-_,-e,Bn.SolveVelocityConstraints_s_df3);this.m_impulse.SelfAdd(m),this.m_limitState===t.b2LimitState.e_atLowerLimit?this.m_impulse.z=et(this.m_impulse.z,0):this.m_limitState===t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=tt(this.m_impulse.z,0));const p=-h-(this.m_impulse.z-u.z)*this.m_K.ez.x,d=-_-(this.m_impulse.z-u.z)*this.m_K.ez.y,f=this.m_K.Solve22(p,d,Bn.SolveVelocityConstraints_s_f2r);f.x+=u.x,f.y+=u.y,this.m_impulse.x=f.x,this.m_impulse.y=f.y,m.x=this.m_impulse.x-u.x,m.y=this.m_impulse.y-u.y,m.z=this.m_impulse.z-u.z;const g=xt.AddVV(xt.MulSV(m.x,this.m_perp,xt.s_t0),xt.MulSV(m.z,this.m_axis,xt.s_t1),Bn.SolveVelocityConstraints_s_P),y=m.x*this.m_s1+m.y+m.z*this.m_a1,v=m.x*this.m_s2+m.y+m.z*this.m_a2;i.SelfMulSub(o,g),n-=l*y,s.SelfMulAdd(a,g),r+=c*v}else{const t=this.m_K.Solve22(-h,-_,Bn.SolveVelocityConstraints_s_df2);this.m_impulse.x+=t.x,this.m_impulse.y+=t.y;const e=xt.MulSV(t.x,this.m_perp,Bn.SolveVelocityConstraints_s_P),u=t.x*this.m_s1+t.y,m=t.x*this.m_s2+t.y;i.SelfMulSub(o,e),n-=l*u,s.SelfMulAdd(a,e),r+=c*m}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,l=this.m_invMassB,c=this.m_invIA,h=this.m_invIB,m=Tt.MulRV(r,this.m_lalcA,this.m_rA),p=Tt.MulRV(o,this.m_lalcB,this.m_rB),d=xt.SubVV(xt.AddVV(n,p,xt.s_t0),xt.AddVV(e,m,xt.s_t1),Bn.SolvePositionConstraints_s_d),f=Tt.MulRV(r,this.m_localXAxisA,this.m_axis),y=xt.CrossVV(xt.AddVV(d,m,xt.s_t0),f),v=xt.CrossVV(p,f),x=Tt.MulRV(r,this.m_localYAxisA,this.m_perp),b=xt.CrossVV(xt.AddVV(d,m,xt.s_t0),x),S=xt.CrossVV(p,x);let A=Bn.SolvePositionConstraints_s_impulse;const C=xt.DotVV(x,d),T=s-i-this.m_referenceAngle;let w=Q(C);const E=Q(T);let P=!1,D=0;if(this.m_enableLimit){const t=xt.DotVV(f,d);Q(this.m_upperTranslation-this.m_lowerTranslation)<2*_?(D=it(t,-g,g),w=et(w,Q(t)),P=!0):t<=this.m_lowerTranslation?(D=it(t-this.m_lowerTranslation+_,-g,0),w=et(w,this.m_lowerTranslation-t),P=!0):t>=this.m_upperTranslation&&(D=it(t-this.m_upperTranslation-_,0,g),w=et(w,t-this.m_upperTranslation),P=!0)}if(P){const t=a+l+c*b*b+h*S*S,e=c*b+h*S,i=c*b*y+h*S*v;let n=c+h;0===n&&(n=1);const s=c*y+h*v,r=a+l+c*y*y+h*v*v,o=this.m_K3;o.ex.SetXYZ(t,e,i),o.ey.SetXYZ(e,n,s),o.ez.SetXYZ(i,s,r),A=o.Solve33(-C,-T,-D,A)}else{const t=a+l+c*b*b+h*S*S,e=c*b+h*S;let i=c+h;0===i&&(i=1);const n=this.m_K2;n.ex.Set(t,e),n.ey.Set(e,i);const s=n.Solve(-C,-T,Bn.SolvePositionConstraints_s_impulse1);A.x=s.x,A.y=s.y,A.z=0}const I=xt.AddVV(xt.MulSV(A.x,x,xt.s_t0),xt.MulSV(A.z,f,xt.s_t1),Bn.SolvePositionConstraints_s_P),R=A.x*b+A.y+A.z*y,M=A.x*S+A.y+A.z*v;return e.SelfMulSub(a,I),i-=c*R,n.SelfMulAdd(l,I),s+=h*M,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,w<=_&&E<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),e.y=t*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Bn.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Bn.GetJointTranslation_s_pB),i=xt.SubVV(e,t,Bn.GetJointTranslation_s_d),n=this.m_bodyA.GetWorldVector(this.m_localXAxisA,Bn.GetJointTranslation_s_axis);return xt.DotVV(i,n)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,this.m_axis),l=t.m_linearVelocity,c=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(c,_,n,xt.s_t0),xt.AddVCrossSV(l,h,i,xt.s_t1),xt.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_impulse.z=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Bn.InitVelocityConstraints_s_d=new xt,Bn.InitVelocityConstraints_s_P=new xt,Bn.SolveVelocityConstraints_s_P=new xt,Bn.SolveVelocityConstraints_s_f2r=new xt,Bn.SolveVelocityConstraints_s_f1=new St,Bn.SolveVelocityConstraints_s_df3=new St,Bn.SolveVelocityConstraints_s_df2=new xt,Bn.SolvePositionConstraints_s_d=new xt,Bn.SolvePositionConstraints_s_impulse=new St,Bn.SolvePositionConstraints_s_impulse1=new xt,Bn.SolvePositionConstraints_s_P=new xt,Bn.GetJointTranslation_s_pA=new xt,Bn.GetJointTranslation_s_pB=new xt,Bn.GetJointTranslation_s_d=new xt,Bn.GetJointTranslation_s_axis=new xt;const Nn=2;class Ln extends vn{constructor(){super(t.b2JointType.e_pulleyJoint),this.groundAnchorA=new xt(-1,1),this.groundAnchorB=new xt(1,1),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.lengthA=0,this.lengthB=0,this.ratio=1,this.collideConnected=!0}Initialize(t,e,i,n,s,r,o){this.bodyA=t,this.bodyB=e,this.groundAnchorA.Copy(i),this.groundAnchorB.Copy(n),this.bodyA.GetLocalPoint(s,this.localAnchorA),this.bodyB.GetLocalPoint(r,this.localAnchorB),this.lengthA=xt.DistanceVV(s,i),this.lengthB=xt.DistanceVV(r,n),this.ratio=o}}class Fn extends xn{constructor(t){super(t),this.m_groundAnchorA=new xt,this.m_groundAnchorB=new xt,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new xt,this.m_uB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_groundAnchorA.Copy(i(t.groundAnchorA,new xt(-1,1))),this.m_groundAnchorB.Copy(i(t.groundAnchorB,new xt(1,0))),this.m_localAnchorA.Copy(i(t.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(t.localAnchorB,new xt(1,0))),this.m_lengthA=i(t.lengthA,0),this.m_lengthB=i(t.lengthB,0),this.m_ratio=i(t.ratio,1),this.m_constant=i(t.lengthA,0)+this.m_ratio*i(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,n=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;const c=this.m_qA.SetAngle(i),h=this.m_qB.SetAngle(o);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(c,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(h,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(r).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const u=this.m_uA.Length(),m=this.m_uB.Length();u>10*_?this.m_uA.SelfMul(1/u):this.m_uA.SetZero(),m>10*_?this.m_uB.SelfMul(1/m):this.m_uB.SetZero();const p=xt.CrossVV(this.m_rA,this.m_uA),d=xt.CrossVV(this.m_rB,this.m_uB),f=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=f+this.m_ratio*this.m_ratio*g,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=xt.MulSV(-this.m_impulse,this.m_uA,Fn.InitVelocityConstraints_s_PA),i=xt.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,Fn.InitVelocityConstraints_s_PB);n.SelfMulAdd(this.m_invMassA,e),s+=this.m_invIA*xt.CrossVV(this.m_rA,e),a.SelfMulAdd(this.m_invMassB,i),l+=this.m_invIB*xt.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=l}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Fn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Fn.SolveVelocityConstraints_s_vpB),a=-xt.DotVV(this.m_uA,r)-this.m_ratio*xt.DotVV(this.m_uB,o),l=-this.m_mass*a;this.m_impulse+=l;const c=xt.MulSV(-l,this.m_uA,Fn.SolveVelocityConstraints_s_PA),h=xt.MulSV(-this.m_ratio*l,this.m_uB,Fn.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,c),i+=this.m_invIA*xt.CrossVV(this.m_rA,c),n.SelfMulAdd(this.m_invMassB,h),s+=this.m_invIB*xt.CrossVV(this.m_rB,h),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_uA.Copy(e).SelfAdd(a).SelfSub(this.m_groundAnchorA),h=this.m_uB.Copy(n).SelfAdd(l).SelfSub(this.m_groundAnchorB),u=c.Length(),m=h.Length();u>10*_?c.SelfMul(1/u):c.SetZero(),m>10*_?h.SelfMul(1/m):h.SetZero();const p=xt.CrossVV(a,c),d=xt.CrossVV(l,h),f=this.m_invMassA+this.m_invIA*p*p,g=this.m_invMassB+this.m_invIB*d*d;let y=f+this.m_ratio*this.m_ratio*g;y>0&&(y=1/y);const v=this.m_constant-u-this.m_ratio*m,x=Q(v),b=-y*v,S=xt.MulSV(-b,c,Fn.SolvePositionConstraints_s_PA),A=xt.MulSV(-this.m_ratio*b,h,Fn.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,S),i+=this.m_invIA*xt.CrossVV(a,S),n.SelfMulAdd(this.m_invMassB,A),s+=this.m_invIB*xt.CrossVV(l,A),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,x<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,Fn.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return xt.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,Fn.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return xt.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}Fn.InitVelocityConstraints_s_PA=new xt,Fn.InitVelocityConstraints_s_PB=new xt,Fn.SolveVelocityConstraints_s_vpA=new xt,Fn.SolveVelocityConstraints_s_vpB=new xt,Fn.SolveVelocityConstraints_s_PA=new xt,Fn.SolveVelocityConstraints_s_PB=new xt,Fn.SolvePositionConstraints_s_PA=new xt,Fn.SolvePositionConstraints_s_PB=new xt,Fn.GetCurrentLengthA_s_p=new xt,Fn.GetCurrentLengthB_s_p=new xt;class zn extends vn{constructor(){super(t.b2JointType.e_revoluteJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.referenceAngle=0,this.enableLimit=!1,this.lowerAngle=0,this.upperAngle=0,this.enableMotor=!1,this.motorSpeed=0,this.maxMotorTorque=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Vn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_impulse=new St,this.m_motorImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new Ct,this.m_motorMass=0,this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new At,this.m_localAnchorA.Copy(i(e.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(e.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(e.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=i(e.lowerAngle,0),this.m_upperAngle=i(e.upperAngle,0),this.m_maxMotorTorque=i(e.maxMotorTorque,0),this.m_motorSpeed=i(e.motorSpeed,0),this.m_enableLimit=i(e.enableLimit,!1),this.m_enableMotor=i(e.enableMotor,!1),this.m_limitState=t.b2LimitState.e_inactiveLimit}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].a,n=e.velocities[this.m_indexA].v;let s=e.velocities[this.m_indexA].w;const r=e.positions[this.m_indexB].a,o=e.velocities[this.m_indexB].v;let a=e.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),c=this.m_qB.SetAngle(r);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(l,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(c,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,m=this.m_invIA,p=this.m_invIB,d=m+p===0;if(this.m_mass.ex.x=h+_+this.m_rA.y*this.m_rA.y*m+this.m_rB.y*this.m_rB.y*p,this.m_mass.ey.x=-this.m_rA.y*this.m_rA.x*m-this.m_rB.y*this.m_rB.x*p,this.m_mass.ez.x=-this.m_rA.y*m-this.m_rB.y*p,this.m_mass.ex.y=this.m_mass.ey.x,this.m_mass.ey.y=h+_+this.m_rA.x*this.m_rA.x*m+this.m_rB.x*this.m_rB.x*p,this.m_mass.ez.y=this.m_rA.x*m+this.m_rB.x*p,this.m_mass.ex.z=this.m_mass.ez.x,this.m_mass.ey.z=this.m_mass.ez.y,this.m_mass.ez.z=m+p,this.m_motorMass=m+p,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass),this.m_enableMotor&&!d||(this.m_motorImpulse=0),this.m_enableLimit&&!d){const e=r-i-this.m_referenceAngle;Q(this.m_upperAngle-this.m_lowerAngle)<2*u?this.m_limitState=t.b2LimitState.e_equalLimits:e<=this.m_lowerAngle?(this.m_limitState!==t.b2LimitState.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atLowerLimit):e>=this.m_upperAngle?(this.m_limitState!==t.b2LimitState.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=t.b2LimitState.e_atUpperLimit):(this.m_limitState=t.b2LimitState.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=t.b2LimitState.e_inactiveLimit;if(e.step.warmStarting){this.m_impulse.SelfMul(e.step.dtRatio),this.m_motorImpulse*=e.step.dtRatio;const t=Vn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);n.SelfMulSub(h,t),s-=m*(xt.CrossVV(this.m_rA,t)+this.m_motorImpulse+this.m_impulse.z),o.SelfMulAdd(_,t),a+=p*(xt.CrossVV(this.m_rB,t)+this.m_motorImpulse+this.m_impulse.z)}else this.m_impulse.SetZero(),this.m_motorImpulse=0;e.velocities[this.m_indexA].w=s,e.velocities[this.m_indexB].w=a}SolveVelocityConstraints(e){const i=e.velocities[this.m_indexA].v;let n=e.velocities[this.m_indexA].w;const s=e.velocities[this.m_indexB].v;let r=e.velocities[this.m_indexB].w;const o=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,c=this.m_invIB,h=l+c===0;if(this.m_enableMotor&&this.m_limitState!==t.b2LimitState.e_equalLimits&&!h){const t=r-n-this.m_motorSpeed;let i=-this.m_motorMass*t;const s=this.m_motorImpulse,o=e.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-o,o),i=this.m_motorImpulse-s,n-=l*i,r+=c*i}if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot1),h=r-n,_=this.m_mass.Solve33(e.x,e.y,h,Vn.SolveVelocityConstraints_s_impulse_v3).SelfNeg();if(this.m_limitState===t.b2LimitState.e_equalLimits)this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atLowerLimit)if(this.m_impulse.z+_.z<0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);else if(this.m_limitState===t.b2LimitState.e_atUpperLimit)if(this.m_impulse.z+_.z>0){const t=-e.x+this.m_impulse.z*this.m_mass.ez.x,i=-e.y+this.m_impulse.z*this.m_mass.ez.y,n=this.m_mass.Solve22(t,i,Vn.SolveVelocityConstraints_s_reduced_v2);_.x=n.x,_.y=n.y,_.z=-this.m_impulse.z,this.m_impulse.x+=n.x,this.m_impulse.y+=n.y,this.m_impulse.z=0}else this.m_impulse.SelfAdd(_);const u=Vn.SolveVelocityConstraints_s_P.Set(_.x,_.y);i.SelfMulSub(o,u),n-=l*(xt.CrossVV(this.m_rA,u)+_.z),s.SelfMulAdd(a,u),r+=c*(xt.CrossVV(this.m_rB,u)+_.z)}else{const t=xt.SubVV(xt.AddVCrossSV(s,r,this.m_rB,xt.s_t0),xt.AddVCrossSV(i,n,this.m_rA,xt.s_t1),Vn.SolveVelocityConstraints_s_Cdot_v2),e=this.m_mass.Solve22(-t.x,-t.y,Vn.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=e.x,this.m_impulse.y+=e.y,i.SelfMulSub(o,e),n-=l*xt.CrossVV(this.m_rA,e),s.SelfMulAdd(a,e),r+=c*xt.CrossVV(this.m_rB,e)}e.velocities[this.m_indexA].w=n,e.velocities[this.m_indexB].w=r}SolvePositionConstraints(e){const i=e.positions[this.m_indexA].c;let n=e.positions[this.m_indexA].a;const s=e.positions[this.m_indexB].c;let r=e.positions[this.m_indexB].a;const o=this.m_qA.SetAngle(n),a=this.m_qB.SetAngle(r);let l=0,c=0;const h=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&this.m_limitState!==t.b2LimitState.e_inactiveLimit&&!h){const e=r-n-this.m_referenceAngle;let i=0;if(this.m_limitState===t.b2LimitState.e_equalLimits){const t=it(e-this.m_lowerAngle,-y,y);i=-this.m_motorMass*t,l=Q(t)}else if(this.m_limitState===t.b2LimitState.e_atLowerLimit){let t=e-this.m_lowerAngle;l=-t,t=it(t+u,-y,0),i=-this.m_motorMass*t}else if(this.m_limitState===t.b2LimitState.e_atUpperLimit){let t=e-this.m_upperAngle;l=t,t=it(t-u,0,y),i=-this.m_motorMass*t}n-=this.m_invIA*i,r+=this.m_invIB*i}{o.SetAngle(n),a.SetAngle(r),xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=Tt.MulRV(o,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const e=Tt.MulRV(a,this.m_lalcB,this.m_rB),l=xt.SubVV(xt.AddVV(s,e,xt.s_t0),xt.AddVV(i,t,xt.s_t1),Vn.SolvePositionConstraints_s_C_v2);c=l.Length();const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,m=this.m_invIB,p=this.m_K;p.ex.x=h+_+u*t.y*t.y+m*e.y*e.y,p.ex.y=-u*t.x*t.y-m*e.x*e.y,p.ey.x=p.ex.y,p.ey.y=h+_+u*t.x*t.x+m*e.x*e.x;const d=p.Solve(l.x,l.y,Vn.SolvePositionConstraints_s_impulse).SelfNeg();i.SelfMulSub(h,d),n-=u*xt.CrossVV(t,d),s.SelfMulAdd(_,d),r+=m*xt.CrossVV(e,d)}return e.positions[this.m_indexA].a=n,e.positions[this.m_indexB].a=r,c<=_&&l<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_impulse.z=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_impulse.z=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Vn.InitVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_P=new xt,Vn.SolveVelocityConstraints_s_Cdot_v2=new xt,Vn.SolveVelocityConstraints_s_Cdot1=new xt,Vn.SolveVelocityConstraints_s_impulse_v3=new St,Vn.SolveVelocityConstraints_s_reduced_v2=new xt,Vn.SolveVelocityConstraints_s_impulse_v2=new xt,Vn.SolvePositionConstraints_s_C_v2=new xt,Vn.SolvePositionConstraints_s_impulse=new xt;class Un extends vn{constructor(){super(t.b2JointType.e_ropeJoint),this.localAnchorA=new xt(-1,0),this.localAnchorB=new xt(1,0),this.maxLength=0}}class Gn extends xn{constructor(e){super(e),this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_maxLength=0,this.m_length=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_state=t.b2LimitState.e_inactiveLimit,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_localAnchorA.Copy(i(e.localAnchorA,new xt(-1,0))),this.m_localAnchorB.Copy(i(e.localAnchorB,new xt(1,0))),this.m_maxLength=i(e.maxLength,0)}InitVelocityConstraints(e){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const i=e.positions[this.m_indexA].c,n=e.positions[this.m_indexA].a,s=e.velocities[this.m_indexA].v;let r=e.velocities[this.m_indexA].w;const o=e.positions[this.m_indexB].c,a=e.positions[this.m_indexB].a,l=e.velocities[this.m_indexB].v;let c=e.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(n),u=this.m_qB.SetAngle(a);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(h,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(u,this.m_lalcB,this.m_rB),this.m_u.Copy(o).SelfAdd(this.m_rB).SelfSub(i).SelfSub(this.m_rA),this.m_length=this.m_u.Length();const m=this.m_length-this.m_maxLength;if(this.m_state=m>0?t.b2LimitState.e_atUpperLimit:t.b2LimitState.e_inactiveLimit,!(this.m_length>_))return this.m_u.SetZero(),this.m_mass=0,void(this.m_impulse=0);this.m_u.SelfMul(1/this.m_length);const p=xt.CrossVV(this.m_rA,this.m_u),d=xt.CrossVV(this.m_rB,this.m_u),f=this.m_invMassA+this.m_invIA*p*p+this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=0!==f?1/f:0,e.step.warmStarting){this.m_impulse*=e.step.dtRatio;const t=xt.MulSV(this.m_impulse,this.m_u,Gn.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,t),r-=this.m_invIA*xt.CrossVV(this.m_rA,t),l.SelfMulAdd(this.m_invMassB,t),c+=this.m_invIB*xt.CrossVV(this.m_rB,t)}else this.m_impulse=0;e.velocities[this.m_indexA].w=r,e.velocities[this.m_indexB].w=c}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=xt.AddVCrossSV(e,i,this.m_rA,Gn.SolveVelocityConstraints_s_vpA),o=xt.AddVCrossSV(n,s,this.m_rB,Gn.SolveVelocityConstraints_s_vpB),a=this.m_length-this.m_maxLength;let l=xt.DotVV(this.m_u,xt.SubVV(o,r,xt.s_t0));a<0&&(l+=t.step.inv_dt*a);let c=-this.m_mass*l;const h=this.m_impulse;this.m_impulse=tt(0,this.m_impulse+c),c=this.m_impulse-h;const _=xt.MulSV(c,this.m_u,Gn.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*xt.CrossVV(this.m_rA,_),n.SelfMulAdd(this.m_invMassB,_),s+=this.m_invIB*xt.CrossVV(this.m_rB,_),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=this.m_u.Copy(n).SelfAdd(l).SelfSub(e).SelfSub(a),h=c.Normalize();let u=h-this.m_maxLength;u=it(u,0,g);const m=-this.m_mass*u,p=xt.MulSV(m,c,Gn.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,p),i-=this.m_invIA*xt.CrossVV(a,p),n.SelfMulAdd(this.m_invMassB,p),s+=this.m_invIB*xt.CrossVV(l,p),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,h-this.m_maxLength<_}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return xt.MulSV(t*this.m_impulse,this.m_u,e)}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxLength(t){this.m_maxLength=t}GetMaxLength(){return this.m_maxLength}GetLimitState(){return this.m_state}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RopeJointDef = new b2RopeJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Gn.InitVelocityConstraints_s_P=new xt,Gn.SolveVelocityConstraints_s_vpA=new xt,Gn.SolveVelocityConstraints_s_vpB=new xt,Gn.SolveVelocityConstraints_s_P=new xt,Gn.SolvePositionConstraints_s_P=new xt;class kn extends vn{constructor(){super(t.b2JointType.e_weldJoint),this.localAnchorA=new xt,this.localAnchorB=new xt,this.referenceAngle=0,this.frequencyHz=0,this.dampingRatio=0}Initialize(t,e,i){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()}}class Hn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_bias=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new St(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new xt,this.m_rB=new xt,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new Ct,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_K=new Ct,this.m_frequencyHz=i(t.frequencyHz,0),this.m_dampingRatio=i(t.dampingRatio,0),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_referenceAngle=i(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let n=t.velocities[this.m_indexA].w;const s=t.positions[this.m_indexB].a,r=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(e),c=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Tt.MulRV(l,this.m_lalcA,this.m_rA),xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Tt.MulRV(c,this.m_lalcB,this.m_rB);const h=this.m_invMassA,_=this.m_invMassB,u=this.m_invIA,m=this.m_invIB,p=this.m_K;if(p.ex.x=h+_+this.m_rA.y*this.m_rA.y*u+this.m_rB.y*this.m_rB.y*m,p.ey.x=-this.m_rA.y*this.m_rA.x*u-this.m_rB.y*this.m_rB.x*m,p.ez.x=-this.m_rA.y*u-this.m_rB.y*m,p.ex.y=p.ey.x,p.ey.y=h+_+this.m_rA.x*this.m_rA.x*u+this.m_rB.x*this.m_rB.x*m,p.ez.y=this.m_rA.x*u+this.m_rB.x*m,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=u+m,this.m_frequencyHz>0){p.GetInverse22(this.m_mass);let i=u+m;const n=i>0?1/i:0,r=s-e-this.m_referenceAngle,a=2*o*this.m_frequencyHz,l=2*n*this.m_dampingRatio*a,c=n*a*a,h=t.step.dt;this.m_gamma=h*(l+h*c),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=r*h*c*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else p.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=Hn.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(h,e),n-=u*(xt.CrossVV(this.m_rA,e)+this.m_impulse.z),r.SelfMulAdd(_,e),a+=m*(xt.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=n,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const n=t.velocities[this.m_indexB].v;let s=t.velocities[this.m_indexB].w;const r=this.m_invMassA,o=this.m_invMassB,a=this.m_invIA,l=this.m_invIB;if(this.m_frequencyHz>0){const t=s-i,c=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=c,i-=a*c,s+=l*c;const h=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),Hn.SolveVelocityConstraints_s_Cdot1),_=Ct.MulM33XY(this.m_mass,h.x,h.y,Hn.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=_.x,this.m_impulse.y+=_.y;const u=_;e.SelfMulSub(r,u),i-=a*xt.CrossVV(this.m_rA,u),n.SelfMulAdd(o,u),s+=l*xt.CrossVV(this.m_rB,u)}else{const t=xt.SubVV(xt.AddVCrossSV(n,s,this.m_rB,xt.s_t0),xt.AddVCrossSV(e,i,this.m_rA,xt.s_t1),Hn.SolveVelocityConstraints_s_Cdot1),c=s-i,h=Ct.MulM33XYZ(this.m_mass,t.x,t.y,c,Hn.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(h);const _=Hn.SolveVelocityConstraints_s_P.Set(h.x,h.y);e.SelfMulSub(r,_),i-=a*(xt.CrossVV(this.m_rA,_)+h.z),n.SelfMulAdd(o,_),s+=l*(xt.CrossVV(this.m_rB,_)+h.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=s}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s),a=this.m_invMassA,l=this.m_invMassB,c=this.m_invIA,h=this.m_invIB;xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const m=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const p=Tt.MulRV(o,this.m_lalcB,this.m_rB);let d,f;const g=this.m_K;if(g.ex.x=a+l+m.y*m.y*c+p.y*p.y*h,g.ey.x=-m.y*m.x*c-p.y*p.x*h,g.ez.x=-m.y*c-p.y*h,g.ex.y=g.ey.x,g.ey.y=a+l+m.x*m.x*c+p.x*p.x*h,g.ez.y=m.x*c+p.x*h,g.ex.z=g.ez.x,g.ey.z=g.ez.y,g.ez.z=c+h,this.m_frequencyHz>0){const t=xt.SubVV(xt.AddVV(n,p,xt.s_t0),xt.AddVV(e,m,xt.s_t1),Hn.SolvePositionConstraints_s_C1);d=t.Length(),f=0;const r=g.Solve22(t.x,t.y,Hn.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(a,r),i-=c*xt.CrossVV(m,r),n.SelfMulAdd(l,r),s+=h*xt.CrossVV(p,r)}else{const t=xt.SubVV(xt.AddVV(n,p,xt.s_t0),xt.AddVV(e,m,xt.s_t1),Hn.SolvePositionConstraints_s_C1),r=s-i-this.m_referenceAngle;d=t.Length(),f=Q(r);const o=g.Solve33(t.x,t.y,r,Hn.SolvePositionConstraints_s_impulse).SelfNeg(),_=Hn.SolvePositionConstraints_s_P.Set(o.x,o.y);e.SelfMulSub(a,_),i-=c*(xt.CrossVV(this.m_rA,_)+o.z),n.SelfMulAdd(l,_),s+=h*(xt.CrossVV(this.m_rB,_)+o.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,d<=_&&f<=u}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetFrequency(t){this.m_frequencyHz=t}GetFrequency(){return this.m_frequencyHz}SetDampingRatio(t){this.m_dampingRatio=t}GetDampingRatio(){return this.m_dampingRatio}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}Hn.InitVelocityConstraints_s_P=new xt,Hn.SolveVelocityConstraints_s_Cdot1=new xt,Hn.SolveVelocityConstraints_s_impulse1=new xt,Hn.SolveVelocityConstraints_s_impulse=new St,Hn.SolveVelocityConstraints_s_P=new xt,Hn.SolvePositionConstraints_s_C1=new xt,Hn.SolvePositionConstraints_s_P=new xt,Hn.SolvePositionConstraints_s_impulse=new St;class jn extends vn{constructor(){super(t.b2JointType.e_wheelJoint),this.localAnchorA=new xt(0,0),this.localAnchorB=new xt(0,0),this.localAxisA=new xt(1,0),this.enableMotor=!1,this.maxMotorTorque=0,this.motorSpeed=0,this.frequencyHz=2,this.dampingRatio=.7}Initialize(t,e,i,n){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(i,this.localAnchorB),this.bodyA.GetLocalVector(n,this.localAxisA)}}class Wn extends xn{constructor(t){super(t),this.m_frequencyHz=0,this.m_dampingRatio=0,this.m_localAnchorA=new xt,this.m_localAnchorB=new xt,this.m_localXAxisA=new xt,this.m_localYAxisA=new xt,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new xt,this.m_localCenterB=new xt,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new xt,this.m_ay=new xt,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new Tt,this.m_qB=new Tt,this.m_lalcA=new xt,this.m_lalcB=new xt,this.m_rA=new xt,this.m_rB=new xt,this.m_frequencyHz=i(t.frequencyHz,2),this.m_dampingRatio=i(t.dampingRatio,.7),this.m_localAnchorA.Copy(i(t.localAnchorA,xt.ZERO)),this.m_localAnchorB.Copy(i(t.localAnchorB,xt.ZERO)),this.m_localXAxisA.Copy(i(t.localAxisA,xt.UNITX)),xt.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_maxMotorTorque=i(t.maxMotorTorque,0),this.m_motorSpeed=i(t.motorSpeed,0),this.m_enableMotor=i(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero()}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_frequencyHz=t}GetSpringFrequencyHz(){return this.m_frequencyHz}SetSpringDampingRatio(t){this.m_dampingRatio=t}GetSpringDampingRatio(){return this.m_dampingRatio}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.positions[this.m_indexA].c,a=t.positions[this.m_indexA].a,l=t.velocities[this.m_indexA].v;let c=t.velocities[this.m_indexA].w;const h=t.positions[this.m_indexB].c,_=t.positions[this.m_indexB].a,u=t.velocities[this.m_indexB].v;let m=t.velocities[this.m_indexB].w;const p=this.m_qA.SetAngle(a),d=this.m_qB.SetAngle(_);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const f=Tt.MulRV(p,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const g=Tt.MulRV(d,this.m_lalcB,this.m_rB),y=xt.SubVV(xt.AddVV(h,g,xt.s_t0),xt.AddVV(r,f,xt.s_t1),Wn.InitVelocityConstraints_s_d);if(Tt.MulRV(p,this.m_localYAxisA,this.m_ay),this.m_sAy=xt.CrossVV(xt.AddVV(y,f,xt.s_t0),this.m_ay),this.m_sBy=xt.CrossVV(g,this.m_ay),this.m_mass=e+i+n*this.m_sAy*this.m_sAy+s*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_frequencyHz>0){Tt.MulRV(p,this.m_localXAxisA,this.m_ax),this.m_sAx=xt.CrossVV(xt.AddVV(y,f,xt.s_t0),this.m_ax),this.m_sBx=xt.CrossVV(g,this.m_ax);const r=e+i+n*this.m_sAx*this.m_sAx+s*this.m_sBx*this.m_sBx;if(r>0){this.m_springMass=1/r;const e=xt.DotVV(y,this.m_ax),i=2*o*this.m_frequencyHz,n=2*this.m_springMass*this.m_dampingRatio*i,s=this.m_springMass*i*i,a=t.step.dt;this.m_gamma=a*(n+a*s),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*a*s*this.m_gamma,this.m_springMass=r+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}}else this.m_springImpulse=0;if(this.m_enableMotor?(this.m_motorMass=n+s,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=xt.AddVV(xt.MulSV(this.m_impulse,this.m_ay,xt.s_t0),xt.MulSV(this.m_springImpulse,this.m_ax,xt.s_t1),Wn.InitVelocityConstraints_s_P),i=this.m_impulse*this.m_sAy+this.m_springImpulse*this.m_sAx+this.m_motorImpulse,n=this.m_impulse*this.m_sBy+this.m_springImpulse*this.m_sBx+this.m_motorImpulse;l.SelfMulSub(this.m_invMassA,e),c-=this.m_invIA*i,u.SelfMulAdd(this.m_invMassB,e),m+=this.m_invIB*n}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0;t.velocities[this.m_indexA].w=c,t.velocities[this.m_indexB].w=m}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,n=this.m_invIA,s=this.m_invIB,r=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const a=t.velocities[this.m_indexB].v;let l=t.velocities[this.m_indexB].w;{const t=xt.DotVV(this.m_ax,xt.SubVV(a,r,xt.s_t0))+this.m_sBx*l-this.m_sAx*o,c=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=c;const h=xt.MulSV(c,this.m_ax,Wn.SolveVelocityConstraints_s_P),_=c*this.m_sAx,u=c*this.m_sBx;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),l+=s*u}{const e=l-o-this.m_motorSpeed;let i=-this.m_motorMass*e;const r=this.m_motorImpulse,a=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=it(this.m_motorImpulse+i,-a,a),i=this.m_motorImpulse-r,o-=n*i,l+=s*i}{const t=xt.DotVV(this.m_ay,xt.SubVV(a,r,xt.s_t0))+this.m_sBy*l-this.m_sAy*o,c=-this.m_mass*t;this.m_impulse+=c;const h=xt.MulSV(c,this.m_ay,Wn.SolveVelocityConstraints_s_P),_=c*this.m_sAy,u=c*this.m_sBy;r.SelfMulSub(e,h),o-=n*_,a.SelfMulAdd(i,h),l+=s*u}t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=l}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const n=t.positions[this.m_indexB].c;let s=t.positions[this.m_indexB].a;const r=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(s);xt.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const a=Tt.MulRV(r,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const l=Tt.MulRV(o,this.m_lalcB,this.m_rB),c=xt.AddVV(xt.SubVV(n,e,xt.s_t0),xt.SubVV(l,a,xt.s_t1),Wn.SolvePositionConstraints_s_d),h=Tt.MulRV(r,this.m_localYAxisA,this.m_ay),u=xt.CrossVV(xt.AddVV(c,a,xt.s_t0),h),m=xt.CrossVV(l,h),p=xt.DotVV(c,this.m_ay),d=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let f;f=0!==d?-p/d:0;const g=xt.MulSV(f,h,Wn.SolvePositionConstraints_s_P),y=f*u,v=f*m;return e.SelfMulSub(this.m_invMassA,g),i-=this.m_invIA*y,n.SelfMulAdd(this.m_invMassB,g),s+=this.m_invIB*v,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=s,Q(p)<=_}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+this.m_springImpulse*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+this.m_springImpulse*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new xt),n=e.GetWorldPoint(this.m_localAnchorB,new xt),s=xt.SubVV(n,i,new xt),r=t.GetWorldVector(this.m_localXAxisA,new xt);return xt.DotVV(s,r)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;xt.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Tt.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);xt.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const n=Tt.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),s=xt.AddVV(t.m_sweep.c,i,xt.s_t0),r=xt.AddVV(e.m_sweep.c,n,xt.s_t1),o=xt.SubVV(r,s,xt.s_t2),a=t.GetWorldVector(this.m_localXAxisA,new xt),l=t.m_linearVelocity,c=e.m_linearVelocity,h=t.m_angularVelocity,_=e.m_angularVelocity;return xt.DotVV(o,xt.CrossSV(h,a,xt.s_t0))+xt.DotVV(a,xt.SubVV(xt.AddVCrossSV(c,_,n,xt.s_t0),xt.AddVCrossSV(l,h,i,xt.s_t1),xt.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.frequencyHz = %.15f;\n",this.m_frequencyHz),t("  jd.dampingRatio = %.15f;\n",this.m_dampingRatio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}function qn(t,e){return at(t*e)}function Xn(t,e){return t>e?t:e}Wn.InitVelocityConstraints_s_d=new xt,Wn.InitVelocityConstraints_s_P=new xt,Wn.SolveVelocityConstraints_s_P=new xt,Wn.SolvePositionConstraints_s_d=new xt,Wn.SolvePositionConstraints_s_P=new xt;class Yn{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class Kn{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Yn(this),this.m_nodeB=new Yn(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new de,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_tangentSpeed=0,this.m_oldManifold=new de}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),n=this.GetShapeA(),s=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),n.m_radius,i.GetTransform(),s.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,n){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=n,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=qn(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=Xn(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const n=this.m_touchingFlag,s=this.m_fixtureA.IsSensor(),r=this.m_fixtureB.IsSensor(),o=s||r,a=this.m_fixtureA.GetBody(),l=this.m_fixtureB.GetBody(),c=a.GetTransform(),h=l.GetTransform();if(o){const t=this.GetShapeA(),e=this.GetShapeB();i=Ee(t,this.m_indexA,e,this.m_indexB,c,h),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,c,h),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const n=this.m_oldManifold.points[t];if(n.id.key===i.key){e.normalImpulse=n.normalImpulse,e.tangentImpulse=n.tangentImpulse;break}}}i!==n&&(a.SetAwake(!0),l.SetAwake(!0))}this.m_touchingFlag=i,!n&&i&&t&&t.BeginContact(this),n&&!i&&t&&t.EndContact(this),!o&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=Kn.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=_;const n=Kn.ComputeTOI_s_output;return ri(n,i),n.t}}Kn.ComputeTOI_s_input=new We,Kn.ComputeTOI_s_output=new Ye;class $n extends Kn{static Create(){return new $n}static Destroy(t){}Evaluate(t,e,i){li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Jn extends Kn{static Create(){return new Jn}static Destroy(t){}Evaluate(t,e,i){Li(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Zn extends Kn{static Create(){return new Zn}static Destroy(t){}Evaluate(t,e,i){ui(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Qn extends Kn{static Create(){return new Qn}static Destroy(t){}Evaluate(t,e,i){Wi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class ts extends Kn{static Create(){return new ts}static Destroy(t){}Evaluate(t,e,i){Qi(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class es extends Kn{static Create(){return new es}static Destroy(t){}Evaluate(t,e,i){const n=es.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Wi(t,n,e,this.GetShapeB(),i)}}es.Evaluate_s_edge=new cn;class is extends Kn{static Create(){return new is}static Destroy(t){}Evaluate(t,e,i){const n=is.Evaluate_s_edge;this.GetShapeA().GetChildEdge(n,this.m_indexA),Qi(t,n,e,this.GetShapeB(),i)}}is.Evaluate_s_edge=new cn;class ns{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class ss{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,n){const s=[];function r(){return s.pop()||t()}function o(t){s.push(t)}this.m_registers[i][n].pool=s,this.m_registers[i][n].createFcn=r,this.m_registers[i][n].destroyFcn=o,this.m_registers[i][n].primary=!0,i!==n&&(this.m_registers[n][i].pool=s,this.m_registers[n][i].createFcn=r,this.m_registers[n][i].destroyFcn=o,this.m_registers[n][i].primary=!1)}InitializeRegisters(){for(let e=0;e<t.b2ShapeType.e_shapeTypeCount;e++){this.m_registers[e]=[];for(let i=0;i<t.b2ShapeType.e_shapeTypeCount;i++)this.m_registers[e][i]=new ns}this.AddType($n.Create,$n.Destroy,t.b2ShapeType.e_circleShape,t.b2ShapeType.e_circleShape),this.AddType(Zn.Create,Zn.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_circleShape),this.AddType(Jn.Create,Jn.Destroy,t.b2ShapeType.e_polygonShape,t.b2ShapeType.e_polygonShape),this.AddType(Qn.Create,Qn.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_circleShape),this.AddType(ts.Create,ts.Destroy,t.b2ShapeType.e_edgeShape,t.b2ShapeType.e_polygonShape),this.AddType(es.Create,es.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_circleShape),this.AddType(is.Create,is.Destroy,t.b2ShapeType.e_chainShape,t.b2ShapeType.e_polygonShape)}Create(t,e,i,n){const s=t.GetType(),r=i.GetType(),o=this.m_registers[s][r];if(o.createFcn){const s=o.createFcn();return o.primary?s.Reset(t,e,i,n):s.Reset(i,n,t,e),s}return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),n=this.m_registers[e][i];n.destroyFcn&&n.destroyFcn(t)}}class rs{SayGoodbyeJoint(t){}SayGoodbyeFixture(t){}SayGoodbyeParticleGroup(t){}SayGoodbyeParticle(t,e){}}class os{ShouldCollide(e,i){const n=e.GetBody(),s=i.GetBody();if(s.GetType()===t.b2BodyType.b2_staticBody&&n.GetType()===t.b2BodyType.b2_staticBody)return!1;if(!s.ShouldCollideConnected(n))return!1;const r=e.GetFilterData(),o=i.GetFilterData();return r.groupIndex===o.groupIndex&&0!==r.groupIndex?r.groupIndex>0:0!=(r.maskBits&o.categoryBits)&&0!=(r.categoryBits&o.maskBits)}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}os.b2_defaultFilter=new os;class as{constructor(){this.normalImpulses=K(a),this.tangentImpulses=K(a),this.count=0}}class ls{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}ls.b2_defaultListener=new ls;class cs{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class hs{ReportFixture(t,e,i,n){return n}ReportParticle(t,e,i,n,s){return 0}ShouldQueryParticleSystem(t){return!0}}class _s{constructor(){this.m_broadPhase=new Ne,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=os.b2_defaultFilter,this.m_contactListener=ls.b2_defaultListener,this.m_contactFactory=new ss}AddPair(t,e){let i=t.fixture,n=e.fixture,s=t.childIndex,r=e.childIndex,o=i.GetBody(),a=n.GetBody();if(o===a)return;let l=a.GetContactList();for(;l;){if(l.other===o){const t=l.contact.GetFixtureA(),e=l.contact.GetFixtureB(),o=l.contact.GetChildIndexA(),a=l.contact.GetChildIndexB();if(t===i&&e===n&&o===s&&a===r)return;if(t===n&&e===i&&o===r&&a===s)return}l=l.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n))return;const c=this.m_contactFactory.Create(i,s,n,r);null!==c&&(i=c.GetFixtureA(),n=c.GetFixtureB(),s=c.GetChildIndexA(),r=c.GetChildIndexB(),o=i.m_body,a=n.m_body,c.m_prev=null,c.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=c),this.m_contactList=c,c.m_nodeA.other=a,c.m_nodeA.prev=null,c.m_nodeA.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=c.m_nodeA),o.m_contactList=c.m_nodeA,c.m_nodeB.other=o,c.m_nodeB.prev=null,c.m_nodeB.next=a.m_contactList,null!==a.m_contactList&&(a.m_contactList.prev=c.m_nodeB),a.m_contactList=c.m_nodeB,i.IsSensor()||n.IsSensor()||(o.SetAwake(!0),a.SetAwake(!0)),++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(((t,e)=>{this.AddPair(t,e)}))}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),n=e.GetBody(),s=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===n.m_contactList&&(n.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===s.m_contactList&&(s.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let e=this.m_contactList;for(;e;){const i=e.GetFixtureA(),n=e.GetFixtureB(),s=e.GetChildIndexA(),r=e.GetChildIndexB(),o=i.GetBody(),a=n.GetBody();if(e.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,n)){const t=e;e=t.m_next,this.Destroy(t);continue}e.m_filterFlag=!1}const l=o.IsAwake()&&o.m_type!==t.b2BodyType.b2_staticBody,c=a.IsAwake()&&a.m_type!==t.b2BodyType.b2_staticBody;if(!l&&!c){e=e.m_next;continue}const h=i.m_proxies[s].treeNode,_=n.m_proxies[r].treeNode;if(Se(h.aabb,_.aabb))e.Update(this.m_contactListener),e=e.m_next;else{const t=e;e=t.m_next,this.Destroy(t)}}}}class us{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class ms{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class ps{constructor(){this.c=new xt,this.a=0}static MakeArray(t){return X(t,(()=>new ps))}}class ds{constructor(){this.v=new xt,this.w=0}static MakeArray(t){return X(t,(()=>new ds))}}class fs{constructor(){this.step=new ms}}let gs=!1;class ys{constructor(){this.rA=new xt,this.rB=new xt,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return X(t,(()=>new ys))}}class vs{constructor(){this.points=ys.MakeArray(a),this.normal=new xt,this.tangent=new xt,this.normalMass=new At,this.K=new At,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return X(t,(()=>new vs))}}class xs{constructor(){this.localPoints=xt.MakeArray(a),this.localNormal=new xt,this.localPoint=new xt,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new xt,this.localCenterB=new xt,this.invIA=0,this.invIB=0,this.type=t.b2ManifoldType.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return X(t,(()=>new xs))}}class bs{constructor(){this.step=new ms,this.count=0}}class Ss{constructor(){this.normal=new xt,this.point=new xt,this.separation=0}Initialize(e,i,n,s){const r=Ss.Initialize_s_pointA,o=Ss.Initialize_s_pointB,a=Ss.Initialize_s_planePoint,l=Ss.Initialize_s_clipPoint;switch(e.type){case t.b2ManifoldType.e_circles:wt.MulXV(i,e.localPoint,r),wt.MulXV(n,e.localPoints[0],o),xt.SubVV(o,r,this.normal).SelfNormalize(),xt.MidVV(r,o,this.point),this.separation=xt.DotVV(xt.SubVV(o,r,xt.s_t0),this.normal)-e.radiusA-e.radiusB;break;case t.b2ManifoldType.e_faceA:Tt.MulRV(i.q,e.localNormal,this.normal),wt.MulXV(i,e.localPoint,a),wt.MulXV(n,e.localPoints[s],l),this.separation=xt.DotVV(xt.SubVV(l,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(l);break;case t.b2ManifoldType.e_faceB:Tt.MulRV(n.q,e.localNormal,this.normal),wt.MulXV(n,e.localPoint,a),wt.MulXV(i,e.localPoints[s],l),this.separation=xt.DotVV(xt.SubVV(l,a,xt.s_t0),this.normal)-e.radiusA-e.radiusB,this.point.Copy(l),this.normal.SelfNeg()}}}Ss.Initialize_s_pointA=new xt,Ss.Initialize_s_pointB=new xt,Ss.Initialize_s_planePoint=new xt,Ss.Initialize_s_clipPoint=new xt;class As{constructor(){this.m_step=new ms,this.m_positionConstraints=xs.MakeArray(1024),this.m_velocityConstraints=vs.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=et(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new xs}if(this.m_velocityConstraints.length<this.m_count){const t=et(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new vs}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,n=e.m_fixtureB,s=i.GetShape(),r=n.GetShape(),o=s.m_radius,a=r.m_radius,l=i.GetBody(),c=n.GetBody(),h=e.GetManifold(),_=h.pointCount,u=this.m_velocityConstraints[t];u.friction=e.m_friction,u.restitution=e.m_restitution,u.tangentSpeed=e.m_tangentSpeed,u.indexA=l.m_islandIndex,u.indexB=c.m_islandIndex,u.invMassA=l.m_invMass,u.invMassB=c.m_invMass,u.invIA=l.m_invI,u.invIB=c.m_invI,u.contactIndex=t,u.pointCount=_,u.K.SetZero(),u.normalMass.SetZero();const m=this.m_positionConstraints[t];m.indexA=l.m_islandIndex,m.indexB=c.m_islandIndex,m.invMassA=l.m_invMass,m.invMassB=c.m_invMass,m.localCenterA.Copy(l.m_sweep.localCenter),m.localCenterB.Copy(c.m_sweep.localCenter),m.invIA=l.m_invI,m.invIB=c.m_invI,m.localNormal.Copy(h.localNormal),m.localPoint.Copy(h.localPoint),m.pointCount=_,m.radiusA=o,m.radiusB=a,m.type=h.type;for(let t=0;t<_;++t){const e=h.points[t],i=u.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,m.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=As.InitializeVelocityConstraints_s_xfA,e=As.InitializeVelocityConstraints_s_xfB,i=As.InitializeVelocityConstraints_s_worldManifold,n=1e3;for(let s=0;s<this.m_count;++s){const r=this.m_velocityConstraints[s],o=this.m_positionConstraints[s],a=o.radiusA,l=o.radiusB,c=this.m_contacts[r.contactIndex].GetManifold(),h=r.indexA,_=r.indexB,u=r.invMassA,m=r.invMassB,p=r.invIA,d=r.invIB,g=o.localCenterA,y=o.localCenterB,v=this.m_positions[h].c,x=this.m_positions[h].a,b=this.m_velocities[h].v,S=this.m_velocities[h].w,A=this.m_positions[_].c,C=this.m_positions[_].a,T=this.m_velocities[_].v,w=this.m_velocities[_].w;t.q.SetAngle(x),e.q.SetAngle(C),xt.SubVV(v,Tt.MulRV(t.q,g,xt.s_t0),t.p),xt.SubVV(A,Tt.MulRV(e.q,y,xt.s_t0),e.p),i.Initialize(c,t,a,e,l),r.normal.Copy(i.normal),xt.CrossVOne(r.normal,r.tangent);const E=r.pointCount;for(let t=0;t<E;++t){const e=r.points[t];xt.SubVV(i.points[t],v,e.rA),xt.SubVV(i.points[t],A,e.rB);const n=xt.CrossVV(e.rA,r.normal),s=xt.CrossVV(e.rB,r.normal),o=u+m+p*n*n+d*s*s;e.normalMass=o>0?1/o:0;const a=r.tangent,l=xt.CrossVV(e.rA,a),c=xt.CrossVV(e.rB,a),h=u+m+p*l*l+d*c*c;e.tangentMass=h>0?1/h:0,e.velocityBias=0;const _=xt.DotVV(r.normal,xt.SubVV(xt.AddVCrossSV(T,w,e.rB,xt.s_t0),xt.AddVCrossSV(b,S,e.rA,xt.s_t1),xt.s_t0));_<-f&&(e.velocityBias+=-r.restitution*_)}if(2===r.pointCount&&gs){const t=r.points[0],e=r.points[1],i=xt.CrossVV(t.rA,r.normal),s=xt.CrossVV(t.rB,r.normal),o=xt.CrossVV(e.rA,r.normal),a=xt.CrossVV(e.rB,r.normal),l=u+m+p*i*i+d*s*s,c=u+m+p*o*o+d*a*a,h=u+m+p*i*o+d*s*a;l*l<n*(l*c-h*h)?(r.K.ex.Set(l,h),r.K.ey.Set(h,c),r.K.GetInverse(r.normalMass)):r.pointCount=1}}}WarmStart(){const t=As.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],n=i.indexA,s=i.indexB,r=i.invMassA,o=i.invIA,a=i.invMassB,l=i.invIB,c=i.pointCount,h=this.m_velocities[n].v;let _=this.m_velocities[n].w;const u=this.m_velocities[s].v;let m=this.m_velocities[s].w;const p=i.normal,d=i.tangent;for(let e=0;e<c;++e){const n=i.points[e];xt.AddVV(xt.MulSV(n.normalImpulse,p,xt.s_t0),xt.MulSV(n.tangentImpulse,d,xt.s_t1),t),_-=o*xt.CrossVV(n.rA,t),h.SelfMulSub(r,t),m+=l*xt.CrossVV(n.rB,t),u.SelfMulAdd(a,t)}this.m_velocities[n].w=_,this.m_velocities[s].w=m}}SolveVelocityConstraints(){const t=As.SolveVelocityConstraints_s_dv,e=As.SolveVelocityConstraints_s_dv1,i=As.SolveVelocityConstraints_s_dv2,n=As.SolveVelocityConstraints_s_P,s=As.SolveVelocityConstraints_s_a,r=As.SolveVelocityConstraints_s_b,o=As.SolveVelocityConstraints_s_x,a=As.SolveVelocityConstraints_s_d,l=As.SolveVelocityConstraints_s_P1,c=As.SolveVelocityConstraints_s_P2,h=As.SolveVelocityConstraints_s_P1P2;for(let _=0;_<this.m_count;++_){const u=this.m_velocityConstraints[_],m=u.indexA,p=u.indexB,d=u.invMassA,f=u.invIA,g=u.invMassB,y=u.invIB,v=u.pointCount,x=this.m_velocities[m].v;let b=this.m_velocities[m].w;const S=this.m_velocities[p].v;let A=this.m_velocities[p].w;const C=u.normal,T=u.tangent,w=u.friction;for(let e=0;e<v;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(S,A,i.rB,xt.s_t0),xt.AddVCrossSV(x,b,i.rA,xt.s_t1),t);const s=xt.DotVV(t,T)-u.tangentSpeed;let r=i.tangentMass*-s;const o=w*i.normalImpulse,a=it(i.tangentImpulse+r,-o,o);r=a-i.tangentImpulse,i.tangentImpulse=a,xt.MulSV(r,T,n),x.SelfMulSub(d,n),b-=f*xt.CrossVV(i.rA,n),S.SelfMulAdd(g,n),A+=y*xt.CrossVV(i.rB,n)}if(1===u.pointCount||!1===gs)for(let e=0;e<v;++e){const i=u.points[e];xt.SubVV(xt.AddVCrossSV(S,A,i.rB,xt.s_t0),xt.AddVCrossSV(x,b,i.rA,xt.s_t1),t);const s=xt.DotVV(t,C);let r=-i.normalMass*(s-i.velocityBias);const o=et(i.normalImpulse+r,0);r=o-i.normalImpulse,i.normalImpulse=o,xt.MulSV(r,C,n),x.SelfMulSub(d,n),b-=f*xt.CrossVV(i.rA,n),S.SelfMulAdd(g,n),A+=y*xt.CrossVV(i.rB,n)}else{const t=u.points[0],n=u.points[1];s.Set(t.normalImpulse,n.normalImpulse),xt.SubVV(xt.AddVCrossSV(S,A,t.rB,xt.s_t0),xt.AddVCrossSV(x,b,t.rA,xt.s_t1),e),xt.SubVV(xt.AddVCrossSV(S,A,n.rB,xt.s_t0),xt.AddVCrossSV(x,b,n.rA,xt.s_t1),i);let _=xt.DotVV(e,C),m=xt.DotVV(i,C);for(r.x=_-t.velocityBias,r.y=m-n.velocityBias,r.SelfSub(At.MulMV(u.K,s,xt.s_t0));;){if(At.MulMV(u.normalMass,r,o).SelfNeg(),o.x>=0&&o.y>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,C,l),xt.MulSV(a.y,C,c),xt.AddVV(l,c,h),x.SelfMulSub(d,h),b-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),S.SelfMulAdd(g,h),A+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=-t.normalMass*r.x,o.y=0,_=0,m=u.K.ex.y*o.x+r.y,o.x>=0&&m>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,C,l),xt.MulSV(a.y,C,c),xt.AddVV(l,c,h),x.SelfMulSub(d,h),b-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),S.SelfMulAdd(g,h),A+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=-n.normalMass*r.y,_=u.K.ey.x*o.y+r.x,m=0,o.y>=0&&_>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,C,l),xt.MulSV(a.y,C,c),xt.AddVV(l,c,h),x.SelfMulSub(d,h),b-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),S.SelfMulAdd(g,h),A+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}if(o.x=0,o.y=0,_=r.x,m=r.y,_>=0&&m>=0){xt.SubVV(o,s,a),xt.MulSV(a.x,C,l),xt.MulSV(a.y,C,c),xt.AddVV(l,c,h),x.SelfMulSub(d,h),b-=f*(xt.CrossVV(t.rA,l)+xt.CrossVV(n.rA,c)),S.SelfMulAdd(g,h),A+=y*(xt.CrossVV(t.rB,l)+xt.CrossVV(n.rB,c)),t.normalImpulse=o.x,n.normalImpulse=o.y;break}break}}this.m_velocities[m].w=b,this.m_velocities[p].w=A}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=As.SolvePositionConstraints_s_xfA,e=As.SolvePositionConstraints_s_xfB,i=As.SolvePositionConstraints_s_psm,n=As.SolvePositionConstraints_s_rA,s=As.SolvePositionConstraints_s_rB,r=As.SolvePositionConstraints_s_P;let o=0;for(let a=0;a<this.m_count;++a){const l=this.m_positionConstraints[a],c=l.indexA,h=l.indexB,u=l.localCenterA,m=l.invMassA,p=l.invIA,d=l.localCenterB,f=l.invMassB,y=l.invIB,v=l.pointCount,x=this.m_positions[c].c;let b=this.m_positions[c].a;const S=this.m_positions[h].c;let C=this.m_positions[h].a;for(let a=0;a<v;++a){t.q.SetAngle(b),e.q.SetAngle(C),xt.SubVV(x,Tt.MulRV(t.q,u,xt.s_t0),t.p),xt.SubVV(S,Tt.MulRV(e.q,d,xt.s_t0),e.p),i.Initialize(l,t,e,a);const c=i.normal,h=i.point,v=i.separation;xt.SubVV(h,x,n),xt.SubVV(h,S,s),o=tt(o,v);const T=it(A*(v+_),-g,0),w=xt.CrossVV(n,c),E=xt.CrossVV(s,c),P=m+f+p*w*w+y*E*E,D=P>0?-T/P:0;xt.MulSV(D,c,r),x.SelfMulSub(m,r),b-=p*xt.CrossVV(n,r),S.SelfMulAdd(f,r),C+=y*xt.CrossVV(s,r)}this.m_positions[c].a=b,this.m_positions[h].a=C}return o>-3*_}SolveTOIPositionConstraints(t,e){const i=As.SolveTOIPositionConstraints_s_xfA,n=As.SolveTOIPositionConstraints_s_xfB,s=As.SolveTOIPositionConstraints_s_psm,r=As.SolveTOIPositionConstraints_s_rA,o=As.SolveTOIPositionConstraints_s_rB,a=As.SolveTOIPositionConstraints_s_P;let l=0;for(let c=0;c<this.m_count;++c){const h=this.m_positionConstraints[c],u=h.indexA,m=h.indexB,p=h.localCenterA,d=h.localCenterB,f=h.pointCount;let y=0,v=0;u!==t&&u!==e||(y=h.invMassA,v=h.invIA);let x=0,b=0;m!==t&&m!==e||(x=h.invMassB,b=h.invIB);const S=this.m_positions[u].c;let A=this.m_positions[u].a;const T=this.m_positions[m].c;let w=this.m_positions[m].a;for(let t=0;t<f;++t){i.q.SetAngle(A),n.q.SetAngle(w),xt.SubVV(S,Tt.MulRV(i.q,p,xt.s_t0),i.p),xt.SubVV(T,Tt.MulRV(n.q,d,xt.s_t0),n.p),s.Initialize(h,i,n,t);const e=s.normal,c=s.point,u=s.separation;xt.SubVV(c,S,r),xt.SubVV(c,T,o),l=tt(l,u);const m=it(C*(u+_),-g,0),f=xt.CrossVV(r,e),E=xt.CrossVV(o,e),P=y+x+v*f*f+b*E*E,D=P>0?-m/P:0;xt.MulSV(D,e,a),S.SelfMulSub(y,a),A-=v*xt.CrossVV(r,a),T.SelfMulAdd(x,a),w+=b*xt.CrossVV(o,a)}this.m_positions[u].a=A,this.m_positions[m].a=w}return l>=-1.5*_}}As.InitializeVelocityConstraints_s_xfA=new wt,As.InitializeVelocityConstraints_s_xfB=new wt,As.InitializeVelocityConstraints_s_worldManifold=new fe,As.WarmStart_s_P=new xt,As.SolveVelocityConstraints_s_dv=new xt,As.SolveVelocityConstraints_s_dv1=new xt,As.SolveVelocityConstraints_s_dv2=new xt,As.SolveVelocityConstraints_s_P=new xt,As.SolveVelocityConstraints_s_a=new xt,As.SolveVelocityConstraints_s_b=new xt,As.SolveVelocityConstraints_s_x=new xt,As.SolveVelocityConstraints_s_d=new xt,As.SolveVelocityConstraints_s_P1=new xt,As.SolveVelocityConstraints_s_P2=new xt,As.SolveVelocityConstraints_s_P1P2=new xt,As.SolvePositionConstraints_s_xfA=new wt,As.SolvePositionConstraints_s_xfB=new wt,As.SolvePositionConstraints_s_psm=new Ss,As.SolvePositionConstraints_s_rA=new xt,As.SolvePositionConstraints_s_rB=new xt,As.SolvePositionConstraints_s_P=new xt,As.SolveTOIPositionConstraints_s_xfA=new wt,As.SolveTOIPositionConstraints_s_xfB=new wt,As.SolveTOIPositionConstraints_s_psm=new Ss,As.SolveTOIPositionConstraints_s_rA=new xt,As.SolveTOIPositionConstraints_s_rB=new xt,As.SolveTOIPositionConstraints_s_P=new xt;class Cs{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=ps.MakeArray(1024),this.m_velocities=ds.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,n){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=n,this.m_positions.length<t){const e=et(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new ps}if(this.m_velocities.length<t){const e=et(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new ds}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(e,i,s,r){const o=Cs.s_timer.Reset(),a=i.dt;for(let e=0;e<this.m_bodyCount;++e){const i=this.m_bodies[e];this.m_positions[e].c.Copy(i.m_sweep.c);const n=i.m_sweep.a,r=this.m_velocities[e].v.Copy(i.m_linearVelocity);let o=i.m_angularVelocity;i.m_sweep.c0.Copy(i.m_sweep.c),i.m_sweep.a0=i.m_sweep.a,i.m_type===t.b2BodyType.b2_dynamicBody&&(r.x+=a*(i.m_gravityScale*s.x+i.m_invMass*i.m_force.x),r.y+=a*(i.m_gravityScale*s.y+i.m_invMass*i.m_force.y),o+=a*i.m_invI*i.m_torque,r.SelfMul(1/(1+a*i.m_linearDamping)),o*=1/(1+a*i.m_angularDamping)),this.m_positions[e].a=n,this.m_velocities[e].w=o}o.Reset();const l=Cs.s_solverData;l.step.Copy(i),l.positions=this.m_positions,l.velocities=this.m_velocities;const c=Cs.s_contactSolverDef;c.step.Copy(i),c.contacts=this.m_contacts,c.count=this.m_contactCount,c.positions=this.m_positions,c.velocities=this.m_velocities;const h=Cs.s_contactSolver.Initialize(c);h.InitializeVelocityConstraints(),i.warmStarting&&h.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(l);e.solveInit=o.GetMilliseconds(),o.Reset();for(let t=0;t<i.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(l);h.SolveVelocityConstraints()}h.StoreImpulses(),e.solveVelocity=o.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const r=xt.MulSV(a,n,Cs.s_translation);if(xt.DotVV(r,r)>x){const t=v/r.Length();n.SelfMul(t)}const o=a*s;o*o>S&&(s*=b/Q(o)),e.x+=a*n.x,e.y+=a*n.y,i+=a*s,this.m_positions[t].a=i,this.m_velocities[t].w=s}o.Reset();let _=!1;for(let t=0;t<i.positionIterations;++t){const t=h.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(l);e=e&&i}if(t&&e){_=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(e.solvePosition=o.GetMilliseconds(),this.Report(h.m_velocityConstraints),r){let e=n;const i=L*L,s=F*F;for(let n=0;n<this.m_bodyCount;++n){const r=this.m_bodies[n];r.GetType()!==t.b2BodyType.b2_staticBody&&(!r.m_autoSleepFlag||r.m_angularVelocity*r.m_angularVelocity>s||xt.DotVV(r.m_linearVelocity,r.m_linearVelocity)>i?(r.m_sleepTime=0,e=0):(r.m_sleepTime+=a,e=tt(e,r.m_sleepTime)))}if(e>=N&&_)for(let t=0;t<this.m_bodyCount;++t)this.m_bodies[t].SetAwake(!1)}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const n=Cs.s_contactSolverDef;n.contacts=this.m_contacts,n.count=this.m_contactCount,n.step.Copy(t),n.positions=this.m_positions,n.velocities=this.m_velocities;const s=Cs.s_contactSolver.Initialize(n);for(let n=0;n<t.positionIterations&&!s.SolveTOIPositionConstraints(e,i);++n);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,s.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)s.SolveVelocityConstraints();const r=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const n=this.m_velocities[t].v;let s=this.m_velocities[t].w;const o=xt.MulSV(r,n,Cs.s_translation);if(xt.DotVV(o,o)>x){const t=v/o.Length();n.SelfMul(t)}const a=r*s;a*a>S&&(s*=b/Q(a)),e.SelfMulAdd(r,n),i+=r*s,this.m_positions[t].a=i,this.m_velocities[t].w=s;const l=this.m_bodies[t];l.m_sweep.c.Copy(e),l.m_sweep.a=i,l.m_linearVelocity.Copy(n),l.m_angularVelocity=s,l.SynchronizeTransform()}this.Report(s.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const n=t[e],s=Cs.s_impulse;s.count=n.pointCount;for(let t=0;t<n.pointCount;++t)s.normalImpulses[t]=n.points[t].normalImpulse,s.tangentImpulses[t]=n.points[t].tangentImpulse;this.m_listener.PostSolve(i,s)}}}var Ts,ws;Cs.s_timer=new Rt,Cs.s_solverData=new fs,Cs.s_contactSolverDef=new bs,Cs.s_contactSolver=new As,Cs.s_translation=new xt,Cs.s_impulse=new as,(Ts=t.b2ParticleFlag||(t.b2ParticleFlag={}))[Ts.b2_waterParticle=0]="b2_waterParticle",Ts[Ts.b2_zombieParticle=2]="b2_zombieParticle",Ts[Ts.b2_wallParticle=4]="b2_wallParticle",Ts[Ts.b2_springParticle=8]="b2_springParticle",Ts[Ts.b2_elasticParticle=16]="b2_elasticParticle",Ts[Ts.b2_viscousParticle=32]="b2_viscousParticle",Ts[Ts.b2_powderParticle=64]="b2_powderParticle",Ts[Ts.b2_tensileParticle=128]="b2_tensileParticle",Ts[Ts.b2_colorMixingParticle=256]="b2_colorMixingParticle",Ts[Ts.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",Ts[Ts.b2_barrierParticle=1024]="b2_barrierParticle",Ts[Ts.b2_staticPressureParticle=2048]="b2_staticPressureParticle",Ts[Ts.b2_reactiveParticle=4096]="b2_reactiveParticle",Ts[Ts.b2_repulsiveParticle=8192]="b2_repulsiveParticle",Ts[Ts.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",Ts[Ts.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",Ts[Ts.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",Ts[Ts.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle";class Es{constructor(){this.flags=0,this.position=new xt,this.velocity=new xt,this.color=new Pt(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}function Ps(t,e,i){const n=8,s=.01;return it(Math.ceil(Math.sqrt(t/(s*e))*i),1,n)}class Ds{constructor(){this.m_index=T}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}(ws=t.b2ParticleGroupFlag||(t.b2ParticleGroupFlag={}))[ws.b2_solidParticleGroup=1]="b2_solidParticleGroup",ws[ws.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",ws[ws.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",ws[ws.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",ws[ws.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",ws[ws.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask";class Is{constructor(){this.flags=0,this.groupFlags=0,this.position=new xt,this.angle=0,this.linearVelocity=new xt,this.angularVelocity=0,this.color=new Pt,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class Rs{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new xt,this.m_linearVelocity=new xt,this.m_angularVelocity=0,this.m_transform=new wt,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(e){e|=this.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,e)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=Rs.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),xt.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,xt.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new xt,e=new xt;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[t]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[t]);if(this.m_mass>0){const t=1/this.m_mass;this.m_center.SelfMul(t),this.m_linearVelocity.SelfMul(t)}this.m_inertia=0,this.m_angularVelocity=0;for(let n=this.m_firstIndex;n<this.m_lastIndex;n++)xt.SubVV(this.m_system.m_positionBuffer.data[n],this.m_center,t),xt.SubVV(this.m_system.m_velocityBuffer.data[n],this.m_linearVelocity,e),this.m_inertia+=i*xt.DotVV(t,t),this.m_angularVelocity+=i*xt.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}Rs.GetLinearVelocityFromWorldPoint_s_t0=new xt;class Ms{constructor(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}get m_capacity(){return this.m_buffer.length}Push(t){if(this.m_back>=this.m_capacity){for(let t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class Os{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=X(t,(()=>new Bs)),this.m_generatorCapacity=t}AddGenerator(t,e,i){const n=this.m_generatorBuffer[this.m_generatorCount++];n.center.Copy(t),n.tag=e,n.necessary=i}Generate(t,e){const i=1/t,s=new xt(+n,+n),r=new xt(-n,-n);let o=0;for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.necessary&&(xt.MinV(s,e.center,s),xt.MaxV(r,e.center,r),++o)}if(0===o)return this.m_countX=0,void(this.m_countY=0);s.x-=e,s.y-=e,r.x+=e,r.y+=e,this.m_countX=1+Math.floor(i*(r.x-s.x)),this.m_countY=1+Math.floor(i*(r.y-s.y)),this.m_diagram=[];const a=new Ms(4*this.m_countX*this.m_countY);for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.center.SelfSub(s).SelfMul(i);const n=Math.floor(e.center.x),r=Math.floor(e.center.y);n>=0&&r>=0&&n<this.m_countX&&r<this.m_countY&&a.Push(new Ns(n,r,n+r*this.m_countX,e))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop(),this.m_diagram[n]||(this.m_diagram[n]=s,e>0&&a.Push(new Ns(e-1,i,n-1,s)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,s)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,s)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,s)))}for(let t=0;t<this.m_countY;t++)for(let e=0;e<this.m_countX-1;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+1];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e+1,t,i+1,n)))}for(let t=0;t<this.m_countY-1;t++)for(let e=0;e<this.m_countX;e++){const i=e+t*this.m_countX,n=this.m_diagram[i],s=this.m_diagram[i+this.m_countX];n!==s&&(a.Push(new Ns(e,t,i,s)),a.Push(new Ns(e,t+1,i+this.m_countX,n)))}for(;!a.Empty();){const t=a.Front(),e=t.m_x,i=t.m_y,n=t.m_i,s=t.m_generator;a.Pop();const r=this.m_diagram[n],o=s;if(r!==o){const t=r.center.x-e,s=r.center.y-i,l=o.center.x-e,c=o.center.y-i;t*t+s*s>l*l+c*c&&(this.m_diagram[n]=o,e>0&&a.Push(new Ns(e-1,i,n-1,o)),i>0&&a.Push(new Ns(e,i-1,n-this.m_countX,o)),e<this.m_countX-1&&a.Push(new Ns(e+1,i,n+1,o)),i<this.m_countY-1&&a.Push(new Ns(e,i+1,n+this.m_countX,o)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const n=i+e*this.m_countX,s=this.m_diagram[n],r=this.m_diagram[n+1],o=this.m_diagram[n+this.m_countX],a=this.m_diagram[n+1+this.m_countX];r!==o&&(s!==r&&s!==o&&(s.necessary||r.necessary||o.necessary)&&t(s.tag,r.tag,o.tag),a!==r&&a!==o&&(s.necessary||r.necessary||o.necessary)&&t(r.tag,a.tag,o.tag))}}}class Bs{constructor(){this.center=new xt,this.tag=0,this.necessary=!1}}class Ns{constructor(t,e,i,n){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=n}}function Ls(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function Fs(t,e){return t<e}function zs(t,e=0,i=t.length-e,n=Fs){let s=e;const r=[];let o=0;for(;;){for(;s+1<i;i++){const e=t[s+Math.floor(Math.random()*(i-s))];r[o++]=i;for(let r=s-1;;){for(;n(t[++r],e););for(;n(e,t[--i]););if(r>=i)break;Ls(t,r,i)}}if(0===o)break;s=i,i=r[--o]}return t}function Vs(t,e=0,i=t.length-e,n=Fs){return zs(t,e,i,n)}function Us(t,e,i=t.length){let n=0;for(let s=0;s<i;++s)e(t[s])||(s!==n?Ls(t,n++,s):++n);return n}function Gs(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(t[o],n)?(e=++o,r-=i+1):r=i}return e}function ks(t,e,i,n,s){let r=i-e;for(;r>0;){const i=Math.floor(r/2);let o=e+i;s(n,t[o])?r=i:(e=++o,r-=i+1)}return e}function Hs(t,e,i,n){let s=i;for(;e!==s;)Ls(t,e++,s++),s===n?s=i:e===i&&(i=s)}function js(t,e,i,n){if(e===i)return i;let s=e;for(;++e!==i;)n(t[s],t[e])||Ls(t,++s,e);return++s}class Ws{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:O;this.Reserve(t)}Free(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=Us(this.data,t,this.count)}Unique(t){this.count=js(this.data,0,this.count,t)}}class qs extends cs{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const e=t.GetShape().GetChildCount();for(let i=0;i<e;i++){const e=t.GetAABB(i),n=this.m_system.GetInsideBoundsEnumerator(e);let s;for(;(s=n.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,s)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class Xs{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new xt,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){const e=.01,i=1e-4;return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&Q(this.weight-t.weight)<e&&xt.DistanceSquaredVV(this.normal,t.normal)<i}}class Ys{constructor(){this.index=0,this.weight=0,this.normal=new xt,this.mass=0}}class Ks{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class $s{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new xt(0,0),this.pb=new xt(0,0),this.pc=new xt(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class Js{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return(new Js).Copy(this)}}class Zs{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new Qs,this.m_flagsBuffer=new Qs,this.m_positionBuffer=new Qs,this.m_velocityBuffer=new Qs,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new Qs,this.m_groupBuffer=[],this.m_userDataBuffer=new Qs,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new Qs,this.m_bodyContactCountBuffer=new Qs,this.m_consecutiveContactStepsBuffer=new Qs,this.m_stuckParticleBuffer=new Ws((()=>0)),this.m_proxyBuffer=new Ws((()=>new tr)),this.m_contactBuffer=new Ws((()=>new Xs)),this.m_bodyContactBuffer=new Ws((()=>new Ys)),this.m_pairBuffer=new Ws((()=>new Ks)),this.m_triadBuffer=new Ws((()=>new $s)),this.m_expirationTimeBuffer=new Qs,this.m_indexByExpirationTimeBuffer=new Qs,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new Js,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+Zs.yOffset>>>0<<Zs.yShift)+(Zs.xScale*t+Zs.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<Zs.yShift)+(e<<Zs.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const t=this.m_count?2*this.m_count:O;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return T;this.DestroyOldestParticle(0,!1),this.SolveZombie()}const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new xt).Copy(i(t.position,xt.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new xt).Copy(i(t.velocity,xt.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new xt).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const n=(new Pt).Copy(i(t.color,Pt.ZERO));!this.m_colorBuffer.data&&n.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new Pt).Copy(n)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const s=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],r=i(t.lifetime,0),o=r>0;(this.m_expirationTimeBuffer.data||o)&&(this.SetParticleLifetime(e,o?r:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),s.index=e;const a=i(t.group,null);return this.m_groupBuffer[e]=a,a&&(a.m_firstIndex<a.m_lastIndex?(this.RotateBuffer(a.m_firstIndex,a.m_lastIndex,e),a.m_lastIndex=e+1):(a.m_firstIndex=e,a.m_lastIndex=e+1)),this.SetParticleFlags(e,i(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new Ds,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(e,i=!1){let n=t.b2ParticleFlag.b2_zombieParticle;i&&(n|=t.b2ParticleFlag.b2_destructionListenerParticle),this.SetParticleFlags(e,this.m_flagsBuffer.data[e]|n)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],s=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[n]>0?n:s,e)}DestroyParticlesInShape(t,e,i=!1){const n=Zs.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const s=new cr(this,t,e,i),r=n;return t.ComputeAABB(r,e,0),this.m_world.QueryAABB(s,r),s.Destroyed()}CreateParticleGroup(t){const e=Zs.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const n=e;n.SetPositionAngle(i(t.position,xt.ZERO),i(t.angle,0));const s=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,n),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,i(t.shapeCount,t.shapes.length),t,n),t.positionData){const e=i(t.particleCount,t.positionData.length);for(let i=0;i<e;i++){const e=t.positionData[i];this.CreateParticleForGroup(t,n,e)}}const r=this.m_count;let o=new Rs(this);o.m_firstIndex=s,o.m_lastIndex=r,o.m_strength=i(t.strength,1),o.m_userData=t.userData,o.m_transform.Copy(n),o.m_prev=null,o.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=o),this.m_groupList=o,++this.m_groupCount;for(let t=s;t<r;t++)this.m_groupBuffer[t]=o;this.SetGroupFlags(o,i(t.groupFlags,0));const a=new lr;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,r,a),t.group&&(this.JoinParticleGroups(t.group,o),o=t.group),o}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new hr(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;const n=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,n),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=X(t.GetParticleCount(),(()=>new ir));Zs.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);const i=Zs.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(e,i){this.m_flagsBuffer.data[e]&~i&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&i&&(i&t.b2ParticleFlag.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),i&t.b2ParticleFlag.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=i),this.m_flagsBuffer.data[e]=i}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let n=0;n<e;++n)i[n]=new xt(t.subarray(2*n,2*n+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;const e=t.length/4,i=new Array(e);for(let n=0;n<e;++n)i[n]=new Pt(t.subarray(4*n,4*n+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=Zs.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=s.normal,l=xt.SubVV(e[o],e[r],t),c=xt.DotVV(l,a);c<0&&(i+=c*c)}return.5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const t=this.GetParticleCount();for(let e=0;e<t;++e)this.m_indexByExpirationTimeBuffer.data[e]=e}const n=e/this.m_def.lifetimeGranularity,s=n>0?this.GetQuantizedTimeElapsed()+n:n;s!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=s,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const n=this.m_velocityBuffer.data,s=(e-t)*this.GetParticleMass(),r=(new xt).Copy(i).SelfMul(1/s);for(let i=t;i<e;i++)n[i].SelfAdd(r)}static IsSignificantForce(t){return 0!==t.x||0!==t.y}ParticleApplyForce(t,e){Zs.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const n=(new xt).Copy(i).SelfMul(1/(e-t));if(Zs.IsSignificantForce(n)){this.PrepareForceBuffer();for(let i=t;i<e;i++)this.m_forceBuffer[i].SelfAdd(n)}}GetNext(){return this.m_next}QueryAABB(t,e){if(0===this.m_proxyBuffer.count)return;const i=0,n=this.m_proxyBuffer.count,s=Gs(this.m_proxyBuffer.data,i,n,Zs.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),tr.CompareProxyTag),r=ks(this.m_proxyBuffer.data,s,n,Zs.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),tr.CompareTagProxy),o=this.m_positionBuffer.data;for(let i=s;i<r;++i){const n=this.m_proxyBuffer.data[i].index,s=o[n];if(e.lowerBound.x<s.x&&s.x<e.upperBound.x&&e.lowerBound.y<s.y&&s.y<e.upperBound.y&&!t.ReportParticle(this,n))break}}QueryShapeAABB(t,e,i,n=0){const s=Zs.QueryShapeAABB_s_aabb;e.ComputeAABB(s,i,n),this.QueryAABB(t,s)}QueryPointAABB(t,e,i=_){const n=Zs.QueryPointAABB_s_aabb;n.lowerBound.Set(e.x-i,e.y-i),n.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,n)}RayCast(t,e,i){const n=Zs.RayCast_s_aabb,s=Zs.RayCast_s_p,r=Zs.RayCast_s_v,o=Zs.RayCast_s_n,a=Zs.RayCast_s_point;if(0===this.m_proxyBuffer.count)return;const l=this.m_positionBuffer.data,c=n;xt.MinV(e,i,c.lowerBound),xt.MaxV(e,i,c.upperBound);let h=1;const _=xt.SubVV(i,e,r),u=xt.DotVV(_,_),m=this.GetInsideBoundsEnumerator(c);let p;for(;(p=m.GetNext())>=0;){const i=xt.SubVV(e,l[p],s),n=xt.DotVV(i,_),r=n*n-u*(xt.DotVV(i,i)-this.m_squaredDiameter);if(r>=0){const s=at(r);let l=(-n-s)/u;if(l>h)continue;if(l<0&&(l=(-n+s)/u,l<0||l>h))continue;const c=xt.AddVMulSV(i,l,_,o);if(c.Normalize(),h=tt(h,t.ReportParticle(this,p,xt.AddVMulSV(e,l,_,a),c,l)),h<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;const i=this.m_positionBuffer.data;for(let n=0;n<e;n++){const e=i[n];xt.MinV(t.lowerBound,e,t.lowerBound),xt.MaxV(t.upperBound,e,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){null!==t&&(t.length=0)}FreeUserOverridableBuffer(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const n=t?t.slice():[];return n.length=i,n}ReallocateBuffer5(t,e,i,n,s){if(n<=i)throw new Error;if(e&&!(n<=e))throw new Error;return s&&!t||e||(t=this.ReallocateBuffer3(t,i,n)),t}ReallocateBuffer4(t,e,i,n){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,n)}RequestBuffer(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(O),(t=[]).length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const e=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,e),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,e),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,e),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,n){const s=new Es;s.flags=i(t.flags,0),wt.MulXV(e,n,s.position),xt.AddVV(i(t.linearVelocity,xt.ZERO),xt.CrossSV(i(t.angularVelocity,0),xt.SubVV(s.position,i(t.position,xt.ZERO),xt.s_t0),xt.s_t0),s.velocity),s.color.Copy(i(t.color,Pt.ZERO)),s.lifetime=i(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)}CreateParticlesStrokeShapeForGroup(e,n,s){const r=Zs.CreateParticlesStrokeShapeForGroup_s_edge,o=Zs.CreateParticlesStrokeShapeForGroup_s_d,a=Zs.CreateParticlesStrokeShapeForGroup_s_p;let l=i(n.stride,0);0===l&&(l=this.GetParticleStride());let c=0;const h=e.GetChildCount();for(let i=0;i<h;i++){let h=null;e.GetType()===t.b2ShapeType.e_edgeShape?h=e:(h=r,e.GetChildEdge(h,i));const _=xt.SubVV(h.m_vertex2,h.m_vertex1,o),u=_.Length();for(;c<u;){const t=xt.AddVMulSV(h.m_vertex1,c/u,_,a);this.CreateParticleForGroup(n,s,t),c+=l}c-=u}}CreateParticlesFillShapeForGroup(t,e,n){const s=Zs.CreateParticlesFillShapeForGroup_s_aabb,r=Zs.CreateParticlesFillShapeForGroup_s_p;let o=i(e.stride,0);0===o&&(o=this.GetParticleStride());const a=wt.IDENTITY,l=s;t.ComputeAABB(l,a,0);for(let i=Math.floor(l.lowerBound.y/o)*o;i<l.upperBound.y;i+=o)for(let s=Math.floor(l.lowerBound.x/o)*o;s<l.upperBound.x;s+=o){const o=r.Set(s,i);t.TestPoint(a,o)&&this.CreateParticleForGroup(e,n,o)}}CreateParticlesWithShapeForGroup(e,i,n){switch(e.GetType()){case t.b2ShapeType.e_edgeShape:case t.b2ShapeType.e_chainShape:this.CreateParticlesStrokeShapeForGroup(e,i,n);break;case t.b2ShapeType.e_polygonShape:case t.b2ShapeType.e_circleShape:this.CreateParticlesFillShapeForGroup(e,i,n)}}CreateParticlesWithShapesForGroup(t,e,i,n){const s=new _r(t,e);this.CreateParticlesFillShapeForGroup(s,i,n)}CloneParticle(t,e){const i=new Es;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const n=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const e=this.m_handleIndexBuffer.data[t];e&&e.SetIndex(n),this.m_handleIndexBuffer.data[n]=e,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[n]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[n]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[n]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[n].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[n]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[n]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[n]=this.m_expirationTimeBuffer.data[t]),n}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(e,i){return 0!=(e&(t.b2ParticleFlag.b2_wallParticle|t.b2ParticleFlag.b2_springParticle|t.b2ParticleFlag.b2_elasticParticle))||null!==i&&0!=(i.GetGroupFlags()&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}UpdatePairsAndTriads(e,i,n){const s=Zs.UpdatePairsAndTriads_s_dab,r=Zs.UpdatePairsAndTriads_s_dbc,o=Zs.UpdatePairsAndTriads_s_dca,a=this.m_positionBuffer.data;let l=0;for(let t=e;t<i;t++)l|=this.m_flagsBuffer.data[t];if(l&Zs.k_pairFlags)for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],o=r.indexA,l=r.indexB,c=this.m_flagsBuffer.data[o],h=this.m_flagsBuffer.data[l],_=this.m_groupBuffer[o],u=this.m_groupBuffer[l];if(o>=e&&o<i&&l>=e&&l<i&&!((c|h)&t.b2ParticleFlag.b2_zombieParticle)&&(c|h)&Zs.k_pairFlags&&(n.IsNecessary(o)||n.IsNecessary(l))&&Zs.ParticleCanBeConnected(c,_)&&Zs.ParticleCanBeConnected(h,u)&&n.ShouldCreatePair(o,l)){const t=this.m_pairBuffer.data[this.m_pairBuffer.Append()];t.indexA=o,t.indexB=l,t.flags=r.flags,t.strength=tt(_?_.m_strength:1,u?u.m_strength:1),t.distance=xt.DistanceVV(a[o],a[l])}Vs(this.m_pairBuffer.data,0,this.m_pairBuffer.count,Zs.ComparePairIndices),this.m_pairBuffer.Unique(Zs.MatchPairIndices)}if(l&Zs.k_triadFlags){const l=new Os(i-e);for(let s=e;s<i;s++){const e=this.m_flagsBuffer.data[s],i=this.m_groupBuffer[s];e&t.b2ParticleFlag.b2_zombieParticle||!Zs.ParticleCanBeConnected(e,i)||l.AddGenerator(a[s],s,n.IsNecessary(s))}const c=this.GetParticleStride();l.Generate(c/2,2*c);const h=this,_=(t,e,i)=>{const l=h.m_flagsBuffer.data[t],c=h.m_flagsBuffer.data[e],_=h.m_flagsBuffer.data[i];if((l|c|_)&Zs.k_triadFlags&&n.ShouldCreateTriad(t,e,i)){const n=a[t],u=a[e],m=a[i],p=xt.SubVV(n,u,s),d=xt.SubVV(u,m,r),f=xt.SubVV(m,n,o),g=M*h.m_squaredDiameter;if(xt.DotVV(p,p)>g||xt.DotVV(d,d)>g||xt.DotVV(f,f)>g)return;const y=h.m_groupBuffer[t],v=h.m_groupBuffer[e],x=h.m_groupBuffer[i],b=h.m_triadBuffer.data[h.m_triadBuffer.Append()];b.indexA=t,b.indexB=e,b.indexC=i,b.flags=l|c|_,b.strength=tt(tt(y?y.m_strength:1,v?v.m_strength:1),x?x.m_strength:1);const S=(n.x+u.x+m.x)/3,A=(n.y+u.y+m.y)/3;b.pa.x=n.x-S,b.pa.y=n.y-A,b.pb.x=u.x-S,b.pb.y=u.y-A,b.pc.x=m.x-S,b.pc.y=m.y-A,b.ka=-xt.DotVV(f,p),b.kb=-xt.DotVV(p,d),b.kc=-xt.DotVV(d,f),b.s=xt.CrossVV(n,u)+xt.CrossVV(u,m)+xt.CrossVV(m,n)}};l.GetNodes(_),Vs(this.m_triadBuffer.data,0,this.m_triadBuffer.count,Zs.CompareTriadIndices),this.m_triadBuffer.Unique(Zs.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const e=new ur(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,e);for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&=~t.b2ParticleFlag.b2_reactiveParticle;this.m_allParticleFlags&=~t.b2ParticleFlag.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(0!==i)return i<0;const n=t.indexB-e.indexB;return 0!==n?n<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),n=t.GetParticleCount();for(let t=0;t<n;t++){const n=e[t];n.list=n,n.next=null,n.count=1,n.index=t+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB;if(!t.ContainsParticle(r)||!t.ContainsParticle(o))continue;let a=e[r-i].list,l=e[o-i].list;if(a!==l){if(a.count<l.count){const t=a;a=l,l=t}Zs.MergeParticleLists(a,l)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const e=i.next;if(!e){i.next=t.next;break}i=e}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let n=e[0];for(let t=0;t<i;t++){const i=e[t];n.count<i.count&&(n=i)}return n}MergeZombieParticleListNodes(e,i,n){const s=e.GetParticleCount();for(let e=0;e<s;e++){const s=i[e];s!==n&&this.m_flagsBuffer.data[s.index]&t.b2ParticleFlag.b2_zombieParticle&&Zs.MergeParticleListAndNode(n,s)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(e,i,n){const s=e.GetParticleCount(),r=new Is;r.groupFlags=e.GetGroupFlags(),r.userData=e.GetUserData();for(let e=0;e<s;e++){const s=i[e];if(!s.count||s===n)continue;const o=this.CreateParticleGroup(r);for(let e=s;e;e=e.next){const i=e.index,n=this.CloneParticle(i,o);this.m_flagsBuffer.data[i]|=t.b2ParticleFlag.b2_zombieParticle,e.index=n}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let n=0;n<this.m_pairBuffer.count;n++){const s=this.m_pairBuffer.data[n],r=s.indexA,o=s.indexB;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index)}for(let n=0;n<this.m_triadBuffer.count;n++){const s=this.m_triadBuffer.data[n],r=s.indexA,o=s.indexB,a=s.indexC;t.ContainsParticle(r)&&(s.indexA=e[r-i].index),t.ContainsParticle(o)&&(s.indexB=e[o-i].index),t.ContainsParticle(a)&&(s.indexC=e[a-i].index)}}ComputeDepth(){const e=[];let i=0;for(let n=0;n<this.m_contactBuffer.count;n++){const s=this.m_contactBuffer.data[n],r=s.indexA,o=s.indexB,a=this.m_groupBuffer[r],l=this.m_groupBuffer[o];a&&a===l&&a.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&(e[i++]=s)}const s=[];let r=0;for(let e=this.m_groupList;e;e=e.GetNext())if(e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth){s[r++]=e,this.SetGroupFlags(e,e.m_groupFlags&~t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth);for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_accumulationBuffer[t]=0}for(let t=0;t<i;t++){const i=e[t],n=i.indexA,s=i.indexB,r=i.weight;this.m_accumulationBuffer[n]+=r,this.m_accumulationBuffer[s]+=r}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++){const e=this.m_accumulationBuffer[t];this.m_depthBuffer[t]=e<.8?0:n}}const o=at(this.m_count)>>0;for(let t=0;t<o;t++){let t=!1;for(let n=0;n<i;n++){const i=e[n],s=i.indexA,r=i.indexB,o=1-i.weight,a=this.m_depthBuffer[s],l=this.m_depthBuffer[r],c=l+o,h=a+o;a>c&&(this.m_depthBuffer[s]=c,t=!0),l>h&&(this.m_depthBuffer[r]=h,t=!0)}if(!t)break}for(let t=0;t<r;t++){const e=s[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_depthBuffer[t]<n?this.m_depthBuffer[t]*=this.m_particleDiameter:this.m_depthBuffer[t]=0}}GetInsideBoundsEnumerator(t){const e=Zs.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=Zs.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),n=0,s=this.m_proxyBuffer.count,r=Gs(this.m_proxyBuffer.data,n,s,e,tr.CompareProxyTag),o=ks(this.m_proxyBuffer.data,n,s,i,tr.CompareTagProxy);return new er(this,e,i,r,o)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const n=this.m_flagsBuffer.data,s=this.m_positionBuffer.data,r=xt.SubVV(s[e],s[t],Zs.AddContact_s_d),o=xt.DotVV(r,r);if(0<o&&o<this.m_squaredDiameter){const i=ot(o),s=this.m_contactBuffer.data[this.m_contactBuffer.Append()];s.indexA=t,s.indexB=e,s.flags=n[t]|n[e],s.weight=1-o*i*this.m_inverseDiameter,s.normal.x=i*r.x,s.normal.y=i*r.y}}FindContacts_Reference(t){const e=0,i=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let t=e,n=e;t<i;t++){const e=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,0);for(let n=t+1;n<i&&!(e<this.m_proxyBuffer.data[n].tag);n++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[n].index,this.m_contactBuffer);const s=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,-1,1);for(;n<i&&!(s<=this.m_proxyBuffer.data[n].tag);n++);const r=Zs.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,1);for(let e=n;e<i&&!(r<this.m_proxyBuffer.data[e].tag);e++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[e].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let t=0;t<this.m_proxyBuffer.count;++t){const n=this.m_proxyBuffer.data[t],s=e[n.index];n.tag=Zs.computeTag(i*s.x,i*s.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){zs(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,tr.CompareProxyProxy)}FilterContacts(e){const i=this.GetParticleContactFilter();if(null===i)return;const n=this,s=e=>0!=(e.flags&t.b2ParticleFlag.b2_particleContactFilterParticle)&&!i.ShouldCollideParticleParticle(n,e.indexA,e.indexB);this.m_contactBuffer.RemoveIf(s)}NotifyContactListenerPreContact(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(null!==e){for(let t=0;t<this.m_contactBuffer.count;++t){const i=this.m_contactBuffer.data[t];e.BeginContactParticleParticle(this,i)}throw new Error}}static b2ParticleContactIsZombie(e){return(e.flags&t.b2ParticleFlag.b2_zombieParticle)===t.b2ParticleFlag.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new ar;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(Zs.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(null!==e){for(let t=0;t<this.m_bodyContactBuffer.count;t++){const i=this.m_bodyContactBuffer.data[t];e.BeginContactFixtureParticle(this,i)}throw new Error}}UpdateBodyContacts(){const t=Zs.UpdateBodyContacts_s_aabb,e=new rr;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const t=this.GetParticleCount();for(let e=0;e<t;e++)this.m_bodyContactCountBuffer.data[e]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[e]+1&&(this.m_consecutiveContactStepsBuffer.data[e]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new mr(this));const n=this.UpdateBodyContacts_callback;n.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(n,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(e){const i=Zs.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(e),this.m_allParticleFlags&t.b2ParticleFlag.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<e.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const n=i.Copy(e);n.dt/=e.particleIterations,n.inv_dt*=e.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&t.b2ParticleFlag.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&t.b2ParticleFlag.b2_repulsiveParticle&&this.SolveRepulsive(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_powderParticle&&this.SolvePowder(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_tensileParticle&&this.SolveTensile(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SolveSolid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle&&this.SolveStaticPressure(n),this.SolvePressure(n),this.SolveDamping(n),this.m_allParticleFlags&Zs.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_elasticParticle&&this.SolveElastic(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_springParticle&&this.SolveSpring(n),this.LimitVelocity(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&t.b2ParticleFlag.b2_barrierParticle&&this.SolveBarrier(n),this.SolveCollision(n),this.m_allGroupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup&&this.SolveRigid(n),this.m_allParticleFlags&t.b2ParticleFlag.b2_wallParticle&&this.SolveWall();for(let t=0;t<this.m_count;t++)this.m_positionBuffer.data[t].SelfMulAdd(n.dt,this.m_velocityBuffer.data[t])}}SolveCollision(t){const e=Zs.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=e;r.lowerBound.x=+n,r.lowerBound.y=+n,r.upperBound.x=-n,r.upperBound.y=-n;for(let e=0;e<this.m_count;e++){const n=s[e],o=i[e],a=o.x+t.dt*n.x,l=o.y+t.dt*n.y;r.lowerBound.x=tt(r.lowerBound.x,tt(o.x,a)),r.lowerBound.y=tt(r.lowerBound.y,tt(o.y,l)),r.upperBound.x=et(r.upperBound.x,et(o.x,a)),r.upperBound.y=et(r.upperBound.y,et(o.y,l))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new pr(this,t));const o=this.SolveCollision_callback;o.m_step=t,this.m_world.QueryAABB(o,r)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let t=0;t<this.m_count;t++){const n=e[t],s=xt.DotVV(n,n);s>i&&n.SelfMul(at(i/s))}}SolveGravity(t){const e=Zs.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,n=xt.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let t=0;t<this.m_count;t++)i[t].SelfAdd(n)}SolveBarrier(e){const i=Zs.SolveBarrier_s_aabb,n=Zs.SolveBarrier_s_va,s=Zs.SolveBarrier_s_vb,r=Zs.SolveBarrier_s_pba,o=Zs.SolveBarrier_s_vba,a=Zs.SolveBarrier_s_vc,l=Zs.SolveBarrier_s_pca,c=Zs.SolveBarrier_s_vca,h=Zs.SolveBarrier_s_qba,_=Zs.SolveBarrier_s_qca,u=Zs.SolveBarrier_s_dv,m=Zs.SolveBarrier_s_f,p=this.m_positionBuffer.data,d=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)0!=(this.m_flagsBuffer.data[t]&Zs.k_barrierWallFlags)&&d[t].SetZero();const f=B*e.dt,g=this.GetParticleMass();for(let y=0;y<this.m_pairBuffer.count;y++){const v=this.m_pairBuffer.data[y];if(v.flags&t.b2ParticleFlag.b2_barrierParticle){const t=v.indexA,y=v.indexB,x=p[t],b=p[y],S=i;xt.MinV(x,b,S.lowerBound),xt.MaxV(x,b,S.upperBound);const A=this.m_groupBuffer[t],C=this.m_groupBuffer[y],T=this.GetLinearVelocity(A,t,x,n),w=this.GetLinearVelocity(C,y,b,s),E=xt.SubVV(b,x,r),P=xt.SubVV(w,T,o),D=this.GetInsideBoundsEnumerator(S);let I;for(;(I=D.GetNext())>=0;){const t=p[I],i=this.m_groupBuffer[I];if(A!==i&&C!==i){const n=this.GetLinearVelocity(i,I,t,a),s=xt.SubVV(t,x,l),r=xt.SubVV(n,T,c),o=xt.CrossVV(P,r),p=xt.CrossVV(E,r)-xt.CrossVV(s,P),y=xt.CrossVV(E,s);let v,b;const S=h,A=_;if(0===o){if(0===p)continue;if(b=-y/p,!(b>=0&&b<f))continue;if(xt.AddVMulSV(E,b,P,S),xt.AddVMulSV(s,b,r,A),v=xt.DotVV(S,A)/xt.DotVV(S,S),!(v>=0&&v<=1))continue}else{const t=p*p-4*y*o;if(t<0)continue;const e=at(t);let i=(-p-e)/(2*o),n=(-p+e)/(2*o);if(i>n){const t=i;i=n,n=t}if(b=i,xt.AddVMulSV(E,b,P,S),xt.AddVMulSV(s,b,r,A),v=xt.DotVV(S,A)/xt.DotVV(S,S),!(b>=0&&b<f&&v>=0&&v<=1)){if(b=n,!(b>=0&&b<f))continue;if(xt.AddVMulSV(E,b,P,S),xt.AddVMulSV(s,b,r,A),v=xt.DotVV(S,A)/xt.DotVV(S,S),!(v>=0&&v<=1))continue}}const C=u;C.x=T.x+v*P.x-n.x,C.y=T.y+v*P.y-n.y;const w=xt.MulSV(g,C,m);if(i&&this.IsRigidGroup(i)){const e=i.GetMass(),n=i.GetInertia();e>0&&i.m_linearVelocity.SelfMulAdd(1/e,w),n>0&&(i.m_angularVelocity+=xt.CrossVV(xt.SubVV(t,i.GetCenter(),xt.s_t0),w)/n)}else d[I].SelfAdd(C);this.ParticleApplyForce(I,w.SelfMul(-e.inv_dt))}}}}}SolveStaticPressure(e){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const i=this.GetCriticalPressure(e),n=this.m_def.staticPressureStrength*i,s=D*i,r=this.m_def.staticPressureRelaxation;for(let e=0;e<this.m_def.staticPressureIterations;e++){for(let t=0;t<this.m_count;t++)this.m_accumulationBuffer[t]=0;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_staticPressureParticle){const t=i.indexA,e=i.indexB,n=i.weight;this.m_accumulationBuffer[t]+=n*this.m_staticPressureBuffer[e],this.m_accumulationBuffer[e]+=n*this.m_staticPressureBuffer[t]}}for(let e=0;e<this.m_count;e++){const i=this.m_weightBuffer[e];if(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle){const t=(this.m_accumulationBuffer[e]+n*(i-P))/(i+r);this.m_staticPressureBuffer[e]=it(t,0,s)}else this.m_staticPressureBuffer[e]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,n=e.weight;this.m_weightBuffer[i]+=n}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,n=e.indexB,s=e.weight;this.m_weightBuffer[i]+=s,this.m_weightBuffer[n]+=s}}SolvePressure(e){const i=Zs.SolvePressure_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.GetCriticalPressure(e),o=this.m_def.pressureStrength*r,a=D*r;for(let t=0;t<this.m_count;t++){const e=o*et(0,this.m_weightBuffer[t]-P);this.m_accumulationBuffer[t]=tt(e,a)}if(this.m_allParticleFlags&Zs.k_noPressureFlags)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&Zs.k_noPressureFlags&&(this.m_accumulationBuffer[t]=0);if(this.m_allParticleFlags&t.b2ParticleFlag.b2_staticPressureParticle)for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_staticPressureParticle&&(this.m_accumulationBuffer[e]+=this.m_staticPressureBuffer[e]);const l=e.dt/(this.m_def.density*this.m_particleDiameter),c=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],r=e.index,a=e.body,h=e.weight,_=e.mass,u=e.normal,m=n[r],p=this.m_accumulationBuffer[r]+o*h,d=xt.MulSV(l*h*_*p,u,i);s[r].SelfMulSub(c,d),a.ApplyLinearImpulse(d,m,!0)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],n=e.indexA,r=e.indexB,o=e.weight,a=e.normal,c=this.m_accumulationBuffer[n]+this.m_accumulationBuffer[r],h=xt.MulSV(l*o*c,a,i);s[n].SelfSub(h),s[r].SelfAdd(h)}}SolveDamping(t){const e=Zs.SolveDamping_s_v,i=Zs.SolveDamping_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.dampingStrength,o=1/this.GetCriticalVelocity(t),a=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const l=this.m_bodyContactBuffer.data[t],c=l.index,h=l.body,_=l.weight,u=l.mass,m=l.normal,p=n[c],d=xt.SubVV(h.GetLinearVelocityFromWorldPoint(p,xt.s_t0),s[c],e),f=xt.DotVV(d,m);if(f<0){const t=et(r*_,tt(-o*f,.5)),e=xt.MulSV(t*u*f,m,i);s[c].SelfMulAdd(a,e),h.ApplyLinearImpulse(e.SelfNeg(),p,!0)}}for(let t=0;t<this.m_contactBuffer.count;t++){const n=this.m_contactBuffer.data[t],a=n.indexA,l=n.indexB,c=n.weight,h=n.normal,_=xt.SubVV(s[l],s[a],e),u=xt.DotVV(_,h);if(u<0){const t=et(r*c,tt(-o*u,.5)),e=xt.MulSV(t*u,h,i);s[a].SelfAdd(e),s[l].SelfSub(e)}}}SolveRigidDamping(){const t=Zs.SolveRigidDamping_s_t0,e=Zs.SolveRigidDamping_s_t1,i=Zs.SolveRigidDamping_s_p,n=Zs.SolveRigidDamping_s_v,s=[0],r=[0],o=[0],a=[0],l=[0],c=[0],h=this.m_positionBuffer.data,_=this.m_def.dampingStrength;for(let i=0;i<this.m_bodyContactBuffer.count;i++){const u=this.m_bodyContactBuffer.data[i],m=u.index,p=this.m_groupBuffer[m];if(p&&this.IsRigidGroup(p)){const i=u.body,d=u.normal,f=u.weight,g=h[m],y=xt.SubVV(i.GetLinearVelocityFromWorldPoint(g,t),p.GetLinearVelocityFromWorldPoint(g,e),n),v=xt.DotVV(y,d);if(v<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,!0,p,m,g,d),this.InitDampingParameter(a,l,c,i.GetMass(),i.GetInertia()-i.GetMass()*i.GetLocalCenter().LengthSquared(),i.GetWorldCenter(),g,d);const t=_*tt(f,1)*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],l[0],c[0],v);this.ApplyDamping(s[0],r[0],o[0],!0,p,m,t,d),i.ApplyLinearImpulse(xt.MulSV(-t,d,xt.s_t0),g,!0)}}}for(let u=0;u<this.m_contactBuffer.count;u++){const m=this.m_contactBuffer.data[u],p=m.indexA,d=m.indexB,f=m.normal,g=m.weight,y=this.m_groupBuffer[p],v=this.m_groupBuffer[d],x=this.IsRigidGroup(y),b=this.IsRigidGroup(v);if(y!==v&&(x||b)){const u=xt.MidVV(h[p],h[d],i),m=xt.SubVV(this.GetLinearVelocity(v,d,u,t),this.GetLinearVelocity(y,p,u,e),n),S=xt.DotVV(m,f);if(S<0){this.InitDampingParameterWithRigidGroupOrParticle(s,r,o,x,y,p,u,f),this.InitDampingParameterWithRigidGroupOrParticle(a,l,c,b,v,d,u,f);const t=_*g*this.ComputeDampingImpulse(s[0],r[0],o[0],a[0],l[0],c[0],S);this.ApplyDamping(s[0],r[0],o[0],x,y,p,t,f),this.ApplyDamping(a[0],l[0],c[0],b,v,d,-t,f)}}}}SolveExtraDamping(){const t=Zs.SolveExtraDamping_s_v,e=Zs.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,n=this.m_positionBuffer.data,s=this.GetParticleInvMass();for(let r=0;r<this.m_bodyContactBuffer.count;r++){const o=this.m_bodyContactBuffer.data[r],a=o.index;if(this.m_flagsBuffer.data[a]&Zs.k_extraDampingFlags){const r=o.body,l=o.mass,c=o.normal,h=n[a],_=xt.SubVV(r.GetLinearVelocityFromWorldPoint(h,xt.s_t0),i[a],t),u=xt.DotVV(_,c);if(u<0){const t=xt.MulSV(.5*l*u,c,e);i[a].SelfMulAdd(s,t),r.ApplyLinearImpulse(t.SelfNeg(),h,!0)}}}}SolveWall(){const e=this.m_velocityBuffer.data;for(let i=0;i<this.m_count;i++)this.m_flagsBuffer.data[i]&t.b2ParticleFlag.b2_wallParticle&&e[i].SetZero()}SolveRigid(e){const i=Zs.SolveRigid_s_position,n=Zs.SolveRigid_s_rotation,s=Zs.SolveRigid_s_transform,r=Zs.SolveRigid_s_velocityTransform,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data;for(let l=this.m_groupList;l;l=l.GetNext())if(l.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup){l.UpdateStatistics();const t=n;t.SetAngle(e.dt*l.m_angularVelocity);const c=xt.AddVV(l.m_center,xt.SubVV(xt.MulSV(e.dt,l.m_linearVelocity,xt.s_t0),Tt.MulRV(t,l.m_center,xt.s_t1),xt.s_t0),i),h=s;h.SetPositionRotation(c,t),wt.MulXX(h,l.m_transform,l.m_transform);const _=r;_.p.x=e.inv_dt*h.p.x,_.p.y=e.inv_dt*h.p.y,_.q.s=e.inv_dt*h.q.s,_.q.c=e.inv_dt*(h.q.c-1);for(let t=l.m_firstIndex;t<l.m_lastIndex;t++)wt.MulXV(_,o[t],a[t])}}SolveElastic(e){const i=Zs.SolveElastic_s_pa,n=Zs.SolveElastic_s_pb,s=Zs.SolveElastic_s_pc,r=Zs.SolveElastic_s_r,o=Zs.SolveElastic_s_t0,a=this.m_positionBuffer.data,l=this.m_velocityBuffer.data,c=e.inv_dt*this.m_def.elasticStrength;for(let h=0;h<this.m_triadBuffer.count;h++){const _=this.m_triadBuffer.data[h];if(_.flags&t.b2ParticleFlag.b2_elasticParticle){const t=_.indexA,h=_.indexB,u=_.indexC,m=_.pa,p=_.pb,d=_.pc,f=i.Copy(a[t]),g=n.Copy(a[h]),y=s.Copy(a[u]),v=l[t],x=l[h],b=l[u];f.SelfMulAdd(e.dt,v),g.SelfMulAdd(e.dt,x),y.SelfMulAdd(e.dt,b);const S=(f.x+g.x+y.x)/3,A=(f.y+g.y+y.y)/3;f.x-=S,f.y-=A,g.x-=S,g.y-=A,y.x-=S,y.y-=A;const C=r;C.s=xt.CrossVV(m,f)+xt.CrossVV(p,g)+xt.CrossVV(d,y),C.c=xt.DotVV(m,f)+xt.DotVV(p,g)+xt.DotVV(d,y);let T=ot(C.s*C.s+C.c*C.c);isFinite(T)||(T=198177537e11),C.s*=T,C.c*=T;const w=c*_.strength;Tt.MulRV(C,m,o),xt.SubVV(o,f,o),xt.MulSV(w,o,o),v.SelfAdd(o),Tt.MulRV(C,p,o),xt.SubVV(o,g,o),xt.MulSV(w,o,o),x.SelfAdd(o),Tt.MulRV(C,d,o),xt.SubVV(o,y,o),xt.MulSV(w,o,o),b.SelfAdd(o)}}}SolveSpring(e){const i=Zs.SolveSpring_s_pa,n=Zs.SolveSpring_s_pb,s=Zs.SolveSpring_s_d,r=Zs.SolveSpring_s_f,o=this.m_positionBuffer.data,a=this.m_velocityBuffer.data,l=e.inv_dt*this.m_def.springStrength;for(let c=0;c<this.m_pairBuffer.count;c++){const h=this.m_pairBuffer.data[c];if(h.flags&t.b2ParticleFlag.b2_springParticle){const t=h.indexA,c=h.indexB,_=i.Copy(o[t]),u=n.Copy(o[c]),m=a[t],p=a[c];_.SelfMulAdd(e.dt,m),u.SelfMulAdd(e.dt,p);const d=xt.SubVV(u,_,s),f=h.distance,g=d.Length(),y=l*h.strength,v=xt.MulSV(y*(f-g)/g,d,r);m.SelfSub(v),p.SelfAdd(v)}}}SolveTensile(e){const i=Zs.SolveTensile_s_weightedNormal,n=Zs.SolveTensile_s_s,s=Zs.SolveTensile_s_f,r=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)this.m_accumulation2Buffer[t]=new xt,this.m_accumulation2Buffer[t].SetZero();for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_tensileParticle){const t=n.indexA,e=n.indexB,s=n.weight,r=n.normal,o=xt.MulSV((1-s)*s,r,i);this.m_accumulation2Buffer[t].SelfSub(o),this.m_accumulation2Buffer[e].SelfAdd(o)}}const o=this.GetCriticalVelocity(e),a=this.m_def.surfaceTensionPressureStrength*o,l=this.m_def.surfaceTensionNormalStrength*o,c=I*o;for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e];if(i.flags&t.b2ParticleFlag.b2_tensileParticle){const t=i.indexA,e=i.indexB,o=i.weight,h=i.normal,_=this.m_weightBuffer[t]+this.m_weightBuffer[e],u=xt.SubVV(this.m_accumulation2Buffer[e],this.m_accumulation2Buffer[t],n),m=tt(a*(_-2)+l*xt.DotVV(u,h),c)*o,p=xt.MulSV(m,h,s);r[t].SelfSub(p),r[e].SelfAdd(p)}}}SolveViscous(){const e=Zs.SolveViscous_s_v,i=Zs.SolveViscous_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.viscousStrength,o=this.GetParticleInvMass();for(let a=0;a<this.m_bodyContactBuffer.count;a++){const l=this.m_bodyContactBuffer.data[a],c=l.index;if(this.m_flagsBuffer.data[c]&t.b2ParticleFlag.b2_viscousParticle){const t=l.body,a=l.weight,h=l.mass,_=n[c],u=xt.SubVV(t.GetLinearVelocityFromWorldPoint(_,xt.s_t0),s[c],e),m=xt.MulSV(r*h*a,u,i);s[c].SelfMulAdd(o,m),t.ApplyLinearImpulse(m.SelfNeg(),_,!0)}}for(let n=0;n<this.m_contactBuffer.count;n++){const o=this.m_contactBuffer.data[n];if(o.flags&t.b2ParticleFlag.b2_viscousParticle){const t=o.indexA,n=o.indexB,a=o.weight,l=xt.SubVV(s[n],s[t],e),c=xt.MulSV(r*a,l,i);s[t].SelfAdd(c),s[n].SelfSub(c)}}}SolveRepulsive(e){const i=Zs.SolveRepulsive_s_f,n=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(e);for(let e=0;e<this.m_contactBuffer.count;e++){const r=this.m_contactBuffer.data[e];if(r.flags&t.b2ParticleFlag.b2_repulsiveParticle){const t=r.indexA,e=r.indexB;if(this.m_groupBuffer[t]!==this.m_groupBuffer[e]){const o=r.weight,a=r.normal,l=xt.MulSV(s*o,a,i);n[t].SelfSub(l),n[e].SelfAdd(l)}}}}SolvePowder(e){const i=Zs.SolvePowder_s_f,n=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.powderStrength*this.GetCriticalVelocity(e),o=1-E,a=this.GetParticleInvMass();for(let e=0;e<this.m_bodyContactBuffer.count;e++){const l=this.m_bodyContactBuffer.data[e],c=l.index;if(this.m_flagsBuffer.data[c]&t.b2ParticleFlag.b2_powderParticle){const t=l.weight;if(t>o){const e=l.body,h=l.mass,_=n[c],u=l.normal,m=xt.MulSV(r*h*(t-o),u,i);s[c].SelfMulSub(a,m),e.ApplyLinearImpulse(m,_,!0)}}}for(let e=0;e<this.m_contactBuffer.count;e++){const n=this.m_contactBuffer.data[e];if(n.flags&t.b2ParticleFlag.b2_powderParticle){const t=n.weight;if(t>o){const e=n.indexA,a=n.indexB,l=n.normal,c=xt.MulSV(r*(t-o),l,i);s[e].SelfSub(c),s[a].SelfAdd(c)}}}}SolveSolid(t){const e=Zs.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const n=t.inv_dt*this.m_def.ejectionStrength;for(let t=0;t<this.m_contactBuffer.count;t++){const s=this.m_contactBuffer.data[t],r=s.indexA,o=s.indexB;if(this.m_groupBuffer[r]!==this.m_groupBuffer[o]){const t=s.weight,a=s.normal,l=this.m_depthBuffer[r]+this.m_depthBuffer[o],c=xt.MulSV(n*l*t,a,e);i[r].SelfSub(c),i[o].SelfAdd(c)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let t=0;t<this.m_count;t++)e[t].SelfMulAdd(i,this.m_forceBuffer[t]);this.m_hasForce=!1}SolveColorMixing(){const e=.5*this.m_def.colorMixingStrength;if(e)for(let i=0;i<this.m_contactBuffer.count;i++){const n=this.m_contactBuffer.data[i],s=n.indexA,r=n.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[r]&t.b2ParticleFlag.b2_colorMixingParticle){const t=this.m_colorBuffer.data[s],i=this.m_colorBuffer.data[r];Pt.MixColors(t,i,e)}}}SolveZombie(){let e=0;const i=[];for(let t=0;t<this.m_count;t++)i[t]=T;let n=0;for(let s=0;s<this.m_count;s++){const r=this.m_flagsBuffer.data[s];if(r&t.b2ParticleFlag.b2_zombieParticle){const e=this.m_world.m_destructionListener;if(r&t.b2ParticleFlag.b2_destructionListenerParticle&&e&&e.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&(t.SetIndex(T),this.m_handleIndexBuffer.data[s]=null)}i[s]=T}else{if(i[s]=e,s!==e){if(this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&t.SetIndex(e),this.m_handleIndexBuffer.data[e]=t}this.m_flagsBuffer.data[e]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[e].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[e].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[e]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[e].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[e]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[e].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[e]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[e]=this.m_expirationTimeBuffer.data[s])}e++,n|=r}}const s={IsProxyInvalid:t=>t.index<0,IsContactInvalid:t=>t.indexA<0||t.indexB<0,IsBodyContactInvalid:t=>t.index<0,IsPairInvalid:t=>t.indexA<0||t.indexB<0,IsTriadInvalid:t=>t.indexA<0||t.indexB<0||t.indexC<0};for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=i[e.index]}this.m_proxyBuffer.RemoveIf(s.IsProxyInvalid);for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_contactBuffer.RemoveIf(s.IsContactInvalid);for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=i[e.index]}this.m_bodyContactBuffer.RemoveIf(s.IsBodyContactInvalid);for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB]}this.m_pairBuffer.RemoveIf(s.IsPairInvalid);for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=i[e.indexA],e.indexB=i[e.indexB],e.indexC=i[e.indexC]}if(this.m_triadBuffer.RemoveIf(s.IsTriadInvalid),this.m_indexByExpirationTimeBuffer.data){let t=0;for(let e=0;e<this.m_count;e++){const n=i[this.m_indexByExpirationTimeBuffer.data[e]];n!==T&&(this.m_indexByExpirationTimeBuffer.data[t++]=n)}}for(let n=this.m_groupList;n;n=n.GetNext()){let s=e,r=0,o=!1;for(let t=n.m_firstIndex;t<n.m_lastIndex;t++){const e=i[t];e>=0?(s=tt(s,e),r=et(r,e+1)):o=!0}s<r?(n.m_firstIndex=s,n.m_lastIndex=r,o&&n.m_groupFlags&t.b2ParticleGroupFlag.b2_solidParticleGroup&&this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth)):(n.m_firstIndex=0,n.m_lastIndex=0,n.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupCanBeEmpty||this.SetGroupFlags(n,n.m_groupFlags|t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed))}this.m_count=e,this.m_allParticleFlags=n,this.m_needsUpdateAllParticleFlags=!1;for(let e=this.m_groupList;e;){const i=e.GetNext();e.m_groupFlags&t.b2ParticleGroupFlag.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(e),e=i}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,n=this.m_indexByExpirationTimeBuffer.data,s=this.GetParticleCount();this.m_expirationTimeBufferRequiresSorting&&(zs(n,0,s,((t,e)=>{const n=i[t],s=i[e],r=n<=0;return r===s<=0?n>s:r})),this.m_expirationTimeBufferRequiresSorting=!1);for(let t=s-1;t>=0;--t){const s=n[t],r=i[s];if(e<r||r<=0)break;this.DestroyParticle(s)}}RotateBuffer(t,e,i){if(t!==e&&e!==i){if(Hs(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Hs(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Hs(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Hs(this.m_consecutiveContactStepsBuffer.data,t,e,i),Hs(this.m_positionBuffer.data,t,e,i),Hs(this.m_velocityBuffer.data,t,e,i),Hs(this.m_groupBuffer,t,e,i),this.m_hasForce&&Hs(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Hs(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Hs(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Hs(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Hs(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Hs(this.m_handleIndexBuffer.data,t,e,i);for(let e=t;e<i;++e){const t=this.m_handleIndexBuffer.data[e];t&&t.SetIndex(n(t.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Hs(this.m_expirationTimeBuffer.data,t,e,i);const s=this.GetParticleCount(),r=this.m_indexByExpirationTimeBuffer.data;for(let t=0;t<s;++t)r[t]=n(r[t])}for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=n(e.index)}for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB)}for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=n(e.indexA),e.indexB=n(e.indexB),e.indexC=n(e.indexC)}for(let t=this.m_groupList;t;t=t.GetNext())t.m_firstIndex=n(t.m_firstIndex),t.m_lastIndex=n(t.m_lastIndex-1)+1}function n(n){return n<t?n:n<e?n+i-e:n<i?n+t-e:n}}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return E*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=this.m_inverseDiameter*(1/E);return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&t.b2ParticleFlag.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(e,i){const n=e.m_groupFlags;(n^i)&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(i|=t.b2ParticleGroupFlag.b2_particleGroupNeedsUpdateDepth),n&~i&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&i&&(i&t.b2ParticleGroupFlag.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=i),e.m_groupFlags=i}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){zs(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,Zs.BodyContactCompare);const t=Zs.RemoveSpuriousBodyContacts_s_n,e=Zs.RemoveSpuriousBodyContacts_s_pos,i=Zs.RemoveSpuriousBodyContacts_s_normal,n=3,s=this;let r=-1,o=0;const a=a=>{if(a.index!==r&&(o=0,r=a.index),o++>n)return!0;const l=t.Copy(a.normal);l.SelfMul(s.m_particleDiameter*(1-a.weight));const c=xt.AddVV(s.m_positionBuffer.data[a.index],l,e);if(!a.fixture.TestPoint(c)){const t=a.fixture.GetShape().GetChildCount();for(let e=0;e<t;e++){const t=i;if(a.fixture.ComputeDistance(c,t,e)<_)return!1}return!0}return!1};this.m_bodyContactBuffer.count=Us(this.m_bodyContactBuffer.data,a,this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==T}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(e){return!(e&t.b2ParticleFlag.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(e){return null!==e&&0!=(e.m_groupFlags&t.b2ParticleGroupFlag.b2_rigidParticleGroup)}GetLinearVelocity(t,e,i,n){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,n):n.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,n,s,r,o,a){t[0]=n>0?1/n:0,e[0]=s>0?1/s:0,i[0]=xt.CrossVV(xt.SubVV(o,r,xt.s_t0),a)}InitDampingParameterWithRigidGroupOrParticle(e,i,n,s,r,o,a,l){if(r&&s)this.InitDampingParameter(e,i,n,r.GetMass(),r.GetInertia(),r.GetCenter(),a,l);else{const s=this.m_flagsBuffer.data[o];this.InitDampingParameter(e,i,n,s&t.b2ParticleFlag.b2_wallParticle?0:this.GetParticleMass(),0,a,a,l)}}ComputeDampingImpulse(t,e,i,n,s,r,o){const a=t+e*i*i+n+s*r*r;return a>0?o/a:0}ApplyDamping(t,e,i,n,s,r,o,a){s&&n?(s.m_linearVelocity.SelfMulAdd(o*t,a),s.m_angularVelocity+=o*i*e):this.m_velocityBuffer.data[r].SelfMulAdd(o*t,a)}}Zs.xTruncBits=12,Zs.yTruncBits=12,Zs.tagBits=32,Zs.yOffset=1<<Zs.yTruncBits-1,Zs.yShift=Zs.tagBits-Zs.yTruncBits,Zs.xShift=Zs.tagBits-Zs.yTruncBits-Zs.xTruncBits,Zs.xScale=1<<Zs.xShift,Zs.xOffset=Zs.xScale*(1<<Zs.xTruncBits-1),Zs.yMask=(1<<Zs.yTruncBits)-1<<Zs.yShift,Zs.xMask=~Zs.yMask,Zs.DestroyParticlesInShape_s_aabb=new be,Zs.CreateParticleGroup_s_transform=new wt,Zs.ComputeCollisionEnergy_s_v=new xt,Zs.QueryShapeAABB_s_aabb=new be,Zs.QueryPointAABB_s_aabb=new be,Zs.RayCast_s_aabb=new be,Zs.RayCast_s_p=new xt,Zs.RayCast_s_v=new xt,Zs.RayCast_s_n=new xt,Zs.RayCast_s_point=new xt,Zs.k_pairFlags=t.b2ParticleFlag.b2_springParticle,Zs.k_triadFlags=t.b2ParticleFlag.b2_elasticParticle,Zs.k_noPressureFlags=t.b2ParticleFlag.b2_powderParticle|t.b2ParticleFlag.b2_tensileParticle,Zs.k_extraDampingFlags=t.b2ParticleFlag.b2_staticPressureParticle,Zs.k_barrierWallFlags=t.b2ParticleFlag.b2_barrierParticle|t.b2ParticleFlag.b2_wallParticle,Zs.CreateParticlesStrokeShapeForGroup_s_edge=new cn,Zs.CreateParticlesStrokeShapeForGroup_s_d=new xt,Zs.CreateParticlesStrokeShapeForGroup_s_p=new xt,Zs.CreateParticlesFillShapeForGroup_s_aabb=new be,Zs.CreateParticlesFillShapeForGroup_s_p=new xt,Zs.UpdatePairsAndTriads_s_dab=new xt,Zs.UpdatePairsAndTriads_s_dbc=new xt,Zs.UpdatePairsAndTriads_s_dca=new xt,Zs.AddContact_s_d=new xt,Zs.UpdateBodyContacts_s_aabb=new be,Zs.Solve_s_subStep=new ms,Zs.SolveCollision_s_aabb=new be,Zs.SolveGravity_s_gravity=new xt,Zs.SolveBarrier_s_aabb=new be,Zs.SolveBarrier_s_va=new xt,Zs.SolveBarrier_s_vb=new xt,Zs.SolveBarrier_s_pba=new xt,Zs.SolveBarrier_s_vba=new xt,Zs.SolveBarrier_s_vc=new xt,Zs.SolveBarrier_s_pca=new xt,Zs.SolveBarrier_s_vca=new xt,Zs.SolveBarrier_s_qba=new xt,Zs.SolveBarrier_s_qca=new xt,Zs.SolveBarrier_s_dv=new xt,Zs.SolveBarrier_s_f=new xt,Zs.SolvePressure_s_f=new xt,Zs.SolveDamping_s_v=new xt,Zs.SolveDamping_s_f=new xt,Zs.SolveRigidDamping_s_t0=new xt,Zs.SolveRigidDamping_s_t1=new xt,Zs.SolveRigidDamping_s_p=new xt,Zs.SolveRigidDamping_s_v=new xt,Zs.SolveExtraDamping_s_v=new xt,Zs.SolveExtraDamping_s_f=new xt,Zs.SolveRigid_s_position=new xt,Zs.SolveRigid_s_rotation=new Tt,Zs.SolveRigid_s_transform=new wt,Zs.SolveRigid_s_velocityTransform=new wt,Zs.SolveElastic_s_pa=new xt,Zs.SolveElastic_s_pb=new xt,Zs.SolveElastic_s_pc=new xt,Zs.SolveElastic_s_r=new Tt,Zs.SolveElastic_s_t0=new xt,Zs.SolveSpring_s_pa=new xt,Zs.SolveSpring_s_pb=new xt,Zs.SolveSpring_s_d=new xt,Zs.SolveSpring_s_f=new xt,Zs.SolveTensile_s_weightedNormal=new xt,Zs.SolveTensile_s_s=new xt,Zs.SolveTensile_s_f=new xt,Zs.SolveViscous_s_v=new xt,Zs.SolveViscous_s_f=new xt,Zs.SolveRepulsive_s_f=new xt,Zs.SolvePowder_s_f=new xt,Zs.SolveSolid_s_f=new xt,Zs.RemoveSpuriousBodyContacts_s_n=new xt,Zs.RemoveSpuriousBodyContacts_s_pos=new xt,Zs.RemoveSpuriousBodyContacts_s_normal=new xt;class Qs{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class tr{constructor(){this.index=T,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class er{constructor(t,e,i,n,s){this.m_system=t,this.m_xLower=(e&Zs.xMask)>>>0,this.m_xUpper=(i&Zs.xMask)>>>0,this.m_yLower=(e&Zs.yMask)>>>0,this.m_yUpper=(i&Zs.yMask)>>>0,this.m_first=n,this.m_last=s}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&Zs.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return T}}class ir{constructor(){this.next=null,this.count=0,this.index=0}}class nr{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class sr{constructor(t,e){this.second=T,this.first=t,this.second=e}}class rr extends nr{Initialize(t,e){}Find(t){return T}}class or{constructor(t,e){this.first=T,this.second=T,this.first=t,this.second=e}}class ar extends nr{Initialize(t,e){}Find(t){return T}}class lr{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class cr extends cs{constructor(t,e,i,n){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=n,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class hr extends lr{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class _r extends on{constructor(e,i=e.length){super(t.b2ShapeType.e_unknown,0),this.m_shapeCount=0,this.m_shapes=e,this.m_shapeCount=i}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,n){return 0}RayCast(t,e,i,n){return!1}ComputeAABB(t,e,i){const s=new be;t.lowerBound.x=+n,t.lowerBound.y=+n,t.upperBound.x=-n,t.upperBound.y=-n;for(let i=0;i<this.m_shapeCount;i++){const n=this.m_shapes[i].GetChildCount();for(let r=0;r<n;r++){const n=s;this.m_shapes[i].ComputeAABB(n,e,r),t.Combine1(n)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,n){return 0}Dump(t){}}class ur extends lr{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(e){return 0!=(this.m_flagsBuffer.data[e]&t.b2ParticleFlag.b2_reactiveParticle)}}class mr extends qs{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(e,i,n){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[n]&t.b2ParticleFlag.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(e,this.m_system,n)}ReportFixtureAndParticle(e,i,n){const s=mr.ReportFixtureAndParticle_s_n,r=mr.ReportFixtureAndParticle_s_rp,o=this.m_system.m_positionBuffer.data[n],a=s,l=e.ComputeDistance(o,a,i);if(l<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(e,this.m_system,n)){const i=e.GetBody(),s=i.GetWorldCenter(),c=i.GetMass(),h=i.GetInertia()-c*i.GetLocalCenter().LengthSquared(),_=c>0?1/c:0,u=h>0?1/h:0,m=this.m_system.m_flagsBuffer.data[n]&t.b2ParticleFlag.b2_wallParticle?0:this.m_system.GetParticleInvMass(),p=xt.SubVV(o,s,r),d=xt.CrossVV(p,a),f=m+_+u*d*d,g=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];g.index=n,g.body=i,g.fixture=e,g.weight=1-l*this.m_system.m_inverseDiameter,g.normal.Copy(a.SelfNeg()),g.mass=f>0?1/f:0,this.m_system.DetectStuckParticle(n)}}}mr.ReportFixtureAndParticle_s_n=new xt,mr.ReportFixtureAndParticle_s_rp=new xt;class pr extends qs{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(e,i,n){const s=pr.ReportFixtureAndParticle_s_p1,r=pr.ReportFixtureAndParticle_s_output,o=pr.ReportFixtureAndParticle_s_input,a=pr.ReportFixtureAndParticle_s_p,l=pr.ReportFixtureAndParticle_s_v,c=pr.ReportFixtureAndParticle_s_f,h=e.GetBody(),u=this.m_system.m_positionBuffer.data[n],m=this.m_system.m_velocityBuffer.data[n],p=r,d=o;if(0===this.m_system.m_iterationIndex){const i=wt.MulTXV(h.m_xf0,u,s);e.GetShape().GetType()===t.b2ShapeType.e_circleShape&&(i.SelfSub(h.GetLocalCenter()),Tt.MulRV(h.m_xf0.q,i,i),Tt.MulTRV(h.m_xf.q,i,i),i.SelfAdd(h.GetLocalCenter())),wt.MulXV(h.m_xf,i,d.p1)}else d.p1.Copy(u);if(xt.AddVMulSV(u,this.m_step.dt,m,d.p2),d.maxFraction=1,e.RayCast(p,d,i)){const t=p.normal,e=a;e.x=(1-p.fraction)*d.p1.x+p.fraction*d.p2.x+_*t.x,e.y=(1-p.fraction)*d.p1.y+p.fraction*d.p2.y+_*t.y;const i=l;i.x=this.m_step.inv_dt*(e.x-u.x),i.y=this.m_step.inv_dt*(e.y-u.y),this.m_system.m_velocityBuffer.data[n].Copy(i);const s=c;s.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(m.x-i.x),s.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(m.y-i.y),this.m_system.ParticleApplyForce(n,s)}}ReportParticle(t,e){return!1}}pr.ReportFixtureAndParticle_s_p1=new xt,pr.ReportFixtureAndParticle_s_output=new xe,pr.ReportFixtureAndParticle_s_input=new ve,pr.ReportFixtureAndParticle_s_p=new xt,pr.ReportFixtureAndParticle_s_v=new xt,pr.ReportFixtureAndParticle_s_f=new xt;class dr{constructor(t){this.m_newFixture=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_contactManager=new _s,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new xt,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new us,this.m_island=new Cs,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new fn(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const e=i;i=i.nextController,e.controller.RemoveBody(t)}let n=t.m_contactList;for(;n;){const t=n;n=n.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let s=t.m_fixtureList;for(;s;){const e=s;s=s.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(),e.Reset(),t.m_fixtureList=s,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(e){switch(e.type){case t.b2JointType.e_distanceJoint:return new Sn(e);case t.b2JointType.e_mouseJoint:return new Mn(e);case t.b2JointType.e_prismaticJoint:return new Bn(e);case t.b2JointType.e_revoluteJoint:return new Vn(e);case t.b2JointType.e_pulleyJoint:return new Fn(e);case t.b2JointType.e_gearJoint:return new Pn(e);case t.b2JointType.e_wheelJoint:return new Wn(e);case t.b2JointType.e_weldJoint:return new Hn(e);case t.b2JointType.e_frictionJoint:return new wn(e);case t.b2JointType.e_ropeJoint:return new Gn(e);case t.b2JointType.e_motorJoint:return new In(e);case t.b2JointType.e_areaJoint:return new Cn(e)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=dr._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,n=e.m_bodyB;if(!e.m_collideConnected){let t=n.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,n=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),dr._Joint_Destroy(t),--this.m_jointCount,!n){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new Zs(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){if(null===this.m_particleSystemList)return 1;function e(t){let e=n;for(let i=t.GetParticleSystemList();null!==i;i=i.m_next)e=tt(e,i.GetRadius());return e}return Ps(this.m_gravity.Length(),e(this),t)}Step(t,e,i,n=this.CalculateReasonableParticleIterations(t)){const s=dr.Step_s_stepTimer.Reset();this.m_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_newFixture=!1),this.m_locked=!0;const r=dr.Step_s_step;r.dt=t,r.velocityIterations=e,r.positionIterations=i,r.particleIterations=n,r.inv_dt=t>0?1/t:0,r.dtRatio=this.m_inv_dt0*t,r.warmStarting=this.m_warmStarting;const o=dr.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&r.dt>0){const t=dr.Step_s_timer.Reset();for(let t=this.m_particleSystemList;t;t=t.m_next)t.Solve(r);this.Solve(r),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&r.dt>0){const t=dr.Step_s_timer.Reset();this.SolveTOI(r),this.m_profile.solveTOI=t.GetMilliseconds()}r.dt>0&&(this.m_inv_dt0=r.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=s.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(null===this.m_debugDraw)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),n=t.GetPositionBuffer();if(t.m_colorBuffer.data){const s=t.GetColorBuffer();this.m_debugDraw.DrawParticles(n,i,s,e)}else this.m_debugDraw.DrawParticles(n,i,null,e)}}DrawDebugData(){if(null===this.m_debugDraw)return;const e=this.m_debugDraw.GetFlags(),i=dr.DrawDebugData_s_color.SetRGB(0,0,0);if(e&t.b2DrawFlags.e_shapeBit)for(let e=this.m_bodyList;e;e=e.m_next){const n=e.m_xf;this.m_debugDraw.PushTransform(n);for(let n=e.GetFixtureList();n;n=n.m_next)e.IsActive()?e.GetType()===t.b2BodyType.b2_staticBody?(i.SetRGB(.5,.9,.5),this.DrawShape(n,i)):e.GetType()===t.b2BodyType.b2_kinematicBody?(i.SetRGB(.5,.5,.9),this.DrawShape(n,i)):e.IsAwake()?(i.SetRGB(.9,.7,.7),this.DrawShape(n,i)):(i.SetRGB(.6,.6,.6),this.DrawShape(n,i)):(i.SetRGB(.5,.5,.3),this.DrawShape(n,i));this.m_debugDraw.PopTransform(n)}if(e&t.b2DrawFlags.e_particleBit)for(let t=this.m_particleSystemList;t;t=t.m_next)this.DrawParticleSystem(t);if(e&t.b2DrawFlags.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)this.DrawJoint(t);if(e&t.b2DrawFlags.e_aabbBit){i.SetRGB(.9,.3,.9);const t=dr.DrawDebugData_s_vs;for(let e=this.m_bodyList;e;e=e.m_next)if(e.IsActive())for(let n=e.GetFixtureList();n;n=n.m_next)for(let e=0;e<n.m_proxyCount;++e){const s=n.m_proxies[e].treeNode.aabb;t[0].Set(s.lowerBound.x,s.lowerBound.y),t[1].Set(s.upperBound.x,s.lowerBound.y),t[2].Set(s.upperBound.x,s.upperBound.y),t[3].Set(s.lowerBound.x,s.upperBound.y),this.m_debugDraw.DrawPolygon(t,4,i)}}if(e&t.b2DrawFlags.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=dr.DrawDebugData_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}if(e&t.b2DrawFlags.e_controllerBit)for(let t=this.m_controllerList;t;t=t.m_next)t.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof cs?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof cs)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(...t){t[0]instanceof cs?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(e=>{const n=e.userData.fixture;return t?t.ReportFixture(n):!i||i(n)})),t instanceof cs)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(...t){t[0]instanceof cs?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,n,s){const r=dr.QueryFixtureShape_s_aabb;if(e.ComputeAABB(r,n,i),this.m_contactManager.m_broadPhase.Query(r,(r=>{const o=r.userData,a=o.fixture;if(Ee(e,i,a.GetShape(),o.childIndex,n,a.GetBody().GetTransform())){if(t)return t.ReportFixture(a);if(s)return s(a)}return!0})),t instanceof cs)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,r)}QueryAllFixtureShape(t,e,i,n=[]){return this.QueryFixtureShape(t,e,i,(t=>(n.push(t),!0))),n}QueryFixturePoint(...t){t[0]instanceof cs?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(n=>{const s=n.userData.fixture;if(s.TestPoint(e)){if(t)return t.ReportFixture(s);if(i)return i(s)}return!0})),t)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(...t){t[0]instanceof hs?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,n){const s=dr.RayCast_s_input;if(s.maxFraction=1,s.p1.Copy(e),s.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(s,((s,r)=>{const o=r.userData,a=o.fixture,l=o.childIndex,c=dr.RayCast_s_output;if(a.RayCast(c,s,l)){const s=c.fraction,r=dr.RayCast_s_point;if(r.Set((1-s)*e.x+s*i.x,(1-s)*e.y+s*i.y),t)return t.ReportFixture(a,r,c.normal,s);if(n)return n(a,r,c.normal,s)}return s.maxFraction})),t)for(let n=this.m_particleSystemList;n;n=n.m_next)t.ShouldQueryParticleSystem(n)&&n.RayCast(t,e,i)}RayCastOne(t,e){let i=null,n=1;return this.RayCast(t,e,((t,e,s,r)=>(r<n&&(n=r,i=t),n))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,(t=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!xt.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(e){if(this.m_locked)return;e("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),e("this.m_world.SetGravity(g);\n"),e("const bodies: b2Body[] = [];\n"),e("const joints: b2Joint[] = [];\n");let i=0;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandIndex=i,t.Dump(e),++i;i=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=i,++i;for(let i=this.m_jointList;i;i=i.m_next)i.m_type!==t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"));for(let i=this.m_jointList;i;i=i.m_next)i.m_type===t.b2JointType.e_gearJoint&&(e("{\n"),i.Dump(e),e("}\n"))}DrawJoint(e){if(null===this.m_debugDraw)return;const i=e.GetBodyA(),n=e.GetBodyB(),s=i.m_xf,r=n.m_xf,o=s.p,a=r.p,l=e.GetAnchorA(dr.DrawJoint_s_p1),c=e.GetAnchorB(dr.DrawJoint_s_p2),h=dr.DrawJoint_s_color.SetRGB(.5,.8,.8);switch(e.m_type){case t.b2JointType.e_distanceJoint:this.m_debugDraw.DrawSegment(l,c,h);break;case t.b2JointType.e_pulleyJoint:{const t=e,i=t.GetGroundAnchorA(),n=t.GetGroundAnchorB();this.m_debugDraw.DrawSegment(i,l,h),this.m_debugDraw.DrawSegment(n,c,h),this.m_debugDraw.DrawSegment(i,n,h);break}case t.b2JointType.e_mouseJoint:{const t=dr.DrawJoint_s_c;t.Set(0,1,0),this.m_debugDraw.DrawPoint(l,4,t),this.m_debugDraw.DrawPoint(c,4,t),t.Set(.8,.8,.8),this.m_debugDraw.DrawSegment(l,c,t);break}default:this.m_debugDraw.DrawSegment(o,l,h),this.m_debugDraw.DrawSegment(l,c,h),this.m_debugDraw.DrawSegment(a,c,h)}}DrawShape(e,i){if(null===this.m_debugDraw)return;const n=e.GetShape();switch(n.m_type){case t.b2ShapeType.e_circleShape:{const t=n,e=t.m_p,s=t.m_radius,r=xt.UNITX;this.m_debugDraw.DrawSolidCircle(e,s,r,i);break}case t.b2ShapeType.e_edgeShape:{const t=n,e=t.m_vertex1,s=t.m_vertex2;this.m_debugDraw.DrawSegment(e,s,i);break}case t.b2ShapeType.e_chainShape:{const t=n,e=t.m_count,s=t.m_vertices,r=dr.DrawShape_s_ghostColor.SetRGBA(.75*i.r,.75*i.g,.75*i.b,i.a);let o=s[0];if(this.m_debugDraw.DrawPoint(o,4,i),t.m_hasPrevVertex){const e=t.m_prevVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}for(let t=1;t<e;++t){const e=s[t];this.m_debugDraw.DrawSegment(o,e,i),this.m_debugDraw.DrawPoint(e,4,i),o=e}if(t.m_hasNextVertex){const e=t.m_nextVertex;this.m_debugDraw.DrawSegment(e,o,r),this.m_debugDraw.DrawCircle(e,.1,r)}break}case t.b2ShapeType.e_polygonShape:{const t=n,e=t.m_count,s=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(s,e,i);break}}}Solve(e){for(let t=this.m_bodyList;t;t=t.m_next)t.m_xf0.Copy(t.m_xf);for(let t=this.m_controllerList;t;t=t.m_next)t.Step(e);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const i=this.m_island;i.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const n=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsActive())continue;if(s.GetType()===t.b2BodyType.b2_staticBody)continue;i.Clear();let r=0;for(n[r++]=s,s.m_islandFlag=!0;r>0;){const e=n[--r];if(!e)throw new Error;if(i.AddBody(e),e.m_awakeFlag=!0,e.GetType()!==t.b2BodyType.b2_staticBody){for(let t=e.m_contactList;t;t=t.next){const e=t.contact;if(e.m_islandFlag)continue;if(!e.IsEnabled()||!e.IsTouching())continue;const s=e.m_fixtureA.m_isSensor,o=e.m_fixtureB.m_isSensor;if(s||o)continue;i.AddContact(e),e.m_islandFlag=!0;const a=t.other;a.m_islandFlag||(n[r++]=a,a.m_islandFlag=!0)}for(let t=e.m_jointList;t;t=t.next){if(t.joint.m_islandFlag)continue;const e=t.other;e.IsActive()&&(i.AddJoint(t.joint),t.joint.m_islandFlag=!0,e.m_islandFlag||(n[r++]=e,e.m_islandFlag=!0))}}}const o=new us;i.Solve(o,e,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=o.solveInit,this.m_profile.solveVelocity+=o.solveVelocity,this.m_profile.solvePosition+=o.solvePosition;for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];n.GetType()===t.b2BodyType.b2_staticBody&&(n.m_islandFlag=!1)}}for(let t=0;t<n.length&&n[t];++t)n[t]=null;const s=new Rt;for(let e=this.m_bodyList;e;e=e.m_next)e.m_islandFlag&&e.GetType()!==t.b2BodyType.b2_staticBody&&e.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=s.GetMilliseconds()}SolveTOI(e){const i=this.m_island;if(i.Initialize(2*d,d,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let n=null,r=1;for(let e=this.m_contactManager.m_contactList;e;e=e.m_next){if(!e.IsEnabled())continue;if(e.m_toiCount>p)continue;let i=1;if(e.m_toiFlag)i=e.m_toi;else{const n=e.GetFixtureA(),s=e.GetFixtureB();if(n.IsSensor()||s.IsSensor())continue;const r=n.GetBody(),o=s.GetBody(),a=r.m_type,l=o.m_type,c=r.IsAwake()&&a!==t.b2BodyType.b2_staticBody,h=o.IsAwake()&&l!==t.b2BodyType.b2_staticBody;if(!c&&!h)continue;const _=r.IsBullet()||a!==t.b2BodyType.b2_dynamicBody,u=o.IsBullet()||l!==t.b2BodyType.b2_dynamicBody;if(!_&&!u)continue;let m=r.m_sweep.alpha0;r.m_sweep.alpha0<o.m_sweep.alpha0?(m=o.m_sweep.alpha0,r.m_sweep.Advance(m)):o.m_sweep.alpha0<r.m_sweep.alpha0&&(m=r.m_sweep.alpha0,o.m_sweep.Advance(m));const p=e.GetChildIndexA(),d=e.GetChildIndexB(),f=dr.SolveTOI_s_toi_input;f.proxyA.SetShape(n.GetShape(),p),f.proxyB.SetShape(s.GetShape(),d),f.sweepA.Copy(r.m_sweep),f.sweepB.Copy(o.m_sweep),f.tMax=1;const g=dr.SolveTOI_s_toi_output;ri(g,f);const y=g.t;i=g.state===t.b2TOIOutputState.e_touching?tt(m+(1-m)*y,1):1,e.m_toi=i,e.m_toiFlag=!0}i<r&&(n=e,r=i)}if(null===n||1-10*s<r){this.m_stepComplete=!0;break}const o=n.GetFixtureA(),a=n.GetFixtureB(),l=o.GetBody(),c=a.GetBody(),h=dr.SolveTOI_s_backup1.Copy(l.m_sweep),_=dr.SolveTOI_s_backup2.Copy(c.m_sweep);if(l.Advance(r),c.Advance(r),n.Update(this.m_contactManager.m_contactListener),n.m_toiFlag=!1,++n.m_toiCount,!n.IsEnabled()||!n.IsTouching()){n.SetEnabled(!1),l.m_sweep.Copy(h),c.m_sweep.Copy(_),l.SynchronizeTransform(),c.SynchronizeTransform();continue}l.SetAwake(!0),c.SetAwake(!0),i.Clear(),i.AddBody(l),i.AddBody(c),i.AddContact(n),l.m_islandFlag=!0,c.m_islandFlag=!0,n.m_islandFlag=!0;for(let e=0;e<2;++e){const n=0===e?l:c;if(n.m_type===t.b2BodyType.b2_dynamicBody)for(let e=n.m_contactList;e&&i.m_bodyCount!==i.m_bodyCapacity&&i.m_contactCount!==i.m_contactCapacity;e=e.next){const s=e.contact;if(s.m_islandFlag)continue;const o=e.other;if(o.m_type===t.b2BodyType.b2_dynamicBody&&!n.IsBullet()&&!o.IsBullet())continue;const a=s.m_fixtureA.m_isSensor,l=s.m_fixtureB.m_isSensor;if(a||l)continue;const c=dr.SolveTOI_s_backup.Copy(o.m_sweep);o.m_islandFlag||o.Advance(r),s.Update(this.m_contactManager.m_contactListener),s.IsEnabled()&&s.IsTouching()?(s.m_islandFlag=!0,i.AddContact(s),o.m_islandFlag||(o.m_islandFlag=!0,o.m_type!==t.b2BodyType.b2_staticBody&&o.SetAwake(!0),i.AddBody(o))):(o.m_sweep.Copy(c),o.SynchronizeTransform())}}const u=dr.SolveTOI_s_subStep;u.dt=(1-r)*e.dt,u.inv_dt=1/u.dt,u.dtRatio=1,u.positionIterations=20,u.velocityIterations=e.velocityIterations,u.particleIterations=e.particleIterations,u.warmStarting=!1,i.SolveTOI(u,l.m_islandIndex,c.m_islandIndex);for(let e=0;e<i.m_bodyCount;++e){const n=i.m_bodies[e];if(n.m_islandFlag=!1,n.m_type===t.b2BodyType.b2_dynamicBody){n.SynchronizeFixtures();for(let t=n.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}dr.Step_s_step=new ms,dr.Step_s_stepTimer=new Rt,dr.Step_s_timer=new Rt,dr.DrawDebugData_s_color=new Pt(0,0,0),dr.DrawDebugData_s_vs=xt.MakeArray(4),dr.DrawDebugData_s_xf=new wt,dr.QueryFixtureShape_s_aabb=new be,dr.RayCast_s_input=new ve,dr.RayCast_s_output=new xe,dr.RayCast_s_point=new xt,dr.DrawJoint_s_p1=new xt,dr.DrawJoint_s_p2=new xt,dr.DrawJoint_s_color=new Pt(.5,.8,.8),dr.DrawJoint_s_c=new Pt,dr.DrawShape_s_ghostColor=new Pt,dr.SolveTOI_s_subStep=new ms,dr.SolveTOI_s_backup=new Et,dr.SolveTOI_s_backup1=new Et,dr.SolveTOI_s_backup2=new Et,dr.SolveTOI_s_toi_input=new We,dr.SolveTOI_s_toi_output=new Ye;class fr{constructor(t,e){this.prevBody=null,this.nextBody=null,this.prevController=null,this.nextController=null,this.controller=t,this.body=e}}class gr{constructor(){this.m_bodyList=null,this.m_bodyCount=0,this.m_prev=null,this.m_next=null}GetNext(){return this.m_next}GetPrev(){return this.m_prev}GetBodyList(){return this.m_bodyList}AddBody(t){const e=new fr(this,t);e.nextBody=this.m_bodyList,e.prevBody=null,this.m_bodyList&&(this.m_bodyList.prevBody=e),this.m_bodyList=e,++this.m_bodyCount,e.nextController=t.m_controllerList,e.prevController=null,t.m_controllerList&&(t.m_controllerList.prevController=e),t.m_controllerList=e,++t.m_controllerCount}RemoveBody(t){if(this.m_bodyCount<=0)throw new Error;let e=this.m_bodyList;for(;e&&e.body!==t;)e=e.nextBody;if(null===e)throw new Error;e.prevBody&&(e.prevBody.nextBody=e.nextBody),e.nextBody&&(e.nextBody.prevBody=e.prevBody),this.m_bodyList===e&&(this.m_bodyList=e.nextBody),--this.m_bodyCount,e.nextController&&(e.nextController.prevController=e.prevController),e.prevController&&(e.prevController.nextController=e.nextController),t.m_controllerList===e&&(t.m_controllerList=e.nextController),--t.m_controllerCount}Clear(){for(;this.m_bodyList;)this.RemoveBody(this.m_bodyList.body);this.m_bodyCount=0}}class yr extends gr{constructor(){super(...arguments),this.normal=new xt(0,1),this.offset=0,this.density=0,this.velocity=new xt(0,0),this.linearDrag=0,this.angularDrag=0,this.useDensity=!1,this.useWorldGravity=!0,this.gravity=new xt(0,0)}Step(t){if(this.m_bodyList){this.useWorldGravity&&this.gravity.Copy(this.m_bodyList.body.GetWorld().GetGravity());for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;if(!e.IsAwake())continue;const i=new xt,n=new xt;let r=0,o=0;for(let t=e.GetFixtureList();t;t=t.m_next){const s=new xt,a=t.GetShape().ComputeSubmergedArea(this.normal,this.offset,e.GetTransform(),s);r+=a,i.x+=a*s.x,i.y+=a*s.y;let l=0;l=this.useDensity?t.GetDensity():1,o+=a*l,n.x+=a*s.x*l,n.y+=a*s.y*l}if(i.x/=r,i.y/=r,n.x/=o,n.y/=o,r<s)continue;const a=this.gravity.Clone().SelfNeg();a.SelfMul(this.density*r),e.ApplyForce(a,n);const l=e.GetLinearVelocityFromWorldPoint(i,new xt);l.SelfSub(this.velocity),l.SelfMul(-this.linearDrag*r),e.ApplyForce(l,i),e.ApplyTorque(-e.GetInertia()/e.GetMass()*r*e.GetAngularVelocity()*this.angularDrag)}}}Draw(t){const e=100,i=new xt,n=new xt;i.x=this.normal.x*this.offset+this.normal.y*e,i.y=this.normal.y*this.offset-this.normal.x*e,n.x=this.normal.x*this.offset-this.normal.y*e,n.y=this.normal.y*this.offset+this.normal.x*e;const s=new Pt(0,0,.8);t.DrawSegment(i,n,s)}}class vr extends gr{constructor(){super(...arguments),this.A=new xt(0,0)}Step(t){const e=xt.MulSV(t.dt,this.A,vr.Step_s_dtA);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;i.IsAwake()&&i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),e,xt.s_t0))}}Draw(t){}}vr.Step_s_dtA=new xt;class xr extends gr{constructor(){super(...arguments),this.F=new xt(0,0)}Step(t){for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body;e.IsAwake()&&e.ApplyForce(this.F,e.GetWorldCenter())}}Draw(t){}}class br extends gr{constructor(){super(...arguments),this.G=1,this.invSqr=!0}Step(t){if(this.invSqr)for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),l=o.x-i.x,c=o.y-i.y,h=l*l+c*c;if(h<s)continue;const _=br.Step_s_f.Set(l,c);_.SelfMul(this.G/h/at(h)*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}else for(let t=this.m_bodyList;t;t=t.nextBody){const e=t.body,i=e.GetWorldCenter(),n=e.GetMass();for(let r=this.m_bodyList;r&&r!==t;r=r.nextBody){const t=r.body,o=t.GetWorldCenter(),a=t.GetMass(),l=o.x-i.x,c=o.y-i.y,h=l*l+c*c;if(h<s)continue;const _=br.Step_s_f.Set(l,c);_.SelfMul(this.G/h*n*a),e.IsAwake()&&e.ApplyForce(_,i),t.IsAwake()&&t.ApplyForce(_.SelfMul(-1),o)}}}Draw(t){}}br.Step_s_f=new xt;class Sr extends gr{constructor(){super(...arguments),this.T=new At,this.maxTimestep=0}Step(t){let e=t.dt;if(!(e<=s)){e>this.maxTimestep&&this.maxTimestep>0&&(e=this.maxTimestep);for(let t=this.m_bodyList;t;t=t.nextBody){const i=t.body;if(!i.IsAwake())continue;const n=i.GetWorldVector(At.MulMV(this.T,i.GetLocalVector(i.GetLinearVelocity(),xt.s_t0),xt.s_t1),Sr.Step_s_damping);i.SetLinearVelocity(xt.AddVV(i.GetLinearVelocity(),xt.MulSV(e,n,xt.s_t0),xt.s_t1))}}}Draw(t){}SetAxisAligned(t,e){this.T.ex.x=-t,this.T.ex.y=0,this.T.ey.x=0,this.T.ey.y=-e,this.maxTimestep=t>0||e>0?1/et(t,e):0}}Sr.Step_s_damping=new xt;class Ar{constructor(){this.vertices=[],this.count=0,this.masses=[],this.gravity=new xt(0,0),this.damping=.1,this.k2=.9,this.k3=.1}}class Cr{constructor(){this.m_count=0,this.m_ps=[],this.m_p0s=[],this.m_vs=[],this.m_ims=[],this.m_Ls=[],this.m_as=[],this.m_gravity=new xt,this.m_damping=0,this.m_k2=1,this.m_k3=.1}GetVertexCount(){return this.m_count}GetVertices(){return this.m_ps}Initialize(t){this.m_count=t.count,this.m_ps=xt.MakeArray(this.m_count),this.m_p0s=xt.MakeArray(this.m_count),this.m_vs=xt.MakeArray(this.m_count),this.m_ims=K(this.m_count);for(let e=0;e<this.m_count;++e){this.m_ps[e].Copy(t.vertices[e]),this.m_p0s[e].Copy(t.vertices[e]),this.m_vs[e].SetZero();const i=t.masses[e];this.m_ims[e]=i>0?1/i:0}const e=this.m_count-1,i=this.m_count-2;this.m_Ls=K(e),this.m_as=K(i);for(let t=0;t<e;++t){const e=this.m_ps[t],i=this.m_ps[t+1];this.m_Ls[t]=xt.DistanceVV(e,i)}for(let t=0;t<i;++t){const e=this.m_ps[t],i=this.m_ps[t+1],n=this.m_ps[t+2],s=xt.SubVV(i,e,xt.s_t0),r=xt.SubVV(n,i,xt.s_t1),o=xt.CrossVV(s,r),a=xt.DotVV(s,r);this.m_as[t]=dt(o,a)}this.m_gravity.Copy(t.gravity),this.m_damping=t.damping,this.m_k2=t.k2,this.m_k3=t.k3}Step(t,e){if(0===t)return;const i=Math.exp(-t*this.m_damping);for(let e=0;e<this.m_count;++e)this.m_p0s[e].Copy(this.m_ps[e]),this.m_ims[e]>0&&this.m_vs[e].SelfMulAdd(t,this.m_gravity),this.m_vs[e].SelfMul(i),this.m_ps[e].SelfMulAdd(t,this.m_vs[e]);for(let t=0;t<e;++t)this.SolveC2(),this.SolveC3(),this.SolveC2();const n=1/t;for(let t=0;t<this.m_count;++t)xt.MulSV(n,xt.SubVV(this.m_ps[t],this.m_p0s[t],xt.s_t0),this.m_vs[t])}SolveC2(){const t=this.m_count-1;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=xt.SubVV(i,t,Cr.s_d),s=n.Normalize(),r=this.m_ims[e],o=this.m_ims[e+1];if(r+o===0)continue;const a=r/(r+o),l=o/(r+o);t.SelfMulSub(this.m_k2*a*(this.m_Ls[e]-s),n),i.SelfMulAdd(this.m_k2*l*(this.m_Ls[e]-s),n)}}SetAngle(t){const e=this.m_count-2;for(let i=0;i<e;++i)this.m_as[i]=t}SolveC3(){const t=this.m_count-2;for(let e=0;e<t;++e){const t=this.m_ps[e],i=this.m_ps[e+1],n=this.m_ps[e+2],s=this.m_ims[e],r=this.m_ims[e+1],a=this.m_ims[e+2],l=xt.SubVV(i,t,Cr.s_d1),c=xt.SubVV(n,i,Cr.s_d2),h=l.LengthSquared(),_=c.LengthSquared();if(h*_==0)continue;const u=xt.CrossVV(l,c),m=xt.DotVV(l,c);let p=dt(u,m);const d=xt.MulSV(-1/h,l.SelfSkew(),Cr.s_Jd1),f=xt.MulSV(1/_,c.SelfSkew(),Cr.s_Jd2),g=xt.NegV(d,Cr.s_J1),y=xt.SubVV(d,f,Cr.s_J2),v=f;let x=s*xt.DotVV(g,g)+r*xt.DotVV(y,y)+a*xt.DotVV(v,v);if(0===x)continue;x=1/x;let b=p-this.m_as[e];for(;b>o;)p-=2*o,b=p-this.m_as[e];for(;b<-o;)p+=2*o,b=p-this.m_as[e];const S=-this.m_k3*x*b;t.SelfMulAdd(s*S,g),i.SelfMulAdd(r*S,y),n.SelfMulAdd(a*S,v)}}Draw(t){const e=new Pt(.4,.5,.7);for(let i=0;i<this.m_count-1;++i)t.DrawSegment(this.m_ps[i],this.m_ps[i+1],e)}}Cr.s_d=new xt,Cr.s_d1=new xt,Cr.s_d2=new xt,Cr.s_Jd1=new xt,Cr.s_Jd2=new xt,Cr.s_J1=new xt,Cr.s_J2=new xt,t.b2AABB=be,t.b2Abs=Q,t.b2Acos=mt,t.b2Alloc=z,t.b2AreaJoint=Cn,t.b2AreaJointDef=An,t.b2Asin=pt,t.b2Assert=e,t.b2Atan2=dt,t.b2BlockAllocator=Bt,t.b2Body=fn,t.b2BodyDef=dn,t.b2BroadPhase=Ne,t.b2BuoyancyController=yr,t.b2CalculateParticleIterations=Ps,t.b2ChainAndCircleContact=es,t.b2ChainAndPolygonContact=is,t.b2ChainShape=hn,t.b2CircleContact=$n,t.b2CircleShape=an,t.b2Clamp=it,t.b2ClipSegmentToLine=Ae,t.b2ClipVertex=ye,t.b2CollideCircles=li,t.b2CollideEdgeAndCircle=Wi,t.b2CollideEdgeAndPolygon=Qi,t.b2CollidePolygonAndCircle=ui,t.b2CollidePolygons=Li,t.b2Color=Pt,t.b2ConstantAccelController=vr,t.b2ConstantForceController=xr,t.b2Contact=Kn,t.b2ContactEdge=Yn,t.b2ContactFactory=ss,t.b2ContactFeature=ue,t.b2ContactFilter=os,t.b2ContactID=me,t.b2ContactImpulse=as,t.b2ContactListener=ls,t.b2ContactManager=_s,t.b2ContactPositionConstraint=xs,t.b2ContactRegister=ns,t.b2ContactSolver=As,t.b2ContactSolverDef=bs,t.b2ContactVelocityConstraint=vs,t.b2Controller=gr,t.b2ControllerEdge=fr,t.b2Cos=_t,t.b2Counter=Mt,t.b2DegToRad=ct,t.b2DestructionListener=rs,t.b2Distance=Qt,t.b2DistanceInput=zt,t.b2DistanceJoint=Sn,t.b2DistanceJointDef=bn,t.b2DistanceOutput=Vt,t.b2DistanceProxy=Lt,t.b2Draw=It,t.b2DynamicTree=Ie,t.b2EdgeAndCircleContact=Qn,t.b2EdgeAndPolygonContact=ts,t.b2EdgeShape=cn,t.b2Filter=_n,t.b2Fixture=pn,t.b2FixtureDef=un,t.b2FixtureParticleQueryCallback=qs,t.b2FixtureProxy=mn,t.b2Free=V,t.b2FrictionJoint=wn,t.b2FrictionJointDef=Tn,t.b2GearJoint=Pn,t.b2GearJointDef=En,t.b2GetPointStates=ge,t.b2GravityController=br,t.b2GrowableBuffer=Ws,t.b2GrowableStack=Ot,t.b2InvSqrt=ot,t.b2IsPowerOfTwo=gt,t.b2IsValid=st,t.b2Island=Cs,t.b2Jacobian=gn,t.b2Joint=xn,t.b2JointDef=vn,t.b2JointEdge=yn,t.b2Log=U,t.b2MakeArray=X,t.b2MakeNullArray=Y,t.b2MakeNumberArray=K,t.b2Manifold=de,t.b2ManifoldPoint=pe,t.b2MassData=tn,t.b2Mat22=At,t.b2Mat33=Ct,t.b2Max=et,t.b2Maybe=i,t.b2Min=tt,t.b2MixFriction=qn,t.b2MixRestitution=Xn,t.b2MotorJoint=In,t.b2MotorJointDef=Dn,t.b2MouseJoint=Mn,t.b2MouseJointDef=Rn,t.b2NextPowerOfTwo=ft,t.b2Pair=Be,t.b2PairLessThan=Le,t.b2ParseInt=W,t.b2ParseUInt=q,t.b2ParticleBodyContact=Ys,t.b2ParticleContact=Xs,t.b2ParticleDef=Es,t.b2ParticleGroup=Rs,t.b2ParticleGroupDef=Is,t.b2ParticleHandle=Ds,t.b2ParticlePair=Ks,t.b2ParticlePairSet=ar,t.b2ParticleSystem=Zs,t.b2ParticleSystemDef=Js,t.b2ParticleSystem_CompositeShape=_r,t.b2ParticleSystem_ConnectionFilter=lr,t.b2ParticleSystem_DestroyParticlesInShapeCallback=cr,t.b2ParticleSystem_FixedSetAllocator=nr,t.b2ParticleSystem_FixtureParticle=sr,t.b2ParticleSystem_FixtureParticleSet=rr,t.b2ParticleSystem_InsideBoundsEnumerator=er,t.b2ParticleSystem_JoinParticleGroupsFilter=hr,t.b2ParticleSystem_ParticleListNode=ir,t.b2ParticleSystem_ParticlePair=or,t.b2ParticleSystem_Proxy=tr,t.b2ParticleSystem_ReactiveFilter=ur,t.b2ParticleSystem_SolveCollisionCallback=pr,t.b2ParticleSystem_UpdateBodyContactsCallback=mr,t.b2ParticleSystem_UserOverridableBuffer=Qs,t.b2ParticleTriad=$s,t.b2PolygonAndCircleContact=Zn,t.b2PolygonContact=Jn,t.b2PolygonShape=ln,t.b2Position=ps,t.b2PositionSolverManifold=Ss,t.b2Pow=lt,t.b2PrismaticJoint=Bn,t.b2PrismaticJointDef=On,t.b2Profile=us,t.b2PulleyJoint=Fn,t.b2PulleyJointDef=Ln,t.b2QueryCallback=cs,t.b2RadToDeg=ht,t.b2Random=yt,t.b2RandomRange=vt,t.b2RayCastCallback=hs,t.b2RayCastInput=ve,t.b2RayCastOutput=xe,t.b2RevoluteJoint=Vn,t.b2RevoluteJointDef=zn,t.b2Rope=Cr,t.b2RopeDef=Ar,t.b2RopeJoint=Gn,t.b2RopeJointDef=Un,t.b2Rot=Tt,t.b2SeparationFunction=Ke,t.b2Shape=on,t.b2ShapeCast=le,t.b2ShapeCastInput=Ut,t.b2ShapeCastOutput=Gt,t.b2Simplex=jt,t.b2SimplexCache=Ft,t.b2SimplexVertex=Ht,t.b2Sin=ut,t.b2SolverData=fs,t.b2Sq=rt,t.b2Sqrt=at,t.b2StackAllocator=Nt,t.b2Swap=nt,t.b2Sweep=Et,t.b2TOIInput=We,t.b2TOIOutput=Ye,t.b2TensorDampingController=Sr,t.b2TestOverlapAABB=Se,t.b2TestOverlapShape=Ee,t.b2TimeOfImpact=ri,t.b2TimeStep=ms,t.b2Timer=Rt,t.b2Transform=wt,t.b2TreeNode=De,t.b2Vec2=xt,t.b2Vec2_zero=bt,t.b2Vec3=St,t.b2Velocity=ds,t.b2VelocityConstraintPoint=ys,t.b2Version=G,t.b2WeldJoint=Hn,t.b2WeldJointDef=kn,t.b2WheelJoint=Wn,t.b2WheelJointDef=jn,t.b2World=dr,t.b2WorldManifold=fe,t.b2_180_over_pi=J,t.b2_aabbExtension=c,t.b2_aabbMultiplier=h,t.b2_angularSleepTolerance=F,t.b2_angularSlop=u,t.b2_barrierCollisionTime=B,t.b2_baumgarte=A,t.b2_branch=H,t.b2_commit=j,t.b2_epsilon=s,t.b2_epsilon_sq=r,t.b2_gjk_reset=kt,t.b2_invalidParticleIndex=T,t.b2_linearSleepTolerance=L,t.b2_linearSlop=_,t.b2_maxAngularCorrection=y,t.b2_maxFloat=n,t.b2_maxLinearCorrection=g,t.b2_maxManifoldPoints=a,t.b2_maxParticleForce=I,t.b2_maxParticleIndex=w,t.b2_maxParticlePressure=D,t.b2_maxPolygonVertices=l,t.b2_maxRotation=b,t.b2_maxRotationSquared=S,t.b2_maxSubSteps=p,t.b2_maxTOIContacts=d,t.b2_maxTranslation=v,t.b2_maxTranslationSquared=x,t.b2_maxTriadDistance=R,t.b2_maxTriadDistanceSquared=M,t.b2_minParticleSystemBufferCapacity=O,t.b2_minParticleWeight=P,t.b2_minPulleyLength=Nn,t.b2_particleStride=E,t.b2_pi=o,t.b2_pi_over_180=$,t.b2_polygonRadius=m,t.b2_timeToSleep=N,t.b2_toiBaumgarte=C,t.b2_toi_reset=Fe,t.b2_two_pi=Z,t.b2_velocityThreshold=f,t.b2_version=k,t.g_blockSolve=gs,Object.defineProperty(t,"__esModule",{value:!0})}(e)}(e={exports:{}},e.exports),e.exports}();(x1=b1)&&x1.__esModule&&Object.prototype.hasOwnProperty.call(x1,"default")&&x1.default;let S1={};for(var A1 in b1)-1===A1.indexOf("b2_")&&(S1[A1.replace("b2","")]=b1[A1]);var C1=S1;let T1,w1,E1,P1;!function(t){t[t.Static=0]="Static",t[t.Kinematic=1]="Kinematic",t[t.Dynamic=2]="Dynamic",t[t.Animated=3]="Animated"}(T1||(T1=t("ERigidBody2DType",{}))),Nt(T1),function(t){t[t.None=0]="None",t[t.BOX=1]="BOX",t[t.CIRCLE=2]="CIRCLE",t[t.POLYGON=3]="POLYGON"}(w1||(w1=t("ECollider2DType",{}))),Nt(w1),function(t){t[t.None=0]="None",t[t.DISTANCE=1]="DISTANCE",t[t.SPRING=2]="SPRING",t[t.WHEEL=3]="WHEEL",t[t.MOUSE=4]="MOUSE",t[t.FIXED=5]="FIXED",t[t.SLIDER=6]="SLIDER",t[t.RELATIVE=7]="RELATIVE",t[t.HINGE=8]="HINGE"}(E1||(E1=t("EJoint2DType",{}))),Nt(E1),function(t){t[t.Closest=0]="Closest",t[t.Any=1]="Any",t[t.AllClosest=2]="AllClosest",t[t.All=3]="All"}(P1||(P1=t("ERaycast2DType",{})));const D1=t("Contact2DType",{None:"none-contact",BEGIN_CONTACT:"begin-contact",END_CONTACT:"end-contact",PRE_SOLVE:"pre-solve",POST_SOLVE:"post-solve"});let I1;!function(t){t[t.None=0]="None",t[t.Shape=1]="Shape",t[t.Joint=2]="Joint",t[t.Aabb=4]="Aabb",t[t.Pair=8]="Pair",t[t.CenterOfMass=16]="CenterOfMass",t[t.Particle=32]="Particle",t[t.Controller=64]="Controller",t[t.All=63]="All"}(I1||(I1=t("EPhysics2DDrawFlags",{})));const R1=t("PHYSICS_2D_PTM_RATIO",32);class M1 extends C1.ContactListener{constructor(...t){super(...t),this._contactFixtures=[],this._BeginContact=null,this._EndContact=null,this._PreSolve=null,this._PostSolve=null}setBeginContact(t){this._BeginContact=t}setEndContact(t){this._EndContact=t}setPreSolve(t){this._PreSolve=t}setPostSolve(t){this._PostSolve=t}BeginContact(t){if(!this._BeginContact)return;const e=t.GetFixtureA(),i=t.GetFixtureB(),n=this._contactFixtures;t._shouldReport=!1,-1===n.indexOf(e)&&-1===n.indexOf(i)||(t._shouldReport=!0,this._BeginContact(t))}EndContact(t){this._EndContact&&t._shouldReport&&(t._shouldReport=!1,this._EndContact(t))}PreSolve(t,e){this._PreSolve&&t._shouldReport&&this._PreSolve(t,e)}PostSolve(t,e){this._PostSolve&&t._shouldReport&&this._PostSolve(t,e)}registerContactFixture(t){this._contactFixtures.push(t)}unregisterContactFixture(t){j(this._contactFixtures,t)}}class O1 extends C1.QueryCallback{constructor(...t){super(...t),this._point=new C1.Vec2,this._isPoint=!1,this._fixtures=[]}init(t){t?(this._isPoint=!0,this._point.x=t.x,this._point.y=t.y):this._isPoint=!1,this._fixtures.length=0}ReportFixture(t){return this._isPoint?t.TestPoint(this._point)&&this._fixtures.push(t):this._fixtures.push(t),!0}getFixture(){return this._fixtures[0]}getFixtures(){return this._fixtures}}function B1(t,e){const i=e.length;return e[t<0?i- -t%i:t%i]}function N1(t,e,i){const n=[];for(;e<t;)e+=i.length;for(;t<=e;++t)n.push(B1(t,i));return n}function L1(t){j1(t);let e,i,n,s,r,o,a=[],l=new tn,c=new tn,h=0,_=0;for(let u=0;u<t.length;++u)if(z1(u,t)){i=n=1e8;for(let r=0;r<t.length;++r)U1(B1(u-1,t),B1(u,t),B1(r,t))&&k1(B1(u-1,t),B1(u,t),B1(r-1,t))&&(s=q1(B1(u-1,t),B1(u,t),B1(r,t),B1(r-1,t)),V1(B1(u+1,t),B1(u,t),s)&&(e=H1(B1(u,t),s),e<i&&(i=e,l=s,h=r))),U1(B1(u+1,t),B1(u,t),B1(r+1,t))&&k1(B1(u+1,t),B1(u,t),B1(r,t))&&(s=q1(B1(u+1,t),B1(u,t),B1(r,t),B1(r+1,t)),U1(B1(u-1,t),B1(u,t),s)&&(e=H1(B1(u,t),s),e<n&&(n=e,_=r,c=s)));if(h==(_+1)%t.length){const e=l.add(c).multiplyScalar(.5);r=N1(u,_,t),r.push(e),o=N1(h,u,t),o.push(e)}else{let e=0,i=h;for(;_<h;)_+=t.length;for(let n=h;n<=_;++n)if(F1(u,n,t)){let s=1/(H1(B1(u,t),B1(n,t))+1);z1(n,t)?k1(B1(n-1,t),B1(n,t),B1(u,t))&&G1(B1(n+1,t),B1(n,t),B1(u,t))?s+=3:s+=2:s+=1,s>e&&(i=n,e=s)}r=N1(u,i,t),o=N1(i,u,t)}return a=a.concat(L1(r)),a=a.concat(L1(o)),a}a.push(t);for(let t=a.length-1;t>=0;t--)0==a[t].length&&a.splice(t,0);return a}function F1(t,e,i){if(z1(t,i)){if(G1(B1(t,i),B1(t-1,i),B1(e,i))&&k1(B1(t,i),B1(t+1,i),B1(e,i)))return!1}else if(k1(B1(t,i),B1(t+1,i),B1(e,i))||G1(B1(t,i),B1(t-1,i),B1(e,i)))return!1;if(z1(e,i)){if(G1(B1(e,i),B1(e-1,i),B1(t,i))&&k1(B1(e,i),B1(e+1,i),B1(t,i)))return!1}else if(k1(B1(e,i),B1(e+1,i),B1(t,i))||G1(B1(e,i),B1(e-1,i),B1(t,i)))return!1;for(let n=0;n<i.length;++n){if((n+1)%i.length==t||n==t||(n+1)%i.length==e||n==e)continue;const s=new tn;if(X1(B1(t,i),B1(e,i),B1(n,i),B1(n+1,i),s))return!1}return!0}function z1(t,e){return V1(t,e)}function V1(t,e,i){if(void 0===i){const n=t,s=e;t=B1(n-1,s),e=B1(n,s),i=B1(n+1,s)}return Y1(t,e,i)<0}function U1(t,e,i){return Y1(t,e,i)>0}function G1(t,e,i){return Y1(t,e,i)>=0}function k1(t,e,i){return Y1(t,e,i)<=0}function H1(t,e){const i=e.x-t.x,n=e.y-t.y;return i*i+n*n}function j1(t){W1(t)||t.reverse()}function W1(t){return t.length<3||function(t){let e,i=0;for(e=0;e<t.length;e++){const n=(e+1)%t.length;i+=t[e].x*t[n].y,i-=t[e].y*t[n].x}return i/=2,i}(t)>0}function q1(t,e,i,n){const s=new tn,r=e.y-t.y,o=t.x-e.x,a=r*t.x+o*t.y,l=n.y-i.y,c=i.x-n.x,h=l*i.x+c*i.y,_=r*c-l*o;var u;return u=_,0,Math.abs(u-0)<=1e-6||(s.x=(c*a-o*h)/_,s.y=(r*h-l*a)/_),s}function X1(t,e,i,n,s){if(t==i||t==n||e==i||e==n)return!1;const r=t.x,o=t.y,a=e.x,l=e.y,c=i.x,h=i.y,_=n.x,u=n.y;if(Math.max(r,a)<Math.min(c,_)||Math.max(c,_)<Math.min(r,a))return!1;if(Math.max(o,l)<Math.min(h,u)||Math.max(h,u)<Math.min(o,l))return!1;let m=(_-c)*(o-h)-(u-h)*(r-c),p=(a-r)*(o-h)-(l-o)*(r-c);const d=(u-h)*(a-r)-(_-c)*(l-o);return!(Math.abs(d)<1e-6)&&(m/=d,p/=d,m>0&&m<1&&p>0&&p<1&&(s.x=r+m*(a-r),s.y=o+m*(l-o),!0))}function Y1(t,e,i){return t.x*(e.y-i.y)+e.x*(i.y-t.y)+i.x*(t.y-e.y)}var K1=Object.freeze({__proto__:null,ConvexPartition:L1,ForceCounterClockWise:j1,IsCounterClockWise:W1});const $1=()=>0,J1={impl:null,rigidBody:null,isAwake:!1,isSleeping:!1,initialize:$1,setType:$1,setLinearDamping:$1,setAngularDamping:$1,setGravityScale:$1,setFixedRotation:$1,setAllowSleep:$1,isActive:$1,setActive:$1,wakeUp:$1,sleep:$1,getMass:$1,getInertia:$1,getLinearVelocity:$1,setLinearVelocity:$1,getLinearVelocityFromWorldPoint:$1,getAngularVelocity:$1,setAngularVelocity:$1,getLocalVector:$1,getWorldVector:$1,getLocalPoint:$1,getWorldPoint:$1,getLocalCenter:$1,getWorldCenter:$1,applyForce:$1,applyForceToCenter:$1,applyTorque:$1,applyLinearImpulse:$1,applyLinearImpulseToCenter:$1,applyAngularImpulse:$1,onEnable:$1,onDisable:$1,onDestroy:$1},Z1={INITED:!1};const Q1={INITED:!1},t2={impl:null,initialize:$1,setDampingRatio:$1,setFrequency:$1,setMaxForce:$1,setTarget:$1,setDistance:$1,setAngularOffset:$1,setCorrectionFactor:$1,setLinearOffset:$1,setMaxLength:$1,setMaxTorque:$1,setLowerLimit:$1,setUpperLimit:$1,setMaxMotorForce:$1,setMaxMotorTorque:$1,setMotorSpeed:$1,enableLimit:$1,enableMotor:$1,setLowerAngle:$1,setUpperAngle:$1};let e2,i2,n2,s2,r2,o2;!function(t){t[t.DYNAMIC=1]="DYNAMIC",t[t.STATIC=2]="STATIC",t[t.KINEMATIC=4]="KINEMATIC"}(e2||(e2={})),Nt(e2),function(t){t[t.X_AXIS=0]="X_AXIS",t[t.Y_AXIS=1]="Y_AXIS",t[t.Z_AXIS=2]="Z_AXIS"}(i2||(i2={})),Nt(i2),function(t){t[t.VERTEX=1]="VERTEX",t[t.LINE=2]="LINE",t[t.TRIANGLE=3]="TRIANGLE",t[t.TETRAHEDRON=4]="TETRAHEDRON"}(n2||(n2={})),Nt(n2),function(t){t[t.BOX=0]="BOX",t[t.SPHERE=1]="SPHERE",t[t.CAPSULE=2]="CAPSULE",t[t.CYLINDER=3]="CYLINDER",t[t.CONE=4]="CONE",t[t.MESH=5]="MESH",t[t.PLANE=6]="PLANE",t[t.SIMPLEX=7]="SIMPLEX",t[t.TERRAIN=8]="TERRAIN"}(s2||(s2={})),Nt(s2),function(t){t[t.POINT_TO_POINT=0]="POINT_TO_POINT",t[t.HINGE=1]="HINGE",t[t.CONE_TWIST=2]="CONE_TWIST"}(r2||(r2={})),Nt(r2),function(t){t[t.DEFAULT=1]="DEFAULT"}(o2||(o2={})),Nt(o2);class a2{constructor(t){if(1===t){const t=this;for(let e=0;e<32;e++){const i="_"+(1<<e);t[i]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get(){return this[i]},set(t){this[i]!==t&&(this[i]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})}this._1=o2.DEFAULT}else{for(let t=0;t<32;t++)this[""+(1<<t)]=0;this[1]=o2.DEFAULT}}}let l2,c2=null;class h2 extends(ke(Sw)){get enable(){return this._enable}set enable(t){this._enable=t}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this.physicsWorld.setAllowSleep(t)}get gravity(){return this._gravity}set gravity(t){this._gravity.set(t),this.physicsWorld.setGravity(new tn(t.x/R1,t.y/R1))}get maxSubSteps(){return this._maxSubSteps}set maxSubSteps(t){this._maxSubSteps=t}get fixedTimeStep(){return this._fixedTimeStep}set fixedTimeStep(t){this._fixedTimeStep=t}get autoSimulation(){return this._autoSimulation}set autoSimulation(t){this._autoSimulation=t}get debugDrawFlags(){return this.physicsWorld.debugDrawFlags}set debugDrawFlags(t){this.physicsWorld.debugDrawFlags=t}static get PHYSICS_NONE(){return!y1}static get PHYSICS_BUILTIN(){return"builtin"===y1}static get PHYSICS_BOX2D(){return"box2d"===y1}static get instance(){return c2||(c2=new h2),c2}get stepping(){return this._steping}constructor(){super(),this.velocityIterations=10,this.positionIterations=10,this.physicsWorld=void 0,this.collisionMatrix=new a2,this._enable=!0,this._allowSleep=!0,this._maxSubSteps=1,this._fixedTimeStep=1/60,this._autoSimulation=!0,this._accumulator=0,this._steping=!1,this._gravity=new tn(0,-10*R1),this._delayEvents=[];const t=_w.config?_w.config.physics:null;if(t&&(tn.copy(this._gravity,t.gravity),this._gravity.multiplyScalar(R1),this._allowSleep=t.allowSleep,this._fixedTimeStep=t.fixedTimeStep,this._maxSubSteps=t.maxSubSteps,this._autoSimulation=t.autoSimulation,t.collisionMatrix))for(const e in t.collisionMatrix){const i=parseInt(e),n=1<<parseInt(e);this.collisionMatrix[`${n}`]=t.collisionMatrix[i]}this.physicsWorld=new g1.PhysicsWorld,this.gravity=this._gravity,this.allowSleep=this._allowSleep}postUpdate(t){if(!this._enable)return;if(!this._autoSimulation)return;Mw.emit(Rw.EVENT_BEFORE_PHYSICS),this._steping=!0;const e=this._fixedTimeStep,i=this.velocityIterations,n=this.positionIterations;this._accumulator+=t;let s=0;for(;s++<this._maxSubSteps&&this._accumulator>e;)this.physicsWorld.step(e,i,n),this._accumulator-=e;const r=this._delayEvents;for(let t=0,e=r.length;t<e;t++){const e=r[t];e.func.call(e.target)}r.length=0,this.physicsWorld.syncPhysicsToScene(),this.debugDrawFlags&&this.physicsWorld.drawDebug(),this._steping=!1,Mw.emit(Rw.EVENT_AFTER_PHYSICS)}_callAfterStep(t,e){this._steping?this._delayEvents.push({target:t,func:e}):e.call(t)}resetAccumulator(t=0){this._accumulator=t}step(t){this.physicsWorld.step(t,this.velocityIterations,this.positionIterations)}raycast(t,e,i=P1.Closest,n=4294967295){return this.physicsWorld.raycast(t,e,i,n)}testPoint(t){return this.physicsWorld.testPoint(t)}testAABB(t){return this.physicsWorld.testAABB(t)}}var _2,u2,m2,p2,d2,f2,g2,y2,v2,x2,b2,S2,A2,C2,T2,w2,E2,P2;t("PhysicsSystem2D",h2),h2.ID="PHYSICS_2D",Mw.once(Rw.EVENT_INIT,(()=>{h2.PHYSICS_NONE||Mw.registerSystem(h2.ID,h2.instance,Sw.Priority.LOW)})),function(t){t[t.Circles=0]="Circles",t[t.FaceA=1]="FaceA",t[t.FaceB=2]="FaceB"}(l2||(l2=t("Physics2DManifoldType",{})));const{property:D2,type:I2,menu:R2}=Rc;let M2=t("RigidBody2D",(_2=Vl("cc.RigidBody2D"),u2=R2("Physics2D/RigidBody2D"),m2=I2(o2),p2=I2(T1),_2(d2=u2((wl((f2=class extends Rh{constructor(...t){super(...t),Tl(this,"enabledContactListener",g2,this),Tl(this,"bullet",y2,this),Tl(this,"awakeOnLoad",v2,this),this._body=null,Tl(this,"_group",x2,this),Tl(this,"_type",b2,this),Tl(this,"_allowSleep",S2,this),Tl(this,"_gravityScale",A2,this),Tl(this,"_linearDamping",C2,this),Tl(this,"_angularDamping",T2,this),Tl(this,"_linearVelocity",w2,this),Tl(this,"_angularVelocity",E2,this),Tl(this,"_fixedRotation",P2,this)}get group(){return this._group}set group(t){this._group=t}get type(){return this._type}set type(t){this._type=t,this._body&&(t===T1.Animated?this._body.setType(T1.Kinematic):this._body.setType(t))}get allowSleep(){return this._allowSleep}set allowSleep(t){this._allowSleep=t,this._body&&this._body.setAllowSleep(t)}get gravityScale(){return this._gravityScale}set gravityScale(t){this._gravityScale=t,this._body&&this._body.setGravityScale(t)}get linearDamping(){return this._linearDamping}set linearDamping(t){this._linearDamping=t,this._body&&this._body.setLinearDamping(t)}get angularDamping(){return this._angularDamping}set angularDamping(t){this._angularDamping=t,this._body&&this._body.setAngularDamping(t)}get linearVelocity(){return this._body&&this._body.getLinearVelocity(this._linearVelocity),this._linearVelocity}set linearVelocity(t){this._linearVelocity=t,this._body&&this._body.setLinearVelocity(t)}get angularVelocity(){return this._body&&(this._angularVelocity=this._body.getAngularVelocity()),this._angularVelocity}set angularVelocity(t){this._angularVelocity=t,this._body&&this._body.setAngularVelocity(t)}get fixedRotation(){return this._fixedRotation}set fixedRotation(t){this._fixedRotation=t,this._body&&this._body.setFixedRotation(t)}isAwake(){return!!this._body&&this._body.isAwake}wakeUp(){this._body&&this._body.wakeUp()}sleep(){this._body&&this._body.sleep()}getMass(){return this._body?this._body.getMass():0}applyForce(t,e,i){this._body&&this._body.applyForce(t,e,i)}applyForceToCenter(t,e){this._body&&this._body.applyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.applyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&this._body.applyLinearImpulse(t,e,i)}applyLinearImpulseToCenter(t,e){this._body&&this._body.applyLinearImpulseToCenter(t,e)}applyAngularImpulse(t,e){this._body&&this._body.applyAngularImpulse(t,e)}getLinearVelocityFromWorldPoint(t,e){return this._body?this._body.getLinearVelocityFromWorldPoint(t,e):e}getLocalVector(t,e){return this._body?this._body.getLocalVector(t,e):e}getWorldVector(t,e){return this._body?this._body.getWorldVector(t,e):e}getLocalPoint(t,e){return this._body?this._body.getLocalPoint(t,e):e}getWorldPoint(t,e){return this._body?this._body.getWorldPoint(t,e):e}getLocalCenter(t){return this._body?this._body.getLocalCenter(t):t}getWorldCenter(t){return this._body?this._body.getWorldCenter(t):t}getInertia(){return this._body&&this._body.getInertia(),0}onLoad(){this._body=n._global.CC_PHYSICS_2D_BUILTIN?J1:new g1.RigidBody,this._body.initialize(this)}onEnable(){this._body&&this._body.onEnable()}onDisable(){this._body&&this._body.onDisable()}onDestroy(){this._body&&this._body.onDestroy()}get impl(){return this._body}}).prototype,"group",[m2],Object.getOwnPropertyDescriptor(f2.prototype,"group"),f2.prototype),g2=wl(f2.prototype,"enabledContactListener",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),y2=wl(f2.prototype,"bullet",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wl(f2.prototype,"type",[p2],Object.getOwnPropertyDescriptor(f2.prototype,"type"),f2.prototype),wl(f2.prototype,"allowSleep",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"allowSleep"),f2.prototype),wl(f2.prototype,"gravityScale",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"gravityScale"),f2.prototype),wl(f2.prototype,"linearDamping",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"linearDamping"),f2.prototype),wl(f2.prototype,"angularDamping",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"angularDamping"),f2.prototype),wl(f2.prototype,"linearVelocity",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"linearVelocity"),f2.prototype),wl(f2.prototype,"angularVelocity",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"angularVelocity"),f2.prototype),wl(f2.prototype,"fixedRotation",[D2],Object.getOwnPropertyDescriptor(f2.prototype,"fixedRotation"),f2.prototype),v2=wl(f2.prototype,"awakeOnLoad",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x2=wl(f2.prototype,"_group",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o2.DEFAULT}}),b2=wl(f2.prototype,"_type",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return T1.Dynamic}}),S2=wl(f2.prototype,"_allowSleep",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),A2=wl(f2.prototype,"_gravityScale",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),C2=wl(f2.prototype,"_linearDamping",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),T2=wl(f2.prototype,"_angularDamping",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),w2=wl(f2.prototype,"_linearVelocity",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn}}),E2=wl(f2.prototype,"_angularVelocity",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),P2=wl(f2.prototype,"_fixedRotation",[D2],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),d2=f2))||d2)||d2));var O2,B2,N2,L2,F2,z2,V2,U2,G2,k2,H2,j2,W2;let q2=t("Collider2D",(O2=Vl("cc.Collider2D"),B2=yc(o2),O2((W2=class extends(ke(Rh)){constructor(...t){super(...t),Tl(this,"editing",F2,this),Tl(this,"tag",z2,this),this.TYPE=w1.None,this._shape=null,this._body=null,Tl(this,"_group",V2,this),Tl(this,"_density",U2,this),Tl(this,"_sensor",G2,this),Tl(this,"_friction",k2,this),Tl(this,"_restitution",H2,this),Tl(this,"_offset",j2,this)}get group(){return this._group}set group(t){this._group=t,this._shape&&this._shape.onGroupChanged&&this._shape.onGroupChanged()}get density(){return this._density}set density(t){this._density=t}get sensor(){return this._sensor}set sensor(t){this._sensor=t}get friction(){return this._friction}set friction(t){this._friction=t}get restitution(){return this._restitution}set restitution(t){this._restitution=t}get offset(){return this._offset}set offset(t){this._offset=t}get body(){return this._body}get impl(){return this._shape}onLoad(){this._shape=function(t){return Z1.INITED||(Z1.INITED=!0,Z1[w1.BOX]=function(){return new g1.BoxShape},Z1[w1.CIRCLE]=function(){return new g1.CircleShape},Z1[w1.POLYGON]=function(){return new g1.PolygonShape}),Z1[t]()}(this.TYPE),this._shape.initialize(this),this._shape.onLoad&&this._shape.onLoad(),this._body=this.getComponent(M2)}onEnable(){this._shape&&this._shape.onEnable()}onDisable(){this._shape&&this._shape.onDisable&&this._shape.onDisable()}onDestroy(){this._shape&&this._shape.onDestroy&&this._shape.onDestroy()}apply(){this._shape&&this._shape.apply&&this._shape.apply()}get worldAABB(){return this._shape?this._shape.worldAABB:new hn}},F2=wl((L2=W2).prototype,"editing",[ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z2=wl(L2.prototype,"tag",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wl(L2.prototype,"group",[B2],Object.getOwnPropertyDescriptor(L2.prototype,"group"),L2.prototype),wl(L2.prototype,"density",[Hl],Object.getOwnPropertyDescriptor(L2.prototype,"density"),L2.prototype),wl(L2.prototype,"sensor",[Hl],Object.getOwnPropertyDescriptor(L2.prototype,"sensor"),L2.prototype),wl(L2.prototype,"friction",[Hl],Object.getOwnPropertyDescriptor(L2.prototype,"friction"),L2.prototype),wl(L2.prototype,"restitution",[Hl],Object.getOwnPropertyDescriptor(L2.prototype,"restitution"),L2.prototype),wl(L2.prototype,"offset",[Hl],Object.getOwnPropertyDescriptor(L2.prototype,"offset"),L2.prototype),V2=wl(L2.prototype,"_group",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return o2.DEFAULT}}),U2=wl(L2.prototype,"_density",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),G2=wl(L2.prototype,"_sensor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k2=wl(L2.prototype,"_friction",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.2}}),H2=wl(L2.prototype,"_restitution",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j2=wl(L2.prototype,"_offset",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn}}),N2=L2))||N2));var X2,Y2,K2,$2,J2,Z2,Q2,t4,e4,i4,n4,s4,r4,o4,a4,l4,c4,h4,_4,u4,m4,p4;t("BoxCollider2D",Vl("cc.BoxCollider2D")(X2=Jl()((K2=wl((Y2=class extends q2{constructor(...t){super(...t),Tl(this,"_size",K2,this),this.TYPE=w1.BOX}get size(){return this._size}set size(t){this._size=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"_size",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ln(1,1)}}),wl(Y2.prototype,"size",[Hl],Object.getOwnPropertyDescriptor(Y2.prototype,"size"),Y2.prototype),X2=Y2))||X2)||X2),t("CircleCollider2D",Vl("cc.CircleCollider2D")($2=Jl()((Z2=wl((J2=class extends q2{constructor(...t){super(...t),Tl(this,"_radius",Z2,this),this.TYPE=w1.CIRCLE}get radius(){return this._radius}set radius(t){this._radius=t<0?0:t}get worldPosition(){return this._shape?this._shape.worldPosition:new tn}get worldRadius(){return this._shape?this._shape.worldRadius:0}}).prototype,"_radius",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wl(J2.prototype,"radius",[Hl],Object.getOwnPropertyDescriptor(J2.prototype,"radius"),J2.prototype),$2=J2))||$2)||$2),t("PolygonCollider2D",(Q2=Vl("cc.PolygonCollider2D"),t4=Jl(),e4=Hl({serializable:!1}),i4=Hl({type:tn}),Q2(n4=t4((r4=wl((s4=class extends q2{constructor(...t){super(...t),Tl(this,"threshold",r4,this),Tl(this,"_points",o4,this),this.TYPE=w1.POLYGON}get points(){return this._points}set points(t){this._points=t}get worldPoints(){return this._shape?this._shape.worldPoints:[]}}).prototype,"threshold",[e4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),o4=wl(s4.prototype,"_points",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new tn(-1,-1),new tn(1,-1),new tn(1,1),new tn(-1,1)]}}),wl(s4.prototype,"points",[i4],Object.getOwnPropertyDescriptor(s4.prototype,"points"),s4.prototype),n4=s4))||n4)||n4));let d4=t("Joint2D",(a4=Vl("cc.Joint2D"),l4=yc(M2),a4((_4=wl((h4=class extends Rh{constructor(...t){super(...t),Tl(this,"anchor",_4,this),Tl(this,"connectedAnchor",u4,this),Tl(this,"collideConnected",m4,this),Tl(this,"connectedBody",p4,this),this._body=null,this._joint=null,this.TYPE=E1.None}get body(){return this._body}get impl(){return this._joint}onLoad(){this._joint=function(t){return function(){if(Q1.INITED)return;Q1.INITED=!0;const t=n._global.CC_PHYSICS_2D_BUILTIN;Q1[E1.SPRING]=function(){return t?t2:new g1.SpringJoint},Q1[E1.DISTANCE]=function(){return t?t2:new g1.DistanceJoint},Q1[E1.FIXED]=function(){return t?t2:new g1.FixedJoint},Q1[E1.MOUSE]=function(){return t?t2:new g1.MouseJoint},Q1[E1.RELATIVE]=function(){return t?t2:new g1.RelativeJoint},Q1[E1.SLIDER]=function(){return t?t2:new g1.SliderJoint},Q1[E1.WHEEL]=function(){return t?t2:new g1.WheelJoint},Q1[E1.HINGE]=function(){return t?t2:new g1.HingeJoint}}(),Q1[t]()}(this.TYPE),this._joint.initialize(this),this._body=this.getComponent(M2)}onEnable(){this._joint&&this._joint.onEnable&&this._joint.onEnable()}onDisable(){this._joint&&this._joint.onDisable&&this._joint.onDisable()}start(){this._joint&&this._joint.start&&this._joint.start()}onDestroy(){this._joint&&this._joint.onDestroy&&this._joint.onDestroy()}}).prototype,"anchor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn}}),u4=wl(h4.prototype,"connectedAnchor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn}}),m4=wl(h4.prototype,"collideConnected",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),p4=wl(h4.prototype,"connectedBody",[l4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),c4=h4))||c4));var f4,g4,y4,v4,x4,b4,S4,A4,C4,T4,w4,E4,P4,D4,I4,R4,M4,O4,B4,N4,L4,F4,z4;t("DistanceJoint2D",Vl("cc.DistanceJoint2D")(f4=Jl()((wl((g4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.DISTANCE,Tl(this,"_maxLength",y4,this),Tl(this,"_autoCalcDistance",v4,this)}get maxLength(){return this._autoCalcDistance&&this.connectedBody?Ni.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._maxLength}set maxLength(t){this._maxLength=t,this._joint&&this._joint.setMaxLength(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"maxLength",[Hl],Object.getOwnPropertyDescriptor(g4.prototype,"maxLength"),g4.prototype),wl(g4.prototype,"autoCalcDistance",[Hl],Object.getOwnPropertyDescriptor(g4.prototype,"autoCalcDistance"),g4.prototype),y4=wl(g4.prototype,"_maxLength",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),v4=wl(g4.prototype,"_autoCalcDistance",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),f4=g4))||f4)||f4),t("SpringJoint2D",Vl("cc.SpringJoint2D")(x4=Jl()((wl((b4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.SPRING,Tl(this,"_frequency",S4,this),Tl(this,"_dampingRatio",A4,this),Tl(this,"_distance",C4,this),Tl(this,"_autoCalcDistance",T4,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get distance(){return this._autoCalcDistance&&this.connectedBody?Ni.distance(this.node.worldPosition,this.connectedBody.node.worldPosition):this._distance}set distance(t){this._distance=t,this._joint&&this._joint.setDistance(t)}get autoCalcDistance(){return this._autoCalcDistance}set autoCalcDistance(t){this._autoCalcDistance=t}}).prototype,"frequency",[Hl],Object.getOwnPropertyDescriptor(b4.prototype,"frequency"),b4.prototype),wl(b4.prototype,"dampingRatio",[Hl],Object.getOwnPropertyDescriptor(b4.prototype,"dampingRatio"),b4.prototype),wl(b4.prototype,"distance",[Hl],Object.getOwnPropertyDescriptor(b4.prototype,"distance"),b4.prototype),wl(b4.prototype,"autoCalcDistance",[Hl],Object.getOwnPropertyDescriptor(b4.prototype,"autoCalcDistance"),b4.prototype),S4=wl(b4.prototype,"_frequency",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),A4=wl(b4.prototype,"_dampingRatio",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),C4=wl(b4.prototype,"_distance",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),T4=wl(b4.prototype,"_autoCalcDistance",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x4=b4))||x4)||x4),t("MouseJoint2D",Vl("cc.MouseJoint2D")(w4=Jl()((wl((E4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.MOUSE,Tl(this,"_maxForce",P4,this),Tl(this,"_dampingRatio",D4,this),Tl(this,"_frequency",I4,this),this._target=new tn}get target(){return this._target}set target(t){this._target=t,this._joint&&this._joint.setTarget(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}update(t){this._joint.update(t)}}).prototype,"frequency",[Hl],Object.getOwnPropertyDescriptor(E4.prototype,"frequency"),E4.prototype),wl(E4.prototype,"dampingRatio",[Hl],Object.getOwnPropertyDescriptor(E4.prototype,"dampingRatio"),E4.prototype),wl(E4.prototype,"maxForce",[Hl],Object.getOwnPropertyDescriptor(E4.prototype,"maxForce"),E4.prototype),P4=wl(E4.prototype,"_maxForce",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),D4=wl(E4.prototype,"_dampingRatio",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),I4=wl(E4.prototype,"_frequency",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),w4=E4))||w4)||w4);const V4=new Ni,U4=new Ni;var G4,k4,H4,j4,W4,q4,X4,Y4,K4,$4;t("RelativeJoint2D",Vl("cc.RelativeJoint2D")(R4=Jl()((wl((M4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.RELATIVE,Tl(this,"_maxForce",O4,this),Tl(this,"_maxTorque",B4,this),Tl(this,"_correctionFactor",N4,this),Tl(this,"_angularOffset",L4,this),Tl(this,"_linearOffset",F4,this),Tl(this,"_autoCalcOffset",z4,this)}get maxForce(){return this._maxForce}set maxForce(t){this._maxForce=t,this._joint&&this._joint.setMaxForce(t)}get maxTorque(){return this._maxTorque}set maxTorque(t){this._maxTorque=t,this._joint&&this._joint.setMaxTorque(t)}get correctionFactor(){return this._correctionFactor}set correctionFactor(t){this._correctionFactor=t,this._joint&&this._joint.setCorrectionFactor(t)}get linearOffset(){return this._autoCalcOffset&&this.connectedBody?tn.subtract(this._linearOffset,this.connectedBody.node.worldPosition,this.node.worldPosition):this._linearOffset}set linearOffset(t){this._linearOffset.set(t),this._joint&&this._joint.setLinearOffset(t)}get angularOffset(){return this._autoCalcOffset&&this.connectedBody&&(ki.toEuler(V4,this.node.worldRotation),ki.toEuler(U4,this.connectedBody.node.worldRotation),this._angularOffset=U4.z-V4.z),this._angularOffset}set angularOffset(t){this._angularOffset=t,this._joint&&this._joint.setAngularOffset(t)}get autoCalcOffset(){return this._autoCalcOffset}set autoCalcOffset(t){this._autoCalcOffset=t}}).prototype,"maxForce",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"maxForce"),M4.prototype),wl(M4.prototype,"maxTorque",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"maxTorque"),M4.prototype),wl(M4.prototype,"correctionFactor",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"correctionFactor"),M4.prototype),wl(M4.prototype,"linearOffset",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"linearOffset"),M4.prototype),wl(M4.prototype,"angularOffset",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"angularOffset"),M4.prototype),wl(M4.prototype,"autoCalcOffset",[Hl],Object.getOwnPropertyDescriptor(M4.prototype,"autoCalcOffset"),M4.prototype),O4=wl(M4.prototype,"_maxForce",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),B4=wl(M4.prototype,"_maxTorque",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),N4=wl(M4.prototype,"_correctionFactor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),L4=wl(M4.prototype,"_angularOffset",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),F4=wl(M4.prototype,"_linearOffset",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new tn}}),z4=wl(M4.prototype,"_autoCalcOffset",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),R4=M4))||R4)||R4);const J4=new tn;var Z4,Q4,t3,e3,i3,n3,s3,r3,o3,a3,l3,c3,h3,_3,u3,m3,p3,d3,f3,g3;t("SliderJoint2D",Vl("cc.SliderJoint2D")(G4=Jl()((wl((k4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.SLIDER,Tl(this,"_angle",H4,this),Tl(this,"_autoCalcAngle",j4,this),Tl(this,"_enableMotor",W4,this),Tl(this,"_maxMotorForce",q4,this),Tl(this,"_motorSpeed",X4,this),Tl(this,"_enableLimit",Y4,this),Tl(this,"_lowerLimit",K4,this),Tl(this,"_upperLimit",$4,this)}get angle(){return this._autoCalcAngle&&this.connectedBody&&(tn.subtract(J4,this.connectedBody.node.worldPosition,this.node.worldPosition),this._angle=fi(Math.atan2(J4.y,J4.x))),this._angle}set angle(t){this._angle=t}get autoCalcAngle(){return this._autoCalcAngle}set autoCalcAngle(t){this._autoCalcAngle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t}get maxMotorForce(){return this._maxMotorForce}set maxMotorForce(t){this._maxMotorForce=t,this._joint&&this._joint.setMaxMotorForce(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerLimit(){return this._lowerLimit}set lowerLimit(t){this._lowerLimit=t,this._joint&&this._joint.setLowerLimit(t)}get upperLimit(){return this._upperLimit}set upperLimit(t){this._upperLimit=t,this._joint&&this._joint.setUpperLimit(t)}}).prototype,"angle",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"angle"),k4.prototype),wl(k4.prototype,"autoCalcAngle",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"autoCalcAngle"),k4.prototype),wl(k4.prototype,"enableMotor",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"enableMotor"),k4.prototype),wl(k4.prototype,"maxMotorForce",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"maxMotorForce"),k4.prototype),wl(k4.prototype,"motorSpeed",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"motorSpeed"),k4.prototype),wl(k4.prototype,"enableLimit",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"enableLimit"),k4.prototype),wl(k4.prototype,"lowerLimit",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"lowerLimit"),k4.prototype),wl(k4.prototype,"upperLimit",[Hl],Object.getOwnPropertyDescriptor(k4.prototype,"upperLimit"),k4.prototype),H4=wl(k4.prototype,"_angle",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),j4=wl(k4.prototype,"_autoCalcAngle",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),W4=wl(k4.prototype,"_enableMotor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),q4=wl(k4.prototype,"_maxMotorForce",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),X4=wl(k4.prototype,"_motorSpeed",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),Y4=wl(k4.prototype,"_enableLimit",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),K4=wl(k4.prototype,"_lowerLimit",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$4=wl(k4.prototype,"_upperLimit",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),G4=k4))||G4)||G4),t("FixedJoint2D",Vl("cc.FixedJoint2D")(Z4=Jl()((wl((Q4=class extends d4{constructor(...t){super(...t),this.TYPE=E1.FIXED,Tl(this,"_frequency",t3,this),Tl(this,"_dampingRatio",e3,this)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"frequency",[Hl],Object.getOwnPropertyDescriptor(Q4.prototype,"frequency"),Q4.prototype),wl(Q4.prototype,"dampingRatio",[Hl],Object.getOwnPropertyDescriptor(Q4.prototype,"dampingRatio"),Q4.prototype),t3=wl(Q4.prototype,"_frequency",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),e3=wl(Q4.prototype,"_dampingRatio",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Z4=Q4))||Z4)||Z4),t("WheelJoint2D",Vl("cc.WheelJoint2D")(i3=Jl()((wl((n3=class extends d4{constructor(...t){super(...t),this.TYPE=E1.WHEEL,Tl(this,"_angle",s3,this),Tl(this,"_enableMotor",r3,this),Tl(this,"_maxMotorTorque",o3,this),Tl(this,"_motorSpeed",a3,this),Tl(this,"_frequency",l3,this),Tl(this,"_dampingRatio",c3,this)}get angle(){return this._angle}set angle(t){this._angle=t}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._joint&&this._joint.setFrequency(t)}get dampingRatio(){return this._dampingRatio}set dampingRatio(t){this._dampingRatio=t,this._joint&&this._joint.setDampingRatio(t)}}).prototype,"angle",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"angle"),n3.prototype),wl(n3.prototype,"enableMotor",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"enableMotor"),n3.prototype),wl(n3.prototype,"maxMotorTorque",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"maxMotorTorque"),n3.prototype),wl(n3.prototype,"motorSpeed",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"motorSpeed"),n3.prototype),wl(n3.prototype,"frequency",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"frequency"),n3.prototype),wl(n3.prototype,"dampingRatio",[Hl],Object.getOwnPropertyDescriptor(n3.prototype,"dampingRatio"),n3.prototype),s3=wl(n3.prototype,"_angle",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),r3=wl(n3.prototype,"_enableMotor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),o3=wl(n3.prototype,"_maxMotorTorque",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),a3=wl(n3.prototype,"_motorSpeed",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l3=wl(n3.prototype,"_frequency",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),c3=wl(n3.prototype,"_dampingRatio",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.7}}),i3=n3))||i3)||i3),t("HingeJoint2D",Vl("cc.HingeJoint2D")(h3=Jl()((wl((_3=class extends d4{constructor(...t){super(...t),this.TYPE=E1.HINGE,Tl(this,"_enableLimit",u3,this),Tl(this,"_lowerAngle",m3,this),Tl(this,"_upperAngle",p3,this),Tl(this,"_enableMotor",d3,this),Tl(this,"_maxMotorTorque",f3,this),Tl(this,"_motorSpeed",g3,this)}get enableLimit(){return this._enableLimit}set enableLimit(t){this._enableLimit=t}get lowerAngle(){return this._lowerAngle}set lowerAngle(t){this._lowerAngle=t,this._joint&&this._joint.setLowerAngle(t)}get upperAngle(){return this._upperAngle}set upperAngle(t){this._upperAngle=t,this._joint&&this._joint.setUpperAngle(t)}get enableMotor(){return this._enableMotor}set enableMotor(t){this._enableMotor=t,this._joint&&this._joint.enableMotor(t)}get maxMotorTorque(){return this._maxMotorTorque}set maxMotorTorque(t){this._maxMotorTorque=t,this._joint&&this._joint.setMaxMotorTorque(t)}get motorSpeed(){return this._motorSpeed}set motorSpeed(t){this._motorSpeed=t,this._joint&&this._joint.setMotorSpeed(t)}}).prototype,"enableLimit",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"enableLimit"),_3.prototype),wl(_3.prototype,"lowerAngle",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"lowerAngle"),_3.prototype),wl(_3.prototype,"upperAngle",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"upperAngle"),_3.prototype),wl(_3.prototype,"enableMotor",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"enableMotor"),_3.prototype),wl(_3.prototype,"maxMotorTorque",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"maxMotorTorque"),_3.prototype),wl(_3.prototype,"motorSpeed",[Hl],Object.getOwnPropertyDescriptor(_3.prototype,"motorSpeed"),_3.prototype),u3=wl(_3.prototype,"_enableLimit",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),m3=wl(_3.prototype,"_lowerAngle",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p3=wl(_3.prototype,"_upperAngle",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d3=wl(_3.prototype,"_enableMotor",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),f3=wl(_3.prototype,"_maxMotorTorque",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),g3=wl(_3.prototype,"_motorSpeed",[Hl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h3=_3))||h3)||h3),t("Physics2DUtils",{PolygonSeparator:K1});class y3 extends C1.RayCastCallback{constructor(...t){super(...t),this._type=P1.Closest,this._fixtures=[],this._points=[],this._normals=[],this._fractions=[],this._mask=4294967295}init(t,e){this._type=t,this._mask=e,this._fixtures.length=0,this._points.length=0,this._normals.length=0,this._fractions.length=0}ReportFixture(t,e,i,n){return 0==(t.GetFilterData().categoryBits&this._mask)?0:this._type===P1.Closest?(this._fixtures[0]=t,this._points[0]=e,this._normals[0]=i,this._fractions[0]=n,n):(this._fixtures.push(t),this._points.push(new tn(e.x,e.y)),this._normals.push(new tn(i.x,i.y)),this._fractions.push(n),this._type===P1.Any?0:this._type>=P1.All?1:n)}getFixtures(){return this._fixtures}getPoints(){return this._points}getNormals(){return this._normals}getFractions(){return this._fractions}}const v3=[],x3=[new tn,new tn],b3=new C1.WorldManifold,S3={points:[],separations:[],normal:new tn};class A3{constructor(){this.localPoint=new tn,this.normalImpulse=0,this.tangentImpulse=0}}const C3=[new A3,new A3],T3={type:0,localPoint:new tn,localNormal:new tn,points:[]},w3={normalImpulses:[],tangentImpulses:[]};class E3{constructor(){this.colliderA=null,this.colliderB=null,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=null}static get(t){let e=v3.pop();return e||(e=new E3),e.init(t),e}static put(t){const e=t.m_userData;e&&(v3.push(e),e.reset())}_setImpulse(t){this._impulse=t}init(t){this.colliderA=t.m_fixtureA.m_userData.collider,this.colliderB=t.m_fixtureB.m_userData.collider,this.disabled=!1,this.disabledOnce=!1,this._impulse=null,this._inverted=!1,this._b2contact=t,t.m_userData=this}reset(){this.setTangentSpeed(0),this.resetFriction(),this.resetRestitution(),this.colliderA=null,this.colliderB=null,this.disabled=!1,this._impulse=null,this._b2contact.m_userData=null,this._b2contact=null}getWorldManifold(){const t=S3.points,e=S3.separations,i=S3.normal;this._b2contact.GetWorldManifold(b3);const n=b3.points,s=b3.separations,r=this._b2contact.GetManifold().pointCount;t.length=e.length=r;for(let i=0;i<r;i++){const r=x3[i];r.x=n[i].x*R1,r.y=n[i].y*R1,t[i]=r,e[i]=s[i]*R1}return i.x=b3.normal.x,i.y=b3.normal.y,this._inverted&&(i.x*=-1,i.y*=-1),S3}getManifold(){const t=T3.points,e=T3.localNormal,i=T3.localPoint,n=this._b2contact.GetManifold(),s=n.points,r=t.length=n.pointCount;for(let e=0;e<r;e++){const i=C3[e],n=s[e];i.localPoint.x=n.localPoint.x*R1,i.localPoint.y=n.localPoint.y*R1,i.normalImpulse=n.normalImpulse*R1,i.tangentImpulse=n.tangentImpulse,t[e]=i}return i.x=n.localPoint.x*R1,i.y=n.localPoint.y*R1,e.x=n.localNormal.x,e.y=n.localNormal.y,T3.type=n.type,this._inverted&&(e.x*=-1,e.y*=-1),T3}getImpulse(){const t=this._impulse;if(!t)return null;const e=w3.normalImpulses,i=w3.tangentImpulses,n=t.count;for(let s=0;s<n;s++)e[s]=t.normalImpulses[s]*R1,i[s]=t.tangentImpulses[s];return i.length=e.length=n,w3}emit(t){const e=this.colliderA,i=this.colliderB,n=e.body,s=i.body;n.enabledContactListener&&(null==e||e.emit(t,e,i,this)),s.enabledContactListener&&(null==i||i.emit(t,i,e,this)),(n.enabledContactListener||s.enabledContactListener)&&h2.instance.emit(t,e,i),(this.disabled||this.disabledOnce)&&(this.setEnabled(!1),this.disabledOnce=!1)}setEnabled(t){this._b2contact.SetEnabled(t)}isTouching(){return this._b2contact.IsTouching()}setTangentSpeed(t){this._b2contact.SetTangentSpeed(t)}getTangentSpeed(){return this._b2contact.GetTangentSpeed()}setFriction(t){this._b2contact.SetFriction(t)}getFriction(){return this._b2contact.GetFriction()}resetFriction(){return this._b2contact.ResetFriction()}setRestitution(t){this._b2contact.SetRestitution(t)}getRestitution(){return this._b2contact.GetRestitution()}resetRestitution(){return this._b2contact.ResetRestitution()}}const P3=new C1.Vec2,D3=new Ri,I3=Ri.GREEN,R3=Ri.RED;class M3 extends C1.Draw{constructor(t){super(),this._drawer=null,this._xf=new C1.Transform,this._dxf=new C1.Transform,this._drawer=t}_DrawPolygon(t,e){const i=this._drawer;for(let n=0;n<e;n++){C1.Transform.MulXV(this._xf,t[n],P3);const e=P3.x*R1,s=P3.y*R1;0===n?i.moveTo(e,s):i.lineTo(e,s)}i.close()}DrawPolygon(t,e,i){this._applyStrokeColor(i),this._DrawPolygon(t,e),this._drawer.stroke()}DrawSolidPolygon(t,e,i){this._applyFillColor(i),this._DrawPolygon(t,e),this._drawer.fill(),this._drawer.stroke()}_DrawCircle(t,e){const i=this._xf.p;this._drawer.circle((t.x+i.x)*R1,(t.y+i.y)*R1,e*R1)}DrawCircle(t,e,i){this._applyStrokeColor(i),this._DrawCircle(t,e),this._drawer.stroke()}DrawSolidCircle(t,e,i,n){this._applyFillColor(n),this._DrawCircle(t,e),this._drawer.fill()}DrawSegment(t,e,i){const n=this._drawer;if(t.x===e.x&&t.y===e.y)return this._applyFillColor(i),this._DrawCircle(t,2/R1),void n.fill();this._applyStrokeColor(i),C1.Transform.MulXV(this._xf,t,P3),n.moveTo(P3.x*R1,P3.y*R1),C1.Transform.MulXV(this._xf,e,P3),n.lineTo(P3.x*R1,P3.y*R1),n.stroke()}DrawTransform(t){const e=this._drawer;e.strokeColor=R3,P3.x=P3.y=0,C1.Transform.MulXV(t,P3,P3),e.moveTo(P3.x*R1,P3.y*R1),P3.x=1,P3.y=0,C1.Transform.MulXV(t,P3,P3),e.lineTo(P3.x*R1,P3.y*R1),e.stroke(),e.strokeColor=I3,P3.x=P3.y=0,C1.Transform.MulXV(t,P3,P3),e.moveTo(P3.x*R1,P3.y*R1),P3.x=0,P3.y=1,C1.Transform.MulXV(t,P3,P3),e.lineTo(P3.x*R1,P3.y*R1),e.stroke()}DrawPoint(t,e,i){}DrawParticles(){}_applyStrokeColor(t){this._drawer.strokeColor=D3.set(255*t.r,255*t.g,255*t.b,150)}_applyFillColor(t){this._drawer.fillColor=D3.set(255*t.r,255*t.g,255*t.b,150)}PushTransform(t){this._xf=t}PopTransform(){this._xf=this._dxf}}const O3=new Ni,B3=new tn,N3=new tn,L3=new C1.BodyDef,F3=new C1.AABB,z3=[];new Ni;const V3=new C1.Vec2,U3=new C1.Filter;function G3(t){const e=t.collider;return U3.categoryBits=e.group===o2.DEFAULT?e.body.group:e.group,U3.maskBits=h2.instance.collisionMatrix[U3.categoryBits],U3}class k3{constructor(){this._shapes=[],this._fixtures=[],this._collider=null,this._body=null,this._inited=!1,this._rect=new hn}get impl(){return this._shapes}get collider(){return this._collider}initialize(t){this._collider=t}onLoad(){}onEnable(){h2.instance._callAfterStep(this,this._init)}onDisable(){h2.instance._callAfterStep(this,this._destroy)}start(){}onGroupChanged(){const t=G3(this);this._fixtures.forEach((e=>{e.SetFilterData(t)}))}apply(){this._destroy(),this._init()}get worldAABB(){const t=1e7;let e=t,i=t,n=-t,s=-t;const r=this._fixtures;for(let t=0;t<r.length;t++){const o=r[t],a=o.GetShape().GetChildCount();for(let t=0;t<a;t++){const r=o.GetAABB(t);r.lowerBound.x<e&&(e=r.lowerBound.x),r.lowerBound.y<i&&(i=r.lowerBound.y),r.upperBound.x>n&&(n=r.upperBound.x),r.upperBound.y>s&&(s=r.upperBound.y)}}e*=R1,i*=R1,n*=R1,s*=R1;const o=this._rect;return o.x=e,o.y=i,o.width=n-e,o.height=s-i,o}getFixtureIndex(t){return this._fixtures.indexOf(t)}_createShapes(t,e){return[]}_init(){var t;if(this._inited)return;const e=this.collider,i=e.getComponent(M2);if(!i)return;const n=null===(t=i.impl)||void 0===t?void 0:t.impl;if(!n)return;const s=i.node.worldScale,r=0===s.x&&0===s.y?[]:this._createShapes(s.x,s.y),o=G3(this);for(let t=0;t<r.length;t++){const s=r[t],a={density:e.density,isSensor:e.sensor,friction:e.friction,restitution:e.restitution,shape:s,filter:o},l=n.CreateFixture(a);l.m_userData=this,i.enabledContactListener&&h2.instance.physicsWorld.registerContactFixture(l),this._shapes.push(s),this._fixtures.push(l)}this._body=n,this._inited=!0}_destroy(){if(!this._inited)return;const t=this._fixtures,e=this._body;for(let i=t.length-1;i>=0;i--){const n=t[i];n.m_userData=null,h2.instance.physicsWorld.unregisterContactFixture(n),e&&e.DestroyFixture(n)}this._body=null,this._fixtures.length=0,this._shapes.length=0,this._inited=!1}}const H3=new hn;class j3{constructor(){this._b2joint=null,this._jointComp=null,this._body=null,this._inited=!1}get impl(){return this._b2joint}get comp(){return this._jointComp}get body(){return this._body}initialize(t){this._jointComp=t}onEnable(){h2.instance._callAfterStep(this,this._init)}onDisable(){h2.instance._callAfterStep(this,this._destroy)}start(){h2.instance._callAfterStep(this,this._init)}_init(){if(this._inited)return;const t=this._jointComp;if(!t.isValid)return;this._body=t.getComponent(M2);const e=this._createJointDef();if(!e)return;const i=t.connectedBody;i&&i.enabledInHierarchy&&(e.bodyA=this._body.impl.impl,e.bodyB=i.impl.impl,e.collideConnected=t.collideConnected,this._b2joint=h2.instance.physicsWorld.impl.CreateJoint(e),this._inited=!0)}_destroy(){this._inited&&(h2.instance.physicsWorld.impl.DestroyJoint(this._b2joint),this._b2joint=null,this._inited=!1)}_createJointDef(){return null}isValid(){return this._b2joint&&this._body&&this._body.impl&&this._jointComp&&this._jointComp.connectedBody&&this._jointComp.connectedBody.impl}}const W3=new C1.Vec2;var q3,X3;function Y3(t,e,i,n){const s=(n.x-i.x)*(t.y-i.y)-(n.y-i.y)*(t.x-i.x),r=(e.x-t.x)*(t.y-i.y)-(e.y-t.y)*(t.x-i.x),o=(n.y-i.y)*(e.x-t.x)-(n.x-i.x)*(e.y-t.y);if(0!==o){const t=s/o,e=r/o;if(t>=0&&t<=1&&e>=0&&e<=1)return!0}return!1}q3="box2d",X3={PhysicsWorld:class{get impl(){return this._world}constructor(){this._world=void 0,this._bodies=[],this._animatedBodies=[],this._rotationAxis=new Ni,this._contactListener=void 0,this._aabbQueryCallback=void 0,this._raycastQueryCallback=void 0,this._debugGraphics=null,this._b2DebugDrawer=null,this._debugDrawFlags=0,this._world=new C1.World(new C1.Vec2(0,-10));const t=new M1;t.setBeginContact(this._onBeginContact),t.setEndContact(this._onEndContact),t.setPreSolve(this._onPreSolve),t.setPostSolve(this._onPostSolve),this._world.SetContactListener(t),this._contactListener=t,this._aabbQueryCallback=new O1,this._raycastQueryCallback=new y3}get debugDrawFlags(){return this._debugDrawFlags}set debugDrawFlags(t){t||this._debugGraphics&&(this._debugGraphics.node.parent=null),this._debugDrawFlags=t}_checkDebugDrawValid(){if(!this._debugGraphics||!this._debugGraphics.isValid){let t=BC("Canvas");if(!t){const e=Mw.getScene();if(!e)return;t=new Yv("Canvas"),t.addComponent(oG),t.parent=e}const e=new Yv("PHYSICS_2D_DEBUG_DRAW");e.hideFlags|=Me.Flags.DontSave,e.parent=t,e.worldPosition=Ni.ZERO,e.layer=Qm.Enum.UI_2D,this._debugGraphics=e.addComponent(aV),this._debugGraphics.lineWidth=2;const i=new M3(this._debugGraphics);this._b2DebugDrawer=i,this._world.SetDebugDraw(i)}const t=this._debugGraphics.node.parent;this._debugGraphics.node.setSiblingIndex(t.children.length-1),this._b2DebugDrawer&&this._b2DebugDrawer.SetFlags(this.debugDrawFlags)}setGravity(t){this._world.SetGravity(t)}setAllowSleep(t){this._world.SetAllowSleeping(!0)}step(t,e=10,i=10){const n=this._animatedBodies;for(let e=0,i=n.length;e<i;e++)n[e].animate(t);this._world.Step(t,e,i)}raycast(t,e,i,n){if(t.equals(e))return[];i=i||P1.Closest,B3.x=t.x/R1,B3.y=t.y/R1,N3.x=e.x/R1,N3.y=e.y/R1;const s=this._raycastQueryCallback;s.init(i,n),this._world.RayCast(s,B3,N3);const r=s.getFixtures();if(r.length>0){const t=s.getPoints(),e=s.getNormals(),n=s.getFractions(),o=[];for(let s=0,a=r.length;s<a;s++){const a=r[s],l=a.m_userData,c=l.collider;if(i===P1.AllClosest){let i;for(let t=0;t<o.length;t++)o[t].collider===c&&(i=o[t]);if(i){n[s]<i.fraction&&(i.fixtureIndex=l.getFixtureIndex(a),i.point.x=t[s].x*R1,i.point.y=t[s].y*R1,i.normal.x=e[s].x,i.normal.y=e[s].y,i.fraction=n[s]);continue}}o.push({collider:c,fixtureIndex:l.getFixtureIndex(a),point:new tn(t[s].x*R1,t[s].y*R1),normal:new tn(e[s].x,e[s].y),fraction:n[s]})}return o}return[]}syncPhysicsToScene(){const t=this._bodies;for(let e=0,i=t.length;e<i;e++){const i=t[e],n=i.rigidBody;if(n.type===T1.Animated){i.resetVelocity();continue}const s=n.node,r=i.impl,o=r.GetPosition();O3.x=o.x*R1,O3.y=o.y*R1,O3.z=0,s.worldPosition=O3;const a=fi(r.GetAngle());s.setWorldRotationFromEuler(0,0,a)}}syncSceneToPhysics(){const t=this._bodies;for(let e=0;e<t.length;e++)t[e].syncRotationToPhysics(),t[e].syncPositionToPhysics()}addBody(t){if(this._bodies.includes(t))return;const e=L3,i=t.rigidBody;e.allowSleep=i.allowSleep,e.gravityScale=i.gravityScale,e.linearDamping=i.linearDamping,e.angularDamping=i.angularDamping,e.fixedRotation=i.fixedRotation,e.bullet=i.bullet;const n=i.node,s=n.worldPosition;e.position.Set(s.x/R1,s.y/R1),O3.z=ki.getAxisAngle(this._rotationAxis,n.worldRotation),e.angle=O3.z,e.awake=i.awakeOnLoad,i.type===T1.Animated?(e.type=T1.Kinematic,this._animatedBodies.push(t),t._animatedPos.set(e.position.x,e.position.y),t._animatedAngle=e.angle):e.type=i.type;const r=i,o=r._linearVelocity;e.linearVelocity.Set(o.x,o.y),e.angularVelocity=di(r._angularVelocity);const a=this._world.CreateBody(e);a.m_userData=t,t._imp=a,this._bodies.push(t)}removeBody(t){this._bodies.includes(t)&&(t.impl&&(t.impl.m_userData=null,this._world.DestroyBody(t.impl),t._imp=null),Mt.remove(this._bodies,t),t.rigidBody.type===T1.Animated&&Mt.remove(this._animatedBodies,t))}registerContactFixture(t){this._contactListener.registerContactFixture(t)}unregisterContactFixture(t){this._contactListener.unregisterContactFixture(t)}testPoint(t){const e=B3.x=t.x/R1,i=B3.y=t.y/R1,n=.2/R1;F3.lowerBound.x=e-n,F3.lowerBound.y=i-n,F3.upperBound.x=e+n,F3.upperBound.y=i+n;const s=this._aabbQueryCallback;s.init(B3),this._world.QueryAABB(s,F3);const r=s.getFixtures();z3.length=0;for(let t=0;t<r.length;t++){const e=r[t].m_userData.collider;z3.includes(e)||z3.push(e)}return z3}testAABB(t){F3.lowerBound.x=t.xMin/R1,F3.lowerBound.y=t.yMin/R1,F3.upperBound.x=t.xMax/R1,F3.upperBound.y=t.yMax/R1;const e=this._aabbQueryCallback;e.init(),this._world.QueryAABB(e,F3);const i=e.getFixtures();z3.length=0;for(let t=0;t<i.length;t++){const e=i[t].m_userData.collider;z3.includes(e)||z3.push(e)}return z3}drawDebug(){this._checkDebugDrawValid(),this._debugGraphics&&(this._debugGraphics.clear(),this._world.DrawDebugData())}_onBeginContact(t){E3.get(t).emit(D1.BEGIN_CONTACT)}_onEndContact(t){const e=t.m_userData;e&&(e.emit(D1.END_CONTACT),E3.put(t))}_onPreSolve(t){const e=t.m_userData;e&&e.emit(D1.PRE_SOLVE)}_onPostSolve(t,e){const i=t.m_userData;i&&(i._setImpulse(e),i.emit(D1.POST_SOLVE),i._setImpulse(null))}},RigidBody:class{constructor(){this._animatedPos=new tn,this._animatedAngle=0,this._body=null,this._inited=!1}get impl(){return this._body}set _imp(t){this._body=t}get rigidBody(){return this._rigidBody}get isAwake(){return this._body.IsAwake()}get isSleeping(){return!this._body.IsAwake()}initialize(t){this._rigidBody=t,h2.instance._callAfterStep(this,this._init)}onDestroy(){h2.instance._callAfterStep(this,this._destroy)}onEnable(){this.setActive(!0)}onDisable(){this.setActive(!1)}_registerNodeEvents(){this.rigidBody.node.on(ev.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_unregisterNodeEvents(){this.rigidBody.node.off(ev.TRANSFORM_CHANGED,this._onNodeTransformChanged,this)}_onNodeTransformChanged(t){if(!h2.instance.stepping)if(t&Yv.TransformBit.SCALE){const t=this.rigidBody.getComponents(q2);for(let e=0;e<t.length;e++)t[e].apply()}else t&Yv.TransformBit.POSITION&&this.syncPositionToPhysics(!0),t&Yv.TransformBit.ROTATION&&this.syncRotationToPhysics(!0)}_init(){this._inited||(this._registerNodeEvents(),h2.instance.physicsWorld.addBody(this),this._inited=!0)}_destroy(){this._inited&&(h2.instance.physicsWorld.removeBody(this),this._unregisterNodeEvents(),this._inited=!1)}animate(t){const e=this._body;if(!e)return;const i=e.GetPosition();e.SetAwake(!0);const n=1/t;V3.x=(this._animatedPos.x-i.x)*n,V3.y=(this._animatedPos.y-i.y)*n,e.SetLinearVelocity(V3);const s=e.GetAngle();e.SetAngularVelocity((this._animatedAngle-s)*n)}syncPositionToPhysics(t=!1){const e=this._body;if(!e)return;const i=this._rigidBody.node.worldPosition;let n;const s=this._rigidBody.type;n=s===T1.Animated?e.GetLinearVelocity():e.GetPosition(),n.x=i.x/R1,n.y=i.y/R1,s===T1.Animated&&t?this._animatedPos.set(n.x,n.y):e.SetTransformVec(n,e.GetAngle())}syncRotationToPhysics(t=!1){const e=this._body;if(!e)return;const i=di(this._rigidBody.node.eulerAngles.z);this._rigidBody.type===T1.Animated&&t?this._animatedAngle=i:e.SetTransformVec(e.GetPosition(),i)}resetVelocity(){const t=this._body;if(!t)return;const e=t.m_linearVelocity;e.Set(0,0),t.SetLinearVelocity(e),t.SetAngularVelocity(0)}setType(t){this._body.SetType(t)}setLinearDamping(t){this._body.SetLinearDamping(t)}setAngularDamping(t){this._body.SetAngularDamping(t)}setGravityScale(t){this._body.SetGravityScale(t)}setFixedRotation(t){this._body.SetFixedRotation(t)}setAllowSleep(t){this._body.SetSleepingAllowed(t)}isActive(){return this._body.IsActive()}setActive(t){this._body.SetActive(t)}wakeUp(){this._body.SetAwake(!0)}sleep(){this._body.SetAwake(!1)}getMass(){return this._body.GetMass()}setLinearVelocity(t){this._body.SetLinearVelocity(t)}getLinearVelocity(t){const e=this._body.GetLinearVelocity();return t.x=e.x,t.y=e.y,t}getLinearVelocityFromWorldPoint(t,e){return V3.Set(t.x/R1,t.y/R1),this._body.GetLinearVelocityFromWorldPoint(V3,e),e.x*=R1,e.y*=R1,e}setAngularVelocity(t){this._body.SetAngularVelocity(t)}getAngularVelocity(){return fi(this._body.GetAngularVelocity())}getLocalVector(t,e){return e=e||new tn,V3.Set(t.x/R1,t.y/R1),this._body.GetLocalVector(V3,e),e.x*=R1,e.y*=R1,e}getWorldVector(t,e){return V3.Set(t.x/R1,t.y/R1),this._body.GetWorldVector(V3,e),e.x*=R1,e.y*=R1,e}getLocalPoint(t,e){return e=e||new tn,V3.Set(t.x/R1,t.y/R1),this._body.GetLocalPoint(V3,e),e.x*=R1,e.y*=R1,e}getWorldPoint(t,e){return e=e||new tn,V3.Set(t.x/R1,t.y/R1),this._body.GetWorldPoint(V3,e),e.x*=R1,e.y*=R1,e}getLocalCenter(t){t=t||new tn;const e=this._body.GetLocalCenter();return t.x=e.x*R1,t.y=e.y*R1,t}getWorldCenter(t){t=t||new tn;const e=this._body.GetWorldCenter();return t.x=e.x*R1,t.y=e.y*R1,t}getInertia(){return this._body.GetInertia()}applyForce(t,e,i){this._body&&(V3.Set(e.x/R1,e.y/R1),this._body.ApplyForce(t,V3,i))}applyForceToCenter(t,e){this._body&&this._body.ApplyForceToCenter(t,e)}applyTorque(t,e){this._body&&this._body.ApplyTorque(t,e)}applyLinearImpulse(t,e,i){this._body&&(V3.Set(e.x/R1,e.y/R1),this._body.ApplyLinearImpulse(t,V3,i))}applyLinearImpulseToCenter(t,e){this._body&&this._body.ApplyLinearImpulse(t,this._body.GetPosition(),e)}applyAngularImpulse(t,e){this._body&&this._body.ApplyAngularImpulse(t,e)}},BoxShape:class extends k3{constructor(...t){super(...t),this._worldPoints=[new tn,new tn,new tn,new tn]}get worldPoints(){const t=H3,e=this.collider,i=e.size,n=e.offset;t.x=n.x-i.width/2,t.y=n.y-i.height/2,t.width=i.width,t.height=i.height;const s=this._worldPoints,r=s[0],o=s[1],a=s[2],l=s[3];return t.transformMat4ToPoints(e.node.worldMatrix,r,o,a,l),s}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.size.width/2/R1*t,s=i.size.height/2/R1*e,r=i.offset.x/R1*t,o=i.offset.y/R1*e,a=new C1.PolygonShape;return a.SetAsBox(n,s,new C1.Vec2(r,o),0),[a]}},CircleShape:class extends k3{constructor(...t){super(...t),this._worldPosition=new tn}get worldRadius(){return this._shapes[0].m_radius*R1}get worldPosition(){const t=this._shapes[0].m_p;return this._worldPosition.set(t.x*R1,t.y*R1)}_createShapes(t,e){t=Math.abs(t),e=Math.abs(e);const i=this.collider,n=i.offset.x/R1*t,s=i.offset.y/R1*e,r=new C1.CircleShape;return r.m_radius=i.radius/R1*t,r.m_p.Set(n,s),[r]}},PolygonShape:class extends k3{constructor(...t){super(...t),this._worldPoints=[]}get worldPoints(){const t=this.collider,e=t.points,i=this._worldPoints,n=t.node.worldMatrix;for(let t=0;t<e.length;t++)i[t]||(i[t]=new tn),tn.transformMat4(i[t],e[t],n);return i.length=e.length,this._worldPoints}_createShapes(t,e){const i=[],n=this.collider,s=n.points;s.length>0&&s[0].equals(s[s.length-1])&&(s.length-=1);const r=L1(s),o=n.offset;for(let n=0;n<r.length;n++){const s=r[n];let a=null,l=[],c=null;for(let n=0,r=s.length;n<r;n++){a||(a=new C1.PolygonShape);const h=s[n],_=(h.x+o.x)/R1*t,u=(h.y+o.y)/R1*e,m=new C1.Vec2(_,u);l.push(m),c||(c=m),l.length===C1.maxPolygonVertices&&(a.Set(l,l.length),i.push(a),a=null,n<r-1&&(l=[c,l[l.length-1]]))}a&&(a.Set(l,l.length),i.push(a))}return i}},MouseJoint:class extends j3{constructor(...t){super(...t),this._touchPoint=new tn,this._isTouched=!1}setTarget(t){this._b2joint&&(W3.x=t.x/R1,W3.y=t.y/R1,this._b2joint.SetTarget(W3))}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}_createJointDef(){const t=new C1.MouseJointDef,e=this._jointComp;return t.target.Set(this._touchPoint.x/R1,this._touchPoint.y/R1),t.maxForce=e.maxForce,t.dampingRatio=e.dampingRatio,t.frequencyHz=e.frequency,t}initialize(t){super.initialize(t);const e=BC("Canvas");e&&(e.on(ev.TOUCH_START,this.onTouchBegan,this),e.on(ev.TOUCH_MOVE,this.onTouchMove,this),e.on(ev.TOUCH_END,this.onTouchEnd,this),e.on(ev.TOUCH_CANCEL,this.onTouchEnd,this))}onEnable(){}start(){}onTouchBegan(t){this._isTouched=!0;const e=this._touchPoint.set(t.getUILocation()),i=h2.instance.physicsWorld.testPoint(e);if(i.length<=0)return;const n=i[0].body;n.wakeUp();const s=this._jointComp;s.connectedBody=n,this._init(),this.setMaxForce(s.maxForce*n.getMass()),this.setTarget(e)}onTouchMove(t){this._touchPoint=t.getUILocation()}onTouchEnd(t){this._destroy(),this._isTouched=!1}update(){this._isTouched&&this.isValid()&&this.setTarget(this._touchPoint)}},DistanceJoint:class extends j3{setMaxLength(t){this._b2joint&&this._b2joint.SetMaxLength(t)}_createJointDef(){const t=this._jointComp,e=new C1.RopeJointDef;return e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1),e.maxLength=t.maxLength/R1,e}},SpringJoint:class extends j3{setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDistance(t){this._b2joint&&this._b2joint.SetLength(t)}_createJointDef(){const t=this._jointComp,e=new C1.DistanceJointDef;return e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1),e.length=t.distance/R1,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},RelativeJoint:class extends j3{setMaxForce(t){this._b2joint&&this._b2joint.SetMaxForce(t)}setAngularOffset(t){this._b2joint&&this._b2joint.SetAngularOffset(di(t))}setLinearOffset(t){this._b2joint&&this._b2joint.SetLinearOffset(new C1.Vec2(t.x/R1,t.y/R1))}setCorrectionFactor(t){this._b2joint&&(this._b2joint.m_correctionFactor=t)}setMaxTorque(t){this._b2joint&&this._b2joint.SetMaxTorque(t)}_createJointDef(){const t=this._jointComp,e=new C1.MotorJointDef;return e.linearOffset.Set(t.linearOffset.x/R1,t.linearOffset.y/R1),e.angularOffset=di(t.angularOffset),e.maxForce=t.maxForce,e.maxTorque=t.maxTorque,e.correctionFactor=t.correctionFactor,e}},SliderJoint:class extends j3{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerLimit(t){this.updateLimits()}setUpperLimit(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(t.lowerLimit/R1,t.upperLimit/R1)}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorForce(t){this._b2joint&&this._b2joint.SetMaxMotorForce(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new C1.PrismaticJointDef;e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1);const i=di(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.referenceAngle=0,e.enableLimit=t.enableLimit,e.lowerTranslation=t.lowerLimit/R1,e.upperTranslation=t.upperLimit/R1,e.enableMotor=t.enableMotor,e.maxMotorForce=t.maxMotorForce,e.motorSpeed=t.motorSpeed,e}},FixedJoint:class extends j3{setFrequency(t){this._b2joint&&this._b2joint.SetFrequency(t)}setDampingRatio(t){this._b2joint&&this._b2joint.SetDampingRatio(t)}_createJointDef(){const t=this._jointComp,e=new C1.WeldJointDef;return e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1),e.referenceAngle=0,e.frequencyHz=t.frequency,e.dampingRatio=t.dampingRatio,e}},WheelJoint:class extends j3{setDampingRatio(t){this._b2joint&&this._b2joint.SetSpringDampingRatio(t)}setFrequency(t){this._b2joint&&this._b2joint.SetSpringFrequencyHz(t)}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new C1.WheelJointDef;e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1);const i=di(t.angle);return e.localAxisA.Set(Math.cos(i),Math.sin(i)),e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=di(t.motorSpeed),e.enableMotor=t.enableMotor,e.dampingRatio=t.dampingRatio,e.frequencyHz=t.frequency,e}},HingeJoint:class extends j3{enableLimit(t){this._b2joint&&this._b2joint.EnableLimit(t)}setLowerAngle(t){this.updateLimits()}setUpperAngle(t){this.updateLimits()}updateLimits(){if(this._b2joint){const t=this._jointComp;this._b2joint.SetLimits(di(t.lowerAngle),di(t.upperAngle))}}enableMotor(t){this._b2joint&&this._b2joint.EnableMotor(t)}setMaxMotorTorque(t){this._b2joint&&this._b2joint.SetMaxMotorTorque(t)}setMotorSpeed(t){this._b2joint&&this._b2joint.SetMotorSpeed(t)}_createJointDef(){const t=this._jointComp,e=new C1.RevoluteJointDef;return e.localAnchorA.Set(t.anchor.x/R1,t.anchor.y/R1),e.localAnchorB.Set(t.connectedAnchor.x/R1,t.connectedAnchor.y/R1),e.enableMotor=t.enableMotor,e.maxMotorTorque=t.maxMotorTorque,e.motorSpeed=di(t.motorSpeed),e.enableLimit=t.enableLimit,e.lowerAngle=t.lowerAngle,e.upperAngle=t.upperAngle,e}}},y1=q3,n._global.CC_PHYSICS_2D_BUILTIN=!1,n._global.CC_PHYSICS_2D_BOX2D=!0,g1=X3;const K3=new tn,$3=new tn,J3=new tn,Z3=new tn;function Q3(t,e,i){const n=i.length;for(let s=0;s<n;++s)if(Y3(t,e,i[s],i[(s+1)%n]))return!0;return!1}function t5(t,e){let i=!1;const n=t.x,s=t.y,r=e.length;for(let t=0,o=r-1;t<r;o=t++){const r=e[t].x,a=e[t].y,l=e[o].x,c=e[o].y;a>s!=c>s&&n<(l-r)*(s-a)/(c-a)+r&&(i=!i)}return i}function e5(t,e,i,n){let s=i.x-e.x,r=i.y-e.y;const o=s*s+r*r,a=((t.x-e.x)*s+(t.y-e.y)*r)/o;let l;return l=n?o?a<0?e:a>1?i:K3.set(e.x+a*s,e.y+a*r):e:K3.set(e.x+a*s,e.y+a*r),s=t.x-l.x,r=t.y-l.y,Math.sqrt(s*s+r*r)}class i5{}t("Intersection2D",i5),i5.lineLine=Y3,i5.lineRect=function(t,e,i){const n=K3.set(i.x,i.y),s=$3.set(i.x,i.yMax),r=J3.set(i.xMax,i.yMax),o=Z3.set(i.xMax,i.y);return!!(Y3(t,e,n,s)||Y3(t,e,s,r)||Y3(t,e,r,o)||Y3(t,e,o,n))},i5.linePolygon=Q3,i5.rectRect=function(t,e){const i=t.x,n=t.y,s=t.x+t.width,r=t.y+t.height,o=e.x,a=e.y,l=e.x+e.width,c=e.y+e.height;return i<=l&&s>=o&&n<=c&&r>=a},i5.rectPolygon=function(t,e){const i=K3.set(t.x,t.y),n=$3.set(t.x,t.yMax),s=J3.set(t.xMax,t.yMax),r=Z3.set(t.xMax,t.y);if(Q3(i,n,e))return!0;if(Q3(n,s,e))return!0;if(Q3(s,r,e))return!0;if(Q3(r,i,e))return!0;for(let i=0,n=e.length;i<n;++i)if(t.contains(e[i]))return!0;return!!(t5(i,e)||t5(n,e)||t5(s,e)||t5(r,e))},i5.rectCircle=function(t,e,i){const n=e.x,s=e.y,r=t.x,o=t.y,a=t.width,l=t.height;let c=n,h=s;n<r?c=r:n>r+a&&(c=r+a),s<o?h=o:s>o+l&&(h=o+l);const _=n-c,u=s-h;return Math.sqrt(_*_+u*u)<=i},i5.polygonPolygon=function(t,e){let i,n;for(i=0,n=t.length;i<n;++i)if(Q3(t[i],t[(i+1)%n],e))return!0;for(i=0,n=e.length;i<n;++i)if(t5(e[i],t))return!0;for(i=0,n=t.length;i<n;++i)if(t5(t[i],e))return!0;return!1},i5.circleCircle=function(t,e,i,n){return tn.distance(t,i)<e+n},i5.polygonCircle=function(t,e,i){const n=e;if(t5(n,t))return!0;for(let e=0,s=t.length;e<s;e++)if(e5(n,0===e?t[t.length-1]:t[e-1],t[e],!0)<i)return!0;return!1},i5.pointInPolygon=t5,i5.pointLineDistance=e5;class n5{constructor(){this._arrayBufferOrPaddings=[],this._length=0}setNextAlignment(t){if(0!==t){const e=this._length%t;if(0!==e){const i=t-e;this._arrayBufferOrPaddings.push(i),this._length+=i}}}addBuffer(t){const e=this._length;return this._arrayBufferOrPaddings.push(t),this._length+=t.byteLength,e}getLength(){return this._length}getCombined(){const t=new Uint8Array(this._length);let e=0;return this._arrayBufferOrPaddings.forEach((i=>{"number"==typeof i?e+=i:(t.set(new Uint8Array(i),e),e+=i.byteLength)})),t.buffer}}class s5{constructor(t,e){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=t,!this._mesh.struct.morph)return;const i=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(i).fill(null);for(let t=0;t<i;++t){const i=this._mesh.struct.morph.subMeshMorphs[t];i&&(i.targets.length>Wp.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[t]=new o5(this._mesh,t,this._mesh.struct.morph,e):this._subMeshRenderings[t]=new r5(this._mesh,t,this._mesh.struct.morph,e))}}createInstance(){const t=this._mesh.struct.primitives.length,e=new Array(t);for(let s=0;s<t;++s){var i,n;e[s]=null!==(i=null===(n=this._subMeshRenderings[s])||void 0===n?void 0:n.createInstance())&&void 0!==i?i:null}return{setWeights(t,i){var n;null===(n=e[t])||void 0===n||n.setWeights(i)},requiredPatches:t=>{this._mesh.struct.morph;const i=this._mesh.struct.morph.subMeshMorphs[t],n=e[t];if(null===n)return null;const s=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(pr.ATTR_POSITION)&&s.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(pr.ATTR_NORMAL)&&s.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(pr.ATTR_TANGENT)&&s.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),s.push(...n.requiredPatches()),s},adaptPipelineState:(t,i)=>{var n;null===(n=e[t])||void 0===n||n.adaptPipelineState(i)},destroy:()=>{for(const t of e)null==t||t.destroy()}}}}class r5{constructor(t,e,i,n){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=n;const s=i.subMeshMorphs[e];this._subMeshMorph=s,h5(t,e,n);const r=t.struct.vertexBundles[t.struct.primitives[e].vertexBundelIndices[0]].view.count;this._verticesCount=r;const o=s.targets.length,a=c5(n,r*o);this._textureInfo={width:a.width,height:a.height},this._attributes=s.attributes.map(((e,i)=>{const n=a.create(),o=n.valueView;return s.targets.forEach(((e,n)=>{const s=e.displacements[i],a=new Float32Array(t.data.buffer,t.data.byteOffset+s.offset,s.count),l=r*n*4;for(let t=0;t<r;++t)o[l+4*t+0]=a[3*t+0],o[l+4*t+1]=a[3*t+1],o[l+4*t+2]=a[3*t+2]})),n.updatePixels(),{name:e,morphTexture:n}}))}destroy(){for(const t of this._attributes)t.morphTexture.destroy()}createInstance(){const t=new l5(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:e=>{t.setWeights(e),t.commit()},requiredPatches:()=>[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}],adaptPipelineState:e=>{for(const t of this._attributes){let i;switch(t.name){case pr.ATTR_POSITION:i=Kp;break;case pr.ATTR_NORMAL:i=Zp;break;case pr.ATTR_TANGENT:i=ed;break;default:m("Unexpected attribute!")}void 0!==i&&(e.bindSampler(i,t.morphTexture.sampler),e.bindTexture(i,t.morphTexture.texture))}e.bindBuffer(Wp.BINDING,t.buffer),e.update()},destroy:()=>{}}}}class o5{constructor(t,e,i,n){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=n;const s=i.subMeshMorphs[e];h5(t,e,n),this._attributes=s.attributes.map(((e,i)=>({name:e,targets:s.targets.map((e=>({displacements:new Float32Array(t.data.buffer,t.data.byteOffset+e.displacements[i].offset,e.displacements[i].count)})))})))}get data(){return this._attributes}createInstance(){return new a5(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)}}class a5{constructor(t,e,i){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=t,this._morphUniforms=new l5(i,0);const n=c5(i,e);this._morphUniforms.setMorphTextureInfo(n.width,n.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((t=>{const e=n.create();return{attributeName:t.name,morphTexture:e}}))}setWeights(t){for(let e=0;e<this._attributes.length;++e){const i=this._attributes[e],n=i.morphTexture.valueView,s=this._owner.data[e];t.length,s.targets.length;for(let e=0;e<s.targets.length;++e){const i=s.targets[e].displacements,r=t[e],o=i.length/3;if(0===e)for(let t=0;t<o;++t)n[4*t+0]=i[3*t+0]*r,n[4*t+1]=i[3*t+1]*r,n[4*t+2]=i[3*t+2]*r;else if(0!==r)for(let t=0;t<o;++t)n[4*t+0]+=i[3*t+0]*r,n[4*t+1]+=i[3*t+1]*r,n[4*t+2]+=i[3*t+2]*r}i.morphTexture.updatePixels()}}requiredPatches(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]}adaptPipelineState(t){for(const e of this._attributes){let i;switch(e.attributeName){case pr.ATTR_POSITION:i=Kp;break;case pr.ATTR_NORMAL:i=Zp;break;case pr.ATTR_TANGENT:i=ed;break;default:m("Unexpected attribute!")}void 0!==i&&(t.bindSampler(i,e.morphTexture.sampler),t.bindTexture(i,e.morphTexture.texture))}t.bindBuffer(Wp.BINDING,this._morphUniforms.buffer),t.update()}destroy(){this._morphUniforms.destroy();for(let t=0;t<this._attributes.length;++t)this._attributes[t].morphTexture.destroy()}}class l5{constructor(t,e){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=e,this._localBuffer=new DataView(new ArrayBuffer(Wp.SIZE)),this._remoteBuffer=t.createBuffer(new Pr(Ls.UNIFORM|Ls.TRANSFER_DST,Vs.HOST|Vs.DEVICE,Wp.SIZE,Wp.SIZE))}destroy(){this._remoteBuffer.destroy()}get buffer(){return this._remoteBuffer}setWeights(t){t.length,this._targetCount;for(let e=0;e<t.length;++e)this._localBuffer.setFloat32(Wp.OFFSET_OF_WEIGHTS+4*e,t[e],n.sys.isLittleEndian)}setMorphTextureInfo(t,e){this._localBuffer.setFloat32(Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,t,n.sys.isLittleEndian),this._localBuffer.setFloat32(Wp.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,e,n.sys.isLittleEndian)}setVerticesCount(t){this._localBuffer.setFloat32(Wp.OFFSET_OF_VERTICES_COUNT,t,n.sys.isLittleEndian)}commit(){this._remoteBuffer.update(this._localBuffer.buffer)}}function c5(t,e){let i,n,s,r;t.hasFeature(Ms.TEXTURE_FLOAT)?(i=e,s=16,n=Af.PixelFormat.RGBA32F,r=Float32Array):(i=4*e,s=4,n=Af.PixelFormat.RGBA8888,r=Uint8Array);const{width:o,height:a}=function(t){t<5&&(t=5);const e=Xe(Ke(t)),i=e>>1;return{width:1<<(1&e?i+1:i),height:1<<i}}(i);return{width:o,height:a,create:()=>{const e=new ArrayBuffer(o*a*s),i=new Float32Array(e),l=r===Float32Array?i:new r(e),c=new Gd({width:o,height:a,_data:l,_compressed:!1,format:n}),h=new Af;h.setFilters(Af.Filter.NEAREST,Af.Filter.NEAREST),h.setMipFilter(Af.Filter.NONE),h.setWrapMode(Af.WrapMode.CLAMP_TO_EDGE,Af.WrapMode.CLAMP_TO_EDGE,Af.WrapMode.CLAMP_TO_EDGE),h.image=c,h.getGFXTexture()||m("Unexpected: failed to create morph texture?");const _=Xd.getSampler(t,h.getSamplerHash());return{get texture(){return h.getGFXTexture()},get sampler(){return _},get valueView(){return i},destroy(){h.destroy()},updatePixels(){h.uploadData(l)}}}}}function h5(t,e,i){t.renderingSubMeshes[e].enableVertexIdChannel(i)}var _5,u5,m5,p5;function d5(t){switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}const f5=new Ni,g5=new Ni,y5=new Uint8Array;let v5=Vl("cc.Mesh")((m5=wl((u5=class extends _h{get _nativeAsset(){return this._data.buffer}set _nativeAsset(t){this._data=new Uint8Array(t)}get subMeshCount(){const t=this.renderingSubMeshes;return t?t.length:0}get minPosition(){return this.struct.minPosition}get maxPosition(){return this.struct.maxPosition}get struct(){return this._struct}get data(){return this._data}get hash(){return this._hash||(this._hash=Uo(this._data,666)),this._hash}get jointBufferIndices(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((t=>t.jointMapIndex||0))}get renderingSubMeshes(){return this.initialize(),this._renderingSubMeshes}constructor(){super(),this.morphRendering=null,Tl(this,"_struct",m5,this),Tl(this,"_hash",p5,this),this._data=y5,this._initialized=!1,this._renderingSubMeshes=null,this._boneSpaceBounds=new Map,this._jointBufferIndices=null}initialize(){if(this._initialized)return;this._initialized=!0;const{buffer:t}=this._data,e=n.director.root.device,i=this._createVertexBuffers(e,t),s=[];for(let n=0;n<this._struct.primitives.length;n++){const r=this._struct.primitives[n];if(0===r.vertexBundelIndices.length)continue;let o=null,a=null;if(r.indexView){const i=r.indexView;let n=i.stride,s=i.length;if(4===n&&!e.hasFeature(Ms.ELEMENT_INDEX_UINT)){const t=this._struct.vertexBundles[r.vertexBundelIndices[0]].view.count;if(t>=65536){A(10001,t,65536);continue}n>>=1,s>>=1}o=e.createBuffer(new Pr(Ls.INDEX,Vs.DEVICE,s,n)),a=new(d5(i.stride))(t,i.offset,i.count),i.stride!==n&&(a=d5(n).from(a)),o.update(a)}const l=r.vertexBundelIndices.map((t=>i[t])),c=[];if(r.vertexBundelIndices.length>0){const t=r.vertexBundelIndices[0],e=this._struct.vertexBundles[t].attributes;for(let t=0;t<e.length;++t){const i=e[t];c[t]=new Wr(i.name,i.format,i.isInstanced,i.stream,i.isInstanced,i.location)}}const h=new Qb(l,c,r.primitiveMode,o);h.mesh=this,h.subMeshIdx=n,s.push(h)}this._renderingSubMeshes=s,this._struct.morph&&(this.morphRendering=function(t,e){return new s5(t,e)}(this,e))}destroy(){return this.destroyRenderingMesh(),super.destroy()}destroyRenderingMesh(){if(this._renderingSubMeshes){for(let t=0;t<this._renderingSubMeshes.length;t++)this._renderingSubMeshes[t].destroy();this._renderingSubMeshes=null,this._initialized=!1}}assign(t,e){this.reset({struct:t,data:e})}reset(t){this.destroyRenderingMesh(),this._struct=t.struct,this._data=t.data,this._hash=0}getBoneSpaceBounds(t){if(this._boneSpaceBounds.has(t.hash))return this._boneSpaceBounds.get(t.hash);const e=[];this._boneSpaceBounds.set(t.hash,e);const i=[],{bindposes:n}=t;for(let t=0;t<n.length;t++)e.push(new gl(1/0,1/0,1/0,-1/0,-1/0,-1/0)),i.push(!1);const{primitives:s}=this._struct;for(let t=0;t<s.length;t++){const s=this.readAttribute(t,pr.ATTR_JOINTS),r=this.readAttribute(t,pr.ATTR_WEIGHTS),o=this.readAttribute(t,pr.ATTR_POSITION);if(!s||!r||!o)continue;const a=Math.min(s.length/4,r.length/4,o.length/3);for(let t=0;t<a;t++){Ni.set(f5,o[3*t+0],o[3*t+1],o[3*t+2]);for(let o=0;o<4;++o){const a=4*t+o,l=s[a];if(0===r[a]||l>=n.length)continue;Ni.transformMat4(g5,f5,n[l]),i[l]=!0;const c=e[l];Ni.min(c.center,c.center,g5),Ni.max(c.halfExtents,c.halfExtents,g5)}}}for(let t=0;t<n.length;t++){const n=e[t];i[t]?gl.fromPoints(n,n.center,n.halfExtents):e[t]=null}return e}merge(t,e,i){if(i&&!this.validateMergingMesh(t))return!1;const n=new Ni,s=e&&new ki,r=e&&new gl;if(s&&e.getRotation(s),!this._initialized){const i=JSON.parse(JSON.stringify(t._struct)),o=t._data.slice();if(e){i.maxPosition&&i.minPosition&&(Ni.add(r.center,i.maxPosition,i.minPosition),Ni.multiplyScalar(r.center,r.center,.5),Ni.subtract(r.halfExtents,i.maxPosition,i.minPosition),Ni.multiplyScalar(r.halfExtents,r.halfExtents,.5),gl.transform(r,r,e),Ni.add(i.maxPosition,r.center,r.halfExtents),Ni.subtract(i.minPosition,r.center,r.halfExtents));for(let t=0;t<i.vertexBundles.length;t++){const r=i.vertexBundles[t];for(let t=0;t<r.attributes.length;t++)if(r.attributes[t].name===pr.ATTR_POSITION||r.attributes[t].name===pr.ATTR_NORMAL){const{format:i}=r.attributes[t],a=new DataView(o.buffer,r.view.offset+x5(r.attributes,t)),l=A5(a,i),c=C5(a,i);if(!l||!c)continue;const h=r.view.count,_=r.view.stride,u=S5(i);for(let i=0;i<h;i++){const o=i*_,a=o+u,h=a+u;switch(n.set(l(o),l(a),l(h)),r.attributes[t].name){case pr.ATTR_POSITION:n.transformMat4(e);break;case pr.ATTR_NORMAL:Ni.transformQuat(n,n,s)}c(o,n.x),c(a,n.y),c(h,n.z)}}}}return this.reset({struct:i,data:o}),this.initialize(),!0}const o=new n5;let a,l,c,h,_,u=0,m=0,p=0,d=0,f=0,g=0,y=0,v=0,x=!1;const b=new Array(this._struct.vertexBundles.length);for(let i=0;i<this._struct.vertexBundles.length;++i){const r=this._struct.vertexBundles[i],S=t._struct.vertexBundles[i];p=r.view.offset,d=S.view.offset,m=r.view.stride,u=r.view.count+S.view.count,a=new ArrayBuffer(u*m),l=new Uint8Array(a),c=this._data.subarray(p,p+r.view.length),p+=c.length,h=t._data.subarray(d,d+S.view.length),d+=h.length,l.set(c),f=0;for(const t of r.attributes){y=0,x=!1;for(const e of S.attributes){if(t.name===e.name&&t.format===e.format){x=!0;break}y+=fo[e.format].size}if(x){v=fo[t.format].size,g=r.view.length+f;for(let i=0;i<S.view.count;++i){if(_=h.subarray(y,y+v),l.set(_,g),(t.name===pr.ATTR_POSITION||t.name===pr.ATTR_NORMAL)&&e){const i=new Float32Array(l.buffer,g,3);switch(n.set(i[0],i[1],i[2]),t.name){case pr.ATTR_POSITION:n.transformMat4(e);break;case pr.ATTR_NORMAL:Ni.transformQuat(n,n,s)}i[0]=n.x,i[1]=n.y,i[2]=n.z}g+=r.view.stride,y+=S.view.stride}}f+=fo[t.format].size}b[i]={attributes:r.attributes,view:{offset:o.getLength(),length:a.byteLength,count:u,stride:m}},o.addBuffer(a)}let S,A,C,T=0,w=2,E=0;const P=new Array(this._struct.primitives.length);for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];P[e]={primitiveMode:i.primitiveMode,vertexBundelIndices:i.vertexBundelIndices};for(const t of i.vertexBundelIndices)E=Math.max(E,this._struct.vertexBundles[t].view.count);if(i.indexView&&n.indexView){T=i.indexView.count,T+=n.indexView.count,p=i.indexView.offset,d=n.indexView.offset,w=T<256?1:T<65536?2:4;const s=new ArrayBuffer(T*w);if(S=2===w?new Uint16Array(s):1===w?new Uint8Array(s):new Uint32Array(s),A=2===i.indexView.stride?new Uint16Array(this._data.buffer,p,i.indexView.count):1===i.indexView.stride?new Uint8Array(this._data.buffer,p,i.indexView.count):new Uint32Array(this._data.buffer,p,i.indexView.count),w===i.indexView.stride)S.set(A);else for(let t=0;t<i.indexView.count;++t)S[t]=A[t];p+=i.indexView.length,C=2===n.indexView.stride?new Uint16Array(t._data.buffer,d,n.indexView.count):1===n.indexView.stride?new Uint8Array(t._data.buffer,d,n.indexView.count):new Uint32Array(t._data.buffer,d,n.indexView.count);for(let t=0;t<n.indexView.count;++t)S[i.indexView.count+t]=E+C[t];d+=n.indexView.length,P[e].indexView={offset:o.getLength(),length:s.byteLength,count:T,stride:w},o.setNextAlignment(w),o.addBuffer(s)}}const D={vertexBundles:b,primitives:P,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return D.minPosition&&t._struct.minPosition&&D.maxPosition&&t._struct.maxPosition&&(e?(Ni.add(r.center,t._struct.maxPosition,t._struct.minPosition),Ni.multiplyScalar(r.center,r.center,.5),Ni.subtract(r.halfExtents,t._struct.maxPosition,t._struct.minPosition),Ni.multiplyScalar(r.halfExtents,r.halfExtents,.5),gl.transform(r,r,e),Ni.add(n,r.center,r.halfExtents),Ni.max(D.maxPosition,D.maxPosition,n),Ni.subtract(n,r.center,r.halfExtents),Ni.min(D.minPosition,D.minPosition,n)):(Ni.min(D.minPosition,D.minPosition,t._struct.minPosition),Ni.max(D.maxPosition,D.maxPosition,t._struct.maxPosition))),this.reset({struct:D,data:new Uint8Array(o.getCombined())}),this.initialize(),!0}validateMergingMesh(t){if(this._struct.vertexBundles.length!==t._struct.vertexBundles.length)return!1;for(let e=0;e<this._struct.vertexBundles.length;++e){const i=this._struct.vertexBundles[e],n=t._struct.vertexBundles[e];if(i.attributes.length!==n.attributes.length)return!1;for(let t=0;t<i.attributes.length;++t)if(i.attributes[t].format!==n.attributes[t].format)return!1}if(this._struct.primitives.length!==t._struct.primitives.length)return!1;for(let e=0;e<this._struct.primitives.length;++e){const i=this._struct.primitives[e],n=t._struct.primitives[e];if(i.vertexBundelIndices.length!==n.vertexBundelIndices.length)return!1;for(let t=0;t<i.vertexBundelIndices.length;++t)if(i.vertexBundelIndices[t]!==n.vertexBundelIndices[t])return!1;if(i.primitiveMode!==n.primitiveMode)return!1;if(i.indexView){if(void 0===n.indexView)return!1}else if(n.indexView)return!1}return!0}readAttribute(t,e){let i=null;return this._accessAttribute(t,e,((t,e)=>{const n=t.view.count,{format:s}=t.attributes[e],r=To(fo[s]);if(0===n)return;const o=new DataView(this._data.buffer,t.view.offset+x5(t.attributes,e)),a=fo[s],l=A5(o,s);if(!r||!l)return;const c=a.count,h=new r(n*c),_=t.view.stride;for(let t=0;t<n;++t)for(let e=0;e<c;++e)h[c*t+e]=l(_*t+h.BYTES_PER_ELEMENT*e);i=h})),i}copyAttribute(t,e,i,n,s){let r=!1;return this._accessAttribute(t,e,((t,e)=>{const o=t.view.count;if(0===o)return void(r=!0);const{format:a}=t.attributes[e],l=new DataView(this._data.buffer,t.view.offset+x5(t.attributes,e)),c=new DataView(i,s),h=fo[a],_=A5(l,a),u=C5(c,a);if(!_||!u)return;const m=h.count,p=t.view.stride,d=S5(a),f=n,g=d;for(let t=0;t<o;++t)for(let e=0;e<m;++e)u(f*t+g*e,_(p*t+d*e));r=!0})),r}readIndices(t){if(t>=this._struct.primitives.length)return null;const e=this._struct.primitives[t];if(!e.indexView)return null;const{stride:i}=e.indexView;return new(1===i?Uint8Array:2===i?Uint16Array:Uint32Array)(this._data.buffer,e.indexView.offset,e.indexView.count)}copyIndices(t,e){if(t>=this._struct.primitives.length)return!1;const i=this._struct.primitives[t];if(!i.indexView)return!1;const n=i.indexView.count,s=1===i.indexView.stride?Os.R8UI:2===i.indexView.stride?Os.R16UI:Os.R32UI,r=A5(new DataView(this._data.buffer),s);for(let t=0;t<n;++t)e[t]=r(i.indexView.offset+fo[s].size*t);return!0}_accessAttribute(t,e,i){if(t>=this._struct.primitives.length)return;const n=this._struct.primitives[t];for(const t of n.vertexBundelIndices){const n=this._struct.vertexBundles[t],s=n.attributes.findIndex((t=>t.name===e));if(!(s<0)){i(n,s);break}}}_createVertexBuffers(t,e){return this._struct.vertexBundles.map((i=>{const n=t.createBuffer(new Pr(Ls.VERTEX,Vs.DEVICE,i.view.length,i.view.stride)),s=new Uint8Array(e,i.view.offset,i.view.length);return n.update(s),n}))}initDefault(t){super.initDefault(t),this.reset({struct:{vertexBundles:[],primitives:[]},data:y5})}validate(){return this.renderingSubMeshes.length>0&&this.data.byteLength>0}}).prototype,"_struct",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),p5=wl(u5.prototype,"_hash",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_5=u5))||_5;function x5(t,e){let i=0;for(let n=0;n<e;++n){const e=t[n];i+=fo[e.format].size}return i}n.Mesh=v5;const{isLittleEndian:b5}=yn;function S5(t){const e=fo[t];return e.size/e.count}function A5(t,e){const i=fo[e],n=i.size/i.count;switch(i.type){case Bs.UNORM:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,b5);case 4:return e=>t.getUint32(e,b5)}break;case Bs.SNORM:case Bs.INT:switch(n){case 1:return e=>t.getInt8(e);case 2:return e=>t.getInt16(e,b5);case 4:return e=>t.getInt32(e,b5)}break;case Bs.UINT:switch(n){case 1:return e=>t.getUint8(e);case 2:return e=>t.getUint16(e,b5);case 4:return e=>t.getUint32(e,b5)}break;case Bs.FLOAT:return e=>t.getFloat32(e,b5)}return null}function C5(t,e){const i=fo[e],n=i.size/i.count;switch(i.type){case Bs.UNORM:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,b5);case 4:return(e,i)=>t.setUint32(e,i,b5)}break;case Bs.SNORM:case Bs.INT:switch(n){case 1:return(e,i)=>t.setInt8(e,i);case 2:return(e,i)=>t.setInt16(e,i,b5);case 4:return(e,i)=>t.setInt32(e,i,b5)}break;case Bs.UINT:switch(n){case 1:return(e,i)=>t.setUint8(e,i);case 2:return(e,i)=>t.setUint16(e,i,b5);case 4:return(e,i)=>t.setUint32(e,i,b5)}break;case Bs.FLOAT:return(e,i)=>t.setFloat32(e,i,b5)}return null}class T5 extends xg{constructor(...t){super(...t),this._morphRenderingInstance=null,this._usedMaterials=new Set}getMacroPatches(t){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(t):null}initSubModel(t,e,i){return super.initSubModel(t,e,this._launderMaterial(i))}destroy(){super.destroy(),this._morphRenderingInstance=null}setSubModelMaterial(t,e){return super.setSubModelMaterial(t,this._launderMaterial(e))}_updateLocalDescriptors(t,e){super._updateLocalDescriptors(t,e),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,e)}_launderMaterial(t){return t}setMorphRendering(t){this._morphRenderingInstance=t}}var w5,E5,P5,D5,I5,R5,M5,O5,B5,N5,L5,F5,z5,V5,U5,G5,k5,H5,j5,W5,q5,X5,Y5,K5,$5,J5,Z5,Q5,t6,e6;const i6=Nt({OFF:0,ON:1}),n6=Nt({OFF:0,ON:1});let s6=(w5=Vl("cc.ModelLightmapSettings"),E5=ql("_recieveShadow"),w5((I5=wl((D5=class{constructor(){Tl(this,"texture",I5,this),Tl(this,"uvParam",R5,this),Tl(this,"_bakeable",M5,this),Tl(this,"_castShadow",O5,this),Tl(this,"_receiveShadow",B5,this),Tl(this,"_lightmapSize",N5,this)}get bakeable(){return this._bakeable}set bakeable(t){this._bakeable=t}get castShadow(){return this._castShadow}set castShadow(t){this._castShadow=t}get receiveShadow(){return this._receiveShadow}set receiveShadow(t){this._receiveShadow=t}get lightmapSize(){return this._lightmapSize}set lightmapSize(t){this._lightmapSize=t}}).prototype,"texture",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),R5=wl(D5.prototype,"uvParam",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rn}}),M5=wl(D5.prototype,"_bakeable",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),O5=wl(D5.prototype,"_castShadow",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),B5=wl(D5.prototype,"_receiveShadow",[E5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),N5=wl(D5.prototype,"_lightmapSize",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),wl(D5.prototype,"bakeable",[ic],Object.getOwnPropertyDescriptor(D5.prototype,"bakeable"),D5.prototype),wl(D5.prototype,"castShadow",[ic],Object.getOwnPropertyDescriptor(D5.prototype,"castShadow"),D5.prototype),wl(D5.prototype,"receiveShadow",[ic],Object.getOwnPropertyDescriptor(D5.prototype,"receiveShadow"),D5.prototype),wl(D5.prototype,"lightmapSize",[ic],Object.getOwnPropertyDescriptor(D5.prototype,"lightmapSize"),D5.prototype),P5=D5))||P5),r6=(L5=Vl("cc.MeshRenderer"),F5=ec(),z5=Gl(100),V5=Jl(),U5=yc(i6),G5=rc(),k5=yc(n6),H5=rc(),j5=yc(v5),W5=rc(),q5=nc(),L5(X5=F5(X5=z5(X5=V5(X5=$l((e6=t6=class extends zD{get shadowCastingMode(){return this._shadowCastingMode}set shadowCastingMode(t){this._shadowCastingMode=t,this._updateCastShadow()}get receiveShadow(){return this._shadowReceivingMode}set receiveShadow(t){this._shadowReceivingMode=t,this._updateReceiveShadow()}get mesh(){return this._mesh}set mesh(t){const e=this._mesh,i=this._mesh=t;null==i||i.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(e),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}get model(){return this._model}get enableMorph(){return this._enableMorph}set enableMorph(t){this._enableMorph=t}constructor(){super(),Tl(this,"lightmapSettings",K5,this),Tl(this,"_mesh",$5,this),Tl(this,"_shadowCastingMode",J5,this),Tl(this,"_shadowReceivingMode",Z5,this),this._subMeshShapesWeights=[],this._modelType=void 0,this._model=null,this._morphInstance=null,Tl(this,"_enableMorph",Q5,this),this._modelType=xg}onLoad(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onRestore(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()}onEnable(){this._model||this._updateModels(),this._attachToScene()}onDisable(){this._model&&this._detachFromScene()}onDestroy(){this._model&&(n.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()}getWeight(t,e){const{_subMeshShapesWeights:i}=this;i.length;const n=this._subMeshShapesWeights[t];return n.length,n[e]}setWeights(t,e){const{_subMeshShapesWeights:i}=this;e>=i.length||i[e].length===t.length&&(i[e]=t.slice(0),this._uploadSubMeshShapesWeights(e))}setWeight(t,e,i){const{_subMeshShapesWeights:n}=this;if(e>=n.length)return;const s=n[e];i>=s.length||(s[i]=t,this._uploadSubMeshShapesWeights(e))}setInstancedAttribute(t,e){if(!this.model)return;const{attributes:i,views:n}=this.model.instancedAttributes;for(let s=0;s<i.length;s++)if(i[s].name===t){n[s].set(e);break}}_updateLightmap(t,e,i,n,s){this.lightmapSettings.texture=t,this.lightmapSettings.uvParam.x=e,this.lightmapSettings.uvParam.y=i,this.lightmapSettings.uvParam.z=n,this.lightmapSettings.uvParam.w=s,this._onUpdateLightingmap()}_updateModels(){if(!this.enabledInHierarchy||!this._mesh)return;const t=this._model;t?(t.destroy(),t.initialize(),t.node=t.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}_createModel(){const t=this._morphInstance&&this._modelType===xg?T5:this._modelType,e=this._model=n.director.root.createModel(t);e.visFlags=this.visibility,e.node=e.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&e instanceof T5&&e.setMorphRendering(this._morphInstance)}_attachToScene(){if(!this.node.scene||!this._model)return;const t=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),t.addModel(this._model)}_detachFromScene(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)}_updateModelParams(){if(!this._mesh||!this._model)return;this.node.hasChangedFlags|=Sg.POSITION,this._model.transform.hasChangedFlags|=Sg.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();const t=this._mesh?this._mesh.renderingSubMeshes.length:0,e=this._mesh.renderingSubMeshes;if(e)for(let i=0;i<t;++i){let t=this.getRenderMaterial(i);t&&!t.isValid&&(t=null);const n=e[i];n&&this._model.initSubModel(i,n,t||this._getBuiltinMaterial())}this._model.enabled=!0}_onUpdateLightingmap(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])}_onMaterialModified(t,e){this._model&&this._model.inited&&this._onRebuildPSO(t,e||this._getBuiltinMaterial())}_onRebuildPSO(t,e){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(t,e),this._onUpdateLightingmap())}_onMeshChanged(t){}_clearMaterials(){if(!this._model)return;const t=this._model.subModels;for(let e=0;e<t.length;++e)this._onMaterialModified(e,null)}_getBuiltinMaterial(){return rg.get("missing-material")}_onVisibilityChange(t){this._model&&(this._model.visFlags=t)}_updateCastShadow(){this._model&&(this._shadowCastingMode===i6.OFF?this._model.castShadow=!1:(this._shadowCastingMode,i6.ON,this._shadowCastingMode,this._model.castShadow=!0))}_updateReceiveShadow(){this._model&&(this._shadowReceivingMode===n6.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)}_isBatchingEnabled(){for(let t=0;t<this._materials.length;++t){const e=this._materials[t];if(e)for(let t=0;t<e.passes.length;++t)if(e.passes[t].batchingScheme)return!0}return!1}_watchMorphInMesh(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),!this._enableMorph)return;if(!this._mesh||!this._mesh.struct.morph||!this._mesh.morphRendering)return;this._morphInstance=this._mesh.morphRendering.createInstance();const t=this._mesh.struct.primitives.length;for(let e=0;e<t;++e)this._uploadSubMeshShapesWeights(e);this._model&&this._model instanceof T5&&this._model.setMorphRendering(this._morphInstance)}_initSubMeshShapesWeights(){const{_mesh:t}=this;if(this._subMeshShapesWeights.length=0,!t)return;const e=t.struct.morph;if(!e)return;const i=e.weights;this._subMeshShapesWeights=e.subMeshMorphs.map((t=>t?t.weights?t.weights.slice(0):i?(i.length,t.targets.length,i.slice(0)):new Array(t.targets.length).fill(0):[]))}_validateShapeWeights(){const{_mesh:t,_subMeshShapesWeights:e}=this;if(!t||!t.struct.morph)return 0===e.length;const{morph:i}=t.struct;return i.subMeshMorphs.length===e.length&&e.every((({length:t},e)=>{var n,s;return(null!==(n=null===(s=i.subMeshMorphs[e])||void 0===s?void 0:s.targets.length)&&void 0!==n?n:0)===t}))}_uploadSubMeshShapesWeights(t){var e;null===(e=this._morphInstance)||void 0===e||e.setWeights(t,this._subMeshShapesWeights[t])}},t6.ShadowCastingMode=i6,t6.ShadowReceivingMode=n6,K5=wl((Y5=e6).prototype,"lightmapSettings",[Wl,ic,mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new s6}}),$5=wl(Y5.prototype,"_mesh",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),J5=wl(Y5.prototype,"_shadowCastingMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return i6.OFF}}),Z5=wl(Y5.prototype,"_shadowReceivingMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n6.ON}}),wl(Y5.prototype,"shadowCastingMode",[U5,G5,mc],Object.getOwnPropertyDescriptor(Y5.prototype,"shadowCastingMode"),Y5.prototype),wl(Y5.prototype,"receiveShadow",[k5,H5,mc],Object.getOwnPropertyDescriptor(Y5.prototype,"receiveShadow"),Y5.prototype),wl(Y5.prototype,"mesh",[j5,W5],Object.getOwnPropertyDescriptor(Y5.prototype,"mesh"),Y5.prototype),wl(Y5.prototype,"enableMorph",[q5,mc],Object.getOwnPropertyDescriptor(Y5.prototype,"enableMorph"),Y5.prototype),Q5=wl(Y5.prototype,"_enableMorph",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),X5=Y5))||X5)||X5)||X5)||X5)||X5);var o6;!function(t){t[t.positions=pr.ATTR_POSITION]="positions",t[t.normals=pr.ATTR_NORMAL]="normals",t[t.uvs=pr.ATTR_TEX_COORD]="uvs",t[t.colors=pr.ATTR_COLOR]="colors"}(o6||(o6={}));const a6=[new Wr(pr.ATTR_POSITION,Os.RGB32F),new Wr(pr.ATTR_NORMAL,Os.RGB32F),new Wr(pr.ATTR_TEX_COORD,Os.RG32F),new Wr(pr.ATTR_TANGENT,Os.RGBA32F),new Wr(pr.ATTR_COLOR,Os.RGBA32F)],l6=new Ni;var c6;let h6=Vl("cc.PerfCounter")(c6=class extends class{get value(){return this._value}set value(t){this._value=t}constructor(t,e,i){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=t,this._opts=e,this._accumStart=i}sample(t){this._average(this._value,t)}human(){const{average:t,isInteger:e}=this._opts,i=t?this._averageValue:this._value;return e?Math.round(i):Math.round(100*i)/100}alarm(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over}_average(t,e=0){if(this._opts.average){this._accumValue+=t,++this._accumSamples;const i=e;i-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=i,this._accumSamples=0)}}}{constructor(t,e,i){super(t,e,i),this._time=void 0,this._time=i}start(t=0){this._time=t}end(t=0){this._value=t-this._time,this._average(this._value)}tick(){this.end(),this.start()}frame(t){const e=t,i=e-this._time;this._total++,i>(this._opts.average||1e3)&&(this._value=1e3*this._total/i,this._total=0,this._time=e,this._average(this._value))}})||c6;const _6="0123456789. ",u6=500,m6={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},p6={fps:{desc:"Framerate (FPS)",below:30,average:u6,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:u6},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:u6,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:u6},render:{desc:"Renderer (ms)",min:0,max:50,average:u6,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},d6={fontSize:23,quadHeight:.4,segmentsPerLine:8,textureWidth:256,textureHeight:256};class f6{constructor(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new Cr,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=d6.textureHeight/(Object.keys(p6).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}isShowingStats(){return this._showFPS}hideStats(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),n.game.off(n.Game.EVENT_RESTART,this.generateNode,this),n.director.off(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.off(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.off(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.off(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.off(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.off(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,n.game.config.showFPS=!1)}showStats(){this._showFPS||(this._device||(this._device=n.director.root.device),this.generateCanvas(),this.generateStats(),n.game.once(n.Game.EVENT_ENGINE_INITED,this.generateNode,this),n.game.on(n.Game.EVENT_RESTART,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),n.director.on(n.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),n.director.on(n.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),n.director.on(n.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),n.director.on(n.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),n.director.on(n.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),n.director.on(n.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,n.game.config.showFPS=!0)}generateCanvas(){if(this._canvasDone)return;const{textureWidth:t,textureHeight:e}=d6;this._ctx&&this._canvas&&(this._canvas.width=t,this._canvas.height=e,this._canvas.style.width=`${this._canvas.width}`,this._canvas.style.height=`${this._canvas.height}`,this._ctx.font=`${d6.fontSize}px Arial`,this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new Or(Us.TEX2D,Gs.SAMPLED|Gs.TRANSFER_DST,Os.RGBA8,t,e)),this._region.texExtent.width=t,this._region.texExtent.height=e)}generateStats(){if(this._statsDone||!this._ctx||!this._canvas)return;this._stats=null;const t=performance.now();this._ctx.textAlign="left";let e=0;for(const i in p6){const n=p6[i];this._ctx.fillText(n.desc,0,e*this._lineHeight),n.counter=new h6(i,n,t),e++}this._totalLines=e,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(let t=0;t<_6.length;++t){const e=this._ctx.measureText(_6[t]).width;this._eachNumWidth=Math.max(this._eachNumWidth,e)}for(let t=0;t<_6.length;++t)this._ctx.fillText(_6[t],t*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=p6,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}generateNode(){if(this._rootNode&&this._rootNode.isValid)return;this._rootNode=new Yv("PROFILER_NODE"),n.game.addPersistRootNode(this._rootNode);const t=new Yv("Profiler_Camera");t.setPosition(0,0,1.5),t.parent=this._rootNode;const e=t.addComponent("cc.Camera");e.projection=wD.ProjectionType.ORTHO,e.orthoHeight=1,e.near=1,e.far=2,e.visibility=Qm.BitMask.PROFILER,e.clearFlags=mr.NONE,e.priority=4294967295;const i=new Yv("Profiler_Root");i.parent=this._rootNode;const s=d6.quadHeight,r=s/this._totalLines,o=s/this._wordHeight,a=r/d6.fontSize,l=this._eachNumWidth*this._canvas.width*a,c=[0,s,0,o,s,0,o,0,0,0,0,0],h=[0,2,1,0,3,2],_=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0];let u=0;for(let t=0;t<this._totalLines;t++)for(let e=0;e<d6.segmentsPerLine;e++){c.push(o+e*l,s-t*r,0),c.push(o+(e+1)*l,s-t*r,0),c.push(o+(e+1)*l,s-(t+1)*r,0),c.push(o+e*l,s-(t+1)*r,0),u=4*(t*d6.segmentsPerLine+e+1),h.push(0+u,2+u,1+u,0+u,3+u,2+u);const i=t*d6.segmentsPerLine+e,n=Math.floor(i/4),a=i-4*n;_.push(0,this._wordHeight,n,a),_.push(this._eachNumWidth,this._wordHeight,n,a),_.push(this._eachNumWidth,1,n,a),_.push(0,1,n,a)}const m=i.addComponent(r6);m.mesh=function(t,e,i){i=i||{};const n=[];let s=0;const r=[];let o,a=0;const l=t.positions.slice();if(l.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===pr.ATTR_POSITION){o=e;break}o||(o=a6[0]),n.push(o);const e=fo[o.format];a=Math.max(a,Math.floor(l.length/e.count)),r.push({offset:s,data:l,attribute:o}),s+=e.size}if(t.normals&&t.normals.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===pr.ATTR_NORMAL){o=e;break}o||(o=a6[1]);const e=fo[o.format];n.push(o),a=Math.max(a,Math.floor(t.normals.length/e.count)),r.push({offset:s,data:t.normals,attribute:o}),s+=e.size}if(t.uvs&&t.uvs.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===pr.ATTR_TEX_COORD){o=e;break}o||(o=a6[2]);const e=fo[o.format];n.push(o),a=Math.max(a,Math.floor(t.uvs.length/e.count)),r.push({offset:s,data:t.uvs,attribute:o}),s+=e.size}if(t.tangents&&t.tangents.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===pr.ATTR_TANGENT){o=e;break}o||(o=a6[3]);const e=fo[o.format];n.push(o),a=Math.max(a,Math.floor(t.tangents.length/e.count)),r.push({offset:s,data:t.tangents,attribute:o}),s+=e.size}if(t.colors&&t.colors.length>0){if(o=null,t.attributes)for(const e of t.attributes)if(e.name===pr.ATTR_COLOR){o=e;break}o||(o=a6[4]);const e=fo[o.format];n.push(o),a=Math.max(a,Math.floor(t.colors.length/e.count)),r.push({offset:s,data:t.colors,attribute:o}),s+=e.size}if(t.customAttributes)for(const e of t.customAttributes){const t=fo[e.attr.format];n.push(e.attr),a=Math.max(a,Math.floor(e.values.length/t.count)),r.push({offset:s,data:e.values,attribute:e.attr}),s+=t.size}const c=new n5,h=new ArrayBuffer(a*s),_=new DataView(h);for(const t of r)Jb(_,t.data,t.attribute.format,t.offset,s);c.setNextAlignment(0);const u={attributes:n,view:{offset:c.getLength(),length:h.byteLength,count:a,stride:s}};c.addBuffer(h);let m=null,p=0;if(t.indices){const{indices:e}=t;p=e.length,m=new ArrayBuffer(2*p),Jb(new DataView(m),e,Os.R16UI)}const d={primitiveMode:t.primitiveMode||sr.TRIANGLE_LIST,vertexBundelIndices:[0]};m&&(c.setNextAlignment(2),d.indexView={offset:c.getLength(),length:m.byteLength,count:p,stride:2},c.addBuffer(m));let f=t.minPos;if(!f&&i.calculateBounds){f=Ni.set(new Ni,1/0,1/0,1/0);for(let t=0;t<a;++t)Ni.set(l6,l[3*t+0],l[3*t+1],l[3*t+2]),Ni.min(f,f,l6)}let g=t.maxPos;if(!g&&i.calculateBounds){g=Ni.set(new Ni,-1/0,-1/0,-1/0);for(let t=0;t<a;++t)Ni.set(l6,l[3*t+0],l[3*t+1],l[3*t+2]),Ni.max(g,g,l6)}const y={vertexBundles:[u],primitives:[d]};return f&&(y.minPosition=new Ni(f.x,f.y,f.z)),g&&(y.maxPosition=new Ni(g.x,g.y,g.z)),e||(e=new v5),e.reset({struct:y,data:new Uint8Array(c.getCombined())}),e}({positions:c,indices:h,colors:_});const p=new $g;p.initialize({effectName:"profiler"});const d=this.pass=p.passes[0],f=d.getBinding("mainTexture"),g=d.getBinding("digits"),y=d.getBinding("offset");d.bindTexture(f,this._texture),this.digitsData=d.blocks[g],this.offsetData=d.blocks[y],this.offsetData[3]=-1,m.material=p,m.node.layer=Qm.Enum.PROFILER,this._inited=!0}beforeUpdate(){if(!this._stats)return;const t=performance.now();this._stats.frame.counter.start(t),this._stats.logic.counter.start(t)}afterUpdate(){if(!this._stats)return;const t=performance.now();n.director.isPaused()?this._stats.frame.counter.start(t):this._stats.logic.counter.end(t)}beforePhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.start(t)}afterPhysics(){if(!this._stats)return;const t=performance.now();this._stats.physics.counter.end(t)}beforeDraw(){if(!this._stats)return;{const t=this._device.surfaceTransform,e=this._device.capabilities.clipSpaceSignY;if(t!==this.offsetData[3]){const i=Ki[t],n=-.9,s=-.9*e;this.offsetData[0]=n*i[0]+s*i[2],this.offsetData[1]=n*i[1]+s*i[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=t}this.pass._setRootBufferDirty(!0)}const t=performance.now();this._stats.render.counter.start(t)}afterDraw(){if(!this._stats||!this._inited)return;const t=performance.now();if(this._stats.frame.counter.end(t),this._stats.fps.counter.frame(t),this._stats.render.counter.end(t),t-this.lastTime<u6)return;this.lastTime=t;const e=this._device;this._stats.draws.counter.value=e.numDrawCalls,this._stats.instances.counter.value=e.numInstances,this._stats.bufferMemory.counter.value=e.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=e.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=e.numTris;let i=0;{const e=this.digitsData;for(const n in this._stats){const s=this._stats[n];s.counter.sample(t);const r=s.counter.human().toString();for(let t=d6.segmentsPerLine-1;t>=0;t--){const n=i*d6.segmentsPerLine+t,s=r[r.length-(d6.segmentsPerLine-t)];let o=m6[s];void 0===o&&(o=11),e[n]=o}i++}}}}t("Profiler",f6);const g6=t("profiler",new f6);n.profiler=g6;const y6=Nt({GRAVITY:0,RADIUS:1}),v6=Nt({FREE:0,RELATIVE:1,GROUPED:2}),x6=new tn(0,0),b6=new tn,S6=new tn,A6=new tn,C6=new tn,T6=Bz(Mz);class w6{constructor(){this.pos=new tn(0,0),this.startPos=new tn(0,0),this.color=new Ri(0,0,0,255),this.deltaColor={r:0,g:0,b:0,a:255},this.size=0,this.deltaSize=0,this.rotation=0,this.deltaRotation=0,this.timeToLive=0,this.drawPos=new tn(0,0),this.aspectRatio=1,this.dir=new tn(0,0),this.radialAccel=0,this.tangentialAccel=0,this.angle=0,this.degreesPerSecond=0,this.radius=0,this.deltaRadius=0}}const E6=new class extends Rt{get(){return this._get()||new w6}}((t=>{t.pos.set(x6),t.startPos.set(x6),t.color._val=4278190080,t.deltaColor.r=t.deltaColor.g=t.deltaColor.b=0,t.deltaColor.a=255,t.size=0,t.deltaSize=0,t.rotation=0,t.deltaRotation=0,t.timeToLive=0,t.drawPos.set(x6),t.aspectRatio=1,t.dir.set(x6),t.radialAccel=0,t.tangentialAccel=0,t.angle=0,t.degreesPerSecond=0,t.radius=0,t.deltaRadius=0}),1024);class P6{constructor(t){this.particles=[],this.active=!1,this.uvFilled=0,this.finished=!1,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this._worldRotation=0,this.sys=t,this.particles=[],this.active=!1,this.readyToPlay=!0,this.finished=!1,this.elapsed=0,this.emitCounter=0,this.uvFilled=0,this._worldRotation=0}stop(){this.active=!1,this.readyToPlay=!1,this.elapsed=this.sys.duration,this.emitCounter=0}reset(){this.active=!0,this.readyToPlay=!0,this.elapsed=0,this.emitCounter=0,this.finished=!1;const t=this.particles;for(let e=0;e<t.length;++e)E6.put(t[e]);t.length=0}emitParticle(t){const e=this.sys,i=E6.get();this.particles.push(i),i.timeToLive=e.life+e.lifeVar*(Math.random()-.5)*2;const n=i.timeToLive=Math.max(0,i.timeToLive);i.pos.x=e.sourcePos.x+e.posVar.x*(Math.random()-.5)*2,i.pos.y=e.sourcePos.y+e.posVar.y*(Math.random()-.5)*2;let s=0,r=0,o=0,a=0;const l=e.startColor,c=e.startColorVar,h=e.endColor,_=e.endColorVar;i.color.r=s=$t(l.r+c.r*(Math.random()-.5)*2,0,255),i.color.g=r=$t(l.g+c.g*(Math.random()-.5)*2,0,255),i.color.b=o=$t(l.b+c.b*(Math.random()-.5)*2,0,255),i.color.a=a=$t(l.a+c.a*(Math.random()-.5)*2,0,255),i.deltaColor.r=($t(h.r+_.r*(Math.random()-.5)*2,0,255)-s)/n,i.deltaColor.g=($t(h.g+_.g*(Math.random()-.5)*2,0,255)-r)/n,i.deltaColor.b=($t(h.b+_.b*(Math.random()-.5)*2,0,255)-o)/n,i.deltaColor.a=($t(h.a+_.a*(Math.random()-.5)*2,0,255)-a)/n;let u=e.startSize+e.startSizeVar*(Math.random()-.5)*2;if(u=Math.max(0,u),i.size=u,-1===e.endSize)i.deltaSize=0;else{let t=e.endSize+e.endSizeVar*(Math.random()-.5)*2;t=Math.max(0,t),i.deltaSize=(t-u)/n}const m=e.startSpin+e.startSpinVar*(Math.random()-.5)*2,p=e.endSpin+e.endSpinVar*(Math.random()-.5)*2;i.rotation=m,i.deltaRotation=(p-m)/n,i.startPos.x=t.x,i.startPos.y=t.y,i.aspectRatio=e.aspectRatio||1;const d=Jt(e.angle+this._worldRotation+e.angleVar*(Math.random()-.5)*2);if(e.emitterMode===y6.GRAVITY){const t=e.speed+e.speedVar*(Math.random()-.5)*2;i.dir.x=Math.cos(d),i.dir.y=Math.sin(d),i.dir.multiplyScalar(t),i.radialAccel=e.radialAccel+e.radialAccelVar*(Math.random()-.5)*2,i.tangentialAccel=e.tangentialAccel+e.tangentialAccelVar*(Math.random()-.5)*2,e.rotationIsDir&&(i.rotation=-Zt(Math.atan2(i.dir.y,i.dir.x)))}else{const t=e.startRadius+e.startRadiusVar*(Math.random()-.5)*2,s=e.endRadius+e.endRadiusVar*(Math.random()-.5)*2;i.radius=t,i.deltaRadius=-1===e.endRadius?0:(s-t)/n,i.angle=d,i.degreesPerSecond=Jt(e.rotatePerS+e.rotatePerSVar*(Math.random()-.5)*2)}}updateUVs(t){const e=this.renderData;if(e&&this.sys._renderSpriteFrame){const i=e.vData,n=this.sys._renderSpriteFrame.uv,s=t?0:this.uvFilled,r=this.particles.length;for(let t=s;t<r;t++){const e=t*T6*4;i[e+3]=n[0],i[e+4]=n[1],i[e+12]=n[2],i[e+13]=n[3],i[e+21]=n[4],i[e+22]=n[5],i[e+30]=n[6],i[e+31]=n[7]}this.uvFilled=r}}updateParticleBuffer(t,e,i,n){const s=i.vData,r=e.x,o=e.y;let a=t.size,l=a;const c=t.aspectRatio;c>1?l=a/c:a=l*c;const h=a/2,_=l/2;if(t.rotation){const e=-h,i=-_,a=h,l=_,c=-Jt(t.rotation),u=Math.cos(c),m=Math.sin(c);s[n]=e*u-i*m+r,s[n+1]=e*m+i*u+o,s[n+2]=0,s[n+9]=a*u-i*m+r,s[n+10]=a*m+i*u+o,s[n+11]=0,s[n+18]=e*u-l*m+r,s[n+19]=e*m+l*u+o,s[n+20]=0,s[n+27]=a*u-l*m+r,s[n+28]=a*m+l*u+o,s[n+29]=0}else s[n]=r-h,s[n+1]=o-_,s[n+2]=0,s[n+9]=r+h,s[n+10]=o-_,s[n+11]=0,s[n+18]=r-h,s[n+19]=o+_,s[n+20]=0,s[n+27]=r+h,s[n+28]=o+_,s[n+29]=0;Ri.toArray(s,t.color,n+5),Ri.toArray(s,t.color,n+14),Ri.toArray(s,t.color,n+23),Ri.toArray(s,t.color,n+32)}step(t){const e=this.sys.assembler,i=this.sys,n=i.node,s=this.particles;if(t=t>e.maxParticleDeltaTime?e.maxParticleDeltaTime:t,n.updateWorldTransform(),i.positionType===v6.FREE){this._worldRotation=function(t){let e=0,i=t;for(;i;)e+=i.eulerAngles.z,i=i.parent;return e}(n);const t=n.worldMatrix;b6.x=t.m12,b6.y=t.m13}else i.positionType===v6.RELATIVE?(this._worldRotation=n.eulerAngles.z,b6.x=n.position.x,b6.y=n.position.y):this._worldRotation=0;if(this.active&&i.emissionRate){const e=1/i.emissionRate;for(s.length<i.totalParticles&&(this.emitCounter+=t);s.length<i.totalParticles&&this.emitCounter>e;)this.emitParticle(b6),this.emitCounter-=e;this.elapsed+=t,-1!==i.duration&&i.duration<this.elapsed&&i.stopSystem()}const r=this.renderData,o=s.length;r.reset(),this.requestData(4*o,6*o),o>this.uvFilled&&this.updateUVs();let a=0;for(;a<s.length;){S6.x=S6.y=A6.x=A6.y=C6.x=C6.y=0;const e=s[a];if(e.timeToLive-=t,e.timeToLive>0){if(i.emitterMode===y6.GRAVITY){const n=C6,s=S6,r=A6;(e.pos.x||e.pos.y)&&(s.set(e.pos),s.normalize()),r.set(s),s.multiplyScalar(e.radialAccel);const o=r.x;r.x=-r.y,r.y=o,r.multiplyScalar(e.tangentialAccel),n.set(s),n.add(r),n.add(i.gravity),n.multiplyScalar(t),e.dir.add(n),n.set(e.dir),n.multiplyScalar(t),e.pos.add(n)}else e.angle+=e.degreesPerSecond*t,e.radius+=e.deltaRadius*t,e.pos.x=-Math.cos(e.angle)*e.radius,e.pos.y=-Math.sin(e.angle)*e.radius;e.color.r+=e.deltaColor.r*t,e.color.g+=e.deltaColor.g*t,e.color.b+=e.deltaColor.b*t,e.color.a+=e.deltaColor.a*t,e.size+=e.deltaSize*t,e.size<0&&(e.size=0),e.rotation+=e.deltaRotation*t;const n=S6;n.set(e.pos),i.positionType!==v6.GROUPED&&n.add(e.startPos);const s=T6*a*4;this.updateParticleBuffer(e,n,r,s),++a}else{const t=s[a];a!==s.length-1&&(s[a]=s[s.length-1]),E6.put(t),s.length--,r.indicesCount-=6,r.vertexCount-=4}}0!==s.length||this.active||this.readyToPlay||(this.finished=!0,i._finishedSimulation())}requestData(t,e){let i=this.renderData.indicesCount;this.renderData.request(t,e);const n=this.renderData.indicesCount/6,s=this.renderData.iData;for(let t=i;t<n;t++){const e=4*t;s[i++]=e,s[i++]=e+1,s[i++]=e+2,s[i++]=e+1,s[i++]=e+3,s[i++]=e+2}}}var D6,I6,R6;let M6=t("ParticleAsset",Vl("cc.ParticleAsset")((R6=wl((I6=class extends _h{constructor(...t){super(...t),Tl(this,"spriteFrame",R6,this)}}).prototype,"spriteFrame",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),D6=I6))||D6);n.ParticleAsset=M6;
/** @license zlib.js 2012 - imaya [ https://github.com/imaya/zlib.js ] The MIT License */
var O6={};(function(){function t(t){throw t}var e=void 0,i=!0,n=this;function s(t,i){var s,r=t.split("."),o=n;!(r[0]in o)&&o.execScript&&o.execScript("var "+r[0]);for(;r.length&&(s=r.shift());)r.length||i===e?o=o[s]?o[s]:o[s]={}:o[s]=i}var r="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array;function o(t){if("string"==typeof t){var e,i,n=t.split("");for(e=0,i=n.length;e<i;e++)n[e]=(255&n[e].charCodeAt(0))>>>0;t=n}for(var s,r=1,o=0,a=t.length,l=0;0<a;){a-=s=1024<a?1024:a;do{o+=r+=t[l++]}while(--s);r%=65521,o%=65521}return(o<<16|r)>>>0}function a(e,i){this.index="number"==typeof i?i:0,this.i=0,this.buffer=e instanceof(r?Uint8Array:Array)?e:new(r?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var t,e=this.buffer,i=e.length,n=new(r?Uint8Array:Array)(i<<1);if(r)n.set(e);else for(t=0;t<i;++t)n[t]=e[t];return this.buffer=n},a.prototype.d=function(t,e,i){var n,s=this.buffer,r=this.index,o=this.i,a=s[r];if(i&&1<e&&(t=8<e?(m[255&t]<<24|m[t>>>8&255]<<16|m[t>>>16&255]<<8|m[t>>>24&255])>>32-e:m[t]>>8-e),8>e+o)a=a<<e|t,o+=e;else for(n=0;n<e;++n)a=a<<1|t>>e-n-1&1,8==++o&&(o=0,s[r++]=m[a],a=0,r===s.length&&(s=this.f()));s[r]=a,this.buffer=s,this.i=o,this.index=r},a.prototype.finish=function(){var t,e=this.buffer,i=this.index;return 0<this.i&&(e[i]<<=8-this.i,e[i]=m[e[i]],i++),r?t=e.subarray(0,i):(e.length=i,t=e),t};var l,c=new(r?Uint8Array:Array)(256);for(l=0;256>l;++l){for(var h=u=l,_=7,u=u>>>1;u;u>>>=1)h<<=1,h|=1&u,--_;c[l]=(h<<_&255)>>>0}var m=c;function p(t){this.buffer=new(r?Uint16Array:Array)(2*t),this.length=0}function d(t){var e,i,n,s,o,a,l,c,h,_=t.length,u=0,m=Number.POSITIVE_INFINITY;for(c=0;c<_;++c)t[c]>u&&(u=t[c]),t[c]<m&&(m=t[c]);for(e=1<<u,i=new(r?Uint32Array:Array)(e),n=1,s=0,o=2;n<=u;){for(c=0;c<_;++c)if(t[c]===n){for(a=0,l=s,h=0;h<n;++h)a=a<<1|1&l,l>>=1;for(h=a;h<e;h+=o)i[h]=n<<16|c;++s}++n,s<<=1,o<<=1}return[i,u,m]}function f(t,e){this.h=y,this.w=0,this.input=t,this.b=0,e&&(e.lazy&&(this.w=e.lazy),"number"==typeof e.compressionType&&(this.h=e.compressionType),e.outputBuffer&&(this.a=r&&e.outputBuffer instanceof Array?new Uint8Array(e.outputBuffer):e.outputBuffer),"number"==typeof e.outputIndex&&(this.b=e.outputIndex)),this.a||(this.a=new(r?Uint8Array:Array)(32768))}p.prototype.getParent=function(t){return 2*((t-2)/4|0)},p.prototype.push=function(t,e){var i,n,s,r=this.buffer;for(i=this.length,r[this.length++]=e,r[this.length++]=t;0<i&&(n=this.getParent(i),r[i]>r[n]);)s=r[i],r[i]=r[n],r[n]=s,s=r[i+1],r[i+1]=r[n+1],r[n+1]=s,i=n;return this.length},p.prototype.pop=function(){var t,e,i,n,s,r=this.buffer;for(e=r[0],t=r[1],this.length-=2,r[0]=r[this.length],r[1]=r[this.length+1],s=0;!((n=2*s+2)>=this.length)&&(n+2<this.length&&r[n+2]>r[n]&&(n+=2),r[n]>r[s]);)i=r[s],r[s]=r[n],r[n]=i,i=r[s+1],r[s+1]=r[n+1],r[n+1]=i,s=n;return{index:t,value:e,length:this.length}};var g,y=2,v={NONE:0,r:1,j:y,N:3},x=[];for(g=0;288>g;g++)switch(i){case 143>=g:x.push([g+48,8]);break;case 255>=g:x.push([g-144+400,9]);break;case 279>=g:x.push([g-256+0,7]);break;case 287>=g:x.push([g-280+192,8]);break;default:t("invalid literal: "+g)}function b(t,e){this.length=t,this.G=e}function S(){var e=A;switch(i){case 3===e:return[257,e-3,0];case 4===e:return[258,e-4,0];case 5===e:return[259,e-5,0];case 6===e:return[260,e-6,0];case 7===e:return[261,e-7,0];case 8===e:return[262,e-8,0];case 9===e:return[263,e-9,0];case 10===e:return[264,e-10,0];case 12>=e:return[265,e-11,1];case 14>=e:return[266,e-13,1];case 16>=e:return[267,e-15,1];case 18>=e:return[268,e-17,1];case 22>=e:return[269,e-19,2];case 26>=e:return[270,e-23,2];case 30>=e:return[271,e-27,2];case 34>=e:return[272,e-31,2];case 42>=e:return[273,e-35,3];case 50>=e:return[274,e-43,3];case 58>=e:return[275,e-51,3];case 66>=e:return[276,e-59,3];case 82>=e:return[277,e-67,4];case 98>=e:return[278,e-83,4];case 114>=e:return[279,e-99,4];case 130>=e:return[280,e-115,4];case 162>=e:return[281,e-131,5];case 194>=e:return[282,e-163,5];case 226>=e:return[283,e-195,5];case 257>=e:return[284,e-227,5];case 258===e:return[285,e-258,0];default:t("invalid length: "+e)}}f.prototype.n=function(){var n,s,o,l,c=this.input;switch(this.h){case 0:for(o=0,l=c.length;o<l;){var h,_,u,m=s=r?c.subarray(o,o+65535):c.slice(o,o+65535),p=(o+=s.length)===l,d=e,f=e,g=this.a,v=this.b;if(r){for(g=new Uint8Array(this.a.buffer);g.length<=v+m.length+5;)g=new Uint8Array(g.length<<1);g.set(this.a)}if(h=p?1:0,g[v++]=0|h,u=65536+~(_=m.length)&65535,g[v++]=255&_,g[v++]=_>>>8&255,g[v++]=255&u,g[v++]=u>>>8&255,r)g.set(m,v),v+=m.length,g=g.subarray(0,v);else{for(d=0,f=m.length;d<f;++d)g[v++]=m[d];g.length=v}this.b=v,this.a=g}break;case 1:var b=new a(new Uint8Array(this.a.buffer),this.b);b.d(1,1,i),b.d(1,2,i);var S,A,C,T=E(this,c);for(S=0,A=T.length;S<A;S++)if(C=T[S],a.prototype.d.apply(b,x[C]),256<C)b.d(T[++S],T[++S],i),b.d(T[++S],5),b.d(T[++S],T[++S],i);else if(256===C)break;this.a=b.finish(),this.b=this.a.length;break;case y:var w,I,R,M,O,B,N,L,F,z,V,U,G,k,H,j=new a(new Uint8Array(this.a),this.b),W=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],q=Array(19);for(w=y,j.d(1,1,i),j.d(w,2,i),I=E(this,c),N=D(B=P(this.L,15)),F=D(L=P(this.K,7)),R=286;257<R&&0===B[R-1];R--);for(M=30;1<M&&0===L[M-1];M--);var X,Y,K,$,J,Z,Q=R,tt=M,et=new(r?Uint32Array:Array)(Q+tt),it=new(r?Uint32Array:Array)(316),nt=new(r?Uint8Array:Array)(19);for(X=Y=0;X<Q;X++)et[Y++]=B[X];for(X=0;X<tt;X++)et[Y++]=L[X];if(!r)for(X=0,$=nt.length;X<$;++X)nt[X]=0;for(X=J=0,$=et.length;X<$;X+=Y){for(Y=1;X+Y<$&&et[X+Y]===et[X];++Y);if(K=Y,0===et[X])if(3>K)for(;0<K--;)it[J++]=0,nt[0]++;else for(;0<K;)(Z=138>K?K:138)>K-3&&Z<K&&(Z=K-3),10>=Z?(it[J++]=17,it[J++]=Z-3,nt[17]++):(it[J++]=18,it[J++]=Z-11,nt[18]++),K-=Z;else if(it[J++]=et[X],nt[et[X]]++,3>--K)for(;0<K--;)it[J++]=et[X],nt[et[X]]++;else for(;0<K;)(Z=6>K?K:6)>K-3&&Z<K&&(Z=K-3),it[J++]=16,it[J++]=Z-3,nt[16]++,K-=Z}for(n=r?it.subarray(0,J):it.slice(0,J),z=P(nt,7),k=0;19>k;k++)q[k]=z[W[k]];for(O=19;4<O&&0===q[O-1];O--);for(V=D(z),j.d(R-257,5,i),j.d(M-1,5,i),j.d(O-4,4,i),k=0;k<O;k++)j.d(q[k],3,i);for(k=0,H=n.length;k<H;k++)if(U=n[k],j.d(V[U],z[U],i),16<=U){switch(k++,U){case 16:G=2;break;case 17:G=3;break;case 18:G=7;break;default:t("invalid code: "+U)}j.d(n[k],G,i)}var st,rt,ot,at,lt,ct,ht,_t,ut=[N,B],mt=[F,L];for(lt=ut[0],ct=ut[1],ht=mt[0],_t=mt[1],st=0,rt=I.length;st<rt;++st)if(ot=I[st],j.d(lt[ot],ct[ot],i),256<ot)j.d(I[++st],I[++st],i),at=I[++st],j.d(ht[at],_t[at],i),j.d(I[++st],I[++st],i);else if(256===ot)break;this.a=j.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var A,C,T=[];for(A=3;258>=A;A++)C=S(),T[A]=C[2]<<24|C[1]<<16|C[0];var w=r?new Uint32Array(T):T;function E(n,s){function o(e,n){var s,r,o,a,l=e.G,c=[],h=0;switch(s=w[e.length],c[h++]=65535&s,c[h++]=s>>16&255,c[h++]=s>>24,i){case 1===l:r=[0,l-1,0];break;case 2===l:r=[1,l-2,0];break;case 3===l:r=[2,l-3,0];break;case 4===l:r=[3,l-4,0];break;case 6>=l:r=[4,l-5,1];break;case 8>=l:r=[5,l-7,1];break;case 12>=l:r=[6,l-9,2];break;case 16>=l:r=[7,l-13,2];break;case 24>=l:r=[8,l-17,3];break;case 32>=l:r=[9,l-25,3];break;case 48>=l:r=[10,l-33,4];break;case 64>=l:r=[11,l-49,4];break;case 96>=l:r=[12,l-65,5];break;case 128>=l:r=[13,l-97,5];break;case 192>=l:r=[14,l-129,6];break;case 256>=l:r=[15,l-193,6];break;case 384>=l:r=[16,l-257,7];break;case 512>=l:r=[17,l-385,7];break;case 768>=l:r=[18,l-513,8];break;case 1024>=l:r=[19,l-769,8];break;case 1536>=l:r=[20,l-1025,9];break;case 2048>=l:r=[21,l-1537,9];break;case 3072>=l:r=[22,l-2049,10];break;case 4096>=l:r=[23,l-3073,10];break;case 6144>=l:r=[24,l-4097,11];break;case 8192>=l:r=[25,l-6145,11];break;case 12288>=l:r=[26,l-8193,12];break;case 16384>=l:r=[27,l-12289,12];break;case 24576>=l:r=[28,l-16385,13];break;case 32768>=l:r=[29,l-24577,13];break;default:t("invalid distance")}for(s=r,c[h++]=s[0],c[h++]=s[1],c[h++]=s[2],o=0,a=c.length;o<a;++o)g[y++]=c[o];x[c[0]]++,S[c[3]]++,v=e.length+n-1,p=null}var a,l,c,h,_,u,m,p,d,f={},g=r?new Uint16Array(2*s.length):[],y=0,v=0,x=new(r?Uint32Array:Array)(286),S=new(r?Uint32Array:Array)(30),A=n.w;if(!r){for(c=0;285>=c;)x[c++]=0;for(c=0;29>=c;)S[c++]=0}for(x[256]=1,a=0,l=s.length;a<l;++a){for(c=_=0,h=3;c<h&&a+c!==l;++c)_=_<<8|s[a+c];if(f[_]===e&&(f[_]=[]),u=f[_],!(0<v--)){for(;0<u.length&&32768<a-u[0];)u.shift();if(a+3>=l){for(p&&o(p,-1),c=0,h=l-a;c<h;++c)d=s[a+c],g[y++]=d,++x[d];break}if(0<u.length){var C=e,T=e,E=0,P=e,D=e,I=e,R=s.length,M=(D=0,u.length);t:for(;D<M;D++){if(C=u[M-D-1],P=3,3<E){for(I=E;3<I;I--)if(s[C+I-1]!==s[a+I-1])continue t;P=E}for(;258>P&&a+P<R&&s[C+P]===s[a+P];)++P;if(P>E&&(T=C,E=P),258===P)break}m=new b(E,a-T),p?p.length<m.length?(d=s[a-1],g[y++]=d,++x[d],o(m,0)):o(p,-1):m.length<A?p=m:o(m,0)}else p?o(p,-1):(d=s[a],g[y++]=d,++x[d])}u.push(a)}return g[y++]=256,x[256]++,n.L=x,n.K=S,r?g.subarray(0,y):g}function P(t,e){function i(t){var e=A[t][C[t]];e===y?(i(t+1),i(t+1)):--b[e],++C[t]}var n,s,o,a,l,c=t.length,h=new p(572),_=new(r?Uint8Array:Array)(c);if(!r)for(a=0;a<c;a++)_[a]=0;for(a=0;a<c;++a)0<t[a]&&h.push(a,t[a]);if(n=Array(h.length/2),s=new(r?Uint32Array:Array)(h.length/2),1===n.length)return _[h.pop().index]=1,_;for(a=0,l=h.length/2;a<l;++a)n[a]=h.pop(),s[a]=n[a].value;var u,m,d,f,g,y=s.length,v=new(r?Uint16Array:Array)(e),x=new(r?Uint8Array:Array)(e),b=new(r?Uint8Array:Array)(y),S=Array(e),A=Array(e),C=Array(e),T=(1<<e)-y,w=1<<e-1;for(v[e-1]=y,m=0;m<e;++m)T<w?x[m]=0:(x[m]=1,T-=w),T<<=1,v[e-2-m]=(v[e-1-m]/2|0)+y;for(v[0]=x[0],S[0]=Array(v[0]),A[0]=Array(v[0]),m=1;m<e;++m)v[m]>2*v[m-1]+x[m]&&(v[m]=2*v[m-1]+x[m]),S[m]=Array(v[m]),A[m]=Array(v[m]);for(u=0;u<y;++u)b[u]=e;for(d=0;d<v[e-1];++d)S[e-1][d]=s[d],A[e-1][d]=d;for(u=0;u<e;++u)C[u]=0;for(1===x[e-1]&&(--b[0],++C[e-1]),m=e-2;0<=m;--m){for(f=u=0,g=C[m+1],d=0;d<v[m];d++)(f=S[m+1][g]+S[m+1][g+1])>s[u]?(S[m][d]=f,A[m][d]=y,g+=2):(S[m][d]=s[u],A[m][d]=u,++u);C[m]=0,1===x[m]&&i(m)}for(o=b,a=0,l=n.length;a<l;++a)_[n[a].index]=o[a];return _}function D(e){var i,n,s,o,a=new(r?Uint16Array:Array)(e.length),l=[],c=[],h=0;for(i=0,n=e.length;i<n;i++)l[e[i]]=1+(0|l[e[i]]);for(i=1,n=16;i<=n;i++)c[i]=h,(h+=0|l[i])>1<<i&&t("overcommitted"),h<<=1;for(65536>h&&t("undercommitted"),i=0,n=e.length;i<n;i++)for(h=c[e[i]],c[e[i]]+=1,s=a[i]=0,o=e[i];s<o;s++)a[i]=a[i]<<1|1&h,h>>>=1;return a}function I(t,e){this.input=t,this.a=new(r?Uint8Array:Array)(32768),this.h=R.j;var i,n={};for(i in!e&&(e={})||"number"!=typeof e.compressionType||(this.h=e.compressionType),e)n[i]=e[i];n.outputBuffer=this.a,this.z=new f(this.input,n)}var R=v;function M(e,i){switch(this.k=[],this.l=32768,this.e=this.g=this.c=this.q=0,this.input=r?new Uint8Array(e):e,this.s=!1,this.m=B,this.B=!1,!i&&(i={})||(i.index&&(this.c=i.index),i.bufferSize&&(this.l=i.bufferSize),i.bufferType&&(this.m=i.bufferType),i.resize&&(this.B=i.resize)),this.m){case O:this.b=32768,this.a=new(r?Uint8Array:Array)(32768+this.l+258);break;case B:this.b=0,this.a=new(r?Uint8Array:Array)(this.l),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}I.prototype.n=function(){var e,i,n,s,a,l,c,h=0;switch(c=this.a,e=ht){case ht:i=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(n=i<<4|e,c[h++]=n,e){case ht:switch(this.h){case R.NONE:a=0;break;case R.r:a=1;break;case R.j:a=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return s=a<<6|0,c[h++]=s|31-(256*n+s)%31,l=o(this.input),this.z.b=h,h=(c=this.z.n()).length,r&&((c=new Uint8Array(c.buffer)).length<=h+4&&(this.a=new Uint8Array(c.length+4),this.a.set(c),c=this.a),c=c.subarray(0,h+4)),c[h++]=l>>24&255,c[h++]=l>>16&255,c[h++]=l>>8&255,c[h++]=255&l,c},s("Zlib.Deflate",I),s("Zlib.Deflate.compress",(function(t,e){return new I(t,e).n()})),s("Zlib.Deflate.CompressionType",R),s("Zlib.Deflate.CompressionType.NONE",R.NONE),s("Zlib.Deflate.CompressionType.FIXED",R.r),s("Zlib.Deflate.CompressionType.DYNAMIC",R.j);var O=0,B=1,N={D:O,C:B};M.prototype.p=function(){for(;!this.s;){var n=tt(this,3);switch(1&n&&(this.s=i),n>>>=1){case 0:var s=this.input,o=this.c,a=this.a,l=this.b,c=e,h=e,_=e,u=a.length,m=e;switch(this.e=this.g=0,(c=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (first byte)")),h=c,(c=s[o++])===e&&t(Error("invalid uncompressed block header: LEN (second byte)")),h|=c<<8,(c=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (first byte)")),_=c,(c=s[o++])===e&&t(Error("invalid uncompressed block header: NLEN (second byte)")),h===~(_|=c<<8)&&t(Error("invalid uncompressed block header: length verify")),o+h>s.length&&t(Error("input buffer is broken")),this.m){case O:for(;l+h>a.length;){if(h-=m=u-l,r)a.set(s.subarray(o,o+m),l),l+=m,o+=m;else for(;m--;)a[l++]=s[o++];this.b=l,a=this.f(),l=this.b}break;case B:for(;l+h>a.length;)a=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(r)a.set(s.subarray(o,o+h),l),l+=h,o+=h;else for(;h--;)a[l++]=s[o++];this.c=o,this.b=l,this.a=a;break;case 1:this.o(J,Q);break;case 2:it(this);break;default:t(Error("unknown BTYPE: "+n))}}return this.t()};var L,F,z=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],V=r?new Uint16Array(z):z,U=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],G=r?new Uint16Array(U):U,k=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],H=r?new Uint8Array(k):k,j=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],W=r?new Uint16Array(j):j,q=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],X=r?new Uint8Array(q):q,Y=new(r?Uint8Array:Array)(288);for(L=0,F=Y.length;L<F;++L)Y[L]=143>=L?8:255>=L?9:279>=L?7:8;var K,$,J=d(Y),Z=new(r?Uint8Array:Array)(30);for(K=0,$=Z.length;K<$;++K)Z[K]=5;var Q=d(Z);function tt(i,n){for(var s,r=i.g,o=i.e,a=i.input,l=i.c;o<n;)(s=a[l++])===e&&t(Error("input buffer is broken")),r|=s<<o,o+=8;return s=r&(1<<n)-1,i.g=r>>>n,i.e=o-n,i.c=l,s}function et(i,n){for(var s,r,o,a=i.g,l=i.e,c=i.input,h=i.c,_=n[0],u=n[1];l<u;)(s=c[h++])===e&&t(Error("input buffer is broken")),a|=s<<l,l+=8;return o=(r=_[a&(1<<u)-1])>>>16,i.g=a>>o,i.e=l-o,i.c=h,65535&r}function it(t){function e(t,e,i){var n,s,r,o;for(o=0;o<t;)switch(n=et(this,e),n){case 16:for(r=3+tt(this,2);r--;)i[o++]=s;break;case 17:for(r=3+tt(this,3);r--;)i[o++]=0;s=0;break;case 18:for(r=11+tt(this,7);r--;)i[o++]=0;s=0;break;default:s=i[o++]=n}return i}var i,n,s,o,a=tt(t,5)+257,l=tt(t,5)+1,c=tt(t,4)+4,h=new(r?Uint8Array:Array)(V.length);for(o=0;o<c;++o)h[V[o]]=tt(t,3);i=d(h),n=new(r?Uint8Array:Array)(a),s=new(r?Uint8Array:Array)(l),t.o(d(e.call(t,a,i,n)),d(e.call(t,l,i,s)))}function nt(e,i){var n,s;switch(this.input=e,this.c=0,!i&&(i={})||(i.index&&(this.c=i.index),i.verify&&(this.M=i.verify)),n=e[this.c++],s=e[this.c++],15&n){case ht:this.method=ht;break;default:t(Error("unsupported compression method"))}0!=((n<<8)+s)%31&&t(Error("invalid fcheck flag:"+((n<<8)+s)%31)),32&s&&t(Error("fdict flag is not supported")),this.A=new M(e,{index:this.c,bufferSize:i.bufferSize,bufferType:i.bufferType,resize:i.resize})}M.prototype.o=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,l=i.length-258;256!==(s=et(this,t));)if(256>s)n>=l&&(this.b=n,i=this.f(),n=this.b),i[n++]=s;else for(a=G[r=s-257],0<H[r]&&(a+=tt(this,H[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n>=l&&(this.b=n,i=this.f(),n=this.b);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.I=function(t,e){var i=this.a,n=this.b;this.u=t;for(var s,r,o,a,l=i.length;256!==(s=et(this,t));)if(256>s)n>=l&&(l=(i=this.f()).length),i[n++]=s;else for(a=G[r=s-257],0<H[r]&&(a+=tt(this,H[r])),s=et(this,e),o=W[s],0<X[s]&&(o+=tt(this,X[s])),n+a>l&&(l=(i=this.f()).length);a--;)i[n]=i[n++-o];for(;8<=this.e;)this.e-=8,this.c--;this.b=n},M.prototype.f=function(){var t,e,i=new(r?Uint8Array:Array)(this.b-32768),n=this.b-32768,s=this.a;if(r)i.set(s.subarray(32768,i.length));else for(t=0,e=i.length;t<e;++t)i[t]=s[t+32768];if(this.k.push(i),this.q+=i.length,r)s.set(s.subarray(n,n+32768));else for(t=0;32768>t;++t)s[t]=s[n+t];return this.b=32768,s},M.prototype.J=function(t){var e,i,n,s=this.input.length/this.c+1|0,o=this.input,a=this.a;return t&&("number"==typeof t.v&&(s=t.v),"number"==typeof t.F&&(s+=t.F)),i=2>s?(n=(o.length-this.c)/this.u[2]/2*258|0)<a.length?a.length+n:a.length<<1:a.length*s,r?(e=new Uint8Array(i)).set(a):e=a,this.a=e},M.prototype.t=function(){var t,e,i,n,s,o=0,a=this.a,l=this.k,c=new(r?Uint8Array:Array)(this.q+(this.b-32768));if(0===l.length)return r?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(e=0,i=l.length;e<i;++e)for(n=0,s=(t=l[e]).length;n<s;++n)c[o++]=t[n];for(e=32768,i=this.b;e<i;++e)c[o++]=a[e];return this.k=[],this.buffer=c},M.prototype.H=function(){var t,e=this.b;return r?this.B?(t=new Uint8Array(e)).set(this.a.subarray(0,e)):t=this.a.subarray(0,e):(this.a.length>e&&(this.a.length=e),t=this.a),this.buffer=t},nt.prototype.p=function(){var e,i=this.input;return e=this.A.p(),this.c=this.A.c,this.M&&(i[this.c++]<<24|i[this.c++]<<16|i[this.c++]<<8|i[this.c++])>>>0!==o(e)&&t(Error("invalid adler-32 checksum")),e},s("Zlib.Inflate",nt),s("Zlib.Inflate.BufferType",N),N.ADAPTIVE=N.C,N.BLOCK=N.D,s("Zlib.Inflate.prototype.decompress",nt.prototype.p);var st,rt,ot=new(r?Uint8Array:Array)(288);for(st=0,rt=ot.length;st<rt;++st)ot[st]=143>=st?8:255>=st?9:279>=st?7:8;d(ot);var at,lt,ct=new(r?Uint8Array:Array)(30);for(at=0,lt=ct.length;at<lt;++at)ct[at]=5;d(ct);var ht=8}).call(O6);var B6=O6.Zlib;B6.Deflate=B6.Deflate,B6.Deflate.compress=B6.Deflate.compress,B6.Inflate=B6.Inflate,B6.Inflate.BufferType=B6.Inflate.BufferType,B6.Inflate.prototype.decompress=B6.Inflate.prototype.decompress;class N6{constructor(t){let e;this.pos=8,this.palette=[],this.imgData=[],this.text={},this.width=0,this.height=0,this.bits=0,this.colorType=0,this.compressionMethod=0,this.filterMethod=0,this.interlaceMethod=0,this.colors=0,this.hasAlphaChannel=!1,this.pixelBitlength=0,this.data=t,this.transparency={indexed:[],rgb:0,grayscale:0};let i=0,n=0,s=0,r=0;for(;;){r=this.readUInt32();const o=(()=>{const t=[];for(i=n=0;n<4;i=++n)t.push(String.fromCharCode(this.data[this.pos++]));return t}).call(this).join("");switch(o){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(r);break;case"fcTL":e&&this.animation.frames.push(e),this.pos+=4,e={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()};const a=this.readUInt16(),l=this.readUInt16()||100;e.delay=1e3*a/l,e.disposeOp=this.data[this.pos++],e.blendOp=this.data[this.pos++],e.data=[];break;case"IDAT":case"fdAT":for("fdAT"===o&&(this.pos+=4,r-=4),t=(null!=e?e.data:void 0)||this.imgData,i=n=0;r>=0?n<r:n>r;i=r>=0?++n:--n)t.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:this.transparency.indexed=this.read(r);const t=255-this.transparency.indexed.length;if(t>0)for(i=s=0;t>=0?s<t:s>t;i=t>=0?++s:--s)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(r)[0];break;case 2:this.transparency.rgb=this.read(r)}break;case"tEXt":const c=this.read(r),h=c.indexOf(0),_=String.fromCharCode.apply(String,c.slice(0,h));this.text[_]=String.fromCharCode.apply(String,c.slice(h+1));break;case"IEND":e&&this.animation.frames.push(e),this.colors=(()=>{switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}).call(this);const u=this.colorType;this.hasAlphaChannel=4===u||6===u;const m=this.colors+(this.hasAlphaChannel?1:0);return this.pixelBitlength=this.bits*m,this.colorSpace=(()=>{switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}).call(this),void(this.imgData instanceof Uint8Array||(this.imgData=new Uint8Array(this.imgData)));default:this.pos+=r}if(this.pos+=4,this.pos>this.data.length)throw new Error(D(6017))}}read(t){let e=0,i=0;const n=[];for(e=i=0;t>=0?i<t:i>t;e=t>=0?++i:--i)n.push(this.data[this.pos++]);return n}readUInt32(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]}readUInt16(){return this.data[this.pos++]<<8|this.data[this.pos++]}decodePixels(t){if(null==t&&(t=this.imgData),0===t.length)return new Uint8Array(0);t=new B6.Inflate(t,{index:0,verify:!1}).decompress();const e=this.pixelBitlength/8,i=e*this.width,n=new Uint8Array(i*this.height),s=t.length;let r=0,o=0,a=0,l=0,c=0,h=0,_=0,u=0,m=0,p=0,d=0,f=0,g=0,y=0,v=0,x=0,b=0,S=0,A=0;for(;o<s;){switch(t[o++]){case 0:for(h=_=0;_<i;h=_+=1)n[a++]=t[o++];break;case 1:for(h=u=0;u<i;h=u+=1)l=t[o++],f=h<e?0:n[a-e],n[a++]=(l+f)%256;break;case 2:for(h=m=0;m<i;h=m+=1)l=t[o++],c=(h-h%e)/e,S=r&&n[(r-1)*i+c*e+h%e],n[a++]=(S+l)%256;break;case 3:for(h=p=0;p<i;h=p+=1)l=t[o++],c=(h-h%e)/e,f=h<e?0:n[a-e],S=r&&n[(r-1)*i+c*e+h%e],n[a++]=(l+Math.floor((f+S)/2))%256;break;case 4:for(h=d=0;d<i;h=d+=1)l=t[o++],c=(h-h%e)/e,f=h<e?0:n[a-e],0===r?S=A=0:(S=n[(r-1)*i+c*e+h%e],A=c&&n[(r-1)*i+(c-1)*e+h%e]),g=f+S-A,y=Math.abs(g-f),x=Math.abs(g-S),b=Math.abs(g-A),v=y<=x&&y<=b?f:x<=b?S:A,n[a++]=(l+v)%256;break;default:throw new Error(D(6018,t[o-1]))}r++}return n}copyToImageData(t,e){let i,n=this.hasAlphaChannel,s=this.colors;this.palette.length&&(i=null!=this._decodedPalette?this._decodedPalette:this._decodedPalette=this.decodePalette(),s=4,n=!0);const r=t.data||t,o=r.length,a=i||e;let l=0,c=0,h=0,_=0;if(1===s)for(;l<o;)h=i?4*e[l/4]:c,_=a[h++],r[l++]=_,r[l++]=_,r[l++]=_,r[l++]=n?a[h++]:255,c=h;else for(;l<o;)h=i?4*e[l/4]:c,r[l++]=a[h++],r[l++]=a[h++],r[l++]=a[h++],r[l++]=n?a[h++]:255,c=h}decodePalette(){const t=this.palette,e=this.transparency.indexed||[],i=new Uint8Array((e.length||0)+t.length);let n=0,s=0,r=0;for(let o=0,a=0,l=t.length;a<l;o=a+=3)i[n++]=t[o],i[n++]=t[o+1],i[n++]=t[o+2],r=e[s++],i[n++]=null!=r?r:255;return i}render(t){t.width=this.width,t.height=this.height;const e=t.getContext("2d"),i=e.createImageData(this.width,this.height);return this.copyToImageData(i,this.decodePixels(null)),e.putImageData(i,0,0)}}class L6{constructor(){this._littleEndian=!1,this._tiffData=[],this._fileDirectories=[]}getUint8(t){return this._tiffData[t]}getUint16(t){return this._littleEndian?this._tiffData[t+1]<<8|this._tiffData[t]:this._tiffData[t]<<8|this._tiffData[t+1]}getUint32(t){const e=this._tiffData;return this._littleEndian?e[t+3]<<24|e[t+2]<<16|e[t+1]<<8|e[t]:e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}checkLittleEndian(){const t=this.getUint16(0);if(18761===t)this._littleEndian=!0;else{if(19789!==t)throw console.log(t),TypeError(D(6019));this._littleEndian=!1}return this._littleEndian}hasTowel(){if(42!==this.getUint16(2))throw RangeError(D(6020));return!0}getFieldTypeName(t){return t in z6?z6[t]:null}getFieldTagName(t){return t in F6?F6[t]:(b(6021,t),`Tag${t}`)}getFieldTypeLength(t){return-1!==["BYTE","ASCII","SBYTE","UNDEFINED"].indexOf(t)?1:-1!==["SHORT","SSHORT"].indexOf(t)?2:-1!==["LONG","SLONG","FLOAT"].indexOf(t)?4:-1!==["RATIONAL","SRATIONAL","DOUBLE"].indexOf(t)?8:0}getFieldValues(t,e,i,n){const s=[],r=this.getFieldTypeLength(e);if(r*i<=4)!1===this._littleEndian?s.push(n>>>8*(4-r)):s.push(n);else for(let t=0;t<i;t++){const i=r*t;r>=8?-1!==["RATIONAL","SRATIONAL"].indexOf(e)?(s.push(this.getUint32(n+i)),s.push(this.getUint32(n+i+4))):b(8e3):s.push(this.getBytes(r,n+i))}return"ASCII"===e&&s.forEach(((t,e,i)=>{i[e]=String.fromCharCode(t)})),s}getBytes(t,e){if(t<=0)b(8001);else{if(t<=1)return this.getUint8(e);if(t<=2)return this.getUint16(e);if(t<=3)return this.getUint32(e)>>>8;if(t<=4)return this.getUint32(e);b(8002)}return 0}getBits(t,e,i){i=i||0;const n=e+Math.floor(i/8),s=i+t,r=32-t;let o=0,a=0;return s<=0?b(6023):s<=8?(o=24+i,a=this.getUint8(n)):s<=16?(o=16+i,a=this.getUint16(n)):s<=32?(o=i,a=this.getUint32(n)):b(6022),{bits:a<<o>>>r,byteOffset:n+Math.floor(s/8),bitOffset:s%8}}parseFileDirectory(t){const e=this.getUint16(t),i=[];let n=0,s=0;for(n=t+2,s=0;s<e;n+=12,s++){const t=this.getUint16(n),e=this.getUint16(n+2),s=this.getUint32(n+4),r=this.getUint32(n+8),o=this.getFieldTagName(t),a=this.getFieldTypeName(e),l=this.getFieldValues(o,a,s,r);i[o]={type:a,values:l}}this._fileDirectories.push(i);const r=this.getUint32(n);0!==r&&this.parseFileDirectory(r)}clampColorSample(t,e){const i=Math.pow(2,8-e);return Math.floor(t*i+(i-1))}parseTIFF(t,e){if(e=e||document.createElement("canvas"),this._tiffData=t,this._canvas=e,this.checkLittleEndian(),!this.hasTowel())return;const i=this.getUint32(4);this._fileDirectories.length=0,this.parseFileDirectory(i);const n=this._fileDirectories[0],s=n.ImageWidth.values[0],r=n.ImageLength.values[0];this._canvas.width=s,this._canvas.height=r;const o=[],a=n.Compression?n.Compression.values[0]:1,l=n.SamplesPerPixel.values[0],c=[];let h=0,_=!1;n.BitsPerSample.values.forEach(((t,e)=>{c[e]={bitsPerSample:t,hasBytesPerSample:!1,bytesPerSample:void 0},t%8==0&&(c[e].hasBytesPerSample=!0,c[e].bytesPerSample=t/8),h+=t}),this);let u=0;h%8==0&&(_=!0,u=h/8);const m=n.StripOffsets.values,p=m.length;let d;if(n.StripByteCounts)d=n.StripByteCounts.values;else{if(b(8003),1!==p)throw Error(D(6024));d=[Math.ceil(s*r*h/8)]}let f=1,g=1;for(let t=0;t<p;t++){const e=m[t];o[t]=[];const i=d[t];for(let n=0,s=0,r=1,h=!0,m=[],p=0,d=0,y=0;n<i;n+=r)switch(a){case 1:m=[];for(let t=0;t<l;t++){const i=c[t];if(!i.hasBytesPerSample){const t=this.getBits(i.bitsPerSample,e+n,s);throw m.push(t.bits),n=t.byteOffset-e,s=t.bitOffset,RangeError(D(6025))}{const s=i.bytesPerSample*t;m.push(this.getBytes(i.bytesPerSample,e+n+s))}}if(o[t].push(m),!_)throw r=0,RangeError(D(6026));r=u;break;case 2:case 3:case 4:case 5:case 6:case 7:break;case 32773:if(h){h=!1;const t=this.getUint8(e+n);t>=0&&t<=127?f=t+1:t>=-127&&t<=-1?g=1-t:h=!0}else{const i=this.getUint8(e+n);for(let e=0;e<g;e++){const e=c[d];if(!e.hasBytesPerSample)throw RangeError(D(6025));y=y<<8*p|i,p++,p===e.bytesPerSample&&(m.push(y),y=p=0,d++),d===l&&(o[t].push(m),m=[],d=0)}f--,0===f&&(h=!0)}r=1}}if(e.getContext){const t=this._canvas.getContext("2d");t.fillStyle="rgba(255, 255, 255, 0)";const e=n.RowsPerStrip?n.RowsPerStrip.values[0]:r,i=o.length,a=r%e,l=0===a?e:a;let h=e,_=0;const u=n.PhotometricInterpretation.values[0];let m=[],p=0;n.ExtraSamples&&(m=n.ExtraSamples.values,p=m.length);let d=[],f=0;n.ColorMap&&(d=n.ColorMap.values,f=Math.pow(2,c[0].bitsPerSample));for(let e=0;e<i;e++){e+1===i&&(h=l);const n=o[e].length,r=_*e;for(let i=0,a=0;i<h&&a<n;i++)for(let n=0;n<s;n++,a++){const s=o[e][a];let l=0,h=0,_=0,g=1;if(p>0)for(let t=0;t<p;t++)if(1===m[t]||2===m[t]){g=s[3+t]/256;break}switch(u){case 0:let t=0;c[0].hasBytesPerSample&&(t=Math.pow(16,2*c[0].bytesPerSample)),s.forEach(((e,i,n)=>{n[i]=t-e}));case 1:l=h=_=this.clampColorSample(s[0],c[0].bitsPerSample);break;case 2:l=this.clampColorSample(s[0],c[0].bitsPerSample),h=this.clampColorSample(s[1],c[1].bitsPerSample),_=this.clampColorSample(s[2],c[2].bitsPerSample);break;case 3:if(void 0===d)throw Error(D(6027));const e=s[0];l=this.clampColorSample(d[e],16),h=this.clampColorSample(d[f+e],16),_=this.clampColorSample(d[2*f+e],16);break;default:throw RangeError(D(6028,u))}t.fillStyle=`rgba(${l}, ${h}, ${_}, ${g})`,t.fillRect(n,r+i,1,1)}_=h}}return this._canvas}}const F6={315:"Artist",258:"BitsPerSample",265:"CellLength",264:"CellWidth",320:"ColorMap",259:"Compression",33432:"Copyright",306:"DateTime",338:"ExtraSamples",266:"FillOrder",289:"FreeByteCounts",288:"FreeOffsets",291:"GrayResponseCurve",290:"GrayResponseUnit",316:"HostComputer",270:"ImageDescription",257:"ImageLength",256:"ImageWidth",271:"Make",281:"MaxSampleValue",280:"MinSampleValue",272:"Model",254:"NewSubfileType",274:"Orientation",262:"PhotometricInterpretation",284:"PlanarConfiguration",296:"ResolutionUnit",278:"RowsPerStrip",277:"SamplesPerPixel",305:"Software",279:"StripByteCounts",273:"StripOffsets",255:"SubfileType",263:"Threshholding",282:"XResolution",283:"YResolution",326:"BadFaxLines",327:"CleanFaxData",343:"ClipPath",328:"ConsecutiveBadFaxLines",433:"Decode",434:"DefaultImageColor",269:"DocumentName",336:"DotRange",321:"HalftoneHints",346:"Indexed",347:"JPEGTables",285:"PageName",297:"PageNumber",317:"Predictor",319:"PrimaryChromaticities",532:"ReferenceBlackWhite",339:"SampleFormat",559:"StripRowCounts",330:"SubIFDs",292:"T4Options",293:"T6Options",325:"TileByteCounts",323:"TileLength",324:"TileOffsets",322:"TileWidth",301:"TransferFunction",318:"WhitePoint",344:"XClipPathUnits",286:"XPosition",529:"YCbCrCoefficients",531:"YCbCrPositioning",530:"YCbCrSubSampling",345:"YClipPathUnits",287:"YPosition",37378:"ApertureValue",40961:"ColorSpace",36868:"DateTimeDigitized",36867:"DateTimeOriginal",34665:"Exif IFD",36864:"ExifVersion",33434:"ExposureTime",41728:"FileSource",37385:"Flash",40960:"FlashpixVersion",33437:"FNumber",42016:"ImageUniqueID",37384:"LightSource",37500:"MakerNote",37377:"ShutterSpeedValue",37510:"UserComment",33723:"IPTC",34675:"ICC Profile",700:"XMP",42112:"GDAL_METADATA",42113:"GDAL_NODATA",34377:"Photoshop"},z6={1:"BYTE",2:"ASCII",3:"SHORT",4:"LONG",5:"RATIONAL",6:"SBYTE",7:"UNDEFINED",8:"SSHORT",9:"SLONG",10:"SRATIONAL",11:"FLOAT",12:"DOUBLE"},V6=new Array(123);for(let t=0;t<123;++t)V6[t]=64;for(let t=0;t<64;++t)V6["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(t)]=t;var U6={name:"Jacob__Codec__Base64",decode:function(t){var e,i,n,s,r,o,a=[],l=0;for(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");l<t.length;)e=V6[t.charCodeAt(l++)]<<2|(s=V6[t.charCodeAt(l++)])>>4,i=(15&s)<<4|(r=V6[t.charCodeAt(l++)])>>2,n=(3&r)<<6|(o=V6[t.charCodeAt(l++)]),a.push(String.fromCharCode(e)),64!==r&&a.push(String.fromCharCode(i)),64!==o&&a.push(String.fromCharCode(n));return a.join("")},decodeAsArray:function(t,e){var i,n,s,r=this.decode(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o}},G6=function(t){this.data=t,this.debug=!1,this.gpflags=void 0,this.files=0,this.unzipped=[],this.buf32k=new Array(32768),this.bIdx=0,this.modeZIP=!1,this.bytepos=0,this.bb=1,this.bits=0,this.nameBuf=[],this.fileout=void 0,this.literalTree=new Array(G6.LITERALS),this.distanceTree=new Array(32),this.treepos=0,this.Places=null,this.len=0,this.fpos=new Array(17),this.fpos[0]=0,this.flens=void 0,this.fmax=void 0};G6.gunzip=function(t){return t.constructor===Array||t.constructor,new G6(t).gunzip()[0][0]},G6.HufNode=function(){this.b0=0,this.b1=0,this.jump=null,this.jumppos=-1},G6.LITERALS=288,G6.NAMEMAX=256,G6.bitReverse=[0,128,64,192,32,160,96,224,16,144,80,208,48,176,112,240,8,136,72,200,40,168,104,232,24,152,88,216,56,184,120,248,4,132,68,196,36,164,100,228,20,148,84,212,52,180,116,244,12,140,76,204,44,172,108,236,28,156,92,220,60,188,124,252,2,130,66,194,34,162,98,226,18,146,82,210,50,178,114,242,10,138,74,202,42,170,106,234,26,154,90,218,58,186,122,250,6,134,70,198,38,166,102,230,22,150,86,214,54,182,118,246,14,142,78,206,46,174,110,238,30,158,94,222,62,190,126,254,1,129,65,193,33,161,97,225,17,145,81,209,49,177,113,241,9,137,73,201,41,169,105,233,25,153,89,217,57,185,121,249,5,133,69,197,37,165,101,229,21,149,85,213,53,181,117,245,13,141,77,205,45,173,109,237,29,157,93,221,61,189,125,253,3,131,67,195,35,163,99,227,19,147,83,211,51,179,115,243,11,139,75,203,43,171,107,235,27,155,91,219,59,187,123,251,7,135,71,199,39,167,103,231,23,151,87,215,55,183,119,247,15,143,79,207,47,175,111,239,31,159,95,223,63,191,127,255],G6.cplens=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],G6.cplext=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,99,99],G6.cpdist=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],G6.cpdext=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],G6.border=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],G6.prototype.gunzip=function(){return this.outputArr=[],this.nextFile(),this.unzipped},G6.prototype.readByte=function(){return this.bits+=8,this.bytepos<this.data.length?this.data.charCodeAt(this.bytepos++):-1},G6.prototype.byteAlign=function(){this.bb=1},G6.prototype.readBit=function(){var t;return this.bits++,t=1&this.bb,this.bb>>=1,0===this.bb&&(this.bb=this.readByte(),t=1&this.bb,this.bb=this.bb>>1|128),t},G6.prototype.readBits=function(t){for(var e=0,i=t;i--;)e=e<<1|this.readBit();return t&&(e=G6.bitReverse[e]>>8-t),e},G6.prototype.flushBuffer=function(){this.bIdx=0},G6.prototype.addBuffer=function(t){this.buf32k[this.bIdx++]=t,this.outputArr.push(String.fromCharCode(t)),32768===this.bIdx&&(this.bIdx=0)},G6.prototype.IsPat=function(){for(;;){if(this.fpos[this.len]>=this.fmax)return-1;if(this.flens[this.fpos[this.len]]===this.len)return this.fpos[this.len]++;this.fpos[this.len]++}},G6.prototype.Rec=function(){var t,e=this.Places[this.treepos];if(17===this.len)return-1;if(this.treepos++,this.len++,(t=this.IsPat())>=0)e.b0=t;else if(e.b0=32768,this.Rec())return-1;if((t=this.IsPat())>=0)e.b1=t,e.jump=null;else if(e.b1=32768,e.jump=this.Places[this.treepos],e.jumppos=this.treepos,this.Rec())return-1;return this.len--,0},G6.prototype.CreateTree=function(t,e,i){var n;for(this.Places=t,this.treepos=0,this.flens=i,this.fmax=e,n=0;n<17;n++)this.fpos[n]=0;return this.len=0,this.Rec()?-1:0},G6.prototype.DecodeValue=function(t){for(var e,i,n=0,s=t[n];;)if(this.readBit()){if(!(32768&s.b1))return s.b1;for(s=s.jump,e=t.length,i=0;i<e;i++)if(t[i]===s){n=i;break}}else{if(!(32768&s.b0))return s.b0;s=t[++n]}return-1},G6.prototype.DeflateLoop=function(){var t,e,i;do{var n,s;if(t=this.readBit(),0===(e=this.readBits(2)))for(this.byteAlign(),n=this.readByte(),n|=this.readByte()<<8,s=this.readByte(),65535&(n^~(s|=this.readByte()<<8))&&document.write("BlockLen checksum mismatch\n");n--;)r=this.readByte(),this.addBuffer(r);else if(1===e)for(;;)if((o=G6.bitReverse[this.readBits(7)]>>1)>23?(o=o<<1|this.readBit())>199?o=(o-=128)<<1|this.readBit():(o-=48)>143&&(o+=136):o+=256,o<256)this.addBuffer(o);else{if(256===o)break;for(o-=257,p=this.readBits(G6.cplext[o])+G6.cplens[o],o=G6.bitReverse[this.readBits(5)]>>3,G6.cpdext[o]>8?(d=this.readBits(8),d|=this.readBits(G6.cpdext[o]-8)<<8):d=this.readBits(G6.cpdext[o]),d+=G6.cpdist[o],o=0;o<p;o++){var r=this.buf32k[this.bIdx-d&32767];this.addBuffer(r)}}else if(2===e){var o,a,l,c,h,_=new Array(320);for(l=257+this.readBits(5),c=1+this.readBits(5),h=4+this.readBits(4),o=0;o<19;o++)_[o]=0;for(o=0;o<h;o++)_[G6.border[o]]=this.readBits(3);for(p=this.distanceTree.length,i=0;i<p;i++)this.distanceTree[i]=new G6.HufNode;if(this.CreateTree(this.distanceTree,19,_,0))return this.flushBuffer(),1;for(a=l+c,i=0;i<a;)if((o=this.DecodeValue(this.distanceTree))<16)_[i++]=o;else if(16===o){var u;if(i+(o=3+this.readBits(2))>a)return this.flushBuffer(),1;for(u=i?_[i-1]:0;o--;)_[i++]=u}else{if(i+(o=17===o?3+this.readBits(3):11+this.readBits(7))>a)return this.flushBuffer(),1;for(;o--;)_[i++]=0}for(p=this.literalTree.length,i=0;i<p;i++)this.literalTree[i]=new G6.HufNode;if(this.CreateTree(this.literalTree,l,_,0))return this.flushBuffer(),1;for(p=this.literalTree.length,i=0;i<p;i++)this.distanceTree[i]=new G6.HufNode;var m=new Array;for(i=l;i<_.length;i++)m[i-l]=_[i];if(this.CreateTree(this.distanceTree,c,m,0))return this.flushBuffer(),1;for(;;)if((o=this.DecodeValue(this.literalTree))>=256){var p,d;if(0==(o-=256))break;for(o--,p=this.readBits(G6.cplext[o])+G6.cplens[o],o=this.DecodeValue(this.distanceTree),G6.cpdext[o]>8?(d=this.readBits(8),d|=this.readBits(G6.cpdext[o]-8)<<8):d=this.readBits(G6.cpdext[o]),d+=G6.cpdist[o];p--;)r=this.buf32k[this.bIdx-d&32767],this.addBuffer(r)}else this.addBuffer(o)}}while(!t);return this.flushBuffer(),this.byteAlign(),0},G6.prototype.unzipFile=function(t){var e;for(this.gunzip(),e=0;e<this.unzipped.length;e++)if(this.unzipped[e][1]===t)return this.unzipped[e][0]},G6.prototype.nextFile=function(){this.outputArr=[],this.modeZIP=!1;var t=[];if(t[0]=this.readByte(),t[1]=this.readByte(),120===t[0]&&218===t[1]&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),"geonext.gxt"],this.files++),31===t[0]&&139===t[1]&&(this.skipdir(),this.unzipped[this.files]=[this.outputArr.join(""),"file"],this.files++),80===t[0]&&75===t[1]&&(this.modeZIP=!0,t[2]=this.readByte(),t[3]=this.readByte(),3===t[2]&&4===t[3])){t[0]=this.readByte(),t[1]=this.readByte(),this.gpflags=this.readByte(),this.gpflags|=this.readByte()<<8;var e=this.readByte();e|=this.readByte()<<8,this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte();var i=this.readByte();i|=this.readByte()<<8;var n=this.readByte();for(n|=this.readByte()<<8,r=0,this.nameBuf=[];i--;){var s=this.readByte();"/"===s|":"===s?r=0:r<G6.NAMEMAX-1&&(this.nameBuf[r++]=String.fromCharCode(s))}this.fileout||(this.fileout=this.nameBuf);for(var r=0;r<n;)s=this.readByte(),r++;8===e&&(this.DeflateLoop(),this.unzipped[this.files]=[this.outputArr.join(""),this.nameBuf.join("")],this.files++),this.skipdir()}},G6.prototype.skipdir=function(){var t,e,i=[];if(8&this.gpflags&&(i[0]=this.readByte(),i[1]=this.readByte(),i[2]=this.readByte(),i[3]=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte()),this.modeZIP&&this.nextFile(),i[0]=this.readByte(),8!==i[0])return 0;if(this.gpflags=this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),4&this.gpflags)for(i[0]=this.readByte(),i[2]=this.readByte(),this.len=i[0]+256*i[1],t=0;t<this.len;t++)this.readByte();if(8&this.gpflags)for(t=0,this.nameBuf=[];e=this.readByte();)"7"!==e&&":"!==e||(t=0),t<G6.NAMEMAX-1&&(this.nameBuf[t++]=e);if(16&this.gpflags)for(;e=this.readByte(););2&this.gpflags&&(this.readByte(),this.readByte()),this.DeflateLoop(),this.readByte(),this.readByte(),this.readByte(),this.readByte(),this.modeZIP&&this.nextFile()};var k6,H6,j6,W6,q6,X6,Y6,K6,$6,J6,Z6,Q6,t8,e8,i8,n8,s8,r8,o8,a8,l8,c8,h8,_8,u8,m8,p8,d8,f8,g8,y8,v8,x8,b8,S8,A8,C8,T8,w8,E8,P8,D8,I8,R8,M8,O8,B8,N8,L8,F8,z8,V8,U8,G8,k8,H8,j8,W8,q8,X8,Y8,K8,$8,J8,Z8,Q8,t7,e7,i7,n7,s7,r7,o7,a7,l7,c7,h7,_7,u7,m7,p7,d7,f7,g7,y7,v7,x7,b7,S7,A7,C7,T7,w7,E7,P7,D7,I7,R7={name:"Jacob__Codec"};let M7;function O7(t){const e=t.parent,i=t.getComponent(B7);return e&&i?O7(e):t.getComponentsInChildren(B7)}R7.Base64=U6,R7.GZip=G6,R7.unzip=function(){return R7.GZip.gunzip.apply(R7.GZip,arguments)},R7.unzipBase64=function(){var t=R7.Base64.decode.apply(R7.Base64,arguments);try{return R7.GZip.gunzip.call(R7.GZip,t)}catch(e){return t.slice(7)}},R7.unzipBase64AsArray=function(t,e){e=e||1;var i,n,s,r=this.unzipBase64(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},R7.unzipAsArray=function(t,e){e=e||1;var i,n,s,r=this.unzip(t),o=[];for(i=0,s=r.length/e;i<s;i++)for(o[i]=0,n=e-1;n>=0;--n)o[i]+=r.charCodeAt(i*e+n)<<8*n;return o},function(t){t[t.JPG=0]="JPG",t[t.PNG=1]="PNG",t[t.TIFF=2]="TIFF",t[t.WEBP=3]="WEBP",t[t.PVR=4]="PVR",t[t.ETC=5]="ETC",t[t.S3TC=6]="S3TC",t[t.ATITC=7]="ATITC",t[t.TGA=8]="TGA",t[t.RAWDATA=9]="RAWDATA",t[t.UNKNOWN=10]="UNKNOWN"}(M7||(M7={}));let B7=t("ParticleSystem2D",(k6=Vl("cc.ParticleSystem2D"),H6=Jl(),j6=rc(),W6=yc(M6),q6=rc(),X6=yc(pN),Y6=rc(),K6=rc(),$6=rc(),J6=rc(),Z6=rc(),Q6=rc(),t8=rc(),e8=rc(),i8=nc(),n8=rc(),s8=rc(),r8=rc(),o8=rc(),a8=rc(),l8=rc(),c8=rc(),h8=rc(),_8=rc(),u8=rc(),m8=rc(),p8=rc(),d8=rc(),f8=yc(v6),g8=rc(),y8=yc(y6),v8=rc(),x8=rc(),b8=rc(),S8=rc(),A8=rc(),C8=rc(),T8=rc(),w8=rc(),E8=rc(),P8=rc(),D8=rc(),I8=rc(),R8=rc(),M8=rc(),O8=rc(),B8=rc(),N8=rc(),L8=ql("preview"),F8=rc(),k6(z8=H6(z8=Zl(z8=$l((I7=D7=class t extends iF{get custom(){return this._custom}set custom(t){this._custom!==t&&(this._custom=t,this._applyFile())}get file(){return this._file}set file(t){this._file!==t&&(this._file=t,t?this._applyFile():this.custom=!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){this._renderSpriteFrame!==t&&(this._renderSpriteFrame=t,t&&!t._uuid||(this._spriteFrame=t),this._applySpriteFrame())}get particleCount(){return this._simulator.particles.length}get totalParticles(){return this._totalParticles}set totalParticles(t){this._totalParticles!==t&&(this._totalParticles=t)}get startColor(){return this._startColor}set startColor(t){this._startColor.r=t.r,this._startColor.g=t.g,this._startColor.b=t.b,this._startColor.a=t.a}get startColorVar(){return this._startColorVar}set startColorVar(t){this._startColorVar.r=t.r,this._startColorVar.g=t.g,this._startColorVar.b=t.b,this._startColorVar.a=t.a}set color(t){}get color(){return this._color}get endColor(){return this._endColor}set endColor(t){this._endColor.r=t.r,this._endColor.g=t.g,this._endColor.b=t.b,this._endColor.a=t.a}get endColorVar(){return this._endColorVar}set endColorVar(t){this._endColorVar.r=t.r,this._endColorVar.g=t.g,this._endColorVar.b=t.b,this._endColorVar.a=t.a}get positionType(){return this._positionType}set positionType(t){this._positionType=t,this._updateMaterial()}get preview(){return this._preview}set preview(t){t?this._startPreview():this._stopPreview(),this._preview=t}get stopped(){return this._stopped}get active(){return this._simulator.active}get assembler(){return this._assembler}constructor(){super(),Tl(this,"duration",U8,this),Tl(this,"emissionRate",G8,this),Tl(this,"life",k8,this),Tl(this,"lifeVar",H8,this),Tl(this,"angle",j8,this),Tl(this,"angleVar",W8,this),Tl(this,"startSize",q8,this),Tl(this,"startSizeVar",X8,this),Tl(this,"endSize",Y8,this),Tl(this,"endSizeVar",K8,this),Tl(this,"startSpin",$8,this),Tl(this,"startSpinVar",J8,this),Tl(this,"endSpin",Z8,this),Tl(this,"endSpinVar",Q8,this),Tl(this,"sourcePos",t7,this),Tl(this,"posVar",e7,this),Tl(this,"emitterMode",i7,this),Tl(this,"gravity",n7,this),Tl(this,"speed",s7,this),Tl(this,"speedVar",r7,this),Tl(this,"tangentialAccel",o7,this),Tl(this,"tangentialAccelVar",a7,this),Tl(this,"radialAccel",l7,this),Tl(this,"radialAccelVar",c7,this),Tl(this,"rotationIsDir",h7,this),Tl(this,"startRadius",_7,this),Tl(this,"startRadiusVar",u7,this),Tl(this,"endRadius",m7,this),Tl(this,"endRadiusVar",p7,this),Tl(this,"rotatePerS",d7,this),Tl(this,"rotatePerSVar",f7,this),this.aspectRatio=1,Tl(this,"playOnLoad",g7,this),Tl(this,"autoRemoveOnFinish",y7,this),Tl(this,"_preview",v7,this),Tl(this,"_custom",x7,this),Tl(this,"_file",b7,this),Tl(this,"_spriteFrame",S7,this),Tl(this,"_totalParticles",A7,this),Tl(this,"_startColor",C7,this),Tl(this,"_startColorVar",T7,this),Tl(this,"_endColor",w7,this),Tl(this,"_endColorVar",E7,this),Tl(this,"_positionType",P7,this),this._stopped=!0,this.initProperties()}onEnable(){super.onEnable(),this._updateMaterial()}onDestroy(){super.onDestroy(),this.autoRemoveOnFinish&&(this.autoRemoveOnFinish=!1),this._simulator.uvFilled=0}initProperties(){this._previewTimer=null,this._focused=!1,this.aspectRatio=1,this._simulator=new P6(this)}onFocusInEditor(){this._focused=!0;const t=O7(this.node);for(let e=0;e<t.length;++e)t[e]._startPreview()}onLostFocusInEditor(){this._focused=!1;const t=O7(this.node);for(let e=0;e<t.length;++e)t[e]._stopPreview()}_startPreview(){this._preview&&this.resetSystem()}_stopPreview(){this._preview&&(this.resetSystem(),this.stopSystem()),this._previewTimer&&clearInterval(this._previewTimer)}__preload(){super.__preload(),this._custom&&this.spriteFrame&&!this._renderSpriteFrame?this._applySpriteFrame():this._file&&(this._custom?!this._getTexture()&&this._applyFile():this._applyFile()),this.playOnLoad&&this.resetSystem()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._assembler&&this._assembler.createData&&(this._simulator.renderData=this._assembler.createData(this))}lateUpdate(t){this._simulator.finished||this._simulator.step(t)}addParticle(){}stopSystem(){this._stopped=!0,this._simulator.stop()}resetSystem(){this._stopped=!1,this._simulator.reset(),this._renderFlag=this._canRender()}isFull(){return this.particleCount>=this.totalParticles}_applyFile(){const t=this._file;if(t){if(!t)return void T(6029);if(!this.isValid)return;this._plistFile=t.nativeUrl,this._custom||(this._spriteFrame!==t.spriteFrame&&(this.spriteFrame=t.spriteFrame),this._initWithDictionary(t._nativeAsset)),this._spriteFrame?!this._renderSpriteFrame&&this._spriteFrame&&this._applySpriteFrame():t.spriteFrame?this.spriteFrame=t.spriteFrame:this._custom&&this._initTextureWithDictionary(t._nativeAsset)}}_initTextureWithDictionary(t){if(t.spriteFrameUuid){const e=t.spriteFrameUuid;LE.loadAny(e,((e,i)=>{e?(t.spriteFrameUuid=void 0,this._initTextureWithDictionary(t),p(e)):this.spriteFrame=i}))}else{const i=Pn(this._plistFile,t.textureFileName||"");if(t.textureFileName)LE.loadRemote(i,((e,i)=>{e?(t.textureFileName=void 0,this._initTextureWithDictionary(t),p(e)):this.spriteFrame=pN.createWithImage(i)}));else if(t.textureImageData){const n=t.textureImageData;if(!(n&&n.length>0))return!1;{let t=LE.assets.get(i);if(!t){const s=R7.unzipBase64AsArray(n,1);if(!s)return A(6030,this._file.name),!1;const r=(e=s).length>8&&137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]&&13===e[4]&&10===e[5]&&26===e[6]&&10===e[7]?M7.PNG:e.length>2&&(73===e[0]&&73===e[1]||77===e[0]&&77===e[1]||255===e[0]&&216===e[1])?M7.TIFF:M7.UNKNOWN;if(r!==M7.TIFF&&r!==M7.PNG)return A(6031,this._file.name),!1;const o=document.createElement("canvas");r===M7.PNG?new N6(s).render(o):(this._tiffReader||(this._tiffReader=new L6),this._tiffReader.parseTIFF(s,o)),t=new Gd(o),LE.assets.add(i,t)}t||A(6032,this._file.name),this.spriteFrame=pN.createWithImage(t)}}}var e;return!0}_initWithDictionary(t){this.totalParticles=parseInt(t.maxParticles||0),this.life=parseFloat(t.particleLifespan||0),this.lifeVar=parseFloat(t.particleLifespanVariance||0);const e=t.emissionRate;this.emissionRate=e||Math.min(this.totalParticles/this.life,Number.MAX_VALUE),this.duration=parseFloat(t.duration||0),this._srcBlendFactor=parseInt(t.blendFuncSource||Ys.SRC_ALPHA),this._dstBlendFactor=parseInt(t.blendFuncDestination||Ys.ONE_MINUS_SRC_ALPHA);const i=this._startColor;i.r=255*parseFloat(t.startColorRed||0),i.g=255*parseFloat(t.startColorGreen||0),i.b=255*parseFloat(t.startColorBlue||0),i.a=255*parseFloat(t.startColorAlpha||0);const n=this._startColorVar;n.r=255*parseFloat(t.startColorVarianceRed||0),n.g=255*parseFloat(t.startColorVarianceGreen||0),n.b=255*parseFloat(t.startColorVarianceBlue||0),n.a=255*parseFloat(t.startColorVarianceAlpha||0);const s=this._endColor;s.r=255*parseFloat(t.finishColorRed||0),s.g=255*parseFloat(t.finishColorGreen||0),s.b=255*parseFloat(t.finishColorBlue||0),s.a=255*parseFloat(t.finishColorAlpha||0);const r=this._endColorVar;if(r.r=255*parseFloat(t.finishColorVarianceRed||0),r.g=255*parseFloat(t.finishColorVarianceGreen||0),r.b=255*parseFloat(t.finishColorVarianceBlue||0),r.a=255*parseFloat(t.finishColorVarianceAlpha||0),this.startSize=parseFloat(t.startParticleSize||0),this.startSizeVar=parseFloat(t.startParticleSizeVariance||0),this.endSize=parseFloat(t.finishParticleSize||0),this.endSizeVar=parseFloat(t.finishParticleSizeVariance||0),this.positionType=parseFloat(void 0!==t.positionType?t.positionType:v6.FREE),this.sourcePos.set(0,0),this.posVar.set(parseFloat(t.sourcePositionVariancex||0),parseFloat(t.sourcePositionVariancey||0)),this.angle=parseFloat(t.angle||0),this.angleVar=parseFloat(t.angleVariance||0),this.startSpin=parseFloat(t.rotationStart||0),this.startSpinVar=parseFloat(t.rotationStartVariance||0),this.endSpin=parseFloat(t.rotationEnd||0),this.endSpinVar=parseFloat(t.rotationEndVariance||0),this.emitterMode=parseInt(t.emitterType||y6.GRAVITY),this.emitterMode===y6.GRAVITY){this.gravity.set(parseFloat(t.gravityx||0),parseFloat(t.gravityy||0)),this.speed=parseFloat(t.speed||0),this.speedVar=parseFloat(t.speedVariance||0),this.radialAccel=parseFloat(t.radialAcceleration||0),this.radialAccelVar=parseFloat(t.radialAccelVariance||0),this.tangentialAccel=parseFloat(t.tangentialAcceleration||0),this.tangentialAccelVar=parseFloat(t.tangentialAccelVariance||0);let e=t.rotationIsDir||"";null!==e?(e=e.toString().toLowerCase(),this.rotationIsDir="true"===e||"1"===e):this.rotationIsDir=!1}else{if(this.emitterMode!==y6.RADIUS)return A(6009),!1;this.startRadius=parseFloat(t.maxRadius||0),this.startRadiusVar=parseFloat(t.maxRadiusVariance||0),this.endRadius=parseFloat(t.minRadius||0),this.endRadiusVar=parseFloat(t.minRadiusVariance||0),this.rotatePerS=parseFloat(t.rotatePerSecond||0),this.rotatePerSVar=parseFloat(t.rotatePerSecondVariance||0)}return this._initTextureWithDictionary(t),!0}_syncAspect(){if(this._renderSpriteFrame){const t=this._renderSpriteFrame.rect;this.aspectRatio=t.width/t.height}}_applySpriteFrame(){this._renderSpriteFrame=this._renderSpriteFrame||this._spriteFrame,this._renderSpriteFrame?this._renderSpriteFrame.texture&&(this._simulator.updateUVs(!0),this._syncAspect(),this._updateMaterial(),this._stopped=!1,this._renderFlag=this._canRender()):this.resetSystem()}_getTexture(){return this._renderSpriteFrame&&this._renderSpriteFrame.texture}_updateMaterial(){const t=this.getMaterialInstance(0);t&&t.recompileShaders({USE_LOCAL:this._positionType!==v6.FREE})}_finishedSimulation(){this.resetSystem(),this.stopSystem(),this._renderFlag=this._canRender(),this.autoRemoveOnFinish&&this._stopped&&this.node.destroy()}_canRender(){return super._canRender()&&!this._stopped&&null!==this._renderSpriteFrame}_render(t){this._positionType===v6.RELATIVE?t.commitComp(this,this._renderSpriteFrame,this._assembler,this.node.parent):this.positionType===v6.GROUPED?t.commitComp(this,this._renderSpriteFrame,this._assembler,this.node):t.commitComp(this,this._renderSpriteFrame,this._assembler,null)}},D7.EmitterMode=y6,D7.PositionType=v6,D7.DURATION_INFINITY=-1,D7.START_SIZE_EQUAL_TO_END_SIZE=-1,D7.START_RADIUS_EQUAL_TO_END_RADIUS=-1,wl((V8=I7).prototype,"custom",[ic,j6],Object.getOwnPropertyDescriptor(V8.prototype,"custom"),V8.prototype),wl(V8.prototype,"file",[W6,q6],Object.getOwnPropertyDescriptor(V8.prototype,"file"),V8.prototype),wl(V8.prototype,"spriteFrame",[X6,Y6],Object.getOwnPropertyDescriptor(V8.prototype,"spriteFrame"),V8.prototype),wl(V8.prototype,"totalParticles",[ic,K6],Object.getOwnPropertyDescriptor(V8.prototype,"totalParticles"),V8.prototype),U8=wl(V8.prototype,"duration",[Wl,ic,$6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),G8=wl(V8.prototype,"emissionRate",[Wl,ic,J6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),k8=wl(V8.prototype,"life",[Wl,ic,Z6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),H8=wl(V8.prototype,"lifeVar",[Wl,ic,Q6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wl(V8.prototype,"startColor",[ic,t8],Object.getOwnPropertyDescriptor(V8.prototype,"startColor"),V8.prototype),wl(V8.prototype,"startColorVar",[ic,e8],Object.getOwnPropertyDescriptor(V8.prototype,"startColorVar"),V8.prototype),wl(V8.prototype,"color",[i8],Object.getOwnPropertyDescriptor(V8.prototype,"color"),V8.prototype),wl(V8.prototype,"endColor",[ic,n8],Object.getOwnPropertyDescriptor(V8.prototype,"endColor"),V8.prototype),wl(V8.prototype,"endColorVar",[ic,s8],Object.getOwnPropertyDescriptor(V8.prototype,"endColorVar"),V8.prototype),j8=wl(V8.prototype,"angle",[Wl,ic,r8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 90}}),W8=wl(V8.prototype,"angleVar",[Wl,ic,o8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),q8=wl(V8.prototype,"startSize",[Wl,ic,a8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),X8=wl(V8.prototype,"startSizeVar",[Wl,ic,l8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Y8=wl(V8.prototype,"endSize",[Wl,ic,c8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),K8=wl(V8.prototype,"endSizeVar",[Wl,ic,h8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$8=wl(V8.prototype,"startSpin",[Wl,ic,_8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),J8=wl(V8.prototype,"startSpinVar",[Wl,ic,u8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Z8=wl(V8.prototype,"endSpin",[Wl,ic,m8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Q8=wl(V8.prototype,"endSpinVar",[Wl,ic,p8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),t7=wl(V8.prototype,"sourcePos",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.ZERO.clone()}}),e7=wl(V8.prototype,"posVar",[Wl,ic,d8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.ZERO.clone()}}),wl(V8.prototype,"positionType",[f8,g8],Object.getOwnPropertyDescriptor(V8.prototype,"positionType"),V8.prototype),wl(V8.prototype,"preview",[ic],Object.getOwnPropertyDescriptor(V8.prototype,"preview"),V8.prototype),i7=wl(V8.prototype,"emitterMode",[Wl,ic,y8,v8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y6.GRAVITY}}),n7=wl(V8.prototype,"gravity",[Wl,ic,x8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tn.ZERO.clone()}}),s7=wl(V8.prototype,"speed",[Wl,ic,b8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 180}}),r7=wl(V8.prototype,"speedVar",[Wl,ic,S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 50}}),o7=wl(V8.prototype,"tangentialAccel",[Wl,ic,A8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 80}}),a7=wl(V8.prototype,"tangentialAccelVar",[Wl,ic,C8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),l7=wl(V8.prototype,"radialAccel",[Wl,ic,T8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),c7=wl(V8.prototype,"radialAccelVar",[Wl,ic,w8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h7=wl(V8.prototype,"rotationIsDir",[Wl,ic,E8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),_7=wl(V8.prototype,"startRadius",[Wl,ic,P8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),u7=wl(V8.prototype,"startRadiusVar",[Wl,ic,D8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),m7=wl(V8.prototype,"endRadius",[Wl,ic,I8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),p7=wl(V8.prototype,"endRadiusVar",[Wl,ic,R8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),d7=wl(V8.prototype,"rotatePerS",[Wl,ic,M8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),f7=wl(V8.prototype,"rotatePerSVar",[Wl,ic,O8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),g7=wl(V8.prototype,"playOnLoad",[Wl,ic,B8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),y7=wl(V8.prototype,"autoRemoveOnFinish",[Wl,ic,N8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),v7=wl(V8.prototype,"_preview",[L8,ic,F8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),x7=wl(V8.prototype,"_custom",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),b7=wl(V8.prototype,"_file",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),S7=wl(V8.prototype,"_spriteFrame",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A7=wl(V8.prototype,"_totalParticles",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 150}}),C7=wl(V8.prototype,"_startColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(255,255,255,255)}}),T7=wl(V8.prototype,"_startColorVar",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(0,0,0,0)}}),w7=wl(V8.prototype,"_endColor",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(255,255,255,0)}}),E7=wl(V8.prototype,"_endColorVar",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Ri(0,0,0,0)}}),P7=wl(V8.prototype,"_positionType",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return v6.FREE}}),z8=V8))||z8)||z8)||z8)||z8));var N7,L7,F7,z7,V7,U7,G7,k7,H7,j7,W7,q7,X7,Y7;let K7=t("MotionStreak",(N7=Vl("cc.MotionStreak"),L7=Jl(),F7=ec(),z7=yc(Af),N7(V7=$l(V7=Zl(V7=L7(V7=F7((Y7=X7=class t extends iF{constructor(...t){super(...t),Tl(this,"_preview",G7,this),Tl(this,"_fadeTime",k7,this),Tl(this,"_minSeg",H7,this),Tl(this,"_stroke",j7,this),Tl(this,"_texture",W7,this),Tl(this,"_fastMode",q7,this),this._points=[]}get preview(){return this._preview}set preview(t){this._preview=t,this.reset()}get fadeTime(){return this._fadeTime}set fadeTime(t){this._fadeTime=t,this.reset()}get minSeg(){return this._minSeg}set minSeg(t){this._minSeg=t}get stroke(){return this._stroke}set stroke(t){this._stroke=t}get texture(){return this._texture}set texture(t){this._texture!==t&&(this._texture=t)}get fastMode(){return this._fastMode}set fastMode(t){this._fastMode=t}get points(){return this._points}onEnable(){super.onEnable(),this.reset()}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)}onFocusInEditor(){this._preview&&this.reset()}onLostFocusInEditor(){this._preview&&this.reset()}reset(){this._points.length=0,this._renderData&&this._renderData.clear()}lateUpdate(t){this._assembler&&this._assembler.update(this,t)}_render(t){t.commitComp(this,this._texture,this._assembler,null)}},X7.Point=class{constructor(t,e){this.point=new tn,this.dir=new tn,this.distance=0,this.time=0,t&&this.point.set(t),e&&this.dir.set(e)}setPoint(t,e){this.point.x=t,this.point.y=e}setDir(t,e){this.dir.x=t,this.dir.y=e}},wl((U7=Y7).prototype,"preview",[ic],Object.getOwnPropertyDescriptor(U7.prototype,"preview"),U7.prototype),wl(U7.prototype,"fadeTime",[ic],Object.getOwnPropertyDescriptor(U7.prototype,"fadeTime"),U7.prototype),wl(U7.prototype,"minSeg",[ic],Object.getOwnPropertyDescriptor(U7.prototype,"minSeg"),U7.prototype),wl(U7.prototype,"stroke",[ic],Object.getOwnPropertyDescriptor(U7.prototype,"stroke"),U7.prototype),wl(U7.prototype,"texture",[z7],Object.getOwnPropertyDescriptor(U7.prototype,"texture"),U7.prototype),wl(U7.prototype,"fastMode",[ic],Object.getOwnPropertyDescriptor(U7.prototype,"fastMode"),U7.prototype),G7=wl(U7.prototype,"_preview",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k7=wl(U7.prototype,"_fadeTime",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),H7=wl(U7.prototype,"_minSeg",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j7=wl(U7.prototype,"_stroke",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),W7=wl(U7.prototype,"_texture",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),q7=wl(U7.prototype,"_fastMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),V7=U7))||V7)||V7)||V7)||V7)||V7));new tn;const $7=new tn,J7=new tn;function Z7(t,e){return t.x=-e.y,t.y=e.x,t}const Q7={createData(t){const e=t.requestRenderData();return e.dataLength=4,e.vertexCount=16,e.indicesCount=42,e},update(t,e){const i=t.stroke/2,n=t.node.worldMatrix,s=n.m12,r=n.m13,o=t.points;let a;if(o.length>1){const e=o[0],i=e.point.x-s,n=e.point.y-r;i*i+n*n<t.minSeg&&(a=e)}a||(a=new K7.Point,o.unshift(a)),a.setPoint(s,r),a.time=t.fadeTime+e;let l=0,c=0;if(o.length<2)return;const h=t.renderData,_=t.color,u=_.r,m=_.g,p=_.b,d=_.a,f=o[1];f.distance=tn.subtract(J7,a.point,f.point).length(),J7.normalize(),f.setDir(J7.x,J7.y),a.setDir(J7.x,J7.y),h.dataLength=2*o.length;const g=h.data,y=t.fadeTime;let v=!1;for(let t=o.length-1;t>=0;t--){const n=o[t],s=n.point,r=n.dir;if(n.time-=e,n.time<0){o.splice(t,1);continue}const a=n.time/y,c=o[t-1];if(!v){if(!c){o.splice(t,1);continue}s.x=c.point.x-r.x*a,s.y=c.point.y-r.y*a}v=!0,Z7($7,r);const h=(a*d<<24>>>0)+(p<<16)+(m<<8)+u;let _=l;g[_].x=s.x+$7.x*i,g[_].y=s.y+$7.y*i,g[_].u=1,g[_].v=a,g[_].color._val=h,_+=1,g[_].x=s.x-$7.x*i,g[_].y=s.y-$7.y*i,g[_].u=0,g[_].v=a,g[_].color._val=h,l+=2}c=l<=2?0:3*(l-2),h.vertexCount=l,h.indicesCount=c},updateRenderData(t){},fillBuffers(t,e){const i=t.renderData,n=i.data;t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;s.request(i.vertexCount,i.indicesCount)||(s=e.currBufferBatch,o=0,a=0);const l=s.vData,c=s.iData,h=i.vertexCount,_=i.indicesCount;for(let t=0;t<h;t++){const e=n[t];l[r++]=e.x,l[r++]=e.y,l[r++]=e.z,l[r++]=e.u,l[r++]=e.v,Ri.toArray(l,e.color,r),r+=4}for(let t=0,e=_;t<e;t+=2){const e=a+t;c[o++]=e,c[o++]=e+2,c[o++]=e+1,c[o++]=e+1,c[o++]=e+2,c[o++]=e+3}}},t9=t("MotionStreakAssemblerManager",{getAssembler:()=>Q7});K7.Assembler=t9;const e9={maxParticleDeltaTime:0,createData:()=>cL.add(),updateRenderData(){},fillBuffers(t,e){if(null===t)return;const i=t._simulator.renderData;if(0===i.vertexCount||0===i.indicesCount)return;let n=e.acquireBufferBatch(),s=n.byteOffset>>2,r=n.indicesOffset,o=n.vertexOffset;n.request(i.vertexCount,i.indicesCount)||(n=e.currBufferBatch,r=0,o=0);const a=n.vData,l=n.iData,c=i.vData,h=i.iData,_=9*i.vertexCount;for(let t=0;t<_;t++)a[s++]=c[t];const u=i.indicesCount;for(let t=0;t<u;t++)l[r++]=h[t]+o}},i9=t("ParticleSystem2DAssembler",{getAssembler:()=>(e9.maxParticleDeltaTime||(e9.maxParticleDeltaTime=n.game.frameTime/1e3*2),e9)});let n9,s9,r9;B7.Assembler=i9,function(t){t.PLAYED="play",t.PAUSED="pause",t.STOPPED="stop",t.SEEKED="seeked",t.ENDED="ended",t.INTERRUPTION_BEGIN="interruptionBegin",t.INTERRUPTION_END="interruptionEnd",t.USER_GESTURE="on_gesture"}(n9||(n9={})),function(t){t[t.DOM_AUDIO=0]="DOM_AUDIO",t[t.WEB_AUDIO=1]="WEB_AUDIO",t[t.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",t[t.NATIVE_AUDIO=3]="NATIVE_AUDIO",t[t.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(s9||(s9={})),function(t){t[t.INIT=0]="INIT",t[t.PLAYING=1]="PLAYING",t[t.PAUSED=2]="PAUSED",t[t.STOPPED=3]="STOPPED",t[t.INTERRUPTED=4]="INTERRUPTED"}(r9||(r9={}));let o9=0;function a9(t,e){e.invoking||(e.invoking=!0,e.func.call(t,...e.args).then((()=>{e.invoking=!1,t._operationQueue.shift(),t._eventTarget.emit(e.id.toString());const i=t._operationQueue[0];i&&a9(t,i)})).catch((()=>{})))}function l9(t,e,i){const n=i.value;i.value=function(...t){return new Promise((e=>{const i=o9++,s=this;s._operationQueue.push({id:i,func:n,args:t,invoking:!1}),s._eventTarget.once(i.toString(),e),a9(s,s._operationQueue[0])}))}}var c9,h9,_9;const u9={},m9=jsb.AudioEngine,p9=-1;class d9{get onPlay(){return this._onPlayCb}set onPlay(t){this._onPlayCb=t}get onEnd(){return this._onEndCb}set onEnd(t){this._onEndCb=t}constructor(t,e){this._id=p9,this._url=void 0,this._volume=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._url=t,this._volume=e}play(){var t;this._id=jsb.AudioEngine.play2d(this._url,!1,this._volume),jsb.AudioEngine.setFinishCallback(this._id,(()=>{var t;null===(t=this.onEnd)||void 0===t||t.call(this)})),null===(t=this.onPlay)||void 0===t||t.call(this)}stop(){this._id!==p9&&jsb.AudioEngine.stop(this._id)}}let f9=(_9=h9=class t{constructor(t){this._url=void 0,this._id=p9,this._state=r9.INIT,this._eventTarget=new He,this._operationQueue=[],this._cachedState={duration:1,loop:!1,currentTime:0,volume:1},this._url=t,qe.on("hide",this._onHide,this),qe.on("show",this._onShow,this)}destroy(){qe.on("hide",this._onHide,this),qe.on("show",this._onShow,this),--u9[this._url]<=0&&m9.uncache(this._url)}_onHide(){this._state===r9.PLAYING&&this.pause().then((()=>{this._state=r9.INTERRUPTED,this._eventTarget.emit(n9.INTERRUPTION_BEGIN)})).catch((()=>{}))}_onShow(){this._state===r9.INTERRUPTED&&this.play().then((()=>{this._eventTarget.emit(n9.INTERRUPTION_END)})).catch((()=>{}))}static load(e){return new Promise(((i,n)=>{t.loadNative(e).then((e=>{i(new t(e))})).catch((t=>n(t)))}))}static loadNative(t){return new Promise(((e,i)=>{qe.platform===F.WIN32?e(t):m9.preload(t,(n=>{n?e(t):i(new Error("load audio failed"))}))}))}static loadOneShotAudio(e,i){return new Promise(((n,s)=>{t.loadNative(e).then((t=>{n(new d9(t,i))})).catch(s)}))}get _isValid(){return this._id!==p9}get src(){return this._url}get type(){return s9.NATIVE_AUDIO}get state(){return this._state}get loop(){return this._isValid?m9.isLoop(this._id):this._cachedState.loop}set loop(t){this._isValid&&m9.setLoop(this._id,t),this._cachedState.loop=t}get volume(){return this._isValid?m9.getVolume(this._id):this._cachedState.volume}set volume(t){t=mi(t),this._isValid&&m9.setVolume(this._id,t),this._cachedState.volume=t}get duration(){return this._isValid?m9.getDuration(this._id):this._cachedState.duration}get currentTime(){return this._isValid?m9.getCurrentTime(this._id):this._cachedState.currentTime}seek(t){return new Promise((e=>(this._isValid&&m9.setCurrentTime(this._id,t),this._cachedState.currentTime=t,e())))}play(){return new Promise((t=>{this._isValid?this._state===r9.PAUSED||this._state===r9.INTERRUPTED?m9.resume(this._id):this._state===r9.PLAYING&&(m9.pause(this._id),m9.setCurrentTime(this._id,0),m9.resume(this._id)):(this._id=m9.play2d(this._url,this._cachedState.loop,this._cachedState.volume),this._isValid&&(0!==this._cachedState.currentTime&&(m9.setCurrentTime(this._id,this._cachedState.currentTime),this._cachedState.currentTime=0),m9.setFinishCallback(this._id,(()=>{this._id=p9,this._state=r9.INIT,this._eventTarget.emit(n9.ENDED)})))),this._state=r9.PLAYING,t()}))}pause(){return new Promise((t=>{this._isValid&&m9.pause(this._id),this._state=r9.PAUSED,t()}))}stop(){return new Promise((t=>{this._isValid&&m9.stop(this._id),this._state=r9.STOPPED,this._id=p9,t()}))}onInterruptionBegin(t){this._eventTarget.on(n9.INTERRUPTION_BEGIN,t)}offInterruptionBegin(t){this._eventTarget.off(n9.INTERRUPTION_BEGIN,t)}onInterruptionEnd(t){this._eventTarget.on(n9.INTERRUPTION_END,t)}offInterruptionEnd(t){this._eventTarget.off(n9.INTERRUPTION_END,t)}onEnded(t){this._eventTarget.on(n9.ENDED,t)}offEnded(t){this._eventTarget.off(n9.ENDED,t)}},h9.maxAudioChannel=m9.getMaxAudioInstance(),wl((c9=_9).prototype,"seek",[l9],Object.getOwnPropertyDescriptor(c9.prototype,"seek"),c9.prototype),wl(c9.prototype,"play",[l9],Object.getOwnPropertyDescriptor(c9.prototype,"play"),c9.prototype),wl(c9.prototype,"pause",[l9],Object.getOwnPropertyDescriptor(c9.prototype,"pause"),c9.prototype),wl(c9.prototype,"stop",[l9],Object.getOwnPropertyDescriptor(c9.prototype,"stop"),c9.prototype),c9);var g9,y9,v9,x9,b9;n.AudioPlayer=f9;let S9=t("AudioClip",Vl("cc.AudioClip")((b9=x9=class extends _h{constructor(){super(),Tl(this,"_duration",v9,this),this._loadMode=s9.UNKNOWN_AUDIO,this._meta=null,this._player=void 0}destroy(){var t;const e=super.destroy();return null===(t=this._player)||void 0===t||t.destroy(),e}set _nativeAsset(t){this._meta=t,t?(this._loadMode=t.type,this._player=t.player):(this._meta=null,this._loadMode=s9.UNKNOWN_AUDIO,this._duration=0)}get _nativeAsset(){return this._meta}get _nativeDep(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}get loadMode(){return this._loadMode}validate(){return!!this._meta}getDuration(){return this._duration?this._duration:this._meta?this._meta.duration:0}get state(){return this._player?this._player.state:r9.INIT}getCurrentTime(){return this._player?this._player.currentTime:0}getVolume(){return this._player?this._player.volume:0}getLoop(){return!!this._player&&this._player.loop}setCurrentTime(t){var e;null===(e=this._player)||void 0===e||e.seek(t).catch((()=>{}))}setVolume(t){this._player&&(this._player.volume=t)}setLoop(t){this._player&&(this._player.loop=t)}play(){var t;null===(t=this._player)||void 0===t||t.play().catch((()=>{}))}pause(){var t;null===(t=this._player)||void 0===t||t.pause().catch((()=>{}))}stop(){var t;null===(t=this._player)||void 0===t||t.stop().catch((()=>{}))}playOneShot(t=1){this._nativeAsset&&f9.loadOneShotAudio(this._nativeAsset.url,t).then((t=>{t.play()})).catch((()=>{}))}},x9.AudioType=s9,v9=wl((y9=b9).prototype,"_duration",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wl(y9.prototype,"_nativeDep",[vc],Object.getOwnPropertyDescriptor(y9.prototype,"_nativeDep"),y9.prototype),g9=y9))||g9);function A9(t,e,i){f9.load(t,{audioLoadMode:e.audioLoadMode}).then((e=>{const n={player:e,url:t,duration:e.duration,type:e.type};i(null,n)})).catch((t=>{i(t)}))}function C9(t,e,i,n){const s=new S9;s._nativeUrl=t,s._nativeAsset=e,s._duration=e.duration,n(null,s)}n.AudioClip=S9,mE.register({".mp3":A9,".ogg":A9,".wav":A9,".m4a":A9}),xE.register({".mp3":C9,".ogg":C9,".wav":C9,".m4a":C9});const T9=new class{constructor(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}_findIndex(t,e){return t.findIndex((t=>t.audio===e))}_tryAddPlaying(t,e){const i=this._findIndex(t,e);return i>-1?(t[i].playTime=performance.now(),!1):(t.push({audio:e,playTime:performance.now()}),!0)}addPlaying(t){if(t instanceof f9){if(this._tryAddPlaying(this._audioPlayerInfoList,t))return}else this._tryAddPlaying(this._oneShotAudioInfoList,t)}_tryRemovePlaying(t,e){const i=this._findIndex(t,e);return-1!==i&&(H(t,i),!0)}removePlaying(t){if(t instanceof f9){if(this._tryRemovePlaying(this._audioPlayerInfoList,t))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,t)}discardOnePlayingIfNeeded(){if(this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<f9.maxAudioChannel)return;let t;this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})):this._audioPlayerInfoList.forEach((e=>{(!t||e.playTime<t.playTime)&&(t=e)})),t&&(t.audio.stop(),this.removePlaying(t.audio))}};var w9,E9,P9,D9,I9,R9,M9,O9,B9,N9,L9,F9,z9,V9,U9,G9,k9,H9,j9;!function(t){t.STARTED="started",t.ENDED="ended"}(j9||(j9={}));let W9=function(e){return t({AudioSource:e,AudioSourceComponent:e}),e}((w9=Vl("cc.AudioSource"),E9=ec(),P9=Jl(),D9=yc(S9),I9=yc(S9),R9=rc(),M9=rc(),O9=rc(),B9=oc(),N9=rc(),w9(L9=E9(L9=P9((H9=k9=class t extends Rh{constructor(...t){super(...t),Tl(this,"_clip",z9,this),this._player=null,Tl(this,"_loop",V9,this),Tl(this,"_playOnAwake",U9,this),Tl(this,"_volume",G9,this),this._cachedCurrentTime=0,this._operationsBeforeLoading=[],this._isLoaded=!1,this._lastSetClip=void 0}static get maxAudioChannel(){return f9.maxAudioChannel}set clip(t){t!==this._clip&&(this._clip=t,this._syncPlayer())}get clip(){return this._clip}_syncPlayer(){const t=this._clip;this._isLoaded=!1,t&&this._lastSetClip!==t&&(t._nativeAsset?(this._lastSetClip=t,f9.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((e=>{this._lastSetClip===t&&(this._isLoaded=!0,this._player&&(this._player.offEnded(),this._player.offInterruptionBegin(),this._player.offInterruptionEnd(),this._player.destroy()),this._player=e,e.onEnded((()=>{T9.removePlaying(e),this.node.emit(j9.ENDED,this)})),e.onInterruptionBegin((()=>{T9.removePlaying(e)})),e.onInterruptionEnd((()=>{T9.addPlaying(e)})),this._syncStates())})).catch((()=>{}))):console.error("Invalid audio clip"))}set loop(t){this._loop=t,this._player&&(this._player.loop=t)}get loop(){return this._loop}set playOnAwake(t){this._playOnAwake=t}get playOnAwake(){return this._playOnAwake}set volume(t){Number.isNaN(t)?console.warn("illegal audio volume!"):(t=ui(t,0,1),this._player?(this._player.volume=t,this._volume=this._player.volume):this._volume=t)}get volume(){return this._volume}onLoad(){this._syncPlayer()}onEnable(){this._playOnAwake&&!this.playing&&this.play()}onDisable(){const t=this._getRootNode();(null==t?void 0:t._persistNode)||this.pause()}onDestroy(){var t;this.stop(),null===(t=this._player)||void 0===t||t.destroy()}_getRootNode(){var t,e;let i=this.node,n=null===(t=i)||void 0===t||null===(e=t.parent)||void 0===e?void 0:e.parent;for(;n;){var s,r,o;i=null===(s=i)||void 0===s?void 0:s.parent,n=null===(r=i)||void 0===r||null===(o=r.parent)||void 0===o?void 0:o.parent}return i}play(){var t,e;this._isLoaded?(T9.discardOnePlayingIfNeeded(),this.state===r9.PLAYING&&(null===(e=this._player)||void 0===e||e.stop().catch((()=>{}))),null===(t=this._player)||void 0===t||t.play().then((()=>{T9.addPlaying(this._player),this.node.emit(j9.STARTED,this)})).catch((()=>{}))):this._operationsBeforeLoading.push("play")}pause(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.pause().then((()=>{T9.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("pause")}stop(){var t;this._isLoaded?null===(t=this._player)||void 0===t||t.stop().then((()=>{T9.removePlaying(this._player)})).catch((()=>{})):this._operationsBeforeLoading.push("stop")}playOneShot(t,e=1){t._nativeAsset?f9.loadOneShotAudio(t._nativeAsset.url,this._volume*e,{audioLoadMode:t.loadMode}).then((t=>{T9.discardOnePlayingIfNeeded(),t.onPlay=()=>{T9.addPlaying(t)},t.onEnd=()=>{T9.removePlaying(t)},t.play()})).catch((()=>{})):console.error("Invalid audio clip")}_syncStates(){this._player&&this._player.seek(this._cachedCurrentTime).then((()=>{this._player&&(this._player.loop=this._loop,this._player.volume=this._volume,this._operationsBeforeLoading.forEach((t=>{var e;null===(e=this[t])||void 0===e||e.call(this)})),this._operationsBeforeLoading.length=0)})).catch((()=>{}))}set currentTime(t){var e;Number.isNaN(t)?console.warn("illegal audio time!"):(t=ui(t,0,this.duration),this._cachedCurrentTime=t,null===(e=this._player)||void 0===e||e.seek(this._cachedCurrentTime).catch((()=>{})))}get currentTime(){return this._player?this._player.currentTime:this._cachedCurrentTime}get duration(){var t,e;return null!==(t=null===(e=this._clip)||void 0===e?void 0:e.getDuration())&&void 0!==t?t:this._player?this._player.currentTime:0}get state(){return this._player?this._player.state:r9.INIT}get playing(){return this.state===t.AudioState.PLAYING}},k9.AudioState=r9,k9.EventType=j9,z9=wl((F9=H9).prototype,"_clip",[D9],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),V9=wl(F9.prototype,"_loop",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U9=wl(F9.prototype,"_playOnAwake",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G9=wl(F9.prototype,"_volume",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wl(F9.prototype,"clip",[I9,R9],Object.getOwnPropertyDescriptor(F9.prototype,"clip"),F9.prototype),wl(F9.prototype,"loop",[M9],Object.getOwnPropertyDescriptor(F9.prototype,"loop"),F9.prototype),wl(F9.prototype,"playOnAwake",[O9],Object.getOwnPropertyDescriptor(F9.prototype,"playOnAwake"),F9.prototype),wl(F9.prototype,"volume",[B9,N9],Object.getOwnPropertyDescriptor(F9.prototype,"volume"),F9.prototype),L9=F9))||L9)||L9)||L9));var q9,X9,Y9;Ze(S9,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:W9,targetName:"AudioSource"}]),ti(S9.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((t=>({name:t,suggest:`please use AudioSource.prototype.${t} instead`})))),n.AudioSourceComponent=W9,Ot.setClassAlias(W9,"cc.AudioSourceComponent");let K9=t("VideoClip",Vl("cc.VideoClip")((Y9=wl((X9=class extends _h{constructor(){super(),Tl(this,"_duration",Y9,this),this._video=null}set _nativeAsset(t){this._video=t,this._duration=t?t.duration:0}get _nativeAsset(){return this._video}}).prototype,"_duration",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),q9=X9))||q9);function $9(t,e,i){const n=document.createElement("video"),s=document.createElement("source");n.appendChild(s);const r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="blob",r.onload=function(){200===this.status||0===this.status?(s.src=URL.createObjectURL(this.response),i(null,n)):i(new Error(`${r.status}(no response)`))},r.onerror=function(){const e=`load video failure - ${t}`;u(e),i(new Error(e))},r.send()}function J9(t,e,i,n){const s=new K9;s._nativeUrl=t,s._nativeAsset=e,n(null,s)}mE.register({".mp4":$9,".avi":$9,".mov":$9,".mpg":$9,".mpeg":$9,".rm":$9,".rmvb":$9}),xE.register({".mp4":J9,".avi":J9,".mov":J9,".mpg":J9,".mpeg":J9,".rm":J9,".rmvb":J9});const Z9=Nt({REMOTE:0,LOCAL:1});let Q9,ttt;!function(t){t.NONE="none",t.PLAYING="playing",t.PAUSED="paused",t.STOPPED="stopped",t.COMPLETED="completed",t.META_LOADED="meta-loaded",t.READY_TO_PLAY="ready-to-play",t.ERROR="error",t.CLICKED="clicked"}(Q9||(Q9={})),function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(ttt||(ttt={}));class ett{constructor(t){this._componentEventList=new Map,this._state=Q9.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(NL),this._onHide=()=>{this.video&&this._state===Q9.PLAYING&&(this.video.pause(),this._interrupted=!0)},this._onShow=()=>{this._interrupted&&this.video&&(this.video.play(),this._interrupted=!1)},n.game.on(n.Game.EVENT_HIDE,this._onHide),n.game.on(n.Game.EVENT_SHOW,this._onShow)}get fullScreenOnAwake(){return this._fullScreenOnAwake}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get video(){return this._video}get state(){return this._state}get isPlaying(){return this._playing}get UICamera(){return Mw.root.batcher2D.getFirstRenderCamera(this._node)}onLoadedMetadata(t){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(Q9.META_LOADED);const e=t.target;this._keepAspectRatio&&e&&this.syncUITransform(e.videoWidth,e.videoHeight),this.delayedFullScreen(),this.delayedPlay()}onCanPlay(t){this._loaded=!0,this.dispatchEvent(Q9.READY_TO_PLAY)}onPlay(t){this._playing=!0,this.dispatchEvent(Q9.PLAYING)}onPlaying(t){this.dispatchEvent(Q9.PLAYING)}onPause(t){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(Q9.PAUSED))}onStoped(t){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(Q9.STOPPED)}onEnded(t){this.dispatchEvent(Q9.COMPLETED)}onClick(t){this.dispatchEvent(Q9.CLICKED)}onError(t){this.dispatchEvent(Q9.ERROR);const e=t.target;e&&e.error&&p(`Error ${e.error.code}; details: ${e.error.message}`)}play(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0}delayedPlay(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)}syncFullScreenOnAwake(t){this._fullScreenOnAwake=t,this._loadedMeta||this._loaded?this.canFullScreen(t):this._waitingFullscreen=!0}delayedFullScreen(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)}dispatchEvent(t){const e=this._componentEventList.get(t);e&&(this._state=t,e.call(this))}syncUITransform(t,e){this._uiTrans&&(this._uiTrans.width=t,this._uiTrans.height=e)}syncCurrentTime(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)}destroy(){this.removeVideoPlayer(),this._componentEventList.clear(),n.game.off(n.Game.EVENT_HIDE,this._onHide),n.game.off(n.Game.EVENT_SHOW,this._onShow)}}n.internal.VideoPlayerImpl=ett;const itt=Qi();class ntt extends ett{constructor(t){super(t),this._eventList=new Map,this._clearColorA=-1,this._clearFlag=void 0}addListener(t,e){this._video&&(this._eventList.set(t,e),this._video.addEventListener(t,e))}removeAllListeners(){this._eventList.forEach(((t,e)=>{this._video&&this._video.removeEventListener(e,t)})),this._eventList.clear()}canPlay(){if(this.video){const t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((()=>{})).then((()=>{this.syncCurrentTime()}))}}pause(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)}resume(){this.play()}stop(){this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((()=>{this._ignorePause=!1,this.dispatchEvent(Q9.STOPPED)}),0))}syncClip(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t.nativeUrl)}syncURL(t){this.removeVideoPlayer(),t&&this.createVideoPlayer(t)}syncPlaybackRate(t){yn.browserType!==O.UC?this.video&&(this.video.playbackRate=t):m("playbackRate is not supported by the uc mobile browser.")}syncVolume(t){this.video&&(this.video.volume=t)}syncMute(t){this.video&&(this.video.muted=t)}syncLoop(t){this.video&&(this.video.loop=t)}getDuration(){return this.video?this.video.duration:0}getCurrentTime(){return this.video?this.video.currentTime:-1}seekTo(t){this.video&&(this.video.currentTime=t)}canFullScreen(t){const e=this._video;if(e&&e.readyState===ttt.HAVE_ENOUGH_DATA)return yn.os===L.IOS&&yn.isBrowser?(t?e.webkitEnterFullscreen&&e.webkitEnterFullscreen():e.webkitExitFullscreen&&e.webkitExitFullscreen(),void(this._fullScreenOnAwake=e.webkitDisplayingFullscreen)):mw.supportsFullScreen?void(t?(yn.browserType===O.IE&&(e.style.transform=""),e.setAttribute("x5-video-player-fullscreen","true"),mw.requestFullScreen(e,(t=>{const i=yn.browserType===O.IE?t.msFullscreenElement:t.fullscreenElement;this._fullScreenOnAwake=i===e}),(()=>{this._fullScreenOnAwake=!1}))):(e.removeAttribute("x5-video-player-fullscreen"),mw.exitFullScreen())):(this._fullScreenOnAwake=t,this._forceUpdate=!0,void this.syncMatrix())}syncStayOnBottom(t){this._video&&(this._video.style["z-index"]=t?-32768:0,this._stayOnBottom=t),this._dirty=!0}syncKeepAspectRatio(t){this._keepAspectRatio=t,t&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)}removeVideoPlayer(){const t=this._video;t&&qt(_w.container,t)&&(_w.container.removeChild(t),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null}createVideoPlayer(t){const e=this._video=document.createElement("video");e.className="cocosVideo",e.style.visibility="hidden",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style["transform-origin"]="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",e.setAttribute("preload","auto"),e.setAttribute("webkit-playsinline",""),e.setAttribute("x5-playsinline",""),e.setAttribute("playsinline",""),this._bindDomEvent(),_w.container.appendChild(e);const i=document.createElement("source");e.appendChild(i),i.src=t}_bindDomEvent(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))}onCanPlay(t){const e=t.target;if(!this._loaded||!e)switch(e.readyState){case ttt.HAVE_METADATA:case ttt.HAVE_ENOUGH_DATA:super.onCanPlay(t)}}enable(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}}disable(t){if(this._video){if(!t&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}}syncMatrix(){if(!this._video||!this._visible||!this._component)return;const t=this.UICamera;if(!t)return;if(mw.fullScreen())return;this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=t.clearColor.w,this._clearFlag=t.clearFlag,t.clearColor.w=0,t.clearFlag=mr.ALL):this._clearFlag&&(t.clearColor.w=this._clearColorA,t.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(itt),t.update(!0),t.worldMatrixToScreen(itt,itt,_w.canvas.width,_w.canvas.height);let e=0,i=0;if(this._fullScreenOnAwake?(e=uw.width,i=uw.height):(e=this._uiTrans.contentSize.width,i=this._uiTrans.contentSize.height),!this._forceUpdate&&this._m00===itt.m00&&this._m01===itt.m01&&this._m04===itt.m04&&this._m05===itt.m05&&this._m12===itt.m12&&this._m13===itt.m13&&this._w===e&&this._h===i)return;this._m00=itt.m00,this._m01=itt.m01,this._m04=itt.m04,this._m05=itt.m05,this._m12=itt.m12,this._m13=itt.m13,this._w=e,this._h=i;const n=vw.getDevicePixelRatio(),s=1/n,r=1/n,o=_w.container,a=itt.m00*s,l=itt.m01,c=itt.m04,h=itt.m05*r;this._video.style.width=`${this._w}px`,this._video.style.height=`${this._h}px`,yn.browserType!==O.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":m("keepAspectRatio is not supported by the qq mobile browser.");const _=this._w*s,u=this._h*r,{x:p,y:d}=this._uiTrans.anchorPoint,f=_*itt.m00*p,g=u*itt.m05*d,y=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,v=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,x=`matrix(${a},${-l},${-c},${h},${itt.m12*s-f+y},${-(itt.m13*r-g+v)})`;this._video.style.transform=x,this._video.style["-webkit-transform"]=x,yn.browserType!==O.IE&&(this._forceUpdate=!1)}}class stt{static getImpl(t){return new ntt(t)}}var rtt,ott,att,ltt,ctt,htt,_tt,utt,mtt,ptt,dtt,ftt,gtt,ytt,vtt,xtt,btt,Stt,Att,Ctt,Ttt,wtt,Ett,Ptt,Dtt,Itt,Rtt,Mtt,Ott,Btt,Ntt,Ltt,Ftt,ztt,Vtt,Utt,Gtt,ktt,Htt;n.internal.VideoPlayerImplManager=stt;let jtt,Wtt=t("VideoPlayer",(rtt=Vl("cc.VideoPlayer"),ott=ec(),att=Jl(),ltt=Ul(NL),ctt=yc(K9),htt=yc(Z9),_tt=rc(),utt=rc(),mtt=yc(K9),ptt=rc(),dtt=rc(),ftt=oc(),gtt=rc(),ytt=oc(),vtt=rc(),xtt=rc(),btt=rc(),Stt=rc(),Att=rc(),Ctt=rc(),Ttt=yc([rP]),wtt=_c(),Ett=rc(),rtt(Ptt=ott(Ptt=att(Ptt=ltt(Ptt=$l((Htt=ktt=class extends Rh{constructor(...t){super(...t),Tl(this,"_resourceType",Itt,this),Tl(this,"_remoteURL",Rtt,this),Tl(this,"_clip",Mtt,this),Tl(this,"_playOnAwake",Ott,this),Tl(this,"_volume",Btt,this),Tl(this,"_mute",Ntt,this),Tl(this,"_playbackRate",Ltt,this),Tl(this,"_loop",Ftt,this),Tl(this,"_fullScreenOnAwake",ztt,this),Tl(this,"_stayOnBottom",Vtt,this),Tl(this,"_keepAspectRatio",Utt,this),this._impl=null,this._cachedCurrentTime=0,Tl(this,"videoPlayerEvent",Gtt,this)}get resourceType(){return this._resourceType}set resourceType(t){this._resourceType!==t&&(this._resourceType=t,this.syncSource())}get remoteURL(){return this._remoteURL}set remoteURL(t){this._remoteURL!==t&&(this._remoteURL=t,this.syncSource())}get clip(){return this._clip}set clip(t){this._clip!==t&&(this._clip=t,this.syncSource())}get playOnAwake(){return this._playOnAwake}set playOnAwake(t){this._playOnAwake=t}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._impl&&this._impl.syncPlaybackRate(t)}get volume(){return this._volume}set volume(t){this._volume=t,this._impl&&this._impl.syncVolume(t)}get mute(){return this._mute}set mute(t){this._mute=t,this._impl&&this._impl.syncMute(t)}get loop(){return this._loop}set loop(t){this._loop=t,this._impl&&this._impl.syncLoop(t)}get keepAspectRatio(){return this._keepAspectRatio}set keepAspectRatio(t){this._keepAspectRatio!==t&&(this._keepAspectRatio=t,this._impl&&this._impl.syncKeepAspectRatio(t))}get fullScreenOnAwake(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake}set fullScreenOnAwake(t){this._fullScreenOnAwake!==t&&(this._fullScreenOnAwake=t,this._impl&&this._impl.syncFullScreenOnAwake(t))}get stayOnBottom(){return this._stayOnBottom}set stayOnBottom(t){this._stayOnBottom!==t&&(this._stayOnBottom=t,this._impl&&this._impl.syncStayOnBottom(t))}get nativeVideo(){return this._impl&&this._impl.video||null}get currentTime(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime}set currentTime(t){Number.isNaN(t)?m(`illegal video time! value:${t}`):(t=ui(t,0,this.duration),this._cachedCurrentTime=t,this._impl&&this._impl.seekTo(t))}get duration(){return this._impl?this._impl.getDuration():0}get state(){return this._impl?this._impl.state:Q9.NONE}get isPlaying(){return!!this._impl&&this._impl.isPlaying}syncSource(){this._impl&&(this._resourceType===Z9.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))}__preload(){this._impl=stt.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(Q9.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(Q9.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(Q9.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(Q9.PAUSED,this.onPasued.bind(this)),this._impl.componentEventList.set(Q9.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(Q9.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(Q9.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}onMetaLoaded(){rP.emitEvents(this.videoPlayerEvent,this,Q9.META_LOADED),this.node.emit("meta-loaded",this)}onReadyToPlay(){this._playOnAwake&&!this.isPlaying&&this.play(),rP.emitEvents(this.videoPlayerEvent,this,Q9.READY_TO_PLAY),this.node.emit(Q9.READY_TO_PLAY,this)}onPlaying(){rP.emitEvents(this.videoPlayerEvent,this,Q9.PLAYING),this.node.emit(Q9.PLAYING,this)}onPasued(){rP.emitEvents(this.videoPlayerEvent,this,Q9.PAUSED),this.node.emit(Q9.PAUSED,this)}onStopped(){rP.emitEvents(this.videoPlayerEvent,this,Q9.STOPPED),this.node.emit(Q9.STOPPED,this)}onCompleted(){rP.emitEvents(this.videoPlayerEvent,this,Q9.COMPLETED),this.node.emit(Q9.COMPLETED,this)}onError(){rP.emitEvents(this.videoPlayerEvent,this,Q9.ERROR),this.node.emit(Q9.ERROR,this)}play(){this._impl&&this._impl.play()}resume(){this._impl&&this._impl.resume()}pause(){this._impl&&this._impl.pause()}stop(){this._impl&&this._impl.stop()}},ktt.EventType=Q9,ktt.ResourceType=Z9,Itt=wl((Dtt=Htt).prototype,"_resourceType",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Z9.LOCAL}}),Rtt=wl(Dtt.prototype,"_remoteURL",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mtt=wl(Dtt.prototype,"_clip",[ctt,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ott=wl(Dtt.prototype,"_playOnAwake",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Btt=wl(Dtt.prototype,"_volume",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ntt=wl(Dtt.prototype,"_mute",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ltt=wl(Dtt.prototype,"_playbackRate",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ftt=wl(Dtt.prototype,"_loop",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ztt=wl(Dtt.prototype,"_fullScreenOnAwake",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vtt=wl(Dtt.prototype,"_stayOnBottom",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Utt=wl(Dtt.prototype,"_keepAspectRatio",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(Dtt.prototype,"resourceType",[htt,_tt],Object.getOwnPropertyDescriptor(Dtt.prototype,"resourceType"),Dtt.prototype),wl(Dtt.prototype,"remoteURL",[utt],Object.getOwnPropertyDescriptor(Dtt.prototype,"remoteURL"),Dtt.prototype),wl(Dtt.prototype,"clip",[mtt,ptt],Object.getOwnPropertyDescriptor(Dtt.prototype,"clip"),Dtt.prototype),wl(Dtt.prototype,"playOnAwake",[dtt],Object.getOwnPropertyDescriptor(Dtt.prototype,"playOnAwake"),Dtt.prototype),wl(Dtt.prototype,"playbackRate",[hc,ftt,gtt],Object.getOwnPropertyDescriptor(Dtt.prototype,"playbackRate"),Dtt.prototype),wl(Dtt.prototype,"volume",[hc,ytt,vtt],Object.getOwnPropertyDescriptor(Dtt.prototype,"volume"),Dtt.prototype),wl(Dtt.prototype,"mute",[xtt],Object.getOwnPropertyDescriptor(Dtt.prototype,"mute"),Dtt.prototype),wl(Dtt.prototype,"loop",[btt],Object.getOwnPropertyDescriptor(Dtt.prototype,"loop"),Dtt.prototype),wl(Dtt.prototype,"keepAspectRatio",[Stt],Object.getOwnPropertyDescriptor(Dtt.prototype,"keepAspectRatio"),Dtt.prototype),wl(Dtt.prototype,"fullScreenOnAwake",[Att],Object.getOwnPropertyDescriptor(Dtt.prototype,"fullScreenOnAwake"),Dtt.prototype),wl(Dtt.prototype,"stayOnBottom",[Ctt],Object.getOwnPropertyDescriptor(Dtt.prototype,"stayOnBottom"),Dtt.prototype),Gtt=wl(Dtt.prototype,"videoPlayerEvent",[Wl,Ttt,wtt,Ett],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ptt=Dtt))||Ptt)||Ptt)||Ptt)||Ptt)||Ptt));n.internal.VideoPlayer=Wtt,function(t){t.NONE="none",t.LOADING="loading",t.LOADED="loaded",t.ERROR="error"}(jtt||(jtt={}));class qtt{constructor(t){this._componentEventList=new Map,this._state=jtt.NONE,this._warpper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=t,this._node=t.node,this._uiTrans=t.node.getComponent(NL),this.reset(),this.createWebView()}reset(){this._warpper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=jtt.NONE,this._forceUpdate=!1}get loaded(){return this._loaded}get componentEventList(){return this._componentEventList}get webview(){return this._webview}get state(){return this._state}get UICamera(){return Mw.root.batcher2D.getFirstRenderCamera(this._node)}dispatchEvent(t,...e){const i=this._componentEventList.get(t);i&&(this._state=t,i.call(this,e))}destroy(){this.removeWebView(),this._warpper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()}}n.internal.WebViewImpl=qtt;const Xtt=Qi();class Ytt extends qtt{constructor(t){super(t)}_bindDomEvent(){this.webview&&this.webview.addEventListener("load",(t=>{this._forceUpdate=!0,this.dispatchEvent(jtt.LOADED);const e=t.target,i=e.contentDocument&&e.contentDocument.body;i&&i.innerHTML.includes("404")&&this.dispatchEvent(jtt.ERROR,i.innerHTML)}))}loadURL(t){this.webview&&(this.webview.src=t,this.dispatchEvent(jtt.LOADING))}createWebView(){const t=document.createElement("div");this._warpper=t,t.id="webview-wrapper",t.style["-webkit-overflow"]="auto",t.style["-webkit-overflow-scrolling"]="touch",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style.transformOrigin="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",_w.container.appendChild(t);const e=document.createElement("iframe");this._webview=e,e.id="webview",e.style.border="none",e.style.width="100%",e.style.height="100%",t.appendChild(e),this._bindDomEvent()}removeWebView(){const t=this._warpper;qt(_w.container,t)&&_w.container.removeChild(t),this.reset()}enable(){this._warpper&&(this._warpper.style.visibility="visible")}disable(){this._warpper&&(this._warpper.style.visibility="hidden")}evaluateJS(t){if(this.webview){const e=this.webview.contentWindow;if(e)try{e.eval(t)}catch(t){this.dispatchEvent(jtt.ERROR,t),p(t)}}}setOnJSCallback(t){m("The platform does not support")}setJavascriptInterfaceScheme(t){m("The platform does not support")}syncMatrix(){if(!this._warpper||!this._uiTrans||!this._component||"hidden"===this._warpper.style.visibility)return;const t=this.UICamera;if(!t)return;this._component.node.getWorldMatrix(Xtt),t.update(!0),t.worldMatrixToScreen(Xtt,Xtt,_w.canvas.width,_w.canvas.height);const{width:e,height:i}=this._uiTrans.contentSize;if(!this._forceUpdate&&this._m00===Xtt.m00&&this._m01===Xtt.m01&&this._m04===Xtt.m04&&this._m05===Xtt.m05&&this._m12===Xtt.m12&&this._m13===Xtt.m13&&this._w===e&&this._h===i)return;this._m00=Xtt.m00,this._m01=Xtt.m01,this._m04=Xtt.m04,this._m05=Xtt.m05,this._m12=Xtt.m12,this._m13=Xtt.m13,this._w=e,this._h=i;const n=vw.getDevicePixelRatio(),s=1/n,r=1/n,o=_w.container,a=Xtt.m00*s,l=Xtt.m01,c=Xtt.m04,h=Xtt.m05*r;this._warpper.style.width=`${e}px`,this._warpper.style.height=`${i}px`;const _=this._w*s,u=this._h*r,m=_*Xtt.m00*this._uiTrans.anchorX,p=u*Xtt.m05*this._uiTrans.anchorY,d=o&&o.style.paddingLeft?parseInt(o.style.paddingLeft):0,f=o&&o.style.paddingBottom?parseInt(o.style.paddingBottom):0,g=`matrix(${a},${-l},${-c},${h},${Xtt.m12*s-m+d},${-(Xtt.m13*r-p+f)})`;this._warpper.style.transform=g,this._warpper.style["-webkit-transform"]=g,this._forceUpdate=!1}}class Ktt{static getImpl(t){return new Ytt(t)}}var $tt,Jtt,Ztt,Qtt,tet,eet,iet,net,set,ret,oet,aet,cet,het;n.internal.WebViewImplManager=Ktt;let _et=t("WebView",($tt=Vl("cc.WebView"),Jtt=ec(),Ztt=Jl(),Qtt=Ul(NL),tet=rc(),eet=yc([rP]),iet=_c(),net=rc(),$tt(set=Jtt(set=Ztt(set=Qtt(set=$l((het=cet=class extends Rh{constructor(...t){super(...t),Tl(this,"_url",oet,this),this._impl=null,Tl(this,"webviewEvents",aet,this)}get url(){return this._url}set url(t){this._url=t,this._impl&&this._impl.loadURL(t)}get nativeWebView(){return this._impl&&this._impl.webview||null}get state(){return this._impl?this._impl.state:jtt.NONE}setJavascriptInterfaceScheme(t){this._impl&&this._impl.setJavascriptInterfaceScheme(t)}setOnJSCallback(t){this._impl&&this._impl.setOnJSCallback(t)}evaluateJS(t){this._impl&&this._impl.evaluateJS(t)}__preload(){this._impl=Ktt.getImpl(this),this._impl.componentEventList.set(jtt.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(jtt.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(jtt.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)}onLoading(){rP.emitEvents(this.webviewEvents,this,jtt.LOADING),this.node.emit(jtt.LOADING,this)}onLoaded(){rP.emitEvents(this.webviewEvents,this,jtt.LOADED),this.node.emit(jtt.LOADED,this)}onError(...t){rP.emitEvents(this.webviewEvents,this,jtt.ERROR,t),this.node.emit(jtt.ERROR,this,t)}onEnable(){this._impl&&this._impl.enable()}onDisable(){this._impl&&this._impl.disable()}onDestroy(){this._impl&&(this._impl.destroy(),this._impl=null)}update(t){this._impl&&this._impl.syncMatrix()}},cet.EventType=jtt,oet=wl((ret=het).prototype,"_url",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),wl(ret.prototype,"url",[tet],Object.getOwnPropertyDescriptor(ret.prototype,"url"),ret.prototype),aet=wl(ret.prototype,"webviewEvents",[Wl,eet,iet,net],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),set=ret))||set)||set)||set)||set)||set));n.internal.WebView=_et;class uet{constructor(){this.originalTarget=null,this.target=null,this.tag=uet.TAG_INVALID}clone(){const t=new uet;return t.originalTarget=null,t.target=null,t.tag=this.tag,t}isDone(){return!0}startWithTarget(t){this.originalTarget=t,this.target=t}stop(){this.target=null}step(t){b(1006)}update(t){b(1007)}getTarget(){return this.target}setTarget(t){this.target=t}getOriginalTarget(){return this.originalTarget}setOriginalTarget(t){this.originalTarget=t}getTag(){return this.tag}setTag(t){this.tag=t}reverse(){return b(1008),null}retain(){}release(){}}uet.TAG_INVALID=-1;class met extends uet{constructor(...t){super(...t),this._duration=0,this._timesForRepeat=1}getDuration(){return this._duration*(this._timesForRepeat||1)}setDuration(t){this._duration=t}clone(){return new met}}let pet,det,fet,get,yet,vet,xet,bet=0;class Aet{constructor(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1}}class Cet{constructor(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}_searchElementByTarget(t,e){for(let i=0;i<t.length;i++)if(e===t[i].target)return t[i];return null}_getElement(t,e){let i=this._elementPool.pop();return i||(i=new Aet),i.target=t,i.paused=!!e,i}_putElement(t){t.actions.length=0,t.actionIndex=0,t.currentAction=null,t.paused=!1,t.target=null,t.lock=!1,this._elementPool.push(t)}addAction(t,e,i){if(!t||!e)return void T(1e3);null==e.uuid&&(e.uuid="_TWEEN_UUID_"+bet++);let n=this._hashTargets.get(e);n?n.actions||(n.actions=[]):(n=this._getElement(e,i),this._hashTargets.set(e,n),this._arrayTargets.push(n)),n.target=e,n.actions.push(t),t.startWithTarget(e)}removeAllActions(){const t=this._arrayTargets;for(let e=0;e<t.length;e++){const i=t[e];i&&this._putElement(i)}this._arrayTargets.length=0,this._hashTargets=new Map}removeAllActionsFromTarget(t){if(null==t)return;const e=this._hashTargets.get(t);e&&(e.actions.length=0,this._deleteHashElement(e))}removeAction(t){if(null==t)return;const e=t.getOriginalTarget(),i=this._hashTargets.get(e);if(i)for(let e=0;e<i.actions.length;e++)if(i.actions[e]===t){i.actions.splice(e,1),i.actionIndex>=e&&i.actionIndex--;break}}_removeActionByTag(t,e,i){for(let n=0,s=e.actions.length;n<s;++n){const s=e.actions[n];if(s&&s.getTag()===t){if(i&&s.getOriginalTarget()!==i)continue;this._removeActionAtIndex(n,e);break}}}removeActionByTag(t,e){t===uet.TAG_INVALID&&b(1002);const i=this._hashTargets;if(e){const n=i.get(e);n&&this._removeActionByTag(t,n,e)}else i.forEach((e=>{this._removeActionByTag(t,e)}))}getActionByTag(t,e){t===uet.TAG_INVALID&&b(1004);const i=this._hashTargets.get(e);if(i){if(null!=i.actions)for(let e=0;e<i.actions.length;++e){const n=i.actions[e];if(n&&n.getTag()===t)return n}b(1005,t)}return null}getNumberOfRunningActionsInTarget(t){const e=this._hashTargets.get(t);return e&&e.actions?e.actions.length:0}pauseTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!0)}resumeTarget(t){const e=this._hashTargets.get(t);e&&(e.paused=!1)}pauseAllRunningActions(){const t=[],e=this._arrayTargets;for(let i=0;i<e.length;i++){const n=e[i];n&&!n.paused&&(n.paused=!0,t.push(n.target))}return t}resumeTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.resumeTarget(t[e])}pauseTargets(t){if(t)for(let e=0;e<t.length;e++)t[e]&&this.pauseTarget(t[e])}purgeSharedManager(){n.director.getScheduler().unscheduleUpdate(this)}_removeActionAtIndex(t,e){e.actions[t],e.actions.splice(t,1),e.actionIndex>=t&&e.actionIndex--,0===e.actions.length&&this._deleteHashElement(e)}_deleteHashElement(t){let e=!1;if(t&&!t.lock&&this._hashTargets.get(t.target)){this._hashTargets.delete(t.target);const i=this._arrayTargets;for(let e=0,n=i.length;e<n;e++)if(i[e]===t){i.splice(e,1);break}this._putElement(t),e=!0}return e}update(t){const e=this._arrayTargets;let i;for(let n=0;n<e.length;n++){this._currentTarget=e[n],i=this._currentTarget;const s=i.target;if(s instanceof Me&&!s.isValid)this.removeAllActionsFromTarget(s),n--;else{if(!i.paused&&i.actions){for(i.lock=!0,i.actionIndex=0;i.actionIndex<i.actions.length;i.actionIndex++)if(i.currentAction=i.actions[i.actionIndex],i.currentAction){if(i.currentAction.step(t*(i.currentAction._speedMethod?i.currentAction._speed:1)),i.currentAction&&i.currentAction.isDone()){i.currentAction.stop();const t=i.currentAction;i.currentAction=null,this.removeAction(t)}i.currentAction=null}i.lock=!1}0===i.actions.length&&this._deleteHashElement(i)&&n--}}}}class Tet extends Sw{constructor(...t){super(...t),this.actionMgr=new Cet}get ActionManager(){return this.actionMgr}update(t){this.actionMgr.update(t)}}t("TweenSystem",Tet),Tet.ID="TWEEN",Tet.instance=void 0,Mw.on(Rw.EVENT_INIT,(()=>{const t=new Tet;Tet.instance=t,Mw.registerSystem(Tet.ID,t,Sw.Priority.MEDIUM)}));class wet extends met{isDone(){return!0}step(t){this.update(1)}update(t){}reverse(){return this.clone()}clone(){return new wet}}class Eet extends wet{update(t){const e=this.target.getComponentsInChildren(zD);for(let t=0;t<e.length;++t)e[t].enabled=!0}reverse(){return new Pet}clone(){return new Eet}}class Pet extends wet{update(t){const e=this.target.getComponentsInChildren(zD);for(let t=0;t<e.length;++t)e[t].enabled=!1}reverse(){return new Eet}clone(){return new Pet}}class Det extends wet{constructor(t){super(),this._isNeedCleanUp=!0,void 0!==t&&this.init(t)}update(t){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()}init(t){return this._isNeedCleanUp=t,!0}reverse(){return new Det(this._isNeedCleanUp)}clone(){return new Det(this._isNeedCleanUp)}}class Iet extends wet{constructor(t,e,i){super(),this._selectorTarget=null,this._function=null,this._data=null,this.initWithFunction(t,e,i)}initWithFunction(t,e,i){return t&&(this._function=t),e&&(this._selectorTarget=e),void 0!==i&&(this._data=i),!0}execute(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)}update(t){this.execute()}getTargetCallback(){return this._selectorTarget}setTargetCallback(t){t!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=t)}clone(){const t=new Iet;return t.initWithFunction(this._function,this._selectorTarget,this._data),t}}class Ret extends met{constructor(t){super(),this.MAX_VALUE=2,this._elapsed=0,this._firstTick=!1,this._easeList=[],this._speed=1,this._repeatForever=!1,this._repeatMethod=!1,this._speedMethod=!1,void 0===t||isNaN(t)||this.initWithDuration(t)}getElapsed(){return this._elapsed}initWithDuration(t){return this._duration=0===t?Ut.FLT_EPSILON:t,this._elapsed=0,this._firstTick=!0,!0}isDone(){return this._elapsed>=this._duration}_cloneDecoration(t){t._repeatForever=this._repeatForever,t._speed=this._speed,t._timesForRepeat=this._timesForRepeat,t._easeList=this._easeList,t._speedMethod=this._speedMethod,t._repeatMethod=this._repeatMethod}_reverseEaseList(t){if(this._easeList){t._easeList=[];for(let e=0;e<this._easeList.length;e++)t._easeList.push(this._easeList[e])}}clone(){const t=new Ret(this._duration);return this._cloneDecoration(t),t}easing(t){this._easeList?this._easeList.length=0:this._easeList=[];for(let t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this}_computeEaseTime(t){return t}step(t){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=t;let e=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);e=e<1?e:1,this.update(e>0?e:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))}startWithTarget(t){uet.prototype.startWithTarget.call(this,t),this._elapsed=0,this._firstTick=!0}reverse(){return b(1010),this}setAmplitudeRate(t){b(1011)}getAmplitudeRate(){return b(1012),0}speed(t){return t<=0?(b(1013),this):(this._speedMethod=!0,this._speed*=t,this)}getSpeed(){return this._speed}setSpeed(t){return this._speed=t,this}repeat(t){return t=Math.round(t),isNaN(t)||t<1?(b(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=t,this)}repeatForever(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this}}class Met extends Ret{constructor(t){super(),this._actions=[],this._split=0,this._last=0,this._reversed=!1;const e=t instanceof Array?t:arguments;if(1===e.length)return void T(1019);const i=e.length-1;if(i>=0&&null==e[i]&&b(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=Met._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return T(1025),!1;let i=t._duration,n=e._duration;i*=t._repeatMethod?t._timesForRepeat:1,n*=e._repeatMethod?e._timesForRepeat:1;const s=i+n;return this.initWithDuration(s),this._actions[0]=t,this._actions[1]=e,!0}clone(){const t=new Met;return this._cloneDecoration(t),t.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),t}startWithTarget(t){Ret.prototype.startWithTarget.call(this,t),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1}stop(){-1!==this._last&&this._actions[this._last].stop(),uet.prototype.stop.call(this)}update(t){let e,i=0;const n=this._split,s=this._actions,r=this._last;let o;(t=this._computeEaseTime(t))<n?(e=0!==n?t/n:1,0===i&&1===r&&this._reversed&&(s[1].update(0),s[1].stop())):(i=1,e=1===n?1:(t-n)/(1-n),-1===r&&(s[0].startWithTarget(this.target),s[0].update(1),s[0].stop()),0===r&&(s[0].update(1),s[0].stop())),o=s[i],r===i&&o.isDone()||(r!==i&&o.startWithTarget(this.target),e*=o._timesForRepeat,o.update(e>1?e%1:e),this._last=i)}reverse(){const t=Met._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t._reversed=!0,t}}function Oet(t){const e=t instanceof Array?t:arguments;if(1===e.length)return T(1019),null;const i=e.length-1;i>=0&&null==e[i]&&b(1015);let n=null;if(i>=0){n=e[0];for(let t=1;t<=i;t++)e[t]&&(n=Met._actionOneTwo(n,e[t]))}return n}Met._actionOneTwo=function(t,e){const i=new Met;return i.initWithTwoActions(t,e),i};class Bet extends Ret{constructor(t,e){super(),this._times=0,this._total=0,this._nextDt=0,this._actionInstant=!1,this._innerAction=null,void 0!==e&&this.initWithAction(t,e)}initWithAction(t,e){const i=t._duration*e;return!!this.initWithDuration(i)&&(this._times=e,this._innerAction=t,t instanceof wet&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)}clone(){const t=new Bet;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone(),this._times),t}startWithTarget(t){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Ret.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}stop(){this._innerAction.stop(),uet.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t);const e=this._innerAction,i=this._duration,n=this._times;let s=this._nextDt;if(t>=s){for(;t>s&&this._total<n;)e.update(1),this._total++,e.stop(),e.startWithTarget(this.target),s+=e._duration/i,this._nextDt=s>1?1:s;t>=1&&this._total<n&&(e.update(1),this._total++),this._actionInstant||(this._total===n?e.stop():e.update(t-(s-e._duration/i)))}else e.update(t*n%1)}isDone(){return this._total===this._times}reverse(){const t=new Bet(this._innerAction.reverse(),this._times);return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class Net extends Ret{constructor(t){super(),this._innerAction=null,t&&this.initWithAction(t)}initWithAction(t){return t?(this._innerAction=t,!0):(T(1026),!1)}clone(){const t=new Net;return this._cloneDecoration(t),t.initWithAction(this._innerAction.clone()),t}startWithTarget(t){Ret.prototype.startWithTarget.call(this,t),this._innerAction.startWithTarget(t)}step(t){const e=this._innerAction;e.step(t),e.isDone()&&(e.startWithTarget(this.target),e.step(e.getElapsed()-e._duration))}isDone(){return!1}reverse(){const t=new Net(this._innerAction.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}setInnerAction(t){this._innerAction!==t&&(this._innerAction=t)}getInnerAction(){return this._innerAction}}class Let extends Ret{constructor(t){super(),this._one=null,this._two=null;const e=t instanceof Array?t:arguments;if(1===e.length)return void T(1020);const i=e.length-1;if(i>=0&&null==e[i]&&b(1015),i>=0){let t,n=e[0];for(let s=1;s<i;s++)e[s]&&(t=n,n=Let._actionOneTwo(t,e[s]));this.initWithTwoActions(n,e[i])}}initWithTwoActions(t,e){if(!t||!e)return T(1027),!1;let i=!1;const n=t._duration,s=e._duration;return this.initWithDuration(Math.max(n,s))&&(this._one=t,this._two=e,n>s?this._two=Met._actionOneTwo(e,Vet(n-s)):n<s&&(this._one=Met._actionOneTwo(t,Vet(s-n))),i=!0),i}clone(){const t=new Let;return this._cloneDecoration(t),t.initWithTwoActions(this._one.clone(),this._two.clone()),t}startWithTarget(t){Ret.prototype.startWithTarget.call(this,t),this._one.startWithTarget(t),this._two.startWithTarget(t)}stop(){this._one.stop(),this._two.stop(),uet.prototype.stop.call(this)}update(t){t=this._computeEaseTime(t),this._one&&this._one.update(t),this._two&&this._two.update(t)}reverse(){const t=Let._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(t),this._reverseEaseList(t),t}}function Fet(t){const e=t instanceof Array?t:arguments;if(1===e.length)return T(1020),null;e.length>0&&null==e[e.length-1]&&b(1015);let i=e[0];for(let t=1;t<e.length;t++)null!=e[t]&&(i=Let._actionOneTwo(i,e[t]));return i}Let._actionOneTwo=function(t,e){const i=new Let;return i.initWithTwoActions(t,e),i};class zet extends Ret{update(t){}reverse(){const t=new zet(this._duration);return this._cloneDecoration(t),this._reverseEaseList(t),t}clone(){const t=new zet;return this._cloneDecoration(t),t.initWithDuration(this._duration),t}}function Vet(t){return new zet(t)}class Uet extends Ret{constructor(t){super(),this._other=null,t&&this.initWithAction(t)}initWithAction(t){return t?t===this._other?(T(1029),!1):!!Ret.prototype.initWithDuration.call(this,t._duration)&&(this._other=t,!0):(T(1028),!1)}clone(){const t=new Uet;return this._cloneDecoration(t),t.initWithAction(this._other.clone()),t}startWithTarget(t){Ret.prototype.startWithTarget.call(this,t),this._other.startWithTarget(t)}update(t){t=this._computeEaseTime(t),this._other&&this._other.update(1-t)}reverse(){return this._other.clone()}stop(){this._other.stop(),uet.prototype.stop.call(this)}}class Get extends Ret{constructor(t,e,i){if(super(),this._opts=void 0,this._props=void 0,this._originProps=void 0,null==i)i=Object.create(null);else if(function(t){const e=" [Tween:] ",i=` option is not support in v + ${s}`,n=t;n.delay&&m(`${e}delay${i}`),n.repeat&&m(`${e}repeat${i}`),n.repeatDelay&&m(`${e}repeatDelay${i}`),n.interpolation&&m(`${e}interpolation${i}`),n.onStop&&m(`${e}onStop${i}`)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(t){const e=t.charAt(0);if(/[A-Z]/.test(e)){const i=(t=t.replace(e,e.toLowerCase())).split("-");if(2===i.length){const e=i[0];if("linear"===e)t="linear";else{const n=i[1];switch(e){case"quadratic":t=`quad${n}`;break;case"quartic":t=`quart${n}`;break;case"quintic":t=`quint${n}`;break;case"sinusoidal":t=`sine${n}`;break;case"exponential":t=`expo${n}`;break;case"circular":t=`circ${n}`;break;default:t=e+n}}}}return t}(i.easing)),i.progress||(i.progress=this.progress),i.easing&&"string"==typeof i.easing){const t=i.easing;i.easing=Cu[t],i.easing||A(1031,t)}this._opts=i,this._props=Object.create(null);for(const t in e){if(!e.hasOwnProperty(t))continue;let i,n,s=e[t];if("function"==typeof s&&(s=s()),null==s||"string"==typeof s)continue;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(i=Cu[s.easing],i||A(1031,s.easing)):i=s.easing,n=s.progress,s=s.value);const r=Object.create(null);r.value=s,r.easing=i,r.progress=n,this._props[t]=r}this._originProps=e,this.initWithDuration(t)}clone(){const t=new Get(this._duration,this._originProps,this._opts);return this._cloneDecoration(t),t}startWithTarget(t){Ret.prototype.startWithTarget.call(this,t);const e=!!this._opts.relative,i=this._props;for(const n in i){const s=t[n];if(void 0===s)continue;const r=i[n],o=r.value;if("number"==typeof s)r.start=s,r.current=s,r.end=e?s+o:o;else if("object"==typeof s){null==r.start&&(r.start={},r.current={},r.end={});for(const t in o)isNaN(s[t])||(r.start[t]=s[t],r.current[t]=s[t],r.end[t]=e?s[t]+o[t]:o[t])}}this._opts.onStart&&this._opts.onStart(this.target)}update(t){const e=this.target;if(!e)return;const i=this._props,n=this._opts;let s=t;n.easing&&(s=n.easing(t));const r=n.progress;for(const n in i){const o=i[n],a=o.easing?o.easing(t):s,l=o.progress?o.progress:r,c=o.start,h=o.end;if("number"==typeof c)o.current=l(c,h,o.current,a);else if("object"==typeof c)for(const t in c)o.current[t]=l(c[t],h[t],o.current[t],a);e[n]=o.current}n.onUpdate&&n.onUpdate(this.target,t),1===t&&n.onComplete&&n.onComplete(this.target)}progress(t,e,i,n){return t+(e-t)*n}}class ket extends wet{constructor(t){super(),this._props=void 0,this._props={},void 0!==t&&this.init(t)}init(t){for(const e in t)this._props[e]=t[e];return!0}update(){const t=this._props,e=this.target;for(const i in t)e[i]=t[i]}clone(){const t=new ket;return t.init(this._props),t}}class Het{constructor(t){this._actions=[],this._finalAction=null,this._target=null,this._tag=uet.TAG_INVALID,this._target=void 0===t?null:t}tag(t){return this._tag=t,this}then(t){return t instanceof uet?this._actions.push(t.clone()):this._actions.push(t._union()),this}target(t){return this._target=t,this}start(){return this._target?(this._finalAction&&Tet.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),Tet.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(m("Please set target to tween first"),this)}stop(){return this._finalAction&&Tet.instance.ActionManager.removeAction(this._finalAction),this}clone(t){const e=this._union();return jet(t).then(e.clone())}union(){const t=this._union();return this._actions.length=0,this._actions.push(t),this}to(t,e,i){(i=i||Object.create(null)).relative=!1;const n=new Get(t,e,i);return this._actions.push(n),this}by(t,e,i){(i=i||Object.create(null)).relative=!0;const n=new Get(t,e,i);return this._actions.push(n),this}set(t){const e=new ket(t);return this._actions.push(e),this}delay(t){const e=Vet(t);return this._actions.push(e),this}call(t){const e=new Iet(t,undefined,undefined);return this._actions.push(e),this}sequence(...t){const e=Het._wrappedSequence(...t);return this._actions.push(e),this}parallel(...t){const e=Het._wrappedParallel(...t);return this._actions.push(e),this}repeat(t,e){if(t==1/0)return this.repeatForever(e);const i=this._actions;let n;return n=e instanceof Het?e._union():i.pop(),i.push(function(t,e){return new Bet(t,e)}(n,t)),this}repeatForever(t){const e=this._actions;let i;return i=t instanceof Het?t._union():e.pop(),e.push(function(t){return new Net(t)}(i)),this}reverseTime(t){const e=this._actions;let i;return i=t instanceof Het?t._union():e.pop(),e.push(function(t){return new Uet(t)}(i)),this}hide(){const t=new Pet;return this._actions.push(t),this}show(){const t=new Eet;return this._actions.push(t),this}removeSelf(){const t=new Det(!1);return this._actions.push(t),this}static stopAll(){Tet.instance.ActionManager.removeAllActions()}static stopAllByTag(t,e){Tet.instance.ActionManager.removeActionByTag(t,e)}static stopAllByTarget(t){Tet.instance.ActionManager.removeAllActionsFromTarget(t)}_union(){const t=this._actions;let e;return e=1===t.length?t[0]:Oet(t),e}_destroy(){this.stop()}static _wrappedSequence(...t){const e=Het._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof Het&&(e[n]=i._union())}return Oet.apply(Oet,e)}static _wrappedParallel(...t){const e=Het._tmp_args;e.length=0;for(let i=t.length,n=0;n<i;n++){const i=e[n]=t[n];i instanceof Het&&(e[n]=i._union())}return Fet.apply(Fet,e)}}function jet(t){return new Het(t)}function Wet(t){return m("tweenUtil' is deprecated, please use 'tween' instead "),new Het(t)}t("Tween",Het),Het._tmp_args=[],n.Tween=Het,n.tween=jet,n.tweenUtil=Wet,function(t){t[t.ORTHO=0]="ORTHO",t[t.HEX=1]="HEX",t[t.ISO=2]="ISO"}(pet||(pet={})),zt(pet),function(t){t[t.NONE=0]="NONE",t[t.MAP=1]="MAP",t[t.LAYER=2]="LAYER",t[t.OBJECTGROUP=3]="OBJECTGROUP",t[t.OBJECT=4]="OBJECT",t[t.TILE=5]="TILE"}(det||(det={})),zt(det),function(t){t[t.HORIZONTAL=2147483648]="HORIZONTAL",t[t.VERTICAL=1073741824]="VERTICAL",t[t.DIAGONAL=536870912]="DIAGONAL",t[t.FLIPPED_ALL=4026531840]="FLIPPED_ALL",t[t.FLIPPED_MASK=268435455]="FLIPPED_MASK"}(fet||(fet={})),zt(fet),function(t){t[t.STAGGERAXIS_X=0]="STAGGERAXIS_X",t[t.STAGGERAXIS_Y=1]="STAGGERAXIS_Y"}(get||(get={})),zt(get),function(t){t[t.STAGGERINDEX_ODD=0]="STAGGERINDEX_ODD",t[t.STAGGERINDEX_EVEN=1]="STAGGERINDEX_EVEN"}(yet||(yet={})),zt(yet),function(t){t[t.RightDown=0]="RightDown",t[t.RightUp=1]="RightUp",t[t.LeftDown=2]="LeftDown",t[t.LeftUp=3]="LeftUp"}(vet||(vet={})),zt(vet),function(t){t[t.RECT=0]="RECT",t[t.ELLIPSE=1]="ELLIPSE",t[t.POLYGON=2]="POLYGON",t[t.POLYLINE=3]="POLYLINE",t[t.IMAGE=4]="IMAGE",t[t.TEXT=5]="TEXT"}(xet||(xet={})),zt(xet);class qet{constructor(){this.name="",this.firstGid=0,this.spacing=0,this.margin=0,this.sourceImage=void 0,this.imageName=null,this.imageSize=new ln(0,0),this.tileOffset=new tn(0,0),this._tileSize=new ln(0,0),this.collection=!1}rectForGID(t,e){const i=e||new hn(0,0,0,0);i.width=this._tileSize.width,i.height=this._tileSize.height;let n=t;n&=fet.FLIPPED_MASK,n-=this.firstGid;const s=Math.floor((this.imageSize.width-2*this.margin+this.spacing)/(this._tileSize.width+this.spacing));return i.x=Math.round(n%s*(this._tileSize.width+this.spacing)+this.margin),i.y=Math.round(Math.floor(n/s)*(this._tileSize.height+this.spacing)+this.margin),i}}class Xet{constructor(){this.properties={},this.name="",this.objects=[],this.visible=!0,this.opacity=0,this.color=new Ri(255,255,255,255),this.offset=new tn(0,0),this.draworder="topdown",this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}class Yet{constructor(){this.properties={},this.name="",this.layerSize=null,this.tiles=[],this.visible=!0,this.opacity=0,this.ownTiles=!0,this.minGID=1e5,this.maxGID=0,this.offset=new tn(0,0),this.tintColor=null}getProperties(){return this.properties}setProperties(t){this.properties=t}}Yet.ATTRIB_NONE=1,Yet.ATTRIB_BASE64=2,Yet.ATTRIB_GZIP=4,Yet.ATTRIB_ZLIB=8;class Ket{constructor(){this.name="",this.visible=!0,this.width=0,this.height=0,this.offset=new tn(0,0),this.opacity=0,this.trans=new Ri(255,255,255,255),this.sourceImage=void 0,this.tintColor=null}}function $et(t){const e=fz.HorizontalAlign;switch(t){case"center":return e.CENTER;case"right":return e.RIGHT;default:return e.LEFT}}function Jet(t){const e=fz.VerticalAlign;switch(t){case"center":return e.CENTER;case"bottom":return e.BOTTOM;default:return e.TOP}}function Zet(t){if(!t)return new Ri(0,0,0,255);if(8===(t=-1!==t.indexOf("#")?t.substring(1):t).length){const e=parseInt(t.substr(0,2),16)||255,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0,s=parseInt(t.substr(6,2),16)||0;return new Ri(i,n,s,e)}{const e=parseInt(t.substr(0,2),16)||0,i=parseInt(t.substr(2,2),16)||0,n=parseInt(t.substr(4,2),16)||0;return new Ri(e,i,n,255)}}function Qet(t,e){const i=[],n=t.getElementsByTagName("properties");for(let t=0;t<n.length;++t){const e=n[t].getElementsByTagName("property");for(let t=0;t<e.length;++t)i.push(e[t])}e=e||{};for(let t=0;t<i.length;t++){const n=i[t],s=n.getAttribute("name"),r=n.getAttribute("type")||"string";let o=n.getAttribute("value");"int"===r?o=parseInt(o):"float"===r?o=parseFloat(o):"bool"===r?o="true"===o:"color"===r&&(o=Zet(o)),e[s]=o}return e}class tit{get mapSize(){return this._mapSize}get tileSize(){return this._tileSize}constructor(t,e,i,n,s){this.properties={},this.orientation=null,this.parentElement=null,this.parentGID=0,this.layerAttrs=0,this.storingCharacters=!1,this.currentString=null,this.renderOrder=vet.RightDown,this._supportVersion=[1,4,0],this._objectGroups=[],this._allChildren=[],this._mapSize=new ln(0,0),this._tileSize=new ln(0,0),this._layers=[],this._tilesets=[],this._imageLayers=[],this._tileProperties=new Map,this._tileAnimations={},this._tsxContentMap=null,this._spriteFrameMap=null,this._spfSizeMap={},this._staggerAxis=null,this._staggerIndex=null,this._hexSideLength=0,this._imageLayerSPF=null,this.initWithXML(t,e,i,n,s)}getOrientation(){return this.orientation}setOrientation(t){this.orientation=t}getStaggerAxis(){return this._staggerAxis}setStaggerAxis(t){this._staggerAxis=t}getStaggerIndex(){return this._staggerIndex}setStaggerIndex(t){this._staggerIndex=t}getHexSideLength(){return this._hexSideLength}setHexSideLength(t){this._hexSideLength=t}getMapSize(){return new ln(this._mapSize.width,this._mapSize.height)}setMapSize(t){this._mapSize.width=t.width,this._mapSize.height=t.height}get mapWidth(){return this._mapSize.width}set mapWidth(t){this._mapSize.width=t}get mapHeight(){return this._mapSize.height}set mapHeight(t){this._mapSize.height=t}getTileSize(){return new ln(this._tileSize.width,this._tileSize.height)}setTileSize(t){this._tileSize.width=t.width,this._tileSize.height=t.height}get tileWidth(){return this._tileSize.width}set tileWidth(t){this._tileSize.width=t}get tileHeight(){return this._tileSize.height}set tileHeight(t){this._tileSize.height=t}getLayers(){return this._layers}setLayers(t){this._allChildren.push(t),this._layers.push(t)}getImageLayers(){return this._imageLayers}setImageLayers(t){this._allChildren.push(t),this._imageLayers.push(t)}getTilesets(){return this._tilesets}setTilesets(t){this._tilesets.push(t)}getObjectGroups(){return this._objectGroups}setObjectGroups(t){this._allChildren.push(t),this._objectGroups.push(t)}getAllChildren(){return this._allChildren}getParentElement(){return this.parentElement}setParentElement(t){this.parentElement=t}getParentGID(){return this.parentGID}setParentGID(t){this.parentGID=t}getLayerAttribs(){return this.layerAttrs}setLayerAttribs(t){this.layerAttrs=t}getStoringCharacters(){return this.storingCharacters}setStoringCharacters(t){this.storingCharacters=t}getProperties(){return this.properties}setProperties(t){this.properties=t}initWithXML(t,e,i,n,s){return this._tilesets.length=0,this._layers.length=0,this._imageLayers.length=0,this._tsxContentMap=e,this._spriteFrameMap=i,this._imageLayerSPF=s,this._spfSizeMap=n,this._objectGroups.length=0,this._allChildren.length=0,this.properties={},this._tileProperties=new Map,this._tileAnimations=new Map,this.currentString="",this.storingCharacters=!1,this.layerAttrs=Yet.ATTRIB_NONE,this.parentElement=null,this.parseXMLString(t)}parseXMLString(t,e){let i;const n=(new CE).parse(t).documentElement,s=n.getAttribute("orientation"),r=n.getAttribute("staggeraxis"),o=n.getAttribute("staggerindex"),a=n.getAttribute("hexsidelength"),l=n.getAttribute("renderorder"),c=n.getAttribute("version")||"1.0.0";if("map"===n.nodeName){const t=c.split("."),e=this._supportVersion;for(i=0;i<e.length;i++){const n=parseInt(t[i])||0;if(e[i]<n){b(7216,c);break}}"orthogonal"===s?this.orientation=pet.ORTHO:"isometric"===s?this.orientation=pet.ISO:"hexagonal"===s?this.orientation=pet.HEX:null!==s&&b(7217,s),this.renderOrder="right-up"===l?vet.RightUp:"left-up"===l?vet.LeftUp:"left-down"===l?vet.LeftDown:vet.RightDown,"x"===r?this.setStaggerAxis(get.STAGGERAXIS_X):"y"===r&&this.setStaggerAxis(get.STAGGERAXIS_Y),"odd"===o?this.setStaggerIndex(yet.STAGGERINDEX_ODD):"even"===o&&this.setStaggerIndex(yet.STAGGERINDEX_EVEN),a&&this.setHexSideLength(parseFloat(a));let h=new ln(0,0);h.width=parseFloat(n.getAttribute("width")),h.height=parseFloat(n.getAttribute("height")),this.setMapSize(h),h=new ln(0,0),h.width=parseFloat(n.getAttribute("tilewidth")),h.height=parseFloat(n.getAttribute("tileheight")),this.setTileSize(h),this.properties=Qet(n)}let h=n.getElementsByTagName("tileset");for("map"!==n.nodeName&&(h=[],h.push(n)),i=0;i<h.length;i++){const t=h[i],n=t.getAttribute("source");if(n){const e=parseInt(t.getAttribute("firstgid")),i=this._tsxContentMap[n];i&&this.parseXMLString(i,e)}else{const i=t.getElementsByTagName("image"),n=i.length>1,s=i[0];let r=s.getAttribute("source");r=r.replace(/\\/g,"/");const o=t.getElementsByTagName("tile"),a=o&&o.length||1;let l=null;const c=t.getAttribute("name")||"",h=parseInt(t.getAttribute("spacing"))||0,_=parseInt(t.getAttribute("margin"))||0,u=e||parseInt(t.getAttribute("firstgid"))||0,m=new ln(0,0);m.width=parseFloat(t.getAttribute("tilewidth")),m.height=parseFloat(t.getAttribute("tileheight"));const p=t.getElementsByTagName("tileoffset")[0];let d=0,f=0;p&&(d=parseFloat(p.getAttribute("x"))||0,f=parseFloat(p.getAttribute("y"))||0);let g=null;for(let t=0;t<a;t++){const e=i[t]?i[t]:s;if(!e)continue;let r=e.getAttribute("source");if(r=r.replace(/\\/g,"/"),!g||n){if(g=new qet,g.name=c,g.firstGid=u&fet.FLIPPED_MASK,g.tileOffset.x=d,g.tileOffset.y=f,g.collection=n,!n&&(g.imageName=r,g.imageSize.width=parseFloat(e.getAttribute("width"))||0,g.imageSize.height=parseFloat(e.getAttribute("height"))||0,g.sourceImage=this._spriteFrameMap[r],!g.sourceImage)){const t=tit.getNameWithPostfix(r);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=tit.getShortName(r);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(console.error(`[error]: ${t} not find in [${Object.keys(this._spriteFrameMap).join(", ")}]`),T(7221,r),console.warn(`Please try asset type of ${r} to 'sprite-frame'`))}}g.spacing=h,g.margin=_,g._tileSize.width=m.width,g._tileSize.height=m.height,this.setTilesets(g)}if(l=o&&o[t],!l)continue;this.parentGID=u+(parseInt(l.getAttribute("id"))||0);const a=l.getElementsByTagName("image");if(a&&a.length>0){const t=a[0];let e=t.getAttribute("source");if(e=e.replace(/\\/g,"/"),g.imageName=e,g.imageSize.width=parseFloat(t.getAttribute("width"))||0,g.imageSize.height=parseFloat(t.getAttribute("height"))||0,g._tileSize.width=g.imageSize.width,g._tileSize.height=g.imageSize.height,g.sourceImage=this._spriteFrameMap[e],!g.sourceImage){const t=tit.getNameWithPostfix(e);if(g.imageName=t,g.sourceImage=this._spriteFrameMap[t],!g.sourceImage){const t=tit.getShortName(e);g.imageName=t,g.sourceImage=this._spriteFrameMap[t],g.sourceImage||(T(7221,e),console.warn(`Please try asset type of ${e} to 'sprite-frame'`))}}g.firstGid=this.parentGID&fet.FLIPPED_MASK}const p=(fet.FLIPPED_MASK&this.parentGID)>>>0;this._tileProperties.set(p,Qet(l));const y=l.getElementsByTagName("animation");if(y&&y.length>0){const t=y[0].getElementsByTagName("frame"),e={frames:[],dt:0,frameIdx:0};this._tileAnimations.set(p,e);const i=e.frames;for(let e=0;e<t.length;e++){const n=t[e],s=u+(parseInt(n.getAttribute("tileid"))||0),r=parseFloat(n.getAttribute("duration"))||0;i.push({tileid:s,duration:r/1e3,grid:null})}}}}}const _=n.childNodes;for(i=0;i<_.length;i++){const t=_[i];if(!this._shouldIgnoreNode(t)){if("imagelayer"===t.nodeName){const e=this._parseImageLayer(t);e&&this.setImageLayers(e)}if("layer"===t.nodeName){const e=this._parseLayer(t);this.setLayers(e)}if("objectgroup"===t.nodeName){const e=this._parseObjectGroup(t);this.setObjectGroups(e)}}}return n}_shouldIgnoreNode(t){return 3===t.nodeType||8===t.nodeType||4===t.nodeType}_parseImageLayer(t){const e=t.getElementsByTagName("image");if(!e||0===e.length)return null;const i=new Ket;i.name=t.getAttribute("name"),i.offset.x=parseFloat(t.getAttribute("offsetx"))||0,i.offset.y=parseFloat(t.getAttribute("offsety"))||0;const n=t.getAttribute("visible");i.visible=!("0"===n);const s=t.getAttribute("opacity");i.opacity=s?Math.round(255*parseFloat(s)):255;const r=t.getAttribute("tintcolor");i.tintColor=r?Zet(r):null;const o=e[0],a=o.getAttribute("source");return i.sourceImage=this._imageLayerSPF[a],i.width=parseInt(o.getAttribute("width"))||0,i.height=parseInt(o.getAttribute("height"))||0,i.trans=Zet(o.getAttribute("trans")),i.sourceImage?i:(T(7221,a),console.warn(`Please try asset type of ${a} to 'sprite-frame'`),null)}_parseLayer(t){const e=t.getElementsByTagName("data")[0],i=new Yet;i.name=t.getAttribute("name");const n=new ln(0,0);n.width=parseFloat(t.getAttribute("width")),n.height=parseFloat(t.getAttribute("height")),i.layerSize=n;const s=t.getAttribute("visible");i.visible=!("0"===s);const r=t.getAttribute("opacity");i.opacity=r?Math.round(255*parseFloat(r)):255,i.offset=new tn(parseFloat(t.getAttribute("offsetx"))||0,parseFloat(t.getAttribute("offsety"))||0);const o=t.getAttribute("tintcolor");i.tintColor=o?Zet(o):null;let a="";for(let t=0;t<e.childNodes.length;t++)a+=e.childNodes[t].nodeValue;a=a.trim();const l=e.getAttribute("compression"),c=e.getAttribute("encoding");if(l&&"gzip"!==l&&"zlib"!==l)return b(7218),null;let h;switch(l){case"gzip":h=R7.unzipBase64AsArray(a,4);break;case"zlib":h=function(t){if(t.length%4!=0)return null;const e=t.length/4,i=window.Uint32Array?new Uint32Array(e):[];for(let n=0;n<e;n++){const e=4*n;i[n]=t[e]+256*t[e+1]+65536*t[e+2]+t[e+3]*(1<<24)}return i}(new B6.Inflate(R7.Base64.decodeAsArray(a,1)).decompress());break;case null:case"":if("base64"===c)h=R7.Base64.decodeAsArray(a,4);else if("csv"===c){h=[];const t=a.split(",");for(let e=0;e<t.length;e++)h.push(parseInt(t[e]))}else{const t=e.getElementsByTagName("tile");h=[];for(let e=0;e<t.length;e++)h.push(parseInt(t[e].getAttribute("gid")))}break;default:this.layerAttrs===Yet.ATTRIB_NONE&&b(7219)}return h&&(i.tiles=new Uint32Array(h)),i.properties=Qet(t),i}_parseObjectGroup(t){const e=new Xet;e.name=t.getAttribute("name")||"",e.offset=new tn(parseFloat(t.getAttribute("offsetx")),parseFloat(t.getAttribute("offsety")));const i=t.getAttribute("opacity");e.opacity=i?Math.round(255*parseFloat(i)):255;const n=t.getAttribute("tintcolor");e.tintColor=n?Zet(n):null;const s=t.getAttribute("visible");s&&0===parseInt(s)&&(e.visible=!1);const r=t.getAttribute("color");r&&e.color.fromHEX(r);const o=t.getAttribute("draworder");o&&(e.draworder=o),e.setProperties(Qet(t));const a=t.getElementsByTagName("object");if(a){for(let t=0;t<a.length;t++){const i=a[t],n={};n.id=i.getAttribute("id")||t,n.name=i.getAttribute("name")||"",n.width=parseFloat(i.getAttribute("width"))||0,n.height=parseFloat(i.getAttribute("height"))||0,n.x=parseFloat(i.getAttribute("x"))||0,n.y=parseFloat(i.getAttribute("y"))||0,n.rotation=parseFloat(i.getAttribute("rotation"))||0,Qet(i,n);const s=i.getAttribute("visible");n.visible=!(s&&0===parseInt(s));const r=i.getElementsByTagName("text");if(r&&r.length>0){const t=r[0];n.type=xet.TEXT,n.wrap="1"===t.getAttribute("wrap"),n.color=Zet(t.getAttribute("color")),n.halign=$et(t.getAttribute("halign")),n.valign=Jet(t.getAttribute("valign")),n.pixelsize=parseInt(t.getAttribute("pixelsize"))||16,n.text=t.childNodes[0].nodeValue}const o=i.getAttribute("gid");o&&(n.gid=parseInt(o),n.type=xet.IMAGE);const l=i.getElementsByTagName("ellipse");l&&l.length>0&&(n.type=xet.ELLIPSE);const c=i.getElementsByTagName("polygon");if(c&&c.length>0){n.type=xet.POLYGON;const t=c[0].getAttribute("points");t&&(n.points=this._parsePointsString(t))}const h=i.getElementsByTagName("polyline");if(h&&h.length>0){n.type=xet.POLYLINE;const t=h[0].getAttribute("points");t&&(n.polylinePoints=this._parsePointsString(t))}n.type||(n.type=xet.RECT),e.objects.push(n)}"index"!==o&&e.objects.sort(((t,e)=>t.y-e.y))}return e}_parsePointsString(t){if(!t)return null;const e=[],i=t.split(" ");for(let t=0;t<i.length;t++){const n=i[t].split(",");e.push({x:parseFloat(n[0]),y:parseFloat(n[1])})}return e}setTileAnimations(t){this._tileAnimations=t}getTileAnimations(){return this._tileAnimations}getTileProperties(){return this._tileProperties}setTileProperties(t){this._tileProperties=t}getCurrentString(){return this.currentString}setCurrentString(t){this.currentString=t}static getNameWithPostfix(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1,i=t.length;return t.substring(e,i)}static getShortName(t){const e=(t=t.replace(/\\/g,"/")).lastIndexOf("/")+1;let i=t.lastIndexOf(".");return i=i<0?t.length:i,t.substring(e,i)}}var eit,iit,nit,sit,rit,oit,ait,lit,cit,hit,_it,uit,mit;let pit=t("TiledTile",(eit=Vl("cc.TiledTile"),iit=ec(),nit=Jl(),sit=Ul(NL),rit=yc(oe),oit=yc(oe),ait=yc(oe),lit=yc(oe),cit=yc(oe),eit(hit=iit(hit=nit(hit=sit(hit=$l((uit=wl((_it=class extends Rh{constructor(){super(),this._layer=null,Tl(this,"_x",uit,this),Tl(this,"_y",mit,this)}get x(){return this._x}set x(t){t!==this._x&&(this._layer&&this._layer.isInvalidPosition(t,this._y)?m("Invalid x, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.width):(this._resetTile(),this._x=t,this.updateInfo()))}get y(){return this._y}set y(t){t!==this._y&&(this._layer&&this._layer.isInvalidPosition(this._x,t)?m("Invalid y, the valid value is between [%s] ~ [%s]",0,this._layer.layerSize.height):(this._resetTile(),this._y=t,this.updateInfo()))}get grid(){return this._layer?this._layer.getTileGIDAt(this._x,this._y):0}set grid(t){this._layer&&this._layer.setTileGIDAt(t,this._x,this._y)}onEnable(){const t=this.node.parent;this._layer=t.getComponent("cc.TiledLayer"),this._resetTile(),this.updateInfo()}onDisable(){this._resetTile()}_resetTile(){this._layer&&this._layer.getTiledTileAt(this._x,this._y)===this&&this._layer.setTiledTileAt(this._x,this._y,null)}updateInfo(){if(!this._layer)return;const t=this._x,e=this._y;if(this._layer.getTiledTileAt(t,e))return void m("There is already a TiledTile at [%s, %s]",t,e);const i=this._layer.getPositionAt(t,e);this.node.setPosition(i.x,i.y),this._layer.setTiledTileAt(t,e,this)}}).prototype,"_x",[rit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mit=wl(_it.prototype,"_y",[oit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wl(_it.prototype,"x",[ait],Object.getOwnPropertyDescriptor(_it.prototype,"x"),_it.prototype),wl(_it.prototype,"y",[lit],Object.getOwnPropertyDescriptor(_it.prototype,"y"),_it.prototype),wl(_it.prototype,"grid",[cit],Object.getOwnPropertyDescriptor(_it.prototype,"grid"),_it.prototype),hit=_it))||hit)||hit)||hit)||hit)||hit));function dit(t,e,i){const n=i||t.sourceImage,s=n.texture,r=t.collection;if(!t.imageSize.width||!t.imageSize.height){const e=t.sourceImage;t.imageSize.width=e.width,t.imageSize.height=e.height}const o=t.imageSize.width,a=t.imageSize.height,l=t._tileSize.width,c=t._tileSize.height,h=n.width,_=n.height,u=t.spacing,m=t.margin;let p=1;if(!r){const t=Math.floor((o-2*m+u)/(l+u)),e=Math.floor((a-2*m+u)/(c+u));p=Math.max(1,e*t)}const d=t.firstGid;let f=null,g=!!e.get(d);const y=t.firstGid+p;let v=d;for(;v<y&&(g&&!e.get(v)&&(g=!1),g||!e.get(v));++v){if(f={tileset:t,x:0,y:0,width:l,height:c,t:0,l:0,r:0,b:0,cx:0,cy:0,offsetX:0,offsetY:0,rotated:!1,gid:v,spriteFrame:n,texture:s},t.rectForGID(v,f),!i||p>1)if(i){f._name=i.name;const t=i.unbiasUV[0],e=i.rotated?i.unbiasUV[1]:i.unbiasUV[5];f.l=t+(f.x+.5)/h,f.t=e+(f.y+.5)/_,f.r=t+(f.x+f.width-.5)/h,f.b=e+(f.y+f.height-.5)/_,f._rect=new hn(f.x,f.y,f.width,f.height)}else f.l=f.x/h,f.t=f.y/_,f.r=(f.x+f.width)/h,f.b=(f.y+f.height)/_,f._rect=new hn(f.x,f.y,f.width,f.height);else i.rotated?(f._rotated=!0,f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[1],f.r=i.unbiasUV[4],f.b=i.unbiasUV[3]):(f._name=i.name,f._rect=i.getRect(),f.l=i.unbiasUV[0],f.t=i.unbiasUV[5],f.r=i.unbiasUV[2],f.b=i.unbiasUV[1]);f.cx=(f.l+f.r)/2,f.cy=(f.t+f.b)/2,e.set(v,f)}}var fit,git;const yit=new $i,vit=new tn,xit=new Ni,bit=new Ni,Sit={row:0,col:0};let Ait=t("TiledUserNodeData",Vl("cc.TiledUserNodeData")(fit=class extends Rh{constructor(){super(),this._index=-1,this._row=-1,this._col=-1,this._tiledLayer=null}})||fit),Cit=t("TiledLayer",Vl("cc.TiledLayer")(git=class t extends iF{get cullingRect(){return this._cullingRect}get rightTop(){return this._rightTop}get layerSize(){return this._layerSize}get meshRenderDataArray(){return this._meshRenderDataArray}get leftDownToCenterX(){return this._leftDownToCenterX}get leftDownToCenterY(){return this._leftDownToCenterY}constructor(){super(),this._userNodeGrid={},this._userNodeMap={},this._userNodeDirty=!1,this.tiledTiles=[],this._viewPort={x:-1,y:-1,width:-1,height:-1},this._cullingRect={leftDown:{row:-1,col:-1},rightTop:{row:-1,col:-1}},this._cullingDirty=!0,this._rightTop={row:-1,col:-1},this._layerInfo=null,this._mapInfo=null,this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this.tiles=[],this.vertices=[],this._verticesDirty=!0,this._layerName="",this._layerSize=void 0,this._minGID=void 0,this._maxGID=void 0,this._layerOrientation=null,this._opacity=void 0,this._tintColor=void 0,this.texGrids=null,this._textures=[],this._tilesets=[],this._leftDownToCenterX=0,this._leftDownToCenterY=0,this._hasTiledNodeGrid=!1,this._hasAniGrid=!1,this._animations=null,this._enableCulling=void 0,this.colorChanged=!1,this._properties=void 0,this.renderOrder=void 0,this._staggerAxis=void 0,this._staggerIndex=void 0,this._hexSideLength=void 0,this._mapTileSize=void 0,this._odd_even=void 0,this._diffX1=void 0,this._diffY1=void 0,this._useAutomaticVertexZ=void 0,this._vertexZvalue=void 0,this._offset=void 0,this._meshRenderDataArray=null,this._meshRenderDataArrayIdx=0}hasTiledNode(){return this._hasTiledNodeGrid}hasAnimation(){return this._hasAniGrid}set enableCulling(t){this._enableCulling!==t&&(this._enableCulling=t,this._cullingDirty=!0,this.markForUpdateRenderData())}get enableCulling(){return this._enableCulling}addUserNode(t){let e=t.getComponent(Ait);return e?(m("CCTiledLayer:addUserNode node has been added"),!1):(e=t.addComponent(Ait),t.parent=this.node,this._userNodeMap[t.uuid]=e,e._row=-1,e._col=-1,e._tiledLayer=this,this._nodeLocalPosToLayerPos(t.getPosition(),vit),this._positionToRowCol(vit.x,vit.y,Sit),this._addUserNodeToGrid(e,Sit),this._updateCullingOffsetByUserNode(t),t.on(ev.TRANSFORM_CHANGED,this._userNodePosChange,e),t.on(ev.SIZE_CHANGED,this._userNodeSizeChange,e),!0)}removeUserNode(t){const e=t.getComponent(Ait);return e?(t.off(ev.TRANSFORM_CHANGED,this._userNodePosChange,e),t.off(ev.SIZE_CHANGED,this._userNodeSizeChange,e),this._removeUserNodeFromGrid(e),delete this._userNodeMap[t.uuid],t._removeComponent(e),e.destroy(),t.removeFromParent(),!0):(m("CCTiledLayer:removeUserNode node is not exist"),!1)}destroyUserNode(t){this.removeUserNode(t),t.destroy()}_nodeLocalPosToLayerPos(t,e){e.x=t.x+this._leftDownToCenterX,e.y=t.y+this._leftDownToCenterY}getNodesByRowCol(t,e){const i=this._userNodeGrid[t];return i?i[e]:null}getNodesCountByRow(t){const e=this._userNodeGrid[t];return e?e.count:0}_updateAllUserNode(){this._userNodeGrid={};for(const t in this._userNodeMap){const e=this._userNodeMap[t];this._nodeLocalPosToLayerPos(e.node.getPosition(),vit),this._positionToRowCol(vit.x,vit.y,Sit),this._addUserNodeToGrid(e,Sit),this._updateCullingOffsetByUserNode(e.node)}}_updateCullingOffsetByUserNode(t){const e=t._uiProps.uiTransformComp.contentSize;this._topOffset<e.height&&(this._topOffset=e.height),this._downOffset<e.height&&(this._downOffset=e.height),this._leftOffset<e.width&&(this._leftOffset=e.width),this._rightOffset<e.width&&(this._rightOffset=e.width)}_userNodeSizeChange(){const t=this.node,e=this._tiledLayer;e._updateCullingOffsetByUserNode(t),e._userNodeDirty=!0,e.markForUpdateRenderData()}_userNodePosChange(){const t=this,e=t.node,i=t._tiledLayer;i._nodeLocalPosToLayerPos(e.getPosition(),vit),i._positionToRowCol(vit.x,vit.y,Sit),i._limitInLayer(Sit),Sit.row===t._row&&Sit.col===t._col||(i._removeUserNodeFromGrid(t),i._addUserNodeToGrid(t,Sit))}_removeUserNodeFromGrid(t){const e=t._row,i=t._col,n=t._index,s=this._userNodeGrid[e],r=s&&s[i];r&&(s.count--,r.count--,r.list[n]=null,r.count<=0&&(r.list.length=0,r.count=0)),t._row=-1,t._col=-1,t._index=-1,this._userNodeDirty=!0,this.markForUpdateRenderData()}_limitInLayer(t){const e=t.row,i=t.col;e<0&&(t.row=0),e>this._rightTop.row&&(t.row=this._rightTop.row),i<0&&(t.col=0),i>this._rightTop.col&&(t.col=this._rightTop.col)}_addUserNodeToGrid(t,e){const i=e.row,n=e.col,s=this._userNodeGrid[i]=this._userNodeGrid[i]||{count:0},r=s[n]=s[n]||{count:0,list:[]};t._row=i,t._col=n,t._index=r.list.length,s.count++,r.count++,r.list.push(t),this._userNodeDirty=!0}isUserNodeDirty(){return this._userNodeDirty}setUserNodeDirty(t){this._userNodeDirty=t}onEnable(){super.onEnable(),this.node.on(ev.ANCHOR_CHANGED,this._syncAnchorPoint,this),this.node.on(ev.TRANSFORM_CHANGED,this.updateCulling,this),this.node.on(ev.SIZE_CHANGED,this.updateCulling,this),this.node.parent.on(ev.TRANSFORM_CHANGED,this.updateCulling,this),this.node.parent.on(ev.SIZE_CHANGED,this.updateCulling,this),this.markForUpdateRenderData(),this.scheduleOnce(this.updateCulling.bind(this))}onDisable(){super.onDisable(),this.node.parent.off(ev.SIZE_CHANGED,this.updateCulling,this),this.node.parent.off(ev.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(ev.SIZE_CHANGED,this.updateCulling,this),this.node.off(ev.TRANSFORM_CHANGED,this.updateCulling,this),this.node.off(ev.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_syncAnchorPoint(){const t=this.node,e=t._uiProps.uiTransformComp,i=t.getScale();this._leftDownToCenterX=e.width*e.anchorX*i.x,this._leftDownToCenterY=e.height*e.anchorY*i.y,this._cullingDirty=!0,this.markForUpdateRenderData()}onDestroy(){super.onDestroy()}getLayerName(){return this._layerName}setLayerName(t){this._layerName=t}getProperty(t){return this._properties[t]}getPositionAt(t,e){let i;switch(void 0!==e?(i=Math.floor(t),e=Math.floor(e)):(i=Math.floor(t.x),e=Math.floor(t.y)),this._layerOrientation){case pet.ORTHO:return this._positionForOrthoAt(i,e);case pet.ISO:return this._positionForIsoAt(i,e);case pet.HEX:return this._positionForHexAt(i,e)}return null}isInvalidPosition(t,e){return t>=this._layerSize.width||e>=this._layerSize.height||t<0||e<0}_positionForIsoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&fet.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new tn(.5*this._mapTileSize.width*(this._layerSize.height+t-e-1)+i,.5*this._mapTileSize.height*(this._layerSize.width-t+this._layerSize.height-e-2)-n)}_positionForOrthoAt(t,e){let i=0,n=0;const s=Math.floor(t)+Math.floor(e)*this._layerSize.width,r=this.tiles[s];if(r){const t=(r&fet.FLIPPED_MASK)>>>0,e=this.texGrids.get(t).tileset.tileOffset;i=e.x,n=e.y}return new tn(t*this._mapTileSize.width+i,(this._layerSize.height-e-1)*this._mapTileSize.height-n)}_positionForHexAt(t,e){const i=this._mapTileSize.width,n=this._mapTileSize.height,s=this._layerSize.height,r=Math.floor(t)+Math.floor(e)*this._layerSize.width,o=(this.tiles[r]&fet.FLIPPED_MASK)>>>0;let a;a=this.texGrids.get(o)?this.texGrids.get(o).tileset.tileOffset:{x:0,y:0};const l=this._staggerIndex===yet.STAGGERINDEX_ODD?1:-1;let c=0,h=0,_=0,u=0;switch(this._staggerAxis){case get.STAGGERAXIS_Y:_=0,e%2==1&&(_=i/2*l),c=t*i+_+a.x,h=(s-e-1)*(n-(n-this._hexSideLength)/2)-a.y;break;case get.STAGGERAXIS_X:u=0,t%2==1&&(u=n/2*-l),c=t*(i-(i-this._hexSideLength)/2)+a.x,h=(s-e-1)*n+u-a.y}return new tn(c,h)}setTilesGIDAt(t,e,i,n){if(!t||0===t.length||n<=0)return;i<0&&(i=0),e<0&&(e=0);let s=0;const r=e+n;for(let n=i;;n++)for(let i=e;i<r;i++){if(s>=t.length)return;this._updateTileForGID(t[s],i,n),s++}}setTileGIDAt(t,e,i,n){const s=(t&fet.FLIPPED_MASK)>>>0;if(e=Math.floor(e),i=Math.floor(i),this.isInvalidPosition(e,i))throw new Error("cc.TiledLayer.setTileGIDAt(): invalid position");this.tiles&&this._tilesets&&0!==this._tilesets.length?0!==s&&s<this._tilesets[0].firstGid?b(7239,t):(n=n||0,this._updateTileForGID((s|n)>>>0,e,i)):b(7238)}_updateTileForGID(t,e,i){const n=0|e+i*this._layerSize.width;if(n>=this.tiles.length)return;if(t===this.tiles[n])return;const s=(t&fet.FLIPPED_MASK)>>>0;this.texGrids.get(s)?(this.tiles[n]=t,this._updateVertex(e,i)):this.tiles[n]=0,this._cullingDirty=!0}getTileGIDAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("cc.TiledLayer.getTileGIDAt(): invalid position");if(!this.tiles)return b(7237),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&fet.FLIPPED_MASK)>>>0}getTileFlagsAt(t,e){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTileFlagsAt: invalid position");if(!this.tiles)return b(7240),null;const i=Math.floor(t)+Math.floor(e)*this._layerSize.width;return(this.tiles[i]&fet.FLIPPED_ALL)>>>0}setCullingDirty(t){this._cullingDirty=t}isCullingDirty(){return this._cullingDirty}updateViewPort(t,e,i,n){if(this._viewPort.width===i&&this._viewPort.height===n&&this._viewPort.x===t&&this._viewPort.y===e)return;this._viewPort.x=t,this._viewPort.y=e,this._viewPort.width=i,this._viewPort.height=n;let s=1;this._layerOrientation===pet.ISO&&(s=2);const r=this._viewPort.x-this._offset.x+this._leftDownToCenterX,o=this._viewPort.y-this._offset.y+this._leftDownToCenterY;let a=r-this._leftOffset,l=o-this._downOffset;const c=r+i+this._rightOffset,h=o+n+this._topOffset,_=this._cullingRect.leftDown,u=this._cullingRect.rightTop;a<0&&(a=0),l<0&&(l=0),this._positionToRowCol(a,l,Sit),Sit.row-=s,Sit.col-=s,Sit.row=Sit.row>0?Sit.row:0,Sit.col=Sit.col>0?Sit.col:0,Sit.row===_.row&&Sit.col===_.col||(_.row=Sit.row,_.col=Sit.col,this._cullingDirty=!0),c<0||h<0?(Sit.row=-1,Sit.col=-1):(this._positionToRowCol(c,h,Sit),Sit.row++,Sit.col++),Sit.row>this._rightTop.row&&(Sit.row=this._rightTop.row),Sit.col>this._rightTop.col&&(Sit.col=this._rightTop.col),Sit.row===u.row&&Sit.col===u.col||(u.row=Sit.row,u.col=Sit.col,this._cullingDirty=!0,this.markForUpdateRenderData())}_positionToRowCol(t,e,i){const n=this._mapTileSize.width,s=this._mapTileSize.height,r=.5*n,o=.5*s;let a=0,l=0,c=0,h=0;const _=this._staggerAxis;switch(this._layerOrientation){case pet.ORTHO:l=Math.floor(t/n),a=Math.floor(e/s);break;case pet.ISO:l=Math.floor(t/r),a=Math.floor(e/o);break;case pet.HEX:_===get.STAGGERAXIS_Y?(a=Math.floor(e/(s-this._diffY1)),c=a%2==1?r*this._odd_even:0,l=Math.floor((t-c)/n)):(l=Math.floor(t/(n-this._diffX1)),h=l%2==1?o*-this._odd_even:0,a=Math.floor((e-h)/s))}return i.row=a,i.col=l,i}updateCulling(){if(this._enableCulling){this.node.updateWorldTransform(),$i.invert(yit,this.node.getWorldMatrix());const t=Mw.root.batcher2D.getFirstRenderCamera(this.node);t&&(xit.x=0,xit.y=0,xit.z=0,bit.x=t.width,bit.y=t.height,bit.z=0,t.screenToWorld(xit,xit),t.screenToWorld(bit,bit),Ni.transformMat4(xit,xit,yit),Ni.transformMat4(bit,bit,yit),this.updateViewPort(xit.x,xit.y,bit.x-xit.x,bit.y-xit.y))}}getLayerOrientation(){return this._layerOrientation}getProperties(){return this._properties}_updateVertex(t,e){const i=fet.FLIPPED_MASK,n=this.vertices,s=this._layerOrientation,r=this.tiles;if(!r)return;const o=this._rightTop,a=this._mapTileSize.width,l=this._mapTileSize.height,c=.5*a,h=.5*l,_=this._layerSize.height,u=this._layerSize.width,m=this.texGrids;let p,d,f,g,y,v,x=0,b=0;s===pet.HEX&&(p=this._staggerAxis,d=this._diffX1,f=this._diffY1,g=this._odd_even);let S=0,A=0,C=0,T=0,w=0,E=0,P=0;const D=e*u+t;C=(r[D]&i)>>>0;const I=m.get(C);if(!I)return;switch(this._animations.get(C)&&(this._hasAniGrid=this._hasAniGrid||!0),s){case pet.ORTHO:S=t,A=_-e-1,x=S*a,b=A*l;break;case pet.ISO:S=_+t-e-1,A=_+u-t-e-2,x=c*S,b=h*A;break;case pet.HEX:y=p===get.STAGGERAXIS_Y&&e%2==1?c*g:0,v=p===get.STAGGERAXIS_X&&t%2==1?h*-g:0,x=t*(a-d)+y,b=(_-e-1)*(l-f)+v,S=t,A=_-e-1}const R=n[A]=n[A]||{minCol:0,maxCol:0},M=R[S]=R[S]||{};R.minCol>S&&(R.minCol=S),R.maxCol<S&&(R.maxCol=S),o.row<A&&(o.row=A),o.col<S&&(o.col=S);const O=I.tileset.tileOffset;x+=this._offset.x+O.x+I.offsetX,b+=this._offset.y-O.y-I.offsetY,T=-O.y+I.tileset._tileSize.height-l,T=T<0?0:T,w=O.y<0?0:O.y,E=-O.x<0?0:-O.x,P=O.x+I.tileset._tileSize.width-a,P=P<0?0:P,this._rightOffset<E&&(this._rightOffset=E),this._leftOffset<P&&(this._leftOffset=P),this._topOffset<w&&(this._topOffset=w),this._downOffset<T&&(this._downOffset=T),M.left=x,M.bottom=b,M.index=D,this._cullingDirty=!0}_updateVertices(){if(this.vertices.length=0,!this.tiles)return;const t=this._rightTop;t.row=-1,t.col=-1;const e=this._layerSize.height,i=this._layerSize.width;this._topOffset=0,this._downOffset=0,this._leftOffset=0,this._rightOffset=0,this._hasAniGrid=!1;for(let t=0;t<e;++t)for(let e=0;e<i;++e)this._updateVertex(e,t);this._verticesDirty=!1}getTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.getTiledTileAt: invalid position");if(!this.tiles)return b(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;let s=this.tiledTiles[n];if(!s&&i){const i=new Yv;return s=i.addComponent(pit),s._x=t,s._y=e,s._layer=this,s.updateInfo(),i.parent=this.node,s}return s}setTiledTileAt(t,e,i){if(this.isInvalidPosition(t,e))throw new Error("TiledLayer.setTiledTileAt: invalid position");if(!this.tiles)return b(7236),null;const n=Math.floor(t)+Math.floor(e)*this._layerSize.width;return this.tiledTiles[n]=i,this._cullingDirty=!0,this._hasTiledNodeGrid=!!i||this.tiledTiles.some((t=>!!t)),i}getTexture(t){return t=t||0,this._textures&&t>=0&&this._textures.length>t?this._textures[t]:null}getTextures(){return this._textures}setTexture(t){this.setTextures([t])}setTextures(t){this._textures=t,this.markForUpdateRenderData()}getLayerSize(){return this._layerSize}getMapTileSize(){return this._mapTileSize}getTileSet(t){return t=t||0,this._tilesets&&t>=0&&this._tilesets.length>t?this._tilesets[t]:null}getTileSets(){return this._tilesets}setTileSet(t){this.setTileSets([t])}setTileSets(t){this._tilesets=t;const e=this._textures=[],i=this.texGrids;i.clear();for(let i=0;i<t.length;i++){const n=t[i];n&&(e[i]=n.sourceImage)}for(let e=0,n=t.length;e<n;++e){const n=t[e];n&&dit(n,i,n.sourceImage)}this._prepareToRender()}init(t,e,i,n,s){this._cullingDirty=!0,this._layerInfo=t,this._mapInfo=e;const r=t.layerSize;this._layerName=t.name,this.tiles=t.tiles,this._properties=t.properties,this._layerSize=r,this._minGID=t.minGID,this._maxGID=t.maxGID,this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this.renderOrder=e.renderOrder,this._staggerAxis=e.getStaggerAxis(),this._staggerIndex=e.getStaggerIndex(),this._hexSideLength=e.getHexSideLength(),this._animations=e.getTileAnimations(),this._tilesets=i,this._textures=n,this.texGrids=s,this._layerOrientation=e.orientation,this._mapTileSize=e.getTileSize();const o=this._mapTileSize.width,a=this._mapTileSize.height,l=this._layerSize.width,c=this._layerSize.height;if(this._layerOrientation===pet.HEX){let t=0,e=0;this._odd_even=this._staggerIndex===yet.STAGGERINDEX_ODD?1:-1,this._staggerAxis===get.STAGGERAXIS_X?(this._diffX1=(o-this._hexSideLength)/2,this._diffY1=0,e=a*(c+.5),t=(o+this._hexSideLength)*Math.floor(l/2)+o*(l%2)):(this._diffX1=0,this._diffY1=(a-this._hexSideLength)/2,t=o*(l+.5),e=(a+this._hexSideLength)*Math.floor(c/2)+a*(c%2)),this.node._uiProps.uiTransformComp.setContentSize(t,e)}else if(this._layerOrientation===pet.ISO){const t=l+c;this.node._uiProps.uiTransformComp.setContentSize(.5*o*t,.5*a*t)}else this.node._uiProps.uiTransformComp.setContentSize(l*o,c*a);this._offset=new tn(t.offset.x,-t.offset.y),this._useAutomaticVertexZ=!1,this._vertexZvalue=0,this._syncAnchorPoint(),this._prepareToRender()}_prepareToRender(){this._updateVertices(),this._updateAllUserNode()}requestMeshRenderData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;for(;t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length;)t.pop();if(t.length>0){const e=t[t.length-1];if(e.renderData&&0===e.renderData.byteCount)return e}const e=new cL,i={renderData:e,texture:null};return Object.defineProperty(e,"material",{get:()=>this.getRenderMaterial(0)}),this._meshRenderDataArray.push(i),i}requestSubNodesData(){this._meshRenderDataArray||(this._meshRenderDataArray=[]);const t=this._meshRenderDataArray;for(;t.length>0&&t[t.length-1].renderData&&0===t[t.length-1].renderData.byteCount;)t.pop();if(t.length>0&&t[t.length-1].subNodes&&0===t[t.length-1].subNodes.length)return t[t.length-1];const e={subNodes:[]};return this._meshRenderDataArray.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{t.renderData&&t.renderData.reset()})),this._meshRenderDataArray.length=0)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),this._meshRenderDataArray||this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._updateColor())}_render(t){if(this._meshRenderDataArray){for(let e=0;e<this._meshRenderDataArray.length;e++){this._meshRenderDataArrayIdx=e;const i=this._meshRenderDataArray[e];i.subNodes?i.subNodes.forEach((e=>{e&&t.walk(e.node)})):i.texture&&t.commitComp(this,i.texture,this._assembler,null)}this.node._static=!0}}})||git);var Tit,wit,Eit,Pit,Dit,Iit;let Rit=t("TiledObjectGroup",(Tit=Vl("cc.TiledObjectGroup"),wit=ec(),Eit=Ul(NL),Pit=yc(le),Tit(Dit=wit(Dit=Eit((wl((Iit=class extends Rh{constructor(...t){super(...t),this._premultiplyAlpha=!1,this._groupName=void 0,this._positionOffset=void 0,this._mapInfo=void 0,this._properties=void 0,this._offset=void 0,this._opacity=void 0,this._tintColor=null,this._animations=void 0,this._hasAniObj=void 0,this._texGrids=void 0,this.aniObjects=void 0,this._objects=[]}get premultiplyAlpha(){return this._premultiplyAlpha}set premultiplyAlpha(t){this._premultiplyAlpha=t}getPositionOffset(){return this._positionOffset}getProperties(){return this._properties}getGroupName(){return this._groupName}getProperty(t){return this._properties[t.toString()]}getObject(t){for(let e=0,i=this._objects.length;e<i;e++){const i=this._objects[e];if(i&&i.name===t)return i}return null}getObjects(){return this._objects}get offset(){return this._offset}_init(t,e,i){const n=fet.FLIPPED_MASK,s=fet.HORIZONTAL,r=fet.VERTICAL;this._groupName=t.name,this._positionOffset=t.offset,this._mapInfo=e,this._properties=t.getProperties(),this._offset=new tn(t.offset.x,-t.offset.y),this._opacity=t.opacity,t.tintColor&&(this._tintColor=t.tintColor),this._texGrids=i,this._animations=e.getTileAnimations(),this.aniObjects=[],this._hasAniObj=!1;const o=e.mapSize,a=e.tileSize;let l=0,c=0;const h=new Ri,_=pet.ISO===e.orientation;if(e.orientation===pet.HEX)e.getStaggerAxis()===get.STAGGERAXIS_X?(c=a.height*(o.height+.5),l=(a.width+e.getHexSideLength())*Math.floor(o.width/2)+a.width*(o.width%2)):(l=a.width*(o.width+.5),c=(a.height+e.getHexSideLength())*Math.floor(o.height/2)+a.height*(o.height%2));else if(_){const t=o.width+o.height;l=.5*a.width*t,c=.5*a.height*t}else l=o.width*a.width,c=o.height*a.height;const u=this.node._uiProps.uiTransformComp;u.setContentSize(l,c);const m=l*u.anchorX,p=c*(1-u.anchorY),d=t.objects,f={};for(let t=0,e=d.length;t<e;t++){const e=d[t],l=e.type;e.offset=new tn(e.x,e.y);const u=e.points||e.polylinePoints;if(u)for(let t=0;t<u.length;t++)u[t].y*=-1;if(_){const t=e.x/a.height,i=e.y/a.height;e.x=.5*a.width*(o.height+t-i),e.y=.5*a.height*(o.width+o.height-t-i)}else e.y=c-e.y;if(l===xet.TEXT){const i=`text${e.id}`;f[i]=!0;let n=this.node.getChildByName(i);n||(n=new Yv),n.setRotationFromEuler(0,0,-e.rotation),n.setPosition(e.x-m,e.y-p),n.name=i,n.parent=this.node,n.setSiblingIndex(t);let s=n.getComponent(fz);s||(s=n.addComponent(fz));const r=n._uiProps.uiTransformComp;n.active=e.visible,r.anchorX=0,r.anchorY=1,this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,s.color.set(h)):s.color.a*=this._opacity/255,s.overflow=fz.Overflow.SHRINK,s.lineHeight=e.height,s.string=e.text,s.horizontalAlign=e.halign,s.verticalAlign=e.valign,s.fontSize=e.pixelsize,r.setContentSize(e.width,e.height)}else if(l===xet.IMAGE){const o=e.gid,a=(o&n)>>>0,l=i.get(a);if(!l)continue;const c=l.tileset,u=`img${e.id}`;f[u]=!0;let d=this.node.getChildByName(u);e.width=e.width||l.width,e.height=e.height||l.height,d&&d._objFlags&Me.Flags.HideInHierarchy&&(d.removeFromParent(),d.hideFlags|=Me.Flags.DontSave,d.destroy(),d=null),d||(d=new Yv),this._animations.get(a)&&(this.aniObjects.push({object:e,imgNode:d,gridGID:a}),this._hasAniObj=!0);const g=c.tileOffset.x,y=c.tileOffset.y;d.active=e.visible,d.setRotationFromEuler(0,0,-e.rotation),d.setPosition(e.x-m,e.y-p),d.name=u,d.parent=this.node,d.setSiblingIndex(t);let v=d.getComponent(HU);v||(v=d.addComponent(HU));const x=d._uiProps.uiTransformComp;_?(x.anchorX=.5+g/e.width,x.anchorY=y/e.height):(x.anchorX=g/e.width,x.anchorY=y/e.height),this._tintColor?(h.set(this._tintColor),h.a*=this._opacity/255,v.color.set(h)):v.color.a*=this._opacity/255,v.sizeMode=HU.SizeMode.CUSTOM,v._srcBlendFactor=this._premultiplyAlpha?Ys.ONE:Ys.SRC_ALPHA,v._dstBlendFactor=Ys.ONE_MINUS_SRC_ALPHA,v._updateBlendFunc();let b=l.spriteFrame;b=b?b.clone():new pN,(o&s)>>>0&&(b.flipUVX=!b.flipUVX),(o&r)>>>0&&(b.flipUVY=!b.flipUVY),b.rotated=l._rotated,b.rect=l._rect,v.spriteFrame=b,x.setContentSize(e.width,e.height),v.markForUpdateRenderData()}}this._objects=d;const g=this.node.children,y=/^(?:img|text)\d+$/;for(let t=0,e=g.length;t<e;t++){const e=g[t],i=e.name;y.test(i)&&!f[i]&&e.destroy()}}update(t){if(!this._hasAniObj)return;const e=this.aniObjects,i=this._texGrids,n=pet.ISO===this._mapInfo.orientation;for(let t=0,s=e.length;t<s;t++){const s=e[t],r=s.gridGID,o=i.get(r);if(!o)continue;const a=o.tileset,l=s.object,c=s.imgNode,h=a.tileOffset.x,_=a.tileOffset.y,u=c._uiProps.uiTransformComp;n?(u.anchorX=.5+h/l.width,u.anchorY=_/l.height):(u.anchorX=h/l.width,u.anchorY=_/l.height);const m=c.getComponent(HU),p=m.spriteFrame;p.rotated=o._rotated,p.rect=o._rect,m.spriteFrame=p,m.markForUpdateRenderData()}}}).prototype,"premultiplyAlpha",[Pit],Object.getOwnPropertyDescriptor(Iit.prototype,"premultiplyAlpha"),Iit.prototype),Dit=Iit))||Dit)||Dit)||Dit));var Mit,Oit,Bit,Nit,Lit,Fit,zit,Vit,Uit,Git,kit,Hit,jit,Wit,qit,Xit,Yit,Kit;let $it=t("TiledMapAsset",(Mit=Vl("cc.TiledMapAsset"),Oit=yc([mT]),Bit=yc([ce]),Nit=yc([pN]),Lit=yc([pN]),Fit=yc([ce]),zit=yc([ce]),Vit=yc([ln]),Mit((kit=wl((Git=class extends _h{constructor(...t){super(...t),Tl(this,"tmxXmlStr",kit,this),Tl(this,"tsxFiles",Hit,this),Tl(this,"tsxFileNames",jit,this),Tl(this,"spriteFrames",Wit,this),Tl(this,"imageLayerSpriteFrame",qit,this),Tl(this,"imageLayerSpriteFrameNames",Xit,this),Tl(this,"spriteFrameNames",Yit,this),Tl(this,"spriteFrameSizes",Kit,this)}}).prototype,"tmxXmlStr",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Hit=wl(Git.prototype,"tsxFiles",[Wl,Oit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jit=wl(Git.prototype,"tsxFileNames",[Wl,Bit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Wit=wl(Git.prototype,"spriteFrames",[Wl,Nit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),qit=wl(Git.prototype,"imageLayerSpriteFrame",[Wl,Lit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Xit=wl(Git.prototype,"imageLayerSpriteFrameNames",[Wl,Fit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yit=wl(Git.prototype,"spriteFrameNames",[Wl,zit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kit=wl(Git.prototype,"spriteFrameSizes",[Wl,Vit],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Uit=Git))||Uit));var Jit,Zit,Qit,tnt,ent,int,nnt,snt,rnt,ont,ant,lnt,cnt;t("TiledMap",(Jit=Vl("cc.TiledMap"),Zit=ec(),Qit=Jl(),tnt=Ul(NL),ent=yc($it),int=_c(),Jit(nnt=Zit(nnt=Qit(nnt=tnt(nnt=$l((cnt=lnt=class extends Rh{constructor(...t){super(...t),this._texGrids=new Map,this._textures=[],this._tilesets=[],this._animations=new Map,this._imageLayers=[],this._layers=[],this._groups=[],this._images=[],this._properties={},this._tileProperties=new Map,this._mapInfo=null,this._mapSize=new ln(0,0),this._tileSize=new ln(0,0),this._preloaded=!1,this._mapOrientation=pet.ORTHO,Tl(this,"_tmxFile",rnt,this),Tl(this,"_enableCulling",ont,this),Tl(this,"cleanupImageCache",ant,this)}get tmxAsset(){return this._tmxFile}set tmxAsset(t){this._tmxFile!==t&&(this._tmxFile=t,this._preloaded&&this._applyFile())}get enableCulling(){return this._enableCulling}set enableCulling(t){this._enableCulling=t;const e=this._layers;for(let i=0;i<e.length;++i)e[i].enableCulling=t}getMapSize(){return this._mapSize}getTileSize(){return this._tileSize}getMapOrientation(){return this._mapOrientation}getObjectGroups(){return this._groups}getObjectGroup(t){const e=this._groups;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getGroupName()===t)return n}return null}getProperties(){return this._properties}getLayers(){return this._layers}getLayer(t){const e=this._layers;for(let i=0,n=e.length;i<n;i++){const n=e[i];if(n&&n.getLayerName()===t)return n}return null}_changeLayer(t,e){const i=this._layers;for(let n=0,s=i.length;n<s;n++){const s=i[n];if(s&&s.getLayerName()===t)return void(i[n]=e)}}getProperty(t){return this._properties[t.toString()]}getPropertiesForGID(t){return this._tileProperties.get(t)}__preload(){this._preloaded=!0,this._tmxFile&&this._applyFile()}onEnable(){this.node.on(ev.ANCHOR_CHANGED,this._syncAnchorPoint,this)}onDisable(){this.node.off(ev.ANCHOR_CHANGED,this._syncAnchorPoint,this)}_applyFile(){const t=[],e={},i=this._tmxFile;if(i){let n=i.spriteFrameNames;const s=i.spriteFrameSizes,r=i.spriteFrames,o={},a={};for(let i=0;i<n.length;++i){const l=n[i];a[l]=s[i],t[i]=r[i];const c=t[i];c&&(e[c.name]=c,o[l]=c)}const l={},c=i.imageLayerSpriteFrame;n=i.imageLayerSpriteFrameNames;for(let t=0;t<c.length;++t)l[n[t]]=c[t];const h=i.tsxFileNames,_=i.tsxFiles,u={};for(let t=0;t<h.length;++t)h[t].length>0&&(u[h[t]]=_[t].text);const m=new tit(i.tmxXmlStr,u,o,a,l),p=m.getTilesets();p&&0!==p.length||b(7241),this._buildWithMapInfo(m)}else this._releaseMapInfo()}_releaseMapInfo(){const t=this._layers;for(let e=0,i=t.length;e<i;e++)t[e].node.removeFromParent(),t[e].node.destroy();t.length=0;const e=this._groups;for(let t=0,i=e.length;t<i;t++)e[t].node.removeFromParent(),e[t].node.destroy();e.length=0;const i=this._images;for(let t=0,e=i.length;t<e;t++)i[t].removeFromParent(),i[t].destroy();i.length=0}_syncAnchorPoint(){const t=this.node._uiProps.uiTransformComp.anchorPoint,e=this.node._uiProps.uiTransformComp.width*t.x,i=this.node._uiProps.uiTransformComp.height*(1-t.y);let n,s;for(n=0,s=this._layers.length;n<s;n++)this._layers[n].node._uiProps.uiTransformComp.setAnchorPoint(t);for(n=0,s=this._groups.length;n<s;n++){const t=this._groups[n],s=t.node._uiProps.uiTransformComp;s.anchorX=.5,s.anchorY=.5;const r=t.offset.x-e+s.width*s.anchorX,o=t.offset.y+i-s.height*s.anchorY;t.node.setPosition(r,o)}for(n=0,s=this._images.length;n<s;n++){const t=this._images[n]._uiProps.uiTransformComp;t.anchorX=.5,t.anchorY=.5;const s=this._images[n]._offset.x-e+t.width*t.anchorX,r=this._images[n]._offset.y+i-t.height*t.anchorY;this._images[n].setPosition(s,r)}}_fillAniGrids(t,e){for(const i of e.keys()){const n=e.get(i);if(!n)continue;const s=n.frames;for(let e=0;e<s.length;e++){const i=s[e];i.grid=t.get(i.tileid)}}}_buildLayerAndGroup(){const t=this._tilesets,e=this._texGrids,i=this._animations;e.clear();for(let i=0,n=t.length;i<n;++i){const n=t[i];n&&(n.sourceImage?dit(n,e,n.sourceImage):console.warn(`Can't find the spriteFrame of tilesets ${i}`))}this._fillAniGrids(e,i);let n=this._layers,s=this._groups,r=this._images;const o={};for(let t=0,e=n.length;t<e;t++)o[n[t].node.name]=!0;for(let t=0,e=s.length;t<e;t++)o[s[t].node.name]=!0;for(let t=0,e=r.length;t<e;t++)o[r[t].name]=!0;n=this._layers=[],s=this._groups=[],r=this._images=[];const a=this._mapInfo,l=this.node,c=a.getAllChildren(),h=this._textures;let _=0,u=0;if(c&&c.length>0)for(let i=0,m=c.length;i<m;i++){const m=c[i],p=m.name;let d=this.node.getChildByName(p);if(o[p]=!1,d||(d=new Yv,d.name=p,d.layer=l.layer,l.addChild(d)),d.setSiblingIndex(i),d.active=m.visible,m instanceof Yet){let i=d.getComponent(Cit);i||(i=d.addComponent(Cit)),i.init(m,a,t,h,e),i.enableCulling=this._enableCulling,m.ownTiles=!1,n.push(i)}else if(m instanceof Xet){let t=d.getComponent(Rit);t||(t=d.addComponent(Rit)),t._init(m,a,e),s.push(t)}else if(m instanceof Ket){const t=m.sourceImage;d.layerInfo=m,d._offset=new tn(m.offset.x,-m.offset.y);let e=d.getComponent(HU);e||(e=d.addComponent(HU)),e.color.a*=m.opacity,e.spriteFrame=t,d._uiProps.uiTransformComp.setContentSize(t.width,t.height),r.push(d)}_=Math.max(_,d._uiProps.uiTransformComp.width),u=Math.max(u,d._uiProps.uiTransformComp.height)}const m=l.children;for(let t=0,e=m.length;t<e;t++){const e=m[t];o[e.name]&&e.destroy()}this.node._uiProps.uiTransformComp.setContentSize(_,u),this._syncAnchorPoint()}_buildWithMapInfo(t){this._mapInfo=t,this._mapSize=t.getMapSize(),this._tileSize=t.getTileSize(),this._mapOrientation=t.orientation,this._properties=t.properties,this._tileProperties=t.getTileProperties(),this._imageLayers=t.getImageLayers(),this._animations=t.getTileAnimations(),this._tilesets=t.getTilesets();const e=this._tilesets;this._textures.length=0;const i=[];for(let t=0,n=e.length;t<n;++t){const n=e[t];n&&n.sourceImage&&(this._textures[t]=n.sourceImage,i.push(n.sourceImage))}for(let t=0;t<this._imageLayers.length;t++){const e=this._imageLayers[t];e&&e.sourceImage&&i.push(e.sourceImage)}this._buildLayerAndGroup(),this.cleanupImageCache&&this._textures.forEach((t=>{this.doCleanupImageCache(t)}))}doCleanupImageCache(t){t._image instanceof HTMLImageElement?(t._image.src="",t._image.destroy()):yn.capabilities.imageBitmap&&t._image instanceof ImageBitmap&&t._image.close&&t._image.close(),t._image=null}update(t){const e=this._animations,i=this._texGrids;for(const n of e.keys()){const s=e.get(n),r=s.frames;let o=r[s.frameIdx];s.dt+=t,o.duration<s.dt&&(s.dt=0,s.frameIdx++,s.frameIdx>=r.length&&(s.frameIdx=0),o=r[s.frameIdx]),i.set(n,o.grid)}for(const t of this.getLayers())t.hasAnimation()&&t.markForUpdateRenderData()}},lnt.Orientation=pet,lnt.Property=det,lnt.TileFlag=fet,lnt.StaggerAxis=get,lnt.StaggerIndex=yet,lnt.TMXObjectType=xet,lnt.RenderOrder=vet,rnt=wl((snt=cnt).prototype,"_tmxFile",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wl(snt.prototype,"tmxAsset",[ent,int],Object.getOwnPropertyDescriptor(snt.prototype,"tmxAsset"),snt.prototype),ont=wl(snt.prototype,"_enableCulling",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(snt.prototype,"enableCulling",[ic],Object.getOwnPropertyDescriptor(snt.prototype,"enableCulling"),snt.prototype),ant=wl(snt.prototype,"cleanupImageCache",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nnt=snt))||nnt)||nnt)||nnt)||nnt)||nnt));const hnt=Math.ceil(10922.5),_nt=[];for(let t=0;t<4;t++)_nt.push(new Ni);const unt=new $i,mnt=new Ni,pnt={row:0,col:0};let dnt,fnt,gnt={x:0,y:0},ynt={x:0,y:0},vnt={x:0,y:0},xnt={x:0,y:0},bnt=0,Snt=0,Ant=0,Cnt=0;const Tnt={createData(t){const e=t.requestMeshRenderData();return t.rightTop.col*t.rightTop.row*4>65535&&console.error("Vertex count exceeds 65535"),e},updateRenderData(t,e){t.updateCulling();const i=t.requestMeshRenderData();if(Ant=t.leftDownToCenterX,Cnt=t.leftDownToCenterY,dnt=i,t.colorChanged||t.isCullingDirty()||t.isUserNodeDirty()||t.hasAnimation()||t.hasTiledNode()){let e,i;if(t.colorChanged=!1,t.destroyRenderData(),t.enableCulling){const n=t.cullingRect;e=n.leftDown,i=n.rightTop}else e=pnt,i=t.rightTop;switch(t.renderOrder){case vet.RightDown:Pnt(e,i,-1,1,t);break;case vet.LeftDown:Pnt(e,i,-1,-1,t);break;case vet.RightUp:Pnt(e,i,1,1,t);break;case vet.LeftUp:default:Pnt(e,i,1,-1,t)}t.setCullingDirty(!1),t.setUserNodeDirty(!1)}dnt=null},updateColor(t){const e=t.color,i=new Float32Array(4);i[0]=e.r/255,i[1]=e.g/255,i[2]=e.b/255,i[0]=e.a/255;const n=t.meshRenderDataArray;if(n)for(const t of n){if(!t.renderData)continue;const e=t.renderData,n=e.vData;for(let t=e.vertexStart,s=e.vertexCount;t<s;t++)n.set(i,9*t+5)}},fillBuffers(t,e){if(!t||!t.meshRenderDataArray)return;const i=t.meshRenderDataArray,n=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;const l=i[t._meshRenderDataArrayIdx].renderData;s.request(l.vertexCount,l.indicesCount)||(s=e.currBufferBatch,r=0,o=0,a=0);const c=s.vData,h=s.iData,_=n.worldMatrix,u=l.vData,m=l.vertexStart;c.set(u.slice(m,m+9*l.vertexCount),r);for(let t=0;t<l.vertexCount;t++){const e=r+9*t;mnt.set(c[e],c[e+1],c[e+2]),mnt.transformMat4(_),c[e]=mnt.x,c[e+1]=mnt.y,c[e+2]=mnt.z}const p=l.vertexCount/4;for(let t=0;t<p;t+=1)h[o]=a,h[o+1]=a+1,h[o+2]=a+2,h[o+3]=a+2,h[o+4]=a+1,h[o+5]=a+3,o+=6,a+=4}};function wnt(t,e){let i;t._rotated?(gnt.x=t.r,gnt.y=t.t,ynt.x=t.l,ynt.y=t.t,vnt.x=t.r,vnt.y=t.b,xnt.x=t.l,xnt.y=t.b):(gnt.x=t.l,gnt.y=t.t,ynt.x=t.l,ynt.y=t.b,vnt.x=t.r,vnt.y=t.t,xnt.x=t.r,xnt.y=t.b),(e&fet.DIAGONAL)>>>0&&(i=ynt,ynt=vnt,vnt=i),(e&fet.HORIZONTAL)>>>0&&(i=gnt,gnt=vnt,vnt=i,i=ynt,ynt=xnt,xnt=i),(e&fet.VERTICAL)>>>0&&(i=gnt,gnt=ynt,ynt=i,i=vnt,vnt=xnt,xnt=i)}function Ent(t,e,i){t||(t=e.texture),dnt.texture||(dnt.texture=t),dnt=i.requestMeshRenderData(),dnt.texture=e.texture}function Pnt(t,e,i,n,s){if(!dnt||e.row<0||e.col<0)return;dnt.renderData||(dnt=s.requestMeshRenderData());let r=dnt.renderData.vData;bnt=0,Snt=0;const o=s.tiledTiles,a=s.texGrids,l=s.tiles,c=s.vertices;let h,_,u,m,p,d,f,g,y,v=0,x=0,b=0,S=0,A=0,C=null,T=0,w=!0;fnt=wnt;const E=new Float32Array(4);for(E[0]=s.color.r/255,E[1]=s.color.g/255,E[2]=s.color.b/255,E[3]=s.color.a/255,-1===i?(m=e.row,p=t.row):(m=t.row,p=e.row);(p-m)*i>=0;m+=i)for(h=c[m],T=s.getNodesCountByRow(m),w=h&&0===T,1===n?(_=w&&t.col<h.minCol?h.minCol:t.col,u=w&&e.col>h.maxCol?h.maxCol:e.col):(_=w&&e.col>h.maxCol?h.maxCol:e.col,u=w&&t.col<h.minCol?h.minCol:t.col);(u-_)*n>=0;_+=n){if(d=h&&h[_],T>0){const t=s.requestSubNodesData(),e=s.getNodesByRowCol(m,_);e&&e.count>0&&(t.subNodes=s.getNodesByRowCol(m,_).list,C=null,dnt=s.requestMeshRenderData())}d&&(v=l[d.index],g=a.get((v&fet.FLIPPED_MASK)>>>0),g&&(C!==g.texture&&(Ent(C,g,s),C=g.texture),f=g.tileset._tileSize,x=d.left-Ant,b=d.bottom-Cnt,S=x+f.width,A=b+f.height,y=o[d.index],dnt.renderData.reserve(4,0),Snt=9*dnt.renderData.vertexCount,r=dnt.renderData.vData,y?y.node.active&&Dnt(y.node,E,r,x,S,A,b,!1):(r[Snt]=x,r[Snt+1]=A,r[Snt+9]=x,r[Snt+9+1]=b,r[Snt+18]=S,r[Snt+18+1]=A,r[Snt+27]=S,r[Snt+27+1]=b,r.set(E,Snt+5),r.set(E,Snt+9+5),r.set(E,Snt+18+5),r.set(E,Snt+27+5)),fnt(g,v),r[Snt+3]=gnt.x,r[Snt+4]=gnt.y,r[Snt+9+3]=ynt.x,r[Snt+9+4]=ynt.y,r[Snt+18+3]=vnt.x,r[Snt+18+4]=vnt.y,r[Snt+27+3]=xnt.x,r[Snt+27+4]=xnt.y,bnt++,dnt.renderData.advance(4,6),bnt>=hnt&&(Ent(C,g,s),C=g.texture)))}}function Dnt(t,e,i,n,s,r,o,a){const l=18,c=27;t.updateWorldTransform(),$i.fromRTS(unt,t.getRotation(),t.getPosition(),t.getScale()),Ni.set(mnt,-(n+Ant),-(o+Cnt),0),$i.transform(unt,unt,mnt);const h=unt,_=h.m12,u=h.m13,m=h.m00,p=h.m01,d=h.m04,f=h.m05,g=1===m&&0===p&&0===d&&1===f;if(a){const t=(n+s)/2,e=(r+o)/2;g?(i[Snt]=t+_,i[Snt+1]=r+u,i[Snt+9]=n+_,i[Snt+9+1]=e+u,i[Snt+l]=s+_,i[Snt+l+1]=e+u,i[Snt+c]=t+_,i[Snt+c+1]=o+u):(i[Snt]=t*m+r*d+_,i[Snt+1]=t*p+r*f+u,i[Snt+9]=n*m+e*d+_,i[Snt+9+1]=n*p+e*f+u,i[Snt+l]=s*m+e*d+_,i[Snt+l+1]=s*p+e*f+u,i[Snt+c]=t*m+o*d+_,i[Snt+c+1]=t*p+o*f+u)}else g?(i[Snt]=n+_,i[Snt+1]=r+u,i[Snt+9]=n+_,i[Snt+9+1]=o+u,i[Snt+l]=s+_,i[Snt+l+1]=r+u,i[Snt+c]=s+_,i[Snt+c+1]=o+u):(i[Snt]=n*m+r*d+_,i[Snt+1]=n*p+r*f+u,i[Snt+9]=n*m+o*d+_,i[Snt+9+1]=n*p+o*f+u,i[Snt+l]=s*m+r*d+_,i[Snt+l+1]=s*p+r*f+u,i[Snt+c]=s*m+o*d+_,i[Snt+c+1]=s*p+o*f+u);i.set(e,Snt+5),i.set(e,Snt+9+5),i.set(e,Snt+l+5),i.set(e,Snt+c+5)}const Int=t("tiledLayerAssembler",{getAssembler:()=>Tnt});Cit.Assembler=Int;class Rnt{constructor(){this.start=void 0,this.interrupt=void 0,this.end=void 0,this.dispose=void 0,this.complete=void 0,this.event=void 0}static getListeners(t){return t.listener||(t.listener=new Rnt),t.listener}}var Mnt,Ont,Bnt=(Mnt=function(t,e){return(Mnt=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])})(t,e)},function(t,e){function i(){this.constructor=t}Mnt(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});!function(t){var e,i,n,s=function(){function t(t,e,i){if(null==t)throw new Error("name cannot be null.");if(null==e)throw new Error("timelines cannot be null.");this.name=t,this.timelines=e,this.timelineIds=[];for(var n=0;n<e.length;n++)this.timelineIds[e[n].getPropertyId()]=!0;this.duration=i}return t.prototype.hasTimeline=function(t){return 1==this.timelineIds[t]},t.prototype.apply=function(t,e,i,n,s,r,o,a){if(null==t)throw new Error("skeleton cannot be null.");n&&0!=this.duration&&(i%=this.duration,e>0&&(e%=this.duration));for(var l=this.timelines,c=0,h=l.length;c<h;c++)l[c].apply(t,e,i,s,r,o,a)},t.binarySearch=function(t,e,i){void 0===i&&(i=1);var n=0,s=t.length/i-2;if(0==s)return i;for(var r=s>>>1;;){if(t[(r+1)*i]<=e?n=r+1:s=r,n==s)return(n+1)*i;r=n+s>>>1}},t.linearSearch=function(t,e,i){for(var n=0,s=t.length-i;n<=s;n+=i)if(t[n]>e)return n;return-1},t}();t.Animation=s,function(t){t[t.setup=0]="setup",t[t.first=1]="first",t[t.replace=2]="replace",t[t.add=3]="add"}(e=t.MixBlend||(t.MixBlend={})),function(t){t[t.mixIn=0]="mixIn",t[t.mixOut=1]="mixOut"}(i=t.MixDirection||(t.MixDirection={})),function(t){t[t.rotate=0]="rotate",t[t.translate=1]="translate",t[t.scale=2]="scale",t[t.shear=3]="shear",t[t.attachment=4]="attachment",t[t.color=5]="color",t[t.deform=6]="deform",t[t.event=7]="event",t[t.drawOrder=8]="drawOrder",t[t.ikConstraint=9]="ikConstraint",t[t.transformConstraint=10]="transformConstraint",t[t.pathConstraintPosition=11]="pathConstraintPosition",t[t.pathConstraintSpacing=12]="pathConstraintSpacing",t[t.pathConstraintMix=13]="pathConstraintMix",t[t.twoColor=14]="twoColor"}(n=t.TimelineType||(t.TimelineType={}));var r=function(){function e(i){if(i<=0)throw new Error("frameCount must be > 0: "+i);this.curves=t.Utils.newFloatArray((i-1)*e.BEZIER_SIZE)}return e.prototype.getFrameCount=function(){return this.curves.length/e.BEZIER_SIZE+1},e.prototype.setLinear=function(t){this.curves[t*e.BEZIER_SIZE]=e.LINEAR},e.prototype.setStepped=function(t){this.curves[t*e.BEZIER_SIZE]=e.STEPPED},e.prototype.getCurveType=function(t){var i=t*e.BEZIER_SIZE;if(i==this.curves.length)return e.LINEAR;var n=this.curves[i];return n==e.LINEAR?e.LINEAR:n==e.STEPPED?e.STEPPED:e.BEZIER},e.prototype.setCurve=function(t,i,n,s,r){var o=.03*(2*-i+s),a=.03*(2*-n+r),l=.006*(3*(i-s)+1),c=.006*(3*(n-r)+1),h=2*o+l,_=2*a+c,u=.3*i+o+.16666667*l,m=.3*n+a+.16666667*c,p=t*e.BEZIER_SIZE,d=this.curves;d[p++]=e.BEZIER;for(var f=u,g=m,y=p+e.BEZIER_SIZE-1;p<y;p+=2)d[p]=f,d[p+1]=g,u+=h,m+=_,h+=l,_+=c,f+=u,g+=m},e.prototype.getCurvePercent=function(i,n){n=t.MathUtils.clamp(n,0,1);var s=this.curves,r=i*e.BEZIER_SIZE,o=s[r];if(o==e.LINEAR)return n;if(o==e.STEPPED)return 0;for(var a=0,l=++r,c=r+e.BEZIER_SIZE-1;r<c;r+=2)if((a=s[r])>=n){var h=void 0,_=void 0;return r==l?(h=0,_=0):(h=s[r-2],_=s[r-1]),_+(s[r+1]-_)*(n-h)/(a-h)}var u=s[r-1];return u+(1-u)*(n-a)/(1-a)},e.LINEAR=0,e.STEPPED=1,e.BEZIER=2,e.BEZIER_SIZE=19,e}();t.CurveTimeline=r;var o=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e<<1),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.rotate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i){t<<=1,this.frames[t]=e,this.frames[t+r.ROTATION]=i},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return void(h.rotation=h.data.rotation);case e.first:var _=h.data.rotation-h.rotation;h.rotation+=(_-360*(16384-(16384.499999999996-_/360|0)))*a}else if(n>=c[c.length-r.ENTRIES]){var u=c[c.length+r.PREV_ROTATION];switch(l){case e.setup:h.rotation=h.data.rotation+u*a;break;case e.first:case e.replace:u+=h.data.rotation-h.rotation,u-=360*(16384-(16384.499999999996-u/360|0));case e.add:h.rotation+=u*a}}else{var m=s.binarySearch(c,n,r.ENTRIES),p=c[m+r.PREV_ROTATION],d=c[m],f=this.getCurvePercent((m>>1)-1,1-(n-d)/(c[m+r.PREV_TIME]-d)),g=c[m+r.ROTATION]-p;switch(g=p+(g-360*(16384-(16384.499999999996-g/360|0)))*f,l){case e.setup:h.rotation=h.data.rotation+(g-360*(16384-(16384.499999999996-g/360|0)))*a;break;case e.first:case e.replace:g+=h.data.rotation-h.rotation;case e.add:h.rotation+=(g-360*(16384-(16384.499999999996-g/360|0)))*a}}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_ROTATION=-1,r.ROTATION=1,r}(r);t.RotateTimeline=o;var a=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.translate<<24)+this.boneIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.X]=i,this.frames[t+r.Y]=n},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return h.x=h.data.x,void(h.y=h.data.y);case e.first:h.x+=(h.data.x-h.x)*a,h.y+=(h.data.y-h.y)*a}else{var _=0,u=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_X],u=c[c.length+r.PREV_Y];else{var m=s.binarySearch(c,n,r.ENTRIES);_=c[m+r.PREV_X],u=c[m+r.PREV_Y];var p=c[m],d=this.getCurvePercent(m/r.ENTRIES-1,1-(n-p)/(c[m+r.PREV_TIME]-p));_+=(c[m+r.X]-_)*d,u+=(c[m+r.Y]-u)*d}switch(l){case e.setup:h.x=h.data.x+_*a,h.y=h.data.y+u*a;break;case e.first:case e.replace:h.x+=(h.data.x+_-h.x)*a,h.y+=(h.data.y+u-h.y)*a;break;case e.add:h.x+=_*a,h.y+=u*a}}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_X=-2,r.PREV_Y=-1,r.X=1,r.Y=2,r}(r);t.TranslateTimeline=a;var l=function(r){function o(t){return r.call(this,t)||this}return Bnt(o,r),o.prototype.getPropertyId=function(){return(n.scale<<24)+this.boneIndex},o.prototype.apply=function(n,r,a,l,c,h,_){var u=this.frames,m=n.bones[this.boneIndex];if(m.active)if(a<u[0])switch(h){case e.setup:return m.scaleX=m.data.scaleX,void(m.scaleY=m.data.scaleY);case e.first:m.scaleX+=(m.data.scaleX-m.scaleX)*c,m.scaleY+=(m.data.scaleY-m.scaleY)*c}else{var p=0,d=0;if(a>=u[u.length-o.ENTRIES])p=u[u.length+o.PREV_X]*m.data.scaleX,d=u[u.length+o.PREV_Y]*m.data.scaleY;else{var f=s.binarySearch(u,a,o.ENTRIES);p=u[f+o.PREV_X],d=u[f+o.PREV_Y];var g=u[f],y=this.getCurvePercent(f/o.ENTRIES-1,1-(a-g)/(u[f+o.PREV_TIME]-g));p=(p+(u[f+o.X]-p)*y)*m.data.scaleX,d=(d+(u[f+o.Y]-d)*y)*m.data.scaleY}if(1==c)h==e.add?(m.scaleX+=p-m.data.scaleX,m.scaleY+=d-m.data.scaleY):(m.scaleX=p,m.scaleY=d);else{var v=0,x=0;if(_==i.mixOut)switch(h){case e.setup:v=m.data.scaleX,x=m.data.scaleY,m.scaleX=v+(Math.abs(p)*t.MathUtils.signum(v)-v)*c,m.scaleY=x+(Math.abs(d)*t.MathUtils.signum(x)-x)*c;break;case e.first:case e.replace:v=m.scaleX,x=m.scaleY,m.scaleX=v+(Math.abs(p)*t.MathUtils.signum(v)-v)*c,m.scaleY=x+(Math.abs(d)*t.MathUtils.signum(x)-x)*c;break;case e.add:v=m.scaleX,x=m.scaleY,m.scaleX=v+(Math.abs(p)*t.MathUtils.signum(v)-m.data.scaleX)*c,m.scaleY=x+(Math.abs(d)*t.MathUtils.signum(x)-m.data.scaleY)*c}else switch(h){case e.setup:v=Math.abs(m.data.scaleX)*t.MathUtils.signum(p),x=Math.abs(m.data.scaleY)*t.MathUtils.signum(d),m.scaleX=v+(p-v)*c,m.scaleY=x+(d-x)*c;break;case e.first:case e.replace:v=Math.abs(m.scaleX)*t.MathUtils.signum(p),x=Math.abs(m.scaleY)*t.MathUtils.signum(d),m.scaleX=v+(p-v)*c,m.scaleY=x+(d-x)*c;break;case e.add:v=t.MathUtils.signum(p),x=t.MathUtils.signum(d),m.scaleX=Math.abs(m.scaleX)*v+(p-Math.abs(m.data.scaleX)*v)*c,m.scaleY=Math.abs(m.scaleY)*x+(d-Math.abs(m.data.scaleY)*x)*c}}}},o}(a);t.ScaleTimeline=l;var c=function(t){function i(e){return t.call(this,e)||this}return Bnt(i,t),i.prototype.getPropertyId=function(){return(n.shear<<24)+this.boneIndex},i.prototype.apply=function(t,n,r,o,a,l){var c=this.frames,h=t.bones[this.boneIndex];if(h.active)if(r<c[0])switch(l){case e.setup:return h.shearX=h.data.shearX,void(h.shearY=h.data.shearY);case e.first:h.shearX+=(h.data.shearX-h.shearX)*a,h.shearY+=(h.data.shearY-h.shearY)*a}else{var _=0,u=0;if(r>=c[c.length-i.ENTRIES])_=c[c.length+i.PREV_X],u=c[c.length+i.PREV_Y];else{var m=s.binarySearch(c,r,i.ENTRIES);_=c[m+i.PREV_X],u=c[m+i.PREV_Y];var p=c[m],d=this.getCurvePercent(m/i.ENTRIES-1,1-(r-p)/(c[m+i.PREV_TIME]-p));_+=(c[m+i.X]-_)*d,u+=(c[m+i.Y]-u)*d}switch(l){case e.setup:h.shearX=h.data.shearX+_*a,h.shearY=h.data.shearY+u*a;break;case e.first:case e.replace:h.shearX+=(h.data.shearX+_-h.shearX)*a,h.shearY+=(h.data.shearY+u-h.shearY)*a;break;case e.add:h.shearX+=_*a,h.shearY+=u*a}}},i}(a);t.ShearTimeline=c;var h=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.color<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o},r.prototype.apply=function(t,i,n,o,a,l){var c=t.slots[this.slotIndex];if(c.bone.active){var h=this.frames;if(n<h[0])switch(l){case e.setup:return void c.color.setFromColor(c.data.color);case e.first:var _=c.color,u=c.data.color;_.add((u.r-_.r)*a,(u.g-_.g)*a,(u.b-_.b)*a,(u.a-_.a)*a)}else{var m=0,p=0,d=0,f=0;if(n>=h[h.length-r.ENTRIES]){var g=h.length;m=h[g+r.PREV_R],p=h[g+r.PREV_G],d=h[g+r.PREV_B],f=h[g+r.PREV_A]}else{var y=s.binarySearch(h,n,r.ENTRIES);m=h[y+r.PREV_R],p=h[y+r.PREV_G],d=h[y+r.PREV_B],f=h[y+r.PREV_A];var v=h[y],x=this.getCurvePercent(y/r.ENTRIES-1,1-(n-v)/(h[y+r.PREV_TIME]-v));m+=(h[y+r.R]-m)*x,p+=(h[y+r.G]-p)*x,d+=(h[y+r.B]-d)*x,f+=(h[y+r.A]-f)*x}1==a?c.color.set(m,p,d,f):(_=c.color,l==e.setup&&_.setFromColor(c.data.color),_.add((m-_.r)*a,(p-_.g)*a,(d-_.b)*a,(f-_.a)*a))}}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_R=-4,r.PREV_G=-3,r.PREV_B=-2,r.PREV_A=-1,r.R=1,r.G=2,r.B=3,r.A=4,r}(r);t.ColorTimeline=h;var _=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.twoColor<<24)+this.slotIndex},r.prototype.setFrame=function(t,e,i,n,s,o,a,l,c){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.R]=i,this.frames[t+r.G]=n,this.frames[t+r.B]=s,this.frames[t+r.A]=o,this.frames[t+r.R2]=a,this.frames[t+r.G2]=l,this.frames[t+r.B2]=c},r.prototype.apply=function(t,i,n,o,a,l){var c=t.slots[this.slotIndex];if(c.bone.active){var h=this.frames;if(n<h[0])switch(l){case e.setup:return c.color.setFromColor(c.data.color),void c.darkColor.setFromColor(c.data.darkColor);case e.first:var _=c.color,u=c.darkColor,m=c.data.color,p=c.data.darkColor;_.add((m.r-_.r)*a,(m.g-_.g)*a,(m.b-_.b)*a,(m.a-_.a)*a),u.add((p.r-u.r)*a,(p.g-u.g)*a,(p.b-u.b)*a,0)}else{var d=0,f=0,g=0,y=0,v=0,x=0,b=0;if(n>=h[h.length-r.ENTRIES]){var S=h.length;d=h[S+r.PREV_R],f=h[S+r.PREV_G],g=h[S+r.PREV_B],y=h[S+r.PREV_A],v=h[S+r.PREV_R2],x=h[S+r.PREV_G2],b=h[S+r.PREV_B2]}else{var A=s.binarySearch(h,n,r.ENTRIES);d=h[A+r.PREV_R],f=h[A+r.PREV_G],g=h[A+r.PREV_B],y=h[A+r.PREV_A],v=h[A+r.PREV_R2],x=h[A+r.PREV_G2],b=h[A+r.PREV_B2];var C=h[A],T=this.getCurvePercent(A/r.ENTRIES-1,1-(n-C)/(h[A+r.PREV_TIME]-C));d+=(h[A+r.R]-d)*T,f+=(h[A+r.G]-f)*T,g+=(h[A+r.B]-g)*T,y+=(h[A+r.A]-y)*T,v+=(h[A+r.R2]-v)*T,x+=(h[A+r.G2]-x)*T,b+=(h[A+r.B2]-b)*T}1==a?(c.color.set(d,f,g,y),c.darkColor.set(v,x,b,1)):(_=c.color,u=c.darkColor,l==e.setup&&(_.setFromColor(c.data.color),u.setFromColor(c.data.darkColor)),_.add((d-_.r)*a,(f-_.g)*a,(g-_.b)*a,(y-_.a)*a),u.add((v-u.r)*a,(x-u.g)*a,(b-u.b)*a,0))}}},r.ENTRIES=8,r.PREV_TIME=-8,r.PREV_R=-7,r.PREV_G=-6,r.PREV_B=-5,r.PREV_A=-4,r.PREV_R2=-3,r.PREV_G2=-2,r.PREV_B2=-1,r.R=1,r.G=2,r.B=3,r.A=4,r.R2=5,r.G2=6,r.B2=7,r}(r);t.TwoColorTimeline=_;var u=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.attachmentNames=new Array(e)}return r.prototype.getPropertyId=function(){return(n.attachment<<24)+this.slotIndex},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.attachmentNames[t]=i},r.prototype.apply=function(t,n,r,o,a,l,c){var h=t.slots[this.slotIndex];if(h.bone.active)if(c!=i.mixOut||l!=e.setup){var _=this.frames;if(r<_[0]){if(l==e.setup||l==e.first){var u=h.data.attachmentName;h.setAttachment(null==u?null:t.getAttachment(this.slotIndex,u))}}else{var m;m=r>=_[_.length-1]?_.length-1:s.binarySearch(_,r,1)-1;var p=this.attachmentNames[m];t.slots[this.slotIndex].setAttachment(null==p?null:t.getAttachment(this.slotIndex,p))}}else{var d=h.data.attachmentName;h.setAttachment(null==d?null:t.getAttachment(this.slotIndex,d))}},r}();t.AttachmentTimeline=u;var m=null,p=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e),n.frameVertices=new Array(e),null==m&&(m=t.Utils.newFloatArray(64)),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.deform<<27)+ +this.attachment.id+this.slotIndex},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.frameVertices[t]=i},r.prototype.apply=function(i,n,r,o,a,l){var c=i.slots[this.slotIndex];if(c.bone.active){var h=c.getAttachment();if(h instanceof t.VertexAttachment&&h.deformAttachment==this.attachment){var _=c.deform;0==_.length&&(l=e.setup);var u=this.frameVertices,m=u[0].length,p=this.frames;if(r<p[0]){var d=h;switch(l){case e.setup:return void(_.length=0);case e.first:if(1==a){_.length=0;break}var f=t.Utils.setArraySize(_,m);if(null==d.bones)for(var g=d.vertices,y=0;y<m;y++)f[y]+=(g[y]-f[y])*a;else for(a=1-a,y=0;y<m;y++)f[y]*=a}}else{var v=t.Utils.setArraySize(_,m);if(r>=p[p.length-1]){var x=u[p.length-1];if(1==a)if(l==e.add)if(null==(d=h).bones){g=d.vertices;for(var b=0;b<m;b++)v[b]+=x[b]-g[b]}else for(var S=0;S<m;S++)v[S]+=x[S];else t.Utils.arrayCopy(x,0,v,0,m);else switch(l){case e.setup:var A=h;if(null==A.bones){g=A.vertices;for(var C=0;C<m;C++){var T=g[C];v[C]=T+(x[C]-T)*a}}else for(var w=0;w<m;w++)v[w]=x[w]*a;break;case e.first:case e.replace:for(var E=0;E<m;E++)v[E]+=(x[E]-v[E])*a;case e.add:if(null==(d=h).bones){g=d.vertices;for(var P=0;P<m;P++)v[P]+=(x[P]-g[P])*a}else for(var D=0;D<m;D++)v[D]+=x[D]*a}}else{var I=s.binarySearch(p,r),R=u[I-1],M=u[I],O=p[I],B=this.getCurvePercent(I-1,1-(r-O)/(p[I-1]-O));if(1==a)if(l==e.add)if(null==(d=h).bones){g=d.vertices;for(var N=0;N<m;N++){var L=R[N];v[N]+=L+(M[N]-L)*B-g[N]}}else for(var F=0;F<m;F++)L=R[F],v[F]+=L+(M[F]-L)*B;else for(var z=0;z<m;z++)L=R[z],v[z]=L+(M[z]-L)*B;else switch(l){case e.setup:var V=h;if(null==V.bones){g=V.vertices;for(var U=0;U<m;U++)L=R[U],T=g[U],v[U]=T+(L+(M[U]-L)*B-T)*a}else for(var G=0;G<m;G++)L=R[G],v[G]=(L+(M[G]-L)*B)*a;break;case e.first:case e.replace:for(var k=0;k<m;k++)L=R[k],v[k]+=(L+(M[k]-L)*B-v[k])*a;break;case e.add:if(null==(d=h).bones){g=d.vertices;for(var H=0;H<m;H++)L=R[H],v[H]+=(L+(M[H]-L)*B-g[H])*a}else for(var j=0;j<m;j++)L=R[j],v[j]+=(L+(M[j]-L)*B)*a}}}}}},r}(r);t.DeformTimeline=p;var d=function(){function e(e){this.frames=t.Utils.newFloatArray(e),this.events=new Array(e)}return e.prototype.getPropertyId=function(){return n.event<<24},e.prototype.getFrameCount=function(){return this.frames.length},e.prototype.setFrame=function(t,e){this.frames[t]=e.time,this.events[t]=e},e.prototype.apply=function(t,e,i,n,r,o,a){if(null!=n){var l=this.frames,c=this.frames.length;if(e>i)this.apply(t,e,Number.MAX_VALUE,n,r,o,a),e=-1;else if(e>=l[c-1])return;if(!(i<l[0])){var h=0;if(e<l[0])h=0;else for(var _=l[h=s.binarySearch(l,e)];h>0&&l[h-1]==_;)h--;for(;h<c&&i>=l[h];h++)n.push(this.events[h])}}},e}();t.EventTimeline=d;var f=function(){function r(e){this.frames=t.Utils.newFloatArray(e),this.drawOrders=new Array(e)}return r.prototype.getPropertyId=function(){return n.drawOrder<<24},r.prototype.getFrameCount=function(){return this.frames.length},r.prototype.setFrame=function(t,e,i){this.frames[t]=e,this.drawOrders[t]=i},r.prototype.apply=function(n,r,o,a,l,c,h){var _=n.drawOrder,u=n.slots;if(h!=i.mixOut||c!=e.setup){var m=this.frames;if(o<m[0])c!=e.setup&&c!=e.first||t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length);else{var p;p=o>=m[m.length-1]?m.length-1:s.binarySearch(m,o)-1;var d=this.drawOrders[p];if(null==d)t.Utils.arrayCopy(u,0,_,0,u.length);else for(var f=0,g=d.length;f<g;f++)_[f]=u[d[f]]}}else t.Utils.arrayCopy(n.slots,0,n.drawOrder,0,n.slots.length)},r}();t.DrawOrderTimeline=f;var g=function(r){function o(e){var i=r.call(this,e)||this;return i.frames=t.Utils.newFloatArray(e*o.ENTRIES),i}return Bnt(o,r),o.prototype.getPropertyId=function(){return(n.ikConstraint<<24)+this.ikConstraintIndex},o.prototype.setFrame=function(t,e,i,n,s,r,a){t*=o.ENTRIES,this.frames[t]=e,this.frames[t+o.MIX]=i,this.frames[t+o.SOFTNESS]=n,this.frames[t+o.BEND_DIRECTION]=s,this.frames[t+o.COMPRESS]=r?1:0,this.frames[t+o.STRETCH]=a?1:0},o.prototype.apply=function(t,n,r,a,l,c,h){var _=this.frames,u=t.ikConstraints[this.ikConstraintIndex];if(u.active)if(r<_[0])switch(c){case e.setup:return u.mix=u.data.mix,u.softness=u.data.softness,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,void(u.stretch=u.data.stretch);case e.first:u.mix+=(u.data.mix-u.mix)*l,u.softness+=(u.data.softness-u.softness)*l,u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch}else if(r>=_[_.length-o.ENTRIES])c==e.setup?(u.mix=u.data.mix+(_[_.length+o.PREV_MIX]-u.data.mix)*l,u.softness=u.data.softness+(_[_.length+o.PREV_SOFTNESS]-u.data.softness)*l,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH])):(u.mix+=(_[_.length+o.PREV_MIX]-u.mix)*l,u.softness+=(_[_.length+o.PREV_SOFTNESS]-u.softness)*l,h==i.mixIn&&(u.bendDirection=_[_.length+o.PREV_BEND_DIRECTION],u.compress=0!=_[_.length+o.PREV_COMPRESS],u.stretch=0!=_[_.length+o.PREV_STRETCH]));else{var m=s.binarySearch(_,r,o.ENTRIES),p=_[m+o.PREV_MIX],d=_[m+o.PREV_SOFTNESS],f=_[m],g=this.getCurvePercent(m/o.ENTRIES-1,1-(r-f)/(_[m+o.PREV_TIME]-f));c==e.setup?(u.mix=u.data.mix+(p+(_[m+o.MIX]-p)*g-u.data.mix)*l,u.softness=u.data.softness+(d+(_[m+o.SOFTNESS]-d)*g-u.data.softness)*l,h==i.mixOut?(u.bendDirection=u.data.bendDirection,u.compress=u.data.compress,u.stretch=u.data.stretch):(u.bendDirection=_[m+o.PREV_BEND_DIRECTION],u.compress=0!=_[m+o.PREV_COMPRESS],u.stretch=0!=_[m+o.PREV_STRETCH])):(u.mix+=(p+(_[m+o.MIX]-p)*g-u.mix)*l,u.softness+=(d+(_[m+o.SOFTNESS]-d)*g-u.softness)*l,h==i.mixIn&&(u.bendDirection=_[m+o.PREV_BEND_DIRECTION],u.compress=0!=_[m+o.PREV_COMPRESS],u.stretch=0!=_[m+o.PREV_STRETCH]))}},o.ENTRIES=6,o.PREV_TIME=-6,o.PREV_MIX=-5,o.PREV_SOFTNESS=-4,o.PREV_BEND_DIRECTION=-3,o.PREV_COMPRESS=-2,o.PREV_STRETCH=-1,o.MIX=1,o.SOFTNESS=2,o.BEND_DIRECTION=3,o.COMPRESS=4,o.STRETCH=5,o}(r);t.IkConstraintTimeline=g;var y=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.transformConstraint<<24)+this.transformConstraintIndex},r.prototype.setFrame=function(t,e,i,n,s,o){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n,this.frames[t+r.SCALE]=s,this.frames[t+r.SHEAR]=o},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.transformConstraints[this.transformConstraintIndex];if(h.active)if(n<c[0]){var _=h.data;switch(l){case e.setup:return h.rotateMix=_.rotateMix,h.translateMix=_.translateMix,h.scaleMix=_.scaleMix,void(h.shearMix=_.shearMix);case e.first:h.rotateMix+=(_.rotateMix-h.rotateMix)*a,h.translateMix+=(_.translateMix-h.translateMix)*a,h.scaleMix+=(_.scaleMix-h.scaleMix)*a,h.shearMix+=(_.shearMix-h.shearMix)*a}}else{var u=0,m=0,p=0,d=0;if(n>=c[c.length-r.ENTRIES]){var f=c.length;u=c[f+r.PREV_ROTATE],m=c[f+r.PREV_TRANSLATE],p=c[f+r.PREV_SCALE],d=c[f+r.PREV_SHEAR]}else{var g=s.binarySearch(c,n,r.ENTRIES);u=c[g+r.PREV_ROTATE],m=c[g+r.PREV_TRANSLATE],p=c[g+r.PREV_SCALE],d=c[g+r.PREV_SHEAR];var y=c[g],v=this.getCurvePercent(g/r.ENTRIES-1,1-(n-y)/(c[g+r.PREV_TIME]-y));u+=(c[g+r.ROTATE]-u)*v,m+=(c[g+r.TRANSLATE]-m)*v,p+=(c[g+r.SCALE]-p)*v,d+=(c[g+r.SHEAR]-d)*v}l==e.setup?(_=h.data,h.rotateMix=_.rotateMix+(u-_.rotateMix)*a,h.translateMix=_.translateMix+(m-_.translateMix)*a,h.scaleMix=_.scaleMix+(p-_.scaleMix)*a,h.shearMix=_.shearMix+(d-_.shearMix)*a):(h.rotateMix+=(u-h.rotateMix)*a,h.translateMix+=(m-h.translateMix)*a,h.scaleMix+=(p-h.scaleMix)*a,h.shearMix+=(d-h.shearMix)*a)}},r.ENTRIES=5,r.PREV_TIME=-5,r.PREV_ROTATE=-4,r.PREV_TRANSLATE=-3,r.PREV_SCALE=-2,r.PREV_SHEAR=-1,r.ROTATE=1,r.TRANSLATE=2,r.SCALE=3,r.SHEAR=4,r}(r);t.TransformConstraintTimeline=y;var v=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintPosition<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.VALUE]=i},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return void(h.position=h.data.position);case e.first:h.position+=(h.data.position-h.position)*a}else{var _=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_VALUE];else{var u=s.binarySearch(c,n,r.ENTRIES);_=c[u+r.PREV_VALUE];var m=c[u],p=this.getCurvePercent(u/r.ENTRIES-1,1-(n-m)/(c[u+r.PREV_TIME]-m));_+=(c[u+r.VALUE]-_)*p}l==e.setup?h.position=h.data.position+(_-h.data.position)*a:h.position+=(_-h.position)*a}},r.ENTRIES=2,r.PREV_TIME=-2,r.PREV_VALUE=-1,r.VALUE=1,r}(r);t.PathConstraintPositionTimeline=v;var x=function(t){function i(e){return t.call(this,e)||this}return Bnt(i,t),i.prototype.getPropertyId=function(){return(n.pathConstraintSpacing<<24)+this.pathConstraintIndex},i.prototype.apply=function(t,n,r,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(r<c[0])switch(l){case e.setup:return void(h.spacing=h.data.spacing);case e.first:h.spacing+=(h.data.spacing-h.spacing)*a}else{var _=0;if(r>=c[c.length-i.ENTRIES])_=c[c.length+i.PREV_VALUE];else{var u=s.binarySearch(c,r,i.ENTRIES);_=c[u+i.PREV_VALUE];var m=c[u],p=this.getCurvePercent(u/i.ENTRIES-1,1-(r-m)/(c[u+i.PREV_TIME]-m));_+=(c[u+i.VALUE]-_)*p}l==e.setup?h.spacing=h.data.spacing+(_-h.data.spacing)*a:h.spacing+=(_-h.spacing)*a}},i}(v);t.PathConstraintSpacingTimeline=x;var b=function(i){function r(e){var n=i.call(this,e)||this;return n.frames=t.Utils.newFloatArray(e*r.ENTRIES),n}return Bnt(r,i),r.prototype.getPropertyId=function(){return(n.pathConstraintMix<<24)+this.pathConstraintIndex},r.prototype.setFrame=function(t,e,i,n){t*=r.ENTRIES,this.frames[t]=e,this.frames[t+r.ROTATE]=i,this.frames[t+r.TRANSLATE]=n},r.prototype.apply=function(t,i,n,o,a,l){var c=this.frames,h=t.pathConstraints[this.pathConstraintIndex];if(h.active)if(n<c[0])switch(l){case e.setup:return h.rotateMix=h.data.rotateMix,void(h.translateMix=h.data.translateMix);case e.first:h.rotateMix+=(h.data.rotateMix-h.rotateMix)*a,h.translateMix+=(h.data.translateMix-h.translateMix)*a}else{var _=0,u=0;if(n>=c[c.length-r.ENTRIES])_=c[c.length+r.PREV_ROTATE],u=c[c.length+r.PREV_TRANSLATE];else{var m=s.binarySearch(c,n,r.ENTRIES);_=c[m+r.PREV_ROTATE],u=c[m+r.PREV_TRANSLATE];var p=c[m],d=this.getCurvePercent(m/r.ENTRIES-1,1-(n-p)/(c[m+r.PREV_TIME]-p));_+=(c[m+r.ROTATE]-_)*d,u+=(c[m+r.TRANSLATE]-u)*d}l==e.setup?(h.rotateMix=h.data.rotateMix+(_-h.data.rotateMix)*a,h.translateMix=h.data.translateMix+(u-h.data.translateMix)*a):(h.rotateMix+=(_-h.rotateMix)*a,h.translateMix+=(u-h.translateMix)*a)}},r.ENTRIES=3,r.PREV_TIME=-3,r.PREV_ROTATE=-2,r.PREV_TRANSLATE=-1,r.ROTATE=1,r.TRANSLATE=2,r}(r);t.PathConstraintMixTimeline=b}(Ont||(Ont={})),function(t){var e=function(){function e(e){this.tracks=new Array,this.timeScale=1,this.events=new Array,this.listeners=new Array,this.queue=new s(this),this.propertyIDs=new t.IntSet,this.animationsChanged=!1,this.trackEntryPool=new t.Pool((function(){return new i})),this.data=e}return e.prototype.update=function(t){t*=this.timeScale;for(var e=this.tracks,i=0,n=e.length;i<n;i++){var s=e[i];if(null!=s){s.animationLast=s.nextAnimationLast,s.trackLast=s.nextTrackLast;var r=t*s.timeScale;if(s.delay>0){if(s.delay-=r,s.delay>0)continue;r=-s.delay,s.delay=0}var o=s.next;if(null!=o){var a=s.trackLast-o.delay;if(a>=0){for(o.delay=0,o.trackTime+=0==s.timeScale?0:(a/s.timeScale+t)*o.timeScale,s.trackTime+=r,this.setCurrent(i,o,!0);null!=o.mixingFrom;)o.mixTime+=t,o=o.mixingFrom;continue}}else if(s.trackLast>=s.trackEnd&&null==s.mixingFrom){e[i]=null,this.queue.end(s),this.disposeNext(s);continue}if(null!=s.mixingFrom&&this.updateMixingFrom(s,t)){var l=s.mixingFrom;for(s.mixingFrom=null,null!=l&&(l.mixingTo=null);null!=l;)this.queue.end(l),l=l.mixingFrom}s.trackTime+=r}}this.queue.drain()},e.prototype.updateMixingFrom=function(t,e){var i=t.mixingFrom;if(null==i)return!0;var n=this.updateMixingFrom(i,e);return i.animationLast=i.nextAnimationLast,i.trackLast=i.nextTrackLast,t.mixTime>0&&t.mixTime>=t.mixDuration?(0!=i.totalAlpha&&0!=t.mixDuration||(t.mixingFrom=i.mixingFrom,null!=i.mixingFrom&&(i.mixingFrom.mixingTo=t),t.interruptAlpha=i.interruptAlpha,this.queue.end(i)),n):(i.trackTime+=e*i.timeScale,t.mixTime+=e,!1)},e.prototype.apply=function(i){if(null==i)throw new Error("skeleton cannot be null.");this.animationsChanged&&this._animationsChanged();for(var n=this.events,s=this.tracks,r=!1,o=0,a=s.length;o<a;o++){var l=s[o];if(!(null==l||l.delay>0)){r=!0;var c=0==o?t.MixBlend.first:l.mixBlend,h=l.alpha;null!=l.mixingFrom?h*=this.applyMixingFrom(l,i,c):l.trackTime>=l.trackEnd&&null==l.next&&(h=0);var _=l.animationLast,u=l.getAnimationTime(),m=l.animation.timelines.length,p=l.animation.timelines;if(0==o&&1==h||c==t.MixBlend.add)for(var d=0;d<m;d++)t.Utils.webkit602BugfixHelper(h,c),p[d].apply(i,_,u,n,h,c,t.MixDirection.mixIn);else{var f=l.timelineMode,g=0==l.timelinesRotation.length;g&&t.Utils.setArraySize(l.timelinesRotation,m<<1,null);var y=l.timelinesRotation;for(d=0;d<m;d++){var v=p[d],x=(f[d]&e.NOT_LAST-1)==e.SUBSEQUENT?c:t.MixBlend.setup;v instanceof t.RotateTimeline?this.applyRotateTimeline(v,i,u,h,x,y,d<<1,g):(t.Utils.webkit602BugfixHelper(h,c),v.apply(i,_,u,n,h,x,t.MixDirection.mixIn))}}this.queueEvents(l,u),n.length=0,l.nextAnimationLast=u,l.nextTrackLast=l.trackTime}}return this.queue.drain(),r},e.prototype.applyMixingFrom=function(i,n,s){var r=i.mixingFrom;null!=r.mixingFrom&&this.applyMixingFrom(r,n,s);var o=0;0==i.mixDuration?(o=1,s==t.MixBlend.first&&(s=t.MixBlend.setup)):((o=i.mixTime/i.mixDuration)>1&&(o=1),s!=t.MixBlend.first&&(s=r.mixBlend));var a=o<r.eventThreshold?this.events:null,l=o<r.attachmentThreshold,c=o<r.drawOrderThreshold,h=r.animationLast,_=r.getAnimationTime(),u=r.animation.timelines.length,m=r.animation.timelines,p=r.alpha*i.interruptAlpha,d=p*(1-o);if(s==t.MixBlend.add)for(var f=0;f<u;f++)m[f].apply(n,h,_,a,d,s,t.MixDirection.mixOut);else{var g=r.timelineMode,y=r.timelineHoldMix,v=0==r.timelinesRotation.length;v&&t.Utils.setArraySize(r.timelinesRotation,u<<1,null);var x=r.timelinesRotation;for(r.totalAlpha=0,f=0;f<u;f++){var b=m[f],S=t.MixDirection.mixOut,A=void 0,C=0;switch(g[f]&e.NOT_LAST-1){case e.SUBSEQUENT:if(A=s,!l&&b instanceof t.AttachmentTimeline){if((g[f]&e.NOT_LAST)==e.NOT_LAST)continue;A=t.MixBlend.setup}if(!c&&b instanceof t.DrawOrderTimeline)continue;C=d;break;case e.FIRST:A=t.MixBlend.setup,C=d;break;case e.HOLD:A=t.MixBlend.setup,C=p;break;default:A=t.MixBlend.setup;var T=y[f];C=p*Math.max(0,1-T.mixTime/T.mixDuration)}r.totalAlpha+=C,b instanceof t.RotateTimeline?this.applyRotateTimeline(b,n,_,C,A,x,f<<1,v):(t.Utils.webkit602BugfixHelper(C,s),A==t.MixBlend.setup&&(b instanceof t.AttachmentTimeline?(l||(g[f]&e.NOT_LAST)==e.NOT_LAST)&&(S=t.MixDirection.mixIn):b instanceof t.DrawOrderTimeline&&c&&(S=t.MixDirection.mixIn)),b.apply(n,h,_,a,C,A,S))}}return i.mixDuration>0&&this.queueEvents(r,_),this.events.length=0,r.nextAnimationLast=_,r.nextTrackLast=r.trackTime,o},e.prototype.applyRotateTimeline=function(e,i,n,s,r,o,a,l){if(l&&(o[a]=0),1!=s){var c=e,h=c.frames,_=i.bones[c.boneIndex];if(_.active){var u=0,m=0;if(n<h[0])switch(r){case t.MixBlend.setup:_.rotation=_.data.rotation;default:return;case t.MixBlend.first:u=_.rotation,m=_.data.rotation}else if(u=r==t.MixBlend.setup?_.data.rotation:_.rotation,n>=h[h.length-t.RotateTimeline.ENTRIES])m=_.data.rotation+h[h.length+t.RotateTimeline.PREV_ROTATION];else{var p=t.Animation.binarySearch(h,n,t.RotateTimeline.ENTRIES),d=h[p+t.RotateTimeline.PREV_ROTATION],f=h[p],g=c.getCurvePercent((p>>1)-1,1-(n-f)/(h[p+t.RotateTimeline.PREV_TIME]-f));m=h[p+t.RotateTimeline.ROTATION]-d,m=d+(m-=360*(16384-(16384.499999999996-m/360|0)))*g+_.data.rotation,m-=360*(16384-(16384.499999999996-m/360|0))}var y=0,v=m-u;if(0==(v-=360*(16384-(16384.499999999996-v/360|0))))y=o[a];else{var x=0,b=0;l?(x=0,b=v):(x=o[a],b=o[a+1]);var S=v>0,A=x>=0;t.MathUtils.signum(b)!=t.MathUtils.signum(v)&&Math.abs(b)<=90&&(Math.abs(x)>180&&(x+=360*t.MathUtils.signum(x)),A=S),y=v+x-x%360,A!=S&&(y+=360*t.MathUtils.signum(x)),o[a]=y}o[a+1]=v,u+=y*s,_.rotation=u-360*(16384-(16384.499999999996-u/360|0))}}else e.apply(i,0,n,null,1,r,t.MixDirection.mixIn)},e.prototype.queueEvents=function(t,e){for(var i=t.animationStart,n=t.animationEnd,s=n-i,r=t.trackLast%s,o=this.events,a=0,l=o.length;a<l;a++){var c=o[a];if(c.time<r)break;c.time>n||this.queue.event(t,c)}for((t.loop?0==s||r>t.trackTime%s:e>=n&&t.animationLast<n)&&this.queue.complete(t);a<l;a++)o[a].time<i||this.queue.event(t,o[a])},e.prototype.clearTracks=function(){var t=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var e=0,i=this.tracks.length;e<i;e++)this.clearTrack(e);this.tracks.length=0,this.queue.drainDisabled=t,this.queue.drain()},e.prototype.clearTrack=function(t){if(!(t>=this.tracks.length)){var e=this.tracks[t];if(null!=e){this.queue.end(e),this.disposeNext(e);for(var i=e;;){var n=i.mixingFrom;if(null==n)break;this.queue.end(n),i.mixingFrom=null,i.mixingTo=null,i=n}this.tracks[e.trackIndex]=null,this.queue.drain()}}},e.prototype.setCurrent=function(t,e,i){var n=this.expandToIndex(t);this.tracks[t]=e,null!=n&&(i&&this.queue.interrupt(n),e.mixingFrom=n,n.mixingTo=e,e.mixTime=0,null!=n.mixingFrom&&n.mixDuration>0&&(e.interruptAlpha*=Math.min(1,n.mixTime/n.mixDuration)),n.timelinesRotation.length=0),this.queue.start(e)},e.prototype.setAnimation=function(t,e,i){var n=this.data.skeletonData.findAnimation(e);if(null==n)throw new Error("Animation not found: "+e);return this.setAnimationWith(t,n,i)},e.prototype.setAnimationWith=function(t,e,i){if(null==e)throw new Error("animation cannot be null.");var n=!0,s=this.expandToIndex(t);null!=s&&(-1==s.nextTrackLast?(this.tracks[t]=s.mixingFrom,this.queue.interrupt(s),this.queue.end(s),this.disposeNext(s),s=s.mixingFrom,n=!1):this.disposeNext(s));var r=this.trackEntry(t,e,i,s);return this.setCurrent(t,r,n),this.queue.drain(),r},e.prototype.addAnimation=function(t,e,i,n){var s=this.data.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);return this.addAnimationWith(t,s,i,n)},e.prototype.addAnimationWith=function(t,e,i,n){if(null==e)throw new Error("animation cannot be null.");var s=this.expandToIndex(t);if(null!=s)for(;null!=s.next;)s=s.next;var r=this.trackEntry(t,e,i,s);if(null==s)this.setCurrent(t,r,!0),this.queue.drain();else if(s.next=r,n<=0){var o=s.animationEnd-s.animationStart;0!=o?(s.loop?n+=o*(1+(s.trackTime/o|0)):n+=Math.max(o,s.trackTime),n-=this.data.getMix(s.animation,e)):n=s.trackTime}return r.delay=n,r},e.prototype.setEmptyAnimation=function(t,i){var n=this.setAnimationWith(t,e.emptyAnimation,!1);return n.mixDuration=i,n.trackEnd=i,n},e.prototype.addEmptyAnimation=function(t,i,n){n<=0&&(n-=i);var s=this.addAnimationWith(t,e.emptyAnimation,!1,n);return s.mixDuration=i,s.trackEnd=i,s},e.prototype.setEmptyAnimations=function(t){var e=this.queue.drainDisabled;this.queue.drainDisabled=!0;for(var i=0,n=this.tracks.length;i<n;i++){var s=this.tracks[i];null!=s&&this.setEmptyAnimation(s.trackIndex,t)}this.queue.drainDisabled=e,this.queue.drain()},e.prototype.expandToIndex=function(e){return e<this.tracks.length?this.tracks[e]:(t.Utils.ensureArrayCapacity(this.tracks,e+1,null),this.tracks.length=e+1,null)},e.prototype.trackEntry=function(t,e,i,n){var s=this.trackEntryPool.obtain();return s.trackIndex=t,s.animation=e,s.loop=i,s.holdPrevious=!1,s.eventThreshold=0,s.attachmentThreshold=0,s.drawOrderThreshold=0,s.animationStart=0,s.animationEnd=e.duration,s.animationLast=-1,s.nextAnimationLast=-1,s.delay=0,s.trackTime=0,s.trackLast=-1,s.nextTrackLast=-1,s.trackEnd=Number.MAX_VALUE,s.timeScale=1,s.alpha=1,s.interruptAlpha=1,s.mixTime=0,s.mixDuration=null==n?0:this.data.getMix(n.animation,e),s},e.prototype.disposeNext=function(t){for(var e=t.next;null!=e;)this.queue.dispose(e),e=e.next;t.next=null},e.prototype._animationsChanged=function(){this.animationsChanged=!1,this.propertyIDs.clear();for(var e=0,i=this.tracks.length;e<i;e++)if(null!=(n=this.tracks[e])){for(;null!=n.mixingFrom;)n=n.mixingFrom;do{null!=n.mixingFrom&&n.mixBlend==t.MixBlend.add||this.computeHold(n),n=n.mixingTo}while(null!=n)}for(this.propertyIDs.clear(),e=this.tracks.length-1;e>=0;e--)for(var n=this.tracks[e];null!=n;)this.computeNotLast(n),n=n.mixingFrom},e.prototype.computeHold=function(i){var n=i.mixingTo,s=i.animation.timelines,r=i.animation.timelines.length,o=t.Utils.setArraySize(i.timelineMode,r);i.timelineHoldMix.length=0;var a=t.Utils.setArraySize(i.timelineHoldMix,r),l=this.propertyIDs;if(null!=n&&n.holdPrevious)for(var c=0;c<r;c++)l.add(s[c].getPropertyId()),o[c]=e.HOLD;else t:for(c=0;c<r;c++){var h=s[c],_=h.getPropertyId();if(l.add(_))if(null==n||h instanceof t.AttachmentTimeline||h instanceof t.DrawOrderTimeline||h instanceof t.EventTimeline||!n.animation.hasTimeline(_))o[c]=e.FIRST;else{for(var u=n.mixingTo;null!=u;u=u.mixingTo)if(!u.animation.hasTimeline(_)){if(i.mixDuration>0){o[c]=e.HOLD_MIX,a[c]=u;continue t}break}o[c]=e.HOLD}else o[c]=e.SUBSEQUENT}},e.prototype.computeNotLast=function(i){for(var n=i.animation.timelines,s=i.animation.timelines.length,r=i.timelineMode,o=this.propertyIDs,a=0;a<s;a++)if(n[a]instanceof t.AttachmentTimeline){var l=n[a];o.add(l.slotIndex)||(r[a]|=e.NOT_LAST)}},e.prototype.getCurrent=function(t){return t>=this.tracks.length?null:this.tracks[t]},e.prototype.addListener=function(t){if(null==t)throw new Error("listener cannot be null.");this.listeners.push(t)},e.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);e>=0&&this.listeners.splice(e,1)},e.prototype.clearListeners=function(){this.listeners.length=0},e.prototype.clearListenerNotifications=function(){this.queue.clear()},e.emptyAnimation=new t.Animation("<empty>",[],0),e.SUBSEQUENT=0,e.FIRST=1,e.HOLD=2,e.HOLD_MIX=3,e.NOT_LAST=4,e}();t.AnimationState=e;var i=function(){function e(){this.mixBlend=t.MixBlend.replace,this.timelineMode=new Array,this.timelineHoldMix=new Array,this.timelinesRotation=new Array}return e.prototype.reset=function(){this.next=null,this.mixingFrom=null,this.mixingTo=null,this.animation=null,this.listener=null,this.timelineMode.length=0,this.timelineHoldMix.length=0,this.timelinesRotation.length=0},e.prototype.getAnimationTime=function(){if(this.loop){var t=this.animationEnd-this.animationStart;return 0==t?this.animationStart:this.trackTime%t+this.animationStart}return Math.min(this.trackTime+this.animationStart,this.animationEnd)},e.prototype.setAnimationLast=function(t){this.animationLast=t,this.nextAnimationLast=t},e.prototype.isComplete=function(){return this.trackTime>=this.animationEnd-this.animationStart},e.prototype.resetRotationDirections=function(){this.timelinesRotation.length=0},e}();t.TrackEntry=i;var n,s=function(){function t(t){this.objects=[],this.drainDisabled=!1,this.animState=t}return t.prototype.start=function(t){this.objects.push(n.start),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.interrupt=function(t){this.objects.push(n.interrupt),this.objects.push(t)},t.prototype.end=function(t){this.objects.push(n.end),this.objects.push(t),this.animState.animationsChanged=!0},t.prototype.dispose=function(t){this.objects.push(n.dispose),this.objects.push(t)},t.prototype.complete=function(t){this.objects.push(n.complete),this.objects.push(t)},t.prototype.event=function(t,e){this.objects.push(n.event),this.objects.push(t),this.objects.push(e)},t.prototype.drain=function(){if(!this.drainDisabled){this.drainDisabled=!0;for(var t=this.objects,e=this.animState.listeners,i=0;i<t.length;i+=2){var s=t[i],r=t[i+1];switch(s){case n.start:null!=r.listener&&r.listener.start&&r.listener.start(r);for(var o=0;o<e.length;o++)e[o].start&&e[o].start(r);break;case n.interrupt:for(null!=r.listener&&r.listener.interrupt&&r.listener.interrupt(r),o=0;o<e.length;o++)e[o].interrupt&&e[o].interrupt(r);break;case n.end:for(null!=r.listener&&r.listener.end&&r.listener.end(r),o=0;o<e.length;o++)e[o].end&&e[o].end(r);case n.dispose:for(null!=r.listener&&r.listener.dispose&&r.listener.dispose(r),o=0;o<e.length;o++)e[o].dispose&&e[o].dispose(r);this.animState.trackEntryPool.free(r);break;case n.complete:for(null!=r.listener&&r.listener.complete&&r.listener.complete(r),o=0;o<e.length;o++)e[o].complete&&e[o].complete(r);break;case n.event:var a=t[2+i++];for(null!=r.listener&&r.listener.event&&r.listener.event(r,a),o=0;o<e.length;o++)e[o].event&&e[o].event(r,a)}}this.clear(),this.drainDisabled=!1}},t.prototype.clear=function(){this.objects.length=0},t}();t.EventQueue=s,function(t){t[t.start=0]="start",t[t.interrupt=1]="interrupt",t[t.end=2]="end",t[t.dispose=3]="dispose",t[t.complete=4]="complete",t[t.event=5]="event"}(n=t.EventType||(t.EventType={}));var r=function(){function t(){}return t.prototype.start=function(){},t.prototype.interrupt=function(){},t.prototype.end=function(){},t.prototype.dispose=function(){},t.prototype.complete=function(){},t.prototype.event=function(){},t}();t.AnimationStateAdapter=r}(Ont||(Ont={})),function(t){var e=function(){function t(t){if(this.animationToMixTime={},this.defaultMix=0,null==t)throw new Error("skeletonData cannot be null.");this.skeletonData=t}return t.prototype.setMix=function(t,e,i){var n=this.skeletonData.findAnimation(t);if(null==n)throw new Error("Animation not found: "+t);var s=this.skeletonData.findAnimation(e);if(null==s)throw new Error("Animation not found: "+e);this.setMixWith(n,s,i)},t.prototype.setMixWith=function(t,e,i){if(null==t)throw new Error("from cannot be null.");if(null==e)throw new Error("to cannot be null.");var n=t.name+"."+e.name;this.animationToMixTime[n]=i},t.prototype.getMix=function(t,e){var i=t.name+"."+e.name,n=this.animationToMixTime[i];return void 0===n?this.defaultMix:n},t}();t.AnimationStateData=e}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){void 0===e&&(e=""),this.assets={},this.errors={},this.toLoad=0,this.loaded=0,this.textureLoader=t,this.pathPrefix=e}return e.downloadText=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.onload=function(){200==n.status?e(n.responseText):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.downloadBinary=function(t,e,i){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="arraybuffer",n.onload=function(){200==n.status?e(new Uint8Array(n.response)):i(n.status,n.responseText)},n.onerror=function(){i(n.status,n.responseText)},n.send()},e.prototype.loadBinary=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadBinary(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load binary "+t+": status "+status+", "+i,n&&n(t,"Couldn't load binary "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadText=function(t,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++,e.downloadText(t,(function(e){s.assets[t]=e,i&&i(t,e),s.toLoad--,s.loaded++}),(function(e,i){s.errors[t]="Couldn't load text "+t+": status "+status+", "+i,n&&n(t,"Couldn't load text "+t+": status "+status+", "+i),s.toLoad--,s.loaded++}))},e.prototype.loadTexture=function(t,e,i){var n=this;void 0===e&&(e=null),void 0===i&&(i=null),t=this.pathPrefix+t,this.toLoad++;var s=new Image;s.crossOrigin="anonymous",s.onload=function(){var i=n.textureLoader(s);n.assets[t]=i,n.toLoad--,n.loaded++,e&&e(t,s)},s.onerror=function(){n.errors[t]="Couldn't load image "+t,n.toLoad--,n.loaded++,i&&i(t,"Couldn't load image "+t)},s.src=t},e.prototype.loadTextureData=function(t,e,i,n){var s=this;void 0===i&&(i=null),void 0===n&&(n=null),t=this.pathPrefix+t,this.toLoad++;var r=new Image;r.onload=function(){var e=s.textureLoader(r);s.assets[t]=e,s.toLoad--,s.loaded++,i&&i(t,r)},r.onerror=function(){s.errors[t]="Couldn't load image "+t,s.toLoad--,s.loaded++,n&&n(t,"Couldn't load image "+t)},r.src=e},e.prototype.loadTextureAtlas=function(i,n,s){var r=this;void 0===n&&(n=null),void 0===s&&(s=null);var o=i.lastIndexOf("/")>=0?i.substring(0,i.lastIndexOf("/")):"";i=this.pathPrefix+i,this.toLoad++,e.downloadText(i,(function(e){var a={count:0},l=new Array;try{new t.TextureAtlas(e,(function(e){l.push(o+"/"+e);var i=document.createElement("img");return i.width=16,i.height=16,new t.FakeTexture(i)}))}catch(t){var c=t;return r.errors[i]="Couldn't load texture atlas "+i+": "+c.message,s&&s(i,"Couldn't load texture atlas "+i+": "+c.message),r.toLoad--,void r.loaded++}for(var h=function(c){var h=!1;r.loadTexture(c,(function(c){if(a.count++,a.count==l.length)if(h)r.errors[i]="Couldn't load texture atlas page "+c+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+c+" of atlas "+i),r.toLoad--,r.loaded++;else try{var _=new t.TextureAtlas(e,(function(t){return r.get(o+"/"+t)}));r.assets[i]=_,n&&n(i,_),r.toLoad--,r.loaded++}catch(t){var u=t;r.errors[i]="Couldn't load texture atlas "+i+": "+u.message,s&&s(i,"Couldn't load texture atlas "+i+": "+u.message),r.toLoad--,r.loaded++}}),(function(t){h=!0,a.count++,a.count==l.length&&(r.errors[i]="Couldn't load texture atlas page "+t+"} of atlas "+i,s&&s(i,"Couldn't load texture atlas page "+t+" of atlas "+i),r.toLoad--,r.loaded++)}))},_=0,u=l;_<u.length;_++)h(u[_])}),(function(t,e){r.errors[i]="Couldn't load texture atlas "+i+": status "+status+", "+e,s&&s(i,"Couldn't load texture atlas "+i+": status "+status+", "+e),r.toLoad--,r.loaded++}))},e.prototype.get=function(t){return t=this.pathPrefix+t,this.assets[t]},e.prototype.remove=function(t){t=this.pathPrefix+t;var e=this.assets[t];e.dispose&&e.dispose(),this.assets[t]=null},e.prototype.removeAll=function(){for(var t in this.assets){var e=this.assets[t];e.dispose&&e.dispose()}this.assets={}},e.prototype.isLoadingComplete=function(){return 0==this.toLoad},e.prototype.getToLoad=function(){return this.toLoad},e.prototype.getLoaded=function(){return this.loaded},e.prototype.dispose=function(){this.removeAll()},e.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},e.prototype.getErrors=function(){return this.errors},e}();t.AssetManager=e}(Ont||(Ont={})),function(t){var e=function(){function e(t){this.atlas=t}return e.prototype.newRegionAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.RegionAttachment(i);return r.setRegion(s),r},e.prototype.newMeshAttachment=function(e,i,n){var s=this.atlas.findRegion(n);if(null==s)return null;s.renderObject=s;var r=new t.MeshAttachment(i);return r.region=s,r},e.prototype.newBoundingBoxAttachment=function(e,i){return new t.BoundingBoxAttachment(i)},e.prototype.newPathAttachment=function(e,i){return new t.PathAttachment(i)},e.prototype.newPointAttachment=function(e,i){return new t.PointAttachment(i)},e.prototype.newClippingAttachment=function(e,i){return new t.ClippingAttachment(i)},e}();t.AtlasAttachmentLoader=e}(Ont||(Ont={})),function(t){var e;(e=t.BlendMode||(t.BlendMode={}))[e.Normal=0]="Normal",e[e.Additive=1]="Additive",e[e.Multiply=2]="Multiply",e[e.Screen=3]="Screen"}(Ont||(Ont={})),function(t){var e=function(){function e(t,e,i){if(this.children=new Array,this.x=0,this.y=0,this.rotation=0,this.scaleX=0,this.scaleY=0,this.shearX=0,this.shearY=0,this.ax=0,this.ay=0,this.arotation=0,this.ascaleX=0,this.ascaleY=0,this.ashearX=0,this.ashearY=0,this.appliedValid=!1,this.a=0,this.b=0,this.c=0,this.d=0,this.worldY=0,this.worldX=0,this.sorted=!1,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.skeleton=e,this.parent=i,this.setToSetupPose()}return e.prototype.isActive=function(){return this.active},e.prototype.update=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransform=function(){this.updateWorldTransformWith(this.x,this.y,this.rotation,this.scaleX,this.scaleY,this.shearX,this.shearY)},e.prototype.updateWorldTransformWith=function(e,i,n,s,r,o,a){this.ax=e,this.ay=i,this.arotation=n,this.ascaleX=s,this.ascaleY=r,this.ashearX=o,this.ashearY=a,this.appliedValid=!0;var l=this.parent;if(null==l){var c=this.skeleton,h=n+90+a,_=c.scaleX,u=c.scaleY;return this.a=t.MathUtils.cosDeg(n+o)*s*_,this.b=t.MathUtils.cosDeg(h)*r*_,this.c=t.MathUtils.sinDeg(n+o)*s*u,this.d=t.MathUtils.sinDeg(h)*r*u,this.worldX=e*_+c.x,void(this.worldY=i*u+c.y)}var m=l.a,p=l.b,d=l.c,f=l.d;switch(this.worldX=m*e+p*i+l.worldX,this.worldY=d*e+f*i+l.worldY,this.data.transformMode){case t.TransformMode.Normal:h=n+90+a;var g=t.MathUtils.cosDeg(n+o)*s,y=t.MathUtils.cosDeg(h)*r,v=t.MathUtils.sinDeg(n+o)*s,x=t.MathUtils.sinDeg(h)*r;return this.a=m*g+p*v,this.b=m*y+p*x,this.c=d*g+f*v,void(this.d=d*y+f*x);case t.TransformMode.OnlyTranslation:h=n+90+a,this.a=t.MathUtils.cosDeg(n+o)*s,this.b=t.MathUtils.cosDeg(h)*r,this.c=t.MathUtils.sinDeg(n+o)*s,this.d=t.MathUtils.sinDeg(h)*r;break;case t.TransformMode.NoRotationOrReflection:var b=0;(C=m*m+d*d)>1e-4?(p=d*(C=Math.abs(m*f-p*d)/C),f=m*C,b=Math.atan2(d,m)*t.MathUtils.radDeg):(m=0,d=0,b=90-Math.atan2(f,p)*t.MathUtils.radDeg);var S=n+o-b,A=n+a-b+90;g=t.MathUtils.cosDeg(S)*s,y=t.MathUtils.cosDeg(A)*r,v=t.MathUtils.sinDeg(S)*s,x=t.MathUtils.sinDeg(A)*r,this.a=m*g-p*v,this.b=m*y-p*x,this.c=d*g+f*v,this.d=d*y+f*x;break;case t.TransformMode.NoScale:case t.TransformMode.NoScaleOrReflection:var C,T=t.MathUtils.cosDeg(n),w=t.MathUtils.sinDeg(n),E=(m*T+p*w)/this.skeleton.scaleX,P=(d*T+f*w)/this.skeleton.scaleY;(C=Math.sqrt(E*E+P*P))>1e-5&&(C=1/C),E*=C,P*=C,C=Math.sqrt(E*E+P*P),this.data.transformMode==t.TransformMode.NoScale&&m*f-p*d<0!=(this.skeleton.scaleX<0!=this.skeleton.scaleY<0)&&(C=-C);var D=Math.PI/2+Math.atan2(P,E),I=Math.cos(D)*C,R=Math.sin(D)*C;g=t.MathUtils.cosDeg(o)*s,y=t.MathUtils.cosDeg(90+a)*r,v=t.MathUtils.sinDeg(o)*s,x=t.MathUtils.sinDeg(90+a)*r,this.a=E*g+I*v,this.b=E*y+I*x,this.c=P*g+R*v,this.d=P*y+R*x}this.a*=this.skeleton.scaleX,this.b*=this.skeleton.scaleX,this.c*=this.skeleton.scaleY,this.d*=this.skeleton.scaleY},e.prototype.setToSetupPose=function(){var t=this.data;this.x=t.x,this.y=t.y,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this.shearX=t.shearX,this.shearY=t.shearY},e.prototype.getWorldRotationX=function(){return Math.atan2(this.c,this.a)*t.MathUtils.radDeg},e.prototype.getWorldRotationY=function(){return Math.atan2(this.d,this.b)*t.MathUtils.radDeg},e.prototype.getWorldScaleX=function(){return Math.sqrt(this.a*this.a+this.c*this.c)},e.prototype.getWorldScaleY=function(){return Math.sqrt(this.b*this.b+this.d*this.d)},e.prototype.updateAppliedTransform=function(){this.appliedValid=!0;var e=this.parent;if(null==e)return this.ax=this.worldX,this.ay=this.worldY,this.arotation=Math.atan2(this.c,this.a)*t.MathUtils.radDeg,this.ascaleX=Math.sqrt(this.a*this.a+this.c*this.c),this.ascaleY=Math.sqrt(this.b*this.b+this.d*this.d),this.ashearX=0,void(this.ashearY=Math.atan2(this.a*this.b+this.c*this.d,this.a*this.d-this.b*this.c)*t.MathUtils.radDeg);var i=e.a,n=e.b,s=e.c,r=e.d,o=1/(i*r-n*s),a=this.worldX-e.worldX,l=this.worldY-e.worldY;this.ax=a*r*o-l*n*o,this.ay=l*i*o-a*s*o;var c=o*r,h=o*i,_=o*n,u=o*s,m=c*this.a-_*this.c,p=c*this.b-_*this.d,d=h*this.c-u*this.a,f=h*this.d-u*this.b;if(this.ashearX=0,this.ascaleX=Math.sqrt(m*m+d*d),this.ascaleX>1e-4){var g=m*f-p*d;this.ascaleY=g/this.ascaleX,this.ashearY=Math.atan2(m*p+d*f,g)*t.MathUtils.radDeg,this.arotation=Math.atan2(d,m)*t.MathUtils.radDeg}else this.ascaleX=0,this.ascaleY=Math.sqrt(p*p+f*f),this.ashearY=0,this.arotation=90-Math.atan2(f,p)*t.MathUtils.radDeg},e.prototype.worldToLocal=function(t){var e=this.a,i=this.b,n=this.c,s=this.d,r=1/(e*s-i*n),o=t.x-this.worldX,a=t.y-this.worldY;return t.x=o*s*r-a*i*r,t.y=a*e*r-o*n*r,t},e.prototype.localToWorld=function(t){var e=t.x,i=t.y;return t.x=e*this.a+i*this.b+this.worldX,t.y=e*this.c+i*this.d+this.worldY,t},e.prototype.worldToLocalRotation=function(e){var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(this.a*i-this.c*n,this.d*n-this.b*i)*t.MathUtils.radDeg+this.rotation-this.shearX},e.prototype.localToWorldRotation=function(e){e-=this.rotation-this.shearX;var i=t.MathUtils.sinDeg(e),n=t.MathUtils.cosDeg(e);return Math.atan2(n*this.c+i*this.d,n*this.a+i*this.b)*t.MathUtils.radDeg},e.prototype.rotateWorld=function(e){var i=this.a,n=this.b,s=this.c,r=this.d,o=t.MathUtils.cosDeg(e),a=t.MathUtils.sinDeg(e);this.a=o*i-a*s,this.b=o*n-a*r,this.c=a*i+o*s,this.d=a*n+o*r,this.appliedValid=!1},e}();t.Bone=e}(Ont||(Ont={})),function(t){var e;t.BoneData=function(i,n,s){if(this.x=0,this.y=0,this.rotation=0,this.scaleX=1,this.scaleY=1,this.shearX=0,this.shearY=0,this.transformMode=e.Normal,this.skinRequired=!1,this.color=new t.Color,i<0)throw new Error("index must be >= 0.");if(null==n)throw new Error("name cannot be null.");this.index=i,this.name=n,this.parent=s},function(t){t[t.Normal=0]="Normal",t[t.OnlyTranslation=1]="OnlyTranslation",t[t.NoRotationOrReflection=2]="NoRotationOrReflection",t[t.NoScale=3]="NoScale",t[t.NoScaleOrReflection=4]="NoScaleOrReflection"}(e=t.TransformMode||(t.TransformMode={}))}(Ont||(Ont={})),function(t){t.ConstraintData=function(t,e,i){this.name=t,this.order=e,this.skinRequired=i}}(Ont||(Ont={})),function(t){t.Event=function(t,e){if(null==e)throw new Error("data cannot be null.");this.time=t,this.data=e}}(Ont||(Ont={})),function(t){t.EventData=function(t){this.name=t}}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){if(this.bendDirection=0,this.compress=!1,this.stretch=!1,this.mix=1,this.softness=0,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.mix=t.mix,this.softness=t.softness,this.bendDirection=t.bendDirection,this.compress=t.compress,this.stretch=t.stretch,this.bones=new Array;for(var i=0;i<t.bones.length;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findBone(t.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var t=this.target,e=this.bones;switch(e.length){case 1:this.apply1(e[0],t.worldX,t.worldY,this.compress,this.stretch,this.data.uniform,this.mix);break;case 2:this.apply2(e[0],e[1],t.worldX,t.worldY,this.bendDirection,this.stretch,this.softness,this.mix)}},e.prototype.apply1=function(e,i,n,s,r,o,a){e.appliedValid||e.updateAppliedTransform();var l=e.parent,c=1/(l.a*l.d-l.b*l.c),h=i-l.worldX,_=n-l.worldY,u=(h*l.d-_*l.b)*c-e.ax,m=(_*l.a-h*l.c)*c-e.ay,p=Math.atan2(m,u)*t.MathUtils.radDeg-e.ashearX-e.arotation;e.ascaleX<0&&(p+=180),p>180?p-=360:p<-180&&(p+=360);var d=e.ascaleX,f=e.ascaleY;if(s||r){var g=e.data.length*d,y=Math.sqrt(u*u+m*m);if(s&&y<g||r&&y>g&&g>1e-4){var v=(y/g-1)*a+1;d*=v,o&&(f*=v)}}e.updateWorldTransformWith(e.ax,e.ay,e.arotation+p*a,d,f,e.ashearX,e.ashearY)},e.prototype.apply2=function(e,i,n,s,r,o,a,l){if(0!=l){e.appliedValid||e.updateAppliedTransform(),i.appliedValid||i.updateAppliedTransform();var c=e.ax,h=e.ay,_=e.ascaleX,u=_,m=e.ascaleY,p=i.ascaleX,d=0,f=0,g=0;_<0?(_=-_,d=180,g=-1):(d=0,g=1),m<0&&(m=-m,g=-g),p<0?(p=-p,f=180):f=0;var y=i.ax,v=0,x=0,b=0,S=e.a,A=e.b,C=e.c,T=e.d,w=Math.abs(_-m)<=1e-4;w?(x=S*y+A*(v=i.ay)+e.worldX,b=C*y+T*v+e.worldY):(v=0,x=S*y+e.worldX,b=C*y+e.worldY);var E=e.parent;S=E.a,A=E.b,C=E.c;var P,D,I=1/(S*(T=E.d)-A*C),R=x-E.worldX,M=b-E.worldY,O=(R*T-M*A)*I-c,B=(M*S-R*C)*I-h,N=Math.sqrt(O*O+B*B),L=i.data.length*p;if(N<1e-4)return this.apply1(e,n,s,!1,o,!1,l),void i.updateWorldTransformWith(y,v,0,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY);var F=((R=n-E.worldX)*T-(M=s-E.worldY)*A)*I-c,z=(M*S-R*C)*I-h,V=F*F+z*z;if(0!=a){a*=_*(p+1)/2;var U=Math.sqrt(V),G=U-N-L*_+a;if(G>0){var k=Math.min(1,G/(2*a))-1;V=(F-=(k=(G-a*(1-k*k))/U)*F)*F+(z-=k*z)*z}}t:if(w){var H=(V-N*N-(L*=_)*L)/(2*N*L);H<-1?H=-1:H>1&&(H=1,o&&(u*=(Math.sqrt(V)/(N+L)-1)*l+1)),D=Math.acos(H)*r,S=N+L*H,A=L*Math.sin(D),P=Math.atan2(z*S-F*A,F*S+z*A)}else{var j=(S=_*L)*S,W=(A=m*L)*A,q=Math.atan2(z,F),X=-2*W*N,Y=W-j;if((T=X*X-4*Y*(C=W*N*N+j*V-j*W))>=0){var K=Math.sqrt(T);X<0&&(K=-K);var $=(K=-(X+K)/2)/Y,J=C/K,Z=Math.abs($)<Math.abs(J)?$:J;if(Z*Z<=V){M=Math.sqrt(V-Z*Z)*r,P=q-Math.atan2(M,Z),D=Math.atan2(M/m,(Z-N)/_);break t}}var Q=t.MathUtils.PI,tt=N-S,et=tt*tt,it=0,nt=0,st=N+S,rt=st*st,ot=0;(C=-S*N/(j-W))>=-1&&C<=1&&(C=Math.acos(C),(T=(R=S*Math.cos(C)+N)*R+(M=A*Math.sin(C))*M)<et&&(Q=C,et=T,tt=R,it=M),T>rt&&(nt=C,rt=T,st=R,ot=M)),V<=(et+rt)/2?(P=q-Math.atan2(it*r,tt),D=Q*r):(P=q-Math.atan2(ot*r,st),D=nt*r)}var at=Math.atan2(v,y)*g,lt=e.arotation;(P=(P-at)*t.MathUtils.radDeg+d-lt)>180?P-=360:P<-180&&(P+=360),e.updateWorldTransformWith(c,h,lt+P*l,u,e.ascaleY,0,0),lt=i.arotation,(D=((D+at)*t.MathUtils.radDeg-i.ashearX)*g+f-lt)>180?D-=360:D<-180&&(D+=360),i.updateWorldTransformWith(y,v,lt+D*l,i.ascaleX,i.ascaleY,i.ashearX,i.ashearY)}else i.updateWorldTransform()},e}();t.IkConstraint=e}(Ont||(Ont={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.bendDirection=1,i.compress=!1,i.stretch=!1,i.uniform=!1,i.mix=1,i.softness=0,i}return Bnt(e,t),e}(t.ConstraintData);t.IkConstraintData=e}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){if(this.position=0,this.spacing=0,this.rotateMix=0,this.translateMix=0,this.spaces=new Array,this.positions=new Array,this.world=new Array,this.curves=new Array,this.lengths=new Array,this.segments=new Array,this.active=!1,null==t)throw new Error("data cannot be null.");if(null==e)throw new Error("skeleton cannot be null.");this.data=t,this.bones=new Array;for(var i=0,n=t.bones.length;i<n;i++)this.bones.push(e.findBone(t.bones[i].name));this.target=e.findSlot(t.target.name),this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){var i=this.target.getAttachment();if(i instanceof t.PathAttachment){var n=this.rotateMix,s=this.translateMix,r=n>0;if(s>0||r){var o=this.data,a=o.spacingMode==t.SpacingMode.Percent,l=o.rotateMode,c=l==t.RotateMode.Tangent,h=l==t.RotateMode.ChainScale,_=this.bones.length,u=c?_:_+1,m=this.bones,p=t.Utils.setArraySize(this.spaces,u),d=null,f=this.spacing;if(h||!a){h&&(d=t.Utils.setArraySize(this.lengths,_));for(var g=o.spacingMode==t.SpacingMode.Length,y=0,v=u-1;y<v;){var x=(R=m[y]).data.length;if(x<e.epsilon)h&&(d[y]=0),p[++y]=0;else if(a){if(h){var b=x*R.a,S=x*R.c,A=Math.sqrt(b*b+S*S);d[y]=A}p[++y]=f}else{b=x*R.a,S=x*R.c;var C=Math.sqrt(b*b+S*S);h&&(d[y]=C),p[++y]=(g?x+f:f)*C/x}}}else for(y=1;y<u;y++)p[y]=f;var T=this.computeWorldPositions(i,u,c,o.positionMode==t.PositionMode.Percent,a),w=T[0],E=T[1],P=o.offsetRotation,D=!1;0==P?D=l==t.RotateMode.Chain:(D=!1,P*=(I=this.target.bone).a*I.d-I.b*I.c>0?t.MathUtils.degRad:-t.MathUtils.degRad),y=0;for(var I=3;y<_;y++,I+=3){var R;(R=m[y]).worldX+=(w-R.worldX)*s,R.worldY+=(E-R.worldY)*s;var M=(b=T[I])-w,O=(S=T[I+1])-E;if(h){var B=d[y];if(0!=B){var N=(Math.sqrt(M*M+O*O)/B-1)*n+1;R.a*=N,R.c*=N}}if(w=b,E=S,r){var L=R.a,F=R.b,z=R.c,V=R.d,U=0,G=0,k=0;if(U=c?T[I-1]:0==p[y+1]?T[I+2]:Math.atan2(O,M),U-=Math.atan2(z,L),D){G=Math.cos(U),k=Math.sin(U);var H=R.data.length;w+=(H*(G*L-k*z)-M)*n,E+=(H*(k*L+G*z)-O)*n}else U+=P;U>t.MathUtils.PI?U-=t.MathUtils.PI2:U<-t.MathUtils.PI&&(U+=t.MathUtils.PI2),U*=n,G=Math.cos(U),k=Math.sin(U),R.a=G*L-k*z,R.b=G*F-k*V,R.c=k*L+G*z,R.d=k*F+G*V}R.appliedValid=!1}}}},e.prototype.computeWorldPositions=function(i,n,s,r,o){var a=this.target,l=this.position,c=this.spaces,h=t.Utils.setArraySize(this.positions,3*n+2),_=null,u=i.closed,m=i.worldVerticesLength,p=m/6,d=e.NONE;if(!i.constantSpeed){var f=i.lengths,g=f[p-=u?1:2];if(r&&(l*=g),o)for(var y=1;y<n;y++)c[y]*=g;_=t.Utils.setArraySize(this.world,8),y=0;for(var v=0,x=0;y<n;y++,v+=3){var b=l+=W=c[y];if(u)(b%=g)<0&&(b+=g),x=0;else{if(b<0){d!=e.BEFORE&&(d=e.BEFORE,i.computeWorldVertices(a,2,4,_,0,2)),this.addBeforePosition(b,_,0,h,v);continue}if(b>g){d!=e.AFTER&&(d=e.AFTER,i.computeWorldVertices(a,m-6,4,_,0,2)),this.addAfterPosition(b-g,_,0,h,v);continue}}for(;;x++){var S=f[x];if(!(b>S)){0==x?b/=S:b=(b-(K=f[x-1]))/(S-K);break}}x!=d&&(d=x,u&&x==p?(i.computeWorldVertices(a,m-4,4,_,0,2),i.computeWorldVertices(a,0,4,_,4,2)):i.computeWorldVertices(a,6*x+2,8,_,0,2)),this.addCurvePosition(b,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],h,v,s||y>0&&0==W)}return h}u?(m+=2,_=t.Utils.setArraySize(this.world,m),i.computeWorldVertices(a,2,m-4,_,0,2),i.computeWorldVertices(a,0,2,_,m-4,2),_[m-2]=_[0],_[m-1]=_[1]):(p--,m-=4,_=t.Utils.setArraySize(this.world,m),i.computeWorldVertices(a,2,m,_,0,2));for(var A=t.Utils.setArraySize(this.curves,p),C=0,T=_[0],w=_[1],E=0,P=0,D=0,I=0,R=0,M=0,O=0,B=0,N=0,L=0,F=0,z=0,V=0,U=0,G=(y=0,2);y<p;y++,G+=6)E=_[G],P=_[G+1],D=_[G+2],I=_[G+3],F=2*(O=.1875*(T-2*E+D))+(N=.09375*(3*(E-D)-T+(R=_[G+4]))),z=2*(B=.1875*(w-2*P+I))+(L=.09375*(3*(P-I)-w+(M=_[G+5]))),V=.75*(E-T)+O+.16666667*N,U=.75*(P-w)+B+.16666667*L,C+=Math.sqrt(V*V+U*U),V+=F,U+=z,F+=N,z+=L,C+=Math.sqrt(V*V+U*U),V+=F,U+=z,C+=Math.sqrt(V*V+U*U),V+=F+N,U+=z+L,C+=Math.sqrt(V*V+U*U),A[y]=C,T=R,w=M;if(l*=r?C:C/i.lengths[p-1],o)for(y=1;y<n;y++)c[y]*=C;for(var k=this.segments,H=0,j=(y=0,v=0,x=0,0);y<n;y++,v+=3){var W;if(b=l+=W=c[y],u)(b%=C)<0&&(b+=C),x=0;else{if(b<0){this.addBeforePosition(b,_,0,h,v);continue}if(b>C){this.addAfterPosition(b-C,_,m-4,h,v);continue}}for(;;x++){var q=A[x];if(!(b>q)){0==x?b/=q:b=(b-(K=A[x-1]))/(q-K);break}}if(x!=d){d=x;var X=6*x;for(T=_[X],w=_[X+1],E=_[X+2],P=_[X+3],D=_[X+4],I=_[X+5],F=2*(O=.03*(T-2*E+D))+(N=.006*(3*(E-D)-T+(R=_[X+6]))),z=2*(B=.03*(w-2*P+I))+(L=.006*(3*(P-I)-w+(M=_[X+7]))),V=.3*(E-T)+O+.16666667*N,U=.3*(P-w)+B+.16666667*L,H=Math.sqrt(V*V+U*U),k[0]=H,X=1;X<8;X++)V+=F,U+=z,F+=N,z+=L,H+=Math.sqrt(V*V+U*U),k[X]=H;V+=F,U+=z,H+=Math.sqrt(V*V+U*U),k[8]=H,V+=F+N,U+=z+L,H+=Math.sqrt(V*V+U*U),k[9]=H,j=0}for(b*=H;;j++){var Y=k[j];if(!(b>Y)){var K;0==j?b/=Y:b=j+(b-(K=k[j-1]))/(Y-K);break}}this.addCurvePosition(.1*b,T,w,E,P,D,I,R,M,h,v,s||y>0&&0==W)}return h},e.prototype.addBeforePosition=function(t,e,i,n,s){var r=e[i],o=e[i+1],a=e[i+2]-r,l=e[i+3]-o,c=Math.atan2(l,a);n[s]=r+t*Math.cos(c),n[s+1]=o+t*Math.sin(c),n[s+2]=c},e.prototype.addAfterPosition=function(t,e,i,n,s){var r=e[i+2],o=e[i+3],a=r-e[i],l=o-e[i+1],c=Math.atan2(l,a);n[s]=r+t*Math.cos(c),n[s+1]=o+t*Math.sin(c),n[s+2]=c},e.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,l,c,h,_){if(0==t||isNaN(t))return c[h]=e,c[h+1]=i,void(c[h+2]=Math.atan2(s-i,n-e));var u=t*t,m=u*t,p=1-t,d=p*p,f=d*p,g=p*t,y=3*g,v=p*y,x=y*t,b=e*f+n*v+r*x+a*m,S=i*f+s*v+o*x+l*m;c[h]=b,c[h+1]=S,_&&(c[h+2]=t<.001?Math.atan2(s-i,n-e):Math.atan2(S-(i*d+s*g*2+o*u),b-(e*d+n*g*2+r*u)))},e.NONE=-1,e.BEFORE=-2,e.AFTER=-3,e.epsilon=1e-5,e}();t.PathConstraint=e}(Ont||(Ont={})),function(t){var e,i,n,s=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i}return Bnt(e,t),e}(t.ConstraintData);t.PathConstraintData=s,(n=t.PositionMode||(t.PositionMode={}))[n.Fixed=0]="Fixed",n[n.Percent=1]="Percent",(i=t.SpacingMode||(t.SpacingMode={}))[i.Length=0]="Length",i[i.Fixed=1]="Fixed",i[i.Percent=2]="Percent",(e=t.RotateMode||(t.RotateMode={}))[e.Tangent=0]="Tangent",e[e.Chain=1]="Chain",e[e.ChainScale=2]="ChainScale"}(Ont||(Ont={})),function(t){var e=function(){function t(t){this.toLoad=new Array,this.assets={},this.clientId=t}return t.prototype.loaded=function(){var t=0;for(var e in this.assets)t++;return t},t}(),i=function(){function t(t){void 0===t&&(t=""),this.clientAssets={},this.queuedAssets={},this.rawAssets={},this.errors={},this.pathPrefix=t}return t.prototype.queueAsset=function(t,i,n){var s=this.clientAssets[t];return null==s&&(s=new e(t),this.clientAssets[t]=s),null!==i&&(s.textureLoader=i),s.toLoad.push(n),this.queuedAssets[n]!==n&&(this.queuedAssets[n]=n,!0)},t.prototype.loadText=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=n.responseText:i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadJson=function(t,e){var i=this;if(e=this.pathPrefix+e,this.queueAsset(t,null,e)){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState==XMLHttpRequest.DONE&&(n.status>=200&&n.status<300?i.rawAssets[e]=JSON.parse(n.responseText):i.errors[e]="Couldn't load text "+e+": status "+n.status+", "+n.responseText)},n.open("GET",e,!0),n.send()}},t.prototype.loadTexture=function(t,e,i){var n=this;if(i=this.pathPrefix+i,this.queueAsset(t,e,i)){var s=new Image;s.src=i,s.crossOrigin="anonymous",s.onload=function(){n.rawAssets[i]=s},s.onerror=function(){n.errors[i]="Couldn't load image "+i}}},t.prototype.get=function(t,e){e=this.pathPrefix+e;var i=this.clientAssets[t];return null==i||i.assets[e]},t.prototype.updateClientAssets=function(t){for(var e=0;e<t.toLoad.length;e++){var i=t.toLoad[e];if(null==t.assets[i]){var n=this.rawAssets[i];if(null==n)continue;n instanceof HTMLImageElement?t.assets[i]=t.textureLoader(n):t.assets[i]=n}}},t.prototype.isLoadingComplete=function(t){var e=this.clientAssets[t];return null==e||(this.updateClientAssets(e),e.toLoad.length==e.loaded())},t.prototype.dispose=function(){},t.prototype.hasErrors=function(){return Object.keys(this.errors).length>0},t.prototype.getErrors=function(){return this.errors},t}();t.SharedAssetManager=i}(Ont||(Ont={})),function(t){var e=function(){function e(e){if(this._updateCache=new Array,this.updateCacheReset=new Array,this.time=0,this.scaleX=1,this.scaleY=1,this.x=0,this.y=0,null==e)throw new Error("data cannot be null.");this.data=e,this.bones=new Array;for(var i=0;i<e.bones.length;i++){var n=e.bones[i],s=void 0;if(null==n.parent)s=new t.Bone(n,this,null);else{var r=this.bones[n.parent.index];s=new t.Bone(n,this,r),r.children.push(s)}this.bones.push(s)}for(this.slots=new Array,this.drawOrder=new Array,i=0;i<e.slots.length;i++){var o=e.slots[i],a=(s=this.bones[o.boneData.index],new t.Slot(o,s));this.slots.push(a),this.drawOrder.push(a)}for(this.ikConstraints=new Array,i=0;i<e.ikConstraints.length;i++){var l=e.ikConstraints[i];this.ikConstraints.push(new t.IkConstraint(l,this))}for(this.transformConstraints=new Array,i=0;i<e.transformConstraints.length;i++){var c=e.transformConstraints[i];this.transformConstraints.push(new t.TransformConstraint(c,this))}for(this.pathConstraints=new Array,i=0;i<e.pathConstraints.length;i++){var h=e.pathConstraints[i];this.pathConstraints.push(new t.PathConstraint(h,this))}this.color=new t.Color(1,1,1,1),this.updateCache()}return e.prototype.updateCache=function(){this._updateCache.length=0,this.updateCacheReset.length=0;for(var t=this.bones,e=0,i=t.length;e<i;e++)(s=t[e]).sorted=s.data.skinRequired,s.active=!s.sorted;if(null!=this.skin){var n=this.skin.bones;for(e=0,i=this.skin.bones.length;e<i;e++){var s=this.bones[n[e].index];do{s.sorted=!1,s.active=!0,s=s.parent}while(null!=s)}}var r=this.ikConstraints,o=this.transformConstraints,a=this.pathConstraints,l=r.length,c=o.length,h=a.length,_=l+c+h;t:for(e=0;e<_;e++){for(var u=0;u<l;u++)if((m=r[u]).data.order==e){this.sortIkConstraint(m);continue t}for(u=0;u<c;u++)if((m=o[u]).data.order==e){this.sortTransformConstraint(m);continue t}for(u=0;u<h;u++){var m;if((m=a[u]).data.order==e){this.sortPathConstraint(m);continue t}}}for(e=0,i=t.length;e<i;e++)this.sortBone(t[e])},e.prototype.sortIkConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target;this.sortBone(i);var n=e.bones,s=n[0];if(this.sortBone(s),n.length>1){var r=n[n.length-1];this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}this._updateCache.push(e),this.sortReset(s.children),n[n.length-1].sorted=!0}},e.prototype.sortPathConstraint=function(e){if(e.active=e.target.bone.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){var i=e.target,n=i.data.index,s=i.bone;null!=this.skin&&this.sortPathConstraintAttachment(this.skin,n,s),null!=this.data.defaultSkin&&this.data.defaultSkin!=this.skin&&this.sortPathConstraintAttachment(this.data.defaultSkin,n,s);for(var r=0,o=this.data.skins.length;r<o;r++)this.sortPathConstraintAttachment(this.data.skins[r],n,s);var a=i.getAttachment();a instanceof t.PathAttachment&&this.sortPathConstraintAttachmentWith(a,s);var l=e.bones,c=l.length;for(r=0;r<c;r++)this.sortBone(l[r]);for(this._updateCache.push(e),r=0;r<c;r++)this.sortReset(l[r].children);for(r=0;r<c;r++)l[r].sorted=!0}},e.prototype.sortTransformConstraint=function(e){if(e.active=e.target.isActive()&&(!e.data.skinRequired||null!=this.skin&&t.Utils.contains(this.skin.constraints,e.data,!0)),e.active){this.sortBone(e.target);var i=e.bones,n=i.length;if(e.data.local)for(var s=0;s<n;s++){var r=i[s];this.sortBone(r.parent),this._updateCache.indexOf(r)>-1||this.updateCacheReset.push(r)}else for(s=0;s<n;s++)this.sortBone(i[s]);this._updateCache.push(e);for(var o=0;o<n;o++)this.sortReset(i[o].children);for(o=0;o<n;o++)i[o].sorted=!0}},e.prototype.sortPathConstraintAttachment=function(t,e,i){var n=t.attachments[e];if(n)for(var s in n)this.sortPathConstraintAttachmentWith(n[s],i)},e.prototype.sortPathConstraintAttachmentWith=function(e,i){if(e instanceof t.PathAttachment){var n=e.bones;if(null==n)this.sortBone(i);else for(var s=this.bones,r=0;r<n.length;)for(var o=n[r++],a=r+o;r<a;r++){var l=n[r];this.sortBone(s[l])}}},e.prototype.sortBone=function(t){if(!t.sorted){var e=t.parent;null!=e&&this.sortBone(e),t.sorted=!0,this._updateCache.push(t)}},e.prototype.sortReset=function(t){for(var e=0,i=t.length;e<i;e++){var n=t[e];n.active&&(n.sorted&&this.sortReset(n.children),n.sorted=!1)}},e.prototype.updateWorldTransform=function(){for(var t=this.updateCacheReset,e=0,i=t.length;e<i;e++){var n=t[e];n.ax=n.x,n.ay=n.y,n.arotation=n.rotation,n.ascaleX=n.scaleX,n.ascaleY=n.scaleY,n.ashearX=n.shearX,n.ashearY=n.shearY,n.appliedValid=!0}var s=this._updateCache;for(e=0,i=s.length;e<i;e++)s[e].update()},e.prototype.setToSetupPose=function(){this.setBonesToSetupPose(),this.setSlotsToSetupPose()},e.prototype.setBonesToSetupPose=function(){for(var t=this.bones,e=0,i=t.length;e<i;e++)t[e].setToSetupPose();var n=this.ikConstraints;for(e=0,i=n.length;e<i;e++)(a=n[e]).mix=a.data.mix,a.softness=a.data.softness,a.bendDirection=a.data.bendDirection,a.compress=a.data.compress,a.stretch=a.data.stretch;var s=this.transformConstraints;for(e=0,i=s.length;e<i;e++){var r=(a=s[e]).data;a.rotateMix=r.rotateMix,a.translateMix=r.translateMix,a.scaleMix=r.scaleMix,a.shearMix=r.shearMix}var o=this.pathConstraints;for(e=0,i=o.length;e<i;e++){var a;r=(a=o[e]).data,a.position=r.position,a.spacing=r.spacing,a.rotateMix=r.rotateMix,a.translateMix=r.translateMix}},e.prototype.setSlotsToSetupPose=function(){var e=this.slots;t.Utils.arrayCopy(e,0,this.drawOrder,0,e.length);for(var i=0,n=e.length;i<n;i++)e[i].setToSetupPose()},e.prototype.getRootBone=function(){return 0==this.bones.length?null:this.bones[0]},e.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].data.name==t)return i;return-1},e.prototype.setSkinByName=function(t){var e=this.data.findSkin(t);if(null==e)throw new Error("Skin not found: "+t);this.setSkin(e)},e.prototype.setSkin=function(t){if(t!=this.skin){if(null!=t)if(null!=this.skin)t.attachAll(this,this.skin);else for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i],r=s.data.attachmentName;if(null!=r){var o=t.getAttachment(i,r);null!=o&&s.setAttachment(o)}}this.skin=t,this.updateCache()}},e.prototype.getAttachmentByName=function(t,e){return this.getAttachment(this.data.findSlotIndex(t),e)},e.prototype.getAttachment=function(t,e){if(null==e)throw new Error("attachmentName cannot be null.");if(null!=this.skin){var i=this.skin.getAttachment(t,e);if(null!=i)return i}return null!=this.data.defaultSkin?this.data.defaultSkin.getAttachment(t,e):null},e.prototype.setAttachment=function(t,e){if(null==t)throw new Error("slotName cannot be null.");for(var i=this.slots,n=0,s=i.length;n<s;n++){var r=i[n];if(r.data.name==t){var o=null;if(null!=e&&null==(o=this.getAttachment(n,e)))throw new Error("Attachment not found: "+e+", for slot: "+t);return void r.setAttachment(o)}}throw new Error("Slot not found: "+t)},e.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.data.name==t)return s}return null},e.prototype.getBounds=function(e,i,n){if(void 0===n&&(n=new Array(2)),null==e)throw new Error("offset cannot be null.");if(null==i)throw new Error("size cannot be null.");for(var s=this.drawOrder,r=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY,c=0,h=s.length;c<h;c++){var _=s[c];if(_.bone.active){var u=0,m=null,p=_.getAttachment();if(p instanceof t.RegionAttachment)u=8,m=t.Utils.setArraySize(n,u,0),p.computeWorldVertices(_.bone,m,0,2);else if(p instanceof t.MeshAttachment){var d=p;u=d.worldVerticesLength,m=t.Utils.setArraySize(n,u,0),d.computeWorldVertices(_,0,u,m,0,2)}if(null!=m)for(var f=0,g=m.length;f<g;f+=2){var y=m[f],v=m[f+1];r=Math.min(r,y),o=Math.min(o,v),a=Math.max(a,y),l=Math.max(l,v)}}}e.set(r,o),i.set(a-r,l-o)},e.prototype.update=function(t){this.time+=t},e}();t.Skeleton=e}(Ont||(Ont={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(n){var s=this.scale,r=new t.SkeletonData;r.name="";var o=new i(n);r.hash=o.readString(),r.version=o.readString(),r.x=o.readFloat(),r.y=o.readFloat(),r.width=o.readFloat(),r.height=o.readFloat();var a=o.readBoolean();a&&(r.fps=o.readFloat(),r.imagesPath=o.readString(),r.audioPath=o.readString());var l=0;l=o.readInt(!0);for(var c=0;c<l;c++)o.strings.push(o.readString());for(l=o.readInt(!0),c=0;c<l;c++){var h=o.readString(),_=0==c?null:r.bones[o.readInt(!0)];(p=new t.BoneData(c,h,_)).rotation=o.readFloat(),p.x=o.readFloat()*s,p.y=o.readFloat()*s,p.scaleX=o.readFloat(),p.scaleY=o.readFloat(),p.shearX=o.readFloat(),p.shearY=o.readFloat(),p.length=o.readFloat()*s,p.transformMode=e.TransformModeValues[o.readInt(!0)],p.skinRequired=o.readBoolean(),a&&t.Color.rgba8888ToColor(p.color,o.readInt32()),r.bones.push(p)}for(l=o.readInt(!0),c=0;c<l;c++){var u=o.readString(),m=r.bones[o.readInt(!0)],p=new t.SlotData(c,u,m);t.Color.rgba8888ToColor(p.color,o.readInt32());var d=o.readInt32();-1!=d&&t.Color.rgb888ToColor(p.darkColor=new t.Color,d),p.attachmentName=o.readStringRef(),p.blendMode=e.BlendModeValues[o.readInt(!0)],r.slots.push(p)}l=o.readInt(!0),c=0;for(var f=void 0;c<l;c++){(p=new t.IkConstraintData(o.readString())).order=o.readInt(!0),p.skinRequired=o.readBoolean(),f=o.readInt(!0);for(var g=0;g<f;g++)p.bones.push(r.bones[o.readInt(!0)]);p.target=r.bones[o.readInt(!0)],p.mix=o.readFloat(),p.softness=o.readFloat()*s,p.bendDirection=o.readByte(),p.compress=o.readBoolean(),p.stretch=o.readBoolean(),p.uniform=o.readBoolean(),r.ikConstraints.push(p)}for(l=o.readInt(!0),c=0,f=void 0;c<l;c++){for((p=new t.TransformConstraintData(o.readString())).order=o.readInt(!0),p.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)p.bones.push(r.bones[o.readInt(!0)]);p.target=r.bones[o.readInt(!0)],p.local=o.readBoolean(),p.relative=o.readBoolean(),p.offsetRotation=o.readFloat(),p.offsetX=o.readFloat()*s,p.offsetY=o.readFloat()*s,p.offsetScaleX=o.readFloat(),p.offsetScaleY=o.readFloat(),p.offsetShearY=o.readFloat(),p.rotateMix=o.readFloat(),p.translateMix=o.readFloat(),p.scaleMix=o.readFloat(),p.shearMix=o.readFloat(),r.transformConstraints.push(p)}for(l=o.readInt(!0),c=0,f=void 0;c<l;c++){for((p=new t.PathConstraintData(o.readString())).order=o.readInt(!0),p.skinRequired=o.readBoolean(),f=o.readInt(!0),g=0;g<f;g++)p.bones.push(r.bones[o.readInt(!0)]);p.target=r.slots[o.readInt(!0)],p.positionMode=e.PositionModeValues[o.readInt(!0)],p.spacingMode=e.SpacingModeValues[o.readInt(!0)],p.rotateMode=e.RotateModeValues[o.readInt(!0)],p.offsetRotation=o.readFloat(),p.position=o.readFloat(),p.positionMode==t.PositionMode.Fixed&&(p.position*=s),p.spacing=o.readFloat(),p.spacingMode!=t.SpacingMode.Length&&p.spacingMode!=t.SpacingMode.Fixed||(p.spacing*=s),p.rotateMix=o.readFloat(),p.translateMix=o.readFloat(),r.pathConstraints.push(p)}var y=this.readSkin(o,r,!0,a);for(null!=y&&(r.defaultSkin=y,r.skins.push(y)),c=r.skins.length,t.Utils.setArraySize(r.skins,l=c+o.readInt(!0));c<l;c++)r.skins[c]=this.readSkin(o,r,!1,a);for(l=this.linkedMeshes.length,c=0;c<l;c++){var v=this.linkedMeshes[c],x=null==v.skin?r.defaultSkin:r.findSkin(v.skin);if(null==x)throw new Error("Skin not found: "+v.skin);var b=x.getAttachment(v.slotIndex,v.parent);if(null==b)throw new Error("Parent mesh not found: "+v.parent);v.mesh.deformAttachment=v.inheritDeform?b:v.mesh,v.mesh.setParentMesh(b),v.mesh.updateUVs()}for(this.linkedMeshes.length=0,l=o.readInt(!0),c=0;c<l;c++)(p=new t.EventData(o.readStringRef())).intValue=o.readInt(!1),p.floatValue=o.readFloat(),p.stringValue=o.readString(),p.audioPath=o.readString(),null!=p.audioPath&&(p.volume=o.readFloat(),p.balance=o.readFloat()),r.events.push(p);for(l=o.readInt(!0),c=0;c<l;c++)r.animations.push(this.readAnimation(o,o.readString(),r));return r},e.prototype.readSkin=function(e,i,n,s){var r=null,o=0;if(n){if(0==(o=e.readInt(!0)))return null;r=new t.Skin("default")}else{(r=new t.Skin(e.readStringRef())).bones.length=e.readInt(!0);for(var a=0,l=r.bones.length;a<l;a++)r.bones[a]=i.bones[e.readInt(!0)];for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.ikConstraints[e.readInt(!0)]);for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.transformConstraints[e.readInt(!0)]);for(a=0,l=e.readInt(!0);a<l;a++)r.constraints.push(i.pathConstraints[e.readInt(!0)]);o=e.readInt(!0)}for(a=0;a<o;a++)for(var c=e.readInt(!0),h=0,_=e.readInt(!0);h<_;h++){var u=e.readStringRef(),m=this.readAttachment(e,i,r,c,u,s);null!=m&&r.setAttachment(c,u,m)}return r},e.prototype.readAttachment=function(i,s,r,o,a,l){var c=this.scale,h=i.readStringRef();null==h&&(h=a);var _=i.readByte();switch(e.AttachmentTypeValues[_]){case t.AttachmentType.Region:var u=i.readStringRef(),m=i.readFloat(),p=i.readFloat(),d=i.readFloat(),f=i.readFloat(),g=i.readFloat(),y=i.readFloat(),v=i.readFloat(),x=i.readInt32();null==u&&(u=h);var b=this.attachmentLoader.newRegionAttachment(r,h,u);return null==b?null:(b.path=u,b.x=p*c,b.y=d*c,b.scaleX=f,b.scaleY=g,b.rotation=m,b.width=y*c,b.height=v*c,t.Color.rgba8888ToColor(b.color,x),b.updateOffset(),b);case t.AttachmentType.BoundingBox:var S=i.readInt(!0),A=this.readVertices(i,S),C=(x=l?i.readInt32():0,this.attachmentLoader.newBoundingBoxAttachment(r,h));return null==C?null:(C.worldVerticesLength=S<<1,C.vertices=A.vertices,C.bones=A.bones,l&&t.Color.rgba8888ToColor(C.color,x),C);case t.AttachmentType.Mesh:u=i.readStringRef(),x=i.readInt32(),S=i.readInt(!0);var T=this.readFloatArray(i,S<<1,1),w=this.readShortArray(i),E=(A=this.readVertices(i,S),i.readInt(!0)),P=null;return y=0,v=0,l&&(P=this.readShortArray(i),y=i.readFloat(),v=i.readFloat()),null==u&&(u=h),null==(D=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(D.path=u,t.Color.rgba8888ToColor(D.color,x),D.bones=A.bones,D.vertices=A.vertices,D.worldVerticesLength=S<<1,D.triangles=w,D.regionUVs=T,D.updateUVs(),D.hullLength=E<<1,l&&(D.edges=P,D.width=y*c,D.height=v*c),D);case t.AttachmentType.LinkedMesh:u=i.readStringRef(),x=i.readInt32();var D,I=i.readStringRef(),R=i.readStringRef(),M=i.readBoolean();return y=0,v=0,l&&(y=i.readFloat(),v=i.readFloat()),null==u&&(u=h),null==(D=this.attachmentLoader.newMeshAttachment(r,h,u))?null:(D.path=u,t.Color.rgba8888ToColor(D.color,x),l&&(D.width=y*c,D.height=v*c),this.linkedMeshes.push(new n(D,I,o,R,M)),D);case t.AttachmentType.Path:for(var O=i.readBoolean(),B=i.readBoolean(),N=(S=i.readInt(!0),A=this.readVertices(i,S),t.Utils.newArray(S/3,0)),L=0,F=N.length;L<F;L++)N[L]=i.readFloat()*c;return x=l?i.readInt32():0,null==(u=this.attachmentLoader.newPathAttachment(r,h))?null:(u.closed=O,u.constantSpeed=B,u.worldVerticesLength=S<<1,u.vertices=A.vertices,u.bones=A.bones,u.lengths=N,l&&t.Color.rgba8888ToColor(u.color,x),u);case t.AttachmentType.Point:m=i.readFloat(),p=i.readFloat(),d=i.readFloat(),x=l?i.readInt32():0;var z=this.attachmentLoader.newPointAttachment(r,h);return null==z?null:(z.x=p*c,z.y=d*c,z.rotation=m,l&&t.Color.rgba8888ToColor(z.color,x),z);case t.AttachmentType.Clipping:var V=i.readInt(!0),U=(S=i.readInt(!0),A=this.readVertices(i,S),x=l?i.readInt32():0,this.attachmentLoader.newClippingAttachment(r,h));return null==U?null:(U.endSlot=s.slots[V],U.worldVerticesLength=S<<1,U.vertices=A.vertices,U.bones=A.bones,l&&t.Color.rgba8888ToColor(U.color,x),U)}return null},e.prototype.readVertices=function(e,i){var n=i<<1,r=new s,o=this.scale;if(!e.readBoolean())return r.vertices=this.readFloatArray(e,n,o),r;for(var a=new Array,l=new Array,c=0;c<i;c++){var h=e.readInt(!0);l.push(h);for(var _=0;_<h;_++)l.push(e.readInt(!0)),a.push(e.readFloat()*o),a.push(e.readFloat()*o),a.push(e.readFloat())}return r.vertices=t.Utils.toFloatArray(a),r.bones=l,r},e.prototype.readFloatArray=function(t,e,i){var n=new Array(e);if(1==i)for(var s=0;s<e;s++)n[s]=t.readFloat();else for(s=0;s<e;s++)n[s]=t.readFloat()*i;return n},e.prototype.readShortArray=function(t){for(var e=t.readInt(!0),i=new Array(e),n=0;n<e;n++)i[n]=t.readShort();return i},e.prototype.readAnimation=function(i,n,s){for(var r=new Array,o=this.scale,a=0,l=new t.Color,c=new t.Color,h=0,_=i.readInt(!0);h<_;h++)for(var u=i.readInt(!0),m=0,p=i.readInt(!0);m<p;m++){var d=i.readByte(),f=i.readInt(!0);switch(d){case e.SLOT_ATTACHMENT:(x=new t.AttachmentTimeline(f)).slotIndex=u;for(var g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readStringRef());r.push(x),a=Math.max(a,x.frames[f-1]);break;case e.SLOT_COLOR:for((x=new t.ColorTimeline(f)).slotIndex=u,g=0;g<f;g++){var y=i.readFloat();t.Color.rgba8888ToColor(l,i.readInt32()),x.setFrame(g,y,l.r,l.g,l.b,l.a),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[(f-1)*t.ColorTimeline.ENTRIES]);break;case e.SLOT_TWO_COLOR:for((x=new t.TwoColorTimeline(f)).slotIndex=u,g=0;g<f;g++)y=i.readFloat(),t.Color.rgba8888ToColor(l,i.readInt32()),t.Color.rgb888ToColor(c,i.readInt32()),x.setFrame(g,y,l.r,l.g,l.b,l.a,c.r,c.g,c.b),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TwoColorTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var v=i.readInt(!0);for(m=0,p=i.readInt(!0);m<p;m++)switch(d=i.readByte(),f=i.readInt(!0),d){case e.BONE_ROTATE:for((x=new t.RotateTimeline(f)).boneIndex=v,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.RotateTimeline.ENTRIES]);break;case e.BONE_TRANSLATE:case e.BONE_SCALE:case e.BONE_SHEAR:var x=void 0,b=1;for(d==e.BONE_SCALE?x=new t.ScaleTimeline(f):d==e.BONE_SHEAR?x=new t.ShearTimeline(f):(x=new t.TranslateTimeline(f),b=o),x.boneIndex=v,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*b,i.readFloat()*b),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TranslateTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var S=i.readInt(!0);for(f=i.readInt(!0),(x=new t.IkConstraintTimeline(f)).ikConstraintIndex=S,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()*o,i.readByte(),i.readBoolean(),i.readBoolean()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.IkConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){for(S=i.readInt(!0),f=i.readInt(!0),(x=new t.TransformConstraintTimeline(f)).transformConstraintIndex=S,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.TransformConstraintTimeline.ENTRIES])}for(h=0,_=i.readInt(!0);h<_;h++){S=i.readInt(!0);var A=s.pathConstraints[S];for(m=0,p=i.readInt(!0);m<p;m++)switch(d=i.readByte(),f=i.readInt(!0),d){case e.PATH_POSITION:case e.PATH_SPACING:for(x=void 0,b=1,d==e.PATH_SPACING?(x=new t.PathConstraintSpacingTimeline(f),A.spacingMode!=t.SpacingMode.Length&&A.spacingMode!=t.SpacingMode.Fixed||(b=o)):(x=new t.PathConstraintPositionTimeline(f),A.positionMode==t.PositionMode.Fixed&&(b=o)),x.pathConstraintIndex=S,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat()*b),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintPositionTimeline.ENTRIES]);break;case e.PATH_MIX:for((x=new t.PathConstraintMixTimeline(f)).pathConstraintIndex=S,g=0;g<f;g++)x.setFrame(g,i.readFloat(),i.readFloat(),i.readFloat()),g<f-1&&this.readCurve(i,g,x);r.push(x),a=Math.max(a,x.frames[(f-1)*t.PathConstraintMixTimeline.ENTRIES])}}for(h=0,_=i.readInt(!0);h<_;h++){var C=s.skins[i.readInt(!0)];for(m=0,p=i.readInt(!0);m<p;m++){u=i.readInt(!0);for(var T=0,w=i.readInt(!0);T<w;T++){var E=C.getAttachment(u,i.readStringRef()),P=null!=E.bones,D=E.vertices,I=P?D.length/3*2:D.length;for(f=i.readInt(!0),(x=new t.DeformTimeline(f)).slotIndex=u,x.attachment=E,g=0;g<f;g++){y=i.readFloat();var R=void 0,M=i.readInt(!0);if(0==M)R=P?t.Utils.newFloatArray(I):D;else{R=t.Utils.newFloatArray(I);var O=i.readInt(!0);if(M+=O,1==o)for(var B=O;B<M;B++)R[B]=i.readFloat();else for(B=O;B<M;B++)R[B]=i.readFloat()*o;if(!P){B=0;for(var N=R.length;B<N;B++)R[B]+=D[B]}}x.setFrame(g,y,R),g<f-1&&this.readCurve(i,g,x)}r.push(x),a=Math.max(a,x.frames[f-1])}}}var L=i.readInt(!0);if(L>0){x=new t.DrawOrderTimeline(L);var F=s.slots.length;for(h=0;h<L;h++){y=i.readFloat();var z=i.readInt(!0),V=t.Utils.newArray(F,0);for(m=F-1;m>=0;m--)V[m]=-1;var U=t.Utils.newArray(F-z,0),G=0,k=0;for(m=0;m<z;m++){for(u=i.readInt(!0);G!=u;)U[k++]=G++;V[G+i.readInt(!0)]=G++}for(;G<F;)U[k++]=G++;for(m=F-1;m>=0;m--)-1==V[m]&&(V[m]=U[--k]);x.setFrame(h,y,V)}r.push(x),a=Math.max(a,x.frames[L-1])}var H=i.readInt(!0);if(H>0){for(x=new t.EventTimeline(H),h=0;h<H;h++){y=i.readFloat();var j=s.events[i.readInt(!0)],W=new t.Event(y,j);W.intValue=i.readInt(!1),W.floatValue=i.readFloat(),W.stringValue=i.readBoolean()?i.readString():j.stringValue,null!=W.data.audioPath&&(W.volume=i.readFloat(),W.balance=i.readFloat()),x.setFrame(h,W)}r.push(x),a=Math.max(a,x.frames[H-1])}return new t.Animation(n,r,a)},e.prototype.readCurve=function(t,i,n){switch(t.readByte()){case e.CURVE_STEPPED:n.setStepped(i);break;case e.CURVE_BEZIER:this.setCurve(n,i,t.readFloat(),t.readFloat(),t.readFloat(),t.readFloat())}},e.prototype.setCurve=function(t,e,i,n,s,r){t.setCurve(e,i,n,s,r)},e.AttachmentTypeValues=[0,1,2,3,4,5,6],e.TransformModeValues=[t.TransformMode.Normal,t.TransformMode.OnlyTranslation,t.TransformMode.NoRotationOrReflection,t.TransformMode.NoScale,t.TransformMode.NoScaleOrReflection],e.PositionModeValues=[t.PositionMode.Fixed,t.PositionMode.Percent],e.SpacingModeValues=[t.SpacingMode.Length,t.SpacingMode.Fixed,t.SpacingMode.Percent],e.RotateModeValues=[t.RotateMode.Tangent,t.RotateMode.Chain,t.RotateMode.ChainScale],e.BlendModeValues=[t.BlendMode.Normal,t.BlendMode.Additive,t.BlendMode.Multiply,t.BlendMode.Screen],e.BONE_ROTATE=0,e.BONE_TRANSLATE=1,e.BONE_SCALE=2,e.BONE_SHEAR=3,e.SLOT_ATTACHMENT=0,e.SLOT_COLOR=1,e.SLOT_TWO_COLOR=2,e.PATH_POSITION=0,e.PATH_SPACING=1,e.PATH_MIX=2,e.CURVE_LINEAR=0,e.CURVE_STEPPED=1,e.CURVE_BEZIER=2,e}();t.SkeletonBinary=e;var i=function(){function t(t,e,i,n){void 0===e&&(e=new Array),void 0===i&&(i=0),void 0===n&&(n=new DataView(t.buffer)),this.strings=e,this.index=i,this.buffer=n}return t.prototype.readByte=function(){return this.buffer.getInt8(this.index++)},t.prototype.readShort=function(){var t=this.buffer.getInt16(this.index);return this.index+=2,t},t.prototype.readInt32=function(){var t=this.buffer.getInt32(this.index);return this.index+=4,t},t.prototype.readInt=function(t){var e=this.readByte(),i=127&e;return 0!=(128&e)&&(i|=(127&(e=this.readByte()))<<7,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<14,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<21,0!=(128&e)&&(i|=(127&(e=this.readByte()))<<28)))),t?i:i>>>1^-(1&i)},t.prototype.readStringRef=function(){var t=this.readInt(!0);return 0==t?null:this.strings[t-1]},t.prototype.readString=function(){var t=this.readInt(!0);switch(t){case 0:return null;case 1:return""}t--;for(var e="",i=0;i<t;){var n=this.readByte();switch(n>>4){case 12:case 13:e+=String.fromCharCode((31&n)<<6|63&this.readByte()),i+=2;break;case 14:e+=String.fromCharCode((15&n)<<12|(63&this.readByte())<<6|63&this.readByte()),i+=3;break;default:e+=String.fromCharCode(n),i++}}return e},t.prototype.readFloat=function(){var t=this.buffer.getFloat32(this.index);return this.index+=4,t},t.prototype.readBoolean=function(){return 0!=this.readByte()},t}(),n=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s},s=function(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.bones=t,this.vertices=e}}(Ont||(Ont={})),function(t){var e=function(){function e(){this.minX=0,this.minY=0,this.maxX=0,this.maxY=0,this.boundingBoxes=new Array,this.polygons=new Array,this.polygonPool=new t.Pool((function(){return t.Utils.newFloatArray(16)}))}return e.prototype.update=function(e,i){if(null==e)throw new Error("skeleton cannot be null.");var n=this.boundingBoxes,s=this.polygons,r=this.polygonPool,o=e.slots,a=o.length;n.length=0,r.freeAll(s),s.length=0;for(var l=0;l<a;l++){var c=o[l];if(c.bone.active){var h=c.getAttachment();if(h instanceof t.BoundingBoxAttachment){var _=h;n.push(_);var u=r.obtain();u.length!=_.worldVerticesLength&&(u=t.Utils.newFloatArray(_.worldVerticesLength)),s.push(u),_.computeWorldVertices(c,0,_.worldVerticesLength,u,0,2)}}}i?this.aabbCompute():(this.minX=Number.POSITIVE_INFINITY,this.minY=Number.POSITIVE_INFINITY,this.maxX=Number.NEGATIVE_INFINITY,this.maxY=Number.NEGATIVE_INFINITY)},e.prototype.aabbCompute=function(){for(var t=Number.POSITIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY,s=this.polygons,r=0,o=s.length;r<o;r++)for(var a=s[r],l=a,c=0,h=a.length;c<h;c+=2){var _=l[c],u=l[c+1];t=Math.min(t,_),e=Math.min(e,u),i=Math.max(i,_),n=Math.max(n,u)}this.minX=t,this.minY=e,this.maxX=i,this.maxY=n},e.prototype.aabbContainsPoint=function(t,e){return t>=this.minX&&t<=this.maxX&&e>=this.minY&&e<=this.maxY},e.prototype.aabbIntersectsSegment=function(t,e,i,n){var s=this.minX,r=this.minY,o=this.maxX,a=this.maxY;if(t<=s&&i<=s||e<=r&&n<=r||t>=o&&i>=o||e>=a&&n>=a)return!1;var l=(n-e)/(i-t),c=l*(s-t)+e;if(c>r&&c<a)return!0;if((c=l*(o-t)+e)>r&&c<a)return!0;var h=(r-e)/l+t;return h>s&&h<o||(h=(a-e)/l+t)>s&&h<o},e.prototype.aabbIntersectsSkeleton=function(t){return this.minX<t.maxX&&this.maxX>t.minX&&this.minY<t.maxY&&this.maxY>t.minY},e.prototype.containsPoint=function(t,e){for(var i=this.polygons,n=0,s=i.length;n<s;n++)if(this.containsPointPolygon(i[n],t,e))return this.boundingBoxes[n];return null},e.prototype.containsPointPolygon=function(t,e,i){for(var n=t,s=t.length,r=s-2,o=!1,a=0;a<s;a+=2){var l=n[a+1],c=n[r+1];if(l<i&&c>=i||c<i&&l>=i){var h=n[a];h+(i-l)/(c-l)*(n[r]-h)<e&&(o=!o)}r=a}return o},e.prototype.intersectsSegment=function(t,e,i,n){for(var s=this.polygons,r=0,o=s.length;r<o;r++)if(this.intersectsSegmentPolygon(s[r],t,e,i,n))return this.boundingBoxes[r];return null},e.prototype.intersectsSegmentPolygon=function(t,e,i,n,s){for(var r=t,o=t.length,a=e-n,l=i-s,c=e*s-i*n,h=r[o-2],_=r[o-1],u=0;u<o;u+=2){var m=r[u],p=r[u+1],d=h*p-_*m,f=h-m,g=_-p,y=a*g-l*f,v=(c*f-a*d)/y;if((v>=h&&v<=m||v>=m&&v<=h)&&(v>=e&&v<=n||v>=n&&v<=e)){var x=(c*g-l*d)/y;if((x>=_&&x<=p||x>=p&&x<=_)&&(x>=i&&x<=s||x>=s&&x<=i))return!0}h=m,_=p}return!1},e.prototype.getPolygon=function(t){if(null==t)throw new Error("boundingBox cannot be null.");var e=this.boundingBoxes.indexOf(t);return-1==e?null:this.polygons[e]},e.prototype.getWidth=function(){return this.maxX-this.minX},e.prototype.getHeight=function(){return this.maxY-this.minY},e}();t.SkeletonBounds=e}(Ont||(Ont={})),function(t){var e=function(){function e(){this.triangulator=new t.Triangulator,this.clippingPolygon=new Array,this.clipOutput=new Array,this.clippedVertices=new Array,this.clippedTriangles=new Array,this.scratch=new Array}return e.prototype.clipStart=function(i,n){if(null!=this.clipAttachment)return 0;this.clipAttachment=n;var s=n.worldVerticesLength,r=t.Utils.setArraySize(this.clippingPolygon,s);n.computeWorldVertices(i,0,s,r,0,2);var o=this.clippingPolygon;e.makeClockwise(o);for(var a=this.clippingPolygons=this.triangulator.decompose(o,this.triangulator.triangulate(o)),l=0,c=a.length;l<c;l++){var h=a[l];e.makeClockwise(h),h.push(h[0]),h.push(h[1])}return a.length},e.prototype.clipEndWithSlot=function(t){null!=this.clipAttachment&&this.clipAttachment.endSlot==t.data&&this.clipEnd()},e.prototype.clipEnd=function(){null!=this.clipAttachment&&(this.clipAttachment=null,this.clippingPolygons=null,this.clippedVertices.length=0,this.clippedTriangles.length=0,this.clippingPolygon.length=0)},e.prototype.isClipping=function(){return null!=this.clipAttachment},e.prototype.clipTriangles=function(e,i,n,s,r,o,a,l,c,h,_){void 0===c&&(c=2),void 0===h&&(h=0),void 0===_&&(_=0);var u=this.clipOutput,m=this.clippedVertices,p=this.clippedTriangles,d=this.clippingPolygons,f=this.clippingPolygons.length,g=l?12:8,y=0;m.length=0,p.length=0;t:for(var v=0;v<s;v+=3)for(var x=n[v]*c,b=e[x+h],S=e[x+h+1],A=r[x+_],C=r[x+_+1],T=e[(x=n[v+1]*c)+h],w=e[x+h+1],E=r[x+_],P=r[x+_+1],D=e[(x=n[v+2]*c)+h],I=e[x+h+1],R=r[x+_],M=r[x+_+1],O=0;O<f;O++){var B=m.length;if(!this.clip(b,S,T,w,D,I,d[O],u)){(H=t.Utils.setArraySize(m,B+3*g))[B]=b,H[B+1]=S,H[B+2]=o.r,H[B+3]=o.g,H[B+4]=o.b,H[B+5]=o.a,l?(H[B+6]=A,H[B+7]=C,H[B+8]=a.r,H[B+9]=a.g,H[B+10]=a.b,H[B+11]=a.a,H[B+12]=T,H[B+13]=w,H[B+14]=o.r,H[B+15]=o.g,H[B+16]=o.b,H[B+17]=o.a,H[B+18]=E,H[B+19]=P,H[B+20]=a.r,H[B+21]=a.g,H[B+22]=a.b,H[B+23]=a.a,H[B+24]=D,H[B+25]=I,H[B+26]=o.r,H[B+27]=o.g,H[B+28]=o.b,H[B+29]=o.a,H[B+30]=R,H[B+31]=M,H[B+32]=a.r,H[B+33]=a.g,H[B+34]=a.b,H[B+35]=a.a):(H[B+6]=A,H[B+7]=C,H[B+8]=T,H[B+9]=w,H[B+10]=o.r,H[B+11]=o.g,H[B+12]=o.b,H[B+13]=o.a,H[B+14]=E,H[B+15]=P,H[B+16]=D,H[B+17]=I,H[B+18]=o.r,H[B+19]=o.g,H[B+20]=o.b,H[B+21]=o.a,H[B+22]=R,H[B+23]=M),B=p.length,(Z=t.Utils.setArraySize(p,B+3))[B]=y,Z[B+1]=y+1,Z[B+2]=y+2,y+=3;continue t}var N=u.length;if(0!=N){for(var L=w-I,F=D-T,z=b-D,V=I-S,U=1/(L*z+F*(S-I)),G=N>>1,k=this.clipOutput,H=t.Utils.setArraySize(m,B+G*g),j=0;j<N;j+=2){var W=k[j],q=k[j+1];H[B]=W,H[B+1]=q,H[B+2]=o.r,H[B+3]=o.g,H[B+4]=o.b,H[B+5]=o.a;var X=W-D,Y=q-I,K=(L*X+F*Y)*U,$=(V*X+z*Y)*U,J=1-K-$;H[B+6]=A*K+E*$+R*J,H[B+7]=C*K+P*$+M*J,l&&(H[B+8]=a.r,H[B+9]=a.g,H[B+10]=a.b,H[B+11]=a.a),B+=g}B=p.length;var Z=t.Utils.setArraySize(p,B+3*(G-2));for(G--,j=1;j<G;j++)Z[B]=y,Z[B+1]=y+j,Z[B+2]=y+j+1,B+=3;y+=G+1}}},e.prototype.clip=function(t,e,i,n,s,r,o,a){var l=a,c=!1,h=null;o.length%4>=2?(h=a,a=this.scratch):h=this.scratch,h.length=0,h.push(t),h.push(e),h.push(i),h.push(n),h.push(s),h.push(r),h.push(t),h.push(e),a.length=0;for(var _=o,u=o.length-4,m=0;;m+=2){for(var p=_[m],d=_[m+1],f=_[m+2],g=_[m+3],y=p-f,v=d-g,x=h,b=h.length-2,S=a.length,A=0;A<b;A+=2){var C=x[A],T=x[A+1],w=x[A+2],E=x[A+3],P=y*(E-g)-v*(w-f)>0;if(y*(T-g)-v*(C-f)>0){if(P){a.push(w),a.push(E);continue}var D=(R=E-T)*(f-p)-(M=w-C)*(g-d);if(Math.abs(D)>1e-6){var I=(M*(d-T)-R*(p-C))/D;a.push(p+(f-p)*I),a.push(d+(g-d)*I)}else a.push(p),a.push(d)}else if(P){var R,M;D=(R=E-T)*(f-p)-(M=w-C)*(g-d),Math.abs(D)>1e-6?(I=(M*(d-T)-R*(p-C))/D,a.push(p+(f-p)*I),a.push(d+(g-d)*I)):(a.push(p),a.push(d)),a.push(w),a.push(E)}c=!0}if(S==a.length)return l.length=0,!0;if(a.push(a[0]),a.push(a[1]),m==u)break;var O=a;(a=h).length=0,h=O}if(l!=a){l.length=0,m=0;for(var B=a.length-2;m<B;m++)l[m]=a[m]}else l.length=l.length-2;return c},e.makeClockwise=function(t){for(var e=t,i=t.length,n=e[i-2]*e[1]-e[0]*e[i-1],s=0,r=0,o=0,a=0,l=i-3;a<l;a+=2)s=e[a],r=e[a+1],o=e[a+2],n+=s*e[a+3]-o*r;if(!(n<0)){a=0;var c=i-2;for(l=i>>1;a<l;a+=2){var h=e[a],_=e[a+1],u=c-a;e[a]=e[u],e[a+1]=e[u+1],e[u]=h,e[u+1]=_}}},e}();t.SkeletonClipping=e}(Ont||(Ont={})),function(t){var e=function(){function t(){this.bones=new Array,this.slots=new Array,this.skins=new Array,this.events=new Array,this.animations=new Array,this.ikConstraints=new Array,this.transformConstraints=new Array,this.pathConstraints=new Array,this.fps=0}return t.prototype.findBone=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findBoneIndex=function(t){if(null==t)throw new Error("boneName cannot be null.");for(var e=this.bones,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSlot=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findSlotIndex=function(t){if(null==t)throw new Error("slotName cannot be null.");for(var e=this.slots,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t.prototype.findSkin=function(t){if(null==t)throw new Error("skinName cannot be null.");for(var e=this.skins,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findEvent=function(t){if(null==t)throw new Error("eventDataName cannot be null.");for(var e=this.events,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findAnimation=function(t){if(null==t)throw new Error("animationName cannot be null.");for(var e=this.animations,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findIkConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.ikConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findTransformConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.transformConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraint=function(t){if(null==t)throw new Error("constraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++){var s=e[i];if(s.name==t)return s}return null},t.prototype.findPathConstraintIndex=function(t){if(null==t)throw new Error("pathConstraintName cannot be null.");for(var e=this.pathConstraints,i=0,n=e.length;i<n;i++)if(e[i].name==t)return i;return-1},t}();t.SkeletonData=e}(Ont||(Ont={})),function(t){var e=function(){function e(t){this.scale=1,this.linkedMeshes=new Array,this.attachmentLoader=t}return e.prototype.readSkeletonData=function(i){var n=this.scale,s=new t.SkeletonData,r="string"==typeof i?JSON.parse(i):i,o=r.skeleton;if(null!=o&&(s.hash=o.hash,s.version=o.spine,s.x=o.x,s.y=o.y,s.width=o.width,s.height=o.height,s.fps=o.fps,s.imagesPath=o.images),r.bones)for(var a=0;a<r.bones.length;a++){var l=r.bones[a],c=null,h=this.getValue(l,"parent",null);if(null!=h&&null==(c=s.findBone(h)))throw new Error("Parent bone not found: "+h);(p=new t.BoneData(s.bones.length,l.name,c)).length=this.getValue(l,"length",0)*n,p.x=this.getValue(l,"x",0)*n,p.y=this.getValue(l,"y",0)*n,p.rotation=this.getValue(l,"rotation",0),p.scaleX=this.getValue(l,"scaleX",1),p.scaleY=this.getValue(l,"scaleY",1),p.shearX=this.getValue(l,"shearX",0),p.shearY=this.getValue(l,"shearY",0),p.transformMode=e.transformModeFromString(this.getValue(l,"transform","normal")),p.skinRequired=this.getValue(l,"skin",!1),s.bones.push(p)}if(r.slots)for(a=0;a<r.slots.length;a++){var _=(D=r.slots[a]).name,u=D.bone,m=s.findBone(u);if(null==m)throw new Error("Slot bone not found: "+u);var p=new t.SlotData(s.slots.length,_,m),d=this.getValue(D,"color",null);null!=d&&p.color.setFromString(d);var f=this.getValue(D,"dark",null);null!=f&&(p.darkColor=new t.Color(1,1,1,1),p.darkColor.setFromString(f)),p.attachmentName=this.getValue(D,"attachment",null),p.blendMode=e.blendModeFromString(this.getValue(D,"blend","normal")),s.slots.push(p)}if(r.ik)for(a=0;a<r.ik.length;a++){var g=r.ik[a];(p=new t.IkConstraintData(g.name)).order=this.getValue(g,"order",0),p.skinRequired=this.getValue(g,"skin",!1);for(var y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("IK bone not found: "+u);p.bones.push(w)}var v=g.target;if(p.target=s.findBone(v),null==p.target)throw new Error("IK target bone not found: "+v);p.mix=this.getValue(g,"mix",1),p.softness=this.getValue(g,"softness",0)*n,p.bendDirection=this.getValue(g,"bendPositive",!0)?1:-1,p.compress=this.getValue(g,"compress",!1),p.stretch=this.getValue(g,"stretch",!1),p.uniform=this.getValue(g,"uniform",!1),s.ikConstraints.push(p)}if(r.transform)for(a=0;a<r.transform.length;a++){for(g=r.transform[a],(p=new t.TransformConstraintData(g.name)).order=this.getValue(g,"order",0),p.skinRequired=this.getValue(g,"skin",!1),y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);p.bones.push(w)}if(v=g.target,p.target=s.findBone(v),null==p.target)throw new Error("Transform constraint target bone not found: "+v);p.local=this.getValue(g,"local",!1),p.relative=this.getValue(g,"relative",!1),p.offsetRotation=this.getValue(g,"rotation",0),p.offsetX=this.getValue(g,"x",0)*n,p.offsetY=this.getValue(g,"y",0)*n,p.offsetScaleX=this.getValue(g,"scaleX",0),p.offsetScaleY=this.getValue(g,"scaleY",0),p.offsetShearY=this.getValue(g,"shearY",0),p.rotateMix=this.getValue(g,"rotateMix",1),p.translateMix=this.getValue(g,"translateMix",1),p.scaleMix=this.getValue(g,"scaleMix",1),p.shearMix=this.getValue(g,"shearMix",1),s.transformConstraints.push(p)}if(r.path)for(a=0;a<r.path.length;a++){for(g=r.path[a],(p=new t.PathConstraintData(g.name)).order=this.getValue(g,"order",0),p.skinRequired=this.getValue(g,"skin",!1),y=0;y<g.bones.length;y++){if(u=g.bones[y],null==(w=s.findBone(u)))throw new Error("Transform constraint bone not found: "+u);p.bones.push(w)}if(v=g.target,p.target=s.findSlot(v),null==p.target)throw new Error("Path target slot not found: "+v);p.positionMode=e.positionModeFromString(this.getValue(g,"positionMode","percent")),p.spacingMode=e.spacingModeFromString(this.getValue(g,"spacingMode","length")),p.rotateMode=e.rotateModeFromString(this.getValue(g,"rotateMode","tangent")),p.offsetRotation=this.getValue(g,"rotation",0),p.position=this.getValue(g,"position",0),p.positionMode==t.PositionMode.Fixed&&(p.position*=n),p.spacing=this.getValue(g,"spacing",0),p.spacingMode!=t.SpacingMode.Length&&p.spacingMode!=t.SpacingMode.Fixed||(p.spacing*=n),p.rotateMix=this.getValue(g,"rotateMix",1),p.translateMix=this.getValue(g,"translateMix",1),s.pathConstraints.push(p)}if(r.skins){var x=r.skins;if(!(x instanceof Array)){var b=[];for(var S in x)b.push({name:S,attachments:x[S]});x=b}for(a=0;a<x.length;a++){var A=x[a],C=new t.Skin(A.name);if(A.bones)for(var T=0;T<A.bones.length;T++){var w;if(null==(w=s.findBone(A.bones[T])))throw new Error("Skin bone not found: "+A.bones[a]);C.bones.push(w)}if(A.ik)for(T=0;T<A.ik.length;T++){if(null==(E=s.findIkConstraint(A.ik[T])))throw new Error("Skin IK constraint not found: "+A.ik[a]);C.constraints.push(E)}if(A.transform)for(T=0;T<A.transform.length;T++){if(null==(E=s.findTransformConstraint(A.transform[T])))throw new Error("Skin transform constraint not found: "+A.transform[a]);C.constraints.push(E)}if(A.path)for(T=0;T<A.path.length;T++){var E;if(null==(E=s.findPathConstraint(A.path[T])))throw new Error("Skin path constraint not found: "+A.path[a]);C.constraints.push(E)}for(var _ in A.attachments){var P=s.findSlot(_);if(null==P)throw new Error("Slot not found: "+_);var D=A.attachments[_];for(var I in D){var R=this.readAttachment(D[I],C,P.index,I,s);null!=R&&C.setAttachment(P.index,I,R)}}s.skins.push(C),"default"==C.name&&(s.defaultSkin=C)}}a=0;for(var M=this.linkedMeshes.length;a<M;a++){var O=this.linkedMeshes[a];if(null==(C=null==O.skin?s.defaultSkin:s.findSkin(O.skin)))throw new Error("Skin not found: "+O.skin);var B=C.getAttachment(O.slotIndex,O.parent);if(null==B)throw new Error("Parent mesh not found: "+O.parent);O.mesh.deformAttachment=O.inheritDeform?B:O.mesh,O.mesh.setParentMesh(B),O.mesh.updateUVs()}if(this.linkedMeshes.length=0,r.events)for(var N in r.events){var L=r.events[N];(p=new t.EventData(N)).intValue=this.getValue(L,"int",0),p.floatValue=this.getValue(L,"float",0),p.stringValue=this.getValue(L,"string",""),p.audioPath=this.getValue(L,"audio",null),null!=p.audioPath&&(p.volume=this.getValue(L,"volume",1),p.balance=this.getValue(L,"balance",0)),s.events.push(p)}if(r.animations)for(var F in r.animations){var z=r.animations[F];this.readAnimation(z,F,s)}return s},e.prototype.readAttachment=function(e,n,s,r,o){var a=this.scale;switch(r=this.getValue(e,"name",r),this.getValue(e,"type","region")){case"region":var l=this.getValue(e,"path",r),c=this.attachmentLoader.newRegionAttachment(n,r,l);return null==c?null:(c.path=l,c.x=this.getValue(e,"x",0)*a,c.y=this.getValue(e,"y",0)*a,c.scaleX=this.getValue(e,"scaleX",1),c.scaleY=this.getValue(e,"scaleY",1),c.rotation=this.getValue(e,"rotation",0),c.width=e.width*a,c.height=e.height*a,null!=(v=this.getValue(e,"color",null))&&c.color.setFromString(v),c.updateOffset(),c);case"boundingbox":var h=this.attachmentLoader.newBoundingBoxAttachment(n,r);return null==h?null:(this.readVertices(e,h,e.vertexCount<<1),null!=(v=this.getValue(e,"color",null))&&h.color.setFromString(v),h);case"mesh":case"linkedmesh":l=this.getValue(e,"path",r);var _=this.attachmentLoader.newMeshAttachment(n,r,l);if(null==_)return null;_.path=l,null!=(v=this.getValue(e,"color",null))&&_.color.setFromString(v),_.width=this.getValue(e,"width",0)*a,_.height=this.getValue(e,"height",0)*a;var u=this.getValue(e,"parent",null);if(null!=u)return this.linkedMeshes.push(new i(_,this.getValue(e,"skin",null),s,u,this.getValue(e,"deform",!0))),_;var m=e.uvs;return this.readVertices(e,_,m.length),_.triangles=e.triangles,_.regionUVs=m,_.updateUVs(),_.edges=this.getValue(e,"edges",null),_.hullLength=2*this.getValue(e,"hull",0),_;case"path":if(null==(l=this.attachmentLoader.newPathAttachment(n,r)))return null;l.closed=this.getValue(e,"closed",!1),l.constantSpeed=this.getValue(e,"constantSpeed",!0);var p=e.vertexCount;this.readVertices(e,l,p<<1);for(var d=t.Utils.newArray(p/3,0),f=0;f<e.lengths.length;f++)d[f]=e.lengths[f]*a;return l.lengths=d,null!=(v=this.getValue(e,"color",null))&&l.color.setFromString(v),l;case"point":var g=this.attachmentLoader.newPointAttachment(n,r);return null==g?null:(g.x=this.getValue(e,"x",0)*a,g.y=this.getValue(e,"y",0)*a,g.rotation=this.getValue(e,"rotation",0),null!=(v=this.getValue(e,"color",null))&&g.color.setFromString(v),g);case"clipping":var y=this.attachmentLoader.newClippingAttachment(n,r);if(null==y)return null;var v,x=this.getValue(e,"end",null);if(null!=x){var b=o.findSlot(x);if(null==b)throw new Error("Clipping end slot not found: "+x);y.endSlot=b}return p=e.vertexCount,this.readVertices(e,y,p<<1),null!=(v=this.getValue(e,"color",null))&&y.color.setFromString(v),y}return null},e.prototype.readVertices=function(e,i,n){var s=this.scale;i.worldVerticesLength=n;var r=e.vertices;if(n!=r.length){var o=new Array,a=new Array;for(_=0,u=r.length;_<u;){var l=r[_++];a.push(l);for(var c=_+4*l;_<c;_+=4)a.push(r[_]),o.push(r[_+1]*s),o.push(r[_+2]*s),o.push(r[_+3])}i.bones=a,i.vertices=t.Utils.toFloatArray(o)}else{var h=t.Utils.toFloatArray(r);if(1!=s)for(var _=0,u=r.length;_<u;_++)h[_]*=s;i.vertices=h}},e.prototype.readAnimation=function(e,i,n){var s=this.scale,r=new Array,o=0;if(e.slots)for(var a in e.slots){var l=e.slots[a];if(-1==(J=n.findSlotIndex(a)))throw new Error("Slot not found: "+a);for(var c in l){var h=l[c];if("attachment"==c){(x=new t.AttachmentTimeline(h.length)).slotIndex=J;for(var _=0,u=0;u<h.length;u++){var m=h[u];x.setFrame(_++,this.getValue(m,"time",0),m.name)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}else if("color"==c){for((x=new t.ColorTimeline(h.length)).slotIndex=J,_=0,u=0;u<h.length;u++){m=h[u];var p=new t.Color;p.setFromString(m.color),x.setFrame(_,this.getValue(m,"time",0),p.r,p.g,p.b,p.a),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.ColorTimeline.ENTRIES])}else{if("twoColor"!=c)throw new Error("Invalid timeline type for a slot: "+c+" ("+a+")");for((x=new t.TwoColorTimeline(h.length)).slotIndex=J,_=0,u=0;u<h.length;u++){m=h[u];var d=new t.Color,f=new t.Color;d.setFromString(m.light),f.setFromString(m.dark),x.setFrame(_,this.getValue(m,"time",0),d.r,d.g,d.b,d.a,f.r,f.g,f.b),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TwoColorTimeline.ENTRIES])}}}if(e.bones)for(var g in e.bones){var y=e.bones[g],v=n.findBoneIndex(g);if(-1==v)throw new Error("Bone not found: "+g);for(var c in y)if(h=y[c],"rotate"===c){for((x=new t.RotateTimeline(h.length)).boneIndex=v,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"angle",0)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.RotateTimeline.ENTRIES])}else{if("translate"!==c&&"scale"!==c&&"shear"!==c)throw new Error("Invalid timeline type for a bone: "+c+" ("+g+")");var x=null,b=1,S=0;for("scale"===c?(x=new t.ScaleTimeline(h.length),S=1):"shear"===c?x=new t.ShearTimeline(h.length):(x=new t.TranslateTimeline(h.length),b=s),x.boneIndex=v,_=0,u=0;u<h.length;u++){m=h[u];var A=this.getValue(m,"x",S),C=this.getValue(m,"y",S);x.setFrame(_,this.getValue(m,"time",0),A*b,C*b),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TranslateTimeline.ENTRIES])}}if(e.ik)for(var T in e.ik){var w=e.ik[T],E=n.findIkConstraint(T);for((x=new t.IkConstraintTimeline(w.length)).ikConstraintIndex=n.ikConstraints.indexOf(E),_=0,u=0;u<w.length;u++)m=w[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"mix",1),this.getValue(m,"softness",0)*s,this.getValue(m,"bendPositive",!0)?1:-1,this.getValue(m,"compress",!1),this.getValue(m,"stretch",!1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.IkConstraintTimeline.ENTRIES])}if(e.transform)for(var T in e.transform){for(w=e.transform[T],E=n.findTransformConstraint(T),(x=new t.TransformConstraintTimeline(w.length)).transformConstraintIndex=n.transformConstraints.indexOf(E),_=0,u=0;u<w.length;u++)m=w[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"rotateMix",1),this.getValue(m,"translateMix",1),this.getValue(m,"scaleMix",1),this.getValue(m,"shearMix",1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.TransformConstraintTimeline.ENTRIES])}let P=e.path||e.paths;if(P)for(var T in P){w=P[T];var D=n.findPathConstraintIndex(T);if(-1==D)throw new Error("Path constraint not found: "+T);var I=n.pathConstraints[D];for(var c in w)if(h=w[c],"position"===c||"spacing"===c){for(x=null,b=1,"spacing"===c?(x=new t.PathConstraintSpacingTimeline(h.length),I.spacingMode!=t.SpacingMode.Length&&I.spacingMode!=t.SpacingMode.Fixed||(b=s)):(x=new t.PathConstraintPositionTimeline(h.length),I.positionMode==t.PositionMode.Fixed&&(b=s)),x.pathConstraintIndex=D,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,c,0)*b),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintPositionTimeline.ENTRIES])}else if("mix"===c){for((x=new t.PathConstraintMixTimeline(h.length)).pathConstraintIndex=D,_=0,u=0;u<h.length;u++)m=h[u],x.setFrame(_,this.getValue(m,"time",0),this.getValue(m,"rotateMix",1),this.getValue(m,"translateMix",1)),this.readCurve(m,x,_),_++;r.push(x),o=Math.max(o,x.frames[(x.getFrameCount()-1)*t.PathConstraintMixTimeline.ENTRIES])}}if(e.deform)for(var R in e.deform){var M=e.deform[R],O=n.findSkin(R);if(null==O)throw new Error("Skin not found: "+R);for(var a in M){if(l=M[a],-1==(J=n.findSlotIndex(a)))throw new Error("Slot not found: "+l.name);for(var c in l){h=l[c];var B=O.getAttachment(J,c);if(null!=B){var N=null!=B.bones,L=B.vertices,F=N?L.length/3*2:L.length;(x=new t.DeformTimeline(h.length)).slotIndex=J,x.attachment=B,_=0;for(var z=0;z<h.length;z++){m=h[z];var V=void 0,U=this.getValue(m,"vertices",null);if(null==U)V=N?t.Utils.newFloatArray(F):L;else{V=t.Utils.newFloatArray(F);var G=this.getValue(m,"offset",0);if(t.Utils.arrayCopy(U,0,V,G,U.length),1!=s)for(var k=(u=G)+U.length;u<k;u++)V[u]*=s;if(!N)for(u=0;u<F;u++)V[u]+=L[u]}x.setFrame(_,this.getValue(m,"time",0),V),this.readCurve(m,x,_),_++}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}}}}var H=e.drawOrder;if(null==H&&(H=e.draworder),null!=H){x=new t.DrawOrderTimeline(H.length);var j=n.slots.length;for(_=0,z=0;z<H.length;z++){var W=H[z],q=null,X=this.getValue(W,"offsets",null);if(null!=X){q=t.Utils.newArray(j,-1);var Y=t.Utils.newArray(j-X.length,0),K=0,$=0;for(u=0;u<X.length;u++){var J,Z=X[u];if(-1==(J=n.findSlotIndex(Z.slot)))throw new Error("Slot not found: "+Z.slot);for(;K!=J;)Y[$++]=K++;q[K+Z.offset]=K++}for(;K<j;)Y[$++]=K++;for(u=j-1;u>=0;u--)-1==q[u]&&(q[u]=Y[--$])}x.setFrame(_++,this.getValue(W,"time",0),q)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(e.events){for(x=new t.EventTimeline(e.events.length),_=0,u=0;u<e.events.length;u++){var Q=e.events[u],tt=n.findEvent(Q.name);if(null==tt)throw new Error("Event not found: "+Q.name);var et=new t.Event(t.Utils.toSinglePrecision(this.getValue(Q,"time",0)),tt);et.intValue=this.getValue(Q,"int",tt.intValue),et.floatValue=this.getValue(Q,"float",tt.floatValue),et.stringValue=this.getValue(Q,"string",tt.stringValue),null!=et.data.audioPath&&(et.volume=this.getValue(Q,"volume",1),et.balance=this.getValue(Q,"balance",0)),x.setFrame(_++,et)}r.push(x),o=Math.max(o,x.frames[x.getFrameCount()-1])}if(isNaN(o))throw new Error("Error while parsing animation, duration is NaN");n.animations.push(new t.Animation(i,r,o))},e.prototype.readCurve=function(t,e,i){var n=t.curve;n&&("stepped"==n?e.setStepped(i):"[object Array]"===Object.prototype.toString.call(n)?e.setCurve(i,n[0],n[1],n[2],n[3]):e.setCurve(i,n,this.getValue(t,"c2",0),this.getValue(t,"c3",1),this.getValue(t,"c4",1)))},e.prototype.getValue=function(t,e,i){return void 0!==t[e]?t[e]:i},e.blendModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.BlendMode.Normal;if("additive"==e)return t.BlendMode.Additive;if("multiply"==e)return t.BlendMode.Multiply;if("screen"==e)return t.BlendMode.Screen;throw new Error("Unknown blend mode: "+e)},e.positionModeFromString=function(e){if("fixed"==(e=e.toLowerCase()))return t.PositionMode.Fixed;if("percent"==e)return t.PositionMode.Percent;throw new Error("Unknown position mode: "+e)},e.spacingModeFromString=function(e){if("length"==(e=e.toLowerCase()))return t.SpacingMode.Length;if("fixed"==e)return t.SpacingMode.Fixed;if("percent"==e)return t.SpacingMode.Percent;throw new Error("Unknown position mode: "+e)},e.rotateModeFromString=function(e){if("tangent"==(e=e.toLowerCase()))return t.RotateMode.Tangent;if("chain"==e)return t.RotateMode.Chain;if("chainscale"==e)return t.RotateMode.ChainScale;throw new Error("Unknown rotate mode: "+e)},e.transformModeFromString=function(e){if("normal"==(e=e.toLowerCase()))return t.TransformMode.Normal;if("onlytranslation"==e)return t.TransformMode.OnlyTranslation;if("norotationorreflection"==e)return t.TransformMode.NoRotationOrReflection;if("noscale"==e)return t.TransformMode.NoScale;if("noscaleorreflection"==e)return t.TransformMode.NoScaleOrReflection;throw new Error("Unknown transform mode: "+e)},e}();t.SkeletonJson=e;var i=function(t,e,i,n,s){this.mesh=t,this.skin=e,this.slotIndex=i,this.parent=n,this.inheritDeform=s}}(Ont||(Ont={})),function(t){var e=function(t,e,i){this.slotIndex=t,this.name=e,this.attachment=i};t.SkinEntry=e;var i=function(){function i(t){if(this.attachments=new Array,this.bones=Array(),this.constraints=new Array,null==t)throw new Error("name cannot be null.");this.name=t}return i.prototype.setAttachment=function(t,e,i){if(null==i)throw new Error("attachment cannot be null.");var n=this.attachments;t>=n.length&&(n.length=t+1),n[t]||(n[t]={}),n[t][e]=i},i.prototype.addSkin=function(t){for(var e=0;e<t.bones.length;e++){for(var i=t.bones[e],n=!1,s=0;s<this.bones.length;s++)if(this.bones[s]==i){n=!0;break}n||this.bones.push(i)}for(e=0;e<t.constraints.length;e++){var r=t.constraints[e];for(n=!1,s=0;s<this.constraints.length;s++)if(this.constraints[s]==r){n=!0;break}n||this.constraints.push(r)}var o=t.getAttachments();for(e=0;e<o.length;e++){var a=o[e];this.setAttachment(a.slotIndex,a.name,a.attachment)}},i.prototype.copySkin=function(e){for(var i=0;i<e.bones.length;i++){for(var n=e.bones[i],s=!1,r=0;r<this.bones.length;r++)if(this.bones[r]==n){s=!0;break}s||this.bones.push(n)}for(i=0;i<e.constraints.length;i++){var o=e.constraints[i];for(s=!1,r=0;r<this.constraints.length;r++)if(this.constraints[r]==o){s=!0;break}s||this.constraints.push(o)}var a=e.getAttachments();for(i=0;i<a.length;i++){var l=a[i];null!=l.attachment&&(l.attachment instanceof t.MeshAttachment?(l.attachment=l.attachment.newLinkedMesh(),this.setAttachment(l.slotIndex,l.name,l.attachment)):(l.attachment=l.attachment.copy(),this.setAttachment(l.slotIndex,l.name,l.attachment)))}},i.prototype.getAttachment=function(t,e){var i=this.attachments[t];return i?i[e]:null},i.prototype.removeAttachment=function(t,e){var i=this.attachments[t];i&&(i[e]=null)},i.prototype.getAttachments=function(){for(var t=new Array,i=0;i<this.attachments.length;i++){var n=this.attachments[i];if(n)for(var s in n){var r=n[s];r&&t.push(new e(i,s,r))}}return t},i.prototype.getAttachmentsForSlot=function(t,i){var n=this.attachments[t];if(n)for(var s in n){var r=n[s];r&&i.push(new e(t,s,r))}},i.prototype.clear=function(){this.attachments.length=0,this.bones.length=0,this.constraints.length=0},i.prototype.attachAll=function(t,e){for(var i=0,n=0;n<t.slots.length;n++){var s=t.slots[n],r=s.getAttachment();if(r&&i<e.attachments.length){var o=e.attachments[i];for(var a in o)if(r==o[a]){var l=this.getAttachment(i,a);null!=l&&s.setAttachment(l);break}}i++}},i}();t.Skin=i}(Ont||(Ont={})),function(t){var e=function(){function e(e,i){if(this.deform=new Array,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("bone cannot be null.");this.data=e,this.bone=i,this.color=new t.Color,this.darkColor=null==e.darkColor?null:new t.Color,this.setToSetupPose()}return e.prototype.getSkeleton=function(){return this.bone.skeleton},e.prototype.getAttachment=function(){return this.attachment},e.prototype.setAttachment=function(t){this.attachment!=t&&(this.attachment=t,this.attachmentTime=this.bone.skeleton.time,this.deform.length=0)},e.prototype.setAttachmentTime=function(t){this.attachmentTime=this.bone.skeleton.time-t},e.prototype.getAttachmentTime=function(){return this.bone.skeleton.time-this.attachmentTime},e.prototype.setToSetupPose=function(){this.color.setFromColor(this.data.color),null!=this.darkColor&&this.darkColor.setFromColor(this.data.darkColor),null==this.data.attachmentName?this.attachment=null:(this.attachment=null,this.setAttachment(this.bone.skeleton.getAttachment(this.data.index,this.data.attachmentName)))},e}();t.Slot=e}(Ont||(Ont={})),function(t){t.SlotData=function(e,i,n){if(this.color=new t.Color(1,1,1,1),e<0)throw new Error("index must be >= 0.");if(null==i)throw new Error("name cannot be null.");if(null==n)throw new Error("boneData cannot be null.");this.index=e,this.name=i,this.boneData=n}}(Ont||(Ont={})),function(t){var e,i,n=function(){function t(t){this._image=t}return t.prototype.getImage=function(){return this._image},t.filterFromString=function(t){switch(t.toLowerCase()){case"nearest":return e.Nearest;case"linear":return e.Linear;case"mipmap":return e.MipMap;case"mipmapnearestnearest":return e.MipMapNearestNearest;case"mipmaplinearnearest":return e.MipMapLinearNearest;case"mipmapnearestlinear":return e.MipMapNearestLinear;case"mipmaplinearlinear":return e.MipMapLinearLinear;default:throw new Error("Unknown texture filter "+t)}},t.wrapFromString=function(t){switch(t.toLowerCase()){case"mirroredtepeat":return i.MirroredRepeat;case"clamptoedge":return i.ClampToEdge;case"repeat":return i.Repeat;default:throw new Error("Unknown texture wrap "+t)}},t}();t.Texture=n,function(t){t[t.Nearest=9728]="Nearest",t[t.Linear=9729]="Linear",t[t.MipMap=9987]="MipMap",t[t.MipMapNearestNearest=9984]="MipMapNearestNearest",t[t.MipMapLinearNearest=9985]="MipMapLinearNearest",t[t.MipMapNearestLinear=9986]="MipMapNearestLinear",t[t.MipMapLinearLinear=9987]="MipMapLinearLinear"}(e=t.TextureFilter||(t.TextureFilter={})),function(t){t[t.MirroredRepeat=33648]="MirroredRepeat",t[t.ClampToEdge=33071]="ClampToEdge",t[t.Repeat=10497]="Repeat"}(i=t.TextureWrap||(t.TextureWrap={}));t.TextureRegion=function(){this.u=0,this.v=0,this.u2=0,this.v2=0,this.width=0,this.height=0,this.rotate=!1,this.offsetX=0,this.offsetY=0,this.originalWidth=0,this.originalHeight=0};var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bnt(e,t),e.prototype.setFilters=function(){},e.prototype.setWraps=function(){},e.prototype.dispose=function(){},e}(n);t.FakeTexture=s}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){this.pages=new Array,this.regions=new Array,this.load(t,e)}return e.prototype.load=function(e,r){if(null==r)throw new Error("textureLoader cannot be null.");for(var o=new i(e),a=new Array(4),l=null;;){var c=o.readLine();if(null==c)break;if(0==(c=c.trim()).length)l=null;else if(l){var h=new s;h.name=c,h.page=l;var _=o.readValue();"true"==_.toLocaleLowerCase()?h.degrees=90:"false"==_.toLocaleLowerCase()?h.degrees=0:h.degrees=parseFloat(_),h.rotate=90==h.degrees,o.readTuple(a);var u=parseInt(a[0]),m=parseInt(a[1]);o.readTuple(a);var p=parseInt(a[0]),d=parseInt(a[1]);h.u=u/l.width,h.v=m/l.height,h.rotate?(h.u2=(u+d)/l.width,h.v2=(m+p)/l.height):(h.u2=(u+p)/l.width,h.v2=(m+d)/l.height),h.x=u,h.y=m,h.width=Math.abs(p),h.height=Math.abs(d),4==o.readTuple(a)&&4==o.readTuple(a)&&o.readTuple(a),h.originalWidth=parseInt(a[0]),h.originalHeight=parseInt(a[1]),o.readTuple(a),h.offsetX=parseInt(a[0]),h.offsetY=parseInt(a[1]),h.index=parseInt(o.readValue()),h.texture=l.texture,this.regions.push(h)}else{(l=new n).name=c,2==o.readTuple(a)&&(l.width=parseInt(a[0]),l.height=parseInt(a[1]),o.readTuple(a)),o.readTuple(a),l.minFilter=t.Texture.filterFromString(a[0]),l.magFilter=t.Texture.filterFromString(a[1]);var f=o.readValue();l.uWrap=t.TextureWrap.ClampToEdge,l.vWrap=t.TextureWrap.ClampToEdge,"x"==f?l.uWrap=t.TextureWrap.Repeat:"y"==f?l.vWrap=t.TextureWrap.Repeat:"xy"==f&&(l.uWrap=l.vWrap=t.TextureWrap.Repeat),l.texture=r(c),l.texture.setFilters(l.minFilter,l.magFilter),l.texture.setWraps(l.uWrap,l.vWrap),l.width=l.texture.getImage().width,l.height=l.texture.getImage().height,this.pages.push(l)}}},e.prototype.findRegion=function(t){for(var e=0;e<this.regions.length;e++)if(this.regions[e].name==t)return this.regions[e];return null},e.prototype.dispose=function(){for(var t=0;t<this.pages.length;t++)this.pages[t].texture.dispose()},e}();t.TextureAtlas=e;var i=function(){function t(t){this.index=0,this.lines=t.split(/\r\n|\r|\n/)}return t.prototype.readLine=function(){return this.index>=this.lines.length?null:this.lines[this.index++]},t.prototype.readValue=function(){var t=this.readLine(),e=t.indexOf(":");if(-1==e)throw new Error("Invalid line: "+t);return t.substring(e+1).trim()},t.prototype.readTuple=function(t){var e=this.readLine(),i=e.indexOf(":");if(-1==i)throw new Error("Invalid line: "+e);for(var n=0,s=i+1;n<3;n++){var r=e.indexOf(",",s);if(-1==r)break;t[n]=e.substr(s,r-s).trim(),s=r+1}return t[n]=e.substring(s).trim(),n+1},t}(),n=function(){};t.TextureAtlasPage=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return Bnt(e,t),e}(t.TextureRegion);t.TextureAtlasRegion=s}(Ont||(Ont={})),function(t){var e=function(){function e(e,i){if(this.rotateMix=0,this.translateMix=0,this.scaleMix=0,this.shearMix=0,this.temp=new t.Vector2,this.active=!1,null==e)throw new Error("data cannot be null.");if(null==i)throw new Error("skeleton cannot be null.");this.data=e,this.rotateMix=e.rotateMix,this.translateMix=e.translateMix,this.scaleMix=e.scaleMix,this.shearMix=e.shearMix,this.bones=new Array;for(var n=0;n<e.bones.length;n++)this.bones.push(i.findBone(e.bones[n].name));this.target=i.findBone(e.target.name)}return e.prototype.isActive=function(){return this.active},e.prototype.apply=function(){this.update()},e.prototype.update=function(){this.data.local?this.data.relative?this.applyRelativeLocal():this.applyAbsoluteLocal():this.data.relative?this.applyRelativeWorld():this.applyAbsoluteWorld()},e.prototype.applyAbsoluteWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,l=r.c,c=r.d,h=o*c-a*l>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,m=this.bones,p=0,d=m.length;p<d;p++){var f=m[p],g=!1;if(0!=e){var y=f.a,v=f.b,x=f.c,b=f.d;(E=Math.atan2(l,o)-Math.atan2(x,y)+_)>t.MathUtils.PI?E-=t.MathUtils.PI2:E<-t.MathUtils.PI&&(E+=t.MathUtils.PI2),E*=e;var S=Math.cos(E),A=Math.sin(E);f.a=S*y-A*x,f.b=S*v-A*b,f.c=A*y+S*x,f.d=A*v+S*b,g=!0}if(0!=i){var C=this.temp;r.localToWorld(C.set(this.data.offsetX,this.data.offsetY)),f.worldX+=(C.x-f.worldX)*i,f.worldY+=(C.y-f.worldY)*i,g=!0}if(n>0){var T=Math.sqrt(f.a*f.a+f.c*f.c),w=Math.sqrt(o*o+l*l);T>1e-5&&(T=(T+(w-T+this.data.offsetScaleX)*n)/T),f.a*=T,f.c*=T,T=Math.sqrt(f.b*f.b+f.d*f.d),w=Math.sqrt(a*a+c*c),T>1e-5&&(T=(T+(w-T+this.data.offsetScaleY)*n)/T),f.b*=T,f.d*=T,g=!0}if(s>0){v=f.b,b=f.d;var E,P=Math.atan2(b,v);(E=Math.atan2(c,a)-Math.atan2(l,o)-(P-Math.atan2(f.c,f.a)))>t.MathUtils.PI?E-=t.MathUtils.PI2:E<-t.MathUtils.PI&&(E+=t.MathUtils.PI2),E=P+(E+u)*s,T=Math.sqrt(v*v+b*b),f.b=Math.cos(E)*T,f.d=Math.sin(E)*T,g=!0}g&&(f.appliedValid=!1)}},e.prototype.applyRelativeWorld=function(){for(var e=this.rotateMix,i=this.translateMix,n=this.scaleMix,s=this.shearMix,r=this.target,o=r.a,a=r.b,l=r.c,c=r.d,h=o*c-a*l>0?t.MathUtils.degRad:-t.MathUtils.degRad,_=this.data.offsetRotation*h,u=this.data.offsetShearY*h,m=this.bones,p=0,d=m.length;p<d;p++){var f,g=m[p],y=!1;if(0!=e){var v=g.a,x=g.b,b=g.c,S=g.d;(f=Math.atan2(l,o)+_)>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),f*=e;var A=Math.cos(f),C=Math.sin(f);g.a=A*v-C*b,g.b=A*x-C*S,g.c=C*v+A*b,g.d=C*x+A*S,y=!0}if(0!=i){var T=this.temp;r.localToWorld(T.set(this.data.offsetX,this.data.offsetY)),g.worldX+=T.x*i,g.worldY+=T.y*i,y=!0}if(n>0){var w=(Math.sqrt(o*o+l*l)-1+this.data.offsetScaleX)*n+1;g.a*=w,g.c*=w,w=(Math.sqrt(a*a+c*c)-1+this.data.offsetScaleY)*n+1,g.b*=w,g.d*=w,y=!0}if(s>0)(f=Math.atan2(c,a)-Math.atan2(l,o))>t.MathUtils.PI?f-=t.MathUtils.PI2:f<-t.MathUtils.PI&&(f+=t.MathUtils.PI2),x=g.b,S=g.d,f=Math.atan2(S,x)+(f-t.MathUtils.PI/2+u)*s,w=Math.sqrt(x*x+S*S),g.b=Math.cos(f)*w,g.d=Math.sin(f)*w,y=!0;y&&(g.appliedValid=!1)}},e.prototype.applyAbsoluteLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var l=r[o];l.appliedValid||l.updateAppliedTransform();var c=l.arotation;if(0!=t){var h=s.arotation-c+this.data.offsetRotation;c+=(h-=360*(16384-(16384.499999999996-h/360|0)))*t}var _=l.ax,u=l.ay;0!=e&&(_+=(s.ax-_+this.data.offsetX)*e,u+=(s.ay-u+this.data.offsetY)*e);var m=l.ascaleX,p=l.ascaleY;0!=i&&(m>1e-5&&(m=(m+(s.ascaleX-m+this.data.offsetScaleX)*i)/m),p>1e-5&&(p=(p+(s.ascaleY-p+this.data.offsetScaleY)*i)/p));var d=l.ashearY;0!=n&&(h=s.ashearY-d+this.data.offsetShearY,h-=360*(16384-(16384.499999999996-h/360|0)),l.shearY+=h*n),l.updateWorldTransformWith(_,u,c,m,p,l.ashearX,d)}},e.prototype.applyRelativeLocal=function(){var t=this.rotateMix,e=this.translateMix,i=this.scaleMix,n=this.shearMix,s=this.target;s.appliedValid||s.updateAppliedTransform();for(var r=this.bones,o=0,a=r.length;o<a;o++){var l=r[o];l.appliedValid||l.updateAppliedTransform();var c=l.arotation;0!=t&&(c+=(s.arotation+this.data.offsetRotation)*t);var h=l.ax,_=l.ay;0!=e&&(h+=(s.ax+this.data.offsetX)*e,_+=(s.ay+this.data.offsetY)*e);var u=l.ascaleX,m=l.ascaleY;0!=i&&(u>1e-5&&(u*=(s.ascaleX-1+this.data.offsetScaleX)*i+1),m>1e-5&&(m*=(s.ascaleY-1+this.data.offsetScaleY)*i+1));var p=l.ashearY;0!=n&&(p+=(s.ashearY+this.data.offsetShearY)*n),l.updateWorldTransformWith(h,_,c,u,m,l.ashearX,p)}},e}();t.TransformConstraint=e}(Ont||(Ont={})),function(t){var e=function(t){function e(e){var i=t.call(this,e,0,!1)||this;return i.bones=new Array,i.rotateMix=0,i.translateMix=0,i.scaleMix=0,i.shearMix=0,i.offsetRotation=0,i.offsetX=0,i.offsetY=0,i.offsetScaleX=0,i.offsetScaleY=0,i.offsetShearY=0,i.relative=!1,i.local=!1,i}return Bnt(e,t),e}(t.ConstraintData);t.TransformConstraintData=e}(Ont||(Ont={})),function(t){var e=function(){function e(){this.convexPolygons=new Array,this.convexPolygonsIndices=new Array,this.indicesArray=new Array,this.isConcaveArray=new Array,this.triangles=new Array,this.polygonPool=new t.Pool((function(){return new Array})),this.polygonIndicesPool=new t.Pool((function(){return new Array}))}return e.prototype.triangulate=function(t){var i=t,n=t.length>>1,s=this.indicesArray;s.length=0;for(var r=0;r<n;r++)s[r]=r;var o=this.isConcaveArray;o.length=0,r=0;for(var a=n;r<a;++r)o[r]=e.isConcave(r,n,i,s);var l=this.triangles;for(l.length=0;n>3;){for(var c=n-1,h=(r=0,1);;){t:if(!o[r]){for(var _=s[c]<<1,u=s[r]<<1,m=s[h]<<1,p=i[_],d=i[_+1],f=i[u],g=i[u+1],y=i[m],v=i[m+1],x=(h+1)%n;x!=c;x=(x+1)%n)if(o[x]){var b=s[x]<<1,S=i[b],A=i[b+1];if(e.positiveArea(y,v,p,d,S,A)&&e.positiveArea(p,d,f,g,S,A)&&e.positiveArea(f,g,y,v,S,A))break t}break}if(0==h){do{if(!o[r])break;r--}while(r>0);break}c=r,r=h,h=(h+1)%n}l.push(s[(n+r-1)%n]),l.push(s[r]),l.push(s[(r+1)%n]),s.splice(r,1),o.splice(r,1);var C=(--n+r-1)%n,T=r==n?0:r;o[C]=e.isConcave(C,n,i,s),o[T]=e.isConcave(T,n,i,s)}return 3==n&&(l.push(s[2]),l.push(s[0]),l.push(s[1])),l},e.prototype.decompose=function(t,i){var n=t,s=this.convexPolygons;this.polygonPool.freeAll(s),s.length=0;var r=this.convexPolygonsIndices;this.polygonIndicesPool.freeAll(r),r.length=0;var o=this.polygonIndicesPool.obtain();o.length=0;var a=this.polygonPool.obtain();a.length=0;for(var l=-1,c=0,h=0,_=i.length;h<_;h+=3){var u=i[h]<<1,m=i[h+1]<<1,p=i[h+2]<<1,d=n[u],f=n[u+1],g=n[m],y=n[m+1],v=n[p],x=n[p+1],b=!1;if(l==u){var S=a.length-4,A=e.winding(a[S],a[S+1],a[S+2],a[S+3],v,x),C=e.winding(v,x,a[0],a[1],a[2],a[3]);A==c&&C==c&&(a.push(v),a.push(x),o.push(p),b=!0)}b||(a.length>0?(s.push(a),r.push(o)):(this.polygonPool.free(a),this.polygonIndicesPool.free(o)),(a=this.polygonPool.obtain()).length=0,a.push(d),a.push(f),a.push(g),a.push(y),a.push(v),a.push(x),(o=this.polygonIndicesPool.obtain()).length=0,o.push(u),o.push(m),o.push(p),c=e.winding(d,f,g,y,v,x),l=u)}for(a.length>0&&(s.push(a),r.push(o)),h=0,_=s.length;h<_;h++)if(0!=(o=r[h]).length)for(var T=o[0],w=o[o.length-1],E=(a=s[h])[S=a.length-4],P=a[S+1],D=a[S+2],I=a[S+3],R=a[0],M=a[1],O=a[2],B=a[3],N=e.winding(E,P,D,I,R,M),L=0;L<_;L++)if(L!=h){var F=r[L];if(3==F.length){var z=F[0],V=F[1],U=F[2],G=s[L];v=G[G.length-2],x=G[G.length-1],z==T&&V==w&&(A=e.winding(E,P,D,I,v,x),C=e.winding(v,x,R,M,O,B),A==N&&C==N&&(G.length=0,F.length=0,a.push(v),a.push(x),o.push(U),E=D,P=I,D=v,I=x,L=0))}}for(h=s.length-1;h>=0;h--)0==(a=s[h]).length&&(s.splice(h,1),this.polygonPool.free(a),o=r[h],r.splice(h,1),this.polygonIndicesPool.free(o));return s},e.isConcave=function(t,e,i,n){var s=n[(e+t-1)%e]<<1,r=n[t]<<1,o=n[(t+1)%e]<<1;return!this.positiveArea(i[s],i[s+1],i[r],i[r+1],i[o],i[o+1])},e.positiveArea=function(t,e,i,n,s,r){return t*(r-n)+i*(e-r)+s*(n-e)>=0},e.winding=function(t,e,i,n,s,r){var o=i-t,a=n-e;return s*a-r*o+o*e-t*a>=0?1:-1},e}();t.Triangulator=e}(Ont||(Ont={})),function(t){var e=function(){function t(){this.array=new Array}return t.prototype.add=function(t){var e=this.contains(t);return this.array[0|t]=0|t,!e},t.prototype.contains=function(t){return null!=this.array[0|t]},t.prototype.remove=function(t){this.array[0|t]=void 0},t.prototype.clear=function(){this.array.length=0},t}();t.IntSet=e;var i=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.r=t,this.g=e,this.b=i,this.a=n}return t.prototype.set=function(t,e,i,n){return this.r=t,this.g=e,this.b=i,this.a=n,this.clamp(),this},t.prototype.setFromColor=function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},t.prototype.setFromString=function(t){return t="#"==t.charAt(0)?t.substr(1):t,this.r=parseInt(t.substr(0,2),16)/255,this.g=parseInt(t.substr(2,2),16)/255,this.b=parseInt(t.substr(4,2),16)/255,this.a=(8!=t.length?255:parseInt(t.substr(6,2),16))/255,this},t.prototype.add=function(t,e,i,n){return this.r+=t,this.g+=e,this.b+=i,this.a+=n,this.clamp(),this},t.prototype.clamp=function(){return this.r<0?this.r=0:this.r>1&&(this.r=1),this.g<0?this.g=0:this.g>1&&(this.g=1),this.b<0?this.b=0:this.b>1&&(this.b=1),this.a<0?this.a=0:this.a>1&&(this.a=1),this},t.rgba8888ToColor=function(t,e){t.r=((4278190080&e)>>>24)/255,t.g=((16711680&e)>>>16)/255,t.b=((65280&e)>>>8)/255,t.a=(255&e)/255},t.rgb888ToColor=function(t,e){t.r=((16711680&e)>>>16)/255,t.g=((65280&e)>>>8)/255,t.b=(255&e)/255},t.WHITE=new t(1,1,1,1),t.RED=new t(1,0,0,1),t.GREEN=new t(0,1,0,1),t.BLUE=new t(0,0,1,1),t.MAGENTA=new t(1,0,1,1),t}();t.Color=i;var n=function(){function t(){}return t.clamp=function(t,e,i){return t<e?e:t>i?i:t},t.cosDeg=function(e){return Math.cos(e*t.degRad)},t.sinDeg=function(e){return Math.sin(e*t.degRad)},t.signum=function(t){return t>0?1:t<0?-1:0},t.toInt=function(t){return t>0?Math.floor(t):Math.ceil(t)},t.cbrt=function(t){var e=Math.pow(Math.abs(t),1/3);return t<0?-e:e},t.randomTriangular=function(e,i){return t.randomTriangularWith(e,i,.5*(e+i))},t.randomTriangularWith=function(t,e,i){var n=Math.random(),s=e-t;return n<=(i-t)/s?t+Math.sqrt(n*s*(i-t)):e-Math.sqrt((1-n)*s*(e-i))},t.PI=3.1415927,t.PI2=2*t.PI,t.radiansToDegrees=180/t.PI,t.radDeg=t.radiansToDegrees,t.degreesToRadians=t.PI/180,t.degRad=t.degreesToRadians,t}();t.MathUtils=n;var s=function(){function t(){}return t.prototype.apply=function(t,e,i){return t+(e-t)*this.applyInternal(i)},t}();t.Interpolation=s;var r=function(t){function e(e){var i=t.call(this)||this;return i.power=2,i.power=e,i}return Bnt(e,t),e.prototype.applyInternal=function(t){return t<=.5?Math.pow(2*t,this.power)/2:Math.pow(2*(t-1),this.power)/(this.power%2==0?-2:2)+1},e}(s);t.Pow=r;var o=function(t){function e(e){return t.call(this,e)||this}return Bnt(e,t),e.prototype.applyInternal=function(t){return Math.pow(t-1,this.power)*(this.power%2==0?-1:1)+1},e}(r);t.PowOut=o;var a=function(){function t(){}return t.arrayCopy=function(t,e,i,n,s){for(var r=e,o=n;r<e+s;r++,o++)i[o]=t[r]},t.setArraySize=function(t,e,i){void 0===i&&(i=0);var n=t.length;if(n==e)return t;if(t.length=e,n<e)for(var s=n;s<e;s++)t[s]=i;return t},t.ensureArrayCapacity=function(e,i,n){return void 0===n&&(n=0),e.length>=i?e:t.setArraySize(e,i,n)},t.newArray=function(t,e){for(var i=new Array(t),n=0;n<t;n++)i[n]=e;return i},t.newFloatArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Float32Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.newShortArray=function(e){if(t.SUPPORTS_TYPED_ARRAYS)return new Int16Array(e);for(var i=new Array(e),n=0;n<i.length;n++)i[n]=0;return i},t.toFloatArray=function(e){return t.SUPPORTS_TYPED_ARRAYS?new Float32Array(e):e},t.toSinglePrecision=function(e){return t.SUPPORTS_TYPED_ARRAYS?Math.fround(e):e},t.webkit602BugfixHelper=function(){},t.contains=function(t,e){for(var i=0;i<t.length;i++)if(t[i]==e)return!0;return!1},t.SUPPORTS_TYPED_ARRAYS="undefined"!=typeof Float32Array,t}();t.Utils=a;var l=function(){function t(){}return t.logBones=function(t){for(var e=0;e<t.bones.length;e++){var i=t.bones[e];console.log(i.data.name+", "+i.a+", "+i.b+", "+i.c+", "+i.d+", "+i.worldX+", "+i.worldY)}},t}();t.DebugUtils=l;var c=function(){function t(t){this.items=new Array,this.instantiator=t}return t.prototype.obtain=function(){return this.items.length>0?this.items.pop():this.instantiator()},t.prototype.free=function(t){t.reset&&t.reset(),this.items.push(t)},t.prototype.freeAll=function(t){for(var e=0;e<t.length;e++)t[e].reset&&t[e].reset(),this.items[e]=t[e]},t.prototype.clear=function(){this.items.length=0},t}();t.Pool=c;var h=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.set=function(t,e){return this.x=t,this.y=e,this},t.prototype.length=function(){var t=this.x,e=this.y;return Math.sqrt(t*t+e*e)},t.prototype.normalize=function(){var t=this.length();return 0!=t&&(this.x/=t,this.y/=t),this},t}();t.Vector2=h;var _=function(){function t(){this.maxDelta=.064,this.framesPerSecond=0,this.delta=0,this.totalTime=0,this.lastTime=Date.now()/1e3,this.frameCount=0,this.frameTime=0}return t.prototype.update=function(){var t=Date.now()/1e3;this.delta=t-this.lastTime,this.frameTime+=this.delta,this.totalTime+=this.delta,this.delta>this.maxDelta&&(this.delta=this.maxDelta),this.lastTime=t,this.frameCount++,this.frameTime>1&&(this.framesPerSecond=this.frameCount/this.frameTime,this.frameTime=0,this.frameCount=0)},t}();t.TimeKeeper=_;var u=function(){function t(t){void 0===t&&(t=32),this.addedValues=0,this.lastValue=0,this.mean=0,this.dirty=!0,this.values=new Array(t)}return t.prototype.hasEnoughData=function(){return this.addedValues>=this.values.length},t.prototype.addValue=function(t){this.addedValues<this.values.length&&this.addedValues++,this.values[this.lastValue++]=t,this.lastValue>this.values.length-1&&(this.lastValue=0),this.dirty=!0},t.prototype.getMean=function(){if(this.hasEnoughData()){if(this.dirty){for(var t=0,e=0;e<this.values.length;e++)t+=this.values[e];this.mean=t/this.values.length,this.dirty=!1}return this.mean}return 0},t}();t.WindowedMean=u}(Ont||(Ont={})),Math.fround||(Math.fround=function(t){return function(e){return t[0]=e,t[0]}}(new Float32Array(1))),function(t){var e=function(t){if(null==t)throw new Error("name cannot be null.");this.name=t};t.Attachment=e;var i=function(e){function i(t){var n=e.call(this,t)||this;return n.id=(65535&i.nextID++)<<11,n.worldVerticesLength=0,n.deformAttachment=n,n}return Bnt(i,e),i.prototype.computeWorldVertices=function(t,e,i,n,s,r){i=s+(i>>1)*r;var o=t.bone.skeleton,a=t.deform,l=this.vertices,c=this.bones;if(null!=c){for(var h=0,_=0,u=0;u<e;u+=2)h+=(f=c[h])+1,_+=f;var m=o.bones;if(0==a.length)for(P=s,C=3*_;P<i;P+=r){var p=0,d=0,f=c[h++];for(f+=h;h<f;h++,C+=3){x=m[c[h]],D=l[C],I=l[C+1];var g=l[C+2];p+=(D*x.a+I*x.b+x.worldX)*g,d+=(D*x.c+I*x.d+x.worldY)*g}n[P]=p,n[P+1]=d}else for(var y=a,v=(P=s,C=3*_,_<<1);P<i;P+=r){for(p=0,d=0,f=c[h++],f+=h;h<f;h++,C+=3,v+=2)x=m[c[h]],D=l[C]+y[v],I=l[C+1]+y[v+1],g=l[C+2],p+=(D*x.a+I*x.b+x.worldX)*g,d+=(D*x.c+I*x.d+x.worldY)*g;n[P]=p,n[P+1]=d}}else{a.length>0&&(l=a);for(var x,b=(x=t.bone).worldX,S=x.worldY,A=x.a,C=x.b,T=x.c,w=x.d,E=e,P=s;P<i;E+=2,P+=r){var D=l[E],I=l[E+1];n[P]=D*A+I*C+b,n[P+1]=D*T+I*w+S}}},i.prototype.copyTo=function(e){null!=this.bones?(e.bones=new Array(this.bones.length),t.Utils.arrayCopy(this.bones,0,e.bones,0,this.bones.length)):e.bones=null,null!=this.vertices?(e.vertices=t.Utils.newFloatArray(this.vertices.length),t.Utils.arrayCopy(this.vertices,0,e.vertices,0,this.vertices.length)):e.vertices=null,e.worldVerticesLength=this.worldVerticesLength,e.deformAttachment=this.deformAttachment},i.nextID=0,i}(e);t.VertexAttachment=i}(Ont||(Ont={})),function(t){var e;(e=t.AttachmentType||(t.AttachmentType={}))[e.Region=0]="Region",e[e.BoundingBox=1]="BoundingBox",e[e.Mesh=2]="Mesh",e[e.LinkedMesh=3]="LinkedMesh",e[e.Path=4]="Path",e[e.Point=5]="Point",e[e.Clipping=6]="Clipping"}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n}return Bnt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.BoundingBoxAttachment=e}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.2275,.2275,.8078,1),n}return Bnt(i,e),i.prototype.copy=function(){var t=new i(name);return this.copyTo(t),t.endSlot=this.endSlot,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.ClippingAttachment=e}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(1,1,1,1),n.tempColor=new t.Color(0,0,0,0),n}return Bnt(i,e),i.prototype.updateUVs=function(){var e=this.regionUVs;null!=this.uvs&&this.uvs.length==e.length||(this.uvs=t.Utils.newFloatArray(e.length));var i=this.uvs,n=this.uvs.length,s=this.region.u,r=this.region.v,o=0,a=0;if(this.region instanceof t.TextureAtlasRegion){var l=this.region,c=l.texture.getImage().width,h=l.texture.getImage().height;switch(l.degrees){case 90:s-=(l.originalHeight-l.offsetY-l.height)/c,r-=(l.originalWidth-l.offsetX-l.width)/h,o=l.originalHeight/c,a=l.originalWidth/h;for(var _=0;_<n;_+=2)i[_]=s+e[_+1]*o,i[_+1]=r+(1-e[_])*a;return;case 180:for(s-=(l.originalWidth-l.offsetX-l.width)/c,r-=l.offsetY/h,o=l.originalWidth/c,a=l.originalHeight/h,_=0;_<n;_+=2)i[_]=s+(1-e[_])*o,i[_+1]=r+(1-e[_+1])*a;return;case 270:for(s-=l.offsetY/c,r-=l.offsetX/h,o=l.originalHeight/c,a=l.originalWidth/h,_=0;_<n;_+=2)i[_]=s+(1-e[_+1])*o,i[_+1]=r+e[_]*a;return}s-=l.offsetX/c,r-=(l.originalHeight-l.offsetY-l.height)/h,o=l.originalWidth/c,a=l.originalHeight/h}else null==this.region?(s=r=0,o=a=1):(o=this.region.u2-s,a=this.region.v2-r);for(_=0;_<n;_+=2)i[_]=s+e[_]*o,i[_+1]=r+e[_+1]*a},i.prototype.getParentMesh=function(){return this.parentMesh},i.prototype.setParentMesh=function(t){this.parentMesh=t,null!=t&&(this.bones=t.bones,this.vertices=t.vertices,this.worldVerticesLength=t.worldVerticesLength,this.regionUVs=t.regionUVs,this.triangles=t.triangles,this.hullLength=t.hullLength,this.worldVerticesLength=t.worldVerticesLength)},i.prototype.copy=function(){if(null!=this.parentMesh)return this.newLinkedMesh();var e=new i(this.name);return e.region=this.region,e.path=this.path,e.color.setFromColor(this.color),this.copyTo(e),e.regionUVs=new Array(this.regionUVs.length),t.Utils.arrayCopy(this.regionUVs,0,e.regionUVs,0,this.regionUVs.length),e.uvs=new Array(this.uvs.length),t.Utils.arrayCopy(this.uvs,0,e.uvs,0,this.uvs.length),e.triangles=new Array(this.triangles.length),t.Utils.arrayCopy(this.triangles,0,e.triangles,0,this.triangles.length),e.hullLength=this.hullLength,null!=this.edges&&(e.edges=new Array(this.edges.length),t.Utils.arrayCopy(this.edges,0,e.edges,0,this.edges.length)),e.width=this.width,e.height=this.height,e},i.prototype.newLinkedMesh=function(){var t=new i(this.name);return t.region=this.region,t.path=this.path,t.color.setFromColor(this.color),t.deformAttachment=this.deformAttachment,t.setParentMesh(null!=this.parentMesh?this.parentMesh:this),t.updateUVs(),t},i}(t.VertexAttachment);t.MeshAttachment=e}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.closed=!1,n.constantSpeed=!1,n.color=new t.Color(1,1,1,1),n}return Bnt(i,e),i.prototype.copy=function(){var e=new i(name);return this.copyTo(e),e.lengths=new Array(this.lengths.length),t.Utils.arrayCopy(this.lengths,0,e.lengths,0,this.lengths.length),e.closed=closed,e.constantSpeed=this.constantSpeed,e.color.setFromColor(this.color),e},i}(t.VertexAttachment);t.PathAttachment=e}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.color=new t.Color(.38,.94,0,1),n}return Bnt(i,e),i.prototype.computeWorldPosition=function(t,e){return e.x=this.x*t.a+this.y*t.b+t.worldX,e.y=this.x*t.c+this.y*t.d+t.worldY,e},i.prototype.computeWorldRotation=function(e){var i=t.MathUtils.cosDeg(this.rotation),n=t.MathUtils.sinDeg(this.rotation),s=i*e.a+n*e.b,r=i*e.c+n*e.d;return Math.atan2(r,s)*t.MathUtils.radDeg},i.prototype.copy=function(){var t=new i(name);return t.x=this.x,t.y=this.y,t.rotation=this.rotation,t.color.setFromColor(this.color),t},i}(t.VertexAttachment);t.PointAttachment=e}(Ont||(Ont={})),function(t){var e=function(e){function i(i){var n=e.call(this,i)||this;return n.x=0,n.y=0,n.scaleX=1,n.scaleY=1,n.rotation=0,n.width=0,n.height=0,n.color=new t.Color(1,1,1,1),n.offset=t.Utils.newFloatArray(8),n.uvs=t.Utils.newFloatArray(8),n.tempColor=new t.Color(1,1,1,1),n}return Bnt(i,e),i.prototype.updateOffset=function(){var t=this.width/this.region.originalWidth*this.scaleX,e=this.height/this.region.originalHeight*this.scaleY,n=-this.width/2*this.scaleX+this.region.offsetX*t,s=-this.height/2*this.scaleY+this.region.offsetY*e,r=n+this.region.width*t,o=s+this.region.height*e,a=this.rotation*Math.PI/180,l=Math.cos(a),c=Math.sin(a),h=n*l+this.x,_=n*c,u=s*l+this.y,m=s*c,p=r*l+this.x,d=r*c,f=o*l+this.y,g=o*c,y=this.offset;y[i.OX1]=h-m,y[i.OY1]=u+_,y[i.OX2]=h-g,y[i.OY2]=f+_,y[i.OX3]=p-g,y[i.OY3]=f+d,y[i.OX4]=p-m,y[i.OY4]=u+d},i.prototype.setRegion=function(t){this.region=t;var e=this.uvs;t.rotate?(e[2]=t.u,e[3]=t.v2,e[4]=t.u,e[5]=t.v,e[6]=t.u2,e[7]=t.v,e[0]=t.u2,e[1]=t.v2):(e[0]=t.u,e[1]=t.v2,e[2]=t.u,e[3]=t.v,e[4]=t.u2,e[5]=t.v,e[6]=t.u2,e[7]=t.v2)},i.prototype.computeWorldVertices=function(t,e,n,s){var r=this.offset,o=t.worldX,a=t.worldY,l=t.a,c=t.b,h=t.c,_=t.d,u=0,m=0;u=r[i.OX1],m=r[i.OY1],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX2],m=r[i.OY2],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX3],m=r[i.OY3],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a,n+=s,u=r[i.OX4],m=r[i.OY4],e[n]=u*l+m*c+o,e[n+1]=u*h+m*_+a},i.prototype.copy=function(){var e=new i(name);return e.region=this.region,e.rendererObject=this.rendererObject,e.path=this.path,e.x=this.x,e.y=this.y,e.scaleX=this.scaleX,e.scaleY=this.scaleY,e.rotation=this.rotation,e.width=this.width,e.height=this.height,t.Utils.arrayCopy(this.uvs,0,e.uvs,0,8),t.Utils.arrayCopy(this.offset,0,e.offset,0,8),e.color.setFromColor(this.color),e},i.OX1=0,i.OY1=1,i.OX2=2,i.OY2=3,i.OX3=4,i.OY3=5,i.OX4=6,i.OY4=7,i.X1=0,i.Y1=1,i.C1R=2,i.C1G=3,i.C1B=4,i.C1A=5,i.U1=6,i.V1=7,i.X2=8,i.Y2=9,i.C2R=10,i.C2G=11,i.C2B=12,i.C2A=13,i.U2=14,i.V2=15,i.X3=16,i.Y3=17,i.C3R=18,i.C3G=19,i.C3B=20,i.C3A=21,i.U3=22,i.V3=23,i.X4=24,i.Y4=25,i.C4R=26,i.C4G=27,i.C4B=28,i.C4A=29,i.U4=30,i.V4=31,i}(t.Attachment);t.RegionAttachment=e}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){this.jitterX=0,this.jitterY=0,this.jitterX=t,this.jitterY=e}return e.prototype.begin=function(){},e.prototype.transform=function(e){e.x+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY),e.y+=t.MathUtils.randomTriangular(-this.jitterX,this.jitterY)},e.prototype.end=function(){},e}();t.JitterEffect=e}(Ont||(Ont={})),function(t){var e=function(){function e(t,e){this.centerX=0,this.centerY=0,this.radius=0,this.angle=0,this.worldX=0,this.worldY=0,this.radius=t,this.interpolation=e}return e.prototype.begin=function(t){this.worldX=t.x+this.centerX,this.worldY=t.y+this.centerY},e.prototype.transform=function(e){var i=this.angle*t.MathUtils.degreesToRadians,n=e.x-this.worldX,s=e.y-this.worldY,r=Math.sqrt(n*n+s*s);if(r<this.radius){var o=this.interpolation.apply(0,i,(this.radius-r)/this.radius),a=Math.cos(o),l=Math.sin(o);e.x=a*n-l*s+this.worldX,e.y=l*n+a*s+this.worldY}},e.prototype.end=function(){},e.interpolation=new t.PowOut(2),e}();t.SwirlEffect=e}(Ont||(Ont={}));var Nnt=Ont;const Lnt=1/60,Fnt=[],znt=[];let Vnt,Unt,Gnt,knt,Hnt,jnt,Wnt=0,qnt=0,Xnt=0,Ynt=null,Knt=null,$nt=0,Jnt=0,Znt=0,Qnt=0,tst=null,est=null,ist=0,nst=0;const sst=new Nnt.Color(1,1,1,1),rst=new Nnt.Color(1,1,1,1),ost=[0,1,2,2,3,0];class ast{constructor(){this.frames=[],this.totalTime=0,this.isCompleted=!1,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this._frameIdx=-1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null,this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this._frameIdx=-1,this.isCompleted=!1,this._skeletonInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._animationName=e,this._skeletonInfo=t}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}bind(t){t.complete=t=>{t&&t.animation.name===this._animationName&&(this.isCompleted=!0)}}unbind(t){t.complete=null}begin(){if(!this._invalid)return;const t=this._skeletonInfo,e=null==t?void 0:t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame());const i=null==t?void 0:t.skeleton,n=null==t?void 0:t.listener,s=null==t?void 0:t.state,r=null==i?void 0:i.data.findAnimation(this._animationName);null==s||s.setAnimationWith(0,r,!1),this.bind(n),t.curAnimationCache=this,this._frameIdx=-1,this.isCompleted=!1,this.totalTime=0,this._invalid=!1}end(){this.needToUpdate()||(this._skeletonInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0,this.unbind(this._skeletonInfo.listener))}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this.needToUpdate(t))return;const e=this._skeletonInfo,i=null==e?void 0:e.skeleton,n=null==e?void 0:e.clipper,s=null==e?void 0:e.state;do{null==i||i.update(Lnt),null==s||s.update(Lnt),null==s||s.apply(i),null==i||i.updateWorldTransform(),this._frameIdx++,this.updateFrame(i,n,this._frameIdx),this.totalTime+=Lnt}while(this.needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}fillVertices(t,e,i,n,s){if(knt=i.a*e.a*t.a*255,Vnt=e.r*t.r*255,Unt=e.g*t.g*255,Gnt=e.b*t.b*255,sst.r=Vnt*i.r,sst.g=Unt*i.g,sst.b=Gnt*i.b,sst.a=knt,null==s.darkColor?rst.set(0,0,0,1):(rst.r=s.darkColor.r*Vnt,rst.g=s.darkColor.g*Unt,rst.b=s.darkColor.b*Gnt),rst.a=0,Hnt=(sst.a<<24>>>0)+(sst.b<<16)+(sst.g<<8)+sst.r,jnt=(rst.a<<24>>>0)+(rst.b<<16)+(rst.g<<8)+rst.r,tst!==Hnt||est!==jnt){const t=this._tempColors;tst=Hnt,est=jnt,Qnt>0&&(t[Qnt-1].vfOffset=Xnt),t[Qnt++]={fr:sst.r,fg:sst.g,fb:sst.b,fa:sst.a,dr:rst.r,dg:rst.g,db:rst.b,da:rst.a,vfOffset:0}}if(n.isClipping()){n.clipTriangles(Fnt,ist,znt,nst,Fnt,sst,rst,!0,6,Xnt,Xnt+2);const t=n.clippedVertices,e=n.clippedTriangles;nst=e.length,ist=t.length/12*6;for(let t=0,i=qnt,n=e.length;t<n;)znt[i++]=e[t++];for(let e=0,i=t.length,n=Xnt;e<i;e+=12,n+=6)Fnt[n]=t[e],Fnt[n+1]=t[e+1],Fnt[n+2]=t[e+6],Fnt[n+3]=t[e+7],Fnt[n+4]=Hnt,Fnt[n+5]=jnt}else for(let t=Xnt,e=Xnt+ist;t<e;t+=6)Fnt[t+4]=Hnt,Fnt[t+5]=jnt}updateFrame(t,e,i){Xnt=0,Wnt=0,qnt=0,Ynt=null,Knt=null,$nt=0,Jnt=0,Znt=0,Qnt=0,tst=null,est=null,this.frames[i]=this.frames[i]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const n=this.frames[i],s=this._tempSegments=n.segments,r=this._tempColors=n.colors,o=this._tempBoneInfos=n.boneInfos;this.traverseSkeleton(t,e),Qnt>0&&(r[Qnt-1].vfOffset=Xnt),r.length=Qnt,o.length=Wnt;const a=Znt-1;if(a>=0)if(Jnt>0){const t=s[a];t.indexCount=Jnt,t.vfCount=13*$nt,t.vertexCount=$nt,s.length=Znt}else s.length=Znt-1;if(0===s.length)return;let l=n.vertices;const c=Xnt/6*13;(!l||l.length<c)&&(l=n.vertices=new Float32Array(c));for(let t=0,e=0;t<c;)l[t]=Fnt[e++],l[t+1]=Fnt[e++],l[t+3]=Fnt[e++],l[t+4]=Fnt[e++],this._setVerticeColor(Fnt[e++],l,t+5),this._setVerticeColor(Fnt[e++],l,t+9),t+=13;let h=n.indices;(!h||h.length<qnt)&&(h=n.indices=new Uint16Array(qnt));for(let t=0;t<qnt;t++)h[t]=znt[t];n.vertices=l,n.indices=h}needToUpdate(t){return!this.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}traverseSkeleton(t,e){const i=this._tempSegments,n=this._tempBoneInfos,s=t.color;let r,o,a,l,c,h,_,u,m,p,d,f,g;const y=t.bones;if(this._enableCacheAttachedInfo)for(let t=0,e=y.length;t<e;t++,Wnt++){const e=y[t];let i=n[Wnt];i||(i=n[Wnt]={}),i.a=e.a,i.b=e.b,i.c=e.c,i.d=e.d,i.worldX=e.worldX,i.worldY=e.worldY}for(let n=0,y=t.drawOrder.length;n<y;n++)if(g=t.drawOrder[n],ist=0,nst=0,r=g.getAttachment(),r)if(h=r instanceof Nnt.RegionAttachment,_=r instanceof Nnt.MeshAttachment,u=r instanceof Nnt.ClippingAttachment,u)e.clipStart(g,r);else if(h||_)if(m=r.region.texture.getRealTexture(),m){if(f=g.data.blendMode,Ynt===m.nativeUrl&&Knt===f||(Ynt=m.nativeUrl,Knt=f,p=Znt-1,p>=0&&(Jnt>0?(d=i[p],d.indexCount=Jnt,d.vertexCount=$nt,d.vfCount=13*$nt):Znt--),i[Znt]={tex:m,blendMode:f,indexCount:0,vertexCount:0,vfCount:0},Znt++,Jnt=0,$nt=0),h)c=ost,ist=24,nst=6,r.computeWorldVertices(g.bone,Fnt,Xnt,6);else if(_){const t=r;c=t.triangles,ist=6*(t.worldVerticesLength>>1),nst=c.length,t.computeWorldVertices(g,0,t.worldVerticesLength,Fnt,Xnt,6)}if(0!==ist&&0!==nst){for(let t=0,e=qnt,i=c.length;t<i;)znt[e++]=c[t++];l=r.uvs;for(let t=Xnt,e=Xnt+ist,i=0;t<e;t+=6,i+=2)Fnt[t+2]=l[i],Fnt[t+3]=l[i+1];if(o=r.color,a=g.color,this.fillVertices(s,o,a,e,g),nst>0){for(let t=qnt,e=qnt+nst;t<e;t++)znt[t]+=$nt;qnt+=nst,Xnt+=ist,Jnt+=nst,$nt+=ist/6}e.clipEndWithSlot(g)}else e.clipEndWithSlot(g)}else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);else e.clipEndWithSlot(g);e.clipEnd()}_setVerticeColor(t,e,i){e[i]=(255&t)/255,e[i+1]=(t>>8&255)/255,e[i+2]=(t>>16&255)/255,e[i+3]=(t>>24&255)/255}}class lst{constructor(){this._privateMode=void 0,this._skeletonCache=void 0,this._animationPool=void 0,this._privateMode=!1,this._animationPool={},this._skeletonCache={}}enablePrivateMode(){this._privateMode=!0}clear(){this._animationPool={},this._skeletonCache={}}removeSkeleton(t){const e=this._skeletonCache[t];if(!e)return;const i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}delete this._skeletonCache[t]}getSkeletonCache(t,e){let i=this._skeletonCache[t];if(!i){const n=new Nnt.Skeleton(e),s=new Nnt.SkeletonClipping,r=new Nnt.AnimationStateData(n.data),o=new Nnt.AnimationState(r),a=new Rnt;o.addListener(a),this._skeletonCache[t]=i={skeleton:n,clipper:s,state:o,listener:a,animationsCache:{},curAnimationCache:null}}return i}getAnimationCache(t,e){const i=this._skeletonCache[t];return i?i.animationsCache[e]:null}invalidAnimationCache(t){const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}initAnimationCache(t,e){if(!e)return null;const i=this._skeletonCache[t],n=i&&i.skeleton;if(!n)return null;if(!n.data.findAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new ast,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return null;i.updateAllFrame()}else{const e=this._skeletonCache[t];if(!e||!e.skeleton)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}}lst.FrameTime=Lnt,lst.sharedCache=new lst;const cst=new $i,hst=new Ni;class _st{constructor(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null,this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}init(t){this._inited=!0,this._skeleton=t._skeleton,this._skeletonNode=t.node,this._skeletonComp=t}reset(){this._inited=!1,this._skeleton=null,this._skeletonNode=null,this._skeletonComp=null}_syncAttachedNode(){if(!this._inited)return;const t=this._skeletonComp.socketNodes;if(0===t.size)return;let e=null;if(e=this._skeletonComp.isAnimationCached()?this._skeletonComp._curFrame&&this._skeletonComp._curFrame.boneInfos:this._skeleton.bones,!e)return;const i=(t,e)=>{hst.set(t.scale);const i=cst;i.m00=e.a,i.m01=e.c,i.m04=e.b,i.m05=e.d,i.m12=e.worldX,i.m13=e.worldY,t.matrix=cst,t.scale=hst};for(const n of t.keys()){const s=t.get(n);if(!s||!s.isValid){t.delete(n);continue}const r=e[n];r?i(s,r):(s.removeFromParent(),s.destroy(),t.delete(n))}}}class ust extends Nnt.Texture{constructor(t){super(t),this.name="sp.SkeletonTexture",this._texture=null,this._material=null}setRealTexture(t){this._texture=t}getRealTexture(){return this._texture}setFilters(t,e){this._texture&&this.getRealTexture().setFilters(mst(t),mst(e))}setWraps(t,e){this._texture&&this.getRealTexture().setWrapMode(pst(t),pst(e))}dispose(){}}function mst(t){switch(t){case Nnt.TextureFilter.Nearest:case Nnt.TextureFilter.MipMapNearestNearest:case Nnt.TextureFilter.MipMapLinearNearest:return Od.NEAREST;case Nnt.TextureFilter.MipMap:case Nnt.TextureFilter.MipMapNearestLinear:case Nnt.TextureFilter.MipMapLinearLinear:case Nnt.TextureFilter.Linear:default:return Od.LINEAR}}function pst(t){switch(t){case Nnt.TextureWrap.MirroredRepeat:return Md.MIRRORED_REPEAT;case Nnt.TextureWrap.ClampToEdge:return Md.CLAMP_TO_EDGE;case Nnt.TextureWrap.Repeat:default:return Md.REPEAT}}var dst,fst,gst,yst,vst,xst,bst,Sst,Ast,Cst;let Tst=(dst=Vl("sp.SkeletonData"),fst=yc([Af]),gst=yc([ce]),dst((xst=wl((vst=class extends _h{get skeletonJsonStr(){return this._skeletonJson?JSON.stringify(this._skeletonJson):""}get skeletonJson(){return this._skeletonJson}set skeletonJson(t){this.reset(),this._skeletonJson="string"==typeof t?JSON.parse(t):t,!this._uuid&&t.skeleton&&(this._uuid=t.skeleton.hash)}get atlasText(){return this._atlasText}set atlasText(t){this._atlasText=t,this.reset()}get _nativeAsset(){return this._buffer}set _nativeAsset(t){this._buffer=t,this.reset()}constructor(){super(),Tl(this,"_skeletonJson",xst,this),Tl(this,"textures",bst,this),Tl(this,"textureNames",Sst,this),Tl(this,"scale",Ast,this),Tl(this,"_atlasText",Cst,this),this._buffer=void 0,this._skeletonCache=null,this._atlasCache=null,this._skinsEnum=null,this._animsEnum=null,this.reset()}createNode(t){const e=new Yv(this.name);return e.addComponent("cc.Skeleton").skeletonData=this,t(null,e)}reset(){this._skeletonCache=null,this._atlasCache=null}resetEnums(){}getRuntimeData(t){if(this._skeletonCache)return this._skeletonCache;if(!(this.textures&&this.textures.length>0)&&this.textureNames&&this.textureNames.length>0)return t||console.error(`${this.name} no textures found!`),null;const e=this._getAtlas(t);if(!e)return null;const i=new Nnt.AtlasAttachmentLoader(e);let n=null,s=null;return this.skeletonJson?(s=new Nnt.SkeletonJson(i),n=this.skeletonJson):(s=new Nnt.SkeletonBinary(i),n=new Uint8Array(this._nativeAsset)),s.scale=this.scale,this._skeletonCache=s.readSkeletonData(n),e.dispose(),this._skeletonCache}getSkinsEnum(){if(this._skinsEnum)return this._skinsEnum;const t=this.getRuntimeData(!0);if(t){const e=t.skins,i={};for(let t=0;t<e.length;t++)i[e[t].name]=t;return this._skinsEnum=Nt(i)}return null}getAnimsEnum(){if(this._animsEnum&&Object.keys(this._animsEnum).length>1)return this._animsEnum;const t=this.getRuntimeData(!0);if(t){const e={"<None>":0},i=t.animations;for(let t=0;t<i.length;t++)e[i[t].name]=t+1;return this._animsEnum=Nt(e)}return null}destroy(){return lst.sharedCache.removeSkeleton(this._uuid),super.destroy()}_getTexture(t){const e=this.textureNames;for(let i=0;i<e.length;i++)if(e[i]===t){const t=this.textures[i],e=new ust({width:t.width,height:t.height});return e.setRealTexture(t),e}return console.error(`${this.name} no textures found!`),null}_getAtlas(t){return this._atlasCache?this._atlasCache:this.atlasText?this._atlasCache=new Nnt.TextureAtlas(this.atlasText,this._getTexture.bind(this)):(t||console.error(`${this.name} no atlas found!`),null)}}).prototype,"_skeletonJson",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),bst=wl(vst.prototype,"textures",[Wl,fst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Sst=wl(vst.prototype,"textureNames",[Wl,gst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ast=wl(vst.prototype,"scale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Cst=wl(vst.prototype,"_atlasText",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yst=vst))||yst);n.internal.SpineSkeletonData=Tst;class wst extends Sw{constructor(){super(),this._skeletons=new Set}static getInstance(){return wst._instance||(wst._instance=new wst,Mw.registerSystem(wst.ID,wst._instance,Sw.Priority.HIGH)),wst._instance}add(t){t&&(this._skeletons.has(t)||this._skeletons.add(t))}remove(t){t&&this._skeletons.has(t)&&this._skeletons.delete(t)}postUpdate(t){this._skeletons&&this._skeletons.forEach((e=>{e.updateAnimation(t)}))}}var Est,Pst,Dst,Ist,Rst,Mst,Ost,Bst,Nst,Lst,Fst,zst,Vst,Ust,Gst,kst,Hst,jst,Wst,qst,Xst,Yst,Kst,$st,Jst,Zst,Qst,trt,ert,irt,nrt,srt,rrt,ort,art,lrt,crt,hrt,_rt,urt,mrt,prt,drt,frt,grt,yrt,vrt,xrt,brt,Srt,Art,Crt,Trt;let wrt,Ert,Prt,Drt;function Irt(t,e,i){we.Attr.setClassAttr(t,e,"type","Enum"),we.Attr.setClassAttr(t,e,"enumList",Nt.getList(i))}wst.ID="SKELETON",wst._instance=void 0,function(t){t[t.default=0]="default"}(wrt||(wrt={})),zt(wrt),function(t){t[t["<None>"]=0]="<None>"}(Ert||(Ert={})),zt(Ert),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(Prt||(Prt={})),zt(Prt),function(t){t[t.COLORED_TEXTURED=0]="COLORED_TEXTURED",t[t.TWO_COLORED=1]="TWO_COLORED"}(Drt||(Drt={}));let Rrt=(Est=Vl("sp.Skeleton.SpineSocket"),Pst=yc(Yv),Est((Rst=wl((Ist=class{constructor(t="",e=null){Tl(this,"path",Rst,this),Tl(this,"target",Mst,this),this.path=t,this.target=e}}).prototype,"path",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Mst=wl(Ist.prototype,"target",[Pst,ic,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Dst=Ist))||Dst);Ot.setClassAlias(Rrt,"sp.Skeleton.SpineSocket");let Mrt=(Ost=Vl("sp.Skeleton"),Bst=ec(),Nst=Jl(),Lst=yc($g),Fst=_c(),zst=sc(),Vst=nc(),Ust=yc(Tst),Gst=sc(),kst=yc(wrt),Hst=rc(),jst=sc(),Wst=yc(Ert),qst=rc(),Xst=sc(),Yst=rc(),Kst=yc(Prt),$st=rc(),Jst=rc(),Zst=rc(),Qst=rc(),trt=rc(),ert=rc(),irt=rc(),nrt=yc([Rrt]),srt=rc(),rrt=nc(),ort=nc(),Ost(art=Bst(art=Nst(art=$l((Trt=Crt=class t extends iF{get meshRenderDataArray(){return this._meshRenderDataArray}get customMaterial(){return this._customMaterial}set customMaterial(t){this._customMaterial=t,this._cleanMaterialCache()}get skeletonData(){return this._skeletonData}set skeletonData(t){t&&t.resetEnums(),this._skeletonData!==t&&(this._skeletonData=t,this.defaultSkin="",this.defaultAnimation="",this._updateSkeletonData())}get animation(){if(this.isAnimationCached())return this._animationName;const t=this.getCurrent(0);return t&&t.animation.name||""}set animation(t){t?(this.setAnimation(0,t,this.loop),this.destroyRenderData(),this.markForUpdateRenderData()):this.isAnimationCached()||(this.clearTrack(0),this.setToSetupPose())}get _defaultSkinIndex(){if(this.skeletonData){const t=this.skeletonData.getSkinsEnum();if(t)if(""===this.defaultSkin){if(t.hasOwnProperty(0))return this._defaultSkinIndex=0,0}else{const e=t[this.defaultSkin];if(void 0!==e)return e}}return 0}set _defaultSkinIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getSkinsEnum()),!e)return void console.error(`${this.name} skin enums are invalid`);const i=e[t];void 0!==i?(this.defaultSkin=i,this.setSkin(this.defaultSkin)):console.error(`${this.name} skin enums are invalid`)}get _animationIndex(){const t=this.animation;if(this.skeletonData)if(t){const e=this.skeletonData.getAnimsEnum();if(e){const i=e[t];if(void 0!==i)return i}}else this._refreshInspector();return 0}set _animationIndex(t){let e;if(this.skeletonData&&(e=this.skeletonData.getAnimsEnum()),!e)return void console.error(`${this.name} animation enums are invalid`);const i=e[t];void 0!==i?(this.animation=i,this.animation=i):console.error(`${this.name} animation enums are invalid`)}get defaultCacheMode(){return this._defaultCacheMode}set defaultCacheMode(t){this._defaultCacheMode=t,this.setAnimationCacheMode(this._defaultCacheMode)}get premultipliedAlpha(){return this._premultipliedAlpha}set premultipliedAlpha(t){t!==this._premultipliedAlpha&&(this._premultipliedAlpha=t,this.markForUpdateRenderData())}get timeScale(){return this._timeScale}set timeScale(t){t!==this._timeScale&&(this._timeScale=t)}get debugSlots(){return this._debugSlots}set debugSlots(t){t!==this._debugSlots&&(this._debugSlots=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugBones(){return this._debugBones}set debugBones(t){t!==this._debugBones&&(this._debugBones=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get debugMesh(){return this._debugMesh}set debugMesh(t){t!==this._debugMesh&&(this._debugMesh=t,this._updateDebugDraw(),this.markForUpdateRenderData())}get useTint(){return this._useTint}set useTint(t){t!==this._useTint&&(this._useTint=t,this._updateUseTint(),this.markForUpdateRenderData())}get sockets(){return this._sockets}set sockets(t){this._sockets=t,this._updateSocketBindings(),this.attachUtil._syncAttachedNode()}get socketNodes(){return this._socketNodes}constructor(){super(),Tl(this,"paused",crt,this),Tl(this,"loop",hrt,this),Tl(this,"_premultipliedAlpha",_rt,this),Tl(this,"_timeScale",urt,this),this.enableBatch=!1,this._frameCache=null,this._curFrame=null,this._effectDelegate=null,this._skeleton=void 0,this._clipper=void 0,this._debugRenderer=void 0,this._startSlotIndex=void 0,this._endSlotIndex=void 0,this._startEntry=void 0,this._endEntry=void 0,this.attachUtil=void 0,this._materialCache={},this._enumSkins=Nt({}),this._enumAnimations=Nt({}),this._accTime=0,this._playCount=0,this._skeletonCache=null,this._animationName="",this._animationQueue=[],this._headAniInfo=null,this._playTimes=0,this._isAniComplete=!0,Tl(this,"_useTint",mrt,this),Tl(this,"_preCacheMode",prt,this),Tl(this,"_cacheMode",drt,this),Tl(this,"_defaultCacheMode",frt,this),Tl(this,"_debugBones",grt,this),Tl(this,"_debugSlots",yrt,this),Tl(this,"_skeletonData",vrt,this),Tl(this,"defaultSkin",xrt,this),Tl(this,"defaultAnimation",brt,this),Tl(this,"_sockets",Srt,this),this._meshRenderDataArray=[],Tl(this,"_debugMesh",Art,this),this._rootBone=void 0,this._state=void 0,this._listener=void 0,this._socketNodes=new Map,this._cachedSockets=new Map,this._meshRenderDataArrayIdx=0,this._effectDelegate=null,this._skeleton=null,this._rootBone=null,this._listener=null,this._debugRenderer=null,this._startSlotIndex=-1,this._endSlotIndex=-1,this._startEntry={animation:{name:""},trackIndex:0},this._endEntry={animation:{name:""},trackIndex:0},this.attachUtil=new _st,Irt(this,"_defaultSkinIndex",this._enumSkins),Irt(this,"_animationIndex",this._enumAnimations)}disableRender(){this.destroyRenderData()}setSkeletonData(t){const e=this.node._uiProps.uiTransformComp;if(null!=t.width&&null!=t.height&&e.setContentSize(t.width,t.height),this._cacheMode===Prt.SHARED_CACHE?this._skeletonCache=lst.sharedCache:this._cacheMode===Prt.PRIVATE_CACHE&&(this._skeletonCache=new lst,this._skeletonCache.enablePrivateMode()),this.isAnimationCached()){(this.debugBones||this.debugSlots)&&m("Debug bones or slots is invalid in cached mode");const e=this._skeletonCache.getSkeletonCache(this.skeletonData._uuid,t);this._skeleton=e.skeleton,this._clipper=e.clipper,this._rootBone=this._skeleton.getRootBone()}else this._skeleton=new Nnt.Skeleton(t),this._clipper=new Nnt.SkeletonClipping,this._rootBone=this._skeleton.getRootBone();this.markForUpdateRenderData()}setSlotsRange(t,e){this.isAnimationCached()?m("Slots visible range can not be modified in cached mode."):(this._startSlotIndex=t,this._endSlotIndex=e)}setAnimationStateData(t){if(this.isAnimationCached())m("'setAnimationStateData' interface can not be invoked in cached mode.");else{const e=new Nnt.AnimationState(t);this._listener&&(this._state&&this._state.removeListener(this._listener),e.addListener(this._listener)),this._state=e}}__preload(){super.__preload();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateSkeletonData(),this._updateDebugDraw(),this._updateUseTint(),this._indexBoneSockets(),this._updateSocketBindings()}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._updateSkeletonData(),this._updateUseTint(),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==Prt.REALTIME}updateAnimation(t){if(!this.paused)if(t*=1*this._timeScale,this.isAnimationCached()){if(this._isAniComplete){if(0===this._animationQueue.length&&!this._headAniInfo){const t=this._frameCache;if(t&&t.isInvalid()){t.updateToFrame();const e=t.frames;this._curFrame=e[e.length-1]}return}if(this._headAniInfo||(this._headAniInfo=this._animationQueue.shift()),this._accTime+=t,this._accTime>this._headAniInfo.delay){const t=this._headAniInfo;this._headAniInfo=null,this.setAnimation(0,t.animationName,t.loop)}return}this._updateCache(t)}else this._updateRealtime(t)}setVertexEffectDelegate(t){this._effectDelegate=t}setToSetupPose(){this._skeleton&&this._skeleton.setToSetupPose()}setBonesToSetupPose(){this._skeleton&&this._skeleton.setBonesToSetupPose()}setSlotsToSetupPose(){this._skeleton&&this._skeleton.setSlotsToSetupPose()}updateAnimationCache(t){if(!this.isAnimationCached())return;const e=this._skeletonData._uuid;this._skeletonCache&&this._skeletonCache.updateAnimationCache(e,t)}invalidAnimationCache(){this.isAnimationCached()&&this._skeletonCache&&this._skeletonCache.invalidAnimationCache(this._skeletonData._uuid)}findBone(t){return this._skeleton?this._skeleton.findBone(t):null}findSlot(t){return this._skeleton?this._skeleton.findSlot(t):null}setSkin(t){this._skeleton&&(this._skeleton.setSkinByName(t),this._skeleton.setSlotsToSetupPose()),this.invalidAnimationCache()}getAttachment(t,e){return this._skeleton?this._skeleton.getAttachmentByName(t,e):null}setAttachment(t,e){this._skeleton&&this._skeleton.setAttachment(t,e),this.invalidAnimationCache()}getTextureAtlas(t){return t.region}setMix(t,e,i){this._state&&this._state.data.setMix(t,e,i)}setAnimation(t,e,i){if(this._playTimes=i?0:1,this._animationName=e,this.isAnimationCached()){if(0!==t&&m("Track index can not greater than 0 in cached mode."),!this._skeletonCache)return null;let i=this._skeletonCache.getAnimationCache(this._skeletonData._uuid,e);i||(i=this._skeletonCache.initAnimationCache(this._skeletonData._uuid,e)),i&&(this._isAniComplete=!1,this._accTime=0,this._playCount=0,this._frameCache=i,this._socketNodes.size>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._curFrame=this._frameCache.frames[0])}else if(this._skeleton){const n=this._skeleton.data.findAnimation(e);if(!n)return b(7509,e),null;const s=this._state.setAnimationWith(t,n,i);return this._state.apply(this._skeleton),s}return null}addAnimation(t,e,i,n){if(n=n||0,this.isAnimationCached())0!==t&&m("Track index can not greater than 0 in cached mode."),this._animationQueue.push({animationName:e,loop:i,delay:n});else if(this._skeleton){var s;const r=this._skeleton.data.findAnimation(e);return r?null===(s=this._state)||void 0===s?void 0:s.addAnimationWith(t,r,i,n):(b(7510,e),null)}return null}findAnimation(t){return this._skeleton?this._skeleton.data.findAnimation(t):null}getCurrent(t){if(this.isAnimationCached())m("'getCurrent' interface can not be invoked in cached mode.");else if(this._state)return this._state.getCurrent(t);return null}clearTracks(){this.isAnimationCached()?m("'clearTracks' interface can not be invoked in cached mode."):this._state&&(this._state.clearTracks(),this.setToSetupPose())}clearTrack(t){this.isAnimationCached()?m("'clearTrack' interface can not be invoked in cached mode."):this._state&&this._state.clearTrack(t)}setStartListener(t){this._ensureListener(),this._listener.start=t}setInterruptListener(t){this._ensureListener(),this._listener.interrupt=t}setEndListener(t){this._ensureListener(),this._listener.end=t}setDisposeListener(t){this._ensureListener(),this._listener.dispose=t}setCompleteListener(t){this._ensureListener(),this._listener.complete=t}setEventListener(t){this._ensureListener(),this._listener.event=t}setTrackStartListener(t,e){Rnt.getListeners(t).start=e}setTrackInterruptListener(t,e){Rnt.getListeners(t).interrupt=e}setTrackEndListener(t,e){Rnt.getListeners(t).end=e}setTrackDisposeListener(t,e){Rnt.getListeners(t).dispose=e}setTrackCompleteListener(t,e){Rnt.getListeners(t).complete=function(t){const i=Math.floor(t.trackTime/t.animationEnd);e(t,i)}}setTrackEventListener(t,e){Rnt.getListeners(t).event=e}getState(){return this._state}onEnable(){super.onEnable(),this._flushAssembler(),wst.getInstance().add(this)}onDisable(){super.onDisable(),wst.getInstance().remove(this)}onDestroy(){this._cleanMaterialCache(),this.destroyRenderData(),super.onDestroy()}requestMeshRenderData(t){if(this._meshRenderDataArray.length>0&&0===this._meshRenderDataArray[this._meshRenderDataArray.length-1].renderData.vertexCount)return this._meshRenderDataArray[this._meshRenderDataArray.length-1];const e=new cL(t),i={renderData:e};return e.material=null,this._meshRenderDataArray.push(i),i}destroyRenderData(){this._meshRenderDataArray.length>0&&(this._meshRenderDataArray.forEach((t=>{t.renderData.reset()})),this._meshRenderDataArray.length=0)}getMaterialForBlendAndTint(t,e,i){const n=`${i}/${t}/${e}`;let s=this._materialCache[n];if(s)return s;let r=this.customMaterial;null===r&&(r=rg.get("default-spine-material"));let o=!1;switch(i){case Drt.TWO_COLORED:o=!0;break;case Drt.COLORED_TEXTURED:}return s=new ny({parent:r,subModelIdx:0,owner:this}),this._materialCache[n]=s,s.overridePipelineStates({blendState:{blendColor:Ri.WHITE,targets:[{blendEq:Ks.ADD,blendAlphaEq:Ks.ADD,blendSrc:t,blendDst:e,blendSrcAlpha:t,blendDstAlpha:e}]}}),s.recompileShaders({TWO_COLORED:o}),s}updateMaterial(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),void(this._blendHash=-1);const t=this._updateBuiltinMaterial();this.setMaterial(t,0),this._updateBlendFunc(),this._blendHash=-1}querySockets(){return this._skeleton?(0===this._cachedSockets.size&&this._indexBoneSockets(),this._cachedSockets.size>0?Array.from(this._cachedSockets.keys()).sort():[]):[]}_render(t){if(this._meshRenderDataArray)for(let e=0;e<this._meshRenderDataArray.length;e++){const i=this.material;this._meshRenderDataArrayIdx=e;const n=this._meshRenderDataArray[e];n.renderData.material&&(this.material=n.renderData.material),n.texture&&t.commitComp(this,n.texture,this._assembler,null),this.material=i}}updateWorldTransform(){this.isAnimationCached()&&this._skeleton&&this._skeleton.updateWorldTransform()}_emitCacheCompleteEvent(){this._listener&&(this._endEntry.animation.name=this._animationName,this._listener.complete&&this._listener.complete(this._endEntry),this._listener.end&&this._listener.end(this._endEntry))}_updateCache(t){const e=this._frameCache;if(!e.isInited())return;const i=e.frames,n=lst.FrameTime;0===this._accTime&&0===this._playCount&&(this._startEntry.animation.name=this._animationName,this._listener&&this._listener.start&&this._listener.start(this._startEntry)),this._accTime+=t;let s=Math.floor(this._accTime/n);if(e.isCompleted||e.updateToFrame(s),e.isCompleted&&s>=i.length){if(this._playCount++,this._playTimes>0&&this._playCount>=this._playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playCount=0,this._isAniComplete=!0,this._emitCacheCompleteEvent(),void this.markForUpdateRenderData();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s],this.markForUpdateRenderData()}_updateRealtime(t){const e=this._skeleton,i=this._state;e&&(e.update(t),i&&(i.update(t),i.apply(e)),this.markForUpdateRenderData())}_indexBoneSockets(){if(!this._skeleton)return;this._cachedSockets.clear();const t=this._skeleton.bones,e=i=>null==i.parent?i.data.name||"<Unamed>":`${e(t[i.parent.data.index])}/${i.data.name}`;for(let i=0,n=t.length;i<n;i++){const n=t[i].data,s=e(t[i]);this._cachedSockets.set(s,n.index)}}_updateUseTint(){this._cleanMaterialCache(),this.destroyRenderData()}_updateBatch(){this.markForUpdateRenderData()}_validateRender(){this.skeletonData||this.disableRender()}_updateAnimEnum(){let t;t=this.skeletonData?this.skeletonData.getAnimsEnum():Ert,this._enumAnimations=Nt({}),Object.assign(this._enumAnimations,t),Nt.update(this._enumAnimations),Irt(this,"_animationIndex",this._enumAnimations)}_updateSkinEnum(){let t;t=this.skeletonData?this.skeletonData.getSkinsEnum():wrt,this._enumSkins=Nt({}),Object.assign(this._enumSkins,t),Nt.update(this._enumSkins),Irt(this,"_defaultSkinIndex",this._enumSkins)}_ensureListener(){this._listener||(this._listener=new Rnt,this._state&&this._state.addListener(this._listener))}_updateSkeletonData(){if(!this.skeletonData)return void this.disableRender();const t=this.skeletonData.getRuntimeData();if(t){try{this.setSkeletonData(t),this.isAnimationCached()||this.setAnimationStateData(new Nnt.AnimationStateData(this._skeleton.data)),this.defaultSkin&&this.setSkin(this.defaultSkin)}catch(t){m(t)}this._indexBoneSockets(),this.attachUtil.init(this),this._preCacheMode=this._cacheMode,this.animation=this.defaultAnimation}else this.disableRender()}_refreshInspector(){this._updateAnimEnum(),this._updateSkinEnum()}_updateDebugDraw(){if(this.debugBones||this.debugSlots||this.debugMesh){if(!this._debugRenderer){const t=new Yv("DEBUG_DRAW_NODE");t.hideFlags|=Me.Flags.DontSave|Me.Flags.HideInHierarchy;const e=t.addComponent(aV);e.lineWidth=1,e.strokeColor=new Ri(255,0,0,255),this._debugRenderer=e,t.parent=this.node}this.isAnimationCached()&&m("Debug bones or slots is invalid in cached mode")}else this._debugRenderer&&(this._debugRenderer.node.destroy(),this._debugRenderer=null)}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),0===this._meshRenderDataArray.length&&this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_updateSocketBindings(){if(this._skeleton){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}this._socketNodes.set(t,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent===this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}const e=new Map;t.forEach((t=>{t.target&&(e.get(t.target)?console.error(`Target node ${t.target.name} has existed.`):e.set(t.target,!0))}))}_cleanMaterialCache(){for(const t in this._materialCache)this._materialCache[t].destroy();this._materialCache={}}},Crt.SpineSocket=Rrt,Crt.AnimationCacheMode=Prt,wl((lrt=Trt).prototype,"customMaterial",[vc,Lst,Fst,zst],Object.getOwnPropertyDescriptor(lrt.prototype,"customMaterial"),lrt.prototype),crt=wl(lrt.prototype,"paused",[Vst],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wl(lrt.prototype,"skeletonData",[ic,Ust],Object.getOwnPropertyDescriptor(lrt.prototype,"skeletonData"),lrt.prototype),wl(lrt.prototype,"_defaultSkinIndex",[Gst,kst,Hst],Object.getOwnPropertyDescriptor(lrt.prototype,"_defaultSkinIndex"),lrt.prototype),wl(lrt.prototype,"_animationIndex",[jst,Wst,qst],Object.getOwnPropertyDescriptor(lrt.prototype,"_animationIndex"),lrt.prototype),wl(lrt.prototype,"defaultCacheMode",[Xst,Yst,ic,Kst],Object.getOwnPropertyDescriptor(lrt.prototype,"defaultCacheMode"),lrt.prototype),hrt=wl(lrt.prototype,"loop",[Wl,$st],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_rt=wl(lrt.prototype,"_premultipliedAlpha",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wl(lrt.prototype,"premultipliedAlpha",[ic,Jst],Object.getOwnPropertyDescriptor(lrt.prototype,"premultipliedAlpha"),lrt.prototype),urt=wl(lrt.prototype,"_timeScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),wl(lrt.prototype,"timeScale",[Zst,ic],Object.getOwnPropertyDescriptor(lrt.prototype,"timeScale"),lrt.prototype),wl(lrt.prototype,"debugSlots",[ic,Qst],Object.getOwnPropertyDescriptor(lrt.prototype,"debugSlots"),lrt.prototype),wl(lrt.prototype,"debugBones",[ic,trt],Object.getOwnPropertyDescriptor(lrt.prototype,"debugBones"),lrt.prototype),wl(lrt.prototype,"debugMesh",[ic,ert],Object.getOwnPropertyDescriptor(lrt.prototype,"debugMesh"),lrt.prototype),wl(lrt.prototype,"useTint",[ic,irt],Object.getOwnPropertyDescriptor(lrt.prototype,"useTint"),lrt.prototype),wl(lrt.prototype,"sockets",[nrt,srt],Object.getOwnPropertyDescriptor(lrt.prototype,"sockets"),lrt.prototype),mrt=wl(lrt.prototype,"_useTint",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),prt=wl(lrt.prototype,"_preCacheMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),drt=wl(lrt.prototype,"_cacheMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Prt.REALTIME}}),frt=wl(lrt.prototype,"_defaultCacheMode",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Prt.REALTIME}}),grt=wl(lrt.prototype,"_debugBones",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yrt=wl(lrt.prototype,"_debugSlots",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vrt=wl(lrt.prototype,"_skeletonData",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),xrt=wl(lrt.prototype,"defaultSkin",[Wl,rrt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),brt=wl(lrt.prototype,"defaultAnimation",[ort,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Srt=wl(lrt.prototype,"_sockets",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Art=wl(lrt.prototype,"_debugMesh",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),art=lrt))||art)||art)||art)||art);n.internal.SpineSkeleton=Mrt;let Ort=0;const Brt=[0,1,2,2,3,0],Nrt=new Ri(0,0,255,255),Lrt=new Ri(255,0,0,255),Frt=new Ri(0,255,0,255),zrt=new Ri(255,255,0,255),Vrt=new Nnt.Color(1,1,1,1),Urt=new Nnt.Color(1,1,1,1),Grt=new Nnt.Vector2,krt=new Nnt.Vector2;let Hrt,jrt,Wrt,qrt,Xrt,Yrt,Krt,$rt,Jrt,Zrt,Qrt,tot;const eot=new Float32Array(4),iot=new Float32Array(4),not=new Ni;let sot,rot,oot,aot,lot,cot,hot,_ot,uot,mot,pot,dot,fot,got,yot,vot,xot,bot,Sot,Aot,Cot,Tot,wot,Eot,Pot,Dot,Iot,Rot,Mot,Oot,Bot=0,Not=0,Lot=0,Fot=0,zot=0,Vot=0,Uot=0,Got=null,kot=null,Hot=null;function jot(t){let e,i;switch(t){case Nnt.BlendMode.Additive:e=Hrt?Ys.ONE:Ys.SRC_ALPHA,i=Ys.ONE;break;case Nnt.BlendMode.Multiply:e=Ys.DST_COLOR,i=Ys.ONE_MINUS_SRC_ALPHA;break;case Nnt.BlendMode.Screen:e=Ys.ONE,i=Ys.ONE_MINUS_SRC_COLOR;break;case Nnt.BlendMode.Normal:default:e=Hrt?Ys.ONE:Ys.SRC_ALPHA,i=Ys.ONE_MINUS_SRC_ALPHA}return Iot.getMaterialForBlendAndTint(e,i,Xrt?Drt.TWO_COLORED:Drt.COLORED_TEXTURED)}function Wot(t){Tot=t.fa*tot,jrt=Hrt?Tot/255:1,vot=Jrt*jrt,xot=Zrt*jrt,bot=Qrt*jrt,Sot=t.fr*vot,Aot=t.fg*xot,Cot=t.fb*bot,eot[0]=Sot/255,eot[1]=Aot/255,eot[2]=Cot/255,eot[3]=Tot/255,wot=t.dr*vot,Eot=t.dg*xot,Pot=t.db*bot,Dot=Hrt?255:0,iot[0]=wot/255,iot[1]=Eot/255,iot[2]=Pot/255,iot[3]=Dot/255}const qot=new Float32Array(4);function Xot(t){return qot[0]=t.r/255,qot[1]=t.g/255,qot[2]=t.b/255,qot[3]=t.a/255,qot}function Yot(t){return t?13:9}const Kot={createData(){},updateRenderData(t,e){Iot=t;const i=t._skeleton;!t.isAnimationCached()&&i&&i.updateWorldTransform(),i&&function(t){if(!t._skeleton)return;const e=t.color;let i;Jrt=e.r/255,Zrt=e.g/255,Qrt=e.b/255,tot=e.a/255,Xrt=t.useTint||t.isAnimationCached(),sot=Yot(Xrt),Mot=t.node,t.destroyRenderData(),Rot=t.requestMeshRenderData(sot),Iot=t,kot=null,hot=!0,Hrt=t.premultipliedAlpha,jrt=1,Ort=0,Oot=!1,Got=t._effectDelegate&&t._effectDelegate._vertexEffect,(4294967295!==e._val||Hrt)&&(Oot=!0),Xrt&&(Ort|=1),Iot.enableBatch&&(i=Mot.worldMatrix,hot=!1,Ort|=16),t.isAnimationCached()?function(t){const e=Iot._curFrame;if(!e)return;const i=e.segments;if(0===i.length)return;let n,s;rot=12;let r=null;const o=e.vertices,a=e.indices;let l=0,c=0,h=0;t&&(mot=t.m00,fot=t.m01,pot=t.m04,got=t.m05,dot=t.m12,yot=t.m13);const _=16&Ort,u=_&&(1===mot&&0===fot&&0===pot&&1===got);let m=0;const p=e.colors;let d=p[m++],f=d.vfOffset;Wot(d);for(let t=0,e=i.length;t<e;t++){const e=i[t];if(r=jot(e.blendMode),!r)continue;kot||(kot=r),Hot||(Hot=e.tex),Rot.renderData.material&&(Rot.renderData.material=kot),(hot||r.hash!==kot.hash||e.tex&&e.tex!==Hot)&&(hot=!1,Rot.texture||(Rot.texture=e.tex),Rot=Iot.requestMeshRenderData(Yot(Xrt)),kot=r,Hot=e.tex,Rot.texture=e.tex,Rot.renderData.material=kot),Not=e.vertexCount,zot=e.indexCount,Rot.renderData.reserve(Not,zot),Vot=Rot.renderData.indicesCount,Lot=Rot.renderData.vertexCount,Uot=Rot.renderData.vDataOffset,n=Rot.renderData.vData,s=Rot.renderData.iData;for(let t=Vot,e=Vot+zot;t<e;t++)s[t]=Lot+a[c++];h=e.vfCount;const g=o.subarray(l,l+h);l+=h;let y=Uot;sot=Yot(Xrt);for(let t=0;t<g.length;)n[y+0]=g[t+0],n[y+1]=g[t+1],n[y+3]=g[t+3],n[y+4]=g[t+4],n[y+5]=g[t+5],n[y+6]=g[t+6],n[y+7]=g[t+7],n[y+8]=g[t+8],Xrt&&(n[y+9]=g[t+9],n[y+10]=g[t+10],n[y+11]=g[t+11],n[y+12]=g[t+12]),y+=sot,t+=13;if(u)for(let t=Uot,e=Uot+h;t<e;t+=sot)n[t]+=dot,n[t+1]+=yot;else if(_)for(let t=Uot,e=Uot+h;t<e;t+=sot)_ot=n[t],uot=n[t+1],n[t]=_ot*mot+uot*pot+dot,n[t+1]=_ot*fot+uot*got+yot;if(Rot.renderData.advance(Not,zot),!Oot)continue;let v=l-h;for(let t=Uot,e=Uot+h;t<e;t+=sot,v+=6)v>=f&&(d=p[m++],Wot(d),f=d.vfOffset),n.set(eot,t+5),n.set(iot,t+9)}}(i):(Got&&Got.begin(t._skeleton),function(t){let e,i;const n=Iot._skeleton,s=n.color,r=Iot._debugRenderer,o=Iot._clipper;let a,l,c,h,_,u,m,p=null;Wrt=Iot._startSlotIndex,qrt=Iot._endSlotIndex,cot=!1,-1===Wrt&&(cot=!0),Yrt=Iot.debugSlots,Krt=Iot.debugBones,$rt=Iot.debugMesh,r&&(Krt||Yrt||$rt)&&(r.clear(),r.lineWidth=5),rot=12,Bot=0,Lot=0,Fot=0,zot=0,Vot=0;for(let f=0,g=n.drawOrder.length;f<g;f++){var d;if(m=n.drawOrder[f],void 0===m)continue;if(Wrt>=0&&Wrt===m.data.index&&(cot=!0),!cot){o.clipEndWithSlot(m);continue}if(qrt>=0&&qrt===m.data.index&&(cot=!1),Bot=0,zot=0,a=m.getAttachment(),!a){o.clipEndWithSlot(m);continue}if(h=a instanceof Nnt.RegionAttachment,_=a instanceof Nnt.MeshAttachment,u=a instanceof Nnt.ClippingAttachment,u){o.clipStart(m,a);continue}if(!h&&!_){o.clipEndWithSlot(m);continue}const g=a.region.texture.getRealTexture();if(p=jot(m.data.blendMode),!p){o.clipEndWithSlot(m);continue}if(kot||(kot=p),(null===(d=Rot)||void 0===d?void 0:d.renderData.material)||(Rot.renderData.material=kot),(hot||p.hash!==kot.hash||g&&Hot!==g)&&(hot=!1,Rot=Iot.requestMeshRenderData(sot),kot=p,Hot=g,Rot.texture=g,Rot.renderData.material=kot),h){if(c=Brt,Bot=4*sot,zot=6,Rot.renderData.reserve(4,6),Vot=Rot.renderData.indicesCount,Lot=Rot.renderData.vertexCount,Fot=Rot.renderData.vDataOffset,e=Rot.renderData.vData,i=Rot.renderData.iData,a.computeWorldVertices(m.bone,e,Fot,sot),r&&Yrt){r.strokeColor=Nrt,r.moveTo(e[Fot],e[Fot+1]);for(let t=Fot+sot,i=Fot+Bot;t<i;t+=sot)r.lineTo(e[t],e[t+1]);r.close(),r.stroke()}}else if(_){const t=a;if(c=t.triangles,Bot=(t.worldVerticesLength>>1)*sot,zot=c.length,Rot.renderData.reserve(t.worldVerticesLength>>1,zot),Vot=Rot.renderData.indicesCount,Lot=Rot.renderData.vertexCount,Fot=Rot.renderData.vDataOffset,e=Rot.renderData.vData,i=Rot.renderData.iData,t.computeWorldVertices(m,0,t.worldVerticesLength,e,Fot,sot),r&&$rt){r.strokeColor=zrt;for(let t=0,i=c.length;t<i;t+=3){const i=c[t]*sot+Fot,n=c[t+1]*sot+Fot,s=c[t+2]*sot+Fot;r.moveTo(e[i],e[i+1]),r.lineTo(e[n],e[n+1]),r.lineTo(e[s],e[s+1]),r.close(),r.stroke()}}}if(0===Bot||0===zot){o.clipEndWithSlot(m);continue}const y=a;i.set(c,Vot),l=y.uvs;for(let t=Fot,i=Fot+Bot,n=0;t<i;t+=sot,n+=2)e[t+3]=l[n],e[t+4]=l[n+1];if($ot(s,y.color,m.color,o,m),e=Rot.renderData.vData,i=Rot.renderData.iData,zot>0){for(let t=Vot,e=Vot+zot;t<e;t++)i[t]+=Lot;if(t){mot=t.m00,pot=t.m04,dot=t.m12,fot=t.m01,got=t.m05,yot=t.m13;for(let t=Fot,i=Fot+Bot;t<i;t+=sot)_ot=e[t],uot=e[t+1],e[t]=_ot*mot+uot*pot+dot,e[t+1]=_ot*fot+uot*got+yot}Rot.renderData.advance(Bot/sot,zot)}o.clipEndWithSlot(m)}if(o.clipEnd(),r&&Krt){let t;r.strokeColor=Lrt,r.fillColor=Nrt;for(let e=0,i=n.bones.length;e<i;e++){t=n.bones[e];const i=t.data.length*t.a+t.worldX,s=t.data.length*t.c+t.worldY;r.moveTo(t.worldX,t.worldY),r.lineTo(i,s),r.stroke(),r.circle(t.worldX,t.worldY,1.5*Math.PI),r.fill(),0===e&&(r.fillColor=Frt)}}}(i),Got&&Got.end()),t.attachUtil._syncAttachedNode(),Mot=void 0,Rot=void 0,Iot=void 0,Got=null}(t)},updateColor(t){t&&(Iot=t,Iot.markForUpdateRenderData())},fillBuffers(t,e){if(!t||!t.meshRenderDataArray)return;Iot=t;const i=t.meshRenderDataArray,n=t.node,s=i[t._meshRenderDataArrayIdx].renderData;let r=e.acquireBufferBatch(9===s.floatStride?Mz:Oz),o=r.byteOffset>>2,a=r.indicesOffset,l=r.vertexOffset;r.request(s.vertexCount,s.indicesCount)||(r=e.currBufferBatch,o=0,a=0,l=0);const c=r.vData,h=r.iData,_=n.worldMatrix,u=s.vData,m=s.vertexStart,p=s.iData,d=s.floatStride;c.set(u.subarray(m,m+s.vertexCount*d),o);for(let t=0;t<s.vertexCount;t++){const e=o+t*d;not.set(c[e],c[e+1],c[e+2]),not.transformMat4(_),c[e]=not.x,c[e+1]=not.y,c[e+2]=not.z}const f=s.indicesStart;for(let t=0;t<s.indicesCount;t+=1)h[t+a]=p[t+f]+l}};function $ot(t,e,i,n,s){let r=Rot.renderData.vData,o=Rot.renderData.iData;if(Vrt.a=i.a*e.a*t.a*tot*255,jrt=Hrt?Vrt.a:255,oot=Jrt*e.r*t.r*jrt,aot=Zrt*e.g*t.g*jrt,lot=Qrt*e.b*t.b*jrt,Vrt.r=oot*i.r,Vrt.g=aot*i.g,Vrt.b=lot*i.b,null==s.darkColor?Urt.set(0,0,0,1):(Urt.r=s.darkColor.r*oot,Urt.g=s.darkColor.g*aot,Urt.b=s.darkColor.b*lot),Urt.a=Hrt?255:0,n.isClipping()){rot=Xrt?12:8;const t=r.subarray(Fot),e=r.subarray(Fot+3);n.clipTriangles(t,Bot,o.subarray(Vot),zot,e,Vrt,Urt,Xrt,sot);const i=new Float32Array(n.clippedVertices),s=n.clippedTriangles;if(zot=s.length,Bot=i.length/rot*sot,Rot.renderData.reserve(Bot/sot,zot),Vot=Rot.renderData.indicesCount,Lot=Rot.renderData.vertexCount,Fot=Rot.renderData.vDataOffset,r=Rot.renderData.vData,o=Rot.renderData.iData,s.length>0&&o.set(s,Vot),Got)for(let t=0,e=i.length,n=Fot;t<e;t+=rot,n+=sot)Grt.x=i[t],Grt.y=i[t+1],Vrt.set(i[t+2],i[t+3],i[t+4],i[t+5]),krt.x=i[t+6],krt.y=i[t+7],Xrt?Urt.set(i[t+8],i[t+9],i[t+10],i[t+11]):Urt.set(0,0,0,0),Got.transform(Grt,krt,Vrt,Urt),r[n]=Grt.x,r[n+1]=Grt.y,r[n+3]=krt.x,r[n+4]=krt.y,r.set(Xot(Vrt),n+5),Xrt&&r.set(Xot(Urt),n+9);else for(let t=0,e=i.length,n=Fot;t<e;t+=rot,n+=sot)r[n]=i[t],r[n+1]=i[t+1],r[n+3]=i[t+6],r[n+4]=i[t+7],r[n+5]=i[t+2]/255,r[n+6]=i[t+3]/255,r[n+7]=i[t+4]/255,r[n+8]=i[t+5]/255,Xrt&&(r[n+9]=i[t+8]/255,r[n+10]=i[t+9]/255,r[n+11]=i[t+10]/255,r[n+12]=i[t+11]/255)}else if(Got)for(let t=Fot,e=Fot+Bot;t<e;t+=sot)Grt.x=r[t],Grt.y=r[t+1],krt.x=r[t+3],krt.y=r[t+4],Got.transform(Grt,krt,Vrt,Urt),r[t]=Grt.x,r[t+1]=Grt.y,r[t+3]=krt.x,r[t+4]=krt.y,r.set(Xot(Vrt),t+5),Xrt&&r.set(Xot(Urt),t+9);else{eot.set(Xot(Vrt)),iot.set(Xot(Urt));for(let t=Fot,e=Fot+Bot;t<e;t+=sot)r.set(eot,t+5),Xrt&&r.set(iot,t+9)}}n.internal.SpineAssembler=Kot;const Jot={getAssembler:()=>Kot};Mrt.Assembler=Jot;const Zot=window.spine,Qot=Zot.VertexEffectDelegate;let tat,eat;!function(t){t[t.REGION=0]="REGION",t[t.BOUNDING_BOX=1]="BOUNDING_BOX",t[t.MESH=2]="MESH",t[t.SKINNED_MESH=3]="SKINNED_MESH"}(tat||(tat={})),zt(tat),function(t){t[t.START=0]="START",t[t.INTERRUPT=1]="INTERRUPT",t[t.END=2]="END",t[t.DISPOSE=3]="DISPOSE",t[t.COMPLETE=4]="COMPLETE",t[t.EVENT=5]="EVENT"}(eat||(eat={})),zt(eat),n.internal.SpineAnimationEventType=eat,t("sp",Object.freeze({__proto__:null,timeScale:1,get DefaultSkinsEnum(){return wrt},get DefaultAnimsEnum(){return Ert},get AnimationCacheMode(){return Prt},get SpineMaterialType(){return Drt},SpineSocket:Rrt,Skeleton:Mrt,SkeletonData:Tst,simpleSpineAssembler:Jot,spine:Zot,VertexEffectDelegate:Qot,get ATTACHMENT_TYPE(){return tat},get AnimationEventType(){return eat}}));var iat=Object.setPrototypeOf;let nat={};nat||(nat={}),function(t){var e=function(){function e(i){this._clock=new t.WorldClock,this._events=[],this._objects=[],this._eventManager=null,this._eventManager=i,console.info("DragonBones: "+e.VERSION+"\nWebsite: http://dragonbones.com/\nSource and Demo: https://github.com/DragonBones/")}return e.prototype.advanceTime=function(e){if(this._objects.length>0){for(var i=0,n=this._objects;i<n.length;i++)n[i].returnToPool();this._objects.length=0}if(this._clock.advanceTime(e),this._events.length>0){for(var s=0;s<this._events.length;++s){var r=this._events[s],o=r.armature;null!==o._armatureData&&(o.eventDispatcher.dispatchDBEvent(r.type,r),r.type===t.EventObject.SOUND_EVENT&&this._eventManager.dispatchDBEvent(r.type,r)),this.bufferObject(r)}this._events.length=0}},e.prototype.bufferEvent=function(t){this._events.indexOf(t)<0&&this._events.push(t)},e.prototype.bufferObject=function(t){this._objects.indexOf(t)<0&&this._objects.push(t)},Object.defineProperty(e.prototype,"clock",{get:function(){return this._clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"eventManager",{get:function(){return this._eventManager},enumerable:!0,configurable:!0}),e.VERSION="5.6.300",e.yDown=!1,e.debug=!1,e.debugDraw=!1,e.webAssembly=!1,e}();t.DragonBones=e}(nat||(nat={})),console.warn||(console.warn=function(){}),console.assert||(console.assert=function(){}),Date.now||(Date.now=function(){return(new Date).getTime()}),iat=function(t,e){function i(){this.constructor=t}for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n]);i.prototype=e.prototype,t.prototype=new i},function(t){var e=function(){function t(){this.hashCode=t._hashCode++,this._isInPool=!1}return t._returnObject=function(e){var i=String(e.constructor),n=i in t._maxCountMap?t._maxCountMap[i]:t._defaultMaxCount,s=t._poolsMap[i]=t._poolsMap[i]||[];s.length<n&&(e._isInPool?console.warn("The object is already in the pool."):(e._isInPool=!0,s.push(e)))},t.toString=function(){throw new Error},t.setMaxCount=function(e,i){if((i<0||i!=i)&&(i=0),null!==e)null!==(s=(n=String(e))in t._poolsMap?t._poolsMap[n]:null)&&s.length>i&&(s.length=i),t._maxCountMap[n]=i;else for(var n in t._defaultMaxCount=i,t._poolsMap){var s;(s=t._poolsMap[n]).length>i&&(s.length=i),n in t._maxCountMap&&(t._maxCountMap[n]=i)}},t.clearPool=function(e){if(void 0===e&&(e=null),null!==e){var i=String(e);null!==(s=i in t._poolsMap?t._poolsMap[i]:null)&&s.length>0&&(s.length=0)}else for(var n in t._poolsMap){var s;(s=t._poolsMap[n]).length=0}},t.borrowObject=function(e){var i=String(e),n=i in t._poolsMap?t._poolsMap[i]:null;if(null!==n&&n.length>0){var s=n.pop();return s._isInPool=!1,s}var r=new e;return r._onClear(),r},t.prototype.returnToPool=function(){this._onClear(),t._returnObject(this)},t._hashCode=0,t._defaultMaxCount=3e3,t._maxCountMap={},t._poolsMap={},t}();t.BaseObject=e}(nat||(nat={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),this.a=t,this.b=e,this.c=i,this.d=n,this.tx=s,this.ty=r}return t.prototype.toString=function(){return"[object dragonBones.Matrix] a:"+this.a+" b:"+this.b+" c:"+this.c+" d:"+this.d+" tx:"+this.tx+" ty:"+this.ty},t.prototype.copyFrom=function(t){return this.a=t.a,this.b=t.b,this.c=t.c,this.d=t.d,this.tx=t.tx,this.ty=t.ty,this},t.prototype.copyFromArray=function(t,e){return void 0===e&&(e=0),this.a=t[e],this.b=t[e+1],this.c=t[e+2],this.d=t[e+3],this.tx=t[e+4],this.ty=t[e+5],this},t.prototype.identity=function(){return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this},t.prototype.concat=function(t){var e=this.a*t.a,i=0,n=0,s=this.d*t.d,r=this.tx*t.a+t.tx,o=this.ty*t.d+t.ty;return 0===this.b&&0===this.c||(e+=this.b*t.c,i+=this.b*t.d,n+=this.c*t.a,s+=this.c*t.b),0===t.b&&0===t.c||(i+=this.a*t.b,n+=this.d*t.c,r+=this.ty*t.c,o+=this.tx*t.b),this.a=e,this.b=i,this.c=n,this.d=s,this.tx=r,this.ty=o,this},t.prototype.invert=function(){var t=this.a,e=this.b,i=this.c,n=this.d,s=this.tx,r=this.ty;if(0===e&&0===i)return this.b=this.c=0,0===t||0===n?this.a=this.b=this.tx=this.ty=0:(t=this.a=1/t,n=this.d=1/n,this.tx=-t*s,this.ty=-n*r),this;var o=t*n-e*i;if(0===o)return this.a=this.d=1,this.b=this.c=0,this.tx=this.ty=0,this;o=1/o;var a=this.a=n*o;return e=this.b=-e*o,i=this.c=-i*o,n=this.d=t*o,this.tx=-(a*s+i*r),this.ty=-(e*s+n*r),this},t.prototype.transformPoint=function(t,e,i,n){void 0===n&&(n=!1),i.x=this.a*t+this.c*e,i.y=this.b*t+this.d*e,n||(i.x+=this.tx,i.y+=this.ty)},t.prototype.transformRectangle=function(t,e){void 0===e&&(e=!1);var i=this.a,n=this.b,s=this.c,r=this.d,o=e?0:this.tx,a=e?0:this.ty,l=t.x,c=t.y,h=l+t.width,_=c+t.height,u=i*l+s*c+o,m=n*l+r*c+a,p=i*h+s*c+o,d=n*h+r*c+a,f=i*h+s*_+o,g=n*h+r*_+a,y=i*l+s*_+o,v=n*l+r*_+a,x=0;u>p&&(x=u,u=p,p=x),f>y&&(x=f,f=y,y=x),t.x=Math.floor(u<f?u:f),t.width=Math.ceil((p>y?p:y)-t.x),m>d&&(x=m,m=d,d=x),g>v&&(x=g,g=v,v=x),t.y=Math.floor(m<g?m:g),t.height=Math.ceil((d>v?d:v)-t.y)},t}();t.Matrix=e}(nat||(nat={})),function(t){var e=function(){function t(t,e,i,n,s,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===s&&(s=1),void 0===r&&(r=1),this.x=t,this.y=e,this.skew=i,this.rotation=n,this.scaleX=s,this.scaleY=r}return t.normalizeRadian=function(t){return(t=(t+Math.PI)%(2*Math.PI))+(t>0?-Math.PI:Math.PI)},t.prototype.toString=function(){return"[object dragonBones.Transform] x:"+this.x+" y:"+this.y+" skewX:"+180*this.skew/Math.PI+" skewY:"+180*this.rotation/Math.PI+" scaleX:"+this.scaleX+" scaleY:"+this.scaleY},t.prototype.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.skew=t.skew,this.rotation=t.rotation,this.scaleX=t.scaleX,this.scaleY=t.scaleY,this},t.prototype.identity=function(){return this.x=this.y=0,this.skew=this.rotation=0,this.scaleX=this.scaleY=1,this},t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this.skew+=t.skew,this.rotation+=t.rotation,this.scaleX*=t.scaleX,this.scaleY*=t.scaleY,this},t.prototype.minus=function(t){return this.x-=t.x,this.y-=t.y,this.skew-=t.skew,this.rotation-=t.rotation,this.scaleX/=t.scaleX,this.scaleY/=t.scaleY,this},t.prototype.fromMatrix=function(e){var i=this.scaleX,n=this.scaleY,s=t.PI_Q;this.x=e.tx,this.y=e.ty,this.rotation=Math.atan(e.b/e.a);var r=Math.atan(-e.c/e.d);return this.scaleX=this.rotation>-s&&this.rotation<s?e.a/Math.cos(this.rotation):e.b/Math.sin(this.rotation),this.scaleY=r>-s&&r<s?e.d/Math.cos(r):-e.c/Math.sin(r),i>=0&&this.scaleX<0&&(this.scaleX=-this.scaleX,this.rotation=this.rotation-Math.PI),n>=0&&this.scaleY<0&&(this.scaleY=-this.scaleY,r-=Math.PI),this.skew=r-this.rotation,this},t.prototype.toMatrix=function(t){return 0===this.rotation?(t.a=1,t.b=0):(t.a=Math.cos(this.rotation),t.b=Math.sin(this.rotation)),0===this.skew?(t.c=-t.b,t.d=t.a):(t.c=-Math.sin(this.skew+this.rotation),t.d=Math.cos(this.skew+this.rotation)),1!==this.scaleX&&(t.a*=this.scaleX,t.b*=this.scaleX),1!==this.scaleY&&(t.c*=this.scaleY,t.d*=this.scaleY),t.tx=this.x,t.ty=this.y,this},t.PI=Math.PI,t.PI_D=2*Math.PI,t.PI_H=Math.PI/2,t.PI_Q=Math.PI/4,t.RAD_DEG=180/Math.PI,t.DEG_RAD=Math.PI/180,t}();t.Transform=e}(nat||(nat={})),function(t){var e=function(){function t(t,e,i,n,s,r,o,a){void 0===t&&(t=1),void 0===e&&(e=1),void 0===i&&(i=1),void 0===n&&(n=1),void 0===s&&(s=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.alphaMultiplier=t,this.redMultiplier=e,this.greenMultiplier=i,this.blueMultiplier=n,this.alphaOffset=s,this.redOffset=r,this.greenOffset=o,this.blueOffset=a}return t.prototype.copyFrom=function(t){this.alphaMultiplier=t.alphaMultiplier,this.redMultiplier=t.redMultiplier,this.greenMultiplier=t.greenMultiplier,this.blueMultiplier=t.blueMultiplier,this.alphaOffset=t.alphaOffset,this.redOffset=t.redOffset,this.greenOffset=t.greenOffset,this.blueOffset=t.blueOffset},t.prototype.identity=function(){this.alphaMultiplier=this.redMultiplier=this.greenMultiplier=this.blueMultiplier=1,this.alphaOffset=this.redOffset=this.greenOffset=this.blueOffset=0},t}();t.ColorTransform=e}(nat||(nat={})),function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t.prototype.clear=function(){this.x=this.y=0},t}();t.Point=e}(nat||(nat={})),function(t){var e=function(){function t(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),this.x=t,this.y=e,this.width=i,this.height=n}return t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height},t.prototype.clear=function(){this.x=this.y=0,this.width=this.height=0},t}();t.Rectangle=e}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.ints=[],e.floats=[],e.strings=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.UserData]"},e.prototype._onClear=function(){this.ints.length=0,this.floats.length=0,this.strings.length=0},e.prototype.addInt=function(t){this.ints.push(t)},e.prototype.addFloat=function(t){this.floats.push(t)},e.prototype.addString=function(t){this.strings.push(t)},e.prototype.getInt=function(t){return void 0===t&&(t=0),t>=0&&t<this.ints.length?this.ints[t]:0},e.prototype.getFloat=function(t){return void 0===t&&(t=0),t>=0&&t<this.floats.length?this.floats[t]:0},e.prototype.getString=function(t){return void 0===t&&(t=0),t>=0&&t<this.strings.length?this.strings[t]:""},e}(t.BaseObject);t.UserData=e;var i=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.data=null,e}return iat(e,t),e.toString=function(){return"[class dragonBones.ActionData]"},e.prototype._onClear=function(){null!==this.data&&this.data.returnToPool(),this.type=0,this.name="",this.bone=null,this.slot=null,this.data=null},e}(t.BaseObject);t.ActionData=i}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.frameIndices=[],e.cachedFrames=[],e.armatureNames=[],e.armatures={},e.userData=null,e}return iat(e,t),e.toString=function(){return"[class dragonBones.DragonBonesData]"},e.prototype._onClear=function(){for(var t in this.armatures)this.armatures[t].returnToPool(),delete this.armatures[t];null!==this.userData&&this.userData.returnToPool(),this.autoSearch=!1,this.frameRate=0,this.version="",this.name="",this.stage=null,this.frameIndices.length=0,this.cachedFrames.length=0,this.armatureNames.length=0,this.binary=null,this.intArray=null,this.floatArray=null,this.frameIntArray=null,this.frameFloatArray=null,this.frameArray=null,this.timelineArray=null,this.userData=null},e.prototype.addArmature=function(t){t.name in this.armatures?console.warn("Same armature: "+t.name):(t.parent=this,this.armatures[t.name]=t,this.armatureNames.push(t.name))},e.prototype.getArmature=function(t){return t in this.armatures?this.armatures[t]:null},e.prototype.dispose=function(){console.warn(""),this.returnToPool()},e}(t.BaseObject);t.DragonBonesData=e}(nat||(nat={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.aabb=new t.Rectangle,i.animationNames=[],i.sortedBones=[],i.sortedSlots=[],i.defaultActions=[],i.actions=[],i.bones={},i.slots={},i.constraints={},i.skins={},i.animations={},i.canvas=null,i.userData=null,i}return iat(i,e),i.toString=function(){return"[class dragonBones.ArmatureData]"},i.prototype._onClear=function(){for(var t=0,e=this.defaultActions;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this.actions;i<n.length;i++)n[i].returnToPool();for(var s in this.bones)this.bones[s].returnToPool(),delete this.bones[s];for(var s in this.slots)this.slots[s].returnToPool(),delete this.slots[s];for(var s in this.constraints)this.constraints[s].returnToPool(),delete this.constraints[s];for(var s in this.skins)this.skins[s].returnToPool(),delete this.skins[s];for(var s in this.animations)this.animations[s].returnToPool(),delete this.animations[s];null!==this.canvas&&this.canvas.returnToPool(),null!==this.userData&&this.userData.returnToPool(),this.type=0,this.frameRate=0,this.cacheFrameRate=0,this.scale=1,this.name="",this.aabb.clear(),this.animationNames.length=0,this.sortedBones.length=0,this.sortedSlots.length=0,this.defaultActions.length=0,this.actions.length=0,this.defaultSkin=null,this.defaultAnimation=null,this.canvas=null,this.userData=null,this.parent=null},i.prototype.sortBones=function(){var t=this.sortedBones.length;if(!(t<=0)){var e=this.sortedBones.concat(),i=0,n=0;for(this.sortedBones.length=0;n<t;){var s=e[i++];if(i>=t&&(i=0),!(this.sortedBones.indexOf(s)>=0)){var r=!1;for(var o in this.constraints){var a=this.constraints[o];if(a.root===s&&this.sortedBones.indexOf(a.target)<0){r=!0;break}}r||null!==s.parent&&this.sortedBones.indexOf(s.parent)<0||(this.sortedBones.push(s),n++)}}}},i.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0))for(var e in this.cacheFrameRate=t,this.animations)this.animations[e].cacheFrames(this.cacheFrameRate)},i.prototype.setCacheFrame=function(t,e){var i=this.parent.cachedFrames,n=i.length;return i.length+=10,i[n]=t.a,i[n+1]=t.b,i[n+2]=t.c,i[n+3]=t.d,i[n+4]=t.tx,i[n+5]=t.ty,i[n+6]=e.rotation,i[n+7]=e.skew,i[n+8]=e.scaleX,i[n+9]=e.scaleY,n},i.prototype.getCacheFrame=function(t,e,i){var n=this.parent.cachedFrames;t.a=n[i],t.b=n[i+1],t.c=n[i+2],t.d=n[i+3],t.tx=n[i+4],t.ty=n[i+5],e.rotation=n[i+6],e.skew=n[i+7],e.scaleX=n[i+8],e.scaleY=n[i+9],e.x=t.tx,e.y=t.ty},i.prototype.addBone=function(t){t.name in this.bones?console.warn("Same bone: "+t.name):(this.bones[t.name]=t,this.sortedBones.push(t))},i.prototype.addSlot=function(t){t.name in this.slots?console.warn("Same slot: "+t.name):(this.slots[t.name]=t,this.sortedSlots.push(t))},i.prototype.addConstraint=function(t){t.name in this.constraints?console.warn("Same constraint: "+t.name):this.constraints[t.name]=t},i.prototype.addSkin=function(t){t.name in this.skins?console.warn("Same skin: "+t.name):(t.parent=this,this.skins[t.name]=t,null===this.defaultSkin&&(this.defaultSkin=t),"default"===t.name&&(this.defaultSkin=t))},i.prototype.addAnimation=function(t){t.name in this.animations?console.warn("Same animation: "+t.name):(t.parent=this,this.animations[t.name]=t,this.animationNames.push(t.name),null===this.defaultAnimation&&(this.defaultAnimation=t))},i.prototype.addAction=function(t,e){e?this.defaultActions.push(t):this.actions.push(t)},i.prototype.getBone=function(t){return t in this.bones?this.bones[t]:null},i.prototype.getSlot=function(t){return t in this.slots?this.slots[t]:null},i.prototype.getConstraint=function(t){return t in this.constraints?this.constraints[t]:null},i.prototype.getSkin=function(t){return t in this.skins?this.skins[t]:null},i.prototype.getMesh=function(t,e,i){var n=this.getSkin(t);return null===n?null:n.getDisplay(e,i)},i.prototype.getAnimation=function(t){return t in this.animations?this.animations[t]:null},i}(t.BaseObject);t.ArmatureData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i.userData=null,i}return iat(i,e),i.toString=function(){return"[class dragonBones.BoneData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.inheritTranslation=!1,this.inheritRotation=!1,this.inheritScale=!1,this.inheritReflection=!1,this.type=0,this.length=0,this.name="",this.transform.identity(),this.userData=null,this.parent=null},i}(t.BaseObject);t.BoneData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.SurfaceData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1,this.segmentX=0,this.segmentY=0,this.vertices.length=0},e}(i);t.SurfaceData=n;var s=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t.color=null,t.userData=null,t}return iat(i,e),i.createColor=function(){return new t.ColorTransform},i.toString=function(){return"[class dragonBones.SlotData]"},i.prototype._onClear=function(){null!==this.userData&&this.userData.returnToPool(),this.blendMode=0,this.displayIndex=0,this.zOrder=0,this.name="",this.color=null,this.userData=null,this.parent=null},i.DEFAULT_COLOR=new t.ColorTransform,i}(t.BaseObject);t.SlotData=s}(nat||(nat={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){this.order=0,this.name="",this.type=0,this.target=null,this.root=null,this.bone=null},e}(t.BaseObject);t.ConstraintData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.IKConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.scaleEnabled=!1,this.bendPositive=!1,this.weight=1},e}(e);t.IKConstraintData=i;var n=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.PathConstraintData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.pathSlot=null,this.pathDisplayData=null,this.bones.length=0,this.positionMode=0,this.spacingMode=1,this.rotateMode=1,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=0,this.translateMix=0},e.prototype.AddBone=function(t){this.bones.push(t)},e}(e);t.PathConstraintData=n}(nat||(nat={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.CanvasData]"},e.prototype._onClear=function(){this.hasBackground=!1,this.color=0,this.x=0,this.y=0,this.width=0,this.height=0},e}(t.BaseObject);t.CanvasData=e}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.displays={},e}return iat(e,t),e.toString=function(){return"[class dragonBones.SkinData]"},e.prototype._onClear=function(){for(var t in this.displays){for(var e=0,i=this.displays[t];e<i.length;e++){var n=i[e];null!==n&&n.returnToPool()}delete this.displays[t]}this.name="",this.parent=null},e.prototype.addDisplay=function(t,e){t in this.displays||(this.displays[t]=[]),null!==e&&(e.parent=this),this.displays[t].push(e)},e.prototype.getDisplay=function(t,e){var i=this.getDisplays(t);if(null!==i)for(var n=0,s=i;n<s.length;n++){var r=s[n];if(null!==r&&r.name===e)return r}return null},e.prototype.getDisplays=function(t){return t in this.displays?this.displays[t]:null},e}(t.BaseObject);t.SkinData=e}(nat||(nat={})),function(t){var e=function(){function t(){this.weight=null}return t.prototype.clear=function(){this.isShared||null===this.weight||this.weight.returnToPool(),this.isShared=!1,this.inheritDeform=!1,this.offset=0,this.data=null,this.weight=null},t.prototype.shareFrom=function(t){this.isShared=!0,this.offset=t.offset,this.weight=t.weight},t}();t.VerticesData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.transform=new t.Transform,i}return iat(i,e),i.prototype._onClear=function(){this.name="",this.path="",this.transform.identity(),this.parent=null},i}(t.BaseObject);t.DisplayData=i;var n=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.pivot=new t.Point,i}return iat(i,e),i.toString=function(){return"[class dragonBones.ImageDisplayData]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.type=0,this.pivot.clear(),this.texture=null},i}(i);t.ImageDisplayData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.actions=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.ArmatureDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this);for(var e=0,i=this.actions;e<i.length;e++)i[e].returnToPool();this.type=1,this.inheritAnimation=!1,this.actions.length=0,this.armature=null},e.prototype.addAction=function(t){this.actions.push(t)},e}(i);t.ArmatureDisplayData=s;var r=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i}return iat(i,t),i.toString=function(){return"[class dragonBones.MeshDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.vertices.clear(),this.texture=null},i}(i);t.MeshDisplayData=r;var o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boundingBox=null,e}return iat(e,t),e.toString=function(){return"[class dragonBones.BoundingBoxDisplayData]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),null!==this.boundingBox&&this.boundingBox.returnToPool(),this.type=3,this.boundingBox=null},e}(i);t.BoundingBoxDisplayData=o;var a=function(t){function i(){var i=null!==t&&t.apply(this,arguments)||this;return i.vertices=new e,i.curveLengths=[],i}return iat(i,t),i.toString=function(){return"[class dragonBones.PathDisplayData]"},i.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=4,this.closed=!1,this.constantSpeed=!1,this.vertices.clear(),this.curveLengths.length=0},i}(i);t.PathDisplayData=a;var l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.bones=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.WeightData]"},e.prototype._onClear=function(){this.count=0,this.offset=0,this.bones.length=0},e.prototype.addBone=function(t){this.bones.push(t)},e}(t.BaseObject);t.WeightData=l}(nat||(nat={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){this.color=0,this.width=0,this.height=0},e}(t.BaseObject);t.BoundingBoxData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.RectangleBoundingBoxData]"},e._computeOutCode=function(t,e,i,n,s,r){var o=0;return t<i?o|=1:t>s&&(o|=2),e<n?o|=4:e>r&&(o|=8),o},e.rectangleIntersectsSegment=function(t,i,n,s,r,o,a,l,c,h,_){void 0===c&&(c=null),void 0===h&&(h=null),void 0===_&&(_=null);var u=t>r&&t<a&&i>o&&i<l,m=n>r&&n<a&&s>o&&s<l;if(u&&m)return-1;for(var p=0,d=e._computeOutCode(t,i,r,o,a,l),f=e._computeOutCode(n,s,r,o,a,l);;){if(0==(d|f)){p=2;break}if(0!=(d&f))break;var g=0,y=0,v=0,x=0!==d?d:f;0!=(4&x)?(g=t+(n-t)*(o-i)/(s-i),y=o,null!==_&&(v=.5*-Math.PI)):0!=(8&x)?(g=t+(n-t)*(l-i)/(s-i),y=l,null!==_&&(v=.5*Math.PI)):0!=(2&x)?(y=i+(s-i)*(a-t)/(n-t),g=a,null!==_&&(v=0)):0!=(1&x)&&(y=i+(s-i)*(r-t)/(n-t),g=r,null!==_&&(v=Math.PI)),x===d?(t=g,i=y,d=e._computeOutCode(t,i,r,o,a,l),null!==_&&(_.x=v)):(n=g,s=y,f=e._computeOutCode(n,s,r,o,a,l),null!==_&&(_.y=v))}return p&&(u?(p=2,null!==c&&(c.x=n,c.y=s),null!==h&&(h.x=n,h.y=n),null!==_&&(_.x=_.y+Math.PI)):m?(p=1,null!==c&&(c.x=t,c.y=i),null!==h&&(h.x=t,h.y=i),null!==_&&(_.y=_.x+Math.PI)):(p=3,null!==c&&(c.x=t,c.y=i),null!==h&&(h.x=n,h.y=s))),p},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=0},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return!0}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null);var l=.5*this.width,c=.5*this.height;return e.rectangleIntersectsSegment(t,i,n,s,-l,-c,l,c,r,o,a)},e}(e);t.RectangleBoundingBoxData=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.EllipseData]"},e.ellipseIntersectsSegment=function(t,e,i,n,s,r,o,a,l,c,h){void 0===l&&(l=null),void 0===c&&(c=null),void 0===h&&(h=null);var _=o/a,u=_*_,m=i-t,p=(n*=_)-(e*=_),d=Math.sqrt(m*m+p*p),f=m/d,g=p/d,y=(s-t)*f+(r-e)*g,v=o*o,x=v-(t*t+e*e)+y*y,b=0;if(x>=0){var S=Math.sqrt(x),A=y-S,C=y+S,T=A<0?-1:A<=d?0:1,w=C<0?-1:C<=d?0:1,E=T*w;if(E<0)return-1;0===E&&(-1===T?(b=2,i=t+C*f,n=(e+C*g)/_,null!==l&&(l.x=i,l.y=n),null!==c&&(c.x=i,c.y=n),null!==h&&(h.x=Math.atan2(n/v*u,i/v),h.y=h.x+Math.PI)):1===w?(b=1,t+=A*f,e=(e+A*g)/_,null!==l&&(l.x=t,l.y=e),null!==c&&(c.x=t,c.y=e),null!==h&&(h.x=Math.atan2(e/v*u,t/v),h.y=h.x+Math.PI)):(b=3,null!==l&&(l.x=t+A*f,l.y=(e+A*g)/_,null!==h&&(h.x=Math.atan2(l.y/v*u,l.x/v))),null!==c&&(c.x=t+C*f,c.y=(e+C*g)/_,null!==h&&(h.y=Math.atan2(c.y/v*u,c.x/v)))))}return b},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=1},e.prototype.containsPoint=function(t,e){var i=.5*this.width;if(t>=-i&&t<=i){var n=.5*this.height;if(e>=-n&&e<=n)return e*=i/n,Math.sqrt(t*t+e*e)<=i}return!1},e.prototype.intersectsSegment=function(t,i,n,s,r,o,a){return void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),e.ellipseIntersectsSegment(t,i,n,s,0,0,.5*this.width,.5*this.height,r,o,a)},e}(e);t.EllipseBoundingBoxData=n;var s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.PolygonBoundingBoxData]"},e.polygonIntersectsSegment=function(t,e,i,n,s,r,o,a){void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),t===i&&(t=i+1e-6),e===n&&(e=n+1e-6);for(var l=s.length,c=t-i,h=e-n,_=t*n-e*i,u=0,m=s[l-2],p=s[l-1],d=0,f=0,g=0,y=0,v=0,x=0,b=0;b<l;b+=2){var S=s[b],A=s[b+1];m===S&&(m=S+1e-4),p===A&&(p=A+1e-4);var C=m-S,T=p-A,w=m*A-p*S,E=c*T-h*C,P=(_*C-c*w)/E;if((P>=m&&P<=S||P>=S&&P<=m)&&(0===c||P>=t&&P<=i||P>=i&&P<=t)){var D=(_*T-h*w)/E;if((D>=p&&D<=A||D>=A&&D<=p)&&(0===h||D>=e&&D<=n||D>=n&&D<=e)){if(null===o){g=P,y=D,v=P,x=D,u++,null!==a&&(a.x=Math.atan2(A-p,S-m)-.5*Math.PI,a.y=a.x);break}var I=P-t;I<0&&(I=-I),0===u?(d=I,f=I,g=P,y=D,v=P,x=D,null!==a&&(a.x=Math.atan2(A-p,S-m)-.5*Math.PI,a.y=a.x)):(I<d&&(d=I,g=P,y=D,null!==a&&(a.x=Math.atan2(A-p,S-m)-.5*Math.PI)),I>f&&(f=I,v=P,x=D,null!==a&&(a.y=Math.atan2(A-p,S-m)-.5*Math.PI))),u++}}m=S,p=A}return 1===u?(null!==r&&(r.x=g,r.y=y),null!==o&&(o.x=g,o.y=y),null!==a&&(a.y=a.x+Math.PI)):u>1&&(u++,null!==r&&(r.x=g,r.y=y),null!==o&&(o.x=v,o.y=x)),u},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.type=2,this.x=0,this.y=0,this.vertices.length=0},e.prototype.containsPoint=function(t,e){var i=!1;if(t>=this.x&&t<=this.width&&e>=this.y&&e<=this.height)for(var n=0,s=this.vertices.length,r=s-2;n<s;n+=2){var o=this.vertices[r+1],a=this.vertices[n+1];if(a<e&&o>=e||o<e&&a>=e){var l=this.vertices[r],c=this.vertices[n];(e-a)*(l-c)/(o-a)+c<t&&(i=!i)}r=n}return i},e.prototype.intersectsSegment=function(t,n,s,r,o,a,l){void 0===o&&(o=null),void 0===a&&(a=null),void 0===l&&(l=null);var c=0;return 0!==i.rectangleIntersectsSegment(t,n,s,r,this.x,this.y,this.x+this.width,this.y+this.height,null,null,null)&&(c=e.polygonIntersectsSegment(t,n,s,r,this.vertices,o,a,l)),c},e}(e);t.PolygonBoundingBoxData=s}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.cachedFrames=[],e.boneTimelines={},e.surfaceTimelines={},e.slotTimelines={},e.constraintTimelines={},e.animationTimelines={},e.boneCachedFrameIndices={},e.slotCachedFrameIndices={},e.actionTimeline=null,e.zOrderTimeline=null,e}return iat(e,t),e.toString=function(){return"[class dragonBones.AnimationData]"},e.prototype._onClear=function(){for(var t in this.boneTimelines){for(var e=0,i=this.boneTimelines[t];e<i.length;e++)i[e].returnToPool();delete this.boneTimelines[t]}for(var t in this.surfaceTimelines){for(var n=0,s=this.surfaceTimelines[t];n<s.length;n++)s[n].returnToPool();delete this.surfaceTimelines[t]}for(var t in this.slotTimelines){for(var r=0,o=this.slotTimelines[t];r<o.length;r++)o[r].returnToPool();delete this.slotTimelines[t]}for(var t in this.constraintTimelines){for(var a=0,l=this.constraintTimelines[t];a<l.length;a++)l[a].returnToPool();delete this.constraintTimelines[t]}for(var t in this.animationTimelines){for(var c=0,h=this.animationTimelines[t];c<h.length;c++)h[c].returnToPool();delete this.animationTimelines[t]}for(var t in this.boneCachedFrameIndices)delete this.boneCachedFrameIndices[t];for(var t in this.slotCachedFrameIndices)delete this.slotCachedFrameIndices[t];null!==this.actionTimeline&&this.actionTimeline.returnToPool(),null!==this.zOrderTimeline&&this.zOrderTimeline.returnToPool(),this.frameIntOffset=0,this.frameFloatOffset=0,this.frameOffset=0,this.frameCount=0,this.playTimes=0,this.duration=0,this.scale=1,this.fadeInTime=0,this.cacheFrameRate=0,this.name="",this.cachedFrames.length=0,this.actionTimeline=null,this.zOrderTimeline=null,this.parent=null},e.prototype.cacheFrames=function(t){if(!(this.cacheFrameRate>0)){this.cacheFrameRate=Math.max(Math.ceil(t*this.scale),1);var e=Math.ceil(this.cacheFrameRate*this.duration)+1;this.cachedFrames.length=e;for(var i=0,n=this.cacheFrames.length;i<n;++i)this.cachedFrames[i]=!1;for(var s=0,r=this.parent.sortedBones;s<r.length;s++){var o=r[s];for(i=0,n=(c=new Array(e)).length;i<n;++i)c[i]=-1;this.boneCachedFrameIndices[o.name]=c}for(var a=0,l=this.parent.sortedSlots;a<l.length;a++){var c,h=l[a];for(i=0,n=(c=new Array(e)).length;i<n;++i)c[i]=-1;this.slotCachedFrameIndices[h.name]=c}}},e.prototype.addBoneTimeline=function(t,e){var i=t.name in this.boneTimelines?this.boneTimelines[t.name]:this.boneTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSurfaceTimeline=function(t,e){var i=t.name in this.surfaceTimelines?this.surfaceTimelines[t.name]:this.surfaceTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addSlotTimeline=function(t,e){var i=t.name in this.slotTimelines?this.slotTimelines[t.name]:this.slotTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addConstraintTimeline=function(t,e){var i=t.name in this.constraintTimelines?this.constraintTimelines[t.name]:this.constraintTimelines[t.name]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.addAnimationTimeline=function(t,e){var i=t in this.animationTimelines?this.animationTimelines[t]:this.animationTimelines[t]=[];i.indexOf(e)<0&&i.push(e)},e.prototype.getBoneTimelines=function(t){return t in this.boneTimelines?this.boneTimelines[t]:null},e.prototype.getSurfaceTimelines=function(t){return t in this.surfaceTimelines?this.surfaceTimelines[t]:null},e.prototype.getSlotTimelines=function(t){return t in this.slotTimelines?this.slotTimelines[t]:null},e.prototype.getConstraintTimelines=function(t){return t in this.constraintTimelines?this.constraintTimelines[t]:null},e.prototype.getAnimationTimelines=function(t){return t in this.animationTimelines?this.animationTimelines[t]:null},e.prototype.getBoneCachedFrameIndices=function(t){return t in this.boneCachedFrameIndices?this.boneCachedFrameIndices[t]:null},e.prototype.getSlotCachedFrameIndices=function(t){return t in this.slotCachedFrameIndices?this.slotCachedFrameIndices[t]:null},e}(t.BaseObject);t.AnimationData=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.TimelineData]"},e.prototype._onClear=function(){this.type=10,this.offset=0,this.frameIndicesOffset=-1},e}(t.BaseObject);t.TimelineData=i}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.boneMask=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.AnimationConfig]"},e.prototype._onClear=function(){this.pauseFadeOut=!0,this.fadeOutMode=4,this.fadeOutTweenType=1,this.fadeOutTime=-1,this.actionEnabled=!0,this.additiveBlending=!1,this.displayControl=!0,this.pauseFadeIn=!0,this.resetToPose=!0,this.fadeInTweenType=1,this.playTimes=-1,this.layer=0,this.position=0,this.duration=-1,this.timeScale=-100,this.weight=1,this.fadeInTime=-1,this.autoFadeOutTime=-1,this.name="",this.animation="",this.group="",this.boneMask.length=0},e.prototype.clear=function(){this._onClear()},e.prototype.copyFrom=function(t){this.pauseFadeOut=t.pauseFadeOut,this.fadeOutMode=t.fadeOutMode,this.autoFadeOutTime=t.autoFadeOutTime,this.fadeOutTweenType=t.fadeOutTweenType,this.actionEnabled=t.actionEnabled,this.additiveBlending=t.additiveBlending,this.displayControl=t.displayControl,this.pauseFadeIn=t.pauseFadeIn,this.resetToPose=t.resetToPose,this.playTimes=t.playTimes,this.layer=t.layer,this.position=t.position,this.duration=t.duration,this.timeScale=t.timeScale,this.fadeInTime=t.fadeInTime,this.fadeOutTime=t.fadeOutTime,this.fadeInTweenType=t.fadeInTweenType,this.weight=t.weight,this.name=t.name,this.animation=t.animation,this.group=t.group,this.boneMask.length=t.boneMask.length;for(var e=0,i=this.boneMask.length;e<i;++e)this.boneMask[e]=t.boneMask[e]},e.prototype.containsBoneMask=function(t){return 0===this.boneMask.length||this.boneMask.indexOf(t)>=0},e.prototype.addBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=t.getBone(e);if(null!==n&&(this.boneMask.indexOf(e)<0&&this.boneMask.push(e),i))for(var s=0,r=t.getBones();s<r.length;s++){var o=r[s];this.boneMask.indexOf(o.name)<0&&n.contains(o)&&this.boneMask.push(o.name)}},e.prototype.removeBoneMask=function(t,e,i){void 0===i&&(i=!0);var n=this.boneMask.indexOf(e);if(n>=0&&this.boneMask.splice(n,1),i){var s=t.getBone(e);if(null!==s)if(this.boneMask.length>0)for(var r=0,o=t.getBones();r<o.length;r++){var a=o[r],l=this.boneMask.indexOf(a.name);l>=0&&s.contains(a)&&this.boneMask.splice(l,1)}else for(var c=0,h=t.getBones();c<h.length;c++)(a=h[c])!==s&&(s.contains(a)||this.boneMask.push(a.name))}},e}(t.BaseObject);t.AnimationConfig=e}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.textures={},e}return iat(e,t),e.prototype._onClear=function(){for(var t in this.textures)this.textures[t].returnToPool(),delete this.textures[t];this.autoSearch=!1,this.width=0,this.height=0,this.scale=1,this.name="",this.imagePath=""},e.prototype.copyFrom=function(t){for(var e in this.autoSearch=t.autoSearch,this.scale=t.scale,this.width=t.width,this.height=t.height,this.name=t.name,this.imagePath=t.imagePath,this.textures)this.textures[e].returnToPool(),delete this.textures[e];for(var e in t.textures){var i=this.createTexture();i.copyFrom(t.textures[e]),this.textures[e]=i}},e.prototype.addTexture=function(t){t.name in this.textures?console.warn("Same texture: "+t.name):(t.parent=this,this.textures[t.name]=t)},e.prototype.getTexture=function(t){return t in this.textures?this.textures[t]:null},e}(t.BaseObject);t.TextureAtlasData=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.region=new t.Rectangle,i.frame=null,i}return iat(i,e),i.createRectangle=function(){return new t.Rectangle},i.prototype._onClear=function(){this.rotated=!1,this.name="",this.region.clear(),this.parent=null,this.frame=null},i.prototype.copyFrom=function(t){this.rotated=t.rotated,this.name=t.name,this.region.copyFrom(t.region),this.parent=t.parent,null===this.frame&&null!==t.frame?this.frame=i.createRectangle():null!==this.frame&&null===t.frame&&(this.frame=null),null!==this.frame&&null!==t.frame&&this.frame.copyFrom(t.frame)},i}(t.BaseObject);t.TextureData=i}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.vertices=[],e.bones=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.DeformVertices]"},e.prototype._onClear=function(){this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.init=function(t,e){if(this.verticesData=t,null!==this.verticesData){var i;i=null!==this.verticesData.weight?2*this.verticesData.weight.count:2*this.verticesData.data.intArray[this.verticesData.offset+0],this.verticesDirty=!0,this.vertices.length=i,this.bones.length=0;for(var n=0,s=this.vertices.length;n<s;++n)this.vertices[n]=0;if(null!==this.verticesData.weight)for(n=0,s=this.verticesData.weight.bones.length;n<s;++n){var r=e.getBone(this.verticesData.weight.bones[n].name);this.bones.push(r)}}else this.verticesDirty=!1,this.vertices.length=0,this.bones.length=0,this.verticesData=null},e.prototype.isBonesUpdate=function(){for(var t=0,e=this.bones;t<e.length;t++){var i=e[t];if(null!==i&&i._childrenTransformDirty)return!0}return!1},e}(t.BaseObject);t.DeformVertices=e}(nat||(nat={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._slots=[],t._constraints=[],t._actions=[],t._animation=null,t._proxy=null,t._replaceTextureAtlasData=null,t._clock=null,t}return iat(i,e),i.toString=function(){return"[class dragonBones.Armature]"},i._onSortSlots=function(t,e){return t._zOrder>e._zOrder?1:-1},i.prototype._onClear=function(){null!==this._clock&&this._clock.remove(this);for(var t=0,e=this._bones;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._slots;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._constraints;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._actions;o<a.length;o++)a[o].returnToPool();null!==this._animation&&this._animation.returnToPool(),null!==this._proxy&&this._proxy.dbClear(),null!==this._replaceTextureAtlasData&&this._replaceTextureAtlasData.returnToPool(),this.inheritAnimation=!0,this.userData=null,this._lockUpdate=!1,this._slotsDirty=!0,this._zOrderDirty=!1,this._flipX=!1,this._flipY=!1,this._cacheFrameIndex=-1,this._bones.length=0,this._slots.length=0,this._constraints.length=0,this._actions.length=0,this._armatureData=null,this._animation=null,this._proxy=null,this._display=null,this._replaceTextureAtlasData=null,this._replacedTexture=null,this._dragonBones=null,this._clock=null,this._parent=null},i.prototype._sortZOrder=function(t,e){var i=this._armatureData.sortedSlots,n=null===t;if(this._zOrderDirty||!n){for(var s=0,r=i.length;s<r;++s){var o=n?s:t[e+s];if(!(o<0||o>=r)){var a=i[o],l=this.getSlot(a.name);null!==l&&l._setZorder(s)}}this._slotsDirty=!0,this._zOrderDirty=!n}},i.prototype._addBone=function(t){this._bones.indexOf(t)<0&&this._bones.push(t)},i.prototype._addSlot=function(t){this._slots.indexOf(t)<0&&this._slots.push(t)},i.prototype._addConstraint=function(t){this._constraints.indexOf(t)<0&&this._constraints.push(t)},i.prototype._bufferAction=function(t,e){this._actions.indexOf(t)<0&&(e?this._actions.push(t):this._actions.unshift(t))},i.prototype.dispose=function(){null!==this._armatureData&&(this._lockUpdate=!0,this._dragonBones.bufferObject(this))},i.prototype.init=function(e,i,n,s){null===this._armatureData&&(this._armatureData=e,this._animation=t.BaseObject.borrowObject(t.Animation),this._proxy=i,this._display=n,this._dragonBones=s,this._proxy.dbInit(this),this._animation.init(this),this._animation.animations=this._armatureData.animations)},i.prototype.advanceTime=function(t){if(!this._lockUpdate)if(null!==this._armatureData)if(null!==this._armatureData.parent){var e=this._cacheFrameIndex;if(this._animation.advanceTime(t),this._slotsDirty&&(this._slotsDirty=!1,this._slots.sort(i._onSortSlots)),this._cacheFrameIndex<0||this._cacheFrameIndex!==e){var n=0,s=0;for(n=0,s=this._bones.length;n<s;++n)this._bones[n].update(this._cacheFrameIndex);for(n=0,s=this._slots.length;n<s;++n)this._slots[n].update(this._cacheFrameIndex)}if(this._actions.length>0){this._lockUpdate=!0;for(var r=0,o=this._actions;r<o.length;r++){var a=o[r],l=a.actionData;if(null!==l&&0===l.type)if(null!==a.slot)null!==(_=a.slot.childArmature)&&_.animation.fadeIn(l.name);else if(null!==a.bone)for(var c=0,h=this.getSlots();c<h.length;c++){var _,u=h[c];u.parent===a.bone&&null!==(_=u.childArmature)&&_.animation.fadeIn(l.name)}else this._animation.fadeIn(l.name);a.returnToPool()}this._actions.length=0,this._lockUpdate=!1}this._proxy.dbUpdate()}else console.warn("The armature data has been disposed.\nPlease make sure dispose armature before call factory.clear().");else console.warn("The armature has been disposed.")},i.prototype.invalidUpdate=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=!1),null!==t&&t.length>0){if(null!==(o=this.getBone(t))&&(o.invalidUpdate(),e))for(var i=0,n=this._slots;i<n.length;i++)(c=n[i]).parent===o&&c.invalidUpdate()}else{for(var s=0,r=this._bones;s<r.length;s++){var o;(o=r[s]).invalidUpdate()}if(e)for(var a=0,l=this._slots;a<l.length;a++){var c;(c=l[a]).invalidUpdate()}}},i.prototype.containsPoint=function(t,e){for(var i=0,n=this._slots;i<n.length;i++){var s=n[i];if(s.containsPoint(t,e))return s}return null},i.prototype.intersectsSegment=function(t,e,i,n,s,r,o){void 0===s&&(s=null),void 0===r&&(r=null),void 0===o&&(o=null);for(var a=t===i,l=0,c=0,h=0,_=0,u=0,m=0,p=0,d=0,f=null,g=null,y=0,v=this._slots;y<v.length;y++){var x=v[y];if(x.intersectsSegment(t,e,i,n,s,r,o)>0){if(null===s&&null===r){f=x;break}var b;null!==s&&((b=a?s.y-e:s.x-t)<0&&(b=-b),(null===f||b<l)&&(l=b,h=s.x,_=s.y,f=x,o&&(p=o.x))),null!==r&&((b=r.x-t)<0&&(b=-b),(null===g||b>c)&&(c=b,u=r.x,m=r.y,g=x,null!==o&&(d=o.y)))}}return null!==f&&null!==s&&(s.x=h,s.y=_,null!==o&&(o.x=p)),null!==g&&null!==r&&(r.x=u,r.y=m,null!==o&&(o.y=d)),f},i.prototype.getBone=function(t){for(var e=0,i=this._bones;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getBoneByDisplay=function(t){var e=this.getSlotByDisplay(t);return null!==e?e.parent:null},i.prototype.getSlot=function(t){for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.name===t)return n}return null},i.prototype.getSlotByDisplay=function(t){if(null!==t)for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];if(n.display===t)return n}return null},i.prototype.getBones=function(){return this._bones},i.prototype.getSlots=function(){return this._slots},Object.defineProperty(i.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this.invalidUpdate())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cacheFrameRate",{get:function(){return this._armatureData.cacheFrameRate},set:function(t){if(this._armatureData.cacheFrameRate!==t){this._armatureData.cacheFrames(t);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.cacheFrameRate=t)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._armatureData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"armatureData",{get:function(){return this._armatureData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animation",{get:function(){return this._animation},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"proxy",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"eventDispatcher",{get:function(){return this._proxy},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"replacedTexture",{get:function(){return this._replacedTexture},set:function(t){if(this._replacedTexture!==t){null!==this._replaceTextureAtlasData&&(this._replaceTextureAtlasData.returnToPool(),this._replaceTextureAtlasData=null),this._replacedTexture=t;for(var e=0,i=this._slots;e<i.length;e++){var n=i[e];n.invalidUpdate(),n.update(-1)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"clock",{get:function(){return this._clock},set:function(t){if(this._clock!==t){null!==this._clock&&this._clock.remove(this),this._clock=t,this._clock&&this._clock.add(this);for(var e=0,i=this._slots;e<i.length;e++){var n=i[e].childArmature;null!==n&&(n.clock=this._clock)}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.replaceTexture=function(t){this.replacedTexture=t},i.prototype.hasEventListener=function(t){return this._proxy.hasDBEventListener(t)},i.prototype.addEventListener=function(t,e,i){this._proxy.addDBEventListener(t,e,i)},i.prototype.removeEventListener=function(t,e,i){this._proxy.removeDBEventListener(t,e,i)},i.prototype.enableAnimationCache=function(t){console.warn("Deprecated."),this.cacheFrameRate=t},i.prototype.getDisplay=function(){return this._display},i}(t.BaseObject);t.Armature=e}(nat||(nat={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.globalTransformMatrix=new t.Matrix,i.global=new t.Transform,i.offset=new t.Transform,i}return iat(i,e),i.prototype._onClear=function(){this.globalTransformMatrix.identity(),this.global.identity(),this.offset.identity(),this.origin=null,this.userData=null,this._globalDirty=!1,this._armature=null},i.prototype.updateGlobalTransform=function(){this._globalDirty&&(this._globalDirty=!1,this.global.fromMatrix(this.globalTransformMatrix))},Object.defineProperty(i.prototype,"armature",{get:function(){return this._armature},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.TransformObject=e}(nat||(nat={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.animationPose=new t.Transform,i._blendState=new t.BlendState,i}return iat(i,e),i.toString=function(){return"[class dragonBones.Bone]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.offsetMode=1,this.animationPose.identity(),this._transformDirty=!1,this._childrenTransformDirty=!1,this._localDirty=!0,this._hasConstraint=!1,this._visible=!0,this._cachedFrameIndex=-1,this._blendState.clear(),this._boneData=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._updateGlobalTransformMatrix=function(e){var i=this._boneData,n=this.global,s=this.globalTransformMatrix,r=this.origin,o=this.offset,a=this.animationPose,l=this._parent,c=this._armature.flipX,h=this._armature.flipY===t.DragonBones.yDown,_=null!==l,u=0;if(1===this.offsetMode?null!==r?(n.x=r.x+o.x+a.x,n.scaleX=r.scaleX*o.scaleX*a.scaleX,n.scaleY=r.scaleY*o.scaleY*a.scaleY,t.DragonBones.yDown?(n.y=r.y+o.y+a.y,n.skew=r.skew+o.skew+a.skew,n.rotation=r.rotation+o.rotation+a.rotation):(n.y=r.y-o.y+a.y,n.skew=r.skew-o.skew+a.skew,n.rotation=r.rotation-o.rotation+a.rotation)):(n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation),n.add(a)):0===this.offsetMode?null!==r?n.copyFrom(r).add(a):n.copyFrom(a):(_=!1,n.copyFrom(o),t.DragonBones.yDown||(n.y=-n.y,n.skew=-n.skew,n.rotation=-n.rotation)),_){var m=0===l._boneData.type?l.globalTransformMatrix:l._getGlobalTransformMatrix(n.x,n.y);if(i.inheritScale)i.inheritRotation||(l.updateGlobalTransform(),u=c&&h?n.rotation-(l.global.rotation+Math.PI):c?n.rotation+l.global.rotation+Math.PI:h?n.rotation+l.global.rotation:n.rotation-l.global.rotation,n.rotation=u),n.toMatrix(s),s.concat(m),i.inheritTranslation?(n.x=s.tx,n.y=s.ty):(s.tx=n.x,s.ty=n.y),e?n.fromMatrix(s):this._globalDirty=!0;else{if(i.inheritTranslation){var p=n.x,d=n.y;n.x=m.a*p+m.c*d+m.tx,n.y=m.b*p+m.d*d+m.ty}else c&&(n.x=-n.x),h&&(n.y=-n.y);i.inheritRotation?(l.updateGlobalTransform(),u=l.global.scaleX<0?n.rotation+l.global.rotation+Math.PI:n.rotation+l.global.rotation,m.a*m.d-m.b*m.c<0&&(u-=2*n.rotation,(c!==h||i.inheritReflection)&&(n.skew+=Math.PI),t.DragonBones.yDown||(n.skew=-n.skew)),n.rotation=u):(c||h)&&(c&&h?u=n.rotation+Math.PI:(u=c?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)}}else(c||h)&&(c&&(n.x=-n.x),h&&(n.y=-n.y),c&&h?u=n.rotation+Math.PI:(u=c?Math.PI-n.rotation:-n.rotation,n.skew+=Math.PI),n.rotation=u),n.toMatrix(s)},i.prototype.init=function(t,e){null===this._boneData&&(this._boneData=t,this._armature=e,null!==this._boneData.parent&&(this._parent=this._armature.getBone(this._boneData.parent.name)),this._armature._addBone(this),this.origin=this._boneData.transform)},i.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];if(e>=0&&this._cachedFrameIndex===e)this._transformDirty=!1;else if(e>=0)this._transformDirty=!0,this._cachedFrameIndex=e;else{if(this._hasConstraint)for(var i=0,n=this._armature._constraints;i<n.length;i++)(o=n[i])._root===this&&o.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var s=0,r=this._armature._constraints;s<r.length;s++){var o;(o=r[s])._root===this&&o.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty)if(this._transformDirty=!1,this._childrenTransformDirty=!0,this._cachedFrameIndex<0){var a=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(a),a&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},i.prototype.updateByConstraint=function(){this._localDirty&&(this._localDirty=!1,(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&this._updateGlobalTransformMatrix(!0),this._transformDirty=!0)},i.prototype.invalidUpdate=function(){this._transformDirty=!0},i.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.parent;return e===this},Object.defineProperty(i.prototype,"boneData",{get:function(){return this._boneData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){if(this._visible!==t){this._visible=t;for(var e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&n._updateVisible()}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._boneData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getBones=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getBones();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},i.prototype.getSlots=function(){console.warn("Deprecated.");for(var t=new Array,e=0,i=this._armature.getSlots();e<i.length;e++){var n=i[e];n.parent===this&&t.push(n)}return t},Object.defineProperty(i.prototype,"slot",{get:function(){console.warn("Deprecated.");for(var t=0,e=this._armature.getSlots();t<e.length;t++){var i=e[t];if(i.parent===this)return i}return null},enumerable:!0,configurable:!0}),i}(t.TransformObject);t.Bone=e}(nat||(nat={})),function(t){var e=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._vertices=[],e._deformVertices=[],e._hullCache=[],e._matrixCahce=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.Surface]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dX=0,this._dY=0,this._k=0,this._kX=0,this._kY=0,this._vertices.length=0,this._deformVertices.length=0,this._matrixCahce.length=0,this._hullCache.length=0},e.prototype._getAffineTransform=function(t,e,i,n,s,r,o,a,l,c,h,_,u){var m=o-s,p=a-r,d=l-s,f=c-r;h.rotation=Math.atan2(p,m),h.skew=Math.atan2(f,d)-.5*Math.PI-h.rotation,u&&(h.rotation+=Math.PI),h.scaleX=Math.sqrt(m*m+p*p)/i,h.scaleY=Math.sqrt(d*d+f*f)/n,h.toMatrix(_),h.x=_.tx=s-(_.a*t+_.c*e),h.y=_.ty=r-(_.b*t+_.d*e)},e.prototype._updateVertices=function(){var t=this._boneData.vertices,e=this._vertices,i=this._deformVertices;if(null!==this._parent)if(1===this._parent._boneData.type)for(var n=0,s=t.length;n<s;n+=2){var r=t[n]+i[n],o=t[n+1]+i[n],a=this._parent._getGlobalTransformMatrix(r,o);e[n]=a.a*r+a.c*o+a.tx,e[n+1]=a.b*r+a.d*o+a.ty}else{var l=this._parent.globalTransformMatrix;for(n=0,s=t.length;n<s;n+=2)r=t[n]+i[n],o=t[n+1]+i[n+1],e[n]=l.a*r+l.c*o+l.tx,e[n+1]=l.b*r+l.d*o+l.ty}else for(n=0,s=t.length;n<s;n+=2)e[n]=t[n]+i[n],e[n+1]=t[n+1]+i[n+1]},e.prototype._updateGlobalTransformMatrix=function(){var t=2*this._boneData.segmentX,e=this._vertices.length-2,i=this._vertices[0],n=this._vertices[1],s=this._vertices[t],r=this._vertices[t+1],o=this._vertices[e],a=this._vertices[e+1],l=this._vertices[e-t],c=this._vertices[e-t+1],h=i+.5*(o-i),_=n+.5*(a-n),u=h+.5*(s+.5*(l-s)-h),m=_+.5*(r+.5*(c-r)-_),p=s+.5*(o-s),d=r+.5*(a-r),f=l+.5*(o-l),g=c+.5*(a-c);this._globalDirty=!1,this._getAffineTransform(0,0,200,200,u,m,p,d,f,g,this.global,this.globalTransformMatrix,!1)},e.prototype._getGlobalTransformMatrix=function(t,i){var n=1e3;if(t<-n||n<t||i<-n||n<i)return this.globalTransformMatrix;var s=!1,r=200,o=this._boneData,a=o.segmentX,l=o.segmentY,c=2*o.segmentX,h=this._dX,_=this._dY,u=Math.floor((t+r)/h),m=Math.floor((i+r)/_),p=0,d=u*h-r,f=m*_-r,g=this._matrixCahce,y=e._helpMatrix;if(t<-r){if(i<-r||i>=r)return this.globalTransformMatrix;if(p=7*(2*(a*(l+1)+2*a+l+m)+((s=i>this._kX*(t+r)+f)?1:0)),this._matrixCahce[p]>0)y.copyFromArray(g,p+1);else{var v=m*(c+2),x=this._hullCache[4],b=this._hullCache[5],S=this._hullCache[2]-(l-m)*x,A=this._hullCache[3]-(l-m)*b,C=this._vertices;s?this._getAffineTransform(-r,f+_,800,_,C[v+c+2],C[v+c+3],S+x,A+b,C[v],C[v+1],e._helpTransform,y,!0):this._getAffineTransform(-n,f,800,_,S,A,C[v],C[v+1],S+x,A+b,e._helpTransform,y,!1),g[p]=1,g[p+1]=y.a,g[p+2]=y.b,g[p+3]=y.c,g[p+4]=y.d,g[p+5]=y.tx,g[p+6]=y.ty}}else if(t>=r){if(i<-r||i>=r)return this.globalTransformMatrix;p=7*(2*(a*(l+1)+a+m)+((s=i>this._kX*(t-n)+f)?1:0)),this._matrixCahce[p]>0?y.copyFromArray(g,p+1):(v=(m+1)*(c+2)-2,x=this._hullCache[4],b=this._hullCache[5],S=this._hullCache[0]+m*x,A=this._hullCache[1]+m*b,C=this._vertices,s?this._getAffineTransform(n,f+_,800,_,S+x,A+b,C[v+c+2],C[v+c+3],S,A,e._helpTransform,y,!0):this._getAffineTransform(r,f,800,_,C[v],C[v+1],S,A,C[v+c+2],C[v+c+3],e._helpTransform,y,!1),g[p]=1,g[p+1]=y.a,g[p+2]=y.b,g[p+3]=y.c,g[p+4]=y.d,g[p+5]=y.tx,g[p+6]=y.ty)}else if(i<-r){if(t<-r||t>=r)return this.globalTransformMatrix;p=7*(a*(l+1)+2*u+((s=i>this._kY*(t-d-h)-n)?1:0)),this._matrixCahce[p]>0?y.copyFromArray(g,p+1):(v=2*u,x=this._hullCache[10],b=this._hullCache[11],S=this._hullCache[8]+u*x,A=this._hullCache[9]+u*b,C=this._vertices,s?this._getAffineTransform(d+h,-r,h,800,C[v+2],C[v+3],C[v],C[v+1],S+x,A+b,e._helpTransform,y,!0):this._getAffineTransform(d,-n,h,800,S,A,S+x,A+b,C[v],C[v+1],e._helpTransform,y,!1),g[p]=1,g[p+1]=y.a,g[p+2]=y.b,g[p+3]=y.c,g[p+4]=y.d,g[p+5]=y.tx,g[p+6]=y.ty)}else if(i>=r){if(t<-r||t>=r)return this.globalTransformMatrix;p=7*(2*(a*(l+1)+a+l+m)+((s=i>this._kY*(t-d-h)+r)?1:0)),this._matrixCahce[p]>0?y.copyFromArray(g,p+1):(v=l*(c+2)+2*u,x=this._hullCache[10],b=this._hullCache[11],S=this._hullCache[6]-(a-u)*x,A=this._hullCache[7]-(a-u)*b,C=this._vertices,s?this._getAffineTransform(d+h,n,h,800,S+x,A+b,S,A,C[v+2],C[v+3],e._helpTransform,y,!0):this._getAffineTransform(d,r,h,800,C[v],C[v+1],C[v+2],C[v+3],S,A,e._helpTransform,y,!1),g[p]=1,g[p+1]=y.a,g[p+2]=y.b,g[p+3]=y.c,g[p+4]=y.d,g[p+5]=y.tx,g[p+6]=y.ty)}else p=7*(2*(a*m+u)+((s=i>this._k*(t-d-h)+f)?1:0)),this._matrixCahce[p]>0?y.copyFromArray(g,p+1):(v=2*u+m*(c+2),C=this._vertices,s?this._getAffineTransform(d+h,f+_,h,_,C[v+c+4],C[v+c+5],C[v+c+2],C[v+c+3],C[v+2],C[v+3],e._helpTransform,y,!0):this._getAffineTransform(d,f,h,_,C[v],C[v+1],C[v+2],C[v+3],C[v+c+2],C[v+c+3],e._helpTransform,y,!1),g[p]=1,g[p+1]=y.a,g[p+2]=y.b,g[p+3]=y.c,g[p+4]=y.d,g[p+5]=y.tx,g[p+6]=y.ty);return y},e.prototype.init=function(e,i){if(null===this._boneData){t.prototype.init.call(this,e,i);var n=e.segmentX,s=e.segmentY,r=e.vertices.length;this._dX=400/n,this._dY=400/s,this._k=-this._dY/this._dX,this._kX=-this._dY/800,this._kY=-800/this._dX,this._vertices.length=r,this._deformVertices.length=r,this._matrixCahce.length=14*(n*s+2*n+2*s),this._hullCache.length=10;for(var o=0;o<r;++o)this._deformVertices[o]=0}},e.prototype.update=function(t){if(this._blendState.dirty=!1,t>=0&&null!==this._cachedFrameIndices){var i=this._cachedFrameIndices[t];if(i>=0&&this._cachedFrameIndex===i)this._transformDirty=!1;else if(i>=0)this._transformDirty=!0,this._cachedFrameIndex=i;else{if(this._hasConstraint)for(var n=0,s=this._armature._constraints;n<s.length;n++)(a=s[n])._root===this&&a.update();this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}}else{if(this._hasConstraint)for(var r=0,o=this._armature._constraints;r<o.length;r++){var a;(a=o[r])._root===this&&a.update()}(this._transformDirty||null!==this._parent&&this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1)}if(this._transformDirty){this._transformDirty=!1,this._childrenTransformDirty=!0;for(var l=0,c=this._matrixCahce.length;l<c;l+=7)this._matrixCahce[l]=-1;if(this._updateVertices(),this._cachedFrameIndex<0){var h=t>=0;this._localDirty&&this._updateGlobalTransformMatrix(h),h&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);var _=2*this.global.x,u=2*this.global.y,m=e._helpPoint;this.globalTransformMatrix.transformPoint(1e3,-200,m),this._hullCache[0]=m.x,this._hullCache[1]=m.y,this._hullCache[2]=_-m.x,this._hullCache[3]=u-m.y,this.globalTransformMatrix.transformPoint(0,this._dY,m,!0),this._hullCache[4]=m.x,this._hullCache[5]=m.y,this.globalTransformMatrix.transformPoint(200,1e3,m),this._hullCache[6]=m.x,this._hullCache[7]=m.y,this._hullCache[8]=_-m.x,this._hullCache[9]=u-m.y,this.globalTransformMatrix.transformPoint(this._dX,0,m,!0),this._hullCache[10]=m.x,this._hullCache[11]=m.y}else this._childrenTransformDirty&&(this._childrenTransformDirty=!1);this._localDirty=!0},e}(t.Bone);t.Surface=e}(nat||(nat={})),function(t){var e=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i._localMatrix=new t.Matrix,i._colorTransform=new t.ColorTransform,i._displayDatas=[],i._displayList=[],i._deformVertices=null,i._rawDisplay=null,i._meshDisplay=null,i}return iat(i,e),i.prototype._onClear=function(){e.prototype._onClear.call(this);for(var i=[],n=0,s=this._displayList;n<s.length;n++)null!==(a=s[n])&&a!==this._rawDisplay&&a!==this._meshDisplay&&i.indexOf(a)<0&&i.push(a);for(var r=0,o=i;r<o.length;r++){var a;(a=o[r])instanceof t.Armature?a.dispose():this._disposeDisplay(a,!0)}null!==this._deformVertices&&this._deformVertices.returnToPool(),null!==this._meshDisplay&&this._meshDisplay!==this._rawDisplay&&this._disposeDisplay(this._meshDisplay,!1),null!==this._rawDisplay&&this._disposeDisplay(this._rawDisplay,!1),this.displayController=null,this._displayDirty=!1,this._zOrderDirty=!1,this._blendModeDirty=!1,this._colorDirty=!1,this._transformDirty=!1,this._visible=!0,this._blendMode=0,this._displayIndex=-1,this._animationDisplayIndex=-1,this._zOrder=0,this._cachedFrameIndex=-1,this._pivotX=0,this._pivotY=0,this._localMatrix.identity(),this._colorTransform.identity(),this._displayList.length=0,this._displayDatas.length=0,this._slotData=null,this._rawDisplayDatas=null,this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._deformVertices=null,this._rawDisplay=null,this._meshDisplay=null,this._display=null,this._childArmature=null,this._parent=null,this._cachedFrameIndices=null},i.prototype._getDefaultRawDisplayData=function(t){var e=this._armature._armatureData.defaultSkin;if(null!==e){var i=e.getDisplays(this._slotData.name);if(null!==i)return t<i.length?i[t]:null}return null},i.prototype._updateDisplayData=function(){var e=this._displayData,n=null!==this._deformVertices?this._deformVertices.verticesData:null,s=this._textureData,r=null,o=null;if(this._displayData=null,this._boundingBoxData=null,this._textureData=null,this._displayIndex>=0&&(null!==this._rawDisplayDatas&&(r=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null),null===r&&(r=this._getDefaultRawDisplayData(this._displayIndex)),this._displayIndex<this._displayDatas.length&&(this._displayData=this._displayDatas[this._displayIndex])),null!==this._displayData&&(2===this._displayData.type||4===this._displayData.type?o=this._displayData.vertices:null!==r&&(2===r.type||4===r.type)&&(o=r.vertices),3===this._displayData.type?this._boundingBoxData=this._displayData.boundingBox:null!==r&&3===r.type&&(this._boundingBoxData=r.boundingBox),(0===this._displayData.type||2===this._displayData.type)&&(this._textureData=this._displayData.texture)),this._displayData!==e||o!==n||this._textureData!==s){if(null===o&&null!==this._textureData){var a=this._displayData,l=this._textureData.parent.scale*this._armature._armatureData.scale,c=this._textureData.frame;this._pivotX=a.pivot.x,this._pivotY=a.pivot.y;var h=null!==c?c:this._textureData.region,_=h.width,u=h.height;this._textureData.rotated&&null===c&&(_=h.height,u=h.width),this._pivotX*=_*l,this._pivotY*=u*l,null!==c&&(this._pivotX+=c.x*l,this._pivotY+=c.y*l),null!==this._displayData&&null!==r&&this._displayData!==r&&(r.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX-=i._helpPoint.x,this._pivotY-=i._helpPoint.y,this._displayData.transform.toMatrix(i._helpMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(0,0,i._helpPoint),this._pivotX+=i._helpPoint.x,this._pivotY+=i._helpPoint.y),t.DragonBones.yDown||(this._pivotY=(this._textureData.rotated?this._textureData.region.width:this._textureData.region.height)*l-this._pivotY)}else this._pivotX=0,this._pivotY=0;null!==r?this.origin=r.transform:null!==this._displayData?this.origin=this._displayData.transform:this.origin=null,o!==n?(null===this._deformVertices&&(this._deformVertices=t.BaseObject.borrowObject(t.DeformVertices)),this._deformVertices.init(o,this._armature)):null!==this._deformVertices&&this._textureData!==s&&(this._deformVertices.verticesDirty=!0),this._displayDirty=!0,this._transformDirty=!0}},i.prototype._updateDisplay=function(){var e=null!==this._display?this._display:this._rawDisplay,i=this._childArmature;this._displayIndex>=0&&this._displayIndex<this._displayList.length?(this._display=this._displayList[this._displayIndex],null!==this._display&&this._display instanceof t.Armature?(this._childArmature=this._display,this._display=this._childArmature.display):this._childArmature=null):(this._display=null,this._childArmature=null);var n=null!==this._display?this._display:this._rawDisplay;if(n!==e&&(this._onUpdateDisplay(),this._replaceDisplay(e),this._transformDirty=!0,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0),n!==this._rawDisplay&&n!==this._meshDisplay||this._updateFrame(),this._childArmature!==i&&(null!==i&&(i._parent=null,i.clock=null,i.inheritAnimation&&i.animation.reset()),null!==this._childArmature&&(this._childArmature._parent=this,this._childArmature.clock=this._armature.clock,this._childArmature.inheritAnimation))){if(0===this._childArmature.cacheFrameRate){var s=this._armature.cacheFrameRate;0!==s&&(this._childArmature.cacheFrameRate=s)}var r=null;if(null!==this._displayData&&1===this._displayData.type)r=this._displayData.actions;else if(this._displayIndex>=0&&null!==this._rawDisplayDatas){var o=this._displayIndex<this._rawDisplayDatas.length?this._rawDisplayDatas[this._displayIndex]:null;null===o&&(o=this._getDefaultRawDisplayData(this._displayIndex)),null!==o&&1===o.type&&(r=o.actions)}if(null!==r&&r.length>0)for(var a=0,l=r;a<l.length;a++){var c=l[a],h=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(c,h,this._armature),h.slot=this,this._armature._bufferAction(h,!1)}else this._childArmature.animation.play()}},i.prototype._updateGlobalTransformMatrix=function(t){var e=0===this._parent._boneData.type?this._parent.globalTransformMatrix:this._parent._getGlobalTransformMatrix(this.global.x,this.global.y);this.globalTransformMatrix.copyFrom(this._localMatrix),this.globalTransformMatrix.concat(e),t?this.global.fromMatrix(this.globalTransformMatrix):this._globalDirty=!0},i.prototype._setDisplayIndex=function(t,e){if(void 0===e&&(e=!1),e){if(this._animationDisplayIndex===t)return!1;this._animationDisplayIndex=t}return this._displayIndex!==t&&(this._displayIndex=t,this._displayDirty=!0,this._updateDisplayData(),this._displayDirty)},i.prototype._setZorder=function(t){return this._zOrder,this._zOrder=t,this._zOrderDirty=!0,this._zOrderDirty},i.prototype._setColor=function(t){return this._colorTransform.copyFrom(t),this._colorDirty=!0,this._colorDirty},i.prototype._setDisplayList=function(e){if(null!==e&&e.length>0){this._displayList.length!==e.length&&(this._displayList.length=e.length);for(var i=0,n=e.length;i<n;++i){var s=e[i];null!==s&&s!==this._rawDisplay&&s!==this._meshDisplay&&!(s instanceof t.Armature)&&this._displayList.indexOf(s)<0&&this._initDisplay(s,!0),this._displayList[i]=s}}else this._displayList.length>0&&(this._displayList.length=0);return this._displayIndex>=0&&this._displayIndex<this._displayList.length?this._displayDirty=this._display!==this._displayList[this._displayIndex]:this._displayDirty=null!==this._display,this._updateDisplayData(),this._displayDirty},i.prototype.init=function(t,e,i,n){if(null===this._slotData){this._slotData=t,this._isFromCache=!1,this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0,this._blendMode=this._slotData.blendMode,this._zOrder=this._slotData.zOrder,this._colorTransform.copyFrom(this._slotData.color),this._rawDisplay=i,this._meshDisplay=n,this._armature=e;var s=this._armature.getBone(this._slotData.parent.name);null!==s&&(this._parent=s),this._armature._addSlot(this),this._initDisplay(this._rawDisplay,!1),this._rawDisplay!==this._meshDisplay&&this._initDisplay(this._meshDisplay,!1),this._onUpdateDisplay(),this._addDisplay()}},i.prototype.update=function(t){if(this._isFromCache=!1,this._displayDirty&&(this._displayDirty=!1,this._updateDisplay(),this._transformDirty&&(null!==this.origin?this.global.copyFrom(this.origin).add(this.offset).toMatrix(this._localMatrix):this.global.copyFrom(this.offset).toMatrix(this._localMatrix))),this._zOrderDirty&&(this._zOrderDirty=!1,this._updateZOrder()),t>=0&&null!==this._cachedFrameIndices){var e=this._cachedFrameIndices[t];e>=0&&this._cachedFrameIndex===e?this._transformDirty=!1:e>=0?(this._transformDirty=!0,this._cachedFrameIndex=e):this._transformDirty||this._parent._childrenTransformDirty?(this._transformDirty=!0,this._cachedFrameIndex=-1):this._cachedFrameIndex>=0?(this._transformDirty=!1,this._cachedFrameIndices[t]=this._cachedFrameIndex):(this._transformDirty=!0,this._cachedFrameIndex=-1)}else(this._transformDirty||this._parent._childrenTransformDirty)&&(t=-1,this._transformDirty=!0,this._cachedFrameIndex=-1);if(null!==this._display){if(this._visibleDirty&&(this._visibleDirty=!1,this._updateVisible()),this._blendModeDirty&&(this._blendModeDirty=!1,this._updateBlendMode()),this._colorDirty&&(this._colorDirty=!1,this._updateColor()),null!==this._deformVertices&&null!==this._deformVertices.verticesData&&this._display===this._meshDisplay){var i=null!==this._deformVertices.verticesData.weight,n=0!==this._parent._boneData.type;if((this._deformVertices.verticesDirty||i&&this._deformVertices.isBonesUpdate()||n&&this._parent._childrenTransformDirty)&&(this._deformVertices.verticesDirty=!1,this._updateMesh()),i||n)return}if(this._transformDirty){if(this._transformDirty=!1,this._cachedFrameIndex<0){var s=t>=0;this._updateGlobalTransformMatrix(s),s&&null!==this._cachedFrameIndices&&(this._cachedFrameIndex=this._cachedFrameIndices[t]=this._armature._armatureData.setCacheFrame(this.globalTransformMatrix,this.global))}else this._isFromCache=!0,this._armature._armatureData.getCacheFrame(this.globalTransformMatrix,this.global,this._cachedFrameIndex);this._updateTransform()}}},i.prototype.updateTransformAndMatrix=function(){this._transformDirty&&(this._transformDirty=!1,this._updateGlobalTransformMatrix(!1))},i.prototype.replaceDisplayData=function(t,e){if(void 0===e&&(e=-1),e<0&&(e=this._displayIndex<0?0:this._displayIndex),this._displayDatas.length<=e){this._displayDatas.length=e+1;for(var i=0,n=this._displayDatas.length;i<n;++i)this._displayDatas[i]||(this._displayDatas[i]=null)}this._displayDatas[e]=t},i.prototype.containsPoint=function(t,e){return null!==this._boundingBoxData&&(this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),this._boundingBoxData.containsPoint(i._helpPoint.x,i._helpPoint.y))},i.prototype.intersectsSegment=function(t,e,n,s,r,o,a){if(void 0===r&&(r=null),void 0===o&&(o=null),void 0===a&&(a=null),null===this._boundingBoxData)return 0;this.updateTransformAndMatrix(),i._helpMatrix.copyFrom(this.globalTransformMatrix),i._helpMatrix.invert(),i._helpMatrix.transformPoint(t,e,i._helpPoint),t=i._helpPoint.x,e=i._helpPoint.y,i._helpMatrix.transformPoint(n,s,i._helpPoint),n=i._helpPoint.x,s=i._helpPoint.y;var l=this._boundingBoxData.intersectsSegment(t,e,n,s,r,o,a);return l>0&&(1===l||2===l?null!==r?(this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&(o.x=r.x,o.y=r.y)):null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o):(null!==r&&this.globalTransformMatrix.transformPoint(r.x,r.y,r),null!==o&&this.globalTransformMatrix.transformPoint(o.x,o.y,o)),null!==a&&(this.globalTransformMatrix.transformPoint(Math.cos(a.x),Math.sin(a.x),i._helpPoint,!0),a.x=Math.atan2(i._helpPoint.y,i._helpPoint.x),this.globalTransformMatrix.transformPoint(Math.cos(a.y),Math.sin(a.y),i._helpPoint,!0),a.y=Math.atan2(i._helpPoint.y,i._helpPoint.x))),l},i.prototype.invalidUpdate=function(){this._displayDirty=!0,this._transformDirty=!0},Object.defineProperty(i.prototype,"visible",{get:function(){return this._visible},set:function(t){this._visible!==t&&(this._visible=t,this._updateVisible())},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayIndex",{get:function(){return this._displayIndex},set:function(t){this._setDisplayIndex(t)&&this.update(-1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"name",{get:function(){return this._slotData.name},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayList",{get:function(){return this._displayList.concat()},set:function(e){var i=this._displayList.concat(),n=new Array;this._setDisplayList(e)&&this.update(-1);for(var s=0,r=i;s<r.length;s++)null!==(l=r[s])&&l!==this._rawDisplay&&l!==this._meshDisplay&&this._displayList.indexOf(l)<0&&n.indexOf(l)<0&&n.push(l);for(var o=0,a=n;o<a.length;o++){var l;(l=a[o])instanceof t.Armature||this._disposeDisplay(l,!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"slotData",{get:function(){return this._slotData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplayDatas",{get:function(){return this._rawDisplayDatas},set:function(t){if(this._rawDisplayDatas!==t)if(this._displayDirty=!0,this._rawDisplayDatas=t,null!==this._rawDisplayDatas){this._displayDatas.length=this._rawDisplayDatas.length;for(var e=0,i=this._displayDatas.length;e<i;++e){var n=this._rawDisplayDatas[e];null===n&&(n=this._getDefaultRawDisplayData(e)),this._displayDatas[e]=n}}else this._displayDatas.length=0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"displayData",{get:function(){return this._displayData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"boundingBoxData",{get:function(){return this._boundingBoxData},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"rawDisplay",{get:function(){return this._rawDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"meshDisplay",{get:function(){return this._meshDisplay},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"display",{get:function(){return this._display},set:function(t){if(this._display!==t){var e=this._displayList.length;if(this._displayIndex<0&&0===e&&(this._displayIndex=0),!(this._displayIndex<0)){var i=this.displayList;e<=this._displayIndex&&(i.length=this._displayIndex+1),i[this._displayIndex]=t,this.displayList=i}}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"childArmature",{get:function(){return this._childArmature},set:function(t){this._childArmature!==t&&(this.display=t)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"parent",{get:function(){return this._parent},enumerable:!0,configurable:!0}),i.prototype.getDisplay=function(){return this._display},i.prototype.setDisplay=function(t){this.display=t},i}(t.TransformObject);t.Slot=e}(nat||(nat={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.prototype._onClear=function(){this._armature=null,this._target=null,this._root=null,this._bone=null},Object.defineProperty(i.prototype,"name",{get:function(){return this._constraintData.name},enumerable:!0,configurable:!0}),i._helpMatrix=new t.Matrix,i._helpTransform=new t.Transform,i._helpPoint=new t.Point,i}(t.BaseObject);t.Constraint=e;var i=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.toString=function(){return"[class dragonBones.IKConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this._scaleEnabled=!1,this._bendPositive=!1,this._weight=1,this._constraintData=null},i.prototype._computeA=function(){var e=this._target.global,i=this._root.global,n=this._root.globalTransformMatrix,s=Math.atan2(e.y-i.y,e.x-i.x);i.scaleX<0&&(s+=Math.PI),i.rotation+=t.Transform.normalizeRadian(s-i.rotation)*this._weight,i.toMatrix(n)},i.prototype._computeB=function(){var e=this._bone._boneData.length,i=this._root,n=this._target.global,s=i.global,r=this._bone.global,o=this._bone.globalTransformMatrix,a=o.a*e,l=o.b*e,c=a*a+l*l,h=Math.sqrt(c),_=r.x-s.x,u=r.y-s.y,m=_*_+u*u,p=Math.sqrt(m),d=r.rotation,f=s.rotation,g=Math.atan2(u,_),y=(_=n.x-s.x)*_+(u=n.y-s.y)*u,v=Math.sqrt(y),x=0;if(h+p<=v||v+h<=p||v+p<=h)x=Math.atan2(n.y-s.y,n.x-s.x),h+p<=v||p<h&&(x+=Math.PI);else{var b=(m-c+y)/(2*y),S=Math.sqrt(m-b*b*y)/v,A=s.x+_*b,C=s.y+u*b,T=-u*S,w=_*S,E=!1,P=i.parent;if(null!==P){var D=P.globalTransformMatrix;E=D.a*D.d-D.b*D.c<0}E!==this._bendPositive?(r.x=A-T,r.y=C-w):(r.x=A+T,r.y=C+w),x=Math.atan2(r.y-s.y,r.x-s.x)}var I=t.Transform.normalizeRadian(x-g);s.rotation=f+I*this._weight,s.toMatrix(i.globalTransformMatrix);var R=g+I*this._weight;r.x=s.x+Math.cos(R)*p,r.y=s.y+Math.sin(R)*p;var M=Math.atan2(n.y-r.y,n.x-r.x);r.scaleX<0&&(M+=Math.PI),r.rotation=s.rotation+d-f+t.Transform.normalizeRadian(M-I-d)*this._weight,r.toMatrix(o)},i.prototype.init=function(t,e){if(null===this._constraintData){this._constraintData=t,this._armature=e,this._target=this._armature.getBone(this._constraintData.target.name),this._root=this._armature.getBone(this._constraintData.root.name),this._bone=null!==this._constraintData.bone?this._armature.getBone(this._constraintData.bone.name):null;var i=this._constraintData;this._scaleEnabled=i.scaleEnabled,this._bendPositive=i.bendPositive,this._weight=i.weight,this._root._hasConstraint=!0}},i.prototype.update=function(){this._root.updateByConstraint(),null!==this._bone?(this._bone.updateByConstraint(),this._computeB()):this._computeA()},i.prototype.invalidUpdate=function(){this._root.invalidUpdate(),null!==this._bone&&this._bone.invalidUpdate()},i}(e);t.IKConstraint=i;var n=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._bones=[],t._spaces=[],t._positions=[],t._curves=[],t._boneLengths=[],t._pathGlobalVertices=[],t._segments=[10],t}return iat(i,e),i.toString=function(){return"[class dragonBones.PathConstraint]"},i.prototype._onClear=function(){e.prototype._onClear.call(this),this.dirty=!1,this.pathOffset=0,this.position=0,this.spacing=0,this.rotateOffset=0,this.rotateMix=1,this.translateMix=1,this._pathSlot=null,this._bones.length=0,this._spaces.length=0,this._positions.length=0,this._curves.length=0,this._boneLengths.length=0,this._pathGlobalVertices.length=0},i.prototype._updatePathVertices=function(t){var e=this._armature,i=e.armatureData.parent,n=e.armatureData.scale,s=i.intArray,r=i.floatArray,o=t.offset,a=s[o+0],l=s[o+2];this._pathGlobalVertices.length=2*a;var c=t.weight;if(null!==c)for(var h=this._pathSlot._deformVertices.bones,_=c.bones.length,u=c.offset,m=s[u+1],p=u+2+_,d=(C=0,0);C<a;C++){for(var f=0,g=0,y=0,v=s[p++];y<v;y++){var x=h[s[p++]];if(null!==x){x.updateByConstraint(),A=x.globalTransformMatrix;var b=r[m++];w=r[m++]*n,E=r[m++]*n,f+=(A.a*w+A.c*E+A.tx)*b,g+=(A.b*w+A.d*E+A.ty)*b}}this._pathGlobalVertices[d++]=f,this._pathGlobalVertices[d++]=g}else{var S=this._pathSlot.parent;S.updateByConstraint();for(var A=S.globalTransformMatrix,C=0,T=l;C<a;C+=2){var w=r[T++]*n,E=r[T++]*n,P=A.a*w+A.c*E+A.tx,D=A.b*w+A.d*E+A.ty;this._pathGlobalVertices[C]=P,this._pathGlobalVertices[C+1]=D}}},i.prototype._computeVertices=function(t,e,i,n){for(var s=i,r=t;s<e;s+=2)n[s]=this._pathGlobalVertices[r++],n[s+1]=this._pathGlobalVertices[r++]},i.prototype._computeBezierCurve=function(t,e,i,n,s){var r=this._armature.armatureData.parent.intArray[t.vertices.offset+0],o=this._positions,a=this._spaces,l=t.closed,c=Array(),h=2*r,_=h/6,u=-1,m=this.position;o.length=3*e+2;var p=0;if(t.constantSpeed){l?(h+=2,c.length=r,this._computeVertices(2,h-4,0,c),this._computeVertices(0,2,h-4,c),c[h-2]=c[0],c[h-1]=c[1]):(_--,h-=4,c.length=h,this._computeVertices(2,h,0,c));var d=new Array(_);p=0;for(var f,g,y,v,x,b,S,A,C=c[0],T=c[1],w=0,E=0,P=0,D=0,I=0,R=0,M=(k=0,2);k<_;k++,M+=6)w=c[M],E=c[M+1],P=c[M+2],D=c[M+3],x=2*(f=.1875*(C-2*w+P))+(y=.09375*(3*(w-P)-C+(I=c[M+4]))),b=2*(g=.1875*(T-2*E+D))+(v=.09375*(3*(E-D)-T+(R=c[M+5]))),S=.75*(w-C)+f+.16666667*y,A=.75*(E-T)+g+.16666667*v,p+=Math.sqrt(S*S+A*A),S+=x,A+=b,x+=y,b+=v,p+=Math.sqrt(S*S+A*A),S+=x,A+=b,p+=Math.sqrt(S*S+A*A),S+=x+y,A+=b+v,p+=Math.sqrt(S*S+A*A),d[k]=p,C=I,T=R;if(n&&(m*=p),s)for(k=0;k<e;k++)a[k]*=p;for(var O=this._segments,B=0,N=(k=0,H=0,j=0,0);k<e;k++,H+=3){var L=m+=a[k];if(l)(L%=p)<0&&(L+=p),j=0;else{if(L<0)continue;if(L>p)continue}for(;;j++){var F=d[j];if(!(L>F)){0===j?L/=F:L=(L-(U=d[j-1]))/(F-U);break}}if(j!==u){u=j;var z=6*j;for(C=c[z],T=c[z+1],w=c[z+2],E=c[z+3],P=c[z+4],D=c[z+5],x=2*(f=.03*(C-2*w+P))+(y=.006*(3*(w-P)-C+(I=c[z+6]))),b=2*(g=.03*(T-2*E+D))+(v=.006*(3*(E-D)-T+(R=c[z+7]))),S=.3*(w-C)+f+.16666667*y,A=.3*(E-T)+g+.16666667*v,B=Math.sqrt(S*S+A*A),O[0]=B,z=1;z<8;z++)S+=x,A+=b,x+=y,b+=v,B+=Math.sqrt(S*S+A*A),O[z]=B;S+=x,A+=b,B+=Math.sqrt(S*S+A*A),O[8]=B,S+=x+y,A+=b+v,B+=Math.sqrt(S*S+A*A),O[9]=B,N=0}for(L*=B;;N++){var V=O[N];if(!(L>V)){var U;0===N?L/=V:L=N+(L-(U=O[N-1]))/(V-U);break}}this.addCurvePosition(.1*L,C,T,w,E,P,D,I,R,o,H,i)}}else{var G=t.curveLengths;if(p=G[_-=l?1:2],n&&(m*=p),s)for(var k=0;k<e;k++)a[k]*=p;c.length=8;k=0;for(var H=0,j=0;k<e;k++,H+=3){if(m+=a[k],l)(m%=p)<0&&(m+=p),j=0;else{if(m<0)continue;if(m>p)continue}for(var W=0;;j++){var q=G[j];if(!(m>q)){if(0===j)W=m/q;else{var X=G[j-1];W=(m-X)/(q-X)}break}}j!==u&&(u=j,l&&j===_?(this._computeVertices(h-4,4,0,c),this._computeVertices(0,4,4,c)):this._computeVertices(6*j+2,8,0,c)),this.addCurvePosition(W,c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],o,H,i)}}},i.prototype.addCurvePosition=function(t,e,i,n,s,r,o,a,l,c,h,_){if(0===t)return c[h]=e,c[h+1]=i,void(c[h+2]=0);if(1===t)return c[h]=a,c[h+1]=l,void(c[h+2]=0);var u=1-t,m=u*u,p=t*t,d=m*u,f=m*t*3,g=u*p*3,y=t*p,v=d*e+f*n+g*r+y*a,x=d*i+f*s+g*o+y*l;c[h]=v,c[h+1]=x,c[h+2]=_?Math.atan2(x-(d*i+f*s+g*o),v-(d*e+f*n+g*r)):0},i.prototype.init=function(t,e){this._constraintData=t,this._armature=e;var i=t;this.pathOffset=i.pathDisplayData.vertices.offset,this.position=i.position,this.spacing=i.spacing,this.rotateOffset=i.rotateOffset,this.rotateMix=i.rotateMix,this.translateMix=i.translateMix,this._root=this._armature.getBone(i.root.name),this._target=this._armature.getBone(i.target.name),this._pathSlot=this._armature.getSlot(i.pathSlot.name);for(var n=0,s=i.bones.length;n<s;n++){var r=this._armature.getBone(i.bones[n].name);null!==r&&this._bones.push(r)}2===i.rotateMode&&(this._boneLengths.length=this._bones.length),this._root._hasConstraint=!0},i.prototype.update=function(){var e=this._pathSlot;if(null!==e._deformVertices&&null!==e._deformVertices.verticesData&&e._deformVertices.verticesData.offset===this.pathOffset){var i=this._constraintData,n=e._displayData,s=!1,r=e._deformVertices;if(this._root._childrenTransformDirty?(this._updatePathVertices(n.vertices),s=!0):null!==r&&(r.verticesDirty||r.isBonesUpdate())&&(this._updatePathVertices(n.vertices),r.verticesDirty=!1,s=!0),s||this.dirty){var o=i.positionMode,a=i.spacingMode,l=i.rotateMode,c=this._bones,h=0===a,_=2===l,u=0===l,m=c.length,p=u?m:m+1,d=this.spacing,f=this._spaces;if(f.length=p,_||h){f[0]=0;for(var g=0,y=p-1;g<y;g++){(R=c[g]).updateByConstraint();var v=R._boneData.length,x=v*(M=R.globalTransformMatrix).a,b=v*M.b,S=Math.sqrt(x*x+b*b);_&&(this._boneLengths[g]=S),f[g+1]=(v+d)*S/v}}else for(g=0;g<p;g++)f[g]=d;this._computeBezierCurve(n,p,u,1===o,2===a);var A,C=this._positions,T=this.rotateOffset,w=C[0],E=C[1];0===T?A=1===l:(A=!1,null!==(R=e.parent)&&(T*=(M=R.globalTransformMatrix).a*M.d-M.b*M.c>0?t.Transform.DEG_RAD:-t.Transform.DEG_RAD));for(var P=this.rotateMix,D=this.translateMix,I=(g=0,3);g<m;g++,I+=3){var R,M;(R=c[g]).updateByConstraint(),(M=R.globalTransformMatrix).tx+=(w-M.tx)*D,M.ty+=(E-M.ty)*D;var O=(x=C[I])-w,B=(b=C[I+1])-E;if(_){var N=this._boneLengths[g],L=(Math.sqrt(O*O+B*B)/N-1)*P+1;M.a*=L,M.b*=L}if(w=x,E=b,P>0){var F=M.a,z=M.b,V=M.c,U=M.d,G=void 0,k=void 0,H=void 0;if(G=u?C[I-1]:Math.atan2(B,O),G-=Math.atan2(z,F),A){k=Math.cos(G),H=Math.sin(G);var j=R._boneData.length;w+=(j*(k*F-H*z)-O)*P,E+=(j*(H*F+k*z)-B)*P}else G+=T;G>t.Transform.PI?G-=t.Transform.PI_D:G<-t.Transform.PI&&(G+=t.Transform.PI_D),G*=P,k=Math.cos(G),H=Math.sin(G),M.a=k*F-H*z,M.b=H*F+k*z,M.c=k*V-H*U,M.d=H*V+k*U}R.global.fromMatrix(M)}this.dirty=!1}}},i.prototype.invalidUpdate=function(){},i}(e);t.PathConstraint=n}(nat||(nat={})),function(t){var e=function(){function t(t){void 0===t&&(t=0),this.time=0,this.timeScale=1,this._systemTime=0,this._animatebles=[],this._clock=null,this.time=t,this._systemTime=.001*(new Date).getTime()}return t.prototype.advanceTime=function(t){t!=t&&(t=0);var e=.001*Date.now();if(t<0&&(t=e-this._systemTime),this._systemTime=e,1!==this.timeScale&&(t*=this.timeScale),0!==t){t<0?this.time-=t:this.time+=t;for(var i=0,n=0,s=this._animatebles.length;i<s;++i){var r=this._animatebles[i];null!==r?(n>0&&(this._animatebles[i-n]=r,this._animatebles[i]=null),r.advanceTime(t)):n++}if(n>0){for(s=this._animatebles.length;i<s;++i){var o=this._animatebles[i];null!==o?this._animatebles[i-n]=o:n++}this._animatebles.length-=n}}},t.prototype.contains=function(t){if(t===this)return!1;for(var e=t;e!==this&&null!==e;)e=e.clock;return e===this},t.prototype.add=function(t){this._animatebles.indexOf(t)<0&&(this._animatebles.push(t),t.clock=this)},t.prototype.remove=function(t){var e=this._animatebles.indexOf(t);e>=0&&(this._animatebles[e]=null,t.clock=null)},t.prototype.clear=function(){for(var t=0,e=this._animatebles;t<e.length;t++){var i=e[t];null!==i&&(i.clock=null)}},Object.defineProperty(t.prototype,"clock",{get:function(){return this._clock},set:function(t){this._clock!==t&&(null!==this._clock&&this._clock.remove(this),this._clock=t,null!==this._clock&&this._clock.add(this))},enumerable:!0,configurable:!0}),t.clock=new t,t}();t.WorldClock=e}(nat||(nat={})),function(t){var e=function(e){function i(){var t=null!==e&&e.apply(this,arguments)||this;return t._animationNames=[],t._animationStates=[],t._animations={},t._animationConfig=null,t}return iat(i,e),i.toString=function(){return"[class dragonBones.Animation]"},i.prototype._onClear=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();for(var i in this._animations)delete this._animations[i];null!==this._animationConfig&&this._animationConfig.returnToPool(),this.timeScale=1,this._lockUpdate=!1,this._animationDirty=!1,this._inheritTimeScale=1,this._animationNames.length=0,this._animationStates.length=0,this._armature=null,this._animationConfig=null,this._lastAnimationState=null},i.prototype._fadeOut=function(t){switch(t.fadeOutMode){case 1:for(var e=0,i=this._animationStates;e<i.length;e++)null===(c=i[e])._parent&&c.layer===t.layer&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 2:for(var n=0,s=this._animationStates;n<s.length;n++)null===(c=s[n])._parent&&c.group===t.group&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 3:for(var r=0,o=this._animationStates;r<o.length;r++)null===(c=o[r])._parent&&c.layer===t.layer&&c.group===t.group&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut);break;case 4:for(var a=0,l=this._animationStates;a<l.length;a++){var c;null===(c=l[a])._parent&&c.fadeOut(t.fadeOutTime,t.pauseFadeOut)}}},i.prototype.init=function(e){null===this._armature&&(this._armature=e,this._animationConfig=t.BaseObject.borrowObject(t.AnimationConfig))},i.prototype.advanceTime=function(t){t<0&&(t=-t),this._armature.inheritAnimation&&null!==this._armature._parent?this._inheritTimeScale=this._armature._parent._armature.animation._inheritTimeScale*this.timeScale:this._inheritTimeScale=this.timeScale,1!==this._inheritTimeScale&&(t*=this._inheritTimeScale);var e=this._animationStates.length;if(1===e)if((p=this._animationStates[0])._fadeState>0&&p._subFadeState>0)this._armature._dragonBones.bufferObject(p),this._animationStates.length=0,this._lastAnimationState=null;else{var i=p._animationData,n=i.cacheFrameRate;if(this._animationDirty&&n>0){this._animationDirty=!1;for(var s=0,r=this._armature.getBones();s<r.length;s++){var o=r[s];o._cachedFrameIndices=i.getBoneCachedFrameIndices(o.name)}for(var a=0,l=this._armature.getSlots();a<l.length;a++){var c=l[a],h=c.rawDisplayDatas;if(null!==h&&h.length>0){var _=h[0];if(null!==_&&_.parent===this._armature.armatureData.defaultSkin){c._cachedFrameIndices=i.getSlotCachedFrameIndices(c.name);continue}}c._cachedFrameIndices=null}}p.advanceTime(t,n)}else if(e>1){for(var u=0,m=0;u<e;++u){var p;(p=this._animationStates[u])._fadeState>0&&p._subFadeState>0?(m++,this._armature._dragonBones.bufferObject(p),this._animationDirty=!0,this._lastAnimationState===p&&(this._lastAnimationState=null)):(m>0&&(this._animationStates[u-m]=p),p.advanceTime(t,0)),u===e-1&&m>0&&(this._animationStates.length-=m,null===this._lastAnimationState&&this._animationStates.length>0&&(this._lastAnimationState=this._animationStates[this._animationStates.length-1]))}this._armature._cacheFrameIndex=-1}else this._armature._cacheFrameIndex=-1},i.prototype.reset=function(){for(var t=0,e=this._animationStates;t<e.length;t++)e[t].returnToPool();this._animationDirty=!1,this._animationConfig.clear(),this._animationStates.length=0,this._lastAnimationState=null},i.prototype.stop=function(t){if(void 0===t&&(t=null),null!==t)null!==(n=this.getState(t))&&n.stop();else for(var e=0,i=this._animationStates;e<i.length;e++){var n;(n=i[e]).stop()}},i.prototype.playConfig=function(e){var i=e.animation;if(!(i in this._animations))return console.warn("Non-existent animation.\n","DragonBones name: "+this._armature.armatureData.parent.name,"Armature name: "+this._armature.name,"Animation name: "+i),null;var n=this._animations[i];if(5===e.fadeOutMode)for(var s=0,r=this._animationStates;s<r.length;s++){var o=r[s];if(o._animationData===n)return o}0===this._animationStates.length?e.fadeInTime=0:e.fadeInTime<0&&(e.fadeInTime=n.fadeInTime),e.fadeOutTime<0&&(e.fadeOutTime=e.fadeInTime),e.timeScale<=-100&&(e.timeScale=1/n.scale),n.frameCount>1?(e.position<0?(e.position%=n.duration,e.position=n.duration-e.position):e.position===n.duration?e.position-=1e-6:e.position>n.duration&&(e.position%=n.duration),e.duration>0&&e.position+e.duration>n.duration&&(e.duration=n.duration-e.position),e.playTimes<0&&(e.playTimes=n.playTimes)):(e.playTimes=1,e.position=0,e.duration>0&&(e.duration=0)),0===e.duration&&(e.duration=-1),this._fadeOut(e);var a=t.BaseObject.borrowObject(t.AnimationState);if(a.init(this._armature,n,e),this._animationDirty=!0,this._armature._cacheFrameIndex=-1,this._animationStates.length>0){for(var l=!1,c=0,h=this._animationStates.length;c<h;++c){if(a.layer>this._animationStates[c].layer){l=!0,this._animationStates.splice(c,0,a);break}if(c!==h-1&&a.layer>this._animationStates[c+1].layer){l=!0,this._animationStates.splice(c+1,0,a);break}}l||this._animationStates.push(a)}else this._animationStates.push(a);for(var _=0,u=this._armature.getSlots();_<u.length;_++){var m=u[_].childArmature;null!==m&&m.inheritAnimation&&m.animation.hasAnimation(i)&&null===m.animation.getState(i)&&m.animation.fadeIn(i)}var p=!1;for(var d in n.animationTimelines){this._lockUpdate||(p=!0,this._lockUpdate=!0);var f=this.fadeIn(d,e.fadeInTime,1,a.layer,null,0);null!==f&&(f.resetToPose=!1,f._parent=a,f.stop())}return p&&(this._lockUpdate=!1),this._lockUpdate||(e.fadeInTime<=0&&this._armature.advanceTime(0),this._lastAnimationState=a),a},i.prototype.play=function(t,e){if(void 0===t&&(t=null),void 0===e&&(e=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=null!==t?t:"",null!==t&&t.length>0)this.playConfig(this._animationConfig);else if(null===this._lastAnimationState){var i=this._armature.armatureData.defaultAnimation;null!==i&&(this._animationConfig.animation=i.name,this.playConfig(this._animationConfig))}else this._lastAnimationState.isPlaying||this._lastAnimationState.isCompleted?(this._animationConfig.animation=this._lastAnimationState.name,this.playConfig(this._animationConfig)):this._lastAnimationState.play();return this._lastAnimationState},i.prototype.fadeIn=function(t,e,i,n,s,r){return void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=0),void 0===s&&(s=null),void 0===r&&(r=3),this._animationConfig.clear(),this._animationConfig.fadeOutMode=r,this._animationConfig.playTimes=i,this._animationConfig.layer=n,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==s?s:"",this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByTime=function(t,e,i){return void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.position=e,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t,this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByFrame=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*e/n.frameCount),this.playConfig(this._animationConfig)},i.prototype.gotoAndPlayByProgress=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=-1),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.playTimes=i,this._animationConfig.fadeInTime=0,this._animationConfig.animation=t;var n=t in this._animations?this._animations[t]:null;return null!==n&&(this._animationConfig.position=n.duration*(e>0?e:0)),this.playConfig(this._animationConfig)},i.prototype.gotoAndStopByTime=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByTime(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByFrame=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByFrame(t,e,1);return null!==i&&i.stop(),i},i.prototype.gotoAndStopByProgress=function(t,e){void 0===e&&(e=0);var i=this.gotoAndPlayByProgress(t,e,1);return null!==i&&i.stop(),i},i.prototype.getState=function(t){for(var e=this._animationStates.length;e--;){var i=this._animationStates[e];if(i.name===t)return i}return null},i.prototype.hasAnimation=function(t){return t in this._animations},i.prototype.getStates=function(){return this._animationStates},Object.defineProperty(i.prototype,"isPlaying",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(e[t].isPlaying)return!0;return!1},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isCompleted",{get:function(){for(var t=0,e=this._animationStates;t<e.length;t++)if(!e[t].isCompleted)return!1;return this._animationStates.length>0},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationName",{get:function(){return null!==this._lastAnimationState?this._lastAnimationState.name:""},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationNames",{get:function(){return this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animations",{get:function(){return this._animations},set:function(t){if(this._animations!==t){for(var e in this._animationNames.length=0,this._animations)delete this._animations[e];for(var e in t)this._animationNames.push(e),this._animations[e]=t[e]}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationConfig",{get:function(){return this._animationConfig.clear(),this._animationConfig},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lastAnimationState",{get:function(){return this._lastAnimationState},enumerable:!0,configurable:!0}),i.prototype.gotoAndPlay=function(t,e,i,n,s,r,o){void 0===e&&(e=-1),void 0===i&&(i=-1),void 0===n&&(n=-1),void 0===s&&(s=0),void 0===r&&(r=null),void 0===o&&(o=3),console.warn("Deprecated."),this._animationConfig.clear(),this._animationConfig.resetToPose=!0,this._animationConfig.fadeOutMode=o,this._animationConfig.playTimes=n,this._animationConfig.layer=s,this._animationConfig.fadeInTime=e,this._animationConfig.animation=t,this._animationConfig.group=null!==r?r:"";var a=this._animations[t];return a&&i>0&&(this._animationConfig.timeScale=a.duration/i),this.playConfig(this._animationConfig)},i.prototype.gotoAndStop=function(t,e){return void 0===e&&(e=0),console.warn("Deprecated."),this.gotoAndStopByTime(t,e)},Object.defineProperty(i.prototype,"animationList",{get:function(){return console.warn("Deprecated."),this._animationNames},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"animationDataList",{get:function(){console.warn("Deprecated.");for(var t=[],e=0,i=this._animationNames.length;e<i;++e)t.push(this._animations[this._animationNames[e]]);return t},enumerable:!0,configurable:!0}),i}(t.BaseObject);t.Animation=e}(nat||(nat={})),function(t){var e=function(e){function s(){var t=null!==e&&e.apply(this,arguments)||this;return t._blendState=new n,t._boneMask=[],t._boneTimelines=[],t._surfaceTimelines=[],t._slotTimelines=[],t._constraintTimelines=[],t._animationTimelines=[],t._poseTimelines=[],t._bonePoses={},t._actionTimeline=null,t._zOrderTimeline=null,t._parent=null,t}return iat(s,e),s.toString=function(){return"[class dragonBones.AnimationState]"},s.prototype._onClear=function(){for(var t=0,e=this._boneTimelines;t<e.length;t++)e[t].returnToPool();for(var i=0,n=this._surfaceTimelines;i<n.length;i++)n[i].returnToPool();for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].returnToPool();for(var o=0,a=this._constraintTimelines;o<a.length;o++)a[o].returnToPool();for(var l=0,c=this._animationTimelines;l<c.length;l++)c[l].returnToPool();for(var h in this._bonePoses)this._bonePoses[h].returnToPool(),delete this._bonePoses[h];null!==this._actionTimeline&&this._actionTimeline.returnToPool(),null!==this._zOrderTimeline&&this._zOrderTimeline.returnToPool(),this.actionEnabled=!1,this.additiveBlending=!1,this.displayControl=!1,this.resetToPose=!1,this.playTimes=1,this.layer=0,this.timeScale=1,this.weight=1,this.autoFadeOutTime=0,this.fadeTotalTime=0,this.name="",this.group="",this._timelineDirty=2,this._playheadState=0,this._fadeState=-1,this._subFadeState=-1,this._position=0,this._duration=0,this._fadeTime=0,this._time=0,this._fadeProgress=0,this._weightResult=0,this._blendState.clear(),this._boneMask.length=0,this._boneTimelines.length=0,this._surfaceTimelines.length=0,this._slotTimelines.length=0,this._constraintTimelines.length=0,this._animationTimelines.length=0,this._poseTimelines.length=0,this._animationData=null,this._armature=null,this._actionTimeline=null,this._zOrderTimeline=null,this._parent=null},s.prototype._updateTimelines=function(){for(var e=0,i=this._armature._constraints;e<i.length;e++){var n=i[e];if(null!==(l=this._animationData.getConstraintTimelines(n.name)))for(var s=0,r=l;s<r.length;s++)switch((u=r[s]).type){case 30:(m=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,m.init(this._armature,this,u),this._constraintTimelines.push(m)}else this.resetToPose&&((m=t.BaseObject.borrowObject(t.IKConstraintTimelineState)).constraint=n,m.init(this._armature,this,null),this._constraintTimelines.push(m),this._poseTimelines.push(m))}for(var o=0,a=this._armature.animation.getStates();o<a.length;o++){var l,c=a[o];if(c._parent===this&&null!==(l=this._animationData.getAnimationTimelines(c.name)))for(var h=0,_=l;h<_.length;h++){var u;switch((u=_[h]).type){case 40:var m;(m=t.BaseObject.borrowObject(t.AnimationTimelineState)).animationState=c,m.init(this._armature,this,u),this._animationTimelines.push(m)}}}},s.prototype._updateBoneAndSlotTimelines=function(){for(var e={},n=0,s=this._boneTimelines;n<s.length;n++)(l=(y=s[n]).bone.name)in e||(e[l]=[]),e[l].push(y);for(var r=0,o=this._armature.getBones();r<o.length;r++){var a=o[r],l=a.name;if(this.containsBoneMask(l))if(l in e)delete e[l];else if(0===a._boneData.type){var c=this._animationData.getBoneTimelines(l),h=l in this._bonePoses?this._bonePoses[l]:this._bonePoses[l]=t.BaseObject.borrowObject(i);if(null!==c)for(var _=0,u=c;_<u.length;_++)switch((R=u[_]).type){case 10:(y=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 11:(y=t.BaseObject.borrowObject(t.BoneTranslateTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 12:(y=t.BaseObject.borrowObject(t.BoneRotateTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y);break;case 13:(y=t.BaseObject.borrowObject(t.BoneScaleTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,R),this._boneTimelines.push(y)}else this.resetToPose&&((y=t.BaseObject.borrowObject(t.BoneAllTimelineState)).bone=a,y.bonePose=h,y.init(this._armature,this,null),this._boneTimelines.push(y),this._poseTimelines.push(y))}else if(1===a._boneData.type)if(null!==(c=this._animationData.getSurfaceTimelines(l)))for(var m=0,p=c;m<p.length;m++)switch((R=p[m]).type){case 50:(y=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,y.init(this._armature,this,R),this._surfaceTimelines.push(y)}else this.resetToPose&&((y=t.BaseObject.borrowObject(t.SurfaceTimelineState)).surface=a,y.init(this._armature,this,null),this._surfaceTimelines.push(y),this._poseTimelines.push(y))}for(var d in e)for(var f=0,g=e[d];f<g.length;f++){var y=g[f];this._boneTimelines.splice(this._boneTimelines.indexOf(y),1),y.returnToPool()}for(var v={},x=[],b=0,S=this._slotTimelines;b<S.length;b++)(l=(y=S[b]).slot.name)in v||(v[l]=[]),v[l].push(y);for(var A=0,C=this._armature.getSlots();A<C.length;A++){var T=C[A],w=T.parent.name;if(this.containsBoneMask(w))if(l=T.name,c=this._animationData.getSlotTimelines(l),l in v)delete v[l];else{var E=!1,P=!1;if(x.length=0,null!==c)for(var D=0,I=c;D<I.length;D++){var R;switch((R=I[D]).type){case 20:(y=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),E=!0;break;case 21:(y=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),P=!0;break;case 22:(y=t.BaseObject.borrowObject(t.DeformTimelineState)).slot=T,y.init(this._armature,this,R),this._slotTimelines.push(y),x.push(y.vertexOffset)}}if(this.resetToPose&&(E||((y=t.BaseObject.borrowObject(t.SlotDislayTimelineState)).slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y)),P||((y=t.BaseObject.borrowObject(t.SlotColorTimelineState)).slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y)),null!==T.rawDisplayDatas))for(var M=0,O=T.rawDisplayDatas;M<O.length;M++){var B=O[M];if(null!==B&&2===B.type){var N=B.vertices.offset;x.indexOf(N)<0&&((y=t.BaseObject.borrowObject(t.DeformTimelineState)).vertexOffset=N,y.slot=T,y.init(this._armature,this,null),this._slotTimelines.push(y),this._poseTimelines.push(y))}}}}for(var d in v)for(var L=0,F=v[d];L<F.length;L++)y=F[L],this._slotTimelines.splice(this._slotTimelines.indexOf(y),1),y.returnToPool()},s.prototype._advanceFadeTime=function(e){var i,n=this._fadeState>0;if(this._subFadeState<0){this._subFadeState=0;var s=n?t.EventObject.FADE_OUT:t.EventObject.FADE_IN;this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i))}(e<0&&(e=-e),this._fadeTime+=e,this._fadeTime>=this.fadeTotalTime?(this._subFadeState=1,this._fadeProgress=n?0:1):this._fadeTime>0?this._fadeProgress=n?1-this._fadeTime/this.fadeTotalTime:this._fadeTime/this.fadeTotalTime:this._fadeProgress=n?1:0,this._subFadeState>0)&&(n||(this._playheadState|=1,this._fadeState=0),s=n?t.EventObject.FADE_OUT_COMPLETE:t.EventObject.FADE_IN_COMPLETE,this._armature.eventDispatcher.hasDBEventListener(s)&&((i=t.BaseObject.borrowObject(t.EventObject)).type=s,i.armature=this._armature,i.animationState=this,this._armature._dragonBones.bufferEvent(i)))},s.prototype.init=function(e,i,n){if(null===this._armature){if(this._armature=e,this._animationData=i,this.resetToPose=n.resetToPose,this.additiveBlending=n.additiveBlending,this.displayControl=n.displayControl,this.actionEnabled=n.actionEnabled,this.layer=n.layer,this.playTimes=n.playTimes,this.timeScale=n.timeScale,this.fadeTotalTime=n.fadeInTime,this.autoFadeOutTime=n.autoFadeOutTime,this.weight=n.weight,this.name=n.name.length>0?n.name:n.animation,this.group=n.group,n.pauseFadeIn?this._playheadState=2:this._playheadState=3,n.duration<0?(this._position=0,this._duration=this._animationData.duration,0!==n.position?this.timeScale>=0?this._time=n.position:this._time=n.position-this._duration:this._time=0):(this._position=n.position,this._duration=n.duration,this._time=0),this.timeScale<0&&0===this._time&&(this._time=-1e-6),this.fadeTotalTime<=0&&(this._fadeProgress=.999999),n.boneMask.length>0){this._boneMask.length=n.boneMask.length;for(var s=0,r=this._boneMask.length;s<r;++s)this._boneMask[s]=n.boneMask[s]}this._actionTimeline=t.BaseObject.borrowObject(t.ActionTimelineState),this._actionTimeline.init(this._armature,this,this._animationData.actionTimeline),this._actionTimeline.currentTime=this._time,this._actionTimeline.currentTime<0&&(this._actionTimeline.currentTime=this._duration-this._actionTimeline.currentTime),null!==this._animationData.zOrderTimeline&&(this._zOrderTimeline=t.BaseObject.borrowObject(t.ZOrderTimelineState),this._zOrderTimeline.init(this._armature,this,this._animationData.zOrderTimeline))}},s.prototype.advanceTime=function(e,i){if(this._blendState.dirty=!1,0===this._fadeState&&0===this._subFadeState||this._advanceFadeTime(e),3===this._playheadState&&(1!==this.timeScale&&(e*=this.timeScale),this._time+=e),0!==this._timelineDirty&&(2===this._timelineDirty&&this._updateTimelines(),this._timelineDirty=0,this._updateBoneAndSlotTimelines()),0!==this.weight){var n=0===this._fadeState&&i>0,s=!0,r=!0,o=this._time;if(this._weightResult=this.weight*this._fadeProgress,null!==this._parent&&(this._weightResult*=this._parent._weightResult/this._parent._fadeProgress),this._actionTimeline.playState<=0&&this._actionTimeline.update(o),n){var a=2*i;this._actionTimeline.currentTime=Math.floor(this._actionTimeline.currentTime*a)/a}if(null!==this._zOrderTimeline&&this._zOrderTimeline.playState<=0&&this._zOrderTimeline.update(o),n){var l=Math.floor(this._actionTimeline.currentTime*i);this._armature._cacheFrameIndex===l?(s=!1,r=!1):(this._armature._cacheFrameIndex=l,this._animationData.cachedFrames[l]?r=!1:this._animationData.cachedFrames[l]=!0)}if(s){if(r)for(var c=0,h=this._boneTimelines.length;c<h;++c)(d=this._boneTimelines[c]).playState<=0&&d.update(o),(c===h-1||d.bone!==this._boneTimelines[c+1].bone)&&0!==(_=d.bone._blendState.update(this._weightResult,this.layer))&&d.blend(_);for(c=0,h=this._surfaceTimelines.length;c<h;++c){var _=(d=this._surfaceTimelines[c]).surface._blendState.update(this._weightResult,this.layer);d.playState<=0&&d.update(o),0!==_&&d.blend(_)}if(this.displayControl)for(c=0,h=this._slotTimelines.length;c<h;++c){var u=(d=this._slotTimelines[c]).slot.displayController;null!==u&&u!==this.name&&u!==this.group||d.playState<=0&&d.update(o)}for(c=0,h=this._constraintTimelines.length;c<h;++c)(d=this._constraintTimelines[c]).playState<=0&&d.update(o);for(c=0,h=this._animationTimelines.length;c<h;++c)_=(d=this._animationTimelines[c]).animationState._blendState.update(this._weightResult,this.layer),d.playState<=0&&d.update(o),0!==_&&d.blend(_)}if(0===this._fadeState){if(this._subFadeState>0&&(this._subFadeState=0,this._poseTimelines.length>0)){for(var m=0,p=this._poseTimelines;m<p.length;m++){var d;(d=p[m])instanceof t.BoneTimelineState?this._boneTimelines.splice(this._boneTimelines.indexOf(d),1):d instanceof t.SurfaceTimelineState?this._surfaceTimelines.splice(this._surfaceTimelines.indexOf(d),1):d instanceof t.SlotTimelineState?this._slotTimelines.splice(this._slotTimelines.indexOf(d),1):d instanceof t.ConstraintTimelineState&&this._constraintTimelines.splice(this._constraintTimelines.indexOf(d),1),d.returnToPool()}this._poseTimelines.length=0}this._actionTimeline.playState>0&&this.autoFadeOutTime>=0&&this.fadeOut(this.autoFadeOutTime)}}},s.prototype.play=function(){this._playheadState=3},s.prototype.stop=function(){this._playheadState&=1},s.prototype.fadeOut=function(t,e){if(void 0===e&&(e=!0),t<0&&(t=0),e&&(this._playheadState&=2),this._fadeState>0){if(t>this.fadeTotalTime-this._fadeTime)return}else{this._fadeState=1,this._subFadeState=-1,(t<=0||this._fadeProgress<=0)&&(this._fadeProgress=1e-6);for(var i=0,n=this._boneTimelines;i<n.length;i++)(u=n[i]).fadeOut();for(var s=0,r=this._surfaceTimelines;s<r.length;s++)(u=r[s]).fadeOut();for(var o=0,a=this._slotTimelines;o<a.length;o++)(u=a[o]).fadeOut();for(var l=0,c=this._constraintTimelines;l<c.length;l++)(u=c[l]).fadeOut();for(var h=0,_=this._animationTimelines;h<_.length;h++){var u;(u=_[h]).animationState.fadeOut(t,e),u.fadeOut()}}this.displayControl=!1,this.fadeTotalTime=this._fadeProgress>1e-6?t/this._fadeProgress:0,this._fadeTime=this.fadeTotalTime*(1-this._fadeProgress)},s.prototype.containsBoneMask=function(t){return 0===this._boneMask.length||this._boneMask.indexOf(t)>=0},s.prototype.addBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._armature.getBone(t);if(null!==i){if(this._boneMask.indexOf(t)<0&&this._boneMask.push(t),e)for(var n=0,s=this._armature.getBones();n<s.length;n++){var r=s[n];this._boneMask.indexOf(r.name)<0&&i.contains(r)&&this._boneMask.push(r.name)}this._timelineDirty=1}},s.prototype.removeBoneMask=function(t,e){void 0===e&&(e=!0);var i=this._boneMask.indexOf(t);if(i>=0&&this._boneMask.splice(i,1),e){var n=this._armature.getBone(t);if(null!==n){var s=this._armature.getBones();if(this._boneMask.length>0)for(var r=0,o=s;r<o.length;r++){var a=o[r],l=this._boneMask.indexOf(a.name);l>=0&&n.contains(a)&&this._boneMask.splice(l,1)}else for(var c=0,h=s;c<h.length;c++)(a=h[c])!==n&&(n.contains(a)||this._boneMask.push(a.name))}}this._timelineDirty=1},s.prototype.removeAllBoneMask=function(){this._boneMask.length=0,this._timelineDirty=1},Object.defineProperty(s.prototype,"isFadeIn",{get:function(){return this._fadeState<0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeOut",{get:function(){return this._fadeState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isFadeComplete",{get:function(){return 0===this._fadeState},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isPlaying",{get:function(){return 0!=(2&this._playheadState)&&this._actionTimeline.playState<=0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"isCompleted",{get:function(){return this._actionTimeline.playState>0},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentPlayTimes",{get:function(){return this._actionTimeline.currentPlayTimes},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"totalTime",{get:function(){return this._duration},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"currentTime",{get:function(){return this._actionTimeline.currentTime},set:function(t){var e=this._actionTimeline.currentPlayTimes-(this._actionTimeline.playState>0?1:0);if((t<0||this._duration<t)&&(t=t%this._duration+e*this._duration)<0&&(t+=this._duration),this.playTimes>0&&e===this.playTimes-1&&t===this._duration&&(t=this._duration-1e-6),this._time!==t){this._time=t,this._actionTimeline.setCurrentTime(this._time),null!==this._zOrderTimeline&&(this._zOrderTimeline.playState=-1);for(var i=0,n=this._boneTimelines;i<n.length;i++)n[i].playState=-1;for(var s=0,r=this._slotTimelines;s<r.length;s++)r[s].playState=-1}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"animationData",{get:function(){return this._animationData},enumerable:!0,configurable:!0}),s}(t.BaseObject);t.AnimationState=e;var i=function(e){function i(){var i=null!==e&&e.apply(this,arguments)||this;return i.current=new t.Transform,i.delta=new t.Transform,i.result=new t.Transform,i}return iat(i,e),i.toString=function(){return"[class dragonBones.BonePose]"},i.prototype._onClear=function(){this.current.identity(),this.delta.identity(),this.result.identity()},i}(t.BaseObject);t.BonePose=i;var n=function(){function t(){}return t.prototype.update=function(t,e){if(this.dirty){if(!(this.leftWeight>0))return 0;if(this.layer!==e){if(this.layerWeight>=this.leftWeight)return this.leftWeight=0,0;this.layer=e,this.leftWeight-=this.layerWeight,this.layerWeight=0}return t*=this.leftWeight,this.layerWeight+=t,this.blendWeight=t,2}return this.dirty=!0,this.layer=e,this.layerWeight=t,this.leftWeight=1,this.blendWeight=t,1},t.prototype.clear=function(){this.dirty=!1,this.layer=0,this.leftWeight=0,this.layerWeight=0,this.blendWeight=0},t}();t.BlendState=n}(nat||(nat={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){this.playState=-1,this.currentPlayTimes=-1,this.currentTime=-1,this._tweenState=0,this._frameRate=0,this._frameValueOffset=0,this._frameCount=0,this._frameOffset=0,this._frameIndex=-1,this._frameRateR=0,this._position=0,this._duration=0,this._timeScale=1,this._timeOffset=0,this._dragonBonesData=null,this._animationData=null,this._timelineData=null,this._armature=null,this._animationState=null,this._actionTimeline=null,this._frameArray=null,this._frameIntArray=null,this._frameFloatArray=null,this._timelineArray=null,this._frameIndices=null},e.prototype._setCurrentTime=function(t){var e=this.playState,i=this.currentPlayTimes,n=this.currentTime;if(null!==this._actionTimeline&&this._frameCount<=1)this.playState=this._actionTimeline.playState>=0?1:-1,this.currentPlayTimes=1,this.currentTime=this._actionTimeline.currentTime;else if(null===this._actionTimeline||1!==this._timeScale||0!==this._timeOffset){var s=this._animationState.playTimes,r=s*this._duration;t*=this._timeScale,0!==this._timeOffset&&(t+=this._timeOffset*this._animationData.duration),s>0&&(t>=r||t<=-r)?(this.playState<=0&&3===this._animationState._playheadState&&(this.playState=1),this.currentPlayTimes=s,this.currentTime=t<0?0:this._duration+1e-6):(0!==this.playState&&3===this._animationState._playheadState&&(this.playState=0),t<0?(t=-t,this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=this._duration-t%this._duration):(this.currentPlayTimes=Math.floor(t/this._duration),this.currentTime=t%this._duration)),this.currentTime+=this._position}else this.playState=this._actionTimeline.playState,this.currentPlayTimes=this._actionTimeline.currentPlayTimes,this.currentTime=this._actionTimeline.currentTime;return(this.currentPlayTimes!==i||this.currentTime!==n)&&((e<0&&this.playState!==e||this.playState<=0&&this.currentPlayTimes!==i)&&(this._frameIndex=-1),!0)},e.prototype.init=function(t,e,i){this._armature=t,this._animationState=e,this._timelineData=i,this._actionTimeline=this._animationState._actionTimeline,this===this._actionTimeline&&(this._actionTimeline=null),this._animationData=this._animationState._animationData,this._frameRate=this._animationData.parent.frameRate,this._frameRateR=1/this._frameRate,this._position=this._animationState._position,this._duration=this._animationState._duration,this._dragonBonesData=this._animationData.parent.parent,null!==this._timelineData&&(this._frameIntArray=this._dragonBonesData.frameIntArray,this._frameFloatArray=this._dragonBonesData.frameFloatArray,this._frameArray=this._dragonBonesData.frameArray,this._timelineArray=this._dragonBonesData.timelineArray,this._frameIndices=this._dragonBonesData.frameIndices,this._frameCount=this._timelineArray[this._timelineData.offset+2],this._frameValueOffset=this._timelineArray[this._timelineData.offset+4],this._timeScale=100/this._timelineArray[this._timelineData.offset+0],this._timeOffset=.01*this._timelineArray[this._timelineData.offset+1])},e.prototype.fadeOut=function(){},e.prototype.update=function(t){if(this._setCurrentTime(t)){if(this._frameCount>1){var e=Math.floor(this.currentTime*this._frameRate),i=this._frameIndices[this._timelineData.frameIndicesOffset+e];this._frameIndex!==i&&(this._frameIndex=i,this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex],this._onArriveAtFrame())}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5]),this._onArriveAtFrame());0!==this._tweenState&&this._onUpdateFrame()}},e}(t.BaseObject);t.TimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e._getEasingValue=function(t,e,i){var n=e;switch(t){case 3:n=Math.pow(e,2);break;case 4:n=1-Math.pow(1-e,2);break;case 5:n=.5*(1-Math.cos(e*Math.PI))}return(n-e)*i+e},e._getEasingCurveValue=function(t,e,i,n){if(t<=0)return 0;if(t>=1)return 1;var s=i+1,r=Math.floor(t*s),o=0===r?0:e[n+r-1];return 1e-4*(o+((r===s-1?1e4:e[n+r])-o)*(t*s-r))},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._tweenType=0,this._curveCount=0,this._framePosition=0,this._frameDurationR=0,this._tweenProgress=0,this._tweenEasing=0},e.prototype._onArriveAtFrame=function(){if(this._frameCount>1&&(this._frameIndex!==this._frameCount-1||0===this._animationState.playTimes||this._animationState.currentPlayTimes<this._animationState.playTimes-1))if(this._tweenType=this._frameArray[this._frameOffset+1],this._tweenState=0===this._tweenType?1:2,2===this._tweenType?this._curveCount=this._frameArray[this._frameOffset+2]:0!==this._tweenType&&1!==this._tweenType&&(this._tweenEasing=.01*this._frameArray[this._frameOffset+2]),this._framePosition=this._frameArray[this._frameOffset]*this._frameRateR,this._frameIndex===this._frameCount-1)this._frameDurationR=1/(this._animationData.duration-this._framePosition);else{var t=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+this._frameIndex+1],e=this._frameArray[t]*this._frameRateR-this._framePosition;this._frameDurationR=e>0?1/e:0}else this._tweenState=1},e.prototype._onUpdateFrame=function(){2===this._tweenState?(this._tweenProgress=(this.currentTime-this._framePosition)*this._frameDurationR,2===this._tweenType?this._tweenProgress=e._getEasingCurveValue(this._tweenProgress,this._frameArray,this._curveCount,this._frameOffset+3):1!==this._tweenType&&(this._tweenProgress=e._getEasingValue(this._tweenType,this._tweenProgress,this._tweenEasing))):this._tweenProgress=0},e}(e);t.TweenTimelineState=i;var n=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.bone=null,this.bonePose=null},e.prototype.blend=function(t){var e=this.bone._blendState.blendWeight,i=this.bone.animationPose,n=this.bonePose.result;2===t?(i.x+=n.x*e,i.y+=n.y*e,i.rotation+=n.rotation*e,i.skew+=n.skew*e,i.scaleX+=(n.scaleX-1)*e,i.scaleY+=(n.scaleY-1)*e):1!==e?(i.x=n.x*e,i.y=n.y*e,i.rotation=n.rotation*e,i.skew=n.skew*e,i.scaleX=(n.scaleX-1)*e+1,i.scaleY=(n.scaleY-1)*e+1):(i.x=n.x,i.y=n.y,i.rotation=n.rotation,i.skew=n.skew,i.scaleX=n.scaleX,i.scaleY=n.scaleY),0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.bone._transformDirty=!0)},e}(i);t.BoneTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.slot=null},e}(i);t.SlotTimelineState=s;var r=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.prototype._onClear=function(){t.prototype._onClear.call(this),this.constraint=null},e}(i);t.ConstraintTimelineState=r}(nat||(nat={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.toString=function(){return"[class dragonBones.ActionTimelineState]"},i.prototype._onCrossFrame=function(e){var i=this._armature.eventDispatcher;if(this._animationState.actionEnabled)for(var n=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5+e],s=this._frameArray[n+1],r=this._animationData.parent.actions,o=0;o<s;++o){var a=r[this._frameArray[n+2+o]];if(0===a.type)(l=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,l.animationState=this._animationState,t.EventObject.actionDataToInstance(a,l,this._armature),this._armature._bufferAction(l,!0);else{var l,c=10===a.type?t.EventObject.FRAME_EVENT:t.EventObject.SOUND_EVENT;(11===a.type||i.hasDBEventListener(c))&&((l=t.BaseObject.borrowObject(t.EventObject)).time=this._frameArray[n]/this._frameRate,l.animationState=this._animationState,t.EventObject.actionDataToInstance(a,l,this._armature),this._armature._dragonBones.bufferEvent(l))}}},i.prototype._onArriveAtFrame=function(){},i.prototype._onUpdateFrame=function(){},i.prototype.update=function(e){var i=this.playState,n=this.currentPlayTimes,s=this.currentTime;if(this._setCurrentTime(e)){var r=this._armature.eventDispatcher;if(i<0){if(this.playState===i)return;if(this._animationState.displayControl&&this._animationState.resetToPose&&this._armature._sortZOrder(null,0),n=this.currentPlayTimes,r.hasDBEventListener(t.EventObject.START)){var o=t.BaseObject.borrowObject(t.EventObject);o.type=t.EventObject.START,o.armature=this._armature,o.animationState=this._animationState,this._armature._dragonBones.bufferEvent(o)}}var a=this._animationState.timeScale<0,l=null,c=null;if(this.currentPlayTimes!==n&&(r.hasDBEventListener(t.EventObject.LOOP_COMPLETE)&&((l=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.LOOP_COMPLETE,l.armature=this._armature,l.animationState=this._animationState),this.playState>0&&r.hasDBEventListener(t.EventObject.COMPLETE)&&((c=t.BaseObject.borrowObject(t.EventObject)).type=t.EventObject.COMPLETE,c.armature=this._armature,c.animationState=this._animationState)),this._frameCount>1){var h=this._timelineData,_=Math.floor(this.currentTime*this._frameRate),u=this._frameIndices[h.frameIndicesOffset+_];if(this._frameIndex!==u){var m=this._frameIndex;if(this._frameIndex=u,null!==this._timelineArray)if(this._frameOffset=this._animationData.frameOffset+this._timelineArray[h.offset+5+this._frameIndex],a){if(m<0){var p=Math.floor(s*this._frameRate);m=this._frameIndices[h.frameIndicesOffset+p],this.currentPlayTimes===n&&m===u&&(m=-1)}for(;m>=0;){var d=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[d]/this._frameRate;if(this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(m),null!==l&&0===m&&(this._armature._dragonBones.bufferEvent(l),l=null),m>0?m--:m=this._frameCount-1,m===u)break}}else for(m<0&&(p=Math.floor(s*this._frameRate),m=this._frameIndices[h.frameIndicesOffset+p],d=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[d]/this._frameRate,this.currentPlayTimes===n&&(s<=f?m>0?m--:m=this._frameCount-1:m===u&&(m=-1)));m>=0&&(m<this._frameCount-1?m++:m=0,d=this._animationData.frameOffset+this._timelineArray[h.offset+5+m],f=this._frameArray[d]/this._frameRate,this._position<=f&&f<=this._position+this._duration&&this._onCrossFrame(m),null!==l&&0===m&&(this._armature._dragonBones.bufferEvent(l),l=null),m!==u););}}else this._frameIndex<0&&(this._frameIndex=0,null!==this._timelineData)&&(this._frameOffset=this._animationData.frameOffset+this._timelineArray[this._timelineData.offset+5],f=this._frameArray[this._frameOffset]/this._frameRate,this.currentPlayTimes===n?s<=f&&this._onCrossFrame(this._frameIndex):this._position<=f&&(a||null===l||(this._armature._dragonBones.bufferEvent(l),l=null),this._onCrossFrame(this._frameIndex)));null!==l&&this._armature._dragonBones.bufferEvent(l),null!==c&&this._armature._dragonBones.bufferEvent(c)}},i.prototype.setCurrentTime=function(t){this._setCurrentTime(t),this._frameIndex=-1},i}(t.TimelineState);t.ActionTimelineState=e;var i=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.ZOrderTimelineState]"},e.prototype._onArriveAtFrame=function(){this.playState>=0&&(this._frameArray[this._frameOffset+1]>0?this._armature._sortZOrder(this._frameArray,this._frameOffset+2):this._armature._sortZOrder(null,0))},e.prototype._onUpdateFrame=function(){},e}(t.TimelineState);t.ZOrderTimelineState=i;var n=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.toString=function(){return"[class dragonBones.BoneAllTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var t=this._animationData.frameFloatOffset+this._frameValueOffset+6*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[t++]*i,s.y=n[t++]*i,s.rotation=n[t++],s.skew=n[t++],s.scaleX=n[t++],s.scaleY=n[t++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(t=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[t++]*i-s.x,r.y=n[t++]*i-s.y,r.rotation=n[t++]-s.rotation,r.skew=n[t++]-s.skew,r.scaleX=n[t++]-s.scaleX,r.scaleY=n[t++]-s.scaleY):(r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,s.rotation=0,s.skew=0,s.scaleX=1,s.scaleY=1,r.x=0,r.y=0,r.rotation=0,r.skew=0,r.scaleX=0,r.scaleY=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=t.x+i.x*this._tweenProgress,n.y=t.y+i.y*this._tweenProgress,n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress,n.scaleX=t.scaleX+i.scaleX*this._tweenProgress,n.scaleY=t.scaleY+i.scaleY*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneAllTimelineState=n;var s=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.BoneTranslateTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._armature._armatureData.scale,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.x=n[e++]*i,s.y=n[e++]*i,2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),r.x=n[e++]*i-s.x,r.y=n[e++]*i-s.y):(r.x=0,r.y=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.x=0,s.y=0,r.x=0,r.y=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.x=e.x+i.x*this._tweenProgress,n.y=e.y+i.y*this._tweenProgress},e}(t.BoneTimelineState);t.BoneTranslateTimelineState=s;var r=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.toString=function(){return"[class dragonBones.BoneRotateTimelineState]"},i.prototype._onArriveAtFrame=function(){if(e.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var i=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameFloatArray,s=this.bonePose.current,r=this.bonePose.delta;s.rotation=n[i++],s.skew=n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1?(i=this._animationData.frameFloatOffset+this._frameValueOffset,r.rotation=t.Transform.normalizeRadian(n[i++]-s.rotation)):r.rotation=n[i++]-s.rotation,r.skew=n[i++]-s.skew):(r.rotation=0,r.skew=0)}else s=this.bonePose.current,r=this.bonePose.delta,s.rotation=0,s.skew=0,r.rotation=0,r.skew=0},i.prototype._onUpdateFrame=function(){e.prototype._onUpdateFrame.call(this);var t=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.rotation=t.rotation+i.rotation*this._tweenProgress,n.skew=t.skew+i.skew*this._tweenProgress},i.prototype.fadeOut=function(){var e=this.bonePose.result;e.rotation=t.Transform.normalizeRadian(e.rotation),e.skew=t.Transform.normalizeRadian(e.skew)},i}(t.BoneTimelineState);t.BoneRotateTimelineState=r;var o=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.BoneScaleTimelineState]"},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+2*this._frameIndex,i=this._frameFloatArray,n=this.bonePose.current,s=this.bonePose.delta;n.scaleX=i[e++],n.scaleY=i[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameFloatOffset+this._frameValueOffset),s.scaleX=i[e++]-n.scaleX,s.scaleY=i[e++]-n.scaleY):(s.scaleX=0,s.scaleY=0)}else n=this.bonePose.current,s=this.bonePose.delta,n.scaleX=1,n.scaleY=1,s.scaleX=0,s.scaleY=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this);var e=this.bonePose.current,i=this.bonePose.delta,n=this.bonePose.result;this.bone._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0),n.scaleX=e.scaleX+i.scaleX*this._tweenProgress,n.scaleY=e.scaleY+i.scaleY*this._tweenProgress},e}(t.BoneTimelineState);t.BoneScaleTimelineState=o;var a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.SurfaceTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.surface=null,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this.surface._transformDirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else this._deformCount=this.surface._deformVertices.length,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0;this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var r=0;r<this._valueCount;++r)this._delta[r]=0},e.prototype.blend=function(t){for(var e=this.surface._blendState.blendWeight,i=this.surface._deformVertices,n=0;n<this._deformCount;++n){var s;s=n<this._valueOffset?this._frameFloatArray[this._frameFloatOffset+n]:n<this._valueOffset+this._valueCount?this._result[n-this._valueOffset]:this._frameFloatArray[this._frameFloatOffset+n-this._valueCount],2===t?i[n]+=s*e:i[n]=1!==e?s*e:s}0===this._animationState._fadeState&&0===this._animationState._subFadeState||(this.surface._transformDirty=!0)},e}(t.TweenTimelineState);t.SurfaceTimelineState=a;var l=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.SlotDislayTimelineState]"},e.prototype._onArriveAtFrame=function(){if(this.playState>=0){var t=null!==this._timelineData?this._frameArray[this._frameOffset+1]:this.slot._slotData.displayIndex;this.slot.displayIndex!==t&&this.slot._setDisplayIndex(t,!0)}},e}(t.SlotTimelineState);t.SlotDislayTimelineState=l;var c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[0,0,0,0,0,0,0,0],e._delta=[0,0,0,0,0,0,0,0],e._result=[0,0,0,0,0,0,0,0],e}return iat(e,t),e.toString=function(){return"[class dragonBones.SlotColorTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._dirty=!1},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._dragonBonesData.intArray,i=this._frameIntArray,n=this._animationData.frameIntOffset+this._frameValueOffset+1*this._frameIndex,s=i[n];s<0&&(s+=65536),this._current[0]=e[s++],this._current[1]=e[s++],this._current[2]=e[s++],this._current[3]=e[s++],this._current[4]=e[s++],this._current[5]=e[s++],this._current[6]=e[s++],this._current[7]=e[s++],2===this._tweenState&&((s=this._frameIndex===this._frameCount-1?i[this._animationData.frameIntOffset+this._frameValueOffset]:i[n+1])<0&&(s+=65536),this._delta[0]=e[s++]-this._current[0],this._delta[1]=e[s++]-this._current[1],this._delta[2]=e[s++]-this._current[2],this._delta[3]=e[s++]-this._current[3],this._delta[4]=e[s++]-this._current[4],this._delta[5]=e[s++]-this._current[5],this._delta[6]=e[s++]-this._current[6],this._delta[7]=e[s++]-this._current[7])}else{var r=this.slot._slotData.color;this._current[0]=100*r.alphaMultiplier,this._current[1]=100*r.redMultiplier,this._current[2]=100*r.greenMultiplier,this._current[3]=100*r.blueMultiplier,this._current[4]=r.alphaOffset,this._current[5]=r.redOffset,this._current[6]=r.greenOffset,this._current[7]=r.blueOffset}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0),this._result[0]=.01*(this._current[0]+this._delta[0]*this._tweenProgress),this._result[1]=.01*(this._current[1]+this._delta[1]*this._tweenProgress),this._result[2]=.01*(this._current[2]+this._delta[2]*this._tweenProgress),this._result[3]=.01*(this._current[3]+this._delta[3]*this._tweenProgress),this._result[4]=this._current[4]+this._delta[4]*this._tweenProgress,this._result[5]=this._current[5]+this._delta[5]*this._tweenProgress,this._result[6]=this._current[6]+this._delta[6]*this._tweenProgress,this._result[7]=this._current[7]+this._delta[7]*this._tweenProgress},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){if(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty){var i=this.slot._colorTransform;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){if(i.alphaMultiplier!==this._result[0]||i.redMultiplier!==this._result[1]||i.greenMultiplier!==this._result[2]||i.blueMultiplier!==this._result[3]||i.alphaOffset!==this._result[4]||i.redOffset!==this._result[5]||i.greenOffset!==this._result[6]||i.blueOffset!==this._result[7]){var n=Math.pow(this._animationState._fadeProgress,4);i.alphaMultiplier+=(this._result[0]-i.alphaMultiplier)*n,i.redMultiplier+=(this._result[1]-i.redMultiplier)*n,i.greenMultiplier+=(this._result[2]-i.greenMultiplier)*n,i.blueMultiplier+=(this._result[3]-i.blueMultiplier)*n,i.alphaOffset+=(this._result[4]-i.alphaOffset)*n,i.redOffset+=(this._result[5]-i.redOffset)*n,i.greenOffset+=(this._result[6]-i.greenOffset)*n,i.blueOffset+=(this._result[7]-i.blueOffset)*n,this.slot._colorDirty=!0}}else this._dirty&&(this._dirty=!1,i.alphaMultiplier===this._result[0]&&i.redMultiplier===this._result[1]&&i.greenMultiplier===this._result[2]&&i.blueMultiplier===this._result[3]&&i.alphaOffset===this._result[4]&&i.redOffset===this._result[5]&&i.greenOffset===this._result[6]&&i.blueOffset===this._result[7]||(i.alphaMultiplier=this._result[0],i.redMultiplier=this._result[1],i.greenMultiplier=this._result[2],i.blueMultiplier=this._result[3],i.alphaOffset=this._result[4],i.redOffset=this._result[5],i.greenOffset=this._result[6],i.blueOffset=this._result[7],this.slot._colorDirty=!0))}},e}(t.SlotTimelineState);t.SlotColorTimelineState=c;var h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._current=[],e._delta=[],e._result=[],e}return iat(e,t),e.toString=function(){return"[class dragonBones.DeformTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.vertexOffset=0,this._dirty=!1,this._frameFloatOffset=0,this._valueCount=0,this._deformCount=0,this._valueOffset=0,this._current.length=0,this._delta.length=0,this._result.length=0},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameFloatOffset+this._frameValueOffset+this._frameIndex*this._valueCount,i=this._armature._armatureData.scale,n=this._frameFloatArray;if(2===this._tweenState){var s=e+this._valueCount;this._frameIndex===this._frameCount-1&&(s=this._animationData.frameFloatOffset+this._frameValueOffset);for(var r=0;r<this._valueCount;++r)this._delta[r]=n[s+r]*i-(this._current[r]=n[e+r]*i)}else for(r=0;r<this._valueCount;++r)this._current[r]=n[e+r]*i}else for(r=0;r<this._valueCount;++r)this._current[r]=0},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),this._dirty=!0,2!==this._tweenState&&(this._tweenState=0);for(var e=0;e<this._valueCount;++e)this._result[e]=this._current[e]+this._delta[e]*this._tweenProgress},e.prototype.init=function(e,i,n){if(t.prototype.init.call(this,e,i,n),null!==this._timelineData){var s=this._animationData.frameIntOffset+this._timelineArray[this._timelineData.offset+3];this.vertexOffset=this._frameIntArray[s+0],this.vertexOffset<0&&(this.vertexOffset+=65536),this._deformCount=this._frameIntArray[s+1],this._valueCount=this._frameIntArray[s+2],this._valueOffset=this._frameIntArray[s+3],this._frameFloatOffset=this._frameIntArray[s+4]+this._animationData.frameFloatOffset}else{var r=this.slot._deformVertices;this._deformCount=null!==r?r.vertices.length:0,this._valueCount=this._deformCount,this._valueOffset=0,this._frameFloatOffset=0}this._current.length=this._valueCount,this._delta.length=this._valueCount,this._result.length=this._valueCount;for(var o=0;o<this._valueCount;++o)this._delta[o]=0},e.prototype.fadeOut=function(){this._tweenState=0,this._dirty=!1},e.prototype.update=function(e){var i=this.slot._deformVertices;if(null!==i&&null!==i.verticesData&&i.verticesData.offset===this.vertexOffset&&(t.prototype.update.call(this,e),0!==this._tweenState||this._dirty)){var n=i.vertices;if(0!==this._animationState._fadeState||0!==this._animationState._subFadeState){for(var s=Math.pow(this._animationState._fadeProgress,2),r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]+=(this._frameFloatArray[this._frameFloatOffset+r]-n[r])*s:r<this._valueOffset+this._valueCount?n[r]+=(this._result[r-this._valueOffset]-n[r])*s:n[r]+=(this._frameFloatArray[this._frameFloatOffset+r-this._valueCount]-n[r])*s;i.verticesDirty=!0}else if(this._dirty){for(this._dirty=!1,r=0;r<this._deformCount;++r)r<this._valueOffset?n[r]=this._frameFloatArray[this._frameFloatOffset+r]:r<this._valueOffset+this._valueCount?n[r]=this._result[r-this._valueOffset]:n[r]=this._frameFloatArray[this._frameFloatOffset+r-this._valueCount];i.verticesDirty=!0}}},e}(t.SlotTimelineState);t.DeformTimelineState=h;var _=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.toString=function(){return"[class dragonBones.IKConstraintTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this._current=0,this._delta=0},e.prototype._onArriveAtFrame=function(){t.prototype._onArriveAtFrame.call(this);var e=this.constraint;if(null!==this._timelineData){var i=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,n=this._frameIntArray,s=0!==n[i++];this._current=.01*n[i++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(i=this._animationData.frameIntOffset+this._frameValueOffset),this._delta=.01*n[i+1]-this._current):this._delta=0,e._bendPositive=s}else{var r=e._constraintData;this._current=r.weight,this._delta=0,e._bendPositive=r.bendPositive}e.invalidUpdate()},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0);var e=this.constraint;e._weight=this._current+this._delta*this._tweenProgress,e.invalidUpdate()},e}(t.ConstraintTimelineState);t.IKConstraintTimelineState=_;var u=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e._floats=[0,0,0,0,0,0],e}return iat(e,t),e.toString=function(){return"[class dragonBones.AnimationTimelineState]"},e.prototype._onClear=function(){t.prototype._onClear.call(this),this.animationState=null},e.prototype._onArriveAtFrame=function(){if(t.prototype._onArriveAtFrame.call(this),null!==this._timelineData){var e=this._animationData.frameIntOffset+this._frameValueOffset+2*this._frameIndex,i=1/this.animationState._animationData.parent.frameRate,n=this._frameIntArray;this._floats[0]=n[e++]*i,this._floats[3]=.01*n[e++],2===this._tweenState?(this._frameIndex===this._frameCount-1&&(e=this._animationData.frameIntOffset+this._frameValueOffset),this._floats[1]=n[e++]*i-this._floats[0],this._floats[4]=.01*n[e++]-this._floats[3]):(this._floats[1]=0,this._floats[4]=0)}},e.prototype._onUpdateFrame=function(){t.prototype._onUpdateFrame.call(this),2!==this._tweenState&&(this._tweenState=0),this._floats[0]>=0&&(this._floats[2]=this._floats[0]+this._floats[1]*this._tweenProgress),this._floats[5]=this._floats[3]+this._floats[4]*this._tweenProgress},e.prototype.blend=function(t){var e=this.animationState,i=e._blendState.blendWeight;2===t?(e.weight+=this._floats[5]*i,e.currentTime+=this._floats[2]*i):(e.weight=this._floats[5]*i,e.currentTime=this._floats[2]*i)},e}(t.TweenTimelineState);t.AnimationTimelineState=u}(nat||(nat={})),function(t){var e=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return iat(e,t),e.actionDataToInstance=function(t,i,n){0===t.type?i.type=e.FRAME_EVENT:i.type=10===t.type?e.FRAME_EVENT:e.SOUND_EVENT,i.name=t.name,i.armature=n,i.actionData=t,i.data=t.data,null!==t.bone&&(i.bone=n.getBone(t.bone.name)),null!==t.slot&&(i.slot=n.getSlot(t.slot.name))},e.toString=function(){return"[class dragonBones.EventObject]"},e.prototype._onClear=function(){this.time=0,this.type="",this.name="",this.armature=null,this.bone=null,this.slot=null,this.animationState=null,this.actionData=null,this.data=null},e.START="start",e.LOOP_COMPLETE="loopComplete",e.COMPLETE="complete",e.FADE_IN="fadeIn",e.FADE_IN_COMPLETE="fadeInComplete",e.FADE_OUT="fadeOut",e.FADE_OUT_COMPLETE="fadeOutComplete",e.FRAME_EVENT="frameEvent",e.SOUND_EVENT="soundEvent",e}(t.BaseObject);t.EventObject=e}(nat||(nat={})),function(t){var e=function(){function e(){}return e._getArmatureType=function(t){switch(t.toLowerCase()){case"stage":return 2;case"armature":return 0;case"movieclip":return 1;default:return 0}},e._getBoneType=function(t){switch(t.toLowerCase()){case"bone":return 0;case"surface":return 1;default:return 0}},e._getDisplayType=function(t){switch(t.toLowerCase()){case"image":return 0;case"mesh":return 2;case"armature":return 1;case"boundingbox":return 3;case"path":return 4;default:return 0}},e._getBoundingBoxType=function(t){switch(t.toLowerCase()){case"rectangle":return 0;case"ellipse":return 1;case"polygon":return 2;default:return 0}},e._getActionType=function(t){switch(t.toLowerCase()){case"play":return 0;case"frame":return 10;case"sound":return 11;default:return 0}},e._getBlendMode=function(t){switch(t.toLowerCase()){case"normal":return 0;case"add":return 1;case"alpha":return 2;case"darken":return 3;case"difference":return 4;case"erase":return 5;case"hardlight":return 6;case"invert":return 7;case"layer":return 8;case"lighten":return 9;case"multiply":return 10;case"overlay":return 11;case"screen":return 12;case"subtract":return 13;default:return 0}},e._getPositionMode=function(t){switch(t.toLocaleLowerCase()){case"percent":return 1;case"fixed":return 0;default:return 1}},e._getSpacingMode=function(t){switch(t.toLocaleLowerCase()){case"length":return 0;case"percent":return 2;case"fixed":return 1;default:return 0}},e._getRotateMode=function(t){switch(t.toLocaleLowerCase()){case"tangent":return 0;case"chain":return 1;case"chainscale":return 2;default:return 0}},e.parseDragonBonesData=function(e){return console.warn("Deprecated."),e instanceof ArrayBuffer?t.BinaryDataParser.getInstance().parseDragonBonesData(e):t.ObjectDataParser.getInstance().parseDragonBonesData(e)},e.parseTextureAtlasData=function(i,n){void 0===n&&(n=1),console.warn("");for(var s={},r=i[e.SUB_TEXTURE],o=0,a=r.length;o<a;o++){var l=r[o],c=l[e.NAME],h=new t.Rectangle,_=null;h.x=l[e.X]/n,h.y=l[e.Y]/n,h.width=l[e.WIDTH]/n,h.height=l[e.HEIGHT]/n,e.FRAME_WIDTH in l&&((_=new t.Rectangle).x=l[e.FRAME_X]/n,_.y=l[e.FRAME_Y]/n,_.width=l[e.FRAME_WIDTH]/n,_.height=l[e.FRAME_HEIGHT]/n),s[c]={region:h,frame:_,rotated:!1}}return s},e.DATA_VERSION_2_3="2.3",e.DATA_VERSION_3_0="3.0",e.DATA_VERSION_4_0="4.0",e.DATA_VERSION_4_5="4.5",e.DATA_VERSION_5_0="5.0",e.DATA_VERSION_5_5="5.5",e.DATA_VERSION=e.DATA_VERSION_5_5,e.DATA_VERSIONS=[e.DATA_VERSION_4_0,e.DATA_VERSION_4_5,e.DATA_VERSION_5_0,e.DATA_VERSION_5_5],e.TEXTURE_ATLAS="textureAtlas",e.SUB_TEXTURE="SubTexture",e.FORMAT="format",e.IMAGE_PATH="imagePath",e.WIDTH="width",e.HEIGHT="height",e.ROTATED="rotated",e.FRAME_X="frameX",e.FRAME_Y="frameY",e.FRAME_WIDTH="frameWidth",e.FRAME_HEIGHT="frameHeight",e.DRADON_BONES="dragonBones",e.USER_DATA="userData",e.ARMATURE="armature",e.BONE="bone",e.SURFACE="surface",e.SLOT="slot",e.CONSTRAINT="constraint",e.IK="ik",e.PATH_CONSTRAINT="path",e.SKIN="skin",e.DISPLAY="display",e.ANIMATION="animation",e.Z_ORDER="zOrder",e.FFD="ffd",e.FRAME="frame",e.TRANSLATE_FRAME="translateFrame",e.ROTATE_FRAME="rotateFrame",e.SCALE_FRAME="scaleFrame",e.DISPLAY_FRAME="displayFrame",e.COLOR_FRAME="colorFrame",e.DEFAULT_ACTIONS="defaultActions",e.ACTIONS="actions",e.EVENTS="events",e.INTS="ints",e.FLOATS="floats",e.STRINGS="strings",e.CANVAS="canvas",e.TRANSFORM="transform",e.PIVOT="pivot",e.AABB="aabb",e.COLOR="color",e.VERSION="version",e.COMPATIBLE_VERSION="compatibleVersion",e.FRAME_RATE="frameRate",e.TYPE="type",e.SUB_TYPE="subType",e.NAME="name",e.PARENT="parent",e.TARGET="target",e.STAGE="stage",e.SHARE="share",e.PATH="path",e.LENGTH="length",e.DISPLAY_INDEX="displayIndex",e.BLEND_MODE="blendMode",e.INHERIT_TRANSLATION="inheritTranslation",e.INHERIT_ROTATION="inheritRotation",e.INHERIT_SCALE="inheritScale",e.INHERIT_REFLECTION="inheritReflection",e.INHERIT_ANIMATION="inheritAnimation",e.INHERIT_DEFORM="inheritDeform",e.SEGMENT_X="segmentX",e.SEGMENT_Y="segmentY",e.BEND_POSITIVE="bendPositive",e.CHAIN="chain",e.WEIGHT="weight",e.FADE_IN_TIME="fadeInTime",e.PLAY_TIMES="playTimes",e.SCALE="scale",e.OFFSET="offset",e.POSITION="position",e.DURATION="duration",e.TWEEN_EASING="tweenEasing",e.TWEEN_ROTATE="tweenRotate",e.TWEEN_SCALE="tweenScale",e.CLOCK_WISE="clockwise",e.CURVE="curve",e.SOUND="sound",e.EVENT="event",e.ACTION="action",e.X="x",e.Y="y",e.SKEW_X="skX",e.SKEW_Y="skY",e.SCALE_X="scX",e.SCALE_Y="scY",e.VALUE="value",e.ROTATE="rotate",e.SKEW="skew",e.ALPHA_OFFSET="aO",e.RED_OFFSET="rO",e.GREEN_OFFSET="gO",e.BLUE_OFFSET="bO",e.ALPHA_MULTIPLIER="aM",e.RED_MULTIPLIER="rM",e.GREEN_MULTIPLIER="gM",e.BLUE_MULTIPLIER="bM",e.UVS="uvs",e.VERTICES="vertices",e.TRIANGLES="triangles",e.WEIGHTS="weights",e.SLOT_POSE="slotPose",e.BONE_POSE="bonePose",e.GLUE_WEIGHTS="glueWeights",e.GLUE_MESHES="glueMeshes",e.BONES="bones",e.POSITION_MODE="positionMode",e.SPACING_MODE="spacingMode",e.ROTATE_MODE="rotateMode",e.SPACING="spacing",e.ROTATE_OFFSET="rotateOffset",e.ROTATE_MIX="rotateMix",e.TRANSLATE_MIX="translateMix",e.TARGET_DISPLAY="targetDisplay",e.CLOSED="closed",e.CONSTANT_SPEED="constantSpeed",e.VERTEX_COUNT="vertexCount",e.LENGTHS="lengths",e.GOTO_AND_PLAY="gotoAndPlay",e.DEFAULT_NAME="default",e}();t.DataParser=e}(nat||(nat={})),function(t){var e=function(e){function n(){var i=null!==e&&e.apply(this,arguments)||this;return i._rawTextureAtlasIndex=0,i._rawBones=[],i._data=null,i._armature=null,i._bone=null,i._surface=null,i._slot=null,i._skin=null,i._mesh=null,i._animation=null,i._timeline=null,i._rawTextureAtlases=null,i._defaultColorOffset=-1,i._prevClockwise=0,i._prevRotation=0,i._helpMatrixA=new t.Matrix,i._helpMatrixB=new t.Matrix,i._helpTransform=new t.Transform,i._helpColorTransform=new t.ColorTransform,i._helpPoint=new t.Point,i._helpArray=[],i._intArray=[],i._floatArray=[],i._frameIntArray=[],i._frameFloatArray=[],i._frameArray=[],i._timelineArray=[],i._cacheRawMeshes=[],i._cacheMeshes=[],i._actionFrames=[],i._weightSlotPose={},i._weightBonePoses={},i._cacheBones={},i._slotChildActions={},i}return iat(n,e),n._getBoolean=function(t,e,i){if(e in t){var n=t[e],s=typeof n;if("boolean"===s)return n;if("string"!==s)return!!n;switch(n){case"0":case"NaN":case"":case"false":case"null":case"undefined":return!1;default:return!0}}return i},n._getNumber=function(t,e,i){if(e in t){var n=t[e];return null===n||"NaN"===n?i:+n||0}return i},n._getString=function(e,i,n){if(i in e){var s=e[i];if("string"==typeof s){if(t.DragonBones.webAssembly)for(var r=0,o=s.length;r<o;++r)if(s.charCodeAt(r)>255)return encodeURI(s);return s}return String(s)}return n},n.prototype._getCurvePoint=function(t,e,i,n,s,r,o,a,l,c){var h=1-l,_=h*h,u=l*l,m=h*_,p=3*l*_,d=3*h*u,f=l*u;c.x=m*t+p*i+d*s+f*o,c.y=m*e+p*n+d*r+f*a},n.prototype._samplingEasingCurve=function(t,e){for(var i=t.length,n=-2,s=0,r=e.length;s<r;++s){for(var o=(s+1)/(r+1);(n+6<i?t[n+6]:1)<o;)n+=6;for(var a=n>=0&&n+6<i,l=a?t[n]:0,c=a?t[n+1]:0,h=t[n+2],_=t[n+3],u=t[n+4],m=t[n+5],p=a?t[n+6]:1,d=a?t[n+7]:1,f=0,g=1;g-f>1e-4;){var y=.5*(g+f);this._getCurvePoint(l,c,h,_,u,m,p,d,y,this._helpPoint),o-this._helpPoint.x>0?f=y:g=y}e[s]=this._helpPoint.y}},n.prototype._parseActionDataInFrame=function(e,i,n,s){t.DataParser.EVENT in e&&this._mergeActionFrame(e[t.DataParser.EVENT],i,10,n,s),t.DataParser.SOUND in e&&this._mergeActionFrame(e[t.DataParser.SOUND],i,11,n,s),t.DataParser.ACTION in e&&this._mergeActionFrame(e[t.DataParser.ACTION],i,0,n,s),t.DataParser.EVENTS in e&&this._mergeActionFrame(e[t.DataParser.EVENTS],i,10,n,s),t.DataParser.ACTIONS in e&&this._mergeActionFrame(e[t.DataParser.ACTIONS],i,0,n,s)},n.prototype._mergeActionFrame=function(e,n,s,r,o){for(var a=t.DragonBones.webAssembly?this._armature.actions.size():this._armature.actions.length,l=this._parseActionData(e,s,r,o),c=0,h=null,_=0,u=l;_<u.length;_++){var m=u[_];this._armature.addAction(m,!1)}0===this._actionFrames.length&&((h=new i).frameStart=0,this._actionFrames.push(h),h=null);for(var p=0,d=this._actionFrames;p<d.length;p++){var f=d[p];if(f.frameStart===n){h=f;break}if(f.frameStart>n)break;c++}null===h&&((h=new i).frameStart=n,this._actionFrames.splice(c+1,0,h));for(var g=0;g<l.length;++g)h.actions.push(a+g)},n.prototype._parseArmature=function(e,i){var s=t.BaseObject.borrowObject(t.ArmatureData);if(s.name=n._getString(e,t.DataParser.NAME,""),s.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,this._data.frameRate),s.scale=i,t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?s.type=t.DataParser._getArmatureType(e[t.DataParser.TYPE]):s.type=n._getNumber(e,t.DataParser.TYPE,0),0===s.frameRate&&(s.frameRate=24),this._armature=s,t.DataParser.CANVAS in e){var r=e[t.DataParser.CANVAS],o=t.BaseObject.borrowObject(t.CanvasData);t.DataParser.COLOR in r?o.hasBackground=!0:o.hasBackground=!1,o.color=n._getNumber(r,t.DataParser.COLOR,0),o.x=n._getNumber(r,t.DataParser.X,0)*s.scale,o.y=n._getNumber(r,t.DataParser.Y,0)*s.scale,o.width=n._getNumber(r,t.DataParser.WIDTH,0)*s.scale,o.height=n._getNumber(r,t.DataParser.HEIGHT,0)*s.scale,s.canvas=o}if(t.DataParser.AABB in e){var a=e[t.DataParser.AABB];s.aabb.x=n._getNumber(a,t.DataParser.X,0)*s.scale,s.aabb.y=n._getNumber(a,t.DataParser.Y,0)*s.scale,s.aabb.width=n._getNumber(a,t.DataParser.WIDTH,0)*s.scale,s.aabb.height=n._getNumber(a,t.DataParser.HEIGHT,0)*s.scale}if(t.DataParser.BONE in e)for(var l=0,c=e[t.DataParser.BONE];l<c.length;l++){var h=c[l],_=n._getString(h,t.DataParser.PARENT,""),u=this._parseBone(h);if(_.length>0){var m=s.getBone(_);null!==m?u.parent=m:(_ in this._cacheBones||(this._cacheBones[_]=[]),this._cacheBones[_].push(u))}if(u.name in this._cacheBones){for(var p=0,d=this._cacheBones[u.name];p<d.length;p++)d[p].parent=u;delete this._cacheBones[u.name]}s.addBone(u),this._rawBones.push(u)}if(t.DataParser.IK in e)for(var f=0,g=e[t.DataParser.IK];f<g.length;f++){var y=g[f];(P=this._parseIKConstraint(y))&&s.addConstraint(P)}if(s.sortBones(),t.DataParser.SLOT in e)for(var v=0,x=0,b=e[t.DataParser.SLOT];x<b.length;x++){var S=b[x];s.addSlot(this._parseSlot(S,v++))}if(t.DataParser.SKIN in e)for(var A=0,C=e[t.DataParser.SKIN];A<C.length;A++){var T=C[A];s.addSkin(this._parseSkin(T))}if(t.DataParser.PATH_CONSTRAINT in e)for(var w=0,E=e[t.DataParser.PATH_CONSTRAINT];w<E.length;w++){var P,D=E[w];(P=this._parsePathConstraint(D))&&s.addConstraint(P)}for(var I=0,R=this._cacheRawMeshes.length;I<R;++I){var M=this._cacheRawMeshes[I];t.DataParser.GLUE_WEIGHTS in M&&t.DataParser.GLUE_MESHES in M&&this._parseMeshGlue(M,this._cacheMeshes[I])}for(I=0,R=this._cacheRawMeshes.length;I<R;++I){var O=this._cacheRawMeshes[I],B=n._getString(O,t.DataParser.SHARE,"");if(0!==B.length){var N=n._getString(O,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME);0===N.length&&(N=t.DataParser.DEFAULT_NAME);var L=s.getMesh(N,"",B);null!==L&&this._cacheMeshes[I].vertices.shareFrom(L.vertices)}}if(t.DataParser.ANIMATION in e)for(var F=0,z=e[t.DataParser.ANIMATION];F<z.length;F++){var V=z[F],U=this._parseAnimation(V);s.addAnimation(U)}if(t.DataParser.DEFAULT_ACTIONS in e)for(var G=0,k=this._parseActionData(e[t.DataParser.DEFAULT_ACTIONS],0,null,null);G<k.length;G++){var H=k[G];s.addAction(H,!0),0===H.type&&null!==(U=s.getAnimation(H.name))&&(s.defaultAnimation=U)}if(t.DataParser.ACTIONS in e)for(var j=0,W=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);j<W.length;j++)H=W[j],s.addAction(H,!1);for(var q in this._rawBones.length=0,this._cacheRawMeshes.length=0,this._cacheMeshes.length=0,this._armature=null,this._weightSlotPose)delete this._weightSlotPose[q];for(var q in this._weightBonePoses)delete this._weightBonePoses[q];for(var q in this._cacheBones)delete this._cacheBones[q];for(var q in this._slotChildActions)delete this._slotChildActions[q];return s},n.prototype._parseBone=function(e){var i=this._armature.scale;if(0===(t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getBoneType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,0))){var s=t.BaseObject.borrowObject(t.BoneData);return s.inheritTranslation=n._getBoolean(e,t.DataParser.INHERIT_TRANSLATION,!0),s.inheritRotation=n._getBoolean(e,t.DataParser.INHERIT_ROTATION,!0),s.inheritScale=n._getBoolean(e,t.DataParser.INHERIT_SCALE,!0),s.inheritReflection=n._getBoolean(e,t.DataParser.INHERIT_REFLECTION,!0),s.length=n._getNumber(e,t.DataParser.LENGTH,0)*i,s.name=n._getString(e,t.DataParser.NAME,""),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],s.transform,i),s}var r=t.BaseObject.borrowObject(t.SurfaceData);if(r.name=n._getString(e,t.DataParser.NAME,""),r.segmentX=n._getNumber(e,t.DataParser.SEGMENT_X,0),r.segmentY=n._getNumber(e,t.DataParser.SEGMENT_Y,0),r.vertices.length=(r.segmentX+1)*(r.segmentY+1)*2,t.DataParser.VERTICES in e)for(var o=e[t.DataParser.VERTICES],a=0,l=r.vertices.length;a<l;++a)a<o.length?r.vertices[a]=o[a]*i:r.vertices[a]=0;return r},n.prototype._parseIKConstraint=function(e){var i=this._armature.getBone(n._getString(e,t.DataParser.BONE,""));if(null===i)return null;var s=this._armature.getBone(n._getString(e,t.DataParser.TARGET,""));if(null===s)return null;var r=t.BaseObject.borrowObject(t.IKConstraintData);return r.scaleEnabled=n._getBoolean(e,t.DataParser.SCALE,!1),r.bendPositive=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0),r.weight=n._getNumber(e,t.DataParser.WEIGHT,1),r.name=n._getString(e,t.DataParser.NAME,""),r.type=0,r.target=s,n._getNumber(e,t.DataParser.CHAIN,0)>0&&null!==i.parent?(r.root=i.parent,r.bone=i):(r.root=i,r.bone=null),r},n.prototype._parsePathConstraint=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.TARGET,""));if(null===i)return null;var s=this._armature.defaultSkin;if(null===s)return null;var r=s.getDisplay(i.name,n._getString(e,t.DataParser.TARGET_DISPLAY,i.name));if(null===r||!(r instanceof t.PathDisplayData))return null;var o=e[t.DataParser.BONES];if(null===o||0===o.length)return null;var a=t.BaseObject.borrowObject(t.PathConstraintData);a.name=n._getString(e,t.DataParser.NAME,""),a.type=1,a.pathSlot=i,a.pathDisplayData=r,a.target=i.parent,a.positionMode=t.DataParser._getPositionMode(n._getString(e,t.DataParser.POSITION_MODE,"")),a.spacingMode=t.DataParser._getSpacingMode(n._getString(e,t.DataParser.SPACING_MODE,"")),a.rotateMode=t.DataParser._getRotateMode(n._getString(e,t.DataParser.ROTATE_MODE,"")),a.position=n._getNumber(e,t.DataParser.POSITION,0),a.spacing=n._getNumber(e,t.DataParser.SPACING,0),a.rotateOffset=n._getNumber(e,t.DataParser.ROTATE_OFFSET,0),a.rotateMix=n._getNumber(e,t.DataParser.ROTATE_MIX,1),a.translateMix=n._getNumber(e,t.DataParser.TRANSLATE_MIX,1);for(var l=0,c=o;l<c.length;l++){var h=c[l],_=this._armature.getBone(h);null!==_&&(a.AddBone(_),null===a.root&&(a.root=_))}return a},n.prototype._parseSlot=function(e,i){var s=t.BaseObject.borrowObject(t.SlotData);return s.displayIndex=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),s.zOrder=i,s.name=n._getString(e,t.DataParser.NAME,""),s.parent=this._armature.getBone(n._getString(e,t.DataParser.PARENT,"")),t.DataParser.BLEND_MODE in e&&"string"==typeof e[t.DataParser.BLEND_MODE]?s.blendMode=t.DataParser._getBlendMode(e[t.DataParser.BLEND_MODE]):s.blendMode=n._getNumber(e,t.DataParser.BLEND_MODE,0),t.DataParser.COLOR in e?(s.color=t.SlotData.createColor(),this._parseColorTransform(e[t.DataParser.COLOR],s.color)):s.color=t.SlotData.DEFAULT_COLOR,t.DataParser.ACTIONS in e&&(this._slotChildActions[s.name]=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null)),s},n.prototype._parseSkin=function(e){var i=t.BaseObject.borrowObject(t.SkinData);if(i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),t.DataParser.SLOT in e){var s=e[t.DataParser.SLOT];this._skin=i;for(var r=0,o=s;r<o.length;r++){var a=o[r],l=n._getString(a,t.DataParser.NAME,""),c=this._armature.getSlot(l);if(null!==c){if(this._slot=c,t.DataParser.DISPLAY in a)for(var h=0,_=a[t.DataParser.DISPLAY];h<_.length;h++){var u=_[h];u?i.addDisplay(l,this._parseDisplay(u)):i.addDisplay(l,null)}this._slot=null}}this._skin=null}return i},n.prototype._parseDisplay=function(e){var i=n._getString(e,t.DataParser.NAME,""),s=n._getString(e,t.DataParser.PATH,""),r=0,o=null;switch(r=t.DataParser.TYPE in e&&"string"==typeof e[t.DataParser.TYPE]?t.DataParser._getDisplayType(e[t.DataParser.TYPE]):n._getNumber(e,t.DataParser.TYPE,r)){case 0:var a=o=t.BaseObject.borrowObject(t.ImageDisplayData);a.name=i,a.path=s.length>0?s:i,this._parsePivot(e,a);break;case 1:var l=o=t.BaseObject.borrowObject(t.ArmatureDisplayData);if(l.name=i,l.path=s.length>0?s:i,l.inheritAnimation=!0,t.DataParser.ACTIONS in e)for(var c=0,h=this._parseActionData(e[t.DataParser.ACTIONS],0,null,null);c<h.length;c++){var _=h[c];l.addAction(_)}else if(this._slot.name in this._slotChildActions){var u=this._skin.getDisplays(this._slot.name);if(null===u?0===this._slot.displayIndex:this._slot.displayIndex===u.length){for(var m=0,p=this._slotChildActions[this._slot.name];m<p.length;m++)_=p[m],l.addAction(_);delete this._slotChildActions[this._slot.name]}}break;case 2:var d=o=t.BaseObject.borrowObject(t.MeshDisplayData);d.vertices.inheritDeform=n._getBoolean(e,t.DataParser.INHERIT_DEFORM,!0),d.name=i,d.path=s.length>0?s:i,d.vertices.data=this._data,t.DataParser.SHARE in e?(this._cacheRawMeshes.push(e),this._cacheMeshes.push(d)):this._parseMesh(e,d),t.DataParser.GLUE_WEIGHTS in e&&t.DataParser.GLUE_MESHES in e&&(this._cacheRawMeshes.push(e),this._cacheMeshes.push(d));break;case 3:var f=this._parseBoundingBox(e);if(null!==f){var g=o=t.BaseObject.borrowObject(t.BoundingBoxDisplayData);g.name=i,g.path=s.length>0?s:i,g.boundingBox=f}break;case 4:var y=e[t.DataParser.LENGTHS],v=o=t.BaseObject.borrowObject(t.PathDisplayData);v.closed=n._getBoolean(e,t.DataParser.CLOSED,!1),v.constantSpeed=n._getBoolean(e,t.DataParser.CONSTANT_SPEED,!1),v.name=i,v.path=s.length>0?s:i,v.vertices.data=this._data,v.curveLengths.length=y.length;for(var x=0,b=y.length;x<b;++x)v.curveLengths[x]=y[x];this._parsePath(e,v)}return null!==o&&t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],o.transform,this._armature.scale),o},n.prototype._parsePath=function(e,i){var s=e[t.DataParser.VERTICES],r=n._getNumber(e,t.DataParser.VERTEX_COUNT,0),o=this._floatArray.length,a=this._intArray.length;if(i.vertices.offset=a,this._intArray.length+=2,this._intArray[a+0]=r,this._intArray[a+2]=o,t.DataParser.WEIGHTS in e){var l=e[t.DataParser.WEIGHTS],c=e[t.DataParser.BONES],h=c.length,_=Math.floor(l.length-r)/2,u=this._intArray.length,m=this._floatArray.length,p=this._armature.sortedBones,d=t.BaseObject.borrowObject(t.WeightData);for(d.count=_,d.offset=u,this._intArray.length+=2+h+r+_,this._intArray[u+0]=h,this._intArray[u+1]=m,P=0;P<h;P++){var f=c[P],g=this._rawBones[f];d.addBone(g),this._intArray[u+2+P]=p.indexOf(g)}this._floatArray.length+=3*_,P=0;for(var y=0,v=0,x=u+2+h,b=m;P<_;P++){var S=l[y++];this._intArray[x++]=S;for(var A=0;A<S;A++){var C=l[y++],T=l[y++],w=s[v++],E=s[v++];this._intArray[x++]=c.indexOf(C),this._floatArray[b++]=T,this._floatArray[b++]=w,this._floatArray[b++]=E}}i.vertices.weight=d}else{this._floatArray.length+=s.length;for(var P=0,D=s.length;P<D;++P)this._floatArray[o+P]=s[P]}},n.prototype._parsePivot=function(e,i){if(t.DataParser.PIVOT in e){var s=e[t.DataParser.PIVOT];i.pivot.x=n._getNumber(s,t.DataParser.X,0),i.pivot.y=n._getNumber(s,t.DataParser.Y,0)}else i.pivot.x=.5,i.pivot.y=.5},n.prototype._parseMesh=function(e,i){var n=e[t.DataParser.VERTICES],s=e[t.DataParser.UVS],r=e[t.DataParser.TRIANGLES],o=Math.floor(n.length/2),a=Math.floor(r.length/3),l=this._floatArray.length,c=l+2*o,h=this._intArray.length,_=this._skin.name+"_"+this._slot.name+"_"+i.name;i.vertices.offset=h,this._intArray.length+=4+3*a,this._intArray[h+0]=o,this._intArray[h+1]=a,this._intArray[h+2]=l;for(var u=0,m=3*a;u<m;++u)this._intArray[h+4+u]=r[u];for(this._floatArray.length+=2*o+2*o,u=0,m=2*o;u<m;++u)this._floatArray[l+u]=n[u],this._floatArray[c+u]=s[u];if(t.DataParser.WEIGHTS in e){var p=e[t.DataParser.WEIGHTS],d=e[t.DataParser.SLOT_POSE],f=e[t.DataParser.BONE_POSE],g=this._armature.sortedBones,y=new Array,v=Math.floor(f.length/7),x=this._floatArray.length,b=Math.floor(p.length-o)/2,S=this._intArray.length,A=t.BaseObject.borrowObject(t.WeightData);for(A.count=b,A.offset=S,y.length=v,this._intArray.length+=2+v+o+b,this._intArray[S+1]=x,u=0;u<v;++u){var C=f[7*u],T=this._rawBones[C];A.addBone(T),y[u]=C,this._intArray[S+2+u]=g.indexOf(T)}this._floatArray.length+=3*b,this._helpMatrixA.copyFromArray(d,0),u=0;for(var w=0,E=S+2+v,P=x;u<o;++u){var D=2*u,I=this._intArray[E++]=p[w++],R=this._floatArray[l+D],M=this._floatArray[l+D+1];this._helpMatrixA.transformPoint(R,M,this._helpPoint),R=this._helpPoint.x,M=this._helpPoint.y;for(var O=0;O<I;++O){C=p[w++];var B=y.indexOf(C);this._helpMatrixB.copyFromArray(f,7*B+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(R,M,this._helpPoint),this._intArray[E++]=B,this._floatArray[P++]=p[w++],this._floatArray[P++]=this._helpPoint.x,this._floatArray[P++]=this._helpPoint.y}}i.vertices.weight=A,this._weightSlotPose[_]=d,this._weightBonePoses[_]=f}},n.prototype._parseMeshGlue=function(){},n.prototype._parseBoundingBox=function(e){var i=null,s=0;switch(s=t.DataParser.SUB_TYPE in e&&"string"==typeof e[t.DataParser.SUB_TYPE]?t.DataParser._getBoundingBoxType(e[t.DataParser.SUB_TYPE]):n._getNumber(e,t.DataParser.SUB_TYPE,s)){case 0:i=t.BaseObject.borrowObject(t.RectangleBoundingBoxData);break;case 1:i=t.BaseObject.borrowObject(t.EllipseBoundingBoxData);break;case 2:i=this._parsePolygonBoundingBox(e)}return null!==i&&(i.color=n._getNumber(e,t.DataParser.COLOR,0),0!==i.type&&1!==i.type||(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0))),i},n.prototype._parsePolygonBoundingBox=function(e){var i=t.BaseObject.borrowObject(t.PolygonBoundingBoxData);if(t.DataParser.VERTICES in e){var n=this._armature.scale,s=e[t.DataParser.VERTICES],r=i.vertices;t.DragonBones.webAssembly?r.resize(s.length,0):r.length=s.length;for(var o=0,a=s.length;o<a;o+=2){var l=s[o]*n,c=s[o+1]*n;t.DragonBones.webAssembly?(r.set(o,l),r.set(o+1,c)):(r[o]=l,r[o+1]=c),0===o?(i.x=l,i.y=c,i.width=l,i.height=c):(l<i.x?i.x=l:l>i.width&&(i.width=l),c<i.y?i.y=c:c>i.height&&(i.height=c))}i.width-=i.x,i.height-=i.y}else console.warn("Data error.\n Please reexport DragonBones Data to fixed the bug.");return i},n.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);if(i.frameCount=Math.max(n._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=n._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=n._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=n._getNumber(e,t.DataParser.SCALE,1),i.name=n._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME),i.frameIntOffset=this._frameIntArray.length,i.frameFloatOffset=this._frameFloatArray.length,i.frameOffset=this._frameArray.length,this._animation=i,t.DataParser.FRAME in e){var s=e[t.DataParser.FRAME],r=s.length;if(r>0)for(var o=0,a=0;o<r;++o){var l=s[o];this._parseActionDataInFrame(l,a,null,null),a+=n._getNumber(l,t.DataParser.DURATION,1)}}if(t.DataParser.Z_ORDER in e&&(this._animation.zOrderTimeline=this._parseTimeline(e[t.DataParser.Z_ORDER],null,t.DataParser.FRAME,1,!1,!1,0,this._parseZOrderFrame)),t.DataParser.BONE in e)for(var c=0,h=e[t.DataParser.BONE];c<h.length;c++){var _=h[c];this._parseBoneTimeline(_)}if(t.DataParser.SURFACE in e)for(var u=0,m=e[t.DataParser.SURFACE];u<m.length;u++){_=m[u];var p=n._getString(_,t.DataParser.NAME,"");this._surface=this._armature.getBone(p),null!==this._surface&&(null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,50,!1,!0,0,this._parseSurfaceFrame))&&this._animation.addSurfaceTimeline(this._surface,P),this._surface=null)}if(t.DataParser.SLOT in e)for(var d=0,f=e[t.DataParser.SLOT];d<f.length;d++)_=f[d],this._parseSlotTimeline(_);if(t.DataParser.FFD in e)for(var g=0,y=e[t.DataParser.FFD];g<y.length;g++){_=y[g];var v=n._getString(_,t.DataParser.SKIN,t.DataParser.DEFAULT_NAME),x=n._getString(_,t.DataParser.SLOT,""),b=n._getString(_,t.DataParser.NAME,"");0===v.length&&(v=t.DataParser.DEFAULT_NAME),this._slot=this._armature.getSlot(x),this._mesh=this._armature.getMesh(v,x,b),null!==this._slot&&null!==this._mesh&&(null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,22,!1,!0,0,this._parseSlotFFDFrame))&&this._animation.addSlotTimeline(this._slot,P),this._slot=null,this._mesh=null)}if(t.DataParser.IK in e)for(var S=0,A=e[t.DataParser.IK];S<A.length;S++){_=A[S];var C=n._getString(_,t.DataParser.NAME,""),T=this._armature.getConstraint(C);null!==T&&null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,30,!0,!1,2,this._parseIKConstraintFrame))&&this._animation.addConstraintTimeline(T,P)}if(t.DataParser.ANIMATION in e)for(var w=0,E=e[t.DataParser.ANIMATION];w<E.length;w++){_=E[w];var P,D=n._getString(_,t.DataParser.NAME,"");null!==(P=this._parseTimeline(_,null,t.DataParser.FRAME,40,!0,!1,2,this._parseAnimationFrame))&&this._animation.addAnimationTimeline(D,P)}return this._actionFrames.length>0&&(this._animation.actionTimeline=this._parseTimeline(null,this._actionFrames,"",0,!1,!1,0,this._parseActionFrame),this._actionFrames.length=0),this._animation=null,i},n.prototype._parseTimeline=function(e,s,r,o,a,l,c,h){if(null!==e&&r.length>0&&r in e&&(s=e[r]),null===s)return null;var _=s.length;if(0===_)return null;var u=this._frameIntArray.length,m=this._frameFloatArray.length,p=t.BaseObject.borrowObject(t.TimelineData),d=this._timelineArray.length;if(this._timelineArray.length+=5+_,null!==e?(this._timelineArray[d+0]=Math.round(100*n._getNumber(e,t.DataParser.SCALE,1)),this._timelineArray[d+1]=Math.round(100*n._getNumber(e,t.DataParser.OFFSET,0))):(this._timelineArray[d+0]=100,this._timelineArray[d+1]=0),this._timelineArray[d+2]=_,this._timelineArray[d+3]=c,this._timelineArray[d+4]=a?u-this._animation.frameIntOffset:l?m-this._animation.frameFloatOffset:0,this._timeline=p,p.type=o,p.offset=d,1===_)p.frameIndicesOffset=-1,this._timelineArray[d+5+0]=h.call(this,s[0],0,0)-this._animation.frameOffset;else{var f=this._animation.frameCount+1,g=this._data.frameIndices,y=0;t.DragonBones.webAssembly?(y=g.size(),g.resize(y+f,0)):(y=g.length,g.length+=f),p.frameIndicesOffset=y;for(var v=0,x=0,b=0,S=0;v<f;++v){if(b+S<=v&&x<_){var A=s[x];b=v,S=x===_-1?this._animation.frameCount-b:A instanceof i?this._actionFrames[x+1].frameStart-b:n._getNumber(A,t.DataParser.DURATION,1),this._timelineArray[d+5+x]=h.call(this,A,b,S)-this._animation.frameOffset,x++}t.DragonBones.webAssembly?g.set(y+v,x-1):g[y+v]=x-1}}return this._timeline=null,p},n.prototype._parseBoneTimeline=function(e){var i,s=this._armature.getBone(n._getString(e,t.DataParser.NAME,""));null!==s&&(this._bone=s,this._slot=this._armature.getSlot(this._bone.name),t.DataParser.TRANSLATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.TRANSLATE_FRAME,11,!1,!0,2,this._parseBoneTranslateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.ROTATE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.ROTATE_FRAME,12,!1,!0,2,this._parseBoneRotateFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.SCALE_FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.SCALE_FRAME,13,!1,!0,2,this._parseBoneScaleFrame))&&this._animation.addBoneTimeline(s,i),t.DataParser.FRAME in e&&null!==(i=this._parseTimeline(e,null,t.DataParser.FRAME,10,!1,!0,6,this._parseBoneAllFrame))&&this._animation.addBoneTimeline(s,i),this._bone=null,this._slot=null)},n.prototype._parseSlotTimeline=function(e){var i=this._armature.getSlot(n._getString(e,t.DataParser.NAME,""));if(null!==i){this._slot=i;var s;null!==(s=t.DataParser.DISPLAY_FRAME in e?this._parseTimeline(e,null,t.DataParser.DISPLAY_FRAME,20,!1,!1,0,this._parseSlotDisplayFrame):this._parseTimeline(e,null,t.DataParser.FRAME,20,!1,!1,0,this._parseSlotDisplayFrame))&&this._animation.addSlotTimeline(i,s);var r;null!==(r=t.DataParser.COLOR_FRAME in e?this._parseTimeline(e,null,t.DataParser.COLOR_FRAME,21,!0,!1,1,this._parseSlotColorFrame):this._parseTimeline(e,null,t.DataParser.FRAME,21,!0,!1,1,this._parseSlotColorFrame))&&this._animation.addSlotTimeline(i,r),this._slot=null}},n.prototype._parseFrame=function(t,e){var i=this._frameArray.length;return this._frameArray.length+=1,this._frameArray[i+0]=e,i},n.prototype._parseTweenFrame=function(e,i,s){var r=this._parseFrame(e,i,s);if(s>0)if(t.DataParser.CURVE in e){var o=s+1;this._helpArray.length=o,this._samplingEasingCurve(e[t.DataParser.CURVE],this._helpArray),this._frameArray.length+=2+this._helpArray.length,this._frameArray[r+1]=2,this._frameArray[r+2]=o;for(var a=0;a<o;++a)this._frameArray[r+3+a]=Math.round(1e4*this._helpArray[a])}else{var l=-2;t.DataParser.TWEEN_EASING in e&&(l=n._getNumber(e,t.DataParser.TWEEN_EASING,-2)),-2===l?(this._frameArray.length+=1,this._frameArray[r+1]=0):0===l?(this._frameArray.length+=1,this._frameArray[r+1]=1):l<0?(this._frameArray.length+=2,this._frameArray[r+1]=3,this._frameArray[r+2]=Math.round(100*-l)):l<=1?(this._frameArray.length+=2,this._frameArray[r+1]=4,this._frameArray[r+2]=Math.round(100*l)):(this._frameArray.length+=2,this._frameArray[r+1]=5,this._frameArray[r+2]=Math.round(100*l-100))}else this._frameArray.length+=1,this._frameArray[r+1]=0;return r},n.prototype._parseActionFrame=function(t,e){var i=this._frameArray.length,n=t.actions.length;this._frameArray.length+=2+n,this._frameArray[i+0]=e,this._frameArray[i+0+1]=n;for(var s=0;s<n;++s)this._frameArray[i+0+2+s]=t.actions[s];return i},n.prototype._parseZOrderFrame=function(e,i,n){var s=this._parseFrame(e,i,n);if(t.DataParser.Z_ORDER in e){var r=e[t.DataParser.Z_ORDER];if(r.length>0){for(var o=this._armature.sortedSlots.length,a=new Array(o-r.length/2),l=new Array(o),c=0;c<a.length;++c)a[c]=0;for(var h=0;h<o;++h)l[h]=-1;for(var _=0,u=0,m=0,p=r.length;m<p;m+=2){for(var d=r[m],f=r[m+1];_!==d;)a[u++]=_++;l[_+f]=_++}for(;_<o;)a[u++]=_++;this._frameArray.length+=1+o,this._frameArray[s+1]=o;for(var g=o;g--;)-1===l[g]?this._frameArray[s+2+g]=a[--u]||0:this._frameArray[s+2+g]=l[g]||0;return s}}return this._frameArray.length+=1,this._frameArray[s+1]=0,s},n.prototype._parseBoneAllFrame=function(e,i,s){this._helpTransform.identity(),t.DataParser.TRANSFORM in e&&this._parseTransform(e[t.DataParser.TRANSFORM],this._helpTransform,1);var r=this._helpTransform.rotation;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.TWEEN_ROTATE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=6,this._frameFloatArray[a++]=this._helpTransform.x,this._frameFloatArray[a++]=this._helpTransform.y,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=this._helpTransform.skew,this._frameFloatArray[a++]=this._helpTransform.scaleX,this._frameFloatArray[a++]=this._helpTransform.scaleY,this._parseActionDataInFrame(e,i,this._bone,this._slot),o},n.prototype._parseBoneTranslateFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,0),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,0),r},n.prototype._parseBoneRotateFrame=function(e,i,s){var r=n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD;0!==i&&(0===this._prevClockwise?r=this._prevRotation+t.Transform.normalizeRadian(r-this._prevRotation):((this._prevClockwise>0?r>=this._prevRotation:r<=this._prevRotation)&&(this._prevClockwise=this._prevClockwise>0?this._prevClockwise-1:this._prevClockwise+1),r=this._prevRotation+r-this._prevRotation+t.Transform.PI_D*this._prevClockwise)),this._prevClockwise=n._getNumber(e,t.DataParser.CLOCK_WISE,0),this._prevRotation=r;var o=this._parseTweenFrame(e,i,s),a=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[a++]=r,this._frameFloatArray[a++]=n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD,o},n.prototype._parseBoneScaleFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameFloatArray.length;return this._frameFloatArray.length+=2,this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.X,1),this._frameFloatArray[o++]=n._getNumber(e,t.DataParser.Y,1),r},n.prototype._parseSurfaceFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=e[t.DataParser.VERTICES],l=n._getNumber(e,t.DataParser.OFFSET,0),c=this._surface.vertices.length/2,h=0,_=0;this._frameFloatArray.length+=2*c;for(var u=0;u<2*c;u+=2)h=u<l||u-l>=a.length?0:a[u-l],_=u+1<l||u+1-l>=a.length?0:a[u+1-l],this._frameFloatArray[r+u]=h,this._frameFloatArray[r+u+1]=_;if(0===i){var m=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[m+0]=0,this._frameIntArray[m+1]=this._frameFloatArray.length-r,this._frameIntArray[m+2]=this._frameFloatArray.length-r,this._frameIntArray[m+3]=0,this._frameIntArray[m+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=m-this._animation.frameIntOffset}return o},n.prototype._parseSlotDisplayFrame=function(e,i,s){var r=this._parseFrame(e,i,s);return this._frameArray.length+=1,t.DataParser.VALUE in e?this._frameArray[r+1]=n._getNumber(e,t.DataParser.VALUE,0):this._frameArray[r+1]=n._getNumber(e,t.DataParser.DISPLAY_INDEX,0),this._parseActionDataInFrame(e,i,this._slot.parent,this._slot),r},n.prototype._parseSlotColorFrame=function(e,i,n){var s=this._parseTweenFrame(e,i,n),r=-1;if(t.DataParser.VALUE in e||t.DataParser.COLOR in e){var o=t.DataParser.VALUE in e?e[t.DataParser.VALUE]:e[t.DataParser.COLOR];for(var a in o){this._parseColorTransform(o,this._helpColorTransform),r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=Math.round(100*this._helpColorTransform.alphaMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.redMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.greenMultiplier),this._intArray[r++]=Math.round(100*this._helpColorTransform.blueMultiplier),this._intArray[r++]=Math.round(this._helpColorTransform.alphaOffset),this._intArray[r++]=Math.round(this._helpColorTransform.redOffset),this._intArray[r++]=Math.round(this._helpColorTransform.greenOffset),this._intArray[r++]=Math.round(this._helpColorTransform.blueOffset),r-=8;break}}r<0&&(this._defaultColorOffset<0&&(this._defaultColorOffset=r=this._intArray.length,this._intArray.length+=8,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=100,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0,this._intArray[r++]=0),r=this._defaultColorOffset);var l=this._frameIntArray.length;return this._frameIntArray.length+=1,this._frameIntArray[l]=r,s},n.prototype._parseSlotFFDFrame=function(e,i,s){var r=this._frameFloatArray.length,o=this._parseTweenFrame(e,i,s),a=t.DataParser.VERTICES in e?e[t.DataParser.VERTICES]:null,l=n._getNumber(e,t.DataParser.OFFSET,0),c=this._intArray[this._mesh.vertices.offset+0],h=this._mesh.parent.name+"_"+this._slot.name+"_"+this._mesh.name,_=this._mesh.vertices.weight,u=0,m=0,p=0,d=0;if(null!==_){var f=this._weightSlotPose[h];this._helpMatrixA.copyFromArray(f,0),this._frameFloatArray.length+=2*_.count,p=_.offset+2+_.bones.length}else this._frameFloatArray.length+=2*c;for(var g=0;g<2*c;g+=2)if(null===a?(u=0,m=0):(u=g<l||g-l>=a.length?0:a[g-l],m=g+1<l||g+1-l>=a.length?0:a[g+1-l]),null!==_){var y=this._weightBonePoses[h],v=this._intArray[p++];this._helpMatrixA.transformPoint(u,m,this._helpPoint,!0),u=this._helpPoint.x,m=this._helpPoint.y;for(var x=0;x<v;++x){var b=this._intArray[p++];this._helpMatrixB.copyFromArray(y,7*b+1),this._helpMatrixB.invert(),this._helpMatrixB.transformPoint(u,m,this._helpPoint,!0),this._frameFloatArray[r+d++]=this._helpPoint.x,this._frameFloatArray[r+d++]=this._helpPoint.y}}else this._frameFloatArray[r+g]=u,this._frameFloatArray[r+g+1]=m;if(0===i){var S=this._frameIntArray.length;this._frameIntArray.length+=5,this._frameIntArray[S+0]=this._mesh.vertices.offset,this._frameIntArray[S+1]=this._frameFloatArray.length-r,this._frameIntArray[S+2]=this._frameFloatArray.length-r,this._frameIntArray[S+3]=0,this._frameIntArray[S+4]=r-this._animation.frameFloatOffset,this._timelineArray[this._timeline.offset+3]=S-this._animation.frameIntOffset}return o},n.prototype._parseIKConstraintFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getBoolean(e,t.DataParser.BEND_POSITIVE,!0)?1:0,this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseAnimationFrame=function(e,i,s){var r=this._parseTweenFrame(e,i,s),o=this._frameIntArray.length;return this._frameIntArray.length+=2,this._frameIntArray[o++]=n._getNumber(e,t.DataParser.VALUE,0),this._frameIntArray[o++]=Math.round(100*n._getNumber(e,t.DataParser.WEIGHT,1)),r},n.prototype._parseActionData=function(e,i,s,r){var o=new Array;if("string"==typeof e)(h=t.BaseObject.borrowObject(t.ActionData)).type=i,h.name=e,h.bone=s,h.slot=r,o.push(h);else if(e instanceof Array)for(var a=0,l=e;a<l.length;a++){var c=l[a],h=t.BaseObject.borrowObject(t.ActionData);if(t.DataParser.GOTO_AND_PLAY in c?(h.type=0,h.name=n._getString(c,t.DataParser.GOTO_AND_PLAY,"")):(t.DataParser.TYPE in c&&"string"==typeof c[t.DataParser.TYPE]?h.type=t.DataParser._getActionType(c[t.DataParser.TYPE]):h.type=n._getNumber(c,t.DataParser.TYPE,i),h.name=n._getString(c,t.DataParser.NAME,"")),t.DataParser.BONE in c){var _=n._getString(c,t.DataParser.BONE,"");h.bone=this._armature.getBone(_)}else h.bone=s;if(t.DataParser.SLOT in c){var u=n._getString(c,t.DataParser.SLOT,"");h.slot=this._armature.getSlot(u)}else h.slot=r;var m=null;if(t.DataParser.INTS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var p=0,d=c[t.DataParser.INTS];p<d.length;p++){var f=d[p];m.addInt(f)}}if(t.DataParser.FLOATS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var g=0,y=c[t.DataParser.FLOATS];g<y.length;g++)f=y[g],m.addFloat(f)}if(t.DataParser.STRINGS in c){null===m&&(m=t.BaseObject.borrowObject(t.UserData));for(var v=0,x=c[t.DataParser.STRINGS];v<x.length;v++)f=x[v],m.addString(f)}h.data=m,o.push(h)}return o},n.prototype._parseTransform=function(e,i,s){i.x=n._getNumber(e,t.DataParser.X,0)*s,i.y=n._getNumber(e,t.DataParser.Y,0)*s,t.DataParser.ROTATE in e||t.DataParser.SKEW in e?(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.ROTATE,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW,0)*t.Transform.DEG_RAD)):(t.DataParser.SKEW_X in e||t.DataParser.SKEW_Y in e)&&(i.rotation=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_Y,0)*t.Transform.DEG_RAD),i.skew=t.Transform.normalizeRadian(n._getNumber(e,t.DataParser.SKEW_X,0)*t.Transform.DEG_RAD)-i.rotation),i.scaleX=n._getNumber(e,t.DataParser.SCALE_X,1),i.scaleY=n._getNumber(e,t.DataParser.SCALE_Y,1)},n.prototype._parseColorTransform=function(e,i){i.alphaMultiplier=.01*n._getNumber(e,t.DataParser.ALPHA_MULTIPLIER,100),i.redMultiplier=.01*n._getNumber(e,t.DataParser.RED_MULTIPLIER,100),i.greenMultiplier=.01*n._getNumber(e,t.DataParser.GREEN_MULTIPLIER,100),i.blueMultiplier=.01*n._getNumber(e,t.DataParser.BLUE_MULTIPLIER,100),i.alphaOffset=n._getNumber(e,t.DataParser.ALPHA_OFFSET,0),i.redOffset=n._getNumber(e,t.DataParser.RED_OFFSET,0),i.greenOffset=n._getNumber(e,t.DataParser.GREEN_OFFSET,0),i.blueOffset=n._getNumber(e,t.DataParser.BLUE_OFFSET,0)},n.prototype._parseArray=function(){this._intArray.length=0,this._floatArray.length=0,this._frameIntArray.length=0,this._frameFloatArray.length=0,this._frameArray.length=0,this._timelineArray.length=0},n.prototype._modifyArray=function(){this._intArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._intArray.push(0),this._frameIntArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameIntArray.push(0),this._frameArray.length%Int16Array.BYTES_PER_ELEMENT!=0&&this._frameArray.push(0),this._timelineArray.length%Uint16Array.BYTES_PER_ELEMENT!=0&&this._timelineArray.push(0);var e=this._intArray.length*Int16Array.BYTES_PER_ELEMENT,i=this._floatArray.length*Float32Array.BYTES_PER_ELEMENT,n=this._frameIntArray.length*Int16Array.BYTES_PER_ELEMENT,s=this._frameFloatArray.length*Float32Array.BYTES_PER_ELEMENT,r=this._frameArray.length*Int16Array.BYTES_PER_ELEMENT,o=this._timelineArray.length*Uint16Array.BYTES_PER_ELEMENT,a=e+i+n+s+r+o;if(t.DragonBones.webAssembly){for(var l=t.webAssemblyModule.HEAP16.buffer,c=t.webAssemblyModule._malloc(a),h=new Int16Array(l,c,this._intArray.length),_=new Float32Array(l,c+e,this._floatArray.length),u=new Int16Array(l,c+e+i,this._frameIntArray.length),m=new Float32Array(l,c+e+i+n,this._frameFloatArray.length),p=new Int16Array(l,c+e+i+n+s,this._frameArray.length),d=new Uint16Array(l,c+e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)m[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)p[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)d[f]=this._timelineArray[f];t.webAssemblyModule.setDataBinary(this._data,c,e,i,n,s,r,o)}else{var y=new ArrayBuffer(a);for(h=new Int16Array(y,0,this._intArray.length),_=new Float32Array(y,e,this._floatArray.length),u=new Int16Array(y,e+i,this._frameIntArray.length),m=new Float32Array(y,e+i+n,this._frameFloatArray.length),p=new Int16Array(y,e+i+n+s,this._frameArray.length),d=new Uint16Array(y,e+i+n+s+r,this._timelineArray.length),f=0,g=this._intArray.length;f<g;++f)h[f]=this._intArray[f];for(f=0,g=this._floatArray.length;f<g;++f)_[f]=this._floatArray[f];for(f=0,g=this._frameIntArray.length;f<g;++f)u[f]=this._frameIntArray[f];for(f=0,g=this._frameFloatArray.length;f<g;++f)m[f]=this._frameFloatArray[f];for(f=0,g=this._frameArray.length;f<g;++f)p[f]=this._frameArray[f];for(f=0,g=this._timelineArray.length;f<g;++f)d[f]=this._timelineArray[f];this._data.binary=y,this._data.intArray=h,this._data.floatArray=_,this._data.frameIntArray=u,this._data.frameFloatArray=m,this._data.frameArray=p,this._data.timelineArray=d}this._defaultColorOffset=-1},n.prototype.parseDragonBonesData=function(e,i){void 0===i&&(i=1),console.assert(null!=e,"Data error.");var s=n._getString(e,t.DataParser.VERSION,""),r=n._getString(e,t.DataParser.COMPATIBLE_VERSION,"");if(t.DataParser.DATA_VERSIONS.indexOf(s)>=0||t.DataParser.DATA_VERSIONS.indexOf(r)>=0){var o=t.BaseObject.borrowObject(t.DragonBonesData);if(o.version=s,o.name=n._getString(e,t.DataParser.NAME,""),o.frameRate=n._getNumber(e,t.DataParser.FRAME_RATE,24),0===o.frameRate&&(o.frameRate=24),t.DataParser.ARMATURE in e){this._data=o,this._parseArray(e);for(var a=0,l=e[t.DataParser.ARMATURE];a<l.length;a++){var c=l[a];o.addArmature(this._parseArmature(c,i))}this._data.binary||this._modifyArray(),t.DataParser.STAGE in e?o.stage=o.getArmature(n._getString(e,t.DataParser.STAGE,"")):o.armatureNames.length>0&&(o.stage=o.getArmature(o.armatureNames[0])),this._data=null}return t.DataParser.TEXTURE_ATLAS in e&&(this._rawTextureAtlases=e[t.DataParser.TEXTURE_ATLAS]),o}return console.assert(!1,"Nonsupport data version: "+s+"\nPlease convert DragonBones data to support version.\nRead more: https://github.com/DragonBones/Tools/"),null},n.prototype.parseTextureAtlasData=function(e,i,s){if(void 0===s&&(s=1),console.assert(void 0!==e),null===e){if(null===this._rawTextureAtlases||0===this._rawTextureAtlases.length)return!1;var r=this._rawTextureAtlases[this._rawTextureAtlasIndex++];return this.parseTextureAtlasData(r,i,s),this._rawTextureAtlasIndex>=this._rawTextureAtlases.length&&(this._rawTextureAtlasIndex=0,this._rawTextureAtlases=null),!0}if(i.width=n._getNumber(e,t.DataParser.WIDTH,0),i.height=n._getNumber(e,t.DataParser.HEIGHT,0),i.scale=1===s?1/n._getNumber(e,t.DataParser.SCALE,1):s,i.name=n._getString(e,t.DataParser.NAME,""),i.imagePath=n._getString(e,t.DataParser.IMAGE_PATH,""),t.DataParser.SUB_TEXTURE in e)for(var o=e[t.DataParser.SUB_TEXTURE],a=0,l=o.length;a<l;++a){var c=o[a],h=i.createTexture();h.rotated=n._getBoolean(c,t.DataParser.ROTATED,!1),h.name=n._getString(c,t.DataParser.NAME,""),h.region.x=n._getNumber(c,t.DataParser.X,0),h.region.y=n._getNumber(c,t.DataParser.Y,0),h.region.width=n._getNumber(c,t.DataParser.WIDTH,0),h.region.height=n._getNumber(c,t.DataParser.HEIGHT,0);var _=n._getNumber(c,t.DataParser.FRAME_WIDTH,-1),u=n._getNumber(c,t.DataParser.FRAME_HEIGHT,-1);_>0&&u>0&&(h.frame=t.TextureData.createRectangle(),h.frame.x=n._getNumber(c,t.DataParser.FRAME_X,0),h.frame.y=n._getNumber(c,t.DataParser.FRAME_Y,0),h.frame.width=_,h.frame.height=u),i.addTexture(h)}return!0},n.getInstance=function(){return null===n._objectDataParserInstance&&(n._objectDataParserInstance=new n),n._objectDataParserInstance},n._objectDataParserInstance=null,n}(t.DataParser);t.ObjectDataParser=e;var i=function(){this.frameStart=0,this.actions=[]};t.ActionFrame=i}(nat||(nat={})),function(t){var e=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return iat(i,e),i.prototype._inRange=function(t,e,i){return e<=t&&t<=i},i.prototype._decodeUTF8=function(t){for(var e,i=0,n="",s=0,r=0,o=0,a=0;t.length>i;){var l=t[i++];if(-1===l)e=0!==r?65533:-1;else if(0===r)this._inRange(l,0,127)?e=l:(this._inRange(l,194,223)?(r=1,a=128,s=l-192):this._inRange(l,224,239)?(r=2,a=2048,s=l-224):this._inRange(l,240,244)&&(r=3,a=65536,s=l-240),s*=Math.pow(64,r),e=null);else if(this._inRange(l,128,191))if(o+=1,s+=(l-128)*Math.pow(64,r-o),o!==r)e=null;else{var c=s,h=a;s=0,r=0,o=0,a=0,e=this._inRange(c,h,1114111)&&!this._inRange(c,55296,57343)?c:l}else s=0,r=0,o=0,a=0,i--,e=l;null!==e&&-1!==e&&(e<=65535?e>0&&(n+=String.fromCharCode(e)):(e-=65536,n+=String.fromCharCode(55296+(e>>10&1023)),n+=String.fromCharCode(56320+(1023&e))))}return n},i.prototype._getUTF16Key=function(t){for(var e=0,i=t.length;e<i;++e)if(t.charCodeAt(e)>255)return encodeURI(t);return t},i.prototype._parseBinaryTimeline=function(e,i,n){void 0===n&&(n=null);var s=null!==n?n:t.BaseObject.borrowObject(t.TimelineData);s.type=e,s.offset=i,this._timeline=s;var r=this._timelineArrayBuffer[s.offset+2];if(1===r)s.frameIndicesOffset=-1;else{var o=0,a=this._animation.frameCount+1,l=this._data.frameIndices;t.DragonBones.webAssembly?(o=l.size(),l.resize(o+a,0)):(o=l.length,l.length+=a),s.frameIndicesOffset=o;for(var c=0,h=0,_=0,u=0;c<a;++c)_+u<=c&&h<r&&(_=this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h]],u=h===r-1?this._animation.frameCount-_:this._frameArrayBuffer[this._animation.frameOffset+this._timelineArrayBuffer[s.offset+5+h+1]]-_,h++),t.DragonBones.webAssembly?l.set(o+c,h-1):l[o+c]=h-1}return this._timeline=null,s},i.prototype._parseVertices=function(e,i){i.offset=e[t.DataParser.OFFSET];var n=this._intArrayBuffer[i.offset+3];if(n>=0){var s=t.BaseObject.borrowObject(t.WeightData),r=this._intArrayBuffer[i.offset+0],o=this._intArrayBuffer[n+0];s.offset=n;for(var a=0;a<o;++a){var l=this._intArrayBuffer[n+2+a];s.addBone(this._rawBones[l])}for(var c=n+2+o,h=0,_=(a=0,r);a<_;++a){var u=this._intArrayBuffer[c++];h+=u,c+=u}s.count=h,i.weight=s}},i.prototype._parseMesh=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parsePath=function(t,e){this._parseVertices(t,e.vertices)},i.prototype._parseAnimation=function(e){var i=t.BaseObject.borrowObject(t.AnimationData);i.frameCount=Math.max(t.ObjectDataParser._getNumber(e,t.DataParser.DURATION,1),1),i.playTimes=t.ObjectDataParser._getNumber(e,t.DataParser.PLAY_TIMES,1),i.duration=i.frameCount/this._armature.frameRate,i.fadeInTime=t.ObjectDataParser._getNumber(e,t.DataParser.FADE_IN_TIME,0),i.scale=t.ObjectDataParser._getNumber(e,t.DataParser.SCALE,1),i.name=t.ObjectDataParser._getString(e,t.DataParser.NAME,t.DataParser.DEFAULT_NAME),0===i.name.length&&(i.name=t.DataParser.DEFAULT_NAME);var n=e[t.DataParser.OFFSET];if(i.frameIntOffset=n[0],i.frameFloatOffset=n[1],i.frameOffset=n[2],this._animation=i,t.DataParser.ACTION in e&&(i.actionTimeline=this._parseBinaryTimeline(0,e[t.DataParser.ACTION])),t.DataParser.Z_ORDER in e&&(i.zOrderTimeline=this._parseBinaryTimeline(1,e[t.DataParser.Z_ORDER])),t.DataParser.BONE in e){var s=e[t.DataParser.BONE];for(var r in s){var o=s[r];t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var a=this._armature.getBone(r);if(null!==a)for(var l=0,c=o.length;l<c;l+=2){var h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_);this._animation.addBoneTimeline(a,u)}}}if(t.DataParser.SURFACE in e)for(var r in s=e[t.DataParser.SURFACE]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var m=this._armature.getBone(r);if(null!==m)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addSurfaceTimeline(m,u)}if(t.DataParser.SLOT in e)for(var r in s=e[t.DataParser.SLOT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var p=this._armature.getSlot(r);if(null!==p)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addSlotTimeline(p,u)}if(t.DataParser.CONSTRAINT in e)for(var r in s=e[t.DataParser.CONSTRAINT]){o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r));var d=this._armature.getConstraint(r);if(null!==d)for(l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addConstraintTimeline(d,u)}if(t.DataParser.ANIMATION in e)for(var r in s=e[t.DataParser.ANIMATION])for(o=s[r],t.DragonBones.webAssembly&&(r=this._getUTF16Key(r)),l=0,c=o.length;l<c;l+=2)h=o[l],_=o[l+1],u=this._parseBinaryTimeline(h,_),this._animation.addAnimationTimeline(r,u);return this._animation=null,i},i.prototype._parseArray=function(e){var i=e[t.DataParser.OFFSET],n=i[1],s=i[3],r=i[5],o=i[7],a=i[9],l=i[11],c=new Int16Array(this._binary,this._binaryOffset+i[0],n/Int16Array.BYTES_PER_ELEMENT),h=new Float32Array(this._binary,this._binaryOffset+i[2],s/Float32Array.BYTES_PER_ELEMENT),_=new Int16Array(this._binary,this._binaryOffset+i[4],r/Int16Array.BYTES_PER_ELEMENT),u=new Float32Array(this._binary,this._binaryOffset+i[6],o/Float32Array.BYTES_PER_ELEMENT),m=new Int16Array(this._binary,this._binaryOffset+i[8],a/Int16Array.BYTES_PER_ELEMENT),p=new Uint16Array(this._binary,this._binaryOffset+i[10],l/Uint16Array.BYTES_PER_ELEMENT);if(t.DragonBones.webAssembly){for(var d=n+s+r+o+a+l,f=t.webAssemblyModule._malloc(d),g=new Uint8Array(this._binary,this._binaryOffset,d/Uint8Array.BYTES_PER_ELEMENT),y=new Uint8Array(t.webAssemblyModule.HEAP16.buffer,f,g.length),v=0,x=g.length;v<x;++v)y[v]=g[v];t.webAssemblyModule.setDataBinary(this._data,f,n,s,r,o,a,l),this._intArrayBuffer=c,this._floatArrayBuffer=h,this._frameIntArrayBuffer=_,this._frameFloatArrayBuffer=u,this._frameArrayBuffer=m,this._timelineArrayBuffer=p}else this._data.binary=this._binary,this._data.intArray=this._intArrayBuffer=c,this._data.floatArray=this._floatArrayBuffer=h,this._data.frameIntArray=this._frameIntArrayBuffer=_,this._data.frameFloatArray=this._frameFloatArrayBuffer=u,this._data.frameArray=this._frameArrayBuffer=m,this._data.timelineArray=this._timelineArrayBuffer=p},i.prototype.parseDragonBonesData=function(t,i){void 0===i&&(i=1),console.assert(null!=t&&t instanceof ArrayBuffer,"Data error.");var n=new Uint8Array(t,0,8);if(n[0]!=="D".charCodeAt(0)||n[1]!=="B".charCodeAt(0)||n[2]!=="D".charCodeAt(0)||n[3]!=="T".charCodeAt(0))return console.assert(!1,"Nonsupport data."),null;var s=new Uint32Array(t,8,1)[0],r=new Uint8Array(t,12,s),o=this._decodeUTF8(r),a=JSON.parse(o);return this._binaryOffset=12+s,this._binary=t,e.prototype.parseDragonBonesData.call(this,a,i)},i.getInstance=function(){return null===i._binaryDataParserInstance&&(i._binaryDataParserInstance=new i),i._binaryDataParserInstance},i._binaryDataParserInstance=null,i}(t.ObjectDataParser);t.BinaryDataParser=e}(nat||(nat={})),function(t){var e=function(){function e(i){void 0===i&&(i=null),this.autoSearch=!1,this._dragonBonesDataMap={},this._textureAtlasDataMap={},this._dragonBones=null,this._dataParser=null,null===e._objectParser&&(e._objectParser=new t.ObjectDataParser),null===e._binaryParser&&(e._binaryParser=new t.BinaryDataParser),this._dataParser=null!==i?i:e._objectParser}return e.prototype._isSupportMesh=function(){return!0},e.prototype._getTextureData=function(t,e){if(t in this._textureAtlasDataMap)for(var i=0,n=this._textureAtlasDataMap[t];i<n.length;i++)if(null!==(l=(a=n[i]).getTexture(e)))return l;if(this.autoSearch)for(var s in this._textureAtlasDataMap)for(var r=0,o=this._textureAtlasDataMap[s];r<o.length;r++){var a,l;if((a=o[r]).autoSearch&&null!==(l=a.getTexture(e)))return l}return null},e.prototype._fillBuildArmaturePackage=function(t,e,i,n,s){var r=null,o=null;if(e.length>0&&e in this._dragonBonesDataMap&&(o=(r=this._dragonBonesDataMap[e]).getArmature(i)),null===o&&(0===e.length||this.autoSearch))for(var a in this._dragonBonesDataMap)if(r=this._dragonBonesDataMap[a],(0===e.length||r.autoSearch)&&null!==(o=r.getArmature(i))){e=a;break}if(null!==o){if(t.dataName=e,t.textureAtlasName=s,t.data=r,t.armature=o,t.skin=null,n.length>0&&(t.skin=o.getSkin(n),null===t.skin&&this.autoSearch))for(var a in this._dragonBonesDataMap){var l=this._dragonBonesDataMap[a].getArmature(n);if(null!==l){t.skin=l.defaultSkin;break}}return null===t.skin&&(t.skin=o.defaultSkin),!0}return!1},e.prototype._buildBones=function(e,i){for(var n=0,s=e.armature.sortedBones;n<s.length;n++){var r=s[n];t.BaseObject.borrowObject(0===r.type?t.Bone:t.Surface).init(r,i)}},e.prototype._buildSlots=function(e,i){var n=e.skin,s=e.armature.defaultSkin;if(null!==n&&null!==s){var r={};for(var o in s.displays){var a=s.getDisplays(o);r[o]=a}if(n!==s)for(var o in n.displays)a=n.getDisplays(o),r[o]=a;for(var l=0,c=e.armature.sortedSlots;l<c.length;l++){var h=c[l],_=h.name in r?r[h.name]:null,u=this._buildSlot(e,h,i);if(u.rawDisplayDatas=_,null!==_){for(var m=new Array,p=0,d=t.DragonBones.webAssembly?_.size():_.length;p<d;++p){var f=t.DragonBones.webAssembly?_.get(p):_[p];null!==f?m.push(this._getSlotDisplay(e,f,null,u)):m.push(null)}u._setDisplayList(m)}u._setDisplayIndex(h.displayIndex,!0)}}},e.prototype._buildConstraints=function(e,i){var n=e.armature.constraints;for(var s in n){var r=n[s];switch(r.type){case 0:var o=t.BaseObject.borrowObject(t.IKConstraint);o.init(r,i),i._addConstraint(o);break;case 1:var a=t.BaseObject.borrowObject(t.PathConstraint);a.init(r,i),i._addConstraint(a);break;default:var l=t.BaseObject.borrowObject(t.IKConstraint);l.init(r,i),i._addConstraint(l)}}},e.prototype._buildChildArmature=function(t,e,i){return this.buildArmature(i.path,null!==t?t.dataName:"","",null!==t?t.textureAtlasName:"")},e.prototype._getSlotDisplay=function(e,i,n,s){var r=null!==e?e.dataName:i.parent.parent.parent.name,o=null;switch(i.type){case 0:var a=i;null!==e&&e.textureAtlasName.length>0&&(a.texture=this._getTextureData(e.textureAtlasName,i.path)),null===a.texture&&(a.texture=this._getTextureData(r,i.path)),o=null!==n&&2===n.type&&this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 2:var l=i;null!==e&&e.textureAtlasName.length>0&&(l.texture=this._getTextureData(e.textureAtlasName,l.path)),null===l.texture&&(l.texture=this._getTextureData(r,l.path)),o=this._isSupportMesh()?s.meshDisplay:s.rawDisplay;break;case 1:var c=i,h=this._buildChildArmature(e,s,i);if(null!==h){if(h.inheritAnimation=c.inheritAnimation,!h.inheritAnimation){var _=c.actions.length>0?c.actions:h.armatureData.defaultActions;if(_.length>0)for(var u=0,m=_;u<m.length;u++){var p=m[u],d=t.BaseObject.borrowObject(t.EventObject);t.EventObject.actionDataToInstance(p,d,s.armature),d.slot=s,s.armature._bufferAction(d,!1)}else h.animation.play()}c.armature=h.armatureData}o=h}return o},e.prototype.parseDragonBonesData=function(t,i,n){void 0===i&&(i=null),void 0===n&&(n=1);for(var s=t instanceof ArrayBuffer?e._binaryParser:this._dataParser,r=s.parseDragonBonesData(t,n);;){var o=this._buildTextureAtlasData(null,null);if(!s.parseTextureAtlasData(null,o,n)){o.returnToPool();break}this.addTextureAtlasData(o,i)}return null!==r&&this.addDragonBonesData(r,i),r},e.prototype.parseTextureAtlasData=function(t,e,i,n){void 0===i&&(i=null),void 0===n&&(n=1);var s=this._buildTextureAtlasData(null,null);return this._dataParser.parseTextureAtlasData(t,s,n),this._buildTextureAtlasData(s,e||null),this.addTextureAtlasData(s,i),s},e.prototype.updateTextureAtlasData=function(t,e){var i=this.getTextureAtlasData(t);if(null!==i)for(var n=0,s=i.length;n<s;++n)n<e.length&&this._buildTextureAtlasData(i[n],e[n])},e.prototype.getDragonBonesData=function(t){return t in this._dragonBonesDataMap?this._dragonBonesDataMap[t]:null},e.prototype.addDragonBonesData=function(t,e){if(void 0===e&&(e=null),(e=null!==e?e:t.name)in this._dragonBonesDataMap){if(this._dragonBonesDataMap[e]===t)return;console.warn("Can not add same name data: "+e)}else this._dragonBonesDataMap[e]=t},e.prototype.removeDragonBonesData=function(t,e){void 0===e&&(e=!0),t in this._dragonBonesDataMap&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[t]),delete this._dragonBonesDataMap[t])},e.prototype.getTextureAtlasData=function(t){return t in this._textureAtlasDataMap?this._textureAtlasDataMap[t]:null},e.prototype.addTextureAtlasData=function(t,e){void 0===e&&(e=null);var i=(e=null!==e?e:t.name)in this._textureAtlasDataMap?this._textureAtlasDataMap[e]:this._textureAtlasDataMap[e]=[];i.indexOf(t)<0&&i.push(t)},e.prototype.removeTextureAtlasData=function(t,e){if(void 0===e&&(e=!0),t in this._textureAtlasDataMap){var i=this._textureAtlasDataMap[t];if(e)for(var n=0,s=i;n<s.length;n++){var r=s[n];this._dragonBones.bufferObject(r)}delete this._textureAtlasDataMap[t]}},e.prototype.getArmatureData=function(t,e){void 0===e&&(e="");var n=new i;return this._fillBuildArmaturePackage(n,e,t,"","")?n.armature:null},e.prototype.clear=function(t){for(var e in void 0===t&&(t=!0),this._dragonBonesDataMap)t&&this._dragonBones.bufferObject(this._dragonBonesDataMap[e]),delete this._dragonBonesDataMap[e];for(var e in this._textureAtlasDataMap){if(t)for(var i=0,n=this._textureAtlasDataMap[e];i<n.length;i++){var s=n[i];this._dragonBones.bufferObject(s)}delete this._textureAtlasDataMap[e]}},e.prototype.buildArmature=function(t,e,n,s){void 0===e&&(e=""),void 0===n&&(n=""),void 0===s&&(s="");var r=new i;if(!this._fillBuildArmaturePackage(r,e||"",t,n||"",s||""))return console.warn("No armature data: "+t+", "+(null!==e?e:"")),null;var o=this._buildArmature(r);return this._buildBones(r,o),this._buildSlots(r,o),this._buildConstraints(r,o),o.invalidUpdate(null,!0),o.advanceTime(0),o},e.prototype.replaceDisplay=function(e,i,n){void 0===n&&(n=-1),n<0&&(n=e.displayIndex),n<0&&(n=0),e.replaceDisplayData(i,n);var s=e.displayList;if(s.length<=n){s.length=n+1;for(var r=0,o=s.length;r<o;++r)s[r]||(s[r]=null)}if(null!==i){var a=e.rawDisplayDatas,l=null;a&&(t.DragonBones.webAssembly?n<a.size()&&(l=a.get(n)):n<a.length&&(l=a[n])),s[n]=this._getSlotDisplay(null,i,l,e)}else s[n]=null;e.displayList=s},e.prototype.replaceSlotDisplay=function(t,e,i,n,s,r){void 0===r&&(r=-1);var o=this.getArmatureData(e,t||"");if(!o||!o.defaultSkin)return!1;var a=o.defaultSkin.getDisplay(i,n);return!!a&&(this.replaceDisplay(s,a,r),!0)},e.prototype.replaceSlotDisplayList=function(e,i,n,s){var r=this.getArmatureData(i,e||"");if(!r||!r.defaultSkin)return!1;var o=r.defaultSkin.getDisplays(n);if(!o)return!1;for(var a=0,l=0,c=t.DragonBones.webAssembly?o.size():o.length;l<c;++l){var h=t.DragonBones.webAssembly?o.get(l):o[l];this.replaceDisplay(s,h,a++)}return!0},e.prototype.replaceSkin=function(e,i,n,s){void 0===n&&(n=!1),void 0===s&&(s=null);for(var r=!1,o=i.parent.defaultSkin,a=0,l=e.getSlots();a<l.length;a++){var c=l[a];if(!(null!==s&&s.indexOf(c.name)>=0)){var h=i.getDisplays(c.name);if(h||(null!==o&&i!==o&&(h=o.getDisplays(c.name)),h)){var _=t.DragonBones.webAssembly?h.size():h.length,u=c.displayList;u.length=_;for(var m=0,p=_;m<p;++m){var d=t.DragonBones.webAssembly?h.get(m):h[m];u[m]=null!==d?this._getSlotDisplay(null,d,null,c):null}r=!0,c.rawDisplayDatas=h,c.displayList=u}else n&&(c.rawDisplayDatas=null,c.displayList=[])}}return r},e.prototype.replaceAnimation=function(e,i,n){void 0===n&&(n=!0);var s=i.defaultSkin;if(null===s)return!1;if(n)e.animation.animations=i.animations;else{var r=e.animation.animations,o={};for(var a in r)o[a]=r[a];for(var a in i.animations)o[a]=i.animations[a];e.animation.animations=o}for(var l=0,c=e.getSlots();l<c.length;l++)for(var h=c[l],_=0,u=0,m=h.displayList;u<m.length;u++){var p=m[u];if(p instanceof t.Armature){var d=s.getDisplays(h.name);if(null!==d&&_<(t.DragonBones.webAssembly?d.size():d.length)){var f=t.DragonBones.webAssembly?d.get(_):d[_];if(null!==f&&1===f.type){var g=this.getArmatureData(f.path,f.parent.parent.parent.name);g&&this.replaceAnimation(p,g,n)}}}_++}return!0},e.prototype.getAllDragonBonesData=function(){return this._dragonBonesDataMap},e.prototype.getAllTextureAtlasData=function(){return this._textureAtlasDataMap},Object.defineProperty(e.prototype,"clock",{get:function(){return this._dragonBones.clock},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"dragonBones",{get:function(){return this._dragonBones},enumerable:!0,configurable:!0}),e.prototype.changeSkin=function(t,e,i){return void 0===i&&(i=null),this.replaceSkin(t,e,!1,i)},e.prototype.copyAnimationsToArmature=function(t,e,i,n,s){void 0===n&&(n=""),void 0===s&&(s=!0);var r=this.getArmatureData(e,n);return!!r&&this.replaceAnimation(t,r,s)},e._objectParser=null,e._binaryParser=null,e}();t.BaseFactory=e;var i=function(){this.dataName="",this.textureAtlasName="",this.skin=null};t.BuildArmaturePackage=i}(nat||(nat={})),function(t){t.BinaryOffset={WeigthBoneCount:0,WeigthFloatOffset:1,WeigthBoneIndices:2,MeshVertexCount:0,MeshTriangleCount:1,MeshFloatOffset:2,MeshWeightOffset:3,MeshVertexIndices:4,TimelineScale:0,TimelineOffset:1,TimelineKeyFrameCount:2,TimelineFrameValueCount:3,TimelineFrameValueOffset:4,TimelineFrameOffset:5,FramePosition:0,FrameTweenType:1,FrameTweenEasingOrCurveSampleCount:2,FrameCurveSamples:3,DeformMeshOffset:0,DeformCount:1,DeformValueCount:2,DeformValueOffset:3,DeformFloatOffset:4},t.ArmatureType={Armature:0,MovieClip:1,Stage:2},t.BoneType={Bone:0,Surface:1},t.DisplayType={Image:0,Armature:1,Mesh:2,BoundingBox:3},t.BoundingBoxType={Rectangle:0,Ellipse:1,Polygon:2},t.ActionType={Play:0,Stop:1,GotoAndPlay:2,GotoAndStop:3,FadeIn:4,FadeOut:5,Frame:10,Sound:11},t.BlendMode={Normal:0,Add:1,Alpha:2,Darken:3,Difference:4,Erase:5,HardLight:6,Invert:7,Layer:8,Lighten:9,Multiply:10,Overlay:11,Screen:12,Subtract:13},t.TweenType={None:0,Line:1,Curve:2,QuadIn:3,QuadOut:4,QuadInOut:5},t.TimelineType={Action:0,ZOrder:1,BoneAll:10,BoneTranslate:11,BoneRotate:12,BoneScale:13,Surface:50,SlotDisplay:20,SlotColor:21,SlotFFD:22,IKConstraint:30,AnimationTime:40,AnimationWeight:41}}(nat||(nat={}));const sat=nat.DragonBones,rat=nat.BaseObject,oat=nat.Matrix,aat=(nat.Transform,nat.ColorTransform,nat.Point,nat.Rectangle,nat.UserData,nat.ActionData,nat.DragonBonesData,nat.ArmatureData,nat.BoneData,nat.SurfaceData,nat.SlotData,nat.ConstraintData,nat.IKConstraintData,nat.PathConstraintData,nat.CanvasData,nat.SkinData,nat.VerticesData,nat.DisplayData),lat=(nat.ImageDisplayData,nat.ArmatureDisplayData,nat.MeshDisplayData,nat.BoundingBoxDisplayData,nat.PathDisplayData,nat.WeightData,nat.BoundingBoxData,nat.RectangleBoundingBoxData,nat.EllipseBoundingBoxData,nat.PolygonBoundingBoxData,nat.AnimationData,nat.TimelineData,nat.AnimationConfig,nat.TextureAtlasData),cat=nat.TextureData,hat=(nat.DeformVertices,nat.Armature),_at=(nat.TransformObject,nat.Bone,nat.Surface,nat.Slot),uat=(nat.Constraint,nat.IKConstraint,nat.PathConstraint,nat.WorldClock,nat.Animation),mat=(nat.AnimationState,nat.BonePose,nat.BlendState,nat.TimelineState,nat.TweenTimelineState,nat.BoneTimelineState,nat.SlotTimelineState,nat.ConstraintTimelineState,nat.ActionTimelineState,nat.ZOrderTimelineState,nat.BoneAllTimelineState,nat.BoneTranslateTimelineState,nat.BoneRotateTimelineState,nat.BoneScaleTimelineState,nat.SurfaceTimelineState,nat.SlotDislayTimelineState,nat.SlotColorTimelineState,nat.DeformTimelineState,nat.IKConstraintTimelineState,nat.AnimationTimelineState,nat.EventObject),pat=(nat.DataParser,nat.ObjectDataParser,nat.ActionFrame,nat.BinaryDataParser,nat.BaseFactory),dat=(nat.BuildArmaturePackage,nat.BinaryOffset),fat=(nat.ArmatureType,nat.BoneType);var gat,yat;nat.DisplayType,nat.BoundingBoxType,nat.ActionType,nat.BlendMode,nat.TweenType,nat.TimelineType;let vat=Vl("dragonBones.CCTextureAtlasData")(gat=class extends lat{constructor(...t){super(...t),this._renderTexture=null}get renderTexture(){return this._renderTexture}set renderTexture(t){if(this._renderTexture=t,t)for(const e in this.textures){const i=this.textures[e];if(!i.spriteFrame){let e=null;i.rotated?e=new hn(i.region.x,i.region.y,i.region.height,i.region.width):(e=new hn(i.region.x,i.region.y,i.region.width,i.region.height),i.spriteFrame=new pN,i.spriteFrame.texture=t,i.spriteFrame.rect=e)}}else for(const t in this.textures)this.textures[t].spriteFrame=null}static toString(){return"[class dragonBones.CCTextureAtlasData]"}createTexture(){return rat.borrowObject(xat)}_onClear(){super._onClear(),this.renderTexture=null}})||gat,xat=Vl("dragonBones.CCTextureData")(yat=class extends cat{constructor(...t){super(...t),this.spriteFrame=null}static toString(){return"[class dragonBones.CCTextureData]"}_onClear(){super._onClear(),this.spriteFrame=null}})||yat;var bat;let Sat=Vl("dragonBones.CCSlot")(bat=class extends _at{static toString(){return"[class dragonBones.CCSlot]"}constructor(){super(),this._localVertices=void 0,this._indices=void 0,this._matrix=void 0,this._worldMatrix=void 0,this._worldMatrixDirty=void 0,this._color=void 0,this._localVertices=[],this._indices=[],this._matrix=new $i,this._worldMatrix=new $i,this._worldMatrixDirty=!0,this._visible=!1,this._color=new Ri}getTexture(){return this._textureData?this._textureData.spriteFrame.texture:null}calculWorldMatrix(){const t=this._armature._parent;t?this._mulMat(this._worldMatrix,t._worldMatrix,this._matrix):$i.copy(this._worldMatrix,this._matrix),this._worldMatrixDirty=!1}_onClear(){super._onClear(),this._localVertices.length=0,this._indices.length=0,$i.identity(this._matrix),$i.identity(this._worldMatrix),this._worldMatrixDirty=!0,this._color=new Ri,this._visible=!1}_onUpdateDisplay(){}_initDisplay(t){}_addDisplay(){this._visible=!0}_replaceDisplay(t){}_removeDisplay(){this._visible=!1}_disposeDisplay(t){}_updateVisible(){this._visible=this.parent.visible}_updateGlueMesh(){}_updateZOrder(){}_updateBlendMode(){if(this._childArmature){const t=this._childArmature.getSlots();for(let e=0,i=t.length;e<i;e++){const i=t[e];i._blendMode=this._blendMode,i._updateBlendMode()}}}_updateColor(){const t=this._color;t.r=255*this._colorTransform.redMultiplier,t.g=255*this._colorTransform.greenMultiplier,t.b=255*this._colorTransform.blueMultiplier,t.a=255*this._colorTransform.alphaMultiplier}_updateFrame(){this._indices.length=0;const t=this._indices,e=this._localVertices;let i=0,n=0;const s=this._textureData;if(!this._display||this._displayIndex<0||!s||!s.spriteFrame)return;const r=s.spriteFrame.texture,o=r.width,a=r.height,l=s.region;if(0===o||0===a)return void console.error(`SpriteFrame ${s.spriteFrame.name} incorrect size ${o} x ${a}`);const c=null!==this._deformVertices&&this._display===this._meshDisplay?this._deformVertices.verticesData:null;if(c){const s=c.data,r=s.intArray,h=s.floatArray,_=r[c.offset+dat.MeshVertexCount],u=r[c.offset+dat.MeshTriangleCount];let m=r[c.offset+dat.MeshFloatOffset];m<0&&(m+=65536);const p=m+2*_,d=this._armature._armatureData.scale;for(let t=0,i=2*_;t<i;t+=2)e[n++]=h[m+t]*d,e[n++]=-h[m+t+1]*d,c.rotated?(e[n++]=(l.x+(1-h[p+t])*l.width)/o,e[n++]=(l.y+h[p+t+1]*l.height)/a):(e[n++]=(l.x+h[p+t]*l.width)/o,e[n++]=(l.y+h[p+t+1]*l.height)/a);for(let e=0;e<3*u;++e)t[i++]=r[c.offset+dat.MeshVertexIndices+e];e.length=n,t.length=i,c.weight&&this._identityTransform()}else{const i=l.x/o,s=(l.y+l.height)/a,r=(l.x+l.width)/o,c=l.y/a;e[n++]=0,e[n++]=0,e[n++]=i,e[n++]=s,e[n++]=l.width,e[n++]=0,e[n++]=r,e[n++]=s,e[n++]=0,e[n++]=l.height,e[n++]=i,e[n++]=c,e[n++]=l.width,e[n++]=l.height,e[n++]=r,e[n++]=c,t[0]=0,t[1]=1,t[2]=2,t[3]=1,t[4]=3,t[5]=2,e.length=n,t.length=6}this._visibleDirty=!0,this._blendModeDirty=!0,this._colorDirty=!0}_updateMesh(){const t=this._armature._armatureData.scale,e=this._deformVertices.vertices,i=this._deformVertices.bones,n=this._deformVertices.verticesData,s=n.weight,r=e.length>0&&n.inheritDeform,o=this._localVertices;if(s){const a=n.data,l=a.intArray,c=a.floatArray,h=l[n.offset+dat.MeshVertexCount];let _=l[s.offset+dat.WeigthFloatOffset];_<0&&(_+=65536);for(let n=0,a=s.offset+dat.WeigthBoneIndices+i.length,u=_,m=0,p=0;n<h;n++,p+=4){const n=l[a++];let s=0,h=0;for(let o=0;o<n;++o){const n=i[l[a++]];if(null!==n){const i=n.globalTransformMatrix,o=c[u++];let a=c[u++]*t,l=c[u++]*t;r&&(a+=e[m++],l+=e[m++]),s+=(i.a*a+i.c*l+i.tx)*o,h+=(i.b*a+i.d*l+i.ty)*o}}o[p]=s,o[p+1]=-h}}else if(r){const i=this._parent._boneData.type!==fat.Bone,s=n.data,r=s.intArray,a=s.floatArray,l=r[n.offset+dat.MeshVertexCount];let c=r[n.offset+dat.MeshFloatOffset];c<0&&(c+=65536);for(let n=0,s=l,r=0;n<s;n++,r+=4){const s=a[c+2*n]*t+e[2*n],l=a[c+2*n+1]*t+e[2*n+1];if(i){const t=this._parent._getGlobalTransformMatrix(s,l);o[r]=t.a*s+t.c*l+t.tx,o[r+1]=-t.b*s+t.d*l+t.ty}else o[r]=s,o[r+1]=-l}}s&&this._identityTransform()}_identityTransform(){const t=this._matrix;t.m00=1,t.m01=0,t.m04=-0,t.m05=-1,t.m12=0,t.m13=0,this._worldMatrixDirty=!0}_updateTransform(){const t=this._matrix;t.m00=this.globalTransformMatrix.a,t.m01=this.globalTransformMatrix.b,t.m04=-this.globalTransformMatrix.c,t.m05=-this.globalTransformMatrix.d,this._childArmature?(t.m12=this.globalTransformMatrix.tx,t.m13=this.globalTransformMatrix.ty):(t.m12=this.globalTransformMatrix.tx-(this.globalTransformMatrix.a*this._pivotX-this.globalTransformMatrix.c*this._pivotY),t.m13=this.globalTransformMatrix.ty-(this.globalTransformMatrix.b*this._pivotX-this.globalTransformMatrix.d*this._pivotY)),this._worldMatrixDirty=!0}updateWorldMatrix(){if(!this._armature)return;const t=this._armature._parent;if(t&&t.updateWorldMatrix(),this._worldMatrixDirty){this.calculWorldMatrix();const t=this.childArmature;if(!t)return;const e=t.getSlots();for(let t=0,i=e.length;t<i;t++){const i=e[t];i&&(i._worldMatrixDirty=!0)}}}_mulMat(t,e,i){const n=e.m00,s=e.m01,r=e.m04,o=e.m05,a=e.m12,l=e.m13,c=i.m00,h=i.m01,_=i.m04,u=i.m05,m=i.m12,p=i.m13;0!==s||0!==r?(t.m00=c*n+h*r,t.m01=c*s+h*o,t.m04=_*n+u*r,t.m05=_*s+u*o,t.m12=n*m+r*p+a,t.m13=s*m+o*p+l):(t.m00=c*n,t.m01=h*o,t.m04=_*n,t.m05=u*o,t.m12=n*m+a,t.m13=o*p+l)}})||bat;var Aat;let Cat=Vl("dragonBones.CCArmatureDisplay")(Aat=class extends aat{get node(){return this}constructor(){super(),this.shouldAdvanced=!1,this._ccNode=null,this._ccComponent=null,this._eventTarget=void 0,this._armature=null,this._eventTarget=new He}hasEvent(t){return console.warn("Method not implemented."),!1}addEvent(t,e,i){console.warn("Method not implemented.")}removeEvent(t,e,i){console.warn("Method not implemented.")}setEventTarget(t){this._eventTarget=t}getRootDisplay(){let t,e=this._armature._parent;if(!e)return this;for(;e;)t=e,e=e._armature._parent;return t._armature.display}convertToRootSpace(t){const e=this._armature._parent;if(!e)return t;e.updateWorldMatrix();const i=e._worldMatrix,n=new Ni(0,0);return n.x=t.x*i.m00+t.y*i.m04+i.m12,n.y=t.x*i.m01+t.y*i.m05+i.m13,n}convertToWorldSpace(t){var e;const i=this.convertToRootSpace(t),n=this.getRootNode();return null==n||null===(e=n._uiProps.uiTransformComp)||void 0===e?void 0:e.convertToWorldSpaceAR(i)}getRootNode(){const t=this.getRootDisplay();return t&&t._ccNode}dbInit(t){this._armature=t}dbClear(){this._armature=null}dbUpdate(){this._ccComponent&&this._ccComponent.markForUpdateRenderData()}advanceTimeBySelf(t){this.shouldAdvanced=!!t}hasDBEventListener(t){return this._eventTarget.hasEventListener(t)}addDBEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeDBEventListener(t,e,i){this._eventTarget.off(t,e,i)}dispatchDBEvent(t,e){this._eventTarget.emit(t,e)}})||Aat;var Tat,wat,Eat;let Pat=Vl("CCFactory")((Eat=wat=class t extends pat{static getInstance(){return t._factory||(t._factory=new t),t._factory}constructor(){super(),this.id=void 0,this.uuid=void 0,this._slots=void 0;const t=new Cat;this._dragonBones=new sat(t),Mw.getScheduler()&&(_w.on(hw.EVENT_RESTART,this.initUpdate,this),this.initUpdate()),this.id=this.uuid="CCFactory"}initUpdate(t){Pw.enableForTarget(this),Mw.getScheduler().scheduleUpdate(this,Sw.Priority.HIGH,!1)}update(t){this._dragonBones.advanceTime(t)}getDragonBonesDataByRawData(t){return(t instanceof ArrayBuffer?pat._binaryParser:this._dataParser).parseDragonBonesData(t,1)}buildArmatureDisplay(t,e,i,n){const s=this.buildArmature(t,e,i,n);return s?s._display:null}createArmatureNode(t,e,i){let n=(i=i||new Yv).getComponent("dragonBones.ArmatureDisplay");return n||(n=i.addComponent("dragonBones.ArmatureDisplay")),i.name=e,n._armatureName=e,n._dragonAsset=t.dragonAsset,n._dragonAtlasAsset=t.dragonAtlasAsset,n._init(),n}_buildTextureAtlasData(t,e){return t?t.renderTexture=e:t=rat.borrowObject(vat),t}_sortSlots(){const t=this._slots,e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i],s=n._zOrder;let r=!1;for(let t=e.length-1;t>=0;t--)if(s>=e[t]._zOrder){e.splice(t+1,0,n),r=!0;break}r||e.unshift(n)}this._slots=e}_buildArmature(t){const e=rat.borrowObject(hat);e._skinData=t.skin,e._animation=rat.borrowObject(uat),e._animation._armature=e,e._animation.animations=t.armature.animations,e._isChildArmature=!1;const i=new Cat;return e.init(t.armature,i,i,this._dragonBones),e}_buildSlot(t,e,i){const n=rat.borrowObject(Sat),s=n;return n.init(e,i,s,s),n}getDragonBonesDataByUUID(t){for(const e in this._dragonBonesDataMap)if(-1!==e.indexOf(t))return this._dragonBonesDataMap[e];return null}removeDragonBonesDataByUUID(t,e){void 0===e&&(e=!0);for(const i in this._dragonBonesDataMap)-1!==i.indexOf(t)&&(e&&this._dragonBones.bufferObject(this._dragonBonesDataMap[i]),delete this._dragonBonesDataMap[i])}},wat._factory=null,Tat=Eat))||Tat;const Dat=1/60,Iat=[],Rat=[];let Mat,Oat,Bat=0,Nat=0,Lat=0,Fat=null,zat=null,Vat=0,Uat=0,Gat=0,kat=0,Hat=0;class jat{constructor(){this._privateMode=!1,this._inited=!1,this._invalid=!0,this._enableCacheAttachedInfo=!1,this.frames=[],this.totalTime=0,this.isCompleted=!1,this._frameIdx=-1,this._armatureInfo=null,this._animationName=null,this._tempSegments=null,this._tempColors=null,this._tempBoneInfos=null}init(t,e){this._inited=!0,this._armatureInfo=t,this._animationName=e}clear(){this._inited=!1;for(let t=0,e=this.frames.length;t<e;t++)this.frames[t].segments.length=0;this.invalidAllFrame()}begin(){if(!this._invalid)return;const t=this._armatureInfo,e=t.curAnimationCache;e&&e!==this&&(this._privateMode?e.invalidAllFrame():e.updateToFrame()),t.armature.animation.play(this._animationName,1),t.curAnimationCache=this,this._invalid=!1,this._frameIdx=-1,this.totalTime=0,this.isCompleted=!1}end(){this._needToUpdate()||(this._armatureInfo.curAnimationCache=null,this.frames.length=this._frameIdx+1,this.isCompleted=!0)}_needToUpdate(t){return!this._armatureInfo.armature.animation.isCompleted&&this.totalTime<30&&(void 0===t||this._frameIdx<t)}updateToFrame(t){if(!this._inited)return;if(this.begin(),!this._needToUpdate(t))return;const e=this._armatureInfo.armature;do{e.advanceTime(Dat),this._frameIdx++,this._updateFrame(e,this._frameIdx),this.totalTime+=Dat}while(this._needToUpdate(t));this.end()}isInited(){return this._inited}isInvalid(){return this._invalid}invalidAllFrame(){this.isCompleted=!1,this._invalid=!0}updateAllFrame(){this.invalidAllFrame(),this.updateToFrame()}enableCacheAttachedInfo(){this._enableCacheAttachedInfo||(this._enableCacheAttachedInfo=!0,this.invalidAllFrame())}_updateFrame(t,e){Lat=0,Bat=0,Nat=0,Fat=null,zat=null,Vat=0,Uat=0,Gat=0,kat=0,Hat=0,this.frames[e]=this.frames[e]||{segments:[],colors:[],boneInfos:[],vertices:null,uintVert:null,indices:null};const i=this.frames[e],n=this._tempSegments=i.segments,s=this._tempColors=i.colors,r=this._tempBoneInfos=i.boneInfos;this._traverseArmature(t,1),kat>0&&(s[kat-1].vfOffset=Lat),s.length=kat,r.length=Bat;const o=Gat-1;if(o>=0)if(Uat>0){const t=n[o];t.indexCount=Uat,t.vfCount=5*Vat,t.vertexCount=Vat,n.length=Gat}else n.length=Gat-1;if(0===n.length)return;let a=i.vertices,l=i.uintVert;(!a||a.length<Lat)&&(a=i.vertices=new Float32Array(Lat),l=i.uintVert=new Uint32Array(a.buffer));for(let t=0,e=0;t<Lat;)a[t++]=Iat[e++],a[t++]=Iat[e++],a[t++]=Iat[e++],a[t++]=Iat[e++],l[t++]=Iat[e++];let c=i.indices;(!c||c.length<Nat)&&(c=i.indices=new Uint16Array(Nat));for(let t=0;t<Nat;t++)c[t]=Rat[t];i.vertices=a,i.uintVert=l,i.indices=c}_traverseArmature(t,e){const i=this._tempColors,n=this._tempSegments,s=this._tempBoneInfos,r=Iat,o=Rat,a=t._slots;let l,c,h,_,u,m,p,d,f;const g=t._bones;if(this._enableCacheAttachedInfo)for(let t=0,e=g.length;t<e;t++,Bat++){const e=g[t];let i=s[Bat];i||(i=s[Bat]={globalTransformMatrix:new oat});const n=e.globalTransformMatrix;i.globalTransformMatrix.copyFrom(n)}for(let t=0,s=a.length;t<s;t++)if(h=a[t],h._visible&&h._displayData)if(h.updateWorldMatrix(),u=h._color,h.childArmature)this._traverseArmature(h.childArmature,e*u.a/255);else if(p=h.getTexture(),p){Fat===p.nativeUrl&&zat===h._blendMode||(Fat=p.nativeUrl,zat=h._blendMode,d=Gat-1,d>=0&&(Uat>0?(f=n[d],f.indexCount=Uat,f.vertexCount=Vat,f.vfCount=5*Vat):Gat--),n[Gat]={tex:p,blendMode:h._blendMode,indexCount:0,vertexCount:0,vfCount:0},Gat++,Uat=0,Vat=0),m=(u.a*e<<24>>>0)+(u.b<<16)+(u.g<<8)+u.r,Hat!==m&&(Hat=m,kat>0&&(i[kat-1].vfOffset=Lat),i[kat++]={r:u.r,g:u.g,b:u.b,a:u.a*e,vfOffset:0}),l=h._localVertices,c=h._indices,_=h._worldMatrix;for(let t=0,e=l.length;t<e;)Mat=l[t++],Oat=l[t++],r[Lat++]=Mat*_.m00+Oat*_.m04+_.m12,r[Lat++]=Mat*_.m01+Oat*_.m05+_.m13,r[Lat++]=l[t++],r[Lat++]=l[t++],r[Lat++]=m;for(let t=0,e=c.length;t<e;t++)o[Nat++]=Vat+c[t];Uat+=c.length,Vat+=l.length/4}}}class Wat{constructor(){this._privateMode=!1,this._animationPool={},this._armatureCache={}}enablePrivateMode(){this._privateMode=!0}dispose(){for(const t in this._armatureCache){const e=this._armatureCache[t];if(e){const t=e.armature;t&&t.dispose()}}this._armatureCache={},this._animationPool={}}_removeArmature(t){const e=this._armatureCache[t],i=e.animationsCache;for(const e in i){const n=i[e];n&&(this._animationPool[`${t}#${e}`]=n,n.clear())}const n=e.armature;n&&n.dispose(),delete this._armatureCache[t]}resetArmature(t){for(const e in this._armatureCache)-1!==e.indexOf(t)&&this._removeArmature(e)}getArmatureCache(t,e,i){const n=this._armatureCache[e];let s;if(n)s=n.armature;else{const n=Pat.getInstance().buildArmatureDisplay(t,e,"",i);if(!n||!n._armature)return null;if(s=n._armature,!Wat.canCache(s))return s.dispose(),null;this._armatureCache[e]={armature:s,animationsCache:{},curAnimationCache:null}}return s}getAnimationCache(t,e){const i=this._armatureCache[t];return i?i.animationsCache[e]:null}initAnimationCache(t,e){if(!e)return null;const i=this._armatureCache[t],n=i&&i.armature;if(!n)return null;if(!n.animation.hasAnimation(e))return null;const s=i.animationsCache;let r=s[e];if(!r){const n=`${t}#${e}`;r=this._animationPool[n],r?delete this._animationPool[n]:(r=new jat,r._privateMode=this._privateMode),r.init(i,e),s[e]=r}return r}invalidAnimationCache(t){const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].invalidAllFrame()}updateAnimationCache(t,e){if(e){const i=this.initAnimationCache(t,e);if(!i)return;i.updateAllFrame()}else{const e=this._armatureCache[t];if(!e||!e.armature)return;const i=e.animationsCache;for(const t in i)i[t].updateAllFrame()}}static canCache(t){const e=t._slots;for(let t=0,i=e.length;t<i;t++)if(e[t].childArmature)return!1;return!0}}var qat,Xat,Yat;Wat.FrameTime=Dat,Wat.sharedCache=new Wat;let Kat=Vl("dragonBones.DragonBonesAsset")((Yat=wl((Xat=class extends _h{constructor(...t){super(...t),Tl(this,"_dragonBonesJson",Yat,this),this._factory=null,this._dragonBonesJsonData=void 0,this._armaturesEnum=null}get dragonBonesJson(){return this._dragonBonesJson}set dragonBonesJson(t){this._dragonBonesJson=t,this._dragonBonesJsonData=JSON.parse(t),this.reset()}constructctor(){this.reset()}createNode(t){const e=new Yv(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAsset=this,t(null,e)}reset(){this._clear()}init(t,e){this._factory=t,!this._dragonBonesJsonData&&this.dragonBonesJson&&(this._dragonBonesJsonData=JSON.parse(this.dragonBonesJson));let i=null;if(i=this._dragonBonesJsonData?this._dragonBonesJsonData:this._nativeAsset,!this._uuid){const t=this._factory.getDragonBonesDataByRawData(i);t?this._uuid=t.name:console.warn("dragonbones name is empty")}const n=`${this._uuid}#${e}`;return this._factory.getDragonBonesData(n)||this._factory.parseDragonBonesData(i instanceof ArrayBuffer?i:i.buffer instanceof ArrayBuffer?i.buffer:i,n),n}getArmatureEnum(){if(this._armaturesEnum)return this._armaturesEnum;this.init();const t=this._factory.getDragonBonesDataByUUID(this._uuid);if(t){const e=t.armatureNames,i={};for(let t=0;t<e.length;t++)i[e[t]]=t;return this._armaturesEnum=Nt(i)}return null}getAnimsEnum(t){this.init();const e=this._factory.getDragonBonesDataByUUID(this._uuid);if(e){const i=e.getArmature(t);if(!i)return null;const n={"<None>":0},s=i.animations;let r=0;for(const t in s)s.hasOwnProperty(t)&&(n[t]=r+1,r++);return Nt(n)}return null}destroy(){return this._clear(),super.destroy()}_clear(){this._factory&&(Wat.sharedCache.resetArmature(this._uuid),this._factory.removeDragonBonesDataByUUID(this._uuid,!0))}}).prototype,"_dragonBonesJson",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qat=Xat))||qat;var $at,Jat,Zat,Qat,tlt,elt,ilt,nlt;n.internal.DragonBonesAsset=Kat;let slt=($at=Vl("dragonBones.DragonBonesAtlasAsset"),Jat=yc(Af),$at((tlt=wl((Qat=class extends _h{constructor(){super(),Tl(this,"_atlasJson",tlt,this),Tl(this,"_texture",elt,this),Tl(this,"_atlasJsonData",ilt,this),this._factory=null,Tl(this,"_textureAtlasData",nlt,this),this._clear()}get atlasJson(){return this._atlasJson}set atlasJson(t){this._atlasJson=t,this._atlasJsonData=JSON.parse(this.atlasJson),this._clear()}get texture(){return this._texture}set texture(t){this._texture=t,this._clear()}createNode(t){const e=new Yv(this.name);return e.addComponent("dragonBones.ArmatureDisplay").dragonAtlasAsset=this,t(null,e)}init(t){this._factory=t,this._atlasJsonData||(this._atlasJsonData=JSON.parse(this.atlasJson));const e=this._atlasJsonData;this._uuid=this._uuid||e.name,this._textureAtlasData?t.addTextureAtlasData(this._textureAtlasData,this._uuid):this._textureAtlasData=t.parseTextureAtlasData(e,this.texture,this._uuid)}destroy(){return this._clear(),super.destroy()}_clear(){}}).prototype,"_atlasJson",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),elt=wl(Qat.prototype,"_texture",[Wl,Jat],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ilt=wl(Qat.prototype,"_atlasJsonData",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),nlt=wl(Qat.prototype,"_textureAtlasData",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zat=Qat))||Zat);var rlt;n.internal.DragonBonesAtlasAsset=slt;const olt=new $i;let alt=Vl("dragonBones.AttachUtil")(rlt=class{constructor(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}init(t){this._inited=!0,this._armature=t._armature,this._armatureNode=t.node,this._armatureDisplay=t}reset(){this._inited=!1,this._armature=null,this._armatureNode=null,this._armatureDisplay=null}_syncAttachedNode(){if(!this._inited)return;this._armatureNode.worldMatrix;let t=null;const e=this._armatureDisplay.isAnimationCached();if(e&&this._armatureDisplay&&(t=this._armatureDisplay._curFrame&&this._armatureDisplay._curFrame.boneInfos,!t))return;const i=this._armatureDisplay.sockets,n=this._armatureDisplay.socketNodes,s=new Ni,r=(t,e)=>{const i=olt;i.m00=e.a,i.m01=e.b,i.m04=-e.c,i.m05=-e.d,i.m12=e.tx,i.m13=e.ty,t._oldScale||(t._oldScale=t.scale.clone()),s.set(t._oldScale),t.matrix=olt,t.scale=s.multiply(this._armatureNode.scale)},o=this._armature.getBones();for(let s=i.length-1;s>=0;s--){const a=i[s],l=a.target;if(!l)continue;if(!l.isValid){n.delete(a.path),i.splice(s,1);continue}const c=e?t[a.boneIndex]:o[a.boneIndex];c&&r(l,c.globalTransformMatrix)}}})||rlt;class llt extends Sw{constructor(){super(),this._armatures=new Set}static getInstance(){return llt._instance||(llt._instance=new llt,Mw.registerSystem(llt.ID,llt._instance,Sw.Priority.HIGH)),llt._instance}add(t){t&&(this._armatures.has(t)||this._armatures.add(t))}remove(t){t&&this._armatures.has(t)&&this._armatures.delete(t)}postUpdate(t){this._armatures&&this._armatures.forEach((e=>{e.updateAnimation(t)}))}}var clt,hlt,_lt,ult,mlt,plt,dlt,flt,glt,ylt,vlt,xlt,blt,Slt,Alt,Clt,Tlt,wlt,Elt,Plt,Dlt,Ilt,Rlt,Mlt,Olt,Blt,Nlt,Llt,Flt,zlt,Vlt,Ult,Glt,klt,Hlt,jlt,Wlt,qlt,Xlt,Ylt,Klt,$lt,Jlt,Zlt,Qlt,tct,ect,ict,nct,sct;let rct;function oct(t,e,i){we.Attr.setClassAttr(t,e,"type","Enum"),we.Attr.setClassAttr(t,e,"enumList",Nt.getList(i))}llt.ID="ARMATURE",llt._instance=void 0,n.internal.ArmatureSystem=llt,function(t){t[t.default=-1]="default"}(ict||(ict={})),zt(ict),function(t){t[t["<None>"]=0]="<None>"}(nct||(nct={})),zt(nct),function(t){t[t.REALTIME=0]="REALTIME"}(sct||(sct={})),zt(nct),function(t){t[t.REALTIME=0]="REALTIME",t[t.SHARED_CACHE=1]="SHARED_CACHE",t[t.PRIVATE_CACHE=2]="PRIVATE_CACHE"}(rct||(rct={})),zt(rct);let act=(clt=Vl("dragonBones.ArmatureDisplay.DragonBoneSocket"),hlt=yc(Yv),clt((mlt=wl((ult=class{constructor(t="",e=null){Tl(this,"path",mlt,this),Tl(this,"target",plt,this),this.boneIndex=null,this.path=t,this.target=e}}).prototype,"path",[Wl,ic],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),plt=wl(ult.prototype,"target",[hlt,ic,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_lt=ult))||_lt);wt(act,"dragonBones.ArmatureDisplay.DragonBoneSocket");let lct=(dlt=Vl("dragonBones.ArmatureDisplay"),flt=ec(),glt=Jl(),ylt=yc(Kat),vlt=rc(),xlt=yc(slt),blt=rc(),Slt=nc(),Alt=nc(),Clt=sc(),Tlt=yc(ict),wlt=rc(),Elt=yc(nct),Plt=sc(),Dlt=rc(),Ilt=sc(),Rlt=rc(),Mlt=rc(),Olt=rc(),Blt=rc(),Nlt=rc(),Llt=yc([act]),Flt=rc(),dlt(zlt=flt(zlt=glt(zlt=$l((ect=tct=class t extends iF{get dragonAsset(){return this._dragonAsset}set dragonAsset(t){this._dragonAsset=t,this._refresh()}get dragonAtlasAsset(){return this._dragonAtlasAsset}set dragonAtlasAsset(t){this._dragonAtlasAsset=t,this._parseDragonAtlasAsset(),this._refresh()}get armatureName(){return this._armatureName}set armatureName(t){this._armatureName=t;const e=this.getAnimationNames(this._armatureName);(!this.animationName||e.indexOf(this.animationName)<0)&&(this.animationName=""),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),this._refresh(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature)}get animationName(){return this._animationName}set animationName(t){this._animationName=t}get _defaultArmatureIndex(){return this._defaultArmatureIndexValue}set _defaultArmatureIndex(t){this._defaultArmatureIndexValue=t;let e="";if(this.dragonAsset){let t;if(this.dragonAsset&&(t=this.dragonAsset.getArmatureEnum()),!t)return void T(7400,this.name);e=t[this._defaultArmatureIndex]}void 0!==e?this.armatureName=e:T(7401,this.name),this.resetRenderData(),this.markForUpdateRenderData()}get _animationIndex(){return this._animationIndexValue}set _animationIndex(t){if(this._animationIndexValue=t,0===this._animationIndex)return void(this.animationName="");let e;if(this.dragonAsset&&(e=this.dragonAsset.getAnimsEnum(this.armatureName)),!e)return;const i=e[this._animationIndex];void 0!==i?this.playAnimation(i,this.playTimes):T(7402,this.name)}get _defaultCacheMode(){return this._defaultCacheModeValue}set _defaultCacheMode(t){if(this._defaultCacheModeValue=t,this._defaultCacheMode!==rct.REALTIME&&this._armature&&!Wat.canCache(this._armature))return this._defaultCacheMode=rct.REALTIME,void console.warn("Animation cache mode doesn't support skeletal nesting");this.setAnimationCacheMode(this._defaultCacheMode)}get timeScale(){return this._timeScale}set timeScale(t){this._timeScale=t,this._armature&&!this.isAnimationCached()&&(this._armature.animation.timeScale=this.timeScale)}get debugBones(){return this._debugBones}set debugBones(t){this._debugBones=t,this._updateDebugDraw()}get sockets(){return this._sockets}set sockets(t){this._verifySockets(t),this._sockets=t,this._updateSocketBindings(),t.length>0&&this._frameCache&&this._frameCache.enableCacheAttachedInfo()}get socketNodes(){return this._socketNodes}get meshRenderDataArray(){return this._meshRenderDataArray}constructor(){super(),Tl(this,"playTimes",Ult,this),Tl(this,"premultipliedAlpha",Glt,this),this._armature=null,this.attachUtil=void 0,Tl(this,"_defaultArmatureIndexValue",klt,this),Tl(this,"_dragonAsset",Hlt,this),Tl(this,"_dragonAtlasAsset",jlt,this),Tl(this,"_armatureName",Wlt,this),Tl(this,"_animationName",qlt,this),Tl(this,"_animationIndexValue",Xlt,this),this._preCacheMode=-1,this._cacheMode=rct.REALTIME,Tl(this,"_defaultCacheModeValue",Ylt,this),Tl(this,"_timeScale",Klt,this),Tl(this,"_playTimes",$lt,this),Tl(this,"_debugBones",Jlt,this),this._debugDraw=null,Tl(this,"_enableBatch",Zlt,this),this._armatureKey="",this._accTime=0,this._playCount=0,this._frameCache=null,this._curFrame=null,this._playing=!1,this._armatureCache=null,this._eventTarget=void 0,this._factory=null,this._displayProxy=null,this._meshRenderDataArray=[],this._materialCache={},this._enumArmatures=Nt({}),this._enumAnimations=Nt({}),this._socketNodes=new Map,this._cachedSockets=new Map,Tl(this,"_sockets",Qlt,this),this._inited=void 0,this._meshRenderDataArrayIdx=0,this._cacheModeEnum=void 0,this._eventTarget=new He,this._inited=!1,this.attachUtil=new alt,this.initFactory(),oct(this,"_animationIndex",this._enumAnimations),oct(this,"_defaultArmatureIndex",this._enumArmatures)}initFactory(){this._factory=Pat.getInstance()}onLoad(){const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];0===(i.name&&i.name.search("CHILD_ARMATURE-"))&&i.destroy()}}requestMeshRenderData(){const t=this._meshRenderDataArray;if(t.length>0&&0===t[t.length-1].renderData.vertexCount)return t[t.length-1];const e={renderData:new cL,texture:null};return t.push(e),e}destroyRenderData(){this._meshRenderDataArray&&(this._meshRenderDataArray.forEach((t=>{t.renderData.reset()})),this._meshRenderDataArray.length=0)}resetRenderData(){this._meshRenderDataArray&&this._meshRenderDataArray.forEach((t=>{t.renderData.reset()}))}getMaterialForBlend(t,e){const i=`${t}/${e}`;let n=this._materialCache[i];if(n)return n;const s=this.getMaterial(0);return n=new ny({parent:s,subModelIdx:0,owner:this}),n.recompileShaders({USE_LOCAL:!1},0),this._materialCache[i]=n,n.overridePipelineStates({blendState:{targets:[{blendSrc:t,blendDst:e}]}}),n}_render(t){if(this._meshRenderDataArray)for(let e=0;e<this._meshRenderDataArray.length;e++){const i=this.material;this._meshRenderDataArrayIdx=e;const n=this._meshRenderDataArray[e];this.material=n.renderData.material,n.texture&&t.commitComp(this,n.texture,this._assembler,null),this.material=i}}_updateBatch(){this._materialCache={},this.destroyRenderData(),this.markForUpdateRenderData()}_updateMaterial(){this.markForUpdateRenderData()}disableRender(){}_validateRender(){return!(!this.dragonAtlasAsset||!this.dragonAtlasAsset.texture)||(this.disableRender(),!1)}__preload(){super.__preload(),this._init()}_init(){if(this._cacheMode=this._defaultCacheMode,this._inited)return;this._inited=!0,this._parseDragonAtlasAsset(),this._refresh();const t=this.node.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i&&"DEBUG_DRAW_NODE"===i.name&&i.destroy()}this._updateDebugDraw(),this._indexBoneSockets(),this._updateSocketBindings()}getArmatureKey(){return this._armatureKey}setAnimationCacheMode(t){this._preCacheMode!==t&&(this._cacheMode=t,this._buildArmature(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._updateSocketBindings(),this.markForUpdateRenderData())}isAnimationCached(){return this._cacheMode!==rct.REALTIME}onEnable(){super.onEnable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.add(this._armature),this._flushAssembler(),llt.getInstance().add(this)}onDisable(){super.onDisable(),this._armature&&!this.isAnimationCached()&&this._factory._dragonBones.clock.remove(this._armature),llt.getInstance().remove(this)}_emitCacheCompleteEvent(){this._eventTarget.emit(mat.LOOP_COMPLETE),this._eventTarget.emit(mat.COMPLETE)}updateAnimation(t){if(!this.isAnimationCached())return;if(!this._frameCache)return;this.markForUpdateRenderData();const e=this._frameCache;if(!e.isInited())return;const i=e.frames;if(!this._playing)return void(e.isInvalid()&&(e.updateToFrame(),this._curFrame=i[i.length-1]));const n=Wat.FrameTime;0===this._accTime&&0===this._playCount&&this._eventTarget.emit(mat.START),this._accTime+=t*this.timeScale*1;let s=Math.floor(this._accTime/n);if(e.isCompleted||e.updateToFrame(s),e.isCompleted&&s>=i.length){if(this._playCount++,this.playTimes>0&&this._playCount>=this.playTimes)return this._curFrame=i[i.length-1],this._accTime=0,this._playing=!1,this._playCount=0,this._emitCacheCompleteEvent(),void this.attachUtil._syncAttachedNode();this._accTime=0,s=0,this._emitCacheCompleteEvent()}this._curFrame=i[s],this.attachUtil._syncAttachedNode()}onDestroy(){this._materialInstances=this._materialInstances.filter((t=>!!t)),super.onDestroy(),this._inited=!1,this._cacheMode===rct.PRIVATE_CACHE?(this._armatureCache.dispose(),this._armatureCache=null,this._armature=null):this._cacheMode===rct.SHARED_CACHE?(this._armatureCache=null,this._armature=null):this._armature&&(this._armature.dispose(),this._armature=null),this.destroyRenderData()}_updateDebugDraw(){if(this.debugBones){if(!this._debugDraw){const t=new Yv("DEBUG_DRAW_NODE");t.hideFlags|=Me.Flags.DontSave|Me.Flags.HideInHierarchy;const e=t.addComponent(aV);e.lineWidth=1,e.strokeColor=new Ri(255,0,0,255),this._debugDraw=e}this._debugDraw.node.parent=this.node}else this._debugDraw&&(this._debugDraw.node.parent=null);this.destroyRenderData(),this.markForUpdateRenderData()}_buildArmature(){if(!this.dragonAsset||!this.dragonAtlasAsset||!this.armatureName)return;this._armature&&(this._preCacheMode===rct.PRIVATE_CACHE?this._armatureCache.dispose():this._preCacheMode===rct.REALTIME&&this._armature.dispose(),this._armatureCache=null,this._armature=null,this._displayProxy=null,this._frameCache=null,this._curFrame=null,this._playing=!1,this._preCacheMode=-1),this._cacheMode===rct.SHARED_CACHE?this._armatureCache=Wat.sharedCache:this._cacheMode===rct.PRIVATE_CACHE&&(this._armatureCache=new Wat,this._armatureCache.enablePrivateMode());const t=this.dragonAtlasAsset._uuid;if(this._armatureKey=this.dragonAsset.init(this._factory,t),this.isAnimationCached()&&(this._armature=this._armatureCache.getArmatureCache(this.armatureName,this._armatureKey,t),this._armature||(this._cacheMode=rct.REALTIME)),this._preCacheMode=this._cacheMode,this._cacheMode===rct.REALTIME){if(this._displayProxy=this._factory.buildArmatureDisplay(this.armatureName,this._armatureKey,"",t),!this._displayProxy)return;this._displayProxy._ccNode=this.node,this._displayProxy._ccComponent=this,this._displayProxy.setEventTarget(this._eventTarget),this._armature=this._displayProxy._armature,this._armature.animation.timeScale=this.timeScale}if(this._cacheMode!==rct.REALTIME&&this.debugBones&&console.warn("Debug bones is invalid in cached mode"),this._armature){const t=this._armature.armatureData.aabb;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._updateBatch(),this.attachUtil.init(this),this.animationName&&this.playAnimation(this.animationName,this.playTimes),this.destroyRenderData(),this.markForUpdateRenderData()}querySockets(){return this._armature?(0===this._cachedSockets.size&&this._indexBoneSockets(),Array.from(this._cachedSockets.keys()).sort()):[]}setBlendHash(){-1!==this._blendHash&&(this._blendHash=-1)}querySocketPathByName(t){const e=[];for(const i of this._cachedSockets.keys())i.endsWith(t)&&e.push(i);return e}_parseDragonAtlasAsset(){this.dragonAtlasAsset&&this.dragonAtlasAsset.init(this._factory)}_refresh(){this._buildArmature(),this._indexBoneSockets(),this.markForUpdateRenderData()}_updateCacheModeEnum(){this._cacheModeEnum=Nt({}),this._armature?Object.assign(this._cacheModeEnum,rct):Object.assign(this._cacheModeEnum,sct),oct(this,"_defaultCacheMode",this._cacheModeEnum)}_updateAnimEnum(){let t;t=this.dragonAsset?this.dragonAsset.getAnimsEnum(this.armatureName):nct,this._enumAnimations=Nt({}),Object.assign(this._enumAnimations,t||nct),Nt.update(this._enumAnimations),oct(this,"_animationIndex",this._enumAnimations)}_updateArmatureEnum(){let t;t=this.dragonAsset?this.dragonAsset.getArmatureEnum():ict,this._enumArmatures=Nt({}),Object.assign(this._enumArmatures,t||ict),Nt.update(this._enumArmatures),oct(this,"_defaultArmatureIndex",this._enumArmatures)}_indexBoneSockets(){if(!this._armature)return;this._cachedSockets.clear();const t=this._cachedSockets,e=(t,i,n)=>{if(n.has(t))return n.get(t);const s=i[t];if(!s.parent)return n.set(t,s.name),s.path=s.name,s.name;const r=`${e(s.parent._boneIndex,i,n)}/${s.name}`;return n.set(t,r),s.path=r,r},i=(n,s)=>{const r=s.getBones(),o=new Map;for(let t=0;t<r.length;t++)r[t]._boneIndex=t;for(let t=0;t<r.length;t++)e(t,r,o);for(const e of o.keys())t.set(`${n}${o.get(e)}`,e);const a=s.getSlots();for(let t=0;t<a.length;t++)a[t].childArmature&&i(a[t].name,a[t].childArmature)};i("",this._armature)}playAnimation(t,e){if(this.playTimes=void 0===e?-1:e,this.animationName=t,this.isAnimationCached()){let e=this._armatureCache.getAnimationCache(this._armatureKey,t);e||(e=this._armatureCache.initAnimationCache(this._armatureKey,t)),e&&(this._accTime=0,this._playCount=0,this._frameCache=e,this._sockets.length>0&&this._frameCache.enableCacheAttachedInfo(),this._frameCache.updateToFrame(0),this._playing=!0,this._curFrame=this._frameCache.frames[0])}else if(this._armature)return this._armature.animation.play(t,this.playTimes);return this.markForUpdateRenderData(),null}updateAnimationCache(t){this.isAnimationCached()&&this._armatureCache.updateAnimationCache(this._armatureKey,t)}invalidAnimationCache(){this.isAnimationCached()&&this._armatureCache.invalidAnimationCache(this._armatureKey)}getArmatureNames(){const t=this._factory.getDragonBonesData(this._armatureKey);return t&&t.armatureNames||[]}getAnimationNames(t){const e=[],i=this._factory.getDragonBonesData(this._armatureKey);if(i){const n=i.getArmature(t);if(n)for(const t in n.animations)n.animations.hasOwnProperty(t)&&e.push(t)}return e}on(t,e,i){this.addEventListener(t,e,i)}off(t,e,i){this.removeEventListener(t,e,i)}once(t,e,i){this._eventTarget.once(t,e,i)}addEventListener(t,e,i){this._eventTarget.on(t,e,i)}removeEventListener(t,e,i){this._eventTarget.off(t,e,i)}buildArmature(t,e){return this._factory.createArmatureNode(this,t,e)}armature(){return this._armature}_flushAssembler(){const e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e),0===this._meshRenderDataArray.length&&this._assembler&&this._assembler.createData&&(this._assembler.createData(this),this.markForUpdateRenderData(),this._colorDirty=!0,this._updateColor())}_updateSocketBindings(){if(this._armature){this._socketNodes.clear();for(let t=0,e=this._sockets.length;t<e;t++){const e=this._sockets[t];if(e.path&&e.target){const t=this._cachedSockets.get(e.path);if(!t){console.error(`Skeleton data does not contain path ${e.path}`);continue}e.boneIndex=t,this._socketNodes.set(e.path,e.target)}}}}_verifySockets(t){for(let e=0,i=t.length;e<i;e++){const i=t[e].target;!i||i.parent&&i.parent===this.node||console.error(`Target node ${i.name} is expected to be a direct child of ${this.node.name}`)}}},tct.AnimationCacheMode=rct,wl((Vlt=ect).prototype,"dragonAsset",[ic,ylt,vlt],Object.getOwnPropertyDescriptor(Vlt.prototype,"dragonAsset"),Vlt.prototype),wl(Vlt.prototype,"dragonAtlasAsset",[ic,xlt,blt],Object.getOwnPropertyDescriptor(Vlt.prototype,"dragonAtlasAsset"),Vlt.prototype),wl(Vlt.prototype,"armatureName",[Slt],Object.getOwnPropertyDescriptor(Vlt.prototype,"armatureName"),Vlt.prototype),wl(Vlt.prototype,"animationName",[Alt],Object.getOwnPropertyDescriptor(Vlt.prototype,"animationName"),Vlt.prototype),wl(Vlt.prototype,"_defaultArmatureIndex",[Clt,ic,Tlt,wlt],Object.getOwnPropertyDescriptor(Vlt.prototype,"_defaultArmatureIndex"),Vlt.prototype),wl(Vlt.prototype,"_animationIndex",[ic,Elt,Plt,Dlt],Object.getOwnPropertyDescriptor(Vlt.prototype,"_animationIndex"),Vlt.prototype),wl(Vlt.prototype,"_defaultCacheMode",[ic,Ilt,Rlt],Object.getOwnPropertyDescriptor(Vlt.prototype,"_defaultCacheMode"),Vlt.prototype),wl(Vlt.prototype,"timeScale",[ic,Mlt,Wl],Object.getOwnPropertyDescriptor(Vlt.prototype,"timeScale"),Vlt.prototype),Ult=wl(Vlt.prototype,"playTimes",[Olt,ic,Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Glt=wl(Vlt.prototype,"premultipliedAlpha",[Wl,ic,Blt],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),wl(Vlt.prototype,"debugBones",[Nlt,ic],Object.getOwnPropertyDescriptor(Vlt.prototype,"debugBones"),Vlt.prototype),wl(Vlt.prototype,"sockets",[Llt,Flt],Object.getOwnPropertyDescriptor(Vlt.prototype,"sockets"),Vlt.prototype),klt=wl(Vlt.prototype,"_defaultArmatureIndexValue",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ict.default}}),Hlt=wl(Vlt.prototype,"_dragonAsset",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jlt=wl(Vlt.prototype,"_dragonAtlasAsset",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wlt=wl(Vlt.prototype,"_armatureName",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),qlt=wl(Vlt.prototype,"_animationName",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Xlt=wl(Vlt.prototype,"_animationIndexValue",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ylt=wl(Vlt.prototype,"_defaultCacheModeValue",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rct.REALTIME}}),Klt=wl(Vlt.prototype,"_timeScale",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$lt=wl(Vlt.prototype,"_playTimes",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Jlt=wl(Vlt.prototype,"_debugBones",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Zlt=wl(Vlt.prototype,"_enableBatch",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qlt=wl(Vlt.prototype,"_sockets",[Wl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zlt=Vlt))||zlt)||zlt)||zlt)||zlt);n.internal.ArmatureDisplay=lct;const cct=new Ri(255,0,0,255),hct=new Ri(0,0,255,255),_ct=new Ri(0,255,0,255);let uct,mct,pct,dct,fct,gct,yct,vct,xct,bct,Sct,Act,Cct,Tct,wct,Ect;const Pct=new Float32Array(4);let Dct,Ict,Rct,Mct,Oct,Bct,Nct;const Lct=new Ni;function Fct(t,e){if(!t)return null;let i,n;switch(e){case 1:i=fct?Ys.ONE:Ys.SRC_ALPHA,n=Ys.ONE;break;case 10:i=Ys.DST_COLOR,n=Ys.ONE_MINUS_SRC_ALPHA;break;case 12:i=Ys.ONE,n=Ys.ONE_MINUS_SRC_COLOR;break;case 0:default:i=fct?Ys.ONE:Ys.SRC_ALPHA,n=Ys.ONE_MINUS_SRC_ALPHA}return xct.setBlendHash(),xct.getMaterialForBlend(i,n)}function zct(t,e){const i=t.a*e*dct,n=fct?i/255:1,s=t.r*uct*n/255,r=t.g*mct*n/255,o=t.b*pct*n/255;Pct[0]=s,Pct[1]=r,Pct[2]=o,Pct[3]=fct?1:i/255}function Vct(t){Pct[0]=(255&t>>>24)/255,Pct[1]=(255&t>>>16)/255,Pct[2]=(255&t>>>8)/255,Pct[3]=(255&t>>>0)/255}const Uct={createData(){},updateRenderData(t,e){xct=t,function(t){const e=t._armature;if(!e)return;t.markForUpdateRenderData(),t.destroyRenderData(),gct=!0,fct=t.premultipliedAlpha,vct=t.node,yct=t.requestMeshRenderData(),xct=t,Dct=0;const i=t.color;let n;if(uct=i.r/255,mct=i.g/255,pct=i.b/255,dct=i.a/255,4294967295!==i._val&&(Dct|=1),xct._enableBatch&&(n=vct.worldMatrix,gct=!1,Dct|=16),t.isAnimationCached())!function(t,e){if(!t)return;const i=t.segments;if(0===i.length)return;let n,s,r;const o=t.vertices,a=new Uint32Array(o.buffer),l=t.indices;let c=0,h=0,_=0;e&&(Ict=e.m00,Oct=e.m01,Rct=e.m04,Bct=e.m05,Mct=e.m12,Nct=e.m13);const u=16&Dct,m=u&&(1===Ict&&0===Oct&&0===Rct&&1===Bct);let p=0;const d=t.colors;let f=d[p++],g=f.vfOffset;zct(f,1);for(let t=0,e=i.length;t<e;t++){const e=i[t];r=Fct(e.tex,e.blendMode),yct.renderData.material||(yct.renderData.material=r),yct.texture||(yct.texture=e.tex),(gct||yct.renderData.material!==r||yct.texture!==e.tex)&&(gct=!1,yct=xct.requestMeshRenderData(),yct.renderData.material=r,yct.texture=e.tex),Cct=e.vertexCount,Tct=e.indexCount;const y=yct.renderData;y.reserve(Cct,Tct),Sct=y.indicesCount,bct=y.vDataOffset,Act=y.vertexCount,n=yct.renderData.vData,s=yct.renderData.iData;for(let t=Sct,e=Sct+Tct;t<e;t++)s[t]=Act+l[h++];_=e.vfCount;for(let t=c,e=bct;t<c+_;)n[e]=o[t++],n[e+1]=o[t++],n[e+3]=o[t++],n[e+4]=o[t++],Vct(a[t++]),n.set(Pct,e+5),e+=9;if(c+=_,m)for(let t=bct,e=bct+_;t<e;t+=9)n[t]+=Mct,n[t+1]+=Nct;else if(u)for(let t=bct,e=bct+_;t<e;t+=9)wct=n[t],Ect=n[t+1],n[t]=wct*Ict+Ect*Rct+Mct,n[t+1]=wct*Oct+Ect*Bct+Nct;if(yct.renderData.advance(Cct,Tct),!(1&Dct))continue;let v=c-_;for(let t=bct+5,e=bct+4+_;t<e;t+=9,v+=9)v>=g&&(f=d[p++],zct(f,1),g=f.vfOffset),n.set(Pct,t)}}(t._curFrame,n);else{Gct(e,n,1);const i=t._debugDraw;if(t.debugBones&&i){i.clear(),i.lineWidth=5,i.strokeColor=cct,i.fillColor=hct;const t=e.getBones();for(let e=0,n=t.length;e<n;e++){const n=t[e],s=Math.max(n.boneData.length,5),r=n.globalTransformMatrix.tx,o=n.globalTransformMatrix.ty,a=r+n.globalTransformMatrix.a*s,l=o+n.globalTransformMatrix.b*s;i.moveTo(r,o),i.lineTo(a,l),i.stroke(),i.circle(r,o,2*Math.PI),i.fill(),0===e&&(i.fillColor=_ct)}}}t.attachUtil._syncAttachedNode(),vct=void 0,yct=void 0,xct=void 0}(t)},updateColor(t){t&&(xct=t,xct.markForUpdateRenderData())},fillBuffers(t,e){if(!t||0===t.meshRenderDataArray.length)return;const i=t.meshRenderDataArray,n=t.node;let s=e.acquireBufferBatch(),r=s.byteOffset>>2,o=s.indicesOffset,a=s.vertexOffset;const l=i[t._meshRenderDataArrayIdx].renderData;s.request(l.vertexCount,l.indicesCount)||(s=e.currBufferBatch,r=0,o=0,a=0);const c=s.vData,h=s.iData,_=n.worldMatrix,u=l.vData,m=l.vertexStart,p=l.iData;if(c.set(u.slice(m,m+9*l.vertexCount),r),!t._enableBatch)for(let t=0;t<l.vertexCount;t++){const e=r+9*t;Lct.set(c[e],c[e+1],c[e+2]),Lct.transformMat4(_),c[e]=Lct.x,c[e+1]=Lct.y,c[e+2]=Lct.z}const d=l.indicesStart;for(let t=0;t<l.indicesCount;t+=1)h[t+o]=p[t+d]+a}};function Gct(t,e,i){const n=t._slots;let s,r,o,a,l,c,h;const _=new $i;for(let t=0,u=n.length;t<u;t++){if(h=n[t],c=h._color,!h._visible||!h._displayData)continue;if(e?h._mulMat(h._worldMatrix,e,h._matrix):$i.copy(h._worldMatrix,h._matrix),h.childArmature){Gct(h.childArmature,h._worldMatrix,i*c.a/255);continue}if(o=Fct(h.getTexture(),h._blendMode),!o)continue;yct.renderData.material||(yct.renderData.material=o),yct.texture||(yct.texture=h.getTexture()),(gct||o!==yct.renderData.material||yct.texture!==h.getTexture())&&(gct=!1,yct=xct.requestMeshRenderData(),yct.renderData.material=o,yct.texture=h.getTexture()),zct(c,i),_.set(h._worldMatrix),a=h._localVertices,Cct=a.length>>2,l=h._indices,Tct=l.length;const u=yct.renderData;u.reserve(Cct,Tct),Sct=u.indicesCount,bct=u.vDataOffset,Act=u.vertexCount,s=yct.renderData.vData,r=yct.renderData.iData,Ict=_.m00,Rct=_.m04,Mct=_.m12,Oct=_.m01,Bct=_.m05,Nct=_.m13;for(let t=0,e=a.length;t<e;)wct=a[t++],Ect=a[t++],s[bct]=wct*Ict+Ect*Rct+Mct,s[bct+1]=wct*Oct+Ect*Bct+Nct,s[bct+3]=a[t++],s[bct+4]=a[t++],s.set(Pct,bct+5),bct+=9;for(let t=0,e=l.length;t<e;t++)r[Sct++]=Act+l[t];yct.renderData.advance(Cct,Tct)}}n.internal.DragonBonesAssembler=Uct;const kct={getAssembler:()=>Uct};let Hct,jct,Wct;lct.Assembler=kct,function(t){t[t.FFD=0]="FFD",t[t.AdjustColor=10]="AdjustColor",t[t.BevelFilter=11]="BevelFilter",t[t.BlurFilter=12]="BlurFilter",t[t.DropShadowFilter=13]="DropShadowFilter",t[t.GlowFilter=14]="GlowFilter",t[t.GradientBevelFilter=15]="GradientBevelFilter",t[t.GradientGlowFilter=16]="GradientGlowFilter"}(Hct||(Hct={})),function(t){t[t.Frame=0]="Frame",t[t.Sound=1]="Sound"}(jct||(jct={})),function(t){t[t.None=0]="None",t[t.SameLayer=1]="SameLayer",t[t.SameGroup=2]="SameGroup",t[t.SameLayerAndGroup=3]="SameLayerAndGroup",t[t.All=4]="All"}(Wct||(Wct={}));const qct=window.dragonBones,Xct=qct.Slot,Yct=qct.Matrix,Kct=qct.BaseObject,$ct=qct.BoundingBoxData,Jct=qct.PolygonBoundingBoxData,Zct=qct.Transform,Qct=qct.Animation,tht=qct.TextureData,eht=qct.CCTextureData,iht=qct.BaseFactory,nht=qct.CCFactory,sht=qct.WorldClock,rht=qct.TextureAtlasData,oht=qct.CCArmatureDisplay,aht=qct.AnimationState,lht=qct.BoneData,cht=qct.EllipseBoundingBoxData,hht=qct.ArmatureData,_ht=qct.CCTextureAtlasData,uht=qct.TransformObject,mht=qct.CCSlot,pht=qct.Armature,dht=qct.Bone,fht=qct.RectangleBoundingBoxData,ght=qct.ArmatureCacheMgr,yht=qct.SkinData,vht=qct.EventObject,xht=qct.SlotData,bht=qct.DragonBonesData,Sht=qct.AnimationData,Aht=qct.CCArmatureCacheDisplay;t("dragonBones",Object.freeze({__proto__:null,DragonBonesAsset:Kat,DragonBonesAtlasAsset:slt,timeScale:1,get AnimationCacheMode(){return rct},DragonBoneSocket:act,ArmatureDisplay:lct,AttachUtil:alt,simpleDragonBoneAssembler:kct,get ExtensionType(){return Hct},get EventType(){return jct},get AnimationFadeOutMode(){return Wct},Slot:Xct,Matrix:Yct,BaseObject:Kct,BoundingBoxData:$ct,PolygonBoundingBoxData:Jct,Transform:Zct,Animation:Qct,TextureData:tht,CCTextureData:eht,BaseFactory:iht,CCFactory:nht,WorldClock:sht,TextureAtlasData:rht,CCArmatureDisplay:oht,AnimationState:aht,BoneData:lht,EllipseBoundingBoxData:cht,ArmatureData:hht,CCTextureAtlasData:_ht,TransformObject:uht,CCSlot:mht,Armature:pht,Bone:dht,RectangleBoundingBoxData:fht,ArmatureCacheMgr:ght,SkinData:yht,EventObject:vht,SlotData:xht,DragonBonesData:bht,AnimationData:Sht,CCArmatureCacheDisplay:Aht}))}}}));
